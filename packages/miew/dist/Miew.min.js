/** Miew - 3D Molecular Viewer v0.9.0 Copyright (c) 2015-2020 EPAM Systems, Inc. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("three")):"function"==typeof define&&define.amd?define(["lodash","three"],t):(e=e||self).Miew=t(e._,e.THREE)}(this,function(w,me){"use strict";w=w&&Object.prototype.hasOwnProperty.call(w,"default")?w.default:w;var r=function(e){if(Array.isArray(e))return e};var n=function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}};var i=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")};var y=function(e,t){return r(e)||n(e,t)||i()},t=function(){return(t=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},o={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",fadeColor:"transparent",animation:"spinner-line-fade-default",rotate:0,direction:1,speed:1,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:"0 0 1px transparent",position:"absolute"},a=(e.prototype.spin=function(e){return this.stop(),this.el=document.createElement("div"),this.el.className=this.opts.className,this.el.setAttribute("role","progressbar"),u(this.el,{position:this.opts.position,width:0,zIndex:this.opts.zIndex,left:this.opts.left,top:this.opts.top,transform:"scale("+this.opts.scale+")"}),e&&e.insertBefore(this.el,e.firstChild||null),function(e,t){var r=Math.round(t.corners*t.width*500)/1e3+"px",n="none";!0===t.shadow?n="0 2px 4px #000":"string"==typeof t.shadow&&(n=t.shadow);for(var i=function(e){for(var t=/^\s*([a-zA-Z]+\s+)?(-?\d+(\.\d+)?)([a-zA-Z]*)\s+(-?\d+(\.\d+)?)([a-zA-Z]*)(.*)$/,r=[],n=0,i=e.split(",");n<i.length;n++){var o=i[n].match(t);if(null!==o){var s=+o[2],a=+o[5],l=o[4],c=o[7];0!=s||l||(l=c),0!=a||c||(c=l),l===c&&r.push({prefix:o[1]||"",x:s,y:a,xUnits:l,yUnits:c,end:o[8]})}}return r}(n),o=0;o<t.lines;o++){var s=~~(360/t.lines*o+t.rotate),a=u(document.createElement("div"),{position:"absolute",top:-t.width/2+"px",width:t.length+t.width+"px",height:t.width+"px",background:h(t.fadeColor,o),borderRadius:r,transformOrigin:"left",transform:"rotate("+s+"deg) translateX("+t.radius+"px)"}),l=o*t.direction/t.lines/t.speed;l-=1/t.speed;var c=u(document.createElement("div"),{width:"100%",height:"100%",background:h(t.color,o),borderRadius:r,boxShadow:d(i,s),animation:1/t.speed+"s linear "+l+"s infinite "+t.animation});a.appendChild(c),e.appendChild(a)}}(this.el,this.opts),this},e.prototype.stop=function(){return this.el&&(("undefined"!=typeof requestAnimationFrame?cancelAnimationFrame:clearTimeout)(this.animateId),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=void 0),this},e);function e(e){void 0===e&&(e={}),this.opts=t(t({},o),e)}function u(e,t){for(var r in t)e.style[r]=t[r];return e}function h(e,t){return"string"==typeof e?e:e[t%e.length]}function d(e,t){for(var r,n,i,o,s,a=[],l=0,c=e;l<c.length;l++){var u=c[l],h=(r=u.x,n=u.y,0,i=t*Math.PI/180,o=Math.sin(i),s=Math.cos(i),[Math.round(1e3*(r*s+n*o))/1e3,Math.round(1e3*(-r*o+n*s))/1e3]);a.push(u.prefix+h[0]+u.xUnits+" "+h[1]+u.yUnits+u.end)}return a.join(", ")}var W=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var l,p=function(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e},c=function(){function r(){W(this,r),this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}return p(r,[{key:"start",value:function(){this.startTime=r.now(),this.oldTime=this.startTime,this.running=!0}},{key:"stop",value:function(){this.getElapsedTime(),this.running=!1}},{key:"getElapsedTime",value:function(){return this.update(),this.elapsedTime}},{key:"update",value:function(){var e=0;if(this.running){var t=r.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}]),r}();c.now=(l="undefined"!=typeof window&&window.performance)&&l.now?l.now.bind(l):Date.now;var f=c.now;function m(e,t,r){var n=document.createElement(e);return n.id=t,n.style.cssText=r,n}var _=function(){function e(){W(this,e),this.domElement=m("div","stats","padding:8px"),this._text=m("p","fps","margin:0;color:silver;font-size:large"),this.domElement.appendChild(this._text),this._startTime=f(),this._prevTime=this._startTime,this._deltas=new Array(20),this._index=0,this._total=0,this._count=0}return p(e,[{key:"end",value:function(){var e=f(),t=e-this._startTime;return this._count<this._deltas.length?this._count++:this._total-=this._deltas[this._index],this._total+=t,this._deltas[this._index]=t,this._index=(this._index+1)%this._deltas.length,this.ms=this._total/this._count,this.fps=1e3/this.ms,e>this._prevTime+1e3&&(this._text.textContent=this.fps.toPrecision(2),this._prevTime=e),e}},{key:"update",value:function(){this._startTime=this.end()}},{key:"show",value:function(e){void 0===e&&(e=!0),this.domElement.style.display=e?"block":"none"}}]),e}(),v="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function g(e,t){return e(t={exports:{}},t.exports),t.exports}var x=g(function(t){function r(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=r=function(e){return typeof e}:t.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}t.exports=r});var S=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var Y=function(e,t){return!t||"object"!==x(t)&&"function"!=typeof t?S(e):t},X=g(function(t){function r(e){return t.exports=r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}t.exports=r}),b=g(function(r){function n(e,t){return r.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}r.exports=n});var A=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)};var C=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")},E=g(function(n){function i(e,t,r){return!function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?n.exports=i=function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&b(i,r.prototype),i}:n.exports=i=Reflect.construct,i.apply(null,arguments)}n.exports=i}),k=g(function(t){function n(e){var r="function"==typeof Map?new Map:void 0;return t.exports=n=function(e){if(null===e||!C(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return E(e,arguments,X(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),b(t,e)},n(e)}t.exports=n});function T(e,t){return!e||e===t}function R(){this._handlers={}}R.prototype.addEventListener=function(e,t,r){var n=this._handlers[e];n||(this._handlers[e]=[],n=this._handlers[e]);var i=[t,r];void 0===w.find(n,function(e){return e[0]===i[0]&&e[1]===i[1]})&&n.push(i)},R.prototype.removeEventListener=function(r,n,i){var o=this;w.forEach(o._handlers,function(e,t){w.remove(e,function(e){return T(r,t)&&T(n,e[0])&&T(i,e[1]||o)})}),this._handlers=w.omitBy(o._handlers,function(e){return 0===e.length})},R.prototype.dispatchEvent=function(r){var n=this;w.forEach(this._handlers[r.type],function(e){var t=e[1]||n;e[0].apply(t,[r])})};var M={debug:0,info:1,report:2,warn:3,error:4};function P(){R.call(this),this.console=!1,this._priority=M.warn}function N(e){if(!w.isNumber(e))throw new Error("Wrong log level specified!");return e}((P.prototype=Object.create(R.prototype)).constructor=P).prototype.instantiate=function(){return new P},Object.defineProperty(P.prototype,"level",{get:function(){var t=this;return w.findKey(M,function(e){return e===t._priority})},set:function(e){this._priority=N(M[e])}}),P.prototype.levels=function(){return Object.keys(M)},P.prototype.message=function(e,t){var r=N(M[e]);this._message(r,t)},P.prototype.debug=function(e){this._message(M.debug,e)},P.prototype.info=function(e){this._message(M.info,e)},P.prototype.report=function(e){this._message(M.report,e)},P.prototype.warn=function(e){this._message(M.warn,e)},P.prototype.error=function(e){this._message(M.error,e)},P.prototype._message=function(t,e){if(!(t<this._priority)){var r=w.findKey(M,function(e){return e===t});if(e=String(e),this.console)"miew:".concat(r,": ").concat(e);this.dispatchEvent({type:"message",level:r,message:e})}};var I=new P,L={DEFAULT:0,SAFARI:1};function O(e){return decodeURIComponent(e.replace(/\+/g," "))}function V(e){for(var t,r=(e=e||window.location.search).substring(e.indexOf("?")+1),n=/([^&=]+)=?([^&]*)/g,i=[];null!==(t=n.exec(r));)i.push([O(t[1]),O(t[2])]);return i}function D(e){var a=!1;this.enable=function(e){a=e};var l=0,t=Object.keys(e);function r(o,s){return function(){var e=D.spaces.substr(0,2*l);a&&I.debug("".concat(e+s," {")),l++;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];var i=o.apply(this,r);return l--,a&&I.debug("".concat(e,"} // ").concat(s)),i}}for(var n=0,i=t.length;n<i;++n){var o=t[n],s=e[o];s instanceof Function&&"constructor"!==o&&(e[o]=r(s,o))}}D.spaces="                                                                                          ";var z=function(e){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this))).name="OutOfMemoryError",t.message=e,t}return A(r,e),r}(k(Error));function F(e){for(var t=new Uint8Array(e),r="",n=0;n<t.byteLength;n++)r+=String.fromCharCode(t[n]);return window.btoa(r)}function B(e){for(var t=window.atob(e),r=new Uint8Array(t.length),n=0;n<r.length;++n)r[n]=t[n].charCodeAt(0);return r.buffer}function U(e){if(w.isPlainObject(e))return!0;var t=e&&Object.getPrototypeOf(e);return!!t&&!t.hasOwnProperty("constructor")&&U(t)}function G(e){return e.slice(Math.max(0,e.lastIndexOf("."))||1/0)}function j(e){var t=e.split(/[:;,]/),r=t.length;return 3<=r&&"base64"===t[r-2]?new Blob([B(t[r-1])]):null}var H=/^[a-zA-Z0-9_]*$/,q=['"',"",'"'];var _e={browserType:L,encodeQueryComponent:function(e,t){return encodeURIComponent(e).replace(t,function(e){return String.fromCharCode(parseInt(e.substr(1),16))}).replace(/%20/g,"+")},decodeQueryComponent:O,getUrlParameters:V,getUrlParametersAsDict:function(e){for(var t={},r=V(e),n=0;n<r.length;++n){var i=y(r[n],2),o=i[0],s=i[1];t[o]=s}return t},resolveURL:function(e){if("undefined"!=typeof URL)try{return"undefined"!=typeof window?new URL(e,window.location).href:new URL(e).href}catch(e){}if("undefined"==typeof document)return e;var t=document.createElement("a");return t.href=e,t.href},generateRegExp:function(e){for(var t=[],r=0,n=e.length;r<n;++r)t[t.length]=e[r].charCodeAt(0).toString(16);var i=t.join("|");return new RegExp("%(?:".concat(i,")"),"gi")},createElement:function(e,t,r){var n,i,o=document.createElement(e);if(t){var s=Object.keys(t);for(n=0,i=s.length;n<i;++n){var a=s[n];o.setAttribute(a,t[a])}}if(r)for(r instanceof Array||(r=[r]),n=0,i=r.length;n<i;++n){var l=r[n];"string"==typeof l?o.appendChild(document.createTextNode(l)):l instanceof HTMLElement&&o.appendChild(l)}return o},deriveClass:function(e,t,r,n){return e.prototype=w.assign(Object.create(t.prototype),{constructor:e},r),n&&w.assign(e,n),e},deriveDeep:function e(t,r){var n,i,o=t;if(t instanceof Array)for(o=new Array(t.length),n=0,i=t.length;n<i;++n)o[n]=e(t[n]);else if(t instanceof Object){o=Object.create(t);var s=Object.keys(t);for(n=0,i=s.length;n<i;++n){var a=s[n],l=t[a],c=e(l);c!==l&&(o[a]=c)}r&&0<Object.keys(o).length&&(o=Object.create(o))}return o},hexColor:function(e){var t="0000000".concat(e.toString(16)).substr(-6);return"#".concat(t)},DebugTracer:D,OutOfMemoryError:z,allocateTyped:function(e,t){var r=null;try{r=new e(t)}catch(e){throw e instanceof RangeError?new z(e.message):e}return r},bytesFromBase64:B,bytesToBase64:F,arrayFromBase64:function(e,t){return Array.prototype.slice.call(new t(B(e)))},arrayToBase64:function(e,t){return F(new t(e).buffer)},compareOptionsWithDefaults:function(e,t){var r=[];if(t&&e){for(var n=Object.keys(e),i=0;i<n.length;++i){var o=n[i],s=e[o];s instanceof Object||void 0===t[o]||t[o]===s||r.push("".concat(o,":").concat(s))}if(0<r.length)return"!".concat(r.join())}return""},objectsDiff:function i(e,o){var s={};return w.forIn(e,function(e,t){var r=o[t];if(U(e)&&U(r)){var n=i(e,r);w.isEmpty(n)||(s[t]=n)}else w.isEqual(e,r)||(s[t]=e)}),s},forInRecursive:function(e,o){!function n(e,i){w.forIn(e,function(e,t){var r=i+(0<i.length?".":"");e instanceof Object?n(e,r+t):void 0!==e&&o(e,r+t)})}(e,"")},enquoteString:function(e){return w.isString(e)?'"'.concat(e.replace(/"/g,'\\"'),'"'):e},unquoteString:function(e){if(!w.isString(e))return e;if('"'===e[0]&&'"'===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\"/g,'"');if("'"===e[0]&&"'"===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\'/g,"'");throw new SyntaxError("Incorrect string format, can't unqute it")},getBrowser:function(){return navigator.vendor&&-1<navigator.vendor.indexOf("Apple")&&navigator.userAgent&&-1===navigator.userAgent.indexOf("CriOS")&&-1===navigator.userAgent.indexOf("FxiOS")?L.SAFARI:L.DEFAULT},shotOpen:function(e){"undefined"!=typeof window&&window.open().document.write('<body style="margin:0"><img src="'.concat(e,'" /></body>'))},shotDownload:function(e,t){if(e&&"data:"===e.substr(0,5))if(t=t||["screenshot-",+new Date,".png"].join(""),"undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(j(e),t);else if("undefined"!=typeof document){var r=document.createElement("a");r.download=t,r.innerHTML="download",r.href=window.URL.createObjectURL(j(e)),document.body.appendChild(r),r.click(),document.body.removeChild(r)}},copySubArrays:function(e,t,r,n){for(var i=0,o=r.length;i<o;++i)for(var s=0;s<n;++s)t[i*n+s]=e[r[i]*n+s]},shallowCloneNode:function(e){var t=e.cloneNode(!0);return t.worldPos=e.worldPos,t},correctSelectorIdentifier:function(e){return H.test(e)?e:(q[1]=e,q.join(""))},getFileExtension:G,splitFileName:function(e){var t=G(e);return[e.slice(0,e.length-t.length),t]},download:function(e,t,r){var n=new Blob([e]);if(t=t||["data",+new Date].join(""),t+=r?".".concat(r):n.type||".bin","undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(n,t);else if("undefined"!=typeof document){var i=document.createElement("a");i.download=t,i.innerHTML="download",i.href=window.URL.createObjectURL(n),document.body.appendChild(i),i.click(),document.body.removeChild(i)}},concatTypedArraysUnsafe:function(e,t){var r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},mergeTypedArraysUnsafe:function(e){if(e.length<=0)return null;for(var t=e.reduce(function(e,t){return e+t.length},0),r=new e[0].constructor(t),n=0,i=0;n<e.length;n++){var o=e[n].length;r.set(e[n],i),i+=o}return r}},$=function(){function t(){var e;return W(this,t),(e=Y(this,X(t).call(this)))._shouldCancel=!1,e}return A(t,R),p(t,[{key:"cancel",value:function(){this._shouldCancel=!0,this.dispatchEvent({type:"cancel"})}},{key:"shouldCancel",value:function(){return this._shouldCancel}},{key:"notify",value:function(e){this.dispatchEvent({type:"notification",slaveEvent:e})}}]),t}(),Z={modes:{BS:{atom:.23,bond:.15,space:.5,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},VW:{polyComplexity:{poor:4,low:6,medium:8,high:16,ultra:32}},LN:{multibond:!0,showarom:!0,offsarom:.2,chunkarom:10,atom:.23,lineWidth:2},LC:{bond:.2,space:0,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},SA:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},SE:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},QS:{isoValue:.5,gaussLim:{poor:1.5,low:2,medium:2.5,high:3,ultra:4},scale:1,wireframe:!1,gridSpacing:{poor:2,low:1.5,medium:1,high:.5,ultra:.25},subset:"",zClip:!1},CS:{probeRadius:1.4,isoValue:1.5,wireframe:!1,probePositions:30,polyComplexity:{poor:.5,low:1,medium:1.5,high:1.75,ultra:2},subset:"",zClip:!1},TR:{radius:.3,polyComplexity:{poor:12,low:16,medium:32,high:64,ultra:64}},TU:{radius:.3,heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},CA:{radius:.3,depth:.25,ss:{helix:{width:1,arrow:2},strand:{width:1,arrow:2}},heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},TX:{template:"{{Chain}}.{{Residue}}{{Sequence}}.{{Name}}",horizontalAlign:"center",verticalAlign:"middle",dx:0,dy:0,dz:1,fg:"none",bg:"0x202020",showBg:!0},VD:{kSigma:1,kSigmaMed:2,kSigmaMax:4,frame:!0,isoMode:!1,polyComplexity:{poor:2,low:3,medium:4,high:8,ultra:10}}},colorers:{EL:{carbon:-1},UN:{color:16777215},CO:{subset:"charged",color:16711680,baseColor:16777215},CB:{color:9474192,factor:.6},SQ:{gradient:"rainbow"},TM:{gradient:"temp",min:5,max:40},OC:{gradient:"reds"},HY:{gradient:"blue-red"},MO:{gradient:"rainbow"}},antialias:!0,camFov:45,camNear:.5,camFar:100,camDistance:2.5,radiusToFit:1,fogNearFactor:.5,fogFarFactor:1,fogAlpha:1,fogColor:0,fogColorEnable:!1,palette:"JM",resolution:"medium",autoResolution:!1,autoPreset:!0,preset:"default",presets:{default:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],empty:[],wire:[{mode:"LN",colorer:"EL",selector:"all",material:"SF"}],small:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],macro:[{mode:"CA",colorer:"SS",selector:"not hetatm",material:"SF"},{mode:"BS",colorer:"EL",selector:"hetatm and not water",material:"SF"}]},objects:{line:{color:4294967295,dashSize:.3,gapSize:.05}},bg:{color:2105376,transparent:!1},draft:{clipPlane:!1,clipPlaneFactor:.5,clipPlaneSpeed:3e-5},plugins:{},axes:!0,fog:!0,fps:!0,zSprites:!0,isoSurfaceFakeOpacity:!0,suspendRender:!0,nowater:!1,autobuild:!0,fxaa:!0,outline:{on:!1,color:0,threshold:.1,thickness:1},ao:!1,shadow:{on:!1,type:"random",radius:1},autoRotation:0,maxfps:30,fbxprec:4,autoRotationAxisFixed:!0,zooming:!0,picking:!0,pick:"atom",editing:!1,aromatic:!1,singleUnit:!0,stereo:"NONE",interpolateViews:!0,transparency:"prepass",translationSpeed:2,debug:{example:3.5,text:"hello!",good:!0,ssaoKernelRadius:.7,ssaoFactor:.7,stereoBarrel:.25},use:{multiFile:!1}};function K(){R.call(this),this.old=null,this.now={},this._changed={},this.reset()}_e.deriveClass(K,R,{defaults:Z,set:function(e,t){if(w.isString(e)){w.get(this.now,e)!==t&&(w.set(this.now,e,t),this._notifyChange(e,t))}else{var r=_e.objectsDiff(e,this.now);w.isEmpty(r)||(w.merge(this.now,r),this._notifyChanges(r))}},get:function(e,t){return w.get(this.now,e,t)},reset:function(){var e=_e.objectsDiff(Z,this.now);this.now=w.cloneDeep(Z),this.old=null,this._notifyChanges(e),this._changed={}},checkpoint:function(){this.old=w.cloneDeep(this.now),this._changed={}},_notifyChange:function(e,t){this._changed[e]=!0,this.dispatchEvent({type:"change:".concat(e),value:t})},_notifyChanges:function(e){var r=this;_e.forInRecursive(e,function(e,t){r._notifyChange(t,e)})},changed:function(){if(!this.old)return[];var t=this.old,r=this.now;return w.filter(Object.keys(this._changed),function(e){return w.get(t,e)!==w.get(r,e)})},applyDiffs:function(e){if(e.hasOwnProperty("VERSION")&&0!==e.VERSION)throw new Error("Settings version does not match!");delete e.VERSION,this.reset(),this.set(e)},getDiffs:function(e){var t=_e.objectsDiff(this.now,Z);return e&&(t.VERSION=0),t},setPluginOpts:function(e,t){Z.plugins[e]=w.cloneDeep(t),this.now.plugins[e]=w.cloneDeep(t)}});var Q=new K,J=0;function ee(e){return!(!e||"0"===e||w.isString(e)&&"false"===e.toLowerCase())}var te={string:String,number:Number,boolean:ee},re="!",ne=":",ie=",";var oe=_e.generateRegExp("$;@/?:,");function se(e){return _e.encodeQueryComponent(e,oe)}var ae=_e.generateRegExp("$;@/? ");function le(e){return _e.encodeQueryComponent(e,ae)}function ce(e){var t=e.reps;if(!t){var r=Q.now.presets,n=e.preset||Q.now.preset;if(!(t=r[n])){I.warn('Unknown preset "'.concat(n,'"'));var i=Object.keys(r);t=r[n=y(i,1)[0]]}e.preset=n,e.reps=_e.deriveDeep(t,!0)}}function ue(e,t,r){ce(e);var n=e.reps[J];n.hasOwnProperty(t)&&(J=e.reps.length,e.reps[J]=_e.deriveDeep(n,!0)),void 0!==r&&(e.reps[J][t]=r)}function he(o,e,t){if(o){var r=o.indexOf(re),n=(l=o.substr(0,0<=r?r:void 0),c=t,0<=(u=l.indexOf(","))?(c.push(l.substr(u+1).split(",")),l.substr(0,u)):l);if(0<=r){var i=o.substr(r+1).split(ie);if(o=n,e){var s=e[o],a=_e.deriveDeep(s,!0);i.forEach(function(e){var t=e.split(ne,2),r=decodeURIComponent(t[0]),n=decodeURIComponent(t[1]),i=te[x(w.get(s,r))];i?w.set(a,r,i(n)):I.warn('Unknown argument "'.concat(r,'" for option "').concat(o,'"'))}),0<Object.keys(a).length&&(o=[o,a])}}else o=n}var l,c,u;return o}var de={l:"load",load:String,t:"type",type:String,v:"view",view:String,u:"unit",unit:Number,menu:ee,o:"object",object:function(e,t){var r=[],n=he(e,Q.defaults.objects,r);Array.isArray(n)||(n=[n]),function(e,t,r){void 0===e._objects&&(e._objects=[]);var n=y(r,2),i=n[0],o=n[1],s={type:i,params:t};void 0!==o&&(s.opts=o),e._objects[e._objects.length]=s}(t,r[0],n)},p:"preset",preset:function(e,t){t.preset=e,t.reps=null,ce(t)},r:"rep",rep:function(e,t){ce(t),(J=(J=Number(e))<=t.reps.length?J<0?0:J:t.reps.length)===t.reps.length&&(t.reps[J]=0<J?_e.deriveDeep(t.reps[J-1],!0):_e.deriveDeep(Q.defaults.presets.default[0],!0))},s:"select",select:function(e,t){ue(t,"selector",e)},m:"mode",mode:function(e,t){ue(t,"mode",he(e,Q.defaults.modes))},c:"color",color:function(e,t){ue(t,"colorer",he(e,Q.defaults.colorers))},mt:"material",material:function(e,t){ue(t,"material",he(e,Q.defaults.materials))},dup:function(e,t){ce(t);var r=t.reps,n=r[J];r[J=r.length]=_e.deriveDeep(n,!0)},ar:"autoResolution"};function fe(e){for(var t={},r=J=0,n=e.length;r<n;++r){for(var i=e[r],o=i[0],s=i[1],a=de[o];w.isString(a);)a=de[o=a];if(a){if(w.isFunction(a)){var l=a(s,t);void 0!==l&&(t[o]=l)}}else{var c=te[x(w.get(Q.defaults,o))];c?w.set(t,"settings.".concat(o),c(s)):I.warn('Unknown option "'.concat(o,'"'))}}return t}function pe(e){var r=[],n=0;return _e.forInRecursive(e,function(e,t){r[n++]=le(t)+ne+le(e)}),r.join(ie)}function ve(e){return w.isArray(e)?e.length<2?e[0]:"".concat(e[0]).concat(re).concat(pe(e[1])):e}function ge(e){if(e&&e.type){var t=e.type;return w.isArray(e.params)&&0<e.params.length&&(t+=",".concat(e.params.join(","))),e.opts&&(t+=re+pe(e.opts)),t}}function ye(e){var r=[],n=0;return _e.forInRecursive(e,function(e,t){r[n++]="".concat(t,"=").concat(_e.enquoteString(e))}),r.join(" ")}function xe(e){return w.isArray(e)?e.length<2?e[0]:"".concat(e[0]," ").concat(ye(e[1])):e}function be(e){if(e&&e.type){var t=e.type;return w.isArray(e.params)&&0<e.params.length&&(t+=" ".concat(e.params.map(_e.enquoteString).join(" "))),e.opts&&(t+=" ".concat(ye(e.opts))),t}}function we(e,t){var r=[],n=0;function i(e,t){null!=t&&(r[n++]=e+t)}return w.isEmpty(e)?null:(i("",t),i("s=",_e.enquoteString(e.selector)),i("m=",xe(e.mode)),i("c=",xe(e.colorer)),i("mt=",xe(e.material)),r.join(" "))}var Se={fromURL:function(e){return fe(_e.getUrlParameters(e))},fromAttr:function(e){return fe(_e.getUrlParameters("?".concat(e||"")))},adapters:te,toURL:function(e){var r=[],n=0;function i(e,t){null!=t&&(r[n++]=se(e)+"="+se(t))}i("l",e.load),i("u",e.unit),i("p",e.preset),function(e){if(e)for(var t=0,r=e.length;t<r;++t)w.isEmpty(e[t])||(i("r",t),i("s",e[t].selector),i("m",ve(e[t].mode)),i("c",ve(e[t].colorer)),i("mt",ve(e[t].material)))}(e.reps),function(e){if(e)for(var t=0,r=e.length;t<r;++t)i("o",ge(e[t]))}(e._objects),i("v",e.view),_e.forInRecursive(e.settings,function(e,t){"preset"!==t&&i(t,e)});var t="";if("undefined"!=typeof window){var o=window.location;t="".concat(o.protocol,"//").concat(o.host).concat(o.pathname)}return 0<r.length&&(t+="?".concat(r.join("&"))),t},toScript:function(e){var i=[],o=0;function n(e,t,r){if(null!=t){var n="string"==typeof t&&r?'"':"";i[o++]="".concat(e," ").concat(n).concat(t).concat(n).trim()}}return n("set","autobuild false"),n("load",e.load,!0),n("unit",e.unit),n("preset",e.preset),function(e){if(e)for(var t=0,r=e.length;t<r;++t)n("rep",we(e[t],t))}(e.reps),function(e){if(e)for(var t=0,r=e.length;t<r;++t)n("",be(e[t]))}(e._objects),_e.forInRecursive(e.settings,function(e,t){"preset"!==t&&n("set ".concat(t),e,!0)}),n("view",e.view),n("set","autobuild true"),i.join("\n")}};var Ce=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},Ae=function(){function h(e,t,r,n,i,o,s,a,l,c,u){W(this,h),this.index=-1,this.residue=e,this.name=t,this.element=r,this.position=n,this.role=i,this.mask=1,this.het=o,this.serial=s,this.location=(a||" ").charCodeAt(0),this.occupancy=l||1,this.temperature=c,this.charge=u,this.hydrogenCount=-1,this.radicalCount=0,this.valence=-1,this.bonds=[],this.flags=0,"H"===r.name?this.flags|=h.Flags.HYDROGEN:"C"===r.name&&(this.flags|=h.Flags.CARBON)}return p(h,[{key:"isHet",value:function(){return this.het}},{key:"isHydrogen",value:function(){return 1===this.element.number}},{key:"getVisualName",value:function(){var e=this.name;return 0<e.length?e:this.element.name.trim()}},{key:"forEachBond",value:function(e){for(var t=this.bonds,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"getFullName",value:function(){var e="";return null!==this.residue&&(null!==this.residue._chain&&(e+="".concat(this.residue._chain.getName(),".")),e+="".concat(this.residue._sequence,".")),e+=this.name}}]),h}();Ce(Ae,"Flags",{CARBON:1,HYDROGEN:8,NONPOLARH:4104});function Ee(e,t,r,n,i,o,s){W(this,Ee),this.number=e,this.name=t,this.fullName=r,this.weight=n,this.radius=i,this.radiusBonding=o,this.hydrogenValency=s}Ce(Ee,"Constants",{U1:1,Lead:2,U2:3,Wing:4,U18:18}),Ce(Ee,"Role",{N:Ee.Constants.U1,CA:Ee.Constants.Lead,C:Ee.Constants.U2,O:Ee.Constants.Wing,SG:Ee.Constants.U18}),Ce(Ee,"ByAtomicNumber",[null,new Ee(1,"H","Hydrogen",1.008,1.2,.23,[1]),new Ee(2,"HE","Helium",4.003,1.4,.93,[0]),new Ee(3,"LI","Lithium",6.941,1.82,.68,[1]),new Ee(4,"BE","Beryllium",9.012,1.7,.35,[2]),new Ee(5,"B","Boron",10.81,2.08,.83,[3]),new Ee(6,"C","Carbon",12.011,1.95,.68,[4]),new Ee(7,"N","Nitrogen",14.007,1.85,.68,[3,5]),new Ee(8,"O","Oxygen",15.999,1.7,.68,[2,4]),new Ee(9,"F","Fluorine",18.998,1.73,.64,[1]),new Ee(10,"NE","Neon",20.18,1.54,1.12,[0]),new Ee(11,"NA","Sodium",22.99,2.27,.97,[1]),new Ee(12,"MG","Magnesium",24.305,1.73,1.1,[2]),new Ee(13,"AL","Aluminum",26.981,2.05,1.35,[3]),new Ee(14,"SI","Silicon",28.086,2.1,1.2,[4]),new Ee(15,"P","Phosphorus",30.974,2.08,.75,[3,5]),new Ee(16,"S","Sulfur",32.07,2,1.02,[2,4,6]),new Ee(17,"CL","Chlorine",35.453,1.97,.99,[1,3,5,7]),new Ee(18,"AR","Argon",39.948,1.88,1.57,[0]),new Ee(19,"K","Potassium",39.1,2.75,1.33,[1]),new Ee(20,"CA","Calcium",40.08,1.973,.99,[2]),new Ee(21,"SC","Scandium",44.956,1.7,1.44,[0]),new Ee(22,"TI","Titanium",47.88,1.7,1.47,[0]),new Ee(23,"V","Vanadium",50.941,1.7,1.33,[0]),new Ee(24,"CR","Chromium",52,1.7,1.35,[0]),new Ee(25,"MN","Manganese",54.938,1.7,1.35,[0]),new Ee(26,"FE","Iron",55.847,1.7,1.34,[0]),new Ee(27,"CO","Cobalt",58.93,1.7,1.33,[0]),new Ee(28,"NI","Nickel",58.69,1.63,1.5,[0]),new Ee(29,"CU","Copper",63.55,1.4,1.52,[0]),new Ee(30,"ZN","Zinc",65.39,1.39,1.45,[0]),new Ee(31,"GA","Gallium",69.72,1.87,1.22,[3]),new Ee(32,"GE","Germanium",72.61,1.7,1.17,[4]),new Ee(33,"AS","Arsenic",74.92,1.85,1.21,[3,5]),new Ee(34,"SE","Selenium",78.96,1.9,1.22,[2,4,6]),new Ee(35,"BR","Bromine",79.9,2.1,1.21,[1,3,5,7]),new Ee(36,"KR","Krypton",83.8,2.02,1.91,[0]),new Ee(37,"RB","Rubidium",85.47,1.7,1.47,[1]),new Ee(38,"SR","Strontium",87.62,1.7,1.12,[2]),new Ee(39,"Y","Yttrium",88.91,1.7,1.78,[0]),new Ee(40,"ZR","Zirconium",91.22,1.7,1.56,[0]),new Ee(41,"NB","Niobium",92.91,1.7,1.48,[0]),new Ee(42,"MO","Molybdenum",95.94,1.7,1.47,[0]),new Ee(43,"TC","Technetium",98.91,1.7,1.35,[0]),new Ee(44,"RU","Ruthenium",101.07,1.7,1.4,[0]),new Ee(45,"RH","Rhodium",102.91,1.7,1.45,[0]),new Ee(46,"PD","Palladium",106.42,1.63,1.5,[0]),new Ee(47,"AG","Silver",107.87,1.72,1.59,[0]),new Ee(48,"CD","Cadmium",112.41,1.58,1.69,[0]),new Ee(49,"IN","Indium",114.82,1.93,1.63,[3]),new Ee(50,"SN","Tin",118.71,2.17,1.46,[2,4]),new Ee(51,"SB","Antimony",121.75,2.2,1.46,[3,5]),new Ee(52,"TE","Tellurium",127.6,2.06,1.47,[2,4,6]),new Ee(53,"I","Iodine",126.91,2.15,1.4,[1,3,5,7]),new Ee(54,"XE","Xenon",131.29,2.16,1.98,[0]),new Ee(55,"CS","Cesium",132.91,1.7,1.67,[1]),new Ee(56,"BA","Barium",137.33,1.7,1.34,[2]),new Ee(57,"LA","Lanthanum",138.91,1.7,1.87,[0]),new Ee(58,"CE","Cerium",140.12,1.7,1.83,[0]),new Ee(59,"PR","Praseodymium",140.91,1.7,1.82,[0]),new Ee(60,"ND","Neodymium",144.24,1.7,1.81,[0]),new Ee(61,"PM","Promethium",144.9,1.7,1.8,[0]),new Ee(62,"SM","Samarium",150.36,1.7,1.8,[0]),new Ee(63,"EU","Europium",151.96,1.7,1.99,[0]),new Ee(64,"GD","Gadolinium",157.25,1.7,1.79,[0]),new Ee(65,"TB","Terbium",158.93,1.7,1.76,[0]),new Ee(66,"DY","Dysprosium",162.5,1.7,1.75,[0]),new Ee(67,"HO","Holmium",164.93,1.7,1.74,[0]),new Ee(68,"ER","Erbium",167.26,1.7,1.73,[0]),new Ee(69,"TM","Thulium",168.93,1.7,1.72,[0]),new Ee(70,"YB","Ytterbium",173.04,1.7,1.94,[0]),new Ee(71,"LU","Lutetium",174.97,1.7,1.72,[0]),new Ee(72,"HF","Hafnium",178.49,1.7,1.57,[0]),new Ee(73,"TA","Tantalum",180.95,1.7,1.43,[0]),new Ee(74,"W","Tungsten",183.85,1.7,1.37,[0]),new Ee(75,"RE","Rhenium",186.21,1.7,1.35,[0]),new Ee(76,"OS","Osmium",190.2,1.7,1.37,[0]),new Ee(77,"IR","Iridium",192.22,1.7,1.32,[0]),new Ee(78,"PT","Platinum",195.08,1.72,1.5,[0]),new Ee(79,"AU","Gold",196.97,1.66,1.5,[0]),new Ee(80,"HG","Mercury",200.59,1.55,1.7,[0]),new Ee(81,"TL","Thallium",204.38,1.96,1.55,[1,3]),new Ee(82,"PB","Lead",207.2,2.02,1.54,[2,4]),new Ee(83,"BI","Bismuth",208.98,1.7,1.54,[3,5]),new Ee(84,"PO","Polonium",210,1.7,1.68,[2,4,6]),new Ee(85,"AT","Astatine",210,1.7,1.7,[1,3,5,7]),new Ee(86,"RN","Radon",222,1.7,2.4,[0]),new Ee(87,"FR","Francium",223,1.7,2,[1]),new Ee(88,"RA","Radium",226.03,1.7,1.9,[2]),new Ee(89,"AC","Actinium",227.03,1.7,1.88,[0]),new Ee(90,"TH","Thorium",232.04,1.7,1.79,[0]),new Ee(91,"PA","Protactinium",231.04,1.7,1.61,[0]),new Ee(92,"U","Uranium",238.03,1.86,1.58,[0]),new Ee(93,"NP","Neptunium",237.05,1.7,1.55,[0]),new Ee(94,"PU","Plutonium",239.1,1.7,1.53,[0]),new Ee(95,"AM","Americium",243.1,1.7,1.51,[0]),new Ee(96,"CM","Curium",247.1,1.7,1.5,[0]),new Ee(97,"BK","Berkelium",247.1,1.7,1.5,[0]),new Ee(98,"CF","Californium",252.1,1.7,1.5,[0]),new Ee(99,"ES","Einsteinium",252.1,1.7,1.5,[0]),new Ee(100,"FM","Fermium",257.1,1.7,1.5,[0]),new Ee(101,"MD","Mendelevium",256.1,1.7,1.5,[0]),new Ee(102,"NO","Nobelium",259.1,1.7,1.5,[0]),new Ee(103,"LR","Lawrencium",260.1,1.7,1.5,[0]),new Ee(104,"RF","Rutherfordium",261,1.7,1.6,[0]),new Ee(105,"DB","Dubnium",262,1.7,1.6,[0]),new Ee(106,"SG","Seaborgium",263,1.7,1.6,[0]),new Ee(107,"BH","Bohrium",262,1.7,1.6,[0]),new Ee(108,"HS","Hassium",265,1.7,1.6,[0]),new Ee(109,"MT","Meitnerium",268,1.7,1.6,[0])]),Ce(Ee,"ByName",{D:new Ee(1,"D","Deuterium",2.014,1.2,.23,[1]),T:new Ee(1,"T","Tritium",3.016,1.2,.23,[1])}),function(){for(var e=Ee.ByAtomicNumber,t=Ee.ByName,r=0,n=e.length;r<n;++r){var i=e[r];i&&(t[i.name]=i)}}(),Ee.getByName=function(e){var t=Ee.ByName[e];return t=t||(Ee.ByName[e]=new Ee(0,e,"Unknown",0,1,.01,[0]))};var ke={UNKNOWN:0,COVALENT:1,AROMATIC:2};function Te(e){return e.position}var Re=function(){function o(e,t,r,n,i){if(W(this,o),this._left=e,this._right=t,this._fixed=i,this._index=-1,t<e)throw new Error("In a bond atom indices must be in increasing order");this._order=r,this._type=n}return p(o,[{key:"getLeft",value:function(){return this._left}},{key:"getRight",value:function(){return this._right}},{key:"getOrder",value:function(){return this._order}},{key:"calcLength",value:function(){return this._left.position.distanceTo(this._right.position)}},{key:"_forEachNeighbour",value:function(e,t){for(var r=e.bonds,n=0,i=r.length;n<i;++n)t(r[n]._left!==e?r[n]._left:r[n]._right)}},{key:"forEachLevelOne",value:function(t){var r=this._left,n=this._right;this._forEachNeighbour(r,function(e){e!==n&&t(e)}),this._forEachNeighbour(n,function(e){e!==r&&t(e)})}},{key:"forEachLevelTwo",value:function(t){var r=this._left,n=this._right,i=this;i._forEachNeighbour(r,function(e){e!==n&&i._forEachNeighbour(e,function(e){e!==r&&t(e)})}),i._forEachNeighbour(n,function(e){e!==r&&i._forEachNeighbour(e,function(e){e!==n&&t(e)})})}},{key:"_fixDir",value:function(t,r,n){var i=0,o=0,s=t.clone();function a(e){s.copy(n(e)),s.sub(t),0<r.dot(s)?++i:++o}function e(e){"C"===e.element.name&&a(e)}for(var l=[[this.forEachLevelOne,e],[this.forEachLevelOne,a],[this.forEachLevelTwo,e],[this.forEachLevelTwo,a]],c=0;c<l.length;++c){if(l[c][0].call(this,l[c][1]),i<o)return r.multiplyScalar(-1);if(o<i)return r}return r}},{key:"calcNormalDir",value:function(e){var t=this._left,r=this._right,n=t,i=r;e=void 0===e?Te:e,t.bonds.length>r.bonds.length&&(n=r,i=t);for(var o=n,s=0,a=i.bonds,l=0,c=a.length;l<c;++l){var u=a[l]._left;a[l]._left===i&&(u=a[l]._right),u.bonds.length>s&&u!==n&&(s=(o=u).bonds.length)}var h=e(i),d=e(n).clone().sub(h),f=e(o).clone().sub(h);return f.crossVectors(d,f),f.lengthSq()<1e-4&&f.set(0,1,0),d.normalize(),f.normalize(),d.crossVectors(f,d),d.lengthSq()<1e-4&&d.set(0,1,0),d.normalize(),this._fixDir(h,d,e)}}]),o}();Ce(Re,"BondType",ke),Re.prototype.BondType=ke;var Me=["C3'","C3*","P","H5T","H3T"],Pe=["OP1","O1P"],Ne=["OP2","O2P"],Ie=["C3'","C3*","C1","C1'","C1*","P"],Le=[{types:["A","DA","G","DG"],atoms:["N1"]},{types:["C","DC"],atoms:["N3"]},{types:["T","DT","U","DU"],atoms:["O4"]}],Oe=function(){function i(e,t,r,n){W(this,i),this._chain=e,this._component=null,this._type=t,this._sequence=r,this._icode=n,this._mask=1,this._index=-1,this._atoms=[],this._secondary=null,this._firstAtom=null,this._leadAtom=null,this._wingAtom=null,this._lastAtom=null,this._controlPoint=null,this._midPoint=null,this._wingVector=null,this._cylinders=null,this._isValid=!0,this._het=!1,this._molecule=null,this.temperature=null,this.occupancy=null}return p(i,[{key:"getChain",value:function(){return this._chain}},{key:"getMolecule",value:function(){return this._molecule}},{key:"getType",value:function(){return this._type}},{key:"getSequence",value:function(){return this._sequence}},{key:"getSecondary",value:function(){return this._secondary}},{key:"getICode",value:function(){return this._icode}},{key:"addAtom",value:function(e,t,r,n,i,o,s,a,l,c){var u=new Ae(this,e,t,r,n,i,o,s,a,l,c);return this._chain.getComplex().addAtom(u),this._atoms.push(u),this._het=this._het||i,u}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,r=0,n=t.length;r<n&&!e(t[r]);++r);}},{key:"_findAtomByName",value:function(t){var r=null;return this.forEachAtom(function(e){return e.name===t&&(r=e,!0)}),r}},{key:"_findFirstAtomInList",value:function(e){for(var t=null,r=0;r<e.length;++r)if(null!==(t=this._findAtomByName(e[r])))return t;return t}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._atoms,r=0,n=t.length;r<n;++r)e&=t[r].mask;this._mask=e}},{key:"getCylinderTargetList",value:function(){for(var e=this._type._name,t=0,r=Le.length;t<r;++t)for(var n=0,i=Le[t].types.length;n<i;++n)if(e===Le[t].types[n])return Le[t].atoms;return null}},{key:"_detectLeadWing",value:function(e,t,r){var n=this._findFirstAtomInList(Me),i=this._findFirstAtomInList(Pe),o=this._findFirstAtomInList(Ne);if(null===i&&null!==t&&(i=t._findFirstAtomInList(Pe)),null===o&&null!==t&&(o=t._findFirstAtomInList(Ne)),null!==n&&null!==i&&null!==o){e._leadAtom=n,e._controlPoint=r(n),e._wingVector=r(o).clone().sub(r(i)),e._isValid=!0;var s=this._findFirstAtomInList(Ie),a=this.getCylinderTargetList(),l=null!==a?this._findFirstAtomInList(a):null;null!==s&&null!==l&&(e._cylinders=[r(s),r(l)])}}},{key:"calcWing",value:function(e,t,r,n){var i=t.clone().sub(e),o=e.clone().sub(r);o.crossVectors(i,o),o.crossVectors(i,o).normalize(),null!==n&&1e-4<n.length()&&(1e-4<o.length()&&Math.abs(n.angleTo(o))>Math.PI/2&&o.negate());return o}},{key:"_innerFinalize",value:function(e,t,r,n,i,o){var s=null===t,a=o(this._leadAtom),l=new me.Vector3(a.x,a.y,a.z);if(i)this._detectLeadWing(n,r,o);else{if(s)n._midPoint=o(this._firstAtom).clone();else{var c=t._controlPoint;n._midPoint=c.clone().lerp(l,.5),n._wingVector=this.calcWing(c,l,o(e._wingAtom),t._wingVector)}n._controlPoint=l}}},{key:"_finalize2",value:function(e,t,r){this._innerFinalize(e,e,t,this,r,function(e){return e.position})}},{key:"isConnected",value:function(o){if(this._chain!==o._chain)return!1;if(this===o)return!0;var s=!1;return this.forEachAtom(function(e){for(var t=e.bonds,r=0,n=t.length;r<n;++r){var i=t[r];if(i._left.residue===o||i._right.residue===o)return s=!0}return!1}),s}},{key:"_finalize",value:function(){var t=this,e=y(this._atoms,1);this._firstAtom=e[0],this._lastAtom=this._atoms[this._atoms.length-1],this._leadAtom=null,this._wingAtom=null;var r=0,n=0,i=0,o=0;this.forEachAtom(function(e){return null===t._leadAtom&&e.role===Ee.Constants.Lead&&(t._leadAtom=e),null===t._wingAtom&&e.role===Ee.Constants.Wing&&(t._wingAtom=e),e.temperature&&(n+=e.temperature,r++),e.occupancy&&(o+=e.occupancy,i++),null!==t._leadAtom&&null!==t._wingAtom}),0<r&&(this.temperature=n/r),0<i&&(this.occupancy=o/i),null!==this._leadAtom&&null!==this._wingAtom||(this._isValid=!1),null===this._leadAtom&&(this._leadAtom=this._firstAtom),null===this._wingAtom&&(this._wingAtom=this._lastAtom)}}]),i}(),Ve=function(){function n(e,t,r){W(this,n),this._name=e,this._fullName=t,this.letterCode=r,this.flags=0}return p(n,[{key:"getName",value:function(){return this._name}}]),n}();function De(e,t){for(var r=0,n=t.length;r<n;++r){var i=Ve.StandardTypes[t[r]];i&&(i.flags|=e)}}Ce(Ve,"StandardTypes",{ALA:new Ve("ALA","Alanine","A"),ARG:new Ve("ARG","Arginine","R"),ASN:new Ve("ASN","Asparagine","N"),ASP:new Ve("ASP","Aspartic Acid","D"),CYS:new Ve("CYS","Cysteine","C"),GLN:new Ve("GLN","Glutamine","Q"),GLU:new Ve("GLU","Glutamic Acid","E"),GLY:new Ve("GLY","Glycine","G"),HIS:new Ve("HIS","Histidine","H"),ILE:new Ve("ILE","Isoleucine","I"),LEU:new Ve("LEU","Leucine","L"),LYS:new Ve("LYS","Lysine","K"),MET:new Ve("MET","Methionine","M"),PHE:new Ve("PHE","Phenylalanine","F"),PRO:new Ve("PRO","Proline","P"),PYL:new Ve("PYL","Pyrrolysine","O"),SEC:new Ve("SEC","Selenocysteine","U"),SER:new Ve("SER","Serine","S"),THR:new Ve("THR","Threonine","T"),TRP:new Ve("TRP","Tryptophan","W"),TYR:new Ve("TYR","Tyrosine","Y"),VAL:new Ve("VAL","Valine","V"),A:new Ve("A","Adenine","A"),C:new Ve("C","Cytosine","C"),G:new Ve("G","Guanine","G"),I:new Ve("I","Inosine","I"),T:new Ve("T","Thymine","T"),U:new Ve("U","Uracil","U"),DA:new Ve("DA","Adenine","A"),DC:new Ve("DC","Cytosine","C"),DG:new Ve("DG","Guanine","G"),DI:new Ve("DI","Inosine","I"),DT:new Ve("DT","Thymine","T"),DU:new Ve("DU","Uracil","U"),"+A":new Ve("+A","Adenine","A"),"+C":new Ve("+C","Cytosine","C"),"+G":new Ve("+G","Guanine","G"),"+I":new Ve("+I","Inosine","I"),"+T":new Ve("+T","Thymine","T"),"+U":new Ve("+U","Uracil","U"),WAT:new Ve("WAT","Water",""),H2O:new Ve("H2O","Water",""),HOH:new Ve("HOH","Water",""),DOD:new Ve("DOD","Water",""),UNK:new Ve("UNK","Unknown",""),UNL:new Ve("UNL","Unknown Ligand","")}),Ce(Ve,"Flags",{PROTEIN:1,BASIC:2,ACIDIC:4,POLAR:8,NONPOLAR:16,AROMATIC:32,NUCLEIC:256,PURINE:512,PYRIMIDINE:1024,DNA:2048,RNA:4096,WATER:65536});var ze=Ve.Flags;De(ze.WATER,["WAT","H2O","HOH","DOD"]),De(ze.PROTEIN,["ALA","ARG","ASN","ASP","CYS","GLY","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","PRO","PYL","SEC","SER","THR","TRP","TYR","VAL"]),De(ze.BASIC,["ARG","HIS","LYS"]),De(ze.ACIDIC,["ASP","GLU"]),De(ze.POLAR,["ASN","CYS","GLN","SER","THR","TYR"]),De(ze.NONPOLAR,["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL","GLY"]),De(ze.AROMATIC,["PHE","TRP","TYR"]),De(ze.NUCLEIC,["A","G","I","DA","DG","DI","+A","+G","+I","C","T","U","DC","DT","DU","+C","+T","+U"]),De(ze.PURINE,["A","G","I","DA","DG","DI","+A","+G","+I"]),De(ze.PYRIMIDINE,["C","T","U","DC","DT","DU","+C","+T","+U"]),De(ze.DNA,["DA","DG","DI","DC","DT","DU"]),De(ze.RNA,["A","G","I","C","T","U"]);!function(e,t){for(var r=Object.keys(t),n=0,i=r.length;n<i;++n){var o=r[n],s=t[o];Ve.StandardTypes[o][e]=s}}("hydrophobicity",{ILE:4.5,VAL:4.2,LEU:3.8,PHE:2.8,CYS:2.5,MET:1.9,ALA:1.8,GLY:-.4,THR:-.7,SER:-.8,TRP:-.9,TYR:-1.3,PRO:-1.6,HIS:-3.2,GLU:-3.5,GLN:-3.5,ASP:-3.5,ASN:-3.5,LYS:-3.9,ARG:-4.5});var Fe,Be=0,Ue=1,Ge=2,je=function(){function r(e,t){W(this,r),this._complex=e,this._name=t,this._mask=1,this._index=-1,this._residues=[],this.minSequence=Number.POSITIVE_INFINITY,this.maxSequence=Number.NEGATIVE_INFINITY}return p(r,[{key:"getComplex",value:function(){return this._complex}},{key:"getName",value:function(){return this._name}},{key:"getResidues",value:function(){return this._residues}},{key:"_determineType",value:function(){var e=this._residues,t=Ve.Flags,r=t.PROTEIN,n=t.NUCLEIC;this.type=Be;for(var i=0,o=e.length;i<o;++i){var s=e[i]._type.flags;if(0!=(s&n)){this.type=Ge;break}if(0!=(s&r)){this.type=Ue;break}}}},{key:"findResidue",value:function(e,t){for(var r=this._residues,n=0,i=r.length;n<i;++n){var o=r[n];if(o._sequence===e&&o._icode===t)return[o,n]}return null}},{key:"_finalize",value:function(){this._determineType();for(var e=this._residues,t=null,r=0,n=e.length;r<n;++r){var i=r+1<n?e[r+1]:null,o=e[r];o._finalize2(t,i,this.type===Ge),t=o}if(1<e.length&&e[1]._wingVector){var s=e[1]._wingVector;e[0]._wingVector=new me.Vector3(s.x,s.y,s.z)}else 0<e.length&&(e[0]._wingVector=new me.Vector3(1,0,0))}},{key:"updateToFrame",value:function(t){var e=this._residues,r=null,n=null,i=t._residues,o=e.length;function s(e){return t.getAtomPos(e.index)}for(var a=0;a<o;++a){var l=e[a],c=i[l._index],u=a+1<o?e[a+1]:null;l._innerFinalize(r,n,u,c,this.type===Ge,s),r=l,n=c}i[e[0]._index]._wingVector=1<o?i[e[1]._index]._wingVector:new me.Vector3(1,0,0)}},{key:"addResidue",value:function(e,t,r){var n=this._complex.getResidueType(e);null===n&&(n=this._complex.addResidueType(e));var i=new Oe(this,n,t,r);return this._complex.addResidue(i),this._residues.push(i),n.flags&(Ve.Flags.NUCLEIC|Ve.Flags.PROTEIN)&&(this.maxSequence<t&&(this.maxSequence=t),this.minSequence>t&&(this.minSequence=t)),i}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"forEachResidue",value:function(e){for(var t=this._residues,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._residues,r=0,n=t.length;r<n;++r)e&=t[r]._mask;this._mask=e}}]),r}(),He=function(){function n(e,t,r){W(this,n),this.type=e,this.generic=n.genericByType[this.type]||"loop",this.init=t,this.term=r}return p(n,[{key:"_finalize",value:function(e,t,r){if(!(this.init instanceof Oe&&this.term instanceof Oe)){for(var n=r.splitUnifiedSerial(this.init),i=r.splitUnifiedSerial(this.term),o=n.chain;o<=i.chain;o++)for(var s=n.serial;s<=i.serial;s++)for(var a=n.iCode;a<=i.iCode;a++){var l=r.getUnifiedSerial(o,s,a);t[l]&&(t[l]._secondary=this)}this.init=t[this.init],this.term=t[this.term]}}}]),n}();He.Type={STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",HELIX:"X",TURN_310:"3",TURN_ALPHA:"4",TURN_PI:"5",TURN:"T",BEND:"S",COIL:"C"},He.Generic={STRAND:"strand",HELIX:"helix",LOOP:"loop"};var We=He.Type,Ye=He.Generic;He.genericByType=(Ce(Fe={},We.STRAND,Ye.STRAND),Ce(Fe,We.HELIX_310,Ye.HELIX),Ce(Fe,We.HELIX_ALPHA,Ye.HELIX),Ce(Fe,We.HELIX_PI,Ye.HELIX),Ce(Fe,We.HELIX,Ye.HELIX),Fe);var Xe=He.Type,qe={1:Xe.HELIX_ALPHA,3:Xe.HELIX_PI,5:Xe.HELIX_310},$e=function(){function l(e,t,r,n,i,o,s){var a;return W(this,l),(a=Y(this,X(l).call(this,qe[e]||He.Type.HELIX,t,r))).serial=n,a.name=i,a.comment=o,a.length=s,a}return A(l,He),l}();var Ze,Ke,Qe,Je,et,tt,rt,nt,it,ot,st,at,lt,ct,ut,ht,dt=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=X(e)););return e},ft=g(function(n){function i(e,t,r){return"undefined"!=typeof Reflect&&Reflect.get?n.exports=i=Reflect.get:n.exports=i=function(e,t,r){var n=dt(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}},i(e,t,r||e)}n.exports=i}),pt=function(){function a(e,t,r,n,i,o){var s;return W(this,a),(s=Y(this,X(a).call(this,He.Type.STRAND,t,r))).sheet=e,s.sense=n,s.atomCur=i,s.atomPrev=o,s}return A(a,He),p(a,[{key:"_finalize",value:function(e,t,r){ft(X(a.prototype),"_finalize",this).call(this,e,t,r);var n=this.atomCur;null===n||Number.isNaN(n)||(this.atomCur=e[n]),null===(n=this.atomPrev)||Number.isNaN(n)||(this.atomPrev=e[n])}}]),a}(),mt=function(){function r(e,t){W(this,r),this._name=e,this._width=t,this._strands=[]}return p(r,[{key:"getName",value:function(){return this._name}},{key:"getWidth",value:function(){return this._width}},{key:"addStrand",value:function(e){this._strands.push(e),this._width=this._strands.length}},{key:"addEmptyStrand",value:function(){this._strands.push(new pt(null,null,null,null,null,null))}},{key:"_finalize",value:function(e,t,r){for(var n=this._strands,i=0,o=n.length;i<o;++i)n[i]._finalize(e,t,r);if(this._width||(this._width=n.length),n.length!==this._width)throw new Error("Sheet ".concat(this._name," is inconsistent."))}}]),r}(),_t=function(){function o(e,t,r,n,i){W(this,o),this._id=e,this._name=t,this._position=r||new me.Vector3,this._atoms=n||[],this._charge=0,this._repeat=1,this._center=null,this.xmlNodeRef=i||null}return p(o,[{key:"getName",value:function(){return this._name}},{key:"getPosition",value:function(){return this._position}},{key:"getCentralPoint",value:function(){return this._center}},{key:"_rebuildSGroupOnAtomChange",value:function(){if(null!==this._center){for(var e=new me.Vector3(1e8,1e8,1e8),t=new me.Vector3(-1e8,-1e8,-1e8),r=0,n=this._atoms.length;r<n;r++){var i=this._atoms[r].position;e.set(Math.min(e.x,i.x),Math.min(e.y,i.y),Math.min(e.z,i.z)),t.set(Math.max(t.x,i.x),Math.max(t.y,i.y),Math.max(t.z,i.z))}this._center.addVectors(e,t),this._center.multiplyScalar(.5)}}}]),o}();function vt(e,t,r,n){for(r=r||{},n=e.length;n--;r[e[n]]=t);return r}function gt(){this.yy={}}var yt={parser:(ot=[1,17],st=[1,22],at=[1,20],lt=[1,21],ct=[5,7,8,11,19],ut={trace:function(){},yy:{},symbols_:{error:2,Program:3,Expression:4,EOF:5,Selector:6,OR:7,AND:8,NOT:9,"(":10,")":11,SELECTOR:12,NAMED_SELECTOR:13,SELECTOR_RANGED:14,RangeList:15,SELECTOR_NAMED:16,NameList:17,Range:18,",":19,NUMBER:20,":":21,Name:22,IDENTIFIER:23,STRING:24,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"OR",8:"AND",9:"NOT",10:"(",11:")",12:"SELECTOR",13:"NAMED_SELECTOR",14:"SELECTOR_RANGED",16:"SELECTOR_NAMED",19:",",20:"NUMBER",21:":",23:"IDENTIFIER",24:"STRING"},productions_:[0,[3,2],[4,1],[4,3],[4,3],[4,2],[4,3],[6,1],[6,1],[6,2],[6,2],[15,1],[15,3],[18,1],[18,3],[17,1],[17,3],[22,1],[22,1],[22,1]],performAction:function(e,t,r,n,i,o){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=n.keyword("or")(o[s-2],o[s]);break;case 4:this.$=n.keyword("and")(o[s-2],o[s]);break;case 5:this.$=n.keyword("not")(o[s]);break;case 6:this.$=o[s-1];break;case 7:this.$=n.keyword(o[s])();break;case 8:this.$=n.GetSelector(o[s].toLowerCase().slice(1,o[s].length));break;case 9:case 10:this.$=n.keyword(o[s-1])(o[s]);break;case 11:this.$=new n.RangeList(o[s]);break;case 12:case 16:this.$=o[s-2].append(o[s]);break;case 13:this.$=new n.Range(Number(o[s]));break;case 14:this.$=new n.Range(Number(o[s-2]),Number(o[s]));break;case 15:this.$=new n.ValueList(o[s])}},table:[{3:1,4:2,6:3,9:Ze=[1,4],10:Ke=[1,5],12:Qe=[1,6],13:Je=[1,7],14:et=[1,8],16:tt=[1,9]},{1:[3]},{5:[1,10],7:rt=[1,11],8:nt=[1,12]},vt(it=[5,7,8,11],[2,2]),{4:13,6:3,9:Ze,10:Ke,12:Qe,13:Je,14:et,16:tt},{4:14,6:3,9:Ze,10:Ke,12:Qe,13:Je,14:et,16:tt},vt(it,[2,7]),vt(it,[2,8]),{15:15,18:16,20:ot},{17:18,20:st,22:19,23:at,24:lt},{1:[2,1]},{4:23,6:3,9:Ze,10:Ke,12:Qe,13:Je,14:et,16:tt},{4:24,6:3,9:Ze,10:Ke,12:Qe,13:Je,14:et,16:tt},vt(it,[2,5]),{7:rt,8:nt,11:[1,25]},vt(it,[2,9],{19:[1,26]}),vt(ct,[2,11]),vt(ct,[2,13],{21:[1,27]}),vt(it,[2,10],{19:[1,28]}),vt(ct,[2,15]),vt(ct,[2,17]),vt(ct,[2,18]),vt(ct,[2,19]),vt([5,7,11],[2,3],{8:nt}),vt(it,[2,4]),vt(it,[2,6]),{18:29,20:ot},{20:[1,30]},{20:st,22:31,23:at,24:lt},vt(ct,[2,12]),vt(ct,[2,14]),vt(ct,[2,16])],defaultActions:{10:[2,1]},parseError:function(e,t){if(!t.recoverable){var r=new Error(e);throw r.hash=t,r}this.trace(e)},parse:function(e){var t=this,r=[0],n=[],i=[null],o=[],s=this.table,a="",l=0,c=0,u=1,h=o.slice.call(arguments,1),d=Object.create(this.lexer),f={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(f.yy[p]=this.yy[p]);d.setInput(e,f.yy),f.yy.lexer=d,f.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var m=d.yylloc;o.push(m);var _=d.options&&d.options.ranges;"function"==typeof f.yy.parseError?this.parseError=f.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var v,g,y,x,b,w,S,C,A,E={};;){if(g=r[r.length-1],void 0===(y=this.defaultActions[g]?this.defaultActions[g]:(null==v&&(A=void 0,"number"!=typeof(A=n.pop()||d.lex()||u)&&(A instanceof Array&&(A=(n=A).pop()),A=t.symbols_[A]||A),v=A),s[g]&&s[g][v]))||!y.length||!y[0]){var k="";for(b in C=[],s[g])this.terminals_[b]&&2<b&&C.push("'"+this.terminals_[b]+"'");k=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+C.join(", ")+", got '"+(this.terminals_[v]||v)+"'":"Parse error on line "+(l+1)+": Unexpected "+(v==u?"end of input":"'"+(this.terminals_[v]||v)+"'"),this.parseError(k,{text:d.match,token:this.terminals_[v]||v,line:d.yylineno,loc:m,expected:C})}if(y[0]instanceof Array&&1<y.length)throw new Error("Parse Error: multiple actions possible at state: "+g+", token: "+v);switch(y[0]){case 1:r.push(v),i.push(d.yytext),o.push(d.yylloc),r.push(y[1]),v=null,c=d.yyleng,a=d.yytext,l=d.yylineno,m=d.yylloc;break;case 2:if(w=this.productions_[y[1]][1],E.$=i[i.length-w],E._$={first_line:o[o.length-(w||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(w||1)].first_column,last_column:o[o.length-1].last_column},_&&(E._$.range=[o[o.length-(w||1)].range[0],o[o.length-1].range[1]]),void 0!==(x=this.performAction.apply(E,[a,c,l,f.yy,y[1],i,o].concat(h))))return x;w&&(r=r.slice(0,-1*w*2),i=i.slice(0,-1*w),o=o.slice(0,-1*w)),r.push(this.productions_[y[1]][0]),i.push(E.$),o.push(E._$),S=s[r[r.length-2]][r[r.length-1]],r.push(S);break;case 3:return!0}}return!0}},ht={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,r=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(20<e.length?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(20<e.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var r,n,i;if(this.options.backtrack_lexer&&(i={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(i.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],r=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var o in i)this[o]=i[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,r,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((r=this._input.match(this.rules[i[o]]))&&(!t||r[0].length>t[0].length)){if(t=r,n=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(r,i[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,i[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return 0<this.conditionStack.length-1?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return 0<=(e=this.conditionStack.length-1-Math.abs(e||0))?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,r){switch(r){case 0:break;case 1:return 20;case 2:return 7;case 3:return 8;case 4:return 9;case 5:return 12;case 6:return 16;case 7:return 14;case 8:return 10;case 9:return 11;case 10:return 19;case 11:return 21;case 12:return"<=";case 13:return">=";case 14:return"<";case 15:return">";case 16:return t.yytext=t.yytext.substr(1,t.yyleng-2),24;case 17:return 13;case 18:return 23;case 19:return 5;case 20:return"INVALID"}},rules:[/^(?:\s+)/i,/^(?:(-?(?:[1-9][0-9]+|[0-9]))\b)/i,/^(?:OR\b)/i,/^(?:AND\b)/i,/^(?:NOT\b)/i,/^(?:((ALL|NONE|HETATM|PROTEIN|BASIC|ACIDIC|CHARGED|POLAR|NONPOLAR|AROMATIC|NUCLEIC|PURINE|PYRIMIDINE|WATER|POLARH|NONPOLARH))\b)/i,/^(?:((NAME|ELEM|TYPE|RESIDUE|ICODE|CHAIN|ALTLOC))\b)/i,/^(?:((SERIAL|SEQUENCE|RESIDX))\b)/i,/^(?:\()/i,/^(?:\))/i,/^(?:,)/i,/^(?::)/i,/^(?:<=)/i,/^(?:>=)/i,/^(?:<)/i,/^(?:>)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:(@[_A-Z0-9]+))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],inclusive:!0}}},ut.lexer=ht,new((gt.prototype=ut).Parser=gt))}.parser,xt=function(){function r(e,t){W(this,r),this.min=e,this.max=void 0===t?e:t}return p(r,[{key:"includes",value:function(e){return this.min<=e&&e<=this.max}},{key:"toString",value:function(){var e=this.min,t=this.max;return e===t?String(e):[e,t].join(":")}},{key:"toJSON",value:function(){return[this.min,this.max]}}]),r}(),bt=function(){function t(e){if(W(this,t),e instanceof this.constructor)return e;e instanceof Array?this._values=e.slice(0):this._values=e?[e]:[]}return p(t,[{key:"append",value:function(e){var t=this._values;return t[t.length]=e,this}},{key:"remove",value:function(e){var t=this._values,r=t.indexOf(e);return 0<=r&&t.splice(r,1),this}},{key:"toString",value:function(){return this._values.join(",")}},{key:"toJSON",value:function(){for(var e=this._values,t=[],r=0,n=e.length;r<n;++r){var i=e[r];t[r]=i.toJSON?i.toJSON():i}return t}}]),t}(),wt=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,bt),p(e,[{key:"includes",value:function(e){for(var t=this._values,r=0,n=t.length;r<n;++r)if(t[r].includes(e))return!0;return!1}}]),e}(),St=[],Ct=function(){function l(e,t){var r;W(this,l);var n=r=Y(this,X(l).call(this,e));if(t){r.upperOnly=!0;for(var i=n._values,o=0,s=i.length;o<s;++o){var a=i[o];"string"==typeof a&&(i[o]=a.toUpperCase())}}else r.upperOnly=!1;return Y(r,n)}return A(l,bt),p(l,[{key:"includes",value:function(e){return-1!==this._values.indexOf(e)}},{key:"toString",value:function(){for(var e=this._values,t=St.length=0,r=e.length;t<r;++t)St[t]=_e.correctSelectorIdentifier(String(e[t]));return St.join(",")}},{key:"_validate",value:function(e){return this.upperOnly&&"string"==typeof e?e.toUpperCase():e}},{key:"append",value:function(e){return ft(X(l.prototype),"append",this).call(this,this._validate(e)),this}},{key:"remove",value:function(e){return ft(X(l.prototype),"remove",this).call(this,this._validate(e)),this}}]),l}(),At=function(){function e(){W(this,e)}return p(e,[{key:"toString",value:function(){return this.keyword}},{key:"toJSON",value:function(){return[this.name]}}]),e}();At.prototype.name="Error",At.prototype.keyword="error";var Et=function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this))).list=e,t}return A(r,At),p(r,[{key:"toString",value:function(){return"".concat(this.keyword," ").concat(this.list)}},{key:"toJSON",value:function(){return[this.name,this.list.toJSON()]}}]),r}(),kt=function(){function t(e){return W(this,t),Y(this,X(t).call(this,new wt(e)))}return A(t,Et),t}(),Tt=function(){function r(e,t){return W(this,r),Y(this,X(r).call(this,new Ct(e,!t)))}return A(r,Et),r}(),Rt=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(){return!1}}]),e}();Rt.prototype.name="None",Rt.prototype.keyword="none";var Mt=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(){return!0}}]),e}();Mt.prototype.name="All",Mt.prototype.keyword="all";var Pt=new Rt,Nt=function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this))).rhs=e||Pt,t}return A(r,At),p(r,[{key:"toString",value:function(){var e=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(this.keyword," ").concat(e)}},{key:"toJSON",value:function(){return[this.name,this.rhs.toJSON()]}}]),r}();Nt.prototype.priority=1;var It=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this))).lhs=e||Pt,r.rhs=t||Pt,r}return A(n,At),p(n,[{key:"toString",value:function(){var e=this.lhs.priority&&this.lhs.priority>this.priority?"(".concat(this.lhs,")"):this.lhs,t=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(e," ").concat(this.keyword," ").concat(t)}},{key:"toJSON",value:function(){return[this.name,this.lhs.toJSON(),this.rhs.toJSON()]}}]),n}();It.prototype.priority=1e3;var Lt={};function Ot(e,n){var t=e.toLowerCase();n.prototype.keyword=t,n.prototype.name=e;function r(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return E(n,t)}return r.SelectorClass=n,Lt[t]=r,n}Ot("Serial",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,kt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.serial)}}]),e}()),Ot("Name",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Tt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.name)}}]),e}()),Ot("AltLoc",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Tt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(String.fromCharCode(e.location))}}]),e}()),Ot("Elem",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Tt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.element.name)}}]),e}()),Ot("Residue",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Tt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._type._name)}}]),e}()),Ot("Sequence",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,kt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._sequence)}}]),e}()),Ot("ICode",function(){function t(e){return W(this,t),Y(this,X(t).call(this,e,!0))}return A(t,Tt),p(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._icode)}}]),t}()),Ot("ResIdx",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,kt),p(e,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._index)}}]),e}()),Ot("Chain",function(){function t(e){return W(this,t),Y(this,X(t).call(this,e,!0))}return A(t,Tt),p(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._chain._name)}}]),t}()),Ot("Hetatm",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(e){return e.het}}]),e}()),Ot("PolarH",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(e){return(e.flags&Ae.Flags.NONPOLARH)===Ae.Flags.HYDROGEN}}]),e}()),Ot("NonPolarH",function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(e){return(e.flags&Ae.Flags.NONPOLARH)===Ae.Flags.NONPOLARH}}]),e}()),Ot("All",Mt),Ot("None",Rt);var Vt=Lt.none();function Dt(e,t,r){return r.prototype.priority=t,Ot(e,r)}function zt(t,e){return Ot(e,function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,At),p(e,[{key:"includesAtom",value:function(e){return 0!=(e.residue._type.flags&t)}}]),e}())}Dt("Not",1,function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Nt),p(e,[{key:"includesAtom",value:function(e){return!this.rhs.includesAtom(e)}}]),e}()),Dt("And",2,function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,It),p(e,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)&&this.rhs.includesAtom(e)}}]),e}()),Dt("Or",3,function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,It),p(e,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)||this.rhs.includesAtom(e)}}]),e}()),zt(Ve.Flags.PROTEIN,"Protein"),zt(Ve.Flags.BASIC,"Basic"),zt(Ve.Flags.ACIDIC,"Acidic"),zt(Ve.Flags.BASIC|Ve.Flags.ACIDIC,"Charged"),zt(Ve.Flags.POLAR,"Polar"),zt(Ve.Flags.NONPOLAR,"NonPolar"),zt(Ve.Flags.AROMATIC,"Aromatic"),zt(Ve.Flags.NUCLEIC,"Nucleic"),zt(Ve.Flags.PURINE,"Purine"),zt(Ve.Flags.PYRIMIDINE,"Pyrimidine"),zt(Ve.Flags.WATER,"Water");var Ft=Object.create(Lt);Ft.Selector=At,Ft.RangeListSelector=kt,Ft.ValueListSelector=Tt,Ft.Range=xt,Ft.RangeList=wt,Ft.ValueList=Ct,Ft.PrefixOperator=Nt,Ft.InfixOperator=It,Ft.Context=Object.create({}),Ft.GetSelector=function(e){if(Ft.Context.hasOwnProperty(e))return Ft.Context[e]||Vt;throw{message:"selector ".concat(e," is not registered")}},Ft.ClearContext=function(){Object.keys(Ft.Context).forEach(function(e){delete Ft.Context[e]})},Ft.keyword=function(e){return Lt[e.toLowerCase()]||Lt.none},Ft.parse=function(e){var t={};try{t.selector=yt.parse(e)}catch(e){t.selector=Vt,t.error=e.message}return t},yt.yy=Ft,yt.yy.parseError=yt.parseError;var Bt=function(){function t(e){W(this,t),this._complex=e,this._selector=Ft.keyword("All")(),this._boundaries={boundingBox:new me.Box3,boundingSphere:new me.Sphere}}return p(t,[{key:"computeBoundaries",value:function(){var e=this._complex._atoms,t=e.length,r=this._selector,n=this._boundaries.boundingBox;if(n.makeEmpty(),1===t){n.expandByPoint(e[0].position);var i=new me.Vector3;n.getCenter(i);var o=2*e[0].element.radius;n.setFromCenterAndSize(i,new me.Vector3(o,o,o))}else for(var s=0;s<t;++s)r.includesAtom(e[s])&&n.expandByPoint(e[s].position);var a=0,l=new me.Vector3;if(n.getCenter(l),1===t)this._boundaries.boundingSphere.set(l,e[0].element.radius);else{for(var c=0;c<t;++c)if(r.includesAtom(e[c])){var u=e[c].position,h=l.distanceToSquared(u);a<h&&(a=h)}this._boundaries.boundingSphere.set(l,Math.sqrt(a))}}},{key:"getTransforms",value:function(){return[]}},{key:"getSelector",value:function(){return this._selector}},{key:"getBoundaries",value:function(){return this._boundaries}},{key:"finalize",value:function(){}}]),t}(),Ut=function(){function l(e){var t;return W(this,l),(t=Y(this,X(l).call(this,e))).chains=[],t.matrices=[],t}return A(l,Bt),p(l,[{key:"computeBoundaries",value:function(){ft(X(l.prototype),"computeBoundaries",this).call(this);var e=this.matrices,t=this._boundaries.boundingSphere.center,r=this._boundaries.boundingSphere.radius,n=this._boundaries.boundingBox=new me.Box3;n.makeEmpty();for(var i=0,o=e.length;i<o;++i)n.expandByPoint(t.clone().applyMatrix4(e[i]));var s=n.max.distanceTo(n.min)/2+r,a=new me.Vector3;n.getCenter(a),this._boundaries.boundingSphere=(new me.Sphere).set(a,s),n.max.addScalar(r),n.min.subScalar(r)}},{key:"addChain",value:function(e){this.chains[this.chains.length]=e}},{key:"addMatrix",value:function(e){this.matrices[this.matrices.length]=e}},{key:"getTransforms",value:function(){return this.matrices}},{key:"finalize",value:function(){0<this.chains.length?this._selector=Ft.keyword("Chain")(this.chains):this._selector=Ft.keyword("None")()}}]),l}(),Gt=function(){function t(e){W(this,t),this._complex=e,this._index=-1,this._residueIndices=[],this._cycles=[],this._subDivs=[],this._residueCount=0}return p(t,[{key:"getResidues",value:function(){return this._complex._residues}},{key:"getResidueCount",value:function(){return this._residueCount}},{key:"forEachResidue",value:function(e){for(var t=this._complex._residues,r=this._residueIndices,n=0,i=r.length;n<i;++n)for(var o=r[n].start,s=r[n].end;o<=s;++o)e(t[o])}},{key:"setSubDivs",value:function(e){for(var t=0,r=[],n=0,i=0,o=(this._subDivs=e).length;i<o;++i)if(i===o-1||e[i].end+1!==e[i+1].start){var s=e[t].start,a=e[i].end;r[r.length]={start:s,end:a},n+=a-s+1,t=i+1}this._residueIndices=r,this._residueCount=n}},{key:"getComplex",value:function(){return this._complex}},{key:"forEachBond",value:function(e){for(var t=this._complex._bonds,r=0,n=t.length;r<n;++r){var i=t[r];i._left.residue._component===this&&e(i)}}},{key:"update",value:function(){this.forEachCycle(function(e){e.update()})}},{key:"forEachAtom",value:function(t){this.forEachResidue(function(e){e.forEachAtom(t)})}},{key:"addCycle",value:function(e){this._cycles.push(e)}},{key:"forEachCycle",value:function(e){for(var t=this._cycles,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"markResidues",value:function(){var t=this;t.forEachResidue(function(e){e._component=t})}},{key:"_forEachSubChain",value:function(e,t){for(var r=this._complex._residues,n=this._subDivs,i=0,o=n.length;i<o;++i)for(var s=n[i].start,a=n[i].end;s<=a;++s){var l=r[s];if(e&l._mask&&l._isValid){for(var c=s+1;c<=a;++c){var u=r[c];if(!(e&u._mask&&u._isValid))break}t(i,s,c-1),s=c}}}},{key:"getMaskedSequences",value:function(e){var n=[],i=0;return this._forEachSubChain(e,function(e,t,r){n[i++]={start:t,end:r}}),n}},{key:"getMaskedSubdivSequences",value:function(e){var n=[],i=-1,o=-1,s=this._subDivs;return this._forEachSubChain(e,function(e,t,r){o!==e&&(n[++i]={arr:[],boundaries:s[e]},o=e),n[i].arr[n[i].arr.length]={start:t,end:r}}),n}}]),t}(),jt=1048576,Ht=function(){function n(e){W(this,n),this.numPairs=0,this.numMaxPairs=e,this.intBuffer=_e.allocateTyped(Int32Array,4*e);for(var t=0;t<4*e;t++)this.intBuffer[t]=-1;this.hashBuffer=_e.allocateTyped(Int32Array,32*jt);for(var r=0;r<32*jt;r++)this.hashBuffer[r]=-1}return p(n,[{key:"destroy",value:function(){this.intBuffer=null,this.hashBuffer=null}},{key:"addPair",value:function(e,t){for(var r=e<t?e:t,n=t<e?e:t,i=r+(n<<14),o=32*(r+89237*n&jt-1),s=0;s<32;s++){var a=this.hashBuffer[o+s];if(-1===a)break;if(a===i)return!1}if(32<=s)throw new Error("addPair: increase cMaxPairsForHashCode");if(this.hashBuffer[o+s]=i,this.numPairs>=this.numMaxPairs)throw new Error("addPair: increase num pairs");return o=4*this.numPairs,this.intBuffer[o]=r,this.intBuffer[o+1]=n,this.intBuffer[o+2]=i,this.numPairs++,!0}}]),n}();function Wt(e){var t=e.element;if(t)return t.radiusBonding;throw new Error("_getBondingRadius: Logic error.")}var Yt,Xt,qt,$t=function(){function r(e){W(this,r),this._complex=e,this._maxRad=1.8;var t=this._complex.getDefaultBoundaries().boundingBox;this._vBoxMin=t.min.clone(),this._vBoxMax=t.max.clone(),this._pairCollection=null}return p(r,[{key:"_addExistingPairs",value:function(){for(var e=this._complex.getAtoms(),t=e.length,r=0,n=this._pairCollection;r<t;r++)for(var i=e[r].bonds,o=i.length,s=0;s<o;s++){var a=i[s];a._left.index===r&&n.addPair(r,a._right.index)}return 0}},{key:"_findPairs",value:function(){var e=this._complex.getVoxelWorld();if(null!==e)for(var o,s,a,l,c,t,r=this._complex._atoms,n=r.length,u=this,i=function(e){if(!s||!e.isHydrogen()){var t=e.location;if(32===l||32===t||l===t){var r=a.distanceToSquared(e.position),n=e.element.radiusBonding,i=o+n+.45;i*i<r||r<.001||u._pairCollection.addPair(c.index,e.index)}}},h=0;h<n;++h)c=r[h],(!(t=c).isHet()||t.bonds&&0===t.bonds.length)&&(o=c.element.radiusBonding,s=c.isHydrogen(),a=c.position,l=c.location,e.forEachAtomWithinRadius(a,2*this._maxRad+.45,i))}},{key:"_addPairs",value:function(){for(var e=this._complex._atoms,t=0,r=0;t<this._pairCollection.numPairs;t++,r+=4){var n=this._pairCollection.intBuffer[r],i=this._pairCollection.intBuffer[r+1];this._addPair(e[n],e[i])}}},{key:"_addPair",value:function(e,t){for(var r=e.bonds,n=e.index,i=t.index,o=0,s=r.length;o<s;++o){var a=r[o];if(a._left.index===i||a._right.index===i)return}var l=n<i?e:t,c=n<i?t:e,u=this._complex.addBond(l,c,0,Re.BondType.UNKNOWN,!1);r.push(u),t.bonds.push(u)}},{key:"build",value:function(){this._buildInner()}},{key:"_buildInner",value:function(){var e=this._complex._atoms;if(!(e.length<2)){if(e[0].index<0)throw new Error("AutoBond: Atoms in complex were not indexed.");this._calcBoundingBox(),this._pairCollection=new Ht(4*e.length),this._addExistingPairs(),this._findPairs(),this._addPairs()}}},{key:"_calcBoundingBox",value:function(){for(var e=this._complex._atoms,t=e.length,r=Wt(e[0]),n=1;n<t;++n)r=Math.max(r,Wt(e[n]));this._vBoxMax.addScalar(r),this._vBoxMin.addScalar(-r),this._maxRad=1.2*r}},{key:"destroy",value:function(){this._pairCollection&&this._pairCollection.destroy()}}]),r}(),Zt=Re.BondType.AROMATIC,Kt=[Ee.ByName.C.number,Ee.ByName.N.number],Qt=(Yt=new me.Vector3,Xt=new me.Vector3,qt=new me.Vector3,function(e,t){return Yt.copy(e).normalize(),Xt.copy(t).normalize(),qt.crossVectors(Yt,Xt),!(.1<qt.length())&&0<=Yt.dot(Xt)});function Jt(e,t){for(var r=0;r<e.length&&e[r]<t;)++r;e.splice(r,0,t)}function er(e,t){return e._left===t?e._right:e._left}function tr(e){e._type=Zt}var rr=function(){function t(e){W(this,t),this.atoms=e,this.update()}return p(t,[{key:"update",value:function(){for(var e=this.atoms,t=new me.Vector3,r=e.length,n=0;n<r;++n)t.add(e[n].position);t.multiplyScalar(1/r),this.center=t,this.radius=t.distanceTo(e[0].position.clone().lerp(e[1].position,.5))}},{key:"forEachBond",value:function(t){var r,e=this.atoms,n=e.length,i=e[0];function o(e){e._left!==r&&e._right!==r||t(e)}for(var s=0;s<n;++s)r=e[(s+1)%n],i.forEachBond(o),i=r}}]),t}();function nr(e){return e._type===Zt}function ir(e){if(e.type===Zt)return!0;var t=Kt.indexOf(e._right.element.number),r=Kt.indexOf(e._left.element.number);return-1!==t&&-1!==r}function or(e){return 3<e.length}function sr(e){return!0}var ar=function(){function o(e){W(this,o),this._complex=e;for(var t=new Array(e._bonds.length),r=new Array(e._bonds.length),n=0,i=t.length;n<i;++n)t[n]=[],r[n]=!1;this._bondsData=t,this._bondMarks=r,this._resetCycles()}return p(o,[{key:"_resetCycles",value:function(){this._cycles=[],this._currIdx=-1}},{key:"_haveSameCycle",value:function(e,t,r){for(var n=e[t._index],i=e[r._index],o=n.length,s=i.length,a=0,l=0;a<o&&l<s;){if(n[a]===i[l])return!0;n[a]>i[l]?++l:++a}return!1}},{key:"_tryBond",value:function(c,u,h){var d=[],f=this._bondsData,e=er(c,u),p=u.position.clone().sub(e.position),m=this._currStart,_=this,v=this._bondMarks,g=this._checkBond;v[c._index]=!0,g=void 0===g?nr:g,u.forEachBond(function(e){if(g(e)&&e!==c&&!v[e._index]&&!_._haveSameCycle(f,c,e)){var t,r,n,i=er(e,u),o=i.position.clone().sub(u.position),s=i===m?-2:1-(r=o,n=(t=p).dot(r)/Math.sqrt(t.lengthSq()*r.lengthSq()),me.Math.clamp(n,-1,1)),a=o.cross(p);if(Qt(a,h)){for(var l=0;l<d.length&&d[l].val<s;)++l;d.splice(l,0,{bond:e,val:s,dir:a})}}});for(var t=0,r=d.length;t<r;++t){var n=d[t].bond,i=n._left===u?n._right:n._left;if(i===m)return++this._currIdx,this._cycles.push([u]),!(v[c._index]=!1);if(this._tryBond(n,i,d[t].dir))return Jt(f[n._index],this._currIdx),this._cycles[this._currIdx].push(u),!(v[c._index]=!1)}return v[c._index]=!1}},{key:"_startCycle",value:function(e){this._currStart=e._left,this._tryBond(e,e._right,new me.Vector3)&&(Jt(this._bondsData[e._index],this._currIdx),this._cycles[this._currIdx].push(e._left))}},{key:"_findLoops",value:function(s,a){this._checkBond=s;var e=this._complex,l=this;e.forEachComponent(function(e){l._resetCycles(),e.forEachBond(function(e){s(e)&&l._startCycle(e)});for(var t=l._cycles,r=0,n=t.length;r<n;++r){var i=t[r];if(a(i)){var o=new rr(i);o.forEachBond(tr),e.addCycle(o)}}})}},{key:"markCycles",value:function(){this._findLoops(nr,or)}},{key:"detectCycles",value:function(){this._findLoops(ir,sr)}}]),o}();var lr=function(){function I(e,t){W(this,I),this._box=e.clone();var r=new me.Vector3;e.getSize(r),this._count=r.clone().divide(t).floor().max(new me.Vector3(1,1,1)),this._last=this._count.clone().subScalar(1),this._cellSize=r.clone().divide(this._count),this._cellInnerR=.5*Math.min(Math.min(this._cellSize.x,this._cellSize.y),this._cellSize.z),this._cellOuterR=.5*Math.sqrt(this._cellSize.dot(this._cellSize));var n=this._count.x*this._count.y*this._count.z;this._voxels=_e.allocateTyped(Int32Array,n);for(var i=0;i<n;++i)this._voxels[i]=-1;this._atoms=[]}return p(I,[{key:"addAtoms",value:function(e){var r=this,n=this._atoms.length;this._atoms.length+=2*e.getAtomCount(),e.forEachAtom(function(e){var t=r._findVoxel(e.position);r._atoms[n]=e,r._atoms[n+1]=r._voxels[t],r._voxels[t]=n,n+=2})}},{key:"_findVoxel",value:function(e){var t=I._zero,r=I._voxel;return r.copy(e).sub(this._box.min).divide(this._cellSize).floor().clamp(t,this._last),r.x+this._count.x*(r.y+this._count.y*r.z)}},{key:"_forEachAtomInVoxel",value:function(e,t){for(var r=this._voxels[e];0<=r;r=this._atoms[r+1])t(this._atoms[r])}},{key:"_forEachVoxelWithinRadius",value:function(e,t,r){var n=I._xRange,i=I._yRange,o=I._zRange;if(t/this._cellInnerR<10)this._forEachVoxelWithinRadiusSimple(e,t,r);else{var s,a,l,c,u,h,d,f,p,m,_,v,g,y,x,b,w,S,C,A,E,k,T,R;o.set(e.z-t,e.z+t),o.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor().clampScalar(0,this._count.z-1);for(var M=o.x;M<=o.y;++M){u=[this._box.min.z+M*this._cellSize.z,this._box.min.z+(M+1)*this._cellSize.z],f=e.z-t<=u[0]&&u[1]<=e.z+t,S=t,A=u[1],0,E=(C=u[0])-(w=e).z,k=A-w.z,T=Math.sqrt(Math.max(S*S-E*E,0)),R=Math.sqrt(Math.max(S*S-k*k,0)),s=[Math.min(T,R),C<=w.z&&A>=w.z?S:Math.max(T,R)],i.set(e.y-s[1],e.y+s[1]),i.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor().clampScalar(0,this._count.y-1);for(var P=i.x;P<=i.y;++P){c=[this._box.min.y+P*this._cellSize.y,this._box.min.y+(P+1)*this._cellSize.y],d=e.y-s[0]<=c[0]&&c[1]<=e.y+s[0],m=s[1],v=c[1],0,g=(_=c[0])-(p=e).y,y=v-p.y,x=Math.sqrt(Math.max(m*m-g*g,0)),b=Math.sqrt(Math.max(m*m-y*y,0)),a=[Math.min(x,b),_<=p.y&&v>=p.y?m:Math.max(x,b)],n.set(e.x-a[1],e.x+a[1]),n.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor().clampScalar(0,this._count.x-1);for(var N=n.x;N<=n.y;++N)l=[this._box.min.x+N*this._cellSize.x,this._box.min.x+(N+1)*this._cellSize.x],h=e.x-a[0]<=l[0]&&l[1]<=e.x+a[0],r(N+this._count.x*(P+this._count.y*M),h&&d&&f)}}}}},{key:"_forEachVoxelWithinRadiusSimple",value:function(e,t,r){var n=I._xRange,i=I._yRange,o=I._zRange,s=I._vCenter,a=(t+this._cellOuterR)*(t+this._cellOuterR),l=-1;t>this._cellOuterR&&(l=(t-this._cellOuterR)*(t-this._cellOuterR)),n.set(e.x-t,e.x+t),n.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor(),n.x=Math.min(Math.max(n.x,0),this._count.x-1),n.y=Math.min(Math.max(n.y,0),this._count.x-1),i.set(e.y-t,e.y+t),i.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor(),i.x=Math.min(Math.max(i.x,0),this._count.y-1),i.y=Math.min(Math.max(i.y,0),this._count.y-1),o.set(e.z-t,e.z+t),o.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor(),o.x=Math.min(Math.max(o.x,0),this._count.z-1),o.y=Math.min(Math.max(o.y,0),this._count.z-1);for(var c=o.x;c<=o.y;++c){var u=[this._box.min.z+c*this._cellSize.z,this._box.min.z+(c+1)*this._cellSize.z];s.z=.5*(u[0]+u[1]);for(var h=i.x;h<=i.y;++h){var d=[this._box.min.y+h*this._cellSize.y,this._box.min.y+(h+1)*this._cellSize.y];s.y=.5*(d[0]+d[1]);for(var f=n.x;f<=n.y;++f){var p=[this._box.min.x+f*this._cellSize.x,this._box.min.x+(f+1)*this._cellSize.x];s.x=.5*(p[0]+p[1]);var m=e.distanceToSquared(s);m<=a&&r(f+this._count.x*(h+this._count.y*c),m<=l)}}}}},{key:"forEachAtomWithinRadius",value:function(r,e,n){var i=this,o=e*e;i._forEachVoxelWithinRadius(r,e,function(e,t){t?i._forEachAtomInVoxel(e,n):i._forEachAtomInVoxel(e,function(e){r.distanceToSquared(e.position)<=o&&n(e)})})}},{key:"forEachAtomWithinDistFromMasked",value:function(e,r,t,n){this._forEachAtomWithinDistFromGroup(function(t){e.forEachAtom(function(e){0!=(e.mask&r)&&t(e)})},t,n)}},{key:"forEachAtomWithinDistFromSelected",value:function(e,r,t,n){this._forEachAtomWithinDistFromGroup(function(t){e.forEachAtom(function(e){r.includesAtom(e)&&t(e)})},t,n)}},{key:"_forEachAtomWithinDistFromGroup",value:function(e,t,r){var n,i=this,o=t*t,s=[],a=[],l=0;e(function(r){i._forEachVoxelWithinRadius(r.position,t,function(e,t){t?s[e]=-1:void 0===s[e]?(a.push(r),a.push(-1),s[e]=l,l+=2):-1!==s[e]&&(a.push(r),a.push(s[e]),s[e]=l,l+=2)})});function c(e){if(void 0!==s[n])if(-1!==(l=s[n])){for(;0<=l;l=a[l+1])if(e.position.distanceToSquared(a[l].position)<o){r(e);break}}else r(e)}for(n in s)s.hasOwnProperty(n)&&i._forEachAtomInVoxel(n,c)}}]),I}();Ce(lr,"_zero",new me.Vector3(0,0,0)),Ce(lr,"_voxel",new me.Vector3),Ce(lr,"_xRange",new me.Vector2),Ce(lr,"_yRange",new me.Vector2),Ce(lr,"_zRange",new me.Vector2),Ce(lr,"_vCenter",new me.Vector3);var cr,ur,hr=-27.888,dr=function(){function t(e){W(this,t),this._complex=e,this._hbonds=[],1e3<this._complex._residues.length?this._buildVW():this._build()}return p(t,[{key:"isBond",value:function(e,t){if(this._hbonds[e]){var r=y(this._hbonds[e].acceptor,2),n=r[0],i=r[1];if(n&&n.residue===t&&n.energy<-.5)return!0;if(i&&i.residue===t&&i.energy<-.5)return!0}return!1}},{key:"_build",value:function(){for(var e=0;e<this._complex._residues.length-1;++e){var t=this._complex._residues[e];if(0!=(t.getType().flags&Ve.Flags.PROTEIN)){var r=null;0<e&&this._complex._residues[e-1].getType().flags&Ve.Flags.PROTEIN&&t._sequence===this._complex._residues[e-1]._sequence+1&&(r=this._complex._residues[e-1]);for(var n=e+1;n<this._complex._residues.length;++n){var i=this._complex._residues[n];if(0!=(i.getType().flags&Ve.Flags.PROTEIN)){var o=null;this._complex._residues[n-1].getType().flags&Ve.Flags.PROTEIN&&i._sequence===this._complex._residues[n-1]._sequence+1&&(o=this._complex._residues[n-1]),this._calcHBondEnergy(r,t,i),n!==e+1&&this._calcHBondEnergy(o,i,t)}}}}}},{key:"_buildVW",value:function(){var n,i,o=this,s=this._complex._residues,e=this._complex.getVoxelWorld();if(null!==e)for(var a=new Ht(this._complex._residues.length*this._complex._residues.length/2),t=0;t<s.length-1;++t)0!=((n=s[t]).getType().flags&Ve.Flags.PROTEIN)&&(!(i=0<t?s[t-1]:null)||0!=(i.getType().flags&Ve.Flags.PROTEIN)&&n._sequence===i._sequence+1||(i=null),e.forEachAtomWithinRadius(this._residueGetCAlpha(n),5,r));function r(e){var t=e.residue;if(t._index!==n._index&&0!=(t.getType().flags&Ve.Flags.PROTEIN)&&a.addPair(n._index,t._index)){var r=0<t._index?s[t._index-1]:null;!r||0!=(r.getType().flags&Ve.Flags.PROTEIN)&&t._sequence===r._sequence+1||(r=null),o._calcHBondEnergy(i,n,t),t._index!==n._index+1&&o._calcHBondEnergy(r,t,n)}}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var r=e._atoms[t].name;if("CA"===r||"C1"===r)return e._atoms[t].position}return null}},{key:"_residueGetCO",value:function(e){var t=null,r=null;return e.forEachAtom(function(e){"C"===e.name?t=e.position:"O"===e.name&&(r=e.position)}),[t,r]}},{key:"_residueGetNH",value:function(e,t){var r,n=this._residueGetCO(e),i=y(n,2),o=i[0],s=i[1];if(t.forEachAtom(function(e){"N"===e.name&&(r=e.position)}),o&&s&&r){var a=o.clone();return a.sub(s),a.multiplyScalar(1/a.length()),a.add(r),[r,a]}return[null,null]}},{key:"_calcHBondEnergy",value:function(e,t,r){var n=0;if(null===e)return n;if("PRO"!==t.getType().getName()){var i=this._residueGetNH(e,t),o=y(i,2),s=o[0],a=o[1],l=this._residueGetCO(r),c=y(l,2),u=c[0],h=c[1];if(null===s||null===a||null===u||null===h)return n;var d=a.distanceTo(h),f=a.distanceTo(u),p=s.distanceTo(u),m=s.distanceTo(h);n=d<.5||f<.5||p<.5||m<.5?-9.9:hr/d-hr/f+hr/p-hr/m,(n=Math.round(1e3*n)/1e3)<-9.9&&(n=-9.9)}void 0===this._hbonds[t._index]&&(this._hbonds[t._index]={donor:[],acceptor:[]});var _=this._hbonds[t._index];_.acceptor.length<2&&_.acceptor.push({residue:r._index,energy:n}),1<_.acceptor.length&&(n<_.acceptor[0].energy?(_.acceptor[1].residue=_.acceptor[0].residue,_.acceptor[1].energy=_.acceptor[0].energy,_.acceptor[0].residue=r._index,_.acceptor[0].energy=n):n<_.acceptor[1].energy&&(_.acceptor[1].residue=r._index,_.acceptor[1].energy=n)),void 0===this._hbonds[r._index]&&(this._hbonds[r._index]={donor:[],acceptor:[]});var v=this._hbonds[r._index];return v.donor.length<2&&v.donor.push({residue:t._index,energy:n}),1<v.donor.length&&(n<v.donor[0].energy?(v.donor[1].residue=v.donor[0].residue,v.donor[1].energy=v.donor[0].energy,v.donor[0].residue=t._index,v.donor[0].energy=n):n<v.donor[1].energy&&(v.donor[1].residue=t._index,v.donor[1].energy=n)),n}}]),t}(),fr=Object.freeze({NO_BRIDGE:0,PARALLEL:1,ANTI_PARALLEL:2}),pr=Object.freeze({START:1,MIDDLE:2,END:3,START_AND_END:4}),mr=Object.freeze({STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",TURN:"T",BEND:"S",LOOP:" "}),_r=function(){function t(e){W(this,t),this._complex=e,this._build()}return p(t,[{key:"_build",value:function(){this._hbonds=new dr(this._complex),this._ss=[],this._sheet=[],this._betaPartners=[],this._bend=[];for(var e=0;e<this._complex.getResidues().length;++e)this._betaPartners[e]=[];this._helixFlags=[],this._helixFlags[3]=[],this._helixFlags[4]=[],this._helixFlags[5]=[],this._chainLengths=[];for(var t=0;t<this._complex._chains.length;++t){for(var r=this._complex._chains[t].getResidues(),n=0;n<r.length&&0!=(r[n].getType().flags&Ve.Flags.PROTEIN);++n);this._chainLengths[t]=n}this._buildBetaSheets();for(var i=0;i<this._complex._chains.length;++i)this._buildAlphaHelices(this._complex._chains[i].getResidues(),this._chainLengths[i],!1)}},{key:"_buildAlphaHelices",value:function(e,t,r){for(var n=3;n<=5&&!(e.length<n);++n)for(var i=0;i+n<t;++i)if(this._hbonds.isBond(e[i+n]._index,e[i]._index)){this._helixFlags[n][e[i+n]._index]=pr.END;for(var o=i+1;o<i+n;++o)void 0===this._helixFlags[n][e[o]._index]&&(this._helixFlags[n][e[o]._index]=pr.MIDDLE);this._helixFlags[n][e[i]._index]===pr.END?this._helixFlags[n][e[i]._index]=pr.START_AND_END:this._helixFlags[n][e[i]._index]=pr.START}for(var s=2;s<t-2;++s){var a=this._kappa(e[s-2],e[s],e[s+2]);this._bend[e[s]._index]=360!==a&&70<a}for(var l=1;l+4<t;++l)if(this._isHelixStart(e[l]._index,4)&&this._isHelixStart(e[l-1]._index,4))for(var c=l;c<=l+3;++c)this._ss[e[c]._index]=mr.HELIX_ALPHA;for(var u=1;u+3<t;++u)if(this._isHelixStart(e[u]._index,3)&&this._isHelixStart(e[u-1]._index,3)){for(var h=!0,d=u;h&&d<=u+2;++d)h=void 0===this._ss[e[d]._index]||this._ss[e[d]._index]===mr.HELIX_310;if(h)for(var f=u;f<=u+2;++f)this._ss[e[f]._index]=mr.HELIX_310}for(var p=1;p+5<t;++p)if(this._isHelixStart(e[p]._index,5)&&this._isHelixStart(e[p-1]._index,5)){for(var m=!0,_=p;m&&_<=p+4;++_)m=void 0===this._ss[e[_]._index]||this._ss[e[_]._index]===mr.HELIX_PI||r&&this._ss[e[_]._index]===mr.HELIX_ALPHA;if(m)for(var v=p;v<=p+4;++v)this._ss[e[v]._index]=mr.HELIX_PI}for(var g=1;g+1<t;++g)if(void 0===this._ss[e[g]._index]){for(var y=!1,x=3;x<=5&&!y;++x)for(var b=1;b<x&&!y;++b)y=b<=g&&this._isHelixStart(e[g-b]._index,x);y?this._ss[e[g]._index]=mr.TURN:this._bend[e[g]._index]&&(this._ss[e[g]._index]=mr.BEND)}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var r=e._atoms[t].name;if("CA"===r||"C1"===r)return e._atoms[t].position}return null}},{key:"_cosinusAngle",value:function(e,t,r,n){var i=e.clone().sub(t),o=r.clone().sub(n),s=0,a=i.dot(i)*o.dot(o);return 0<a&&(s=i.dot(o)/Math.sqrt(a)),s}},{key:"_kappa",value:function(e,t,r){var n=this._residueGetCAlpha(t),i=this._residueGetCAlpha(e),o=this._residueGetCAlpha(r);if(null===n||null===i||null===o)return 180;var s=this._cosinusAngle(n,i,o,n),a=Math.sqrt(1-s*s);return 180*Math.atan2(a,s)/Math.PI}},{key:"_isHelixStart",value:function(e,t){return this._helixFlags[t][e]===pr.START||this._helixFlags[t][e]===pr.START_AND_END}},{key:"_buildBetaSheets",value:function(){for(var e=[],t=0;t<this._complex._chains.length;++t){var r=this._chainLengths[t];if(!(r<=4))for(var n=this._complex._chains[t].getResidues(),i=t;i<this._complex._chains.length;++i){var o=this._chainLengths[i];if(!(o<=4))for(var s=this._complex._chains[i].getResidues(),a=1;a+1<r;++a){var l=n[a],c=1;for(i===t&&(c=a+3);c+1<o;++c){var u=s[c],h=this._testBridge(n,a,s,c);if(h!==fr.NO_BRIDGE){var d=!1,f=!0,p=!1,m=void 0;try{for(var _,v=e[Symbol.iterator]();!(f=(_=v.next()).done);f=!0){var g=_.value;if(h===g.type&&l._index===g.i[g.i.length-1]+1){if(h===fr.PARALLEL&&g.j[g.j.length-1]+1===u._index){g.i.push(l._index),g.j.push(u._index),d=!0;break}if(h===fr.ANTI_PARALLEL&&g.j[0]-1===u._index){g.i.push(l._index),g.j.unshift(u._index),d=!0;break}}}}catch(e){p=!0,m=e}finally{try{f||null==v.return||v.return()}finally{if(p)throw m}}d||e.push({type:h,i:[l._index],chainI:l.getChain()._index,j:[u._index],chainJ:u.getChain()._index})}}}}}e.sort(function(e,t){return e.chainI<t.chainI||e.chainI===t.chainI&&e.i[0]<t.i[0]?-1:1});for(var y=0;y<e.length;++y)for(var x=y+1;x<e.length;++x){var b=e[y].i[0],w=e[y].i[e[y].i.length-1],S=e[y].j[0],C=e[y].j[e[y].j.length-1],A=e[x].i[0],E=e[x].i[e[x].i.length-1],k=e[x].j[0],T=e[x].j[e[x].j.length-1];if(!(e[y].type!==e[x].type||this._hasChainBreak(Math.min(b,A),Math.max(w,E))||this._hasChainBreak(Math.min(S,k),Math.max(C,T))||6<=A-w||A<=w&&b<=E)){(e[y].type===fr.PARALLEL?k-C<6&&A-w<3||k-C<3:S-T<6&&A-w<3||S-T<3)&&(e[y].i=e[y].i.concat(e[x].i),e[y].type===fr.PARALLEL?e[y].j=e[y].j.concat(e[x].j):e[y].j=e[x].j.concat(e[y].j),e.splice(x--,1))}}for(var R=new Set,M=0;M<e.length;++M)R.add(e[M]);for(var P=1,N=0;0<R.size;){var I=R.values().next().value;R.delete(I);var L=new Set;L.add(I);var O=void 0;do{O=new Set;var V=!0,D=!1,z=void 0;try{for(var F,B=L.values()[Symbol.iterator]();!(V=(F=B.next()).done);V=!0){var U=F.value,G=!0,j=!1,H=void 0;try{for(var W,Y=R.values()[Symbol.iterator]();!(G=(W=Y.next()).done);G=!0){var X=W.value;this._areBridgesLinked(U,X)&&O.add(X)}}catch(e){j=!0,H=e}finally{try{G||null==Y.return||Y.return()}finally{if(j)throw H}}}}catch(e){D=!0,z=e}finally{try{V||null==B.return||B.return()}finally{if(D)throw z}}var q=!0,$=!1,Z=void 0;try{for(var K,Q=O.values()[Symbol.iterator]();!(q=(K=Q.next()).done);q=!0)I=K.value,L.add(I),R.delete(I)}catch(e){$=!0,Z=e}finally{try{q||null==Q.return||Q.return()}finally{if($)throw Z}}}while(0<O.size);var J=!0,ee=!1,te=void 0;try{for(var re,ne=L.values()[Symbol.iterator]();!(J=(re=ne.next()).done);J=!0)(I=re.value).ladder=N,I.sheet=P,I.link=L,++N}catch(e){ee=!0,te=e}finally{try{J||null==ne.return||ne.return()}finally{if(ee)throw te}}++P}for(var ie=0;ie<e.length;++ie){for(var oe=e[ie],se=0,ae=0,le=0;le<oe.i.length;++le)if(this._betaPartners[oe.i[le]][0]){se=1;break}for(var ce=0;ce<oe.j.length;++ce)if(this._betaPartners[oe.j[ce]][0]){ae=1;break}var ue=mr.BRIDGE;if(1<oe.i.length&&(ue=mr.STRAND),oe.type===fr.PARALLEL){for(var he=0,de=0;de<oe.i.length;++de)this._betaPartners[oe.i[de]][se]={residue:oe.j[he++],ladder:oe.ladder,parallel:!0};for(var fe=he=0;fe<oe.j.length;++fe)this._betaPartners[oe.j[fe]][ae]={residue:oe.i[he++],ladder:oe.ladder,parallel:!0}}else{for(var pe=oe.j.length-1,me=0;me<oe.i.length;++me)this._betaPartners[oe.i[me]][se]={residue:oe.j[pe--],ladder:oe.ladder,parallel:!1};pe=oe.i.length-1;for(var _e=0;_e<oe.j.length;++_e)this._betaPartners[oe.j[_e]][ae]={residue:oe.i[pe--],ladder:oe.ladder,parallel:!1}}for(var ve=oe.i[0];ve<=oe.i[oe.i.length-1];++ve)this._ss[ve]!==mr.STRAND&&(this._ss[ve]=ue,this._sheet[ve]=oe.sheet);for(var ge=oe.j[0];ge<=oe.j[oe.j.length-1];++ge)this._ss[ge]!==mr.STRAND&&(this._ss[ge]=ue,this._sheet[ge]=oe.sheet)}}},{key:"_testBridge",value:function(e,t,r,n){var i=fr.NO_BRIDGE,o=e[t-1]._index,s=e[t]._index,a=e[t+1]._index,l=r[n-1]._index,c=r[n]._index,u=r[n+1]._index,h=this._hbonds.isBond.bind(this._hbonds);return h(a,c)&&h(c,o)||h(u,s)&&h(s,l)?i=fr.PARALLEL:(h(a,l)&&h(u,o)||h(c,s)&&h(s,c))&&(i=fr.ANTI_PARALLEL),i}},{key:"_areBridgesLinked",value:function(e,t){var r=new Set(e.i),n=new Set(e.j),i=!0,o=!1,s=void 0;try{for(var a,l=t.i[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){var c=a.value;if(r.has(c)||n.has(c))return!0}}catch(e){o=!0,s=e}finally{try{i||null==l.return||l.return()}finally{if(o)throw s}}var u=!0,h=!1,d=void 0;try{for(var f,p=t.j[Symbol.iterator]();!(u=(f=p.next()).done);u=!0){var m=f.value;if(r.has(m)||n.has(m))return!0}}catch(e){h=!0,d=e}finally{try{u||null==p.return||p.return()}finally{if(h)throw d}}return!1}},{key:"_hasChainBreak",value:function(e,t){for(var r=e+1;r<=t;++r)if(this._complex._residues[r]._sequence!==this._complex._residues[r-1]._sequence+1)return!0;return!1}}]),t}();_r.StructureType=mr;var vr=_r.StructureType,gr=He.Type,yr=(Ce(cr={},vr.HELIX_ALPHA,1),Ce(cr,vr.HELIX_PI,3),Ce(cr,vr.HELIX_310,5),cr),xr=(Ce(ur={},vr.BRIDGE,gr.BRIDGE),Ce(ur,vr.TURN,gr.TURN),Ce(ur,vr.BEND,gr.BEND),Ce(ur,vr.LOOP,gr.COIL),ur),br=function(){function e(){W(this,e),this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._residueTypes=Object.create(Ve.StandardTypes),this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[],this._molecules=[],this._maskNeedsUpdate=!1,this.metadata={},this.symmetry=[],this.units=[new Bt(this)],this._currentUnit=0}return p(e,[{key:"addAtom",value:function(e){var t=this._atoms.length;return this._atoms.push(e),t}},{key:"addSheet",value:function(e){var t=this._sheets.length;return this._sheets.push(e),t}},{key:"addHelix",value:function(e){var t=this._helices.length;return this._helices.push(e),t}},{key:"getAtoms",value:function(){return this._atoms}},{key:"getBonds",value:function(){return this._bonds}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"addResidue",value:function(e){var t=this._residues.length;return this._residues.push(e),t}},{key:"updateToFrame",value:function(t){this.forEachChain(function(e){e.updateToFrame(t)})}},{key:"addResidueType",value:function(e){return this._residueTypes[e]=new Ve(e,"Unknown","")}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"getResidues",value:function(){return this._residues}},{key:"getSGroupCount",value:function(){return this._sgroups.length}},{key:"getSGroups",value:function(){return this._sgroups}},{key:"getAtomByFullname",value:function(e){var t=e.split(".");if(3!==t.length)return null;var r=t[0],n=parseInt(t[1],10);if(Number.isNaN(n))return null;var i=t[2].toUpperCase(),o=null;return this.forEachChain(function(e){o||0===e._name.localeCompare(r)&&e.forEachResidue(function(e){o||e._sequence===n&&e.forEachAtom(function(e){o||0===i.localeCompare(e.name)&&(o=e)})})}),o}},{key:"addChain",value:function(e){var t=new je(this,e);return this._chains.push(t),t}},{key:"getChain",value:function(e){for(var t=0,r=this._chains.length;t<r;++t){var n=this._chains[t];if(n.getName()===e)return n}return null}},{key:"getChainCount",value:function(){return this._chains.length}},{key:"getMolecules",value:function(){return this._molecules}},{key:"getMoleculeCount",value:function(){return this._molecules.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachBond",value:function(e){for(var t=this._bonds,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachResidue",value:function(e){for(var t=this._residues,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachChain",value:function(e){for(var t=this._chains,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachMolecule",value:function(e){for(var t=this._molecules,r=t.length,n=0;n<r;++n)e(t[n])}},{key:"forEachSGroup",value:function(e){for(var t=this._sgroups,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachComponent",value:function(e){for(var t=this._components,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"forEachVisibleComponent",value:function(e){for(var t=this._components,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"addBond",value:function(e,t,r,n,i){var o=new Re(e,t,r,n,i);return this._bonds.push(o),o}},{key:"getBondCount",value:function(){return this._bonds.length}},{key:"getResidueType",value:function(e){return this._residueTypes[e]||null}},{key:"getUnifiedSerial",value:function(e,t,r){return t+65536*r+16777216*e}},{key:"splitUnifiedSerial",value:function(e){var t=Math.floor(e/16777216),r=e-16777216*t,n=Math.floor(r/65536);return{chain:t,serial:r-65536*n,iCode:n}}},{key:"_fillCmpEdit",value:function(){var t=this,r=this._components;function l(){var e=new Gt(t);return e._index=r.length,r[e._index]=e}this.forEachChain(function(e){var t=e._residues,r=t.length;if(!(r<1))for(var n=l(),i=t[0]._index,o=0;o<r;++o){var s=t[o];s._component=n;var a=o===r-1?null:t[o+1];a&&s.isConnected(a)&&s._index===a._index-1||(n.setSubDivs([{start:i,end:s._index}]),a&&(i=a._index,n=l()))}})}},{key:"_fillCmpNoedit",value:function(){var e=new Gt(this);e._index=0;var t=this._residues,r=t.length;if(0!==r){for(var n=[],i=0,o=0;o<r;++o){var s=t[o];s._component=e;var a=o===r-1?null:t[o+1];a&&s.isConnected(a)||(n[n.length]={start:i,end:o},a&&(i=o+1))}e.setSubDivs(n),this._components[e._index]=e}}},{key:"_fillComponents",value:function(e){e?this._fillCmpEdit():this._fillCmpNoedit()}},{key:"getCurrentUnit",value:function(){return this._currentUnit}},{key:"getDefaultBoundaries",value:function(){return this.units[0].getBoundaries()}},{key:"getBoundaries",value:function(){return this.units[this._currentUnit].getBoundaries()}},{key:"getTransforms",value:function(){return this.units[this._currentUnit].getTransforms()}},{key:"getSelector",value:function(){return this.units[this._currentUnit].getSelector()}},{key:"resetCurrentUnit",value:function(){this._currentUnit=0,this.setCurrentUnit(1)}},{key:"setCurrentUnit",value:function(e){return null!=e&&e!==this._currentUnit&&0<=e&&e<this.units.length&&(this._currentUnit=e,!0)}},{key:"_computeBounds",value:function(){for(var e=this.units,t=0,r=e.length;t<r;++t)e[t].computeBoundaries()}},{key:"onAtomPositionChanged",value:function(){this.forEachChain(function(e){e._finalize()}),this.forEachComponent(function(e){e.update()}),this._computeBounds(),this._finalizeBonds(),this.forEachSGroup(function(e){e._rebuildSGroupOnAtomChange()})}},{key:"update",value:function(){this._maskNeedsUpdate&&(this.updateStructuresMask(),this._maskNeedsUpdate=!1)}},{key:"_finalizeBonds",value:function(){for(var e=this.getBonds(),t=e.length,r=0;r<t;++r)e[r]._index=r}},{key:"finalize",value:function(e){e=e||{};var t,r,n=this._bonds;for(t=n.length-1;0<=t;t--){var i=n[t];null===i._left||null===i._right?n.splice(t,1):(i._left.bonds.push(i),i._right.bonds.push(i))}var o=this._residues;for(t=0,r=o.length;t<r;++t)o[t]._finalize();this.forEachChain(function(e){e._finalize()});var s=this.units;for(t=0,r=s.length;t<r;++t)s[t].finalize();this.setCurrentUnit(1);var a={};for(t=0,r=o.length;t<r;++t){var l=o[t];a[this.getUnifiedSerial(l.getChain().getName().charCodeAt(0),l.getSequence(),l.getICode().charCodeAt(0))]=l}var c=this.structures;for(t=0,r=c.length;t<r;++t)c[t]._finalize(e.serialAtomMap,a,this);var u=this._helices;for(t=0,r=u.length;t<r;++t)u[t]._finalize(e.serialAtomMap,a,this);var h=this._sheets;for(t=0,r=h.length;t<r;++t)h[t]._finalize(e.serialAtomMap,a,this);this._computeBounds();var d=this._atoms;for(t=0,r=d.length;t<r;++t){d[t].index=t}if(e.needAutoBonding){var f=new $t(this);f.build(),f.destroy()}var p=this._chains;for(t=0,r=p.length;t<r;++t)p[t]._index=t;for(t=0,r=o.length;t<r;++t)o[t]._index=t;for(t=0,r=d.length;t<r;++t){var m=d[t];if(m.flags&Ae.Flags.HYDROGEN&&1===m.bonds.length){var _=m.bonds[0];(_._left!==m&&_._left||_._right).flags&Ae.Flags.CARBON&&(m.flags|=Ae.Flags.NONPOLARH)}}this._finalizeBonds(),this._fillComponents(e.enableEditing);var v=new ar(this);v.markCycles(),e.detectAromaticLoops&&v.detectCycles(),this._finalizeMolecules()}},{key:"_finalizeMolecules",value:function(){for(var e=0;e<this._molecules.length;e++)for(var t=this._molecules[e],r=t.residues.length,n=0;n<r;n++){t.residues[n]._molecule=t}}},{key:"updateStructuresMask",value:function(){function e(e){return e.collectMask()}this.forEachResidue(e),this.forEachChain(e),this.forEachMolecule(e)}},{key:"countAtomsByMask",value:function(t){var r=0;return this.forEachAtom(function(e){0!=(e.mask&t)&&r++}),r}},{key:"getNumAtomsBySelector",value:function(t){var r=0;return this.forEachAtom(function(e){t.includesAtom(e)&&r++}),r}},{key:"resetAtomMask",value:function(t){this.forEachAtom(function(e){e.mask=t})}},{key:"markAtoms",value:function(e,t){var r=t,n=~r,i=0,o=Ft.keyword("And")(e,this.getSelector());return this.forEachAtom(function(e){o.includesAtom(e)?(e.mask|=r,i++):e.mask&=n}),this._maskNeedsUpdate=!0,i}},{key:"markAtomsAdditionally",value:function(t,r){var n=r,i=0;return this.forEachAtom(function(e){t.includesAtom(e)&&(e.mask&r)!==r&&(e.mask|=n,i++)}),i}},{key:"clearAtomBits",value:function(e){var t=~e;this.forEachAtom(function(e){e.mask&=t});function r(e){e._mask&=t}this.forEachAtom(r),this.forEachResidue(r),this.forEachChain(r),this.forEachMolecule(r)}},{key:"getAtomNames",value:function(){if(this.hasOwnProperty("_atomNames"))return this._atomNames;var t={};return this.forEachAtom(function(e){t[e.name]=1}),this._atomNames=Object.keys(t),this._atomNames}},{key:"getElements",value:function(){if(this.hasOwnProperty("_elements"))return this._elements;var t={};return this.forEachAtom(function(e){t[e.element.name]=1}),this._elements=Object.keys(t),this._elements}},{key:"getResidueNames",value:function(){if(this.hasOwnProperty("_residueNames"))return this._residueNames;var t={};return this.forEachResidue(function(e){t[e._type._name]=1}),this._residueNames=Object.keys(t),this._residueNames}},{key:"getChainNames",value:function(){if(this.hasOwnProperty("_chainNames"))return this._chainNames;var t={};return this.forEachChain(function(e){t[e._name]=1}),this._chainNames=Object.keys(t),this._chainNames}},{key:"getAltLocNames",value:function(){if(this.hasOwnProperty("_altlocNames"))return this._altlocNames;var t={};return this.forEachAtom(function(e){t[String.fromCharCode(e.location)]=1}),this._altlocNames=Object.keys(t),this._altlocNames}},{key:"getVoxelWorld",value:function(){if(!this.hasOwnProperty("_voxelWorld"))try{this._voxelWorld=new lr(this.getDefaultBoundaries().boundingBox,new me.Vector3(5,5,5)),this._voxelWorld.addAtoms(this)}catch(e){I.warn("Unable to create voxel world"),this._voxelWorld=null}return this._voxelWorld}},{key:"addElement",value:function(e,t,r,n){for(var i=e.length,o=0;o<i;++o){var s=e[o];n(s,r),t.push(s)}}},{key:"joinComplexes",value:function(e){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[];var r=this,t=0,n=0,i=0,o=0,s=0;function a(e,t){e.serial+=t,e.index+=t}function l(e,t){e._index+=t}function c(e,t){e._index+=t}function u(e,t){e._complex=r,e._index+=t}function h(e,t){e._complex=r,e._index+=t}function d(){}for(var f=0;f<e.length;++f){var p=e[f];for(var m in this.addElement(p._atoms,this._atoms,t,a),this.addElement(p._bonds,this._bonds,n,l),this.addElement(p._residues,this._residues,i,c),this.addElement(p._chains,this._chains,o,u),this.addElement(p._sheets,this._sheets,0,d),this.addElement(p._helices,this._helices,0,d),this.addElement(p._sgroups,this._sgroups,0,d),this.addElement(p._components,this._components,s,h),this.addElement(p.structures,this.structures,0,d),p._residueTypes)p._residueTypes.hasOwnProperty(m)&&(this._residueTypes[m]=p._residueTypes[m]);t+=p._atoms.length,n+=p._bonds.length,i+=p._residues.length,o+=p._chains.length,s+=p._components.length}this._computeBounds()}},{key:"dssp",value:function(){for(var e,t,r,n=new _r(this),i=this.structures=[],o=this._helices=[],s=this._sheets=[],a=0,l=null,c=0,u=this._residues.length;c<u;++c){var h=n._ss[c],d=this._residues[c],f=n._sheet[c];if(h!==e||f!==t){var p=yr[h],m=xr[h];if(h===vr.STRAND){var _=s[r=f]||(s[r]=new mt(String(r),0));l=new pt(_,d,d,0,null,null),_.addStrand(l)}else void 0!==p?(l=new $e(p,d,d,++a,String(a),"",1),o.push(l)):l=void 0!==m?new He(m,d,d):null;l&&i.push(l),d._secondary=l,e=h,t=f}else(d._secondary=l)&&(l.term=d),l instanceof $e&&l.length++}this._sheets=s.filter(function(e){return!0})}}]),e}();function wr(e){var t=2;for(e=e-1>>1;e;)t<<=1,e>>=1;return t}br.prototype.id="Complex",br.prototype.name="";var Sr=function(){function g(e,t,r,n,i,o){if(W(this,g),this._box=r.clone(),this._dimVec=Math.max(Math.floor(n||1),1),this._volumeInfo=o,t instanceof Array){var s=y(t,3);this._dimX=s[0],this._dimY=s[1],this._dimZ=s[2]}else this._dimX=t.x,this._dimY=t.y,this._dimZ=t.z;switch(this._dimX=Math.max(Math.floor(this._dimX),1),this._dimY=Math.max(Math.floor(this._dimY),1),this._dimZ=Math.max(Math.floor(this._dimZ),1),this._rowElements=this._dimVec*this._dimX,this._planeElements=this._rowElements*this._dimY,this._totalElements=this._planeElements*this._dimZ,this._data=i||_e.allocateTyped(e,this._totalElements),this._dimVec){case 1:break;case 2:this.getValue=function(e,t,r){var n=e*this._dimVec+t*this._rowElements+r*this._planeElements;return[this._data[n],this._data[1+n]]},this.setValue=function(e,t,r,n,i){var o=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[o]=n,this._data[1+o]=i},this.addValue=function(e,t,r,n,i){var o=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[o]+=n,this._data[1+o]+=i};break;case 3:this.getValue=function(e,t,r){var n=e*this._dimVec+t*this._rowElements+r*this._planeElements;return[this._data[n],this._data[1+n],this._data[2+n]]},this.setValue=function(e,t,r,n,i,o){var s=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[s]=n,this._data[1+s]=i,this._data[2+s]=o},this.addValue=function(e,t,r,n,i,o){var s=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[s]+=n,this._data[1+s]+=i,this._data[2+s]+=o};break;default:throw new Error("Volume: invalid vector dimension")}}return p(g,[{key:"getValue",value:function(e,t,r){return this._data[e+t*this._rowElements+r*this._planeElements]}},{key:"setValue",value:function(e,t,r,n){this._data[e+t*this._rowElements+r*this._planeElements]=n}},{key:"addValue",value:function(e,t,r,n){this._data[e+t*this._rowElements+r*this._planeElements]+=n}},{key:"getDimensions",value:function(){return[this._dimX,this._dimY,this._dimZ]}},{key:"getBox",value:function(){return this._box}},{key:"getVolumeInfo",value:function(){return this._volumeInfo}},{key:"getCellSize",value:function(){var e=new me.Vector3;this._box.getSize(e);var t=new me.Vector3;return t.x=1<this._dimX?e.x/(this._dimX-1):0,t.y=1<this._dimY?e.y/(this._dimY-1):0,t.z=1<this._dimZ?e.z/(this._dimZ-1):0,t}},{key:"computeGradient",value:function(){if(1!==this._dimVec)return null;var e=new g(Float32Array,[this._dimX,this._dimY,this._dimZ],this._box,3),t=this.getCellSize(),r=new me.Vector3(-.5/t.x,-.5/t.y,-.5/t.z);function n(e,t,r){return Math.min(r,Math.max(t,e))}var i=this._dimX,o=this._dimY,s=this._dimZ,a=this._data;function l(e,t,r){return a[r*i*o+t*i+e]}for(var c=0;c<s;++c)for(var u=n(c-1,0,s-1),h=n(c+1,0,s-1),d=0;d<o;++d)for(var f=n(d-1,0,o-1),p=n(d+1,0,o-1),m=0;m<i;++m){var _=n(m-1,0,i-1),v=n(m+1,0,i-1);e.setValue(m,d,c,(l(v,d,c)-l(_,d,c))*r.x,(l(m,p,c)-l(m,f,c))*r.y,(l(m,d,h)-l(m,d,u))*r.z)}return e}},{key:"normalize",value:function(){for(var e=this._data,t=e[0],r=e[0],n=1;n<e.length;++n)t=Math.min(t,e[n]),r=Math.max(r,e[n]);var i=1/(r-t);if(0!=i)for(var o=0;o<e.length;++o)e[o]=i*(e[o]-t)}},{key:"getTiledTextureStride",value:function(){return[this._dimX+2,this._dimY+2]}},{key:"buildTiledTexture",value:function(){var e=Math.ceil(Math.sqrt(this._dimZ*this._dimY/this._dimX)),t=e*(this._dimX+2)-1;t=wr(t),e=Math.floor(t/(this._dimX+2));var r=Math.ceil(this._dimZ/e),n=r*(this._dimY+2)-1;n=wr(n);for(var i,o,s=new Uint8Array(t*n),a=0;a<r;++a)for(var l=0;l<this._dimY;++l){i=a*e*this._planeElements+l*this._rowElements,o=t*(a*(this._dimY+2)+l);for(var c=0;c<e;++c){for(var u=0;u<this._dimX;++u)s[o++]=255*this._data[i++];s[o++]=255*this._data[i-1],c<e-1&&(i+=this._planeElements-this._rowElements,s[o++]=255*this._data[i])}}for(var h=0;h<r;++h){o=(i=t*(h*(this._dimY+2)+this._dimY-1))+t;for(var d=0;d<t;++d)s[o++]=s[i++];if(h<r-1){o=(i=t*(h+1)*(this._dimY+2))-t;for(var f=0;f<t;++f)s[o++]=s[i++]}}var p=new me.DataTexture(s,t,n,me.LuminanceFormat,me.UnsignedByteType,me.UVMapping,me.ClampToEdgeWrapping,me.ClampToEdgeWrapping,me.LinearFilter,me.LinearFilter);return p.needsUpdate=!0,p}},{key:"getData",value:function(){return this._data}},{key:"getDirectIdx",value:function(e,t,r){return e*this._dimVec+t*this._rowElements+r*this._planeElements}},{key:"getStrideX",value:function(){return this._dimVec}},{key:"getStrideY",value:function(){return this._rowElements}},{key:"getStrideZ",value:function(){return this._planeElements}}]),g}();Sr.prototype.id="Volume";var Cr={Atom:Ae,Element:Ee,Bond:Re,Residue:Oe,ResidueType:Ve,Chain:je,Helix:$e,Strand:pt,Sheet:mt,SGroup:_t,Assembly:Ut,Complex:br,Volume:Sr,VoxelWorld:lr,selectors:Ft,Molecule:function(){function n(e,t,r){W(this,n),this.complex=e,this.name=t||"",this.residues=[],this.mask=1,this.index=r||-1}return p(n,[{key:"forEachResidue",value:function(e){for(var t=this.residues,r=0,n=t.length;r<n;++r)e(t[r])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this.residues,r=0,n=t.length;r<n;++r)e&=t[r]._mask;this.mask=e}}]),n}()},Ar=function(e){function n(e){var t;W(this,n),t=Y(this,X(n).call(this));var r=S(t);return t._element=e,t._element.style.position="absolute",t.addEventListener("removed",function(){null!==r._element.parentNode&&r._element.parentNode.removeChild(r._element)}),t}return A(n,e),p(n,[{key:"getElement",value:function(){return this._element}},{key:"setTransparency",value:function(e){var t=this.getElement();if(null!==t)if(1!==e){t.style.display="inline";var r=1-e,n=r.toString(),i=100*r;t.style.opacity=n,t.style.filter="alpha(opacity=".concat(i,")")}else t.style.display="none"}},{key:"clone",value:function(){var e=new n(this._element);return e.copy(this),e}}]),n}(me.Object3D),Er=function(e){function t(){return W(this,t),Y(this,X(t).apply(this,arguments))}return A(t,e),p(t,[{key:"raycast",value:function(e,t){if(this.visible)for(var r=this.children,n=0,i=r.length;n<i;++n)r[n].raycast(e,t)}},{key:"enableSubset",value:function(e,t){for(var r=this.children,n=0,i=r.length;n<i;++n)r[n].enableSubset&&r[n].enableSubset(e,t)}},{key:"disableSubset",value:function(e,t){for(var r=this.children,n=0,i=r.length;n<i;++n)r[n].disableSubset&&r[n].disableSubset(e,t)}},{key:"isEmpty",value:function(){return 0===this.children.length}},{key:"updateToFrame",value:function(e){for(var t=this.children,r=0,n=t.length;r<n;++r)t[r].updateToFrame&&t[r].updateToFrame(e)}},{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=n.length;i<o;++i)n[i].getSubset&&Array.prototype.push.apply(r,n[i].getSubset(e,t));return r}}]),t}(me.Group),kr="uniform mat4 projectionMatrix;\r\nuniform mat4 modelViewMatrix;\r\n\r\nattribute vec2 uv;\r\nattribute vec3 position;\r\n\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vUv = uv;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n}\r\n",Tr="float INSTANCED_SPRITE_OVERSCALE = 1.3;\r\n\r\nattribute vec3 normal;\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  varying vec3 viewNormal;\r\n#endif\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  varying vec3 vNormal;\r\n#endif\r\n\r\n#ifdef THICK_LINE\r\n  attribute vec4 position; // W contains vert pos or neg offset\r\n#else\r\n  attribute vec3 position;\r\n#endif\r\n\r\nvarying vec3 vWorldPosition;\r\nvarying vec3 vViewPosition;\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  attribute float alphaColor;\r\n  varying float alphaCol;\r\n#endif\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  attribute vec3 color;\r\n  varying vec3 vColor;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  attribute vec3 color2;\r\n  varying vec3 vColor2;\r\n  attribute vec2 uv;\r\n  #ifndef CYLINDER_SPRITE\r\n    varying vec2 vUv;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_POS\r\n  attribute vec4 offset;\r\n  #ifdef SPHERE_SPRITE\r\n    varying vec4 instOffset;\r\n  varying vec4 spritePosEye;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  attribute vec4 matVector1;\r\n  attribute vec4 matVector2;\r\n  attribute vec4 matVector3;\r\n  attribute vec4 invmatVector1;\r\n  attribute vec4 invmatVector2;\r\n  attribute vec4 invmatVector3;\r\n\r\n  #ifdef CYLINDER_SPRITE\r\n    varying vec4 matVec1;\r\n    varying vec4 matVec2;\r\n    varying vec4 matVec3;\r\n    varying vec4 invmatVec1;\r\n    varying vec4 invmatVec2;\r\n    varying vec4 invmatVec3;\r\n  #endif\r\n#endif\r\n\r\nuniform mat4 modelViewMatrix; // optional\r\nuniform mat4 projectionMatrix; // optional\r\nuniform mat3 normalMatrix; // optional\r\nuniform mat4 modelMatrix; // optional\r\n\r\n#ifdef DASHED_LINE\r\n  attribute float lineDistance;\r\n  varying float vLineDistance;\r\n#endif\r\n\r\n#ifdef THICK_LINE\r\n  attribute vec3 direction;\r\n  uniform mat4 projMatrixInv;\r\n  uniform vec2 viewport;\r\n  uniform float lineWidth;\r\n\r\n  vec4 transform(vec4 coord){\r\n    return projectionMatrix * modelViewMatrix * coord;\r\n  }\r\n\r\n  vec2 project(vec4 device){\r\n    vec3 device_normal = device.xyz/device.w;\r\n    vec2 clip_pos = (device_normal*0.5+0.5).xy;\r\n    return clip_pos * viewport;\r\n  }\r\n\r\n  vec4 unproject(vec2 screen, float z, float w){\r\n    vec2 clip_pos = screen/viewport;\r\n    vec2 device_normal = clip_pos*2.0-1.0;\r\n    return vec4(device_normal*w, z, w);\r\n  }\r\n#endif\r\n\r\n\r\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\r\nvoid main() {\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  alphaCol = alphaColor;\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  vec3 objectNormal = vec3(\r\n    dot(normal, matVector1.xyz),\r\n    dot(normal, matVector2.xyz),\r\n    dot(normal, matVector3.xyz));\r\n#else\r\n  vec3 objectNormal = vec3( normal );\r\n#endif\r\n\r\nvec3 transformedNormal = normalMatrix * objectNormal;\r\n\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  vNormal = normalize(transformedNormal);\r\n#endif\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  viewNormal = normalize(mat3(modelViewMatrix)*objectNormal);\r\n#endif\r\n\r\n  vec4 localPos = vec4(position.xyz, 1.0);\r\n  vec4 worldPos = modelMatrix * localPos;\r\n  vec4 mvPosition = modelViewMatrix * localPos;\r\n\r\n// make thick line offset\r\n#ifdef THICK_LINE\r\n   // get screen pos\r\n   vec4 dPos = transform(vec4(position.xyz, 1.0));\r\n   vec2 sPos = project(dPos);\r\n   // move pos forward\r\n   vec3 position2 = position.xyz + direction.xyz * 0.5;\r\n   // get screen offset pos\r\n   vec4 dPos2 = transform(vec4(position2.xyz, 1.0));\r\n   vec2 sPos2 = project(dPos2);\r\n   // screen line direction\r\n   vec2 sDir = normalize(sPos2 - sPos);\r\n   // vertex offset (orthogonal to line direction)\r\n   vec2 offset1 = vec2(-sDir.y, sDir.x);\r\n   // move screen vertex\r\n   vec2 newPos = sPos + offset1 * position.w * lineWidth;\r\n   // get moved pos in view space\r\n   vec4 dNewPos =  unproject(newPos, dPos.z, dPos.w);\r\n   mvPosition.xyz = (projMatrixInv * dNewPos).xyz;\r\n#endif // THICK_LINE\r\n\r\n#ifdef INSTANCED_POS\r\n  #ifdef SPHERE_SPRITE\r\n    instOffset = offset;\r\n\r\n    vec4 posEye = modelViewMatrix * vec4( offset.xyz, 1.0 );\r\n    float scale = length(modelViewMatrix[0]);\r\n    mvPosition = posEye + vec4( position.xyz * offset.w * scale * INSTANCED_SPRITE_OVERSCALE, 0.0 );\r\n    posEye.w = offset.w * scale;\r\n\r\n    spritePosEye = posEye;\r\n #else\r\n    localPos = vec4( offset.xyz + position.xyz * offset.w, 1.0 );\r\n    worldPos = modelMatrix * localPos;\r\n    mvPosition = modelViewMatrix * localPos;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  #ifdef CYLINDER_SPRITE\r\n    matVec1 = matVector1;\r\n    matVec2 = matVector2;\r\n    matVec3 = matVector3;\r\n    invmatVec1 = invmatVector1;\r\n    invmatVec2 = invmatVector2;\r\n    invmatVec3 = invmatVector3;\r\n\r\n    // calculate eye coords of cylinder endpoints\r\n    vec4 v = vec4(0, -0.5, 0, 1);\r\n    vec4 p1 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r\n    v.y = 0.5;\r\n    vec4 p2 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r\n\r\n    // sprite is placed at the center of cylinder\r\n    vec4 posEye;\r\n    posEye.xyz = mix(p1.xyz, p2.xyz, 0.5);\r\n    posEye.w = 1.0;\r\n\r\n    // basic sprite size at screen plane (covers only cylinder axis)\r\n    vec2 spriteSizeScreen = abs(p2.xy / p2.z - p1.xy / p1.z);\r\n\r\n    // cylinder radius in eye space\r\n    float rad = length(modelViewMatrix[0]) * length(vec3(matVector1.x, matVector2.x, matVector3.x));\r\n\r\n    // full sprite size in eye coords\r\n    float minZ = min(abs(p1.z), abs(p2.z));\r\n    vec2 spriteSize = INSTANCED_SPRITE_OVERSCALE  * abs(posEye.z) *\r\n      (spriteSizeScreen + 2.0 * rad / minZ);\r\n\r\n    mvPosition = posEye + vec4( position.xy * 0.5 * spriteSize, 0, 0 );\r\n  #else\r\n    localPos = vec4(dot(localPos, matVector1), dot(localPos, matVector2), dot(localPos, matVector3), 1.0);\r\n    worldPos = modelMatrix * localPos;\r\n    mvPosition = modelViewMatrix * localPos;\r\n  #endif\r\n#endif\r\n\r\n  gl_Position = projectionMatrix * mvPosition;\r\n\r\n  vWorldPosition = worldPos.xyz;\r\n  vViewPosition = - mvPosition.xyz;\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t  vec4 worldPosition;\r\n\t  // see THREE.WebGLProgram.unrollLoops\r\n\t  #pragma unroll_loop\r\n\t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n      vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * vec4(vWorldPosition, 1.0);\r\n      vDirectionalShadowNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(objectNormal, 0.0))).xyz;\r\n\t  }\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  vColor = color.xyz;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  vColor2 = color2;\r\n  #ifndef CYLINDER_SPRITE\r\n    vUv = uv;\r\n  #endif\r\n#endif\r\n\r\n#ifdef DASHED_LINE\r\n  vLineDistance = lineDistance;\r\n#endif\r\n}\r\n",Rr="#if defined (NORMALS_TO_G_BUFFER)\r\n  #define fragColor gl_FragData[0]\r\n#else\r\n  #define fragColor gl_FragColor\r\n#endif\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  varying float alphaCol;\r\n#endif\r\n\r\n#ifdef COLOR_FROM_POS\r\n  uniform mat4 world2colorMatrix;\r\n#endif\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r\n\r\n    #ifdef SHADOWMAP_PCF_RAND\r\n      // We use 4 instead uniform variable or define because this value is used in for(... i < value; ...) with\r\n      // unroll_loop and unroll_loop has pattern:\r\n      // /#pragma unroll_loop[\\s]+?for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g\r\n      uniform vec2 samplesKernel[4]; // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n      uniform sampler2D noiseTex;\r\n      uniform vec2 noiseTexelSize;\r\n      uniform vec2 srcTexelSize;\r\n      uniform mat4 projectionMatrix;\r\n    #endif\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  varying vec3 vColor;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  varying vec3 vColor2;\r\n  #ifndef CYLINDER_SPRITE\r\n    varying vec2 vUv;\r\n  #endif\r\n#endif\r\n\r\nuniform vec3 diffuse;\r\nuniform vec3 emissive;\r\nuniform vec3 specular;\r\nuniform float shininess;\r\nuniform vec3 fixedColor;\r\nuniform float opacity;\r\nuniform float zClipValue;\r\nuniform float clipPlaneValue;\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  varying vec3 viewNormal;\r\n#endif\r\n\r\n#define PI 3.14159265359\r\n#define RECIPROCAL_PI 0.31830988618\r\n#define saturate(a) clamp( a, 0.0, 1.0 )\r\n\r\n#ifdef USE_FOG\r\n  uniform vec3 fogColor;\r\n  uniform float fogAlpha;\r\n  uniform float fogNear;\r\n  uniform float fogFar;\r\n#endif\r\n\r\nvarying vec3 vWorldPosition; // world position of the pixel (invalid when INSTANCED_SPRITE is defined)\r\nvarying vec3 vViewPosition;\r\n\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  varying vec3 vNormal;\r\n#endif\r\n\r\n/////////////////////////////////////////// ZSprites ////////////////////////////////////////////////\r\n#ifdef SPHERE_SPRITE\r\n  varying vec4 spritePosEye;\r\n#endif\r\n\r\n#if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n  uniform float zOffset;\r\n  uniform mat4 projectionMatrix;\r\n\r\n  float calcDepthForSprites(vec4 pixelPosEye, float zOffset, mat4 projMatrix) {\r\n    vec4 pixelPosScreen = projMatrix * pixelPosEye;\r\n    return 0.5 * (pixelPosScreen.z / pixelPosScreen.w + 1.0) + zOffset;\r\n  }\r\n#endif\r\n\r\n#ifdef SPHERE_SPRITE\r\n  varying vec4 instOffset;\r\n  uniform mat4 modelMatrix;\r\n  uniform mat4 modelViewMatrix;\r\n  uniform mat4 invModelViewMatrix;\r\n  uniform mat3 normalMatrix;\r\n\r\n  float intersect_ray_sphere(in vec3 origin, in vec3 ray, out vec3 point) {\r\n\r\n    // intersect XZ-projected ray with circle\r\n    float a = dot(ray, ray);\r\n    float b = dot(ray, origin);\r\n    float c = dot(origin, origin) - 1.0;\r\n    float det = b * b - a * c;\r\n    if (det < 0.0) return -1.0;\r\n    float t1 = (-b - sqrt(det)) / a;\r\n    float t2 = (-b + sqrt(det)) / a;\r\n\r\n    // calculate both intersection points\r\n    vec3 p1 = origin + ray * t1;\r\n    vec3 p2 = origin + ray * t2;\r\n\r\n    // choose nearest point\r\n    if (t1 >= 0.0) {\r\n      point = p1;\r\n      return t1;\r\n    }\r\n    if (t2 >= 0.0) {\r\n      point = p2;\r\n      return t2;\r\n    }\r\n\r\n    return -1.0;\r\n  }\r\n\r\n  float get_sphere_point(in vec3 pixelPosEye, out vec3 point) {\r\n    // transform camera pos into sphere local coords\r\n    vec4 v = invModelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0);\r\n    vec3 origin = (v.xyz - instOffset.xyz) / instOffset.w;\r\n\r\n    // transform (camera -> pixel) ray into cylinder local coords\r\n    v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\r\n    vec3 ray = normalize(v.xyz);\r\n\r\n    return intersect_ray_sphere(origin, ray, point);\r\n  }\r\n#endif\r\n\r\n#ifdef CYLINDER_SPRITE\r\n  varying vec4 matVec1;\r\n  varying vec4 matVec2;\r\n  varying vec4 matVec3;\r\n  varying vec4 invmatVec1;\r\n  varying vec4 invmatVec2;\r\n  varying vec4 invmatVec3;\r\n\r\n  uniform mat4 modelMatrix;\r\n  uniform mat4 modelViewMatrix;\r\n  uniform mat4 invModelViewMatrix;\r\n  uniform mat3 normalMatrix;\r\n\r\n  float intersect_ray_cylinder(in vec3 origin, in vec3 ray, out vec3 point) {\r\n\r\n    // intersect XZ-projected ray with circle\r\n    float a = dot(ray.xz, ray.xz);\r\n    float b = dot(ray.xz, origin.xz);\r\n    float c = dot(origin.xz, origin.xz) - 1.0;\r\n    float det = b * b - a * c;\r\n    if (det < 0.0) return -1.0;\r\n    float t1 = (-b - sqrt(det)) / a;\r\n    float t2 = (-b + sqrt(det)) / a;\r\n\r\n    // calculate both intersection points\r\n    vec3 p1 = origin + ray * t1;\r\n    vec3 p2 = origin + ray * t2;\r\n\r\n    // choose nearest point\r\n    float halfHeight = 0.5;\r\n    if (t1 >= 0.0 && p1.y >= -halfHeight && p1.y <= halfHeight) {\r\n      point = p1;\r\n      return t1;\r\n    }\r\n    if (t2 >= 0.0 && p2.y >= -halfHeight && p2.y <= halfHeight) {\r\n      point = p2;\r\n      return t2;\r\n    }\r\n\r\n    return -1.0;\r\n  }\r\n\r\n  float get_cylinder_point(in vec3 pixelPosEye, out vec3 point) {\r\n    // transform camera pos into cylinder local coords\r\n    vec4 v = invModelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0);\r\n    vec3 origin = vec3(\r\n      dot(v, invmatVec1),\r\n      dot(v, invmatVec2),\r\n      dot(v, invmatVec3));\r\n\r\n    // transform (camera -> pixel) ray into cylinder local coords\r\n    v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\r\n    vec3 ray = vec3(\r\n      dot(v, invmatVec1),\r\n      dot(v, invmatVec2),\r\n      dot(v, invmatVec3));\r\n    ray = normalize(ray);\r\n\r\n    return intersect_ray_cylinder(origin, ray, point);\r\n  }\r\n#endif\r\n\r\n///////////////////////////////////// Pack and unpack ///////////////////////////////////////////////\r\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\r\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\r\n\r\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\r\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\r\n\r\n\r\nconst float ShiftRight8 = 1. / 256.;\r\n\r\nvec4 packDepthToRGBA( const in float v ) {\r\n  vec4 r = vec4( fract( v * PackFactors ), v );\r\n  r.yzw -= r.xyz * ShiftRight8; // tidy overflow\r\n  return r * PackUpscale;\r\n}\r\n\r\nfloat unpackRGBAToDepth( const in vec4 v ) {\r\n  return dot( v, UnpackFactors );\r\n}\r\n\r\n////////////////////////////////////////// All Lighting /////////////////////////////////////////////////\r\n#ifdef TOON_SHADING\r\n  #define LOW_TOON_BORDER 0.0\r\n  #define MEDIUM_TOON_BORDER 0.7\r\n  #define HIGH_TOON_BORDER 1.0\r\n\r\n  #define MEDIUM_TOON_RANGE 0.5\r\n  #define HIGH_TOON_RANGE 0.95\r\n#endif\r\n#if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r\n  struct ReflectedLight {\r\n    vec3 directDiffuse;\r\n    vec3 directSpecular;\r\n    vec3 indirectDiffuse;\r\n  };\r\n\r\n  struct BlinnPhongMaterial {\r\n    vec3  diffuseColor;\r\n    vec3  specularColor;\r\n    float specularShininess;\r\n  };\r\n\r\n  struct GeometricContext {\r\n    vec3 normal;\r\n    vec3 viewDir;\r\n  };\r\n\r\n  struct DirectionalLight {\r\n    vec3 direction;\r\n    vec3 color;\r\n\r\n    int shadow;\r\n    vec2 shadowMapSize;\r\n    float shadowBias;\r\n    float shadowRadius;\r\n  };\r\n\r\n  uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\r\n  uniform vec3 ambientLightColor;\r\n\r\n  /////////////////////////////////////////// Shadowmap ////////////////////////////////////////////////\r\n\r\n  #if defined(SHADOWMAP)\r\n  \tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\r\n  \t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\r\n  \t}\r\n\r\n    float getShadow( sampler2D shadowMap, DirectionalLight dirLight, vec4 shadowCoord, vec3 vViewPosition, vec3 vNormal ) {\r\n   \t  float shadow = 0.0;\r\n\r\n      // When shadows for sprites will appear use here for them normals as it done for G-buffer\r\n      shadowCoord.xyz += dirLight.shadowBias * vNormal;\r\n      shadowCoord.xyz /= shadowCoord.w;\r\n\r\n      bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r\n      bool inFrustum = all( inFrustumVec );\r\n      bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r\n      bool frustumTest = all( frustumTestVec );\r\n\r\n      if ( frustumTest ) {\r\n        #ifdef SHADOWMAP_BASIC\r\n      \t  shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\r\n      \t#endif\r\n\r\n      \t#ifdef SHADOWMAP_PCF_SHARP\r\n      \t  vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r\n\r\n            float dx0 = - texelSize.x * dirLight.shadowRadius;\r\n            float dy0 = - texelSize.y * dirLight.shadowRadius;\r\n            float dx1 = + texelSize.x * dirLight.shadowRadius;\r\n            float dy1 = + texelSize.y * dirLight.shadowRadius;\r\n\r\n            shadow = (\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\r\n            ) * ( 1.0 / 9.0 );\r\n        #endif\r\n\r\n        #ifdef SHADOWMAP_PCF_RAND\r\n          vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r\n\r\n          vec4 vUv = ((projectionMatrix * vec4(vViewPosition, 1.0)) + 1.0) / 2.0;\r\n          vec2 vUvNoise = vUv.xy / srcTexelSize * noiseTexelSize;\r\n\r\n          vec2 noiseVec = normalize(texture2D(noiseTex, vUvNoise).rg);\r\n          mat2 mNoise = mat2(noiseVec.x, noiseVec.y, -noiseVec.y, noiseVec.x);\r\n\r\n          vec2 offset;\r\n          #pragma unroll_loop\r\n          for ( int i = 0; i < 4; i ++ ) { // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n            offset = mNoise * ( normalize( samplesKernel[ i ]) * texelSize * dirLight.shadowRadius );\r\n            shadow +=  texture2DCompare( shadowMap, shadowCoord.xy + offset, shadowCoord.z );\r\n          }\r\n          shadow /= float( 4 ); // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n        #endif\r\n      }\r\n      return shadow;//(shadow != 1.0) ? 0.5 : 1.0;//vec4(shadow, shadow, shadow, 1.0);\r\n   }\r\n  #endif\r\n\r\n  /////////////////////////////////////////// Lighting /////////////////////////////////////////////////\r\n\r\n  vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\r\n    return RECIPROCAL_PI * diffuseColor;\r\n  } // validated\r\n\r\n  vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\r\n    // Original approximation by Christophe Schlick '94\r\n    //;float fresnel = pow( 1.0 - dotLH, 5.0 );\r\n    // Optimized variant (presented by Epic at SIGGRAPH '13)\r\n    float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\r\n    return ( 1.0 - specularColor ) * fresnel + specularColor;\r\n  } // validated\r\n\r\n  float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\r\n    // geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\r\n    return 0.25;\r\n  }\r\n\r\n  float D_BlinnPhong( const in float shininess, const in float dotNH ) {\r\n    return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\r\n  }\r\n\r\n  vec3 BRDF_Specular_BlinnPhong( const in DirectionalLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\r\n    vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\r\n    float dotNH = saturate(dot( geometry.normal, halfDir ));\r\n    float dotLH = saturate(dot( incidentLight.direction, halfDir ));\r\n\r\n    vec3 F = F_Schlick( specularColor, dotLH );\r\n    float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\r\n    float D = D_BlinnPhong( shininess, dotNH );\r\n\r\n    return F * ( G * D );\r\n  } // validated\r\n\r\n  void RE_Direct_BlinnPhong( const in DirectionalLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight, float penumbra ) {\r\n\r\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ));\r\n    #ifdef TOON_SHADING\r\n      if(dotNL < MEDIUM_TOON_RANGE){\r\n        dotNL = LOW_TOON_BORDER;\r\n      }\r\n      else if(dotNL < HIGH_TOON_RANGE){\r\n        dotNL = MEDIUM_TOON_BORDER;\r\n      }\r\n      else{\r\n        dotNL = HIGH_TOON_BORDER;\r\n      }\r\n    #endif\r\n\r\n    vec3 irradiance = dotNL * directLight.color * PI;\r\n    reflectedLight.directDiffuse += penumbra * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r\n    reflectedLight.directSpecular += penumbra * irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess );\r\n  }\r\n\r\n  void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\r\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r\n  }\r\n\r\n  vec3 calcLighting(const in GeometricContext geometry, const in BlinnPhongMaterial material, vec3 vViewPosition) {\r\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ));\r\n    vec3 irradiance = ambientLightColor * PI;\r\n\r\n    float shadowMask = 1.0;\r\n    // see THREE.WebGLProgram.unrollLoops\r\n  \t#pragma unroll_loop\r\n  \t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n  \t    #ifdef SHADOWMAP\r\n  \t    if ( directionalLights[ i ].shadow > 0 ) shadowMask = getShadow( directionalShadowMap[ i ], directionalLights[ i ], vDirectionalShadowCoord[ i ], vViewPosition, vDirectionalShadowNormal[ i ] );\r\n  \t    #endif\r\n\r\n  \t\t  if ( shadowMask > 0.0 ) RE_Direct_BlinnPhong( directionalLights[ i ], geometry, material, reflectedLight, shadowMask );\r\n  \t\t}\r\n\r\n    RE_IndirectDiffuse_BlinnPhong(irradiance, material, reflectedLight);\r\n\r\n    return saturate(reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular);\r\n  }\r\n#endif\r\n\r\n/////////////////////////////////////////// Dashed Line ///////////////////////////////////////////////\r\n#ifdef DASHED_LINE\r\n  uniform float dashedLineSize;\r\n  uniform float dashedLinePeriod;\r\n  varying float vLineDistance;\r\n#endif\r\n\r\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\r\nvoid main() {\r\n\r\n#ifdef CLIP_PLANE\r\n  if (vViewPosition.z < clipPlaneValue) discard;\r\n#endif\r\n\r\n#ifdef ZCLIP\r\n  if (vViewPosition.z < zClipValue) discard;\r\n#endif\r\n\r\n  vec4 pixelPosWorld = vec4(vWorldPosition, 1.0);\r\n  vec4 pixelPosEye;\r\n\r\n#ifdef SPHERE_SPRITE\r\n\r\n  vec3 viewNormalSprites;\r\n  vec3 normal;\r\n\r\n/* quick-and-dirty method\r\n  normal.xy = ' + INSTANCED_SPRITE_OVERSCALE + ' * (2.0 * vUv - 1.0);\r\n  float r2 = dot(normal.xy, normal.xy);\r\n  if (r2 > 1.0) discard;\r\n  float normalZ = sqrt(1.0 - r2);\r\n  normal.z = normalZ;\r\n  normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\r\n  pixelPosEye = vec4(spritePosEye.xyz, 1.0);\r\n  pixelPosEye.z += spritePosEye.w * normalZ;\r\n*/\r\n\r\n  // ray-trace sphere surface\r\n  {\r\n    vec3 p;\r\n    if (get_sphere_point(-vViewPosition, p) < 0.0) discard;\r\n    pixelPosWorld = modelMatrix * vec4(instOffset.xyz + p * instOffset.w, 1.0);\r\n    // pixelPosEye = modelViewMatrix * vec4(instOffset.xyz + p * instOffset.w, 1.0);\r\n    pixelPosEye = vec4(spritePosEye.xyz, 1.0);\r\n    pixelPosEye.z += instOffset.w *\r\n      (modelViewMatrix[0][2] * p.x +\r\n       modelViewMatrix[1][2] * p.y +\r\n       modelViewMatrix[2][2] * p.z);\r\n    normal = normalize(normalMatrix * p);\r\n    #ifdef NORMALS_TO_G_BUFFER\r\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*p);\r\n    #endif\r\n  }\r\n\r\n#endif\r\n\r\n#ifdef CYLINDER_SPRITE\r\n  vec3 normal;\r\n  vec3 viewNormalSprites;\r\n  float cylinderY = 0.0;\r\n\r\n    // ray-trace cylinder surface\r\n    {\r\n      vec3 p;\r\n      if (get_cylinder_point(-vViewPosition, p) < 0.0) discard;\r\n\r\n      cylinderY = 0.5 * (p.y + 1.0);\r\n\r\n      vec4 v = vec4(p, 1.0);\r\n      v = vec4(dot(v, matVec1), dot(v, matVec2), dot(v, matVec3), 1.0);\r\n      pixelPosWorld = modelMatrix * v;\r\n      pixelPosEye = modelViewMatrix * v;\r\n\r\n      vec3 localNormal = normalize(vec3(p.x, 0.0, p.z));\r\n      normal = vec3(\r\n        dot(localNormal, matVec1.xyz),\r\n        dot(localNormal, matVec2.xyz),\r\n        dot(localNormal, matVec3.xyz));\r\n      #ifdef NORMALS_TO_G_BUFFER\r\n        viewNormalSprites = normalize(mat3(modelViewMatrix)*normal);\r\n      #endif\r\n      normal = normalize(normalMatrix * normal);\r\n    }\r\n#endif\r\n\r\n  #ifdef ATTR_COLOR\r\n    vec3 vertexColor = vColor;\r\n  #else\r\n    vec3 vertexColor = vec3(1.0, 1.0, 1.0);\r\n  #endif\r\n\r\n  #ifdef ATTR_COLOR2\r\n    #ifdef CYLINDER_SPRITE\r\n      float colorCoef = cylinderY; // cylinder parameter is calculated from ray-tracing\r\n    #else\r\n      float colorCoef = vUv.y; // cylinder parameter is interpolated as tex coord\r\n    #endif\r\n      // choose either color or color2\r\n    vertexColor = mix(vColor2, vColor, step(0.5, colorCoef));\r\n  #endif\r\n\r\n  // negative red component is a special condition\r\n  if (vertexColor.x < 0.0) discard;\r\n\r\n  #ifdef DASHED_LINE\r\n    if ( mod( vLineDistance, dashedLinePeriod ) > dashedLineSize ) discard;\r\n  #endif\r\n\r\n  // transparency prepass writes only z, so we don't need to calc the color\r\n  #ifdef PREPASS_TRANSP\r\n    fragColor = vec4(1.0, 1.0, 1.0, 1.0);\r\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n    #endif\r\n    return;\r\n  #endif\r\n\r\n    float totalOpacity = opacity;\r\n\r\n  #ifdef ATTR_ALPHA_COLOR\r\n    totalOpacity *= alphaCol;\r\n  #endif\r\n\r\n  // discard fully transparent pixels\r\n  if (totalOpacity == 0.0) discard;\r\n\r\n  #ifdef FAKE_OPACITY\r\n    // discard pixels in checker pattern\r\n    vec2 dm_coord = floor(gl_FragCoord.xy);\r\n    dm_coord = fract(dm_coord * 0.5);\r\n    if (totalOpacity < 1.0 && (dm_coord.x < 0.5 ^^ dm_coord.y < 0.5)) discard;\r\n    vec4 diffuseColor = vec4(diffuse, 1.0);\r\n  #else\r\n    vec4 diffuseColor = vec4(diffuse, totalOpacity);\r\n  #endif\r\n\r\n  float flipNormal;\r\n  #if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n    flipNormal = 1.0;\r\n    #ifdef DOUBLE_SIDED\r\n      flipNormal = float( gl_FrontFacing );\r\n    #endif\r\n    vec3 normal = normalize( vNormal ) * flipNormal;\r\n  #endif\r\n\r\n    diffuseColor.rgb *= vertexColor;\r\n\r\n  #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n    gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n  #endif\r\n\r\n  #ifdef NORMALS_TO_G_BUFFER\r\n    #if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\r\n      vec3 viewNormaInColor = viewNormalSprites;\r\n      float frontFaced = 1.0;\r\n    #else\r\n      vec3 viewNormaInColor = viewNormal;\r\n      float frontFaced = float( gl_FrontFacing );\r\n    #endif\r\n    // [-1, 1] -> [0, 1]\r\n    viewNormaInColor = 0.5 * viewNormaInColor + 0.5;\r\n    gl_FragData[1] = vec4(viewNormaInColor, frontFaced);\r\n  #endif\r\n\r\n  #if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r\n    GeometricContext geometry = GeometricContext(normal, normalize( vViewPosition ));\r\n    BlinnPhongMaterial material = BlinnPhongMaterial(diffuseColor.rgb, specular, shininess);\r\n    vec3 outgoingLight = calcLighting(geometry, material, vViewPosition);\r\n  #else\r\n    vec3 outgoingLight = diffuseColor.rgb;\r\n  #endif\r\n\r\n  #ifdef COLOR_FROM_DEPTH\r\n    float depth = 0.0;\r\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n      depth = gl_FragDepthEXT;\r\n    #else\r\n      depth = gl_FragCoord.z;\r\n    #endif\r\n    fragColor = packDepthToRGBA(depth);\r\n    return;\r\n  #endif\r\n\r\n  #ifdef COLOR_FROM_POS\r\n    fragColor = world2colorMatrix * pixelPosWorld;\r\n  #else\r\n    #ifdef OVERRIDE_COLOR\r\n      fragColor = vec4(fixedColor, diffuseColor.a);\r\n    #else\r\n      fragColor = vec4(outgoingLight, diffuseColor.a);//vec4(vNormal, 1.0);\r\n    #endif\r\n\r\n    #ifdef USE_FOG\r\n      float viewDistance;\r\n      #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n        viewDistance = abs(pixelPosEye.z);\r\n      #else\r\n        viewDistance = vViewPosition.z;\r\n      #endif\r\n      float fogFactor = smoothstep( fogNear, fogFar, viewDistance) * fogAlpha;\r\n      #ifdef FOG_TRANSPARENT\r\n        fragColor.a = fragColor.a * (1.0 - fogFactor);\r\n      #else\r\n        fragColor.rgb = mix( fragColor.rgb, fogColor, fogFactor );\r\n      #endif\r\n    #endif\r\n\r\n  #endif\r\n}\r\n",Mr={precision:"mediump",init:function(e){this.precision=e.capabilities.getMaxPrecision("highp")}},Pr=new Uint8Array([24,52,0,254,145,0,122,0,0,7,170,0,34,214,0,173,8,0,86,249,0,160,4,0,226,46,0,224,211,0,3,157,0,174,247,0,12,182,0,220,216,0,1,109,0,253,154,0]),Nr=me.RepeatWrapping,Ir=me.RepeatWrapping,Lr=me.NearestFilter,Or=me.NearestFilter,Vr=me.UVMapping,Dr=new me.DataTexture(Pr,4,4,me.RGBFormat,me.UnsignedByteType,Vr,Nr,Ir,Or,Lr,1);Dr.needsUpdate=!0;var zr={noiseWidth:4,noiseHeight:4,noiseTexture:Dr};function Fr(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}var Br=[new me.Vector2(-.541978,.840393),new me.Vector2(.125533,-.992089),new me.Vector2(.374329,.927296),new me.Vector2(-.105475,.994422)],Ur=me.UniformsUtils.merge([me.UniformsLib.fog,me.UniformsLib.lights,{diffuse:{value:new me.Color(15658734)},opacity:{value:1},specular:{type:"c",value:new me.Color(1118481)},shininess:{type:"f",value:30},fixedColor:{type:"c",value:new me.Color(16777215)},zOffset:{type:"f",value:0},zClipValue:{type:"f",value:0},clipPlaneValue:{type:"f",value:0},invModelViewMatrix:{type:"4fv",value:new me.Matrix4},world2colorMatrix:{type:"4fv",value:new me.Matrix4},dashedLineSize:{type:"f",value:.1},dashedLinePeriod:{type:"f",value:.2},projMatrixInv:{type:"4fv",value:new me.Matrix4},viewport:{type:"v2",value:new me.Vector2},lineWidth:{type:"f",value:2},fogAlpha:{type:"f",value:1},samplesKernel:{type:"v2v",value:null},noiseTex:{type:"t",value:null},noiseTexelSize:{type:"v2",value:null},srcTexelSize:{type:"v2",value:null}}]),Gr=["shininess","opacity","zOffset","diffuse","specular","fixedColor","zClipCoef","zClipValue","clipPlaneValue","world2colorMatrix","dashedLineSize","dashedLinePeriod","projMatrixInv","viewport","lineWidth","fogAlpha","samplesKernel","noiseTex","noiseTexelSize","srcTexelSize"];function jr(e){me.RawShaderMaterial.call(this),this.fog=!0,this.instancedPos=!1,this.instancedMatrix=!1,this.attrColor=!1,this.attrColor2=!1,this.attrAlphaColor=!1,this.overrideColor=!1,this.sphereSprite=!1,this.cylinderSprite=!1,this.zClip=!1,this.clipPlane=!1,this.fakeOpacity=!1,this.prepassTransparancy=!1,this.colorFromPos=!1,this.shadowmap=!1,this.shadowmapType="random",this.colorFromDepth=!1,this.dashedLine=!1,this.transparent=!0,this.thickLine=!1,this.fogTransparent=!1,this.normalsToGBuffer=!1,this.toonShading=!1,this.uberOptions=Object.create(jr.prototype.uberOptions),me.RawShaderMaterial.prototype.setValues.call(this,{uniforms:me.UniformsUtils.clone(Ur),vertexShader:this.precisionString()+Tr,fragmentShader:this.precisionString()+Rr,lights:!0,fog:!0,side:me.DoubleSide}),this.setValues(e)}((jr.prototype=Object.create(me.RawShaderMaterial.prototype)).constructor=jr).prototype.precisionString=function(){var e=Mr.precision;return"precision ".concat(e," float;\n")+"precision ".concat(e," int;\n\n")},jr.prototype.uberOptions={diffuse:new me.Color(16777215),specular:new me.Color(1118481),shininess:30,opacity:1,fixedColor:new me.Color(16777215),zOffset:0,zClipCoef:2,zClipValue:0,clipPlaneValue:0,world2colorMatrix:new me.Matrix4,dashedLineSize:.1,dashedLinePeriod:.3,projMatrixInv:new me.Matrix4,viewport:new me.Vector2(800,600),lineWidth:2,fogAlpha:1,samplesKernel:Br,noiseTex:zr.noiseTexture,noiseTexelSize:new me.Vector2(1/zr.noiseWidth,1/zr.noiseHeight),srcTexelSize:new me.Vector2(1/800,1/600),copy:function(e){this.diffuse.copy(e.diffuse),this.specular.copy(e.specular),this.shininess=e.shininess,this.opacity=e.opacity,this.fixedColor.copy(e.fixedColor),this.zOffset=e.zOffset,this.zClipCoef=e.zClipCoef,this.zClipValue=e.zClipValue,this.clipPlaneValue=e.clipPlaneValue,this.world2colorMatrix.copy(e.world2colorMatrix),this.dashedLineSize=e.dashedLineSize,this.dashedLinePeriod=e.dashedLinePeriod,this.projMatrixInv=e.projMatrixInv,this.viewport=e.viewport,this.lineWidth=e.lineWidth,this.toonShading=e.toonShading,this.fogAlpha=e.fogAlpha,this.samplesKernel=e.samplesKernel,this.noiseTex=e.noiseTex,this.noiseTexelSize=e.noiseTexelSize,this.srcTexelSize=e.srcTexelSize}},jr.prototype.copy=function(e){return me.RawShaderMaterial.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=me.UniformsUtils.clone(e.uniforms),this.defines=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Fr(Object(r),!0).forEach(function(e){Ce(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Fr(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({},e.defines),this.extensions=e.extensions,this.fog=e.fog,this.instancedPos=e.instancedPos,this.instancedMatrix=e.instancedMatrix,this.attrColor=e.attrColor,this.attrColor2=e.attrColor2,this.attrAlphaColor=e.attrAlphaColor,this.overrideColor=e.overrideColor,this.sphereSprite=e.sphereSprite,this.cylinderSprite=e.cylinderSprite,this.zClip=e.zClip,this.clipPlane=e.clipPlane,this.fakeOpacity=e.fakeOpacity,this.colorFromPos=e.colorFromPos,this.shadowmap=e.shadowmap,this.shadowmapType=e.shadowmapType,this.colorFromDepth=e.colorFromDepth,this.prepassTransparancy=e.prepassTransparancy,this.dashedLine=e.dashedLine,this.thickLine=e.thickLine,this.fogTransparent=e.fogTransparent,this.normalsToGBuffer=e.normalsToGBuffer,this.toonShading=e.toonShading,this.uberOptions.copy(e.uberOptions),this},jr.prototype.createInstance=function(){var e=new jr;return e.copy(this),e.uberOptions=Object.create(this.uberOptions),e},jr.prototype.setValues=function(e){if(void 0!==e){me.RawShaderMaterial.prototype.setValues.call(this,e);var t={},r={};this.fog&&(t.USE_FOG=1),this.instancedPos&&(t.INSTANCED_POS=1),this.instancedMatrix&&(t.INSTANCED_MATRIX=1),this.attrColor&&(t.ATTR_COLOR=1),this.attrColor2&&(t.ATTR_COLOR2=1),this.attrAlphaColor&&(t.ATTR_ALPHA_COLOR=1),this.overrideColor&&(t.OVERRIDE_COLOR=1),this.sphereSprite&&(t.SPHERE_SPRITE=1,r.fragDepth=1),this.cylinderSprite&&(t.CYLINDER_SPRITE=1,r.fragDepth=1),this.zClip&&(t.ZCLIP=1),this.clipPlane&&(t.CLIP_PLANE=1),this.fakeOpacity&&(t.FAKE_OPACITY=1),this.lights&&(t.USE_LIGHTS=1),this.colorFromPos&&(t.COLOR_FROM_POS=1),this.shadowmap&&(t.SHADOWMAP=1,"pcf"===this.shadowmapType?t.SHADOWMAP_PCF_SHARP=1:"random"===this.shadowmapType?t.SHADOWMAP_PCF_RAND=1:t.SHADOWMAP_BASIC=1),this.colorFromDepth&&(t.COLOR_FROM_DEPTH=1),this.prepassTransparancy&&(t.PREPASS_TRANSP=1),this.dashedLine&&(t.DASHED_LINE=1),this.thickLine&&(t.THICK_LINE=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.normalsToGBuffer&&(r.drawBuffers=1,t.NORMALS_TO_G_BUFFER=1),this.toonShading&&(t.TOON_SHADING=1),this.defines=t,this.extensions=r}},jr.prototype.setUberOptions=function(e){if(void 0!==e)for(var t in e)e.hasOwnProperty(t)&&(this.uberOptions[t]instanceof me.Color?this.uberOptions[t]=e[t].clone():this.uberOptions[t]=e[t])},jr.prototype.clone=function(e){return e?this.createInstance():me.Material.prototype.clone.call(this)},jr.prototype.updateUniforms=function(){var t=this;Gr.forEach(function(e){t.uniforms.hasOwnProperty(e)&&(t.uberOptions[e]instanceof me.Color||t.uberOptions[e]instanceof me.Matrix4?t.uniforms[e].value=t.uberOptions[e].clone():t.uniforms[e].value=t.uberOptions[e])})};var Hr,Wr,Yr={DEFAULT:0,VOLUME:1,TRANSPARENT:2,PREPASS_TRANSPARENT:3,VOLUME_BFPLANE:4,COLOR_FROM_POSITION:5,SHADOWMAP:6},Xr=[Yr.DEFAULT,Yr.TRANSPARENT];me.Object3D.prototype.resetTransform=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.scale.set(1,1,1)},me.Object3D.prototype.updateMatrixWorldRecursive=function(){null!=this.parent&&this.parent.updateMatrixWorldRecursive(),this.updateMatrixWorld()},me.Object3D.prototype.addSavingWorldTransform=(Hr=new me.Matrix4,function(e){e instanceof me.Object3D&&(Hr.getInverse(this.matrixWorld),Hr.multiply(e.matrixWorld),e.matrix.copy(Hr),e.matrix.decompose(e.position,e.quaternion,e.scale),this.add(e))}),me.WebGLRenderer.prototype.renderDummyQuad=function(){var e=new me.MeshBasicMaterial({transparent:!0,opacity:0,depthWrite:!1}),t=new me.Scene,r=new me.Mesh(new me.PlaneBufferGeometry(.01,.01),e);t.add(r);var n=new me.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(){this.render(t,n)}}(),me.WebGLRenderer.prototype.renderScreenQuad=function(){var t=new me.Scene,r=new me.Mesh(new me.PlaneBufferGeometry(1,1));t.add(r);var n=new me.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(e){r.material=e,this.render(t,n)}}(),me.Matrix4.prototype.isIdentity=(Wr=new me.Matrix4,function(){return Wr.equals(this)}),me.Matrix4.prototype.applyToPointsArray=function(e,t,r){if(!e||!t||t<3)return e;r=r||0;for(var n=this.elements,i=0;i<e.length;i+=t){var o=e[i],s=e[i+1],a=e[i+2],l=1/(n[3]*o+n[7]*s+n[11]*a+n[15]);e[i]=(n[0]*o+n[4]*s+n[8]*a+n[12]*r)*l,e[i+1]=(n[1]*o+n[5]*s+n[9]*a+n[13]*r)*l,e[i+2]=(n[2]*o+n[6]*s+n[10]*a+n[14]*r)*l}return e};var qr,$r,Zr,Kr=function(e){function t(e){return W(this,t),void 0===e.uniforms&&(e.uniforms={}),e.uniforms.srcTex={type:"t",value:null},e.vertexShader=kr,e.transparent=!1,e.depthTest=!1,e.depthWrite=!1,Y(this,X(t).call(this,e))}return A(t,e),t}(me.RawShaderMaterial);function Qr(e,i){!function e(t){t instanceof me.Mesh&&i(t);for(var r=0,n=t.children.length;r<n;r++)e(t.children[r])}(e)}function Jr(e){e.traverse(function(e){(e instanceof me.Mesh||e instanceof me.LineSegments||e instanceof me.Line)&&e.geometry.dispose()}),function(e){for(var t=e.children,r=0,n=t.length;r<n;++r){var i=t[r];i.parent=null,i.dispatchEvent({type:"removed"})}e.children=[]}(e)}function en(e,r){var n=[];return e.traverse(function(e){for(var t=0;t<r.length;t++)if(e instanceof r[t]){n[n.length]=e;break}}),n}me.WebGLRenderer.prototype.renderScreenQuadFromTex=(qr=new Kr({uniforms:{opacity:{type:"f",value:1}},fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform float opacity;\r\n\r\nvoid main() {\r\n  vec4 color = texture2D(srcTex, vUv);\r\n  gl_FragColor = vec4(color.xyz, color.a * opacity);\r\n}\r\n",transparent:!0}),function(e,t){qr.uniforms.srcTex.value=e,qr.transparent=t<1,qr.uniforms.opacity.value=t,this.renderScreenQuad(qr)}),me.WebGLRenderer.prototype.renderScreenQuadFromTexWithDistortion=($r=new Kr({uniforms:{coef:{type:"f",value:1}},fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform float coef;\r\n\r\nvoid main() {\r\n  vec2 uv = vUv * 2.0 - 1.0;\r\n  float r2 = dot(uv, uv);\r\n  vec2 tc = uv * (1.0 + coef * r2);\r\n  if (!all(lessThan(abs(tc), vec2(1.0))))\r\n    discard;\r\n  tc = 0.5 * (tc + 1.0);\r\n  gl_FragColor = texture2D(srcTex, tc);\r\n}\r\n"}),function(e,t){$r.uniforms.srcTex.value=e,$r.uniforms.coef.value=t,this.renderScreenQuad($r)}),me.PerspectiveCamera.prototype.setMinimalFov=function(e){1<=this.aspect?this.fov=e:this.fov=me.Math.radToDeg(2*Math.atan(Math.tan(.5*me.Math.degToRad(e))/this.aspect))},me.StereoCamera.prototype.updateHalfSized=function(e,t){var r=e.aspect,n=e.fov;e.aspect=r/2,e.setMinimalFov(t),e.updateProjectionMatrix(),this.update(e),e.aspect=r,e.fov=n,e.updateProjectionMatrix()},me.PerspectiveCamera.prototype.setDistanceToFit=function(e,t){this.position.z=e/Math.sin(.5*me.Math.degToRad(t))},me.Raycaster.prototype.intersectVisibleObject=function(e,t,r,n){var i=this.intersectObject(e,!1);if(0===i.length)return null;var o,s=Math.min(t.near,r),a=i[0],l=new me.Vector3;for(o=0;o<i.length&&(a=i[o],l.copy(a.point),l.applyMatrix4(t.matrixWorldInverse),!(l.z<=-s));++o);if(o===i.length)return null;var c=Math.min(t.far,n);return l.copy(a.point),l.applyMatrix4(t.matrixWorldInverse),l.z<=-c?null:a},me.Matrix4.prototype.extractScale=(Zr=new me.Vector3,function(e){void 0===e&&(I.debug("extractScale(): new is too expensive operation to do it on-the-fly"),e=Zr.clone());var t=this.elements;return e.x=Zr.set(t[0],t[1],t[2]).length(),e.y=Zr.set(t[4],t[5],t[6]).length(),e.z=Zr.set(t[8],t[9],t[10]).length(),this.determinant()<0&&(e.x=-e.x),e}),me.BufferAttribute.prototype.copyAtList=function(e,t){for(var r=this.itemSize,n=0,i=t.length;n<i;++n)for(var o=0;o<r;++o)this.array[n*r+o]=e.array[t[n]*r+o];return this};var tn={calcCylinderMatrix:function(e,t,r){var n=e.clone().lerp(t,.5),i=new me.Matrix4;i.makeScale(r,e.distanceTo(t),r);var o=new me.Matrix4;o.makeRotationX(Math.PI/2);var s=new me.Matrix4,a=new me.Vector3(0,1,0);return s.lookAt(n,t,a),s.multiply(o),s.multiply(i),s.setPosition(n),s},calcChunkMatrix:function(e,t,r,n){var i=new me.Matrix4;i.makeScale(n.x,n.y,0);var o=new me.Matrix4;return o.lookAt(e,t,r),o.multiply(i),o.setPosition(e),o},forEachMeshInGroup:Qr,countTriangles:function(e){var t=0;return Qr(e,function(e){t+=function(e){var t=e.geometry;if(t instanceof me.InstancedBufferGeometry){var r=t.attributes;for(var n in r)if(r.hasOwnProperty(n)&&r[n]instanceof me.InstancedBufferAttribute){var i=r[n];return(t.index?t.index.array.length/3:0)*i.array.length/i.itemSize}return 0}return t instanceof me.BufferGeometry?t.index?t.index.array.length/3:0:t.faces?t.faces.length:0}(e)}),t},groupHasGeometryToRender:function(e){var t=!1;return e.traverse(function(e){(e.hasOwnProperty("geometry")||e instanceof Ar)&&(t=!0)}),t},buildDistorionMesh:function(e,t,i){function r(e){for(var t=0,r=e,n=1;1e-5<Math.abs(r-t);)r=e/((n=1+i*(t=r))*n);return 1/n}for(var n=new me.PlaneBufferGeometry(2,2,e,t),o=n.getAttribute("position"),s=0;s<o.count;++s){var a=o.array[3*s],l=o.array[3*s+1],c=r(a*a+l*l);o.setXY(s,c*a,c*l)}return n},RCGroup:Er,fillArray:function(e,t,r,n){r=void 0!==r?r:0,n=void 0!==n?n:e.length;for(var i=r;i<n;++i)e[i]=t},clearTree:Jr,destroyObject:function(e){Jr(e),e.parent?e.parent.remove(e):e.dispatchEvent({type:"removed"})},belongToSelectLayers:function(e){for(var t=0;t<Xr.length;t++)if(1==(e.layers.mask>>Xr[t]&1))return!0;return!1},applyTransformsToMeshes:function(e,t){var r=t.length;if(!(r<1))for(var n=en(e,[me.Mesh,me.LineSegments,me.Line]),i=0,o=n.length;i<o;++i){var s=n[i],a=s.parent;if(a){s.applyMatrix(t[0]);for(var l=1;l<r;++l){var c=new s.constructor(s.geometry,s.material);a.add(c),c.applyMatrix(t[l])}}}},processTransparentMaterial:function(e,t){if(t instanceof jr)for(var o=en(e,[me.Mesh,me.LineSegments]),r=function(e){var t=o[e],r=t.parent;if(!r)return"continue";t.material.setValues({prepassTransparancy:!1,fakeOpacity:!1}),t.material.needsUpdate=!0,t.layers.set(Yr.TRANSPARENT);var n=t.material.createInstance();n.setValues({prepassTransparancy:!0,fakeOpacity:!1});var i=new t.constructor(t.geometry,n);w.forEach(["transparent","colorFromDepth","lights","shadowmap","fog"],function(e){i.material[e]=!1}),i.material.needsUpdate=!0,i.applyMatrix(t.matrix),i.layers.set(Yr.PREPASS_TRANSPARENT),r.add(i)},n=0,i=o.length;n<i;++n)r(n)},processColFromPosMaterial:function(e,t){if(t instanceof jr)for(var o=en(e,[me.Mesh,me.LineSegments]),r=function(e){var t=o[e],r=t.parent;if(!r)return"continue";var n=t.material.createInstance();n.setValues({colorFromPos:!0});var i=new t.constructor(t.geometry,n);w.forEach(["transparent","colorFromDepth","lights","shadowmap","fog","overrideColor","fogTransparent","attrColor","attrColor2","attrAlphaColor","fakeOpacity"],function(e){i.material[e]=!1}),i.material.needsUpdate=!0,i.applyMatrix(t.matrix),i.layers.set(Yr.COLOR_FROM_POSITION),r.add(i)},n=0,i=o.length;n<i;++n)r(n)},createShadowmapMaterial:function(e,t){if(t instanceof jr)for(var o=en(e,[me.Mesh,me.LineSegments]),r=function(e){var t=o[e];if(!t.receiveShadow&&t.material.shadowmap&&t.material.setValues({shadowmap:!1}),!t.castShadow)return"continue";var r=t.parent;if(!r)return"continue";var n=t.material.createInstance();n.setValues({colorFromDepth:!0});var i=new t.constructor(t.geometry,n);w.forEach(["lights","shadowmap","fog"],function(e){i.material[e]=!1}),i.isShadowmapMesh=!0,i.material.needsUpdate=!0,i.applyMatrix(t.matrix),i.layers.set(Yr.SHADOWMAP),r.add(i)},n=0,i=o.length;n<i;++n)r(n)},removeShadowmapMaterial:function(e,t){if(t instanceof jr)for(var r=en(e,[me.Mesh,me.LineSegments]),n=0,i=r.length;n<i;++n){var o=r[n];o.isShadowmapMesh&&o.parent&&o.parent.remove(o)}},processObjRenderOrder:function(e,t){var r=+("BA"!==t);e.traverse(function(e){e.isGroup&&(e.renderOrder=r)})},makeVisibleMeshes:function(e,t){e&&e.traverse&&e.traverse(function(e){e instanceof me.Mesh&&(e.visible=t(e))})},applySelectionMaterial:function(e){e.traverse(function(e){"material"in e&&(e.material=e.material.clone(!0),e.material.setValues({depthFunc:me.LessEqualDepth,overrideColor:!0,fog:!1}),e.material.setUberOptions({fixedColor:new me.Color(16776960),zOffset:-1e-6}))})},getMiddlePoint:function(e,t,r){var n=r||new me.Vector3;return n.set(0,0,0),n.addScaledVector(e,.5),n.addScaledVector(t,.5),n},LAYERS:Yr},rn={boundingBox:new me.Box3(new me.Vector3(-1,-1,-1),new me.Vector3(1,1,1)),boundingSphere:new me.Sphere(new me.Vector3(0,0,0),1)};function nn(e,t){tn.RCGroup.call(this),this.name=e,this._dataSource=t}_e.deriveClass(nn,tn.RCGroup),nn.prototype.release=function(){this.parent&&this.parent.remove(this)},nn.prototype.getDataSource=function(){return this._dataSource},nn.prototype.getBoundaries=function(){return rn};var on=function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}};var sn=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)};var an=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var ln=function(e){return on(e)||sn(e)||an()};function cn(e){return null==e||Array.isArray(e)?e:[e]}var un=function(){function n(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:["id"];W(this,n),this._list=[],this._dict={},this._indices=ln(r),this._indices.forEach(function(e){t._dict[e]={}}),e.forEach(function(e){return t.register(e)})}return p(n,[{key:"register",value:function(t){var r=this;n.registerInList(this._list,t),this._indices.forEach(function(e){n.registerInDict(r._dict[e],cn(t[e]),t)})}},{key:"unregister",value:function(t){var r=this;n.unregisterFromList(this._list,t),this._indices.forEach(function(e){n.unregisterFromDict(r._dict[e],cn(t[e]),t)})}},{key:"keys",value:function(e){return Object.keys(this._dict[e||this._indices[0]])}},{key:"get",value:function(e,t){var r=this._dict[t||this._indices[0]];if(r){var n=r[e&&e.toLowerCase()];return n&&0<n.length?n[0]:void 0}}},{key:"all",get:function(){return ln(this._list)}},{key:"first",get:function(){return this._list[0]}}],[{key:"registerInList",value:function(e,t){e.includes(t)||e.push(t)}},{key:"unregisterFromList",value:function(e,t){var r=e.indexOf(t);-1!==r&&e.splice(r,1)}},{key:"registerInDict",value:function(r,e,n){e.forEach(function(e){e=e.toLowerCase();var t=r[e]=r[e]||[];t.includes(n)||t.push(n)})}},{key:"unregisterFromDict",value:function(n,e,i){e.forEach(function(e){e=e.toLowerCase();var t=n[e];if(t){var r=t.indexOf(i);-1!==r&&t.splice(r,1),0===t.length&&delete n[e]}})}}]),n}();function hn(e){Object.defineProperties(e,{logger:{get:function(){return this.context&&this.context.logger?this.context.logger:I}},settings:{get:function(){return this.context&&this.context.settings?this.context.settings:Q}}})}var dn=function(){function n(e,t){W(this,n),this._position=e,this._radius=t}return p(n,[{key:"raycast",value:function(e){var t=n._sphere;t.set(this._position,this._radius);var r=new me.Vector3;return e.ray.intersectSphere(t,r)?{distance:e.ray.origin.distanceTo(r),point:r}:null}}]),n}();Ce(dn,"_sphere",new me.Sphere);function fn(e){return function(){function s(e){var t,r;W(this,s);for(var n=arguments.length,i=new Array(1<n?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return(r=Y(this,(t=X(s)).call.apply(t,[this].concat(i))))._objects=new Array(e),r.boundingSphere=null,r.boundingBox=null,r}return A(s,e),p(s,[{key:"setSphere",value:function(e,t,r){this._objects[e]=new dn(t,r)}},{key:"raycast",value:function(e,t){for(var r=0,n=this._objects.length;r<n;++r){var i=this._objects[r].raycast(e);i&&(i.chunkIdx=r,t.push(i))}}},{key:"computeBoundingBox",value:function(){var e=this._objects,t=this.boundingBox;null===t&&(this.boundingBox=t=new me.Box3),t.makeEmpty();for(var r=0,n=e.length;r<n;++r)t.expandByPoint(e[r]._position)}},{key:"computeBoundingSphere",value:function(){this.computeBoundingBox();var e=this._objects,t=this.boundingBox,r=0,n=new me.Vector3;t.getCenter(n);for(var i=0,o=e.length;i<o;++i){var s=e[i]._position,a=n.distanceToSquared(s);r<a&&(r=a)}null===this.boundingSphere&&(this.boundingSphere=new me.Sphere),this.boundingSphere.set(n,Math.sqrt(r))}}]),s}()}var pn=new me.Color,mn=_e.copySubArrays;var _n=function(e){function i(e,t,r){var n;return W(this,i),(n=Y(this,X(i).call(this,e)))._sphGeometry=r?new me.PlaneBufferGeometry(2,2,1,1):new me.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI),n._init(e,n._sphGeometry),n}return A(i,e),p(i,[{key:"setItem",value:function(e,t,r){var n,i,o,s,a,l;n=this._offsets,i=4*e,o=t.x,s=t.y,a=t.z,l=r,n[i]=o,n[i+1]=s,n[i+2]=a,n[i+3]=l,this.setSphere(e,t,r)}},{key:"setColor",value:function(e,t){var r,n,i,o,s;pn.set(t),r=this._colors,n=3*e,i=pn.r,o=pn.g,s=pn.b,r[n]=i,r[n+1]=o,r[n+2]=s}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("offset").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var r=this._alpha,n=0,i=e.length;n<i;++n)r[e[n]]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=e.length,r=new me.InstancedBufferGeometry;return this._init.call(r,t,this._sphGeometry),mn(this._offsets,r._offsets,e,4),mn(this._colors,r._colors,e,3),r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}},{key:"_init",value:function(e,t){this.copy(t),this._offsets=_e.allocateTyped(Float32Array,4*e),this._colors=_e.allocateTyped(Float32Array,3*e);var r=this._alpha=_e.allocateTyped(Float32Array,e);w.fill(r,1),this.setAttribute("offset",new me.InstancedBufferAttribute(this._offsets,4,!1,1)),this.setAttribute("color",new me.InstancedBufferAttribute(this._colors,3,!1,1)),this.setAttribute("alphaColor",new me.InstancedBufferAttribute(r,1,!1,1))}}]),i}(fn(me.InstancedBufferGeometry)),vn=function(e){function v(){return W(this,v),Y(this,X(v).apply(this,arguments))}return A(v,e),p(v,[{key:"uvIntersection",value:function(e,t,r,n,i,o,s){var a=v._barycoord;return me.Triangle.barycoordFromPoint(e,t,r,n,a),i.multiplyScalar(a.x),o.multiplyScalar(a.y),s.multiplyScalar(a.z),i.add(o).add(s),i.clone()}},{key:"checkIntersection",value:function(e,t,r,n,i,o,s){return null===r.intersectTriangle(n,i,o,!1,s)?null:{point:s.clone()}}},{key:"checkBufferGeometryIntersection",value:function(e,t,r,n,i,o,s,a){var l=v._vA,c=v._vB,u=v._vC,h=v._intersectionPoint;l.fromBufferAttribute(n,o),c.fromBufferAttribute(n,s),u.fromBufferAttribute(n,a);var d=this.checkIntersection(e,t,r,l,c,u,h);if(d){if(i){var f=v._uvA,p=v._uvB,m=v._uvC;f.fromBufferAttribute(i,o),p.fromBufferAttribute(i,s),m.fromBufferAttribute(i,a),d.uv=this.uvIntersection(h,l,c,u,f,p,m)}var _=new me.Vector3;me.Triangle.getNormal(l,c,u,_),d.face=new me.Face3(o,s,a,_),d.faceIndex=o}return d}},{key:"raycast",value:function(e,t){var r=e.ray;if(null===this.boundingSphere&&this.computeBoundingSphere(),!1!==e.ray.intersectsSphere(this.boundingSphere)&&(null===this.boundingBox||!1!==r.intersectsBox(this.boundingBox))){var n,i,o,s=this.index,a=this.attributes,l=a.position,c=a.uv;if(null!==s)for(var u=0,h=s.count;u<h;u+=3){n=s.getX(u),i=s.getX(u+1),o=s.getX(u+2);var d=this.checkBufferGeometryIntersection(this,e,r,l,c,n,i,o);d&&(d.faceIndex=Math.floor(u/3),t.push(d))}}}}]),v}(me.BufferGeometry);Ce(vn,"_vA",new me.Vector3),Ce(vn,"_vB",new me.Vector3),Ce(vn,"_vC",new me.Vector3),Ce(vn,"_uvA",new me.Vector2),Ce(vn,"_uvB",new me.Vector2),Ce(vn,"_uvC",new me.Vector2),Ce(vn,"_barycoord",new me.Vector3),Ce(vn,"_intersectionPoint",new me.Vector3);var gn=new me.Color,yn=function(){function s(e,t){var r;if(W(this,s),(r=Y(this,X(s).call(this))).constructor===s)throw new Error("Can not instantiate abstract class!");return r._chunkGeo=e,r._init(e,t),r}return A(s,vn),p(s,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("normal").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"setColor",value:function(e,t){gn.set(t);for(var r=this._colors,n=this._chunkSize,i=e*n,o=i+n;i<o;++i){var s=3*i;r[s]=gn.r,r[1+s]=gn.g,r[2+s]=gn.b}}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var r=this._alpha,n=this._chunkSize,i=0,o=e.length;i<o;++i){var s=e[i]*n;w.fill(r,t,s,s+n)}this.getAttribute("alphaColor").needsUpdate=!0}},{key:"raycast",value:function(e,t){var r=[];ft(X(s.prototype),"raycast",this).call(this,e,r);for(var n=this._chunkGeo.index.count/3,i=0,o=r.length;i<o;++i)r[i].hasOwnProperty("faceIndex")&&(r[i].chunkIdx=Math.floor(r[i].faceIndex/n),t.push(r[i]))}},{key:"getSubset",value:function(e){var t=e.length,r=new me.BufferGeometry;this._init.call(r,this._chunkGeo,t);for(var n=this._positions,i=this._normals,o=this._colors,s=r._positions,a=r._normals,l=r._colors,c=3*this._chunkSize,u=0,h=e.length;u<h;++u){var d=u*c,f=e[u]*c,p=f+c;s.set(n.subarray(f,p),d),a.set(i.subarray(f,p),d),l.set(o.subarray(f,p),d)}return r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}},{key:"_init",value:function(e,t){var r=this._chunkSize=e.attributes.position.count,n=e.index.array,i=n.length,o=this._chunkSize*t,s=65535<o,a=i*t,l=this._index=_e.allocateTyped(s?Uint32Array:Uint16Array,a);this._positions=_e.allocateTyped(Float32Array,3*o),this._normals=_e.allocateTyped(Float32Array,3*o),this._colors=_e.allocateTyped(Float32Array,3*o);var c=this._alpha=_e.allocateTyped(Float32Array,o);w.fill(c,1);for(var u=0;u<t;++u){var h=u*i,d=u*r;l.set(n,h);for(var f=0;f<i;++f)l[h+f]+=d}this.setIndex(new me.BufferAttribute(this._index,1)),this.setAttribute("position",new me.BufferAttribute(this._positions,3)),this.setAttribute("normal",new me.BufferAttribute(this._normals,3)),this.setAttribute("color",new me.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new me.BufferAttribute(c,1))}}]),s}(),xn=function(e){function l(e,t){var r;W(this,l);var n=new me.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI),i=(r=Y(this,X(l).call(this,e,n,e)))._normals,o=n.attributes.normal.array,s=r._chunkSize;r._chunkPos=r._chunkGeo.attributes.position.array,r._tmpPositions=_e.allocateTyped(Float32Array,3*s);for(var a=0;a<e;++a)i.set(o,3*s*a);return r}return A(l,e),p(l,[{key:"setItem",value:function(e,t,r){for(var n=this._tmpPositions,i=this._chunkSize,o=this._chunkPos,s=0;s<i;++s){var a=3*s;n[a]=t.x+o[a]*r,n[1+a]=t.y+o[1+a]*r,n[2+a]=t.z+o[2+a]*r}this._positions.set(n,i*e*3),this.setSphere(e,t,r)}}]),l}(fn(yn)),bn=new me.Vector3,wn=new me.Vector3,Sn=new me.Matrix3,Cn=function(){function o(e,t){var r;W(this,o);var n=new me.CylinderBufferGeometry(1,1,1,Math.max(3,t),2,!0),i=(r=Y(this,X(o).call(this,n,2*e)))._chunkSize;return r._chunkPos=r._chunkGeo.attributes.position.array,r._chunkNorms=r._chunkGeo.attributes.normal.array,r._tmpVector=_e.allocateTyped(Float32Array,3*i),r}return A(o,yn),p(o,[{key:"setItem",value:function(e,t,r,n){var i=this._chunkSize,o=2*i*e*3,s=o+3*i,a=this._tmpVector,l=this._chunkPos,c=this._chunkNorms;bn.lerpVectors(t,r,.5);var u,h=tn.calcCylinderMatrix(t,bn,n);Sn.getNormalMatrix(h);for(var d=0;d<i;++d)u=3*d,wn.fromArray(l,u),wn.applyMatrix4(h),wn.toArray(a,u);this._positions.set(a,o),bn.sub(t);for(var f=0;f<i;++f)a[u=3*f]+=bn.x,a[u+1]+=bn.y,a[u+2]+=bn.z;this._positions.set(a,s);for(var p=0;p<i;++p)u=3*p,wn.fromArray(c,u),wn.applyMatrix3(Sn),wn.toArray(a,u);this._normals.set(a,o),this._normals.set(a,s)}},{key:"setColor",value:function(e,t,r){var n=2*e;ft(X(o.prototype),"setColor",this).call(this,n,t);var i=1+n;ft(X(o.prototype),"setColor",this).call(this,i,r)}}]),o}(),An=function(e){function H(e,t,r,n,i,o){var s;W(this,H),s=Y(this,X(H).call(this));var a=2*Math.PI;s.type="CylinderBufferGeometry";for(var l=!(s.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:i,openEnded:o})===o&&0<e,c=!1===o&&0<t,u=(i+1)*n+l*(n+1)+c*(n+1),h=(2*i+l+c)*n,d=r/2,f=new me.BufferAttribute(_e.allocateTyped(Float32Array,3*u),3),p=new me.BufferAttribute(_e.allocateTyped(Float32Array,3*u),3),m=new me.Uint16BufferAttribute(_e.allocateTyped(Uint16Array,3*h),1),_=new me.BufferAttribute(_e.allocateTyped(Float32Array,2*u),2),v=0,g=0,y=-(t-e)/r,x=0;x<=i;x++){if(x!==i)for(var b=0;b<n;b++){var w=v+b,S=v+n+b,C=v+n+(b+1)%n,A=v+(b+1)%n;m.setXYZ(3*g,w,A,S),g++,m.setXYZ(3*g,S,A,C),g++}for(var E=x/i,k=E*(t-e)+e,T=0;T<n;T++){var R=T/n,M=k*Math.sin(R*a+0),P=E*r-d,N=k*Math.cos(R*a+0),I=new me.Vector3(M,Math.sqrt(M*M+N*N)*y,N).normalize();f.setXYZ(v,M,P,N),p.setXYZ(v,I.x,I.y,I.z),_.setXY(v,R,E),++v}}if(l){for(var L=v,O=v+n,V=0;V<n;++V){var D=v-n;f.setXYZ(v,f.getX(D),f.getY(D),f.getZ(D)),p.setXYZ(v,0,1,0),_.setXY(v,1,1);var z=L+(V+1)%n;m.setXYZ(3*g,v,z,O),g++,v++}f.setXYZ(v,0,d,0),p.setXYZ(v,0,1,0),_.setXY(v,1,1),++v}if(c){for(var F=v,B=v+n,U=0;U<n;++U){var G=U;f.setXYZ(v,f.getX(G),f.getY(G),f.getZ(G)),p.setXYZ(v,0,-1,0),_.setXY(v,0,0);var j=F+(U+1)%n;m.setXYZ(3*g,j,v,B),g++,v++}f.setXYZ(v,0,-d,0),p.setXYZ(v,0,-1,0),_.setXY(v,0,0)}return s.setIndex(m),s.setAttribute("position",f),s.setAttribute("normal",p),s.setAttribute("uv",_),s}return A(H,e),p(H,[{key:"clone",value:function(){var e=this.parameters;return new H(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded)}}]),H}(me.BufferGeometry),En=new me.Color,kn=new me.Matrix4,Tn=_e.copySubArrays;function Rn(e,t,r,n,i){e[t]=r,e[t+1]=n,e[t+2]=i}function Mn(e,t,r,n,i,o){e[t]=r,e[t+1]=n,e[t+2]=i,e[t+3]=o}function Pn(e,t){return e-t}var Nn=function(e){function o(e,t,r,n){var i;return W(this,o),(i=Y(this,X(o).call(this)))._useZSprites=r,i._cylGeometry=r?new me.PlaneBufferGeometry(2,2,1,1):new An(1,1,1,Math.max(3,t),2,n),i._init(e,i._cylGeometry,i._useZSprites),i._collisionGeo=new Cn(e,3),i}return A(o,e),p(o,[{key:"setItem",value:function(e,t,r,n){var i=tn.calcCylinderMatrix(t,r,n),o=i.elements,s=4*e;this._collisionGeo.setItem(e,t,r,n),Mn(this._matVector1,s,o[0],o[4],o[8],o[12]),Mn(this._matVector2,s,o[1],o[5],o[9],o[13]),Mn(this._matVector3,s,o[2],o[6],o[10],o[14]),this._useZSprites&&(kn.getInverse(i),o=kn.elements,Mn(this._invmatVector1,s,o[0],o[4],o[8],o[12]),Mn(this._invmatVector2,s,o[1],o[5],o[9],o[13]),Mn(this._invmatVector3,s,o[2],o[6],o[10],o[14]))}},{key:"setColor",value:function(e,t,r){var n=3*e;En.set(t),Rn(this._color1,n,En.r,En.g,En.b),En.set(r),Rn(this._color2,n,En.r,En.g,En.b)}},{key:"computeBoundingSphere",value:function(){this._collisionGeo.computeBoundingSphere(),this.boundingSphere=this._collisionGeo.boundingSphere}},{key:"computeBoundingBox",value:function(){this._collisionGeo.computeBoundingBox(),this.boundingBox=this._collisionGeo.boundingBox}},{key:"raycast",value:function(e,t){this._collisionGeo.raycast(e,t)}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("matVector1").needsUpdate=!0,this.getAttribute("matVector2").needsUpdate=!0,this.getAttribute("matVector3").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("color2").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this._useZSprites&&(this.getAttribute("invmatVector1").needsUpdate=!0,this.getAttribute("invmatVector2").needsUpdate=!0,this.getAttribute("invmatVector3").needsUpdate=!0),this._collisionGeo.finishUpdate()}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var r=this._alpha,n=0,i=e.length;n<i;++n)r[Math.floor(e[n]/2)]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=function(e){e.sort(Pn);for(var t=[],r=[],n=0,i=e.length;n<i;++n){var o=e[n],s={first:!1,second:!1};(0|o)%2==0?(s.first=!0,s.second=n+1<i&&e[n+1]===e[n]+1,s.second&&++n):s.second=!0,t.push(Math.floor(o/2)),r.push(s)}return{indices:t,cylinderInfo:r}}(e),r=t.indices,n=r.length,i=new me.InstancedBufferGeometry;return this._init.call(i,n,this._cylGeometry,this._useZSprites),Tn(this._matVector1,i._matVector1,r,4),Tn(this._matVector2,i._matVector2,r,4),Tn(this._matVector3,i._matVector3,r,4),this._useZSprites&&(Tn(this._invmatVector1,i._invmatVector1,r,4),Tn(this._invmatVector2,i._invmatVector2,r,4),Tn(this._invmatVector3,i._invmatVector3,r,4)),Tn(this._color1,i._color1,r,3),Tn(this._color2,i._color2,r,3),function(e,t,r){for(var n=0,i=e.length;n<i;++n){var o=e[n];o.first||(t[3*n]=-.5),o.second||(r[3*n]=-.5)}}(t.cylinderInfo,i._color1,i._color2),i.boundingSphere=this.boundingSphere,i.boundingBox=this.boundingBox,[i]}},{key:"getGeoParams",value:function(){return this._cylGeometry.parameters}},{key:"_init",value:function(e,t,r){this.copy(t),this._matVector1=_e.allocateTyped(Float32Array,4*e),this._matVector2=_e.allocateTyped(Float32Array,4*e),this._matVector3=_e.allocateTyped(Float32Array,4*e),this._color1=_e.allocateTyped(Float32Array,3*e),this._color2=_e.allocateTyped(Float32Array,3*e);var n=this._alpha=_e.allocateTyped(Float32Array,e);w.fill(n,1),this.setAttribute("matVector1",new me.InstancedBufferAttribute(this._matVector1,4,!1,1)),this.setAttribute("matVector2",new me.InstancedBufferAttribute(this._matVector2,4,!1,1)),this.setAttribute("matVector3",new me.InstancedBufferAttribute(this._matVector3,4,!1,1)),this.setAttribute("color",new me.InstancedBufferAttribute(this._color1,3,!1,1)),this.setAttribute("color2",new me.InstancedBufferAttribute(this._color2,3,!1,1)),this.setAttribute("alphaColor",new me.InstancedBufferAttribute(this._alpha,1,!1,1)),r&&(this._invmatVector1=_e.allocateTyped(Float32Array,4*e),this._invmatVector2=_e.allocateTyped(Float32Array,4*e),this._invmatVector3=_e.allocateTyped(Float32Array,4*e),this.setAttribute("invmatVector1",new me.InstancedBufferAttribute(this._invmatVector1,4,!1,1)),this.setAttribute("invmatVector2",new me.InstancedBufferAttribute(this._invmatVector2,4,!1,1)),this.setAttribute("invmatVector3",new me.InstancedBufferAttribute(this._invmatVector3,4,!1,1)))}}]),o}(me.InstancedBufferGeometry),In=3,Ln=3,On=new me.Vector3,Vn=new me.Vector3,Dn=new me.Vector3,zn=new me.Vector3(1,0,0),Fn=new me.Vector3,Bn=new me.Vector3;var Un=function(){function a(e,t,r){var n;W(this,a);var i=function(e,t){for(var r=new me.BufferGeometry,n=e.length,i=n*t,o=i<=65536?Uint16Array:Uint32Array,s=(t-1)*n*2,a=new me.BufferAttribute(_e.allocateTyped(o,s*Ln),1),l=0,c=0,u=0;u<t;u++){if(u!==t-1)for(var h=0;h<n;h++){var d=l+h,f=l+n+h,p=l+n+(h+1)%n,m=l+(h+1)%n;a.setXYZ(c*Ln,d,m,f),c++,a.setXYZ(c*Ln,f,m,p),c++}l+=n}r.setIndex(a);var _=_e.allocateTyped(Float32Array,i*In);return r.setAttribute("position",new me.BufferAttribute(_,In)),r._positions=e,r}(e,t);(n=Y(this,X(a).call(this,i,r)))._ringsCount=t;for(var o=n._tmpShape=[],s=0;s<e.length;++s)o[s]=new me.Vector3;return n}return A(a,yn),p(a,[{key:"setItem",value:function(e,t,r,n){var i=2<arguments.length&&void 0!==r&&r,o=3<arguments.length&&void 0!==n&&n,s=this._chunkGeo._positions.length,a=this._ringsCount,l=s*this._ringsCount*e*In;this._setPoints(t,s,a,l),i?this._setSlopeNormals(s,a,l):this._setBaseNormals(s,a,l),o&&this._addCut(s,a,l)}},{key:"_setPoints",value:function(e,t,r,n){for(var i=this._tmpShape,o=this._positions,s=this._chunkGeo._positions,a=0,l=n;a<r;++a)for(var c=e[a],u=0;u<t;++u,l+=In)i[u].copy(s[u]).applyMatrix4(c).toArray(o,l)}},{key:"_setBaseNormals",value:function(e,t,r){for(var n=e*In,i=0,o=r;i<t;++i,o+=n)this._countNormalsInRing(e,o,!1)}},{key:"_setSlopeNormals",value:function(e,t,r){for(var n=this._normals,i=e*In,o=r,s=0;s<e;++s,o+=In)zn.toArray(n,o);if(0<o-2*i)for(var a=0;a<e;++a,o+=In)Dn.fromArray(n,o-2*i).toArray(n,o);else this._countNormalsInRing(e,o,!0,+i),o+=i;for(var l=2;l<t;++l,o+=i)this._countNormalsInRing(e,o,!0,-i)}},{key:"_countNormalsInRing",value:function(e,t,r,n){var i=this._tmpShape,o=this._normals;i[0].fromArray(this._positions,t),i[e-1].fromArray(this._positions,t+(e-1)*In);for(var s=0;s<e;++s,t+=In)s<e-1&&i[s+1].fromArray(this._positions,t+In),r?(Bn.fromArray(this._positions,t+n),On.subVectors(i[(s+e-1)%e],i[(s+1)%e]).normalize(),Vn.subVectors(i[s],Bn).normalize(),Dn.crossVectors(Vn,On).normalize().toArray(o,t)):(On.subVectors(i[s],i[(s+e-1)%e]).normalize(),Vn.subVectors(i[s],i[(s+1)%e]).normalize(),Dn.addVectors(On,Vn).normalize().toArray(o,t))}},{key:"_addCut",value:function(e,t,r){if(!(e<3||t<2)){var n=this._positions,i=this._normals,o=this._tmpShape,s=e*In;o[0].fromArray(n,r),o[1].fromArray(n,r+In),o[2].fromArray(n,r+2*In),On.subVectors(o[1],o[0]).normalize(),Vn.subVectors(o[1],o[2]).normalize(),Fn.crossVectors(On,Vn).normalize();for(var a=r,l=0;l<2*e;++l,a+=In)Fn.toArray(i,a);if(2<t)for(var c=0;c<e;++c,a+=In)Dn.fromArray(n,a-s).toArray(n,a)}}}]),a}(),Gn=new me.Color,jn=new me.Vector3;function Hn(e,t,r,n,i){e[t]=r,e[t+1]=n,e[t+2]=i}function Wn(e,t,r,n,i,o){e[t]=r,e[t+1]=n,e[t+2]=i,e[t+3]=o}function Yn(e,t,r,n){var i=4*t,o=i+4*r;return e.subarray(i*n,o*n)}var Xn=function(e){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this)))._initVertices(e),t}return A(r,e),p(r,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this.getAttribute("direction").needsUpdate=!0}},{key:"setColor",value:function(e,t){Gn.set(t);var r=4*e*3;Hn(this._colors,r,Gn.r,Gn.g,Gn.b),r+=3,Hn(this._colors,r,Gn.r,Gn.g,Gn.b),r+=3,Hn(this._colors,r,Gn.r,Gn.g,Gn.b),r+=3,Hn(this._colors,r,Gn.r,Gn.g,Gn.b)}},{key:"setSegment",value:function(e,t,r){jn.subVectors(t,r),jn.normalize();var n=this._positions,i=this._directions,o=4*e*4,s=4*e*3;Wn(n,o,t.x,t.y,t.z,.5),Hn(i,s,jn.x,jn.y,jn.z),s+=3,Wn(n,o+=4,t.x,t.y,t.z,-.5),Hn(i,s,jn.x,jn.y,jn.z),s+=3,Wn(n,o+=4,r.x,r.y,r.z,.5),Hn(i,s,jn.x,jn.y,jn.z),s+=3,Wn(n,o+=4,r.x,r.y,r.z,-.5),Hn(i,s,jn.x,jn.y,jn.z)}},{key:"setOpacity",value:function(e,t,r){var n=4*e,i=4*t;w.fill(this.alpha,r,i,n),this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubsetSegments",value:function(e,t){return[Yn(this._positions,e,t,4),Yn(this._directions,e,t,3)]}},{key:"getSubsetColors",value:function(e,t){return Yn(this._colors,e,t,3)}},{key:"getSubsetOpacities",value:function(e,t){return Yn(this._alpha,e,t,1)}},{key:"getNumVertexPerSegment",value:function(){return 4}},{key:"getPositionSize",value:function(){return 4}},{key:"setSegments",value:function(e,t){var r=4*e*4;if(t instanceof Array&&2===t.length){this._positions.set(t[0],r);var n=4*e*3;this._directions.set(t[1],n)}else this._positions.set(t,r)}},{key:"setColors",value:function(e,t){var r=4*e*3;this._colors.set(t,r)}},{key:"_initVertices",value:function(e){this._buffersSize=4*e;var t=this._buffersSize,r=65535<t;this._index=_e.allocateTyped(r?Uint32Array:Uint16Array,6*e),this._positions=_e.allocateTyped(Float32Array,4*t),this._colors=_e.allocateTyped(Float32Array,3*t),this._directions=_e.allocateTyped(Float32Array,3*t);var n=this._alpha=_e.allocateTyped(Float32Array,t);w.fill(n,1);for(var i=this._index,o=0,s=0,a=0;a<e;a++,o+=6,s+=4)i[o]=s,i[o+1]=s+1,i[o+2]=s+3,i[o+3]=s,i[o+4]=s+2,i[o+5]=s+3;this.setIndex(new me.BufferAttribute(this._index,1)),this.setAttribute("position",new me.BufferAttribute(this._positions,4)),this.setAttribute("color",new me.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new me.BufferAttribute(n,1)),this.setAttribute("direction",new me.BufferAttribute(this._directions,3))}}]),r}(me.BufferGeometry),qn=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Xn),p(e,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this.boundingBox,t=0,r=new me.Vector3;e&&e.getCenter(r);for(var n=this._positions,i=this.boundingSphere||new me.Sphere,o=this._positions.length,s=new me.Vector3,a=this.getPositionSize(),l=0;l<o;l+=a){s.set(n[l],n[l+1],n[l+2]);var c=r.distanceToSquared(s);t<c&&(t=c)}i.set(r,Math.sqrt(t)),this.boundingSphere=i}},{key:"computeBoundingBox",value:function(){for(var e=this._positions,t=new me.Box3,r=this._positions.length,n=new me.Vector3,i=this.getPositionSize(),o=0;o<r;o+=i)n.set(e[o],e[o+1],e[o+2]),t.expandByPoint(n);this.boundingBox=t}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}}]),e}(),$n=new me.Vector3,Zn=new me.Matrix3,Kn=function(){function o(e,t){var r;W(this,o);var n=new me.CylinderBufferGeometry(1,1,1,Math.max(3,t),2,!0),i=(r=Y(this,X(o).call(this,n,e)))._chunkSize;return r._chunkPos=r._chunkGeo.attributes.position.array,r._chunkNorms=r._chunkGeo.attributes.normal.array,r._tmpVector=_e.allocateTyped(Float32Array,3*i),r}return A(o,yn),p(o,[{key:"setItem",value:function(e,t,r,n){var i,o=this._chunkSize,s=o*e*3,a=this._tmpVector,l=this._chunkPos,c=this._chunkNorms,u=tn.calcCylinderMatrix(t,r,n);Zn.getNormalMatrix(u);for(var h=0;h<o;++h)i=3*h,$n.fromArray(l,i),$n.applyMatrix4(u),$n.toArray(a,i);this._positions.set(a,s);for(var d=0;d<o;++d)i=3*d,$n.fromArray(c,i),$n.applyMatrix3(Zn),$n.toArray(a,i);this._normals.set(a,s)}}]),o}(),Qn=function(){function l(e,t,r){var n;return W(this,l),(n=Y(this,X(l).call(this,e*t)))._init(t),n._collisionGeo=r?new Kn(e*t,3):null,n}return A(l,qn),p(l,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingSphere(),void(this.boundingSphere=e.boundingSphere);ft(X(l.prototype),"computeBoundingSphere",this).call(this)}},{key:"computeBoundingBox",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingBox(),void(this.boundingBox=e.boundingBox);ft(X(l.prototype),"computeBoundingBox",this).call(this)}},{key:"raycast",value:function(e,t){if(this._collisionGeo){var r=this._chunkSize;this._collisionGeo.raycast(e,t);for(var n=0,i=t.length;n<i;++n){var o=t[n].chunkIdx;void 0!==o&&(o=o/r|0,t[n].chunkIdx=o)}}}},{key:"setColor",value:function(e,t){for(var r=this._chunkSize,n=e*r,i=n+r;n<i;++n)ft(X(l.prototype),"setColor",this).call(this,n,t)}},{key:"setSegment",value:function(e,t,r,n){var i=this._chunkSize,o=e*i+t;ft(X(l.prototype),"setSegment",this).call(this,o,r,n),this._collisionGeo&&this._collisionGeo.setItem(e*i+t,r,n,.1)}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var r=this._chunkSize,n=0,i=e.length;n<i;++n){var o=e[n]*r;ft(X(l.prototype),"setOpacity",this).call(this,o,o+r-1,t)}}},{key:"getSubset",value:function(e){for(var t=e.length,r=this._chunkSize,n=new l(t,r,!1),i=0,o=e.length;i<o;++i){var s=i*r,a=e[i]*r;n.setSegments(s,this.getSubsetSegments(a,r)),n.setColors(s,this.getSubsetColors(a,r))}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e){this._chunkSize=e}}]),l}(),Jn=new me.Vector3,ei=function(){function s(e){var t;return W(this,s),(t=Y(this,X(s).call(this,2*e)))._init(e),t._collisionGeo=new Cn(e,3),t}return A(s,qn),p(s,[{key:"setItem",value:function(e,t,r){this._collisionGeo.setItem(e,t,r,.3);var n=2*e;Jn.lerpVectors(t,r,.5),ft(X(s.prototype),"setSegment",this).call(this,n,t,Jn),ft(X(s.prototype),"setSegment",this).call(this,1+n,Jn,r)}},{key:"setColor",value:function(e,t,r){var n=2*e;ft(X(s.prototype),"setColor",this).call(this,n,t),ft(X(s.prototype),"setColor",this).call(this,1+n,r)}},{key:"raycast",value:function(e,t){this._collisionGeo&&this._collisionGeo.raycast(e,t)}},{key:"getSubset",value:function(e){for(var t=e.length,r=new s(t),n=0,i=t;n<i;++n){var o=e[n];r.setSegments(n,this.getSubsetSegments(o,1)),r.setColors(n,this.getSubsetColors(o,1))}return r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}},{key:"_init",value:function(e){this._segCounts=2*e}}]),s}(),ti=[new me.Vector3(1,0,0),new me.Vector3(-1,0,0),new me.Vector3(0,1,0),new me.Vector3(0,-1,0),new me.Vector3(0,0,1),new me.Vector3(0,0,-1)],ri=ti.length,ni=new me.Vector3,ii=new me.Vector3,oi=function(e){function t(e){return W(this,t),Y(this,X(t).call(this,e,e,ri/2|0,!1))}return A(t,e),p(t,[{key:"setItem",value:function(e,t,r){this.setSphere(e,t,r);for(var n=0;n<ri/2;++n){var i=2*n;ni.x=t.x+ti[i].x*r,ni.y=t.y+ti[i].y*r,ni.z=t.z+ti[i].z*r;var o=1+i;ii.x=t.x+ti[o].x*r,ii.y=t.y+ti[o].y*r,ii.z=t.z+ti[o].z*r,this.setSegment(e,n,ni,ii)}}}]),t}(fn(Qn)),si=new me.Color,ai=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this)))._opts=t,r.zClip=r._opts.zClip,r._posRad=_e.allocateTyped(Float32Array,4*e),r._colors=_e.allocateTyped(Float32Array,3*e),r}return A(n,vn),p(n,[{key:"setItem",value:function(e,t,r){var n=this._posRad,i=4*e;n[i++]=t.x,n[i++]=t.y,n[i++]=t.z,n[i]=r}},{key:"setColor",value:function(e,t){si.set(t);var r=this._colors,n=3*e;r[n++]=si.r,r[n++]=si.g,r[n]=si.b}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"finishUpdate",value:function(){this._build()}},{key:"setOpacity",value:function(){}},{key:"raycast",value:function(){}},{key:"getSubset",value:function(){return[]}}]),n}(),li=function(){function e(){W(this,e),this.pointsValuesLinear=null,this.hasIntersection=null,this.bitsInside=null}return p(e,[{key:"create",value:function(e){var t=e*e*e;if(117440512<t)throw new Error("Too large cube dimension: lead to memory huge uasge");return this.pointsValuesLinear=_e.allocateTyped(Float32Array,32*t),this.hasIntersection=_e.allocateTyped(Int32Array,t),this.bitsInside=_e.allocateTyped(Int32Array,t),0}},{key:"destroy",value:function(){this.bitsInside=null,this.hasIntersection=null,this.pointsValuesLinear=null}}]),e}();li.prototype.striIndicesMarchCube=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var ci=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0];function ui(){W(this,ui),this._arrSize=8,this.p=new Array(this._arrSize),this.g=new Array(this._arrSize),this.val=new Array(this._arrSize);for(var e=0;e<this._arrSize;++e)this.p[e]=new me.Vector3,this.g[e]=new me.Vector3;this.cubeIndex=0}function hi(){W(this,hi),this.a={p:new me.Vector3,n:new me.Vector3},this.b={p:new me.Vector3,n:new me.Vector3},this.c={p:new me.Vector3,n:new me.Vector3}}function di(e){for(var t=new Array(e),r=0;r<e;++r)t[r]=new me.Vector3;return t}var fi=function(){function f(){W(this,f),this._numTriangles=0,this._numVertices=0,this._position=[],this._normals=[],this._colors=null,this._indices=[],this._volumetricData=null,this._xAxis=new me.Vector3,this._yAxis=new me.Vector3,this._zAxis=new me.Vector3,this._xDir=new me.Vector3,this._yDir=new me.Vector3,this._zDir=new me.Vector3}return p(f,[{key:"_prepareAxesAndDirs",value:function(){var e=this._volumetricData.getCellSize(),t=this._xAxis,r=this._yAxis,n=this._zAxis,i=this._xDir,o=this._yDir,s=this._zDir;t.set(e.x,0,0),r.set(0,e.y,0),n.set(0,0,e.z),i.set(1,0,0),o.set(0,1,0),s.set(0,0,1);var a=new me.Vector3;if(a.crossVectors(i,o),a.dot(s)<0&&(i.negate(),o.negate(),s.negate()),i.x<0||i.y<0||i.z<0||o.x<0||o.y<0||o.z<0||s.x<0||s.y<0||s.z<0)return!1;function l(e){return Math.abs(e)>Number.EPSILON}return!(l(t.y)||l(t.z)||l(r.x)||l(r.z)||l(n.x)||l(n.y))}},{key:"_vertexInterp",value:function(e,t,r,n,i,o){var s=t.p[r],a=t.p[n],l=t.g[r],c=t.g[n],u=t.val[r],h=e-u,d=t.val[n]-u,f=0;0<Math.abs(d)&&(f=h/d),f=1<f?1:f,i.lerpVectors(s,a,f),o.lerpVectors(l,c,f)}},{key:"_polygonize",value:function(e,t,r){for(var n=e.cubeIndex,i=0,o=f._arrSize,s=f._firstIndices,a=f._secondIndices,l=f._vertexList,c=f._normalList;i<o;++i)ci[n]&1<<i&&this._vertexInterp(t,e,s[i],a[i],l[i],c[i]);var u=0,h=16*n,d=f._triTable;for(i=0;-1!==d[h+i];i+=3)r[u].a.p.copy(l[d[h+i]]),r[u].a.n.copy(c[d[h+i]]),r[u].b.p.copy(l[d[h+i+1]]),r[u].b.n.copy(c[d[h+i+1]]),r[u].c.p.copy(l[d[h+i+2]]),r[u].c.n.copy(c[d[h+i+2]]),++u;return u}},{key:"_doGridPosNorms",value:function(e,t,r){for(var n,i=this._volumetricData,o=this._volumetricData.getData(),s=i.getDimensions(),a=s[0],l=s[1],c=s[2],u=t*i.getStrideX(),h=t*i.getStrideY(),d=t*i.getStrideZ(),f=new ui,p=f.val,m=f.val.length,_=[new me.Vector3(0,0,0),new me.Vector3(t,0,0),new me.Vector3(t,t,0),new me.Vector3(0,t,0),new me.Vector3(0,0,t),new me.Vector3(t,0,t),new me.Vector3(t,t,t),new me.Vector3(0,t,t)],v=new Array(5),g=0;g<5;++g)v[g]=new hi;var y,x=this,b=this._position,w=this._normals;n=r?(y=new me.Vector3(x._xAxis.x,x._yAxis.y,x._zAxis.z),function(e){var t=e.p.clone();t.multiply(y),b.push(t.add(x._origin)),w.push(e.n.clone())}):function(){var t=new me.Matrix3;t.set(x._xAxis.x,x._yAxis.x,x._zAxis.x,x._xAxis.y,x._yAxis.y,x._zAxis.y,x._xAxis.z,x._yAxis.z,x._zAxis.z);var r=new me.Matrix3;return r.set(x._xDir.x,x._yDir.x,x._zDir.x,x._xDir.y,x._yDir.y,x._zDir.y,x._xDir.z,x._yDir.z,x._zDir.z),function(e){b.push(e.p.clone().applyMatrix3(t).add(x._origin)),w.push(e.n.clone().applyMatrix3(r))}}();for(var S,C,A,E,k=this._indices,T=0,R=0;R<c-t;R+=t)for(var M=0;M<l-t;M+=t)for(var P=i.getDirectIdx(0,M,R),N=0;N<a-t;N+=t,P+=u){p[0]=o[P],p[1]=o[P+u],p[3]=o[P+h],p[2]=o[P+u+h],p[4]=o[P+d],p[5]=o[P+u+d],p[7]=o[P+h+d],p[6]=o[P+u+h+d];for(var I=0,L=0;L<m;++L)p[L]<e&&(I|=1<<L);if(0!==ci[I]){for(f.cubeIndex=I,L=0;L<m;++L)f.p[L].set(N+_[L].x,M+_[L].y,R+_[L].z),S=this._gradient,C=f.p[L],A=f.g[L],E=S.getValue(C.x,C.y,C.z),A.set(E[0],E[1],E[2]);var O=this._polygonize(f,e,v);for(T+=O,L=0;L<O;++L)k.push(3*this._numTriangles),k.push(3*this._numTriangles+1),k.push(3*this._numTriangles+2),++this._numTriangles,n(v[L].a),n(v[L].b),n(v[L].c)}}return T}},{key:"compute",value:function(e,t,r,n){this._volumetricData=e,this._origin=t,this._gradient=e.computeGradient(),this._doGridPosNorms(r,n,this._prepareAxesAndDirs())}},{key:"_remapIndices",value:function(e,t){for(var r=this._indices,n=_e.allocateTyped(Uint32Array,t),i=0;i<t;++i)r[i]=e[r[i]],n[i]=r[i];this._indices=n}},{key:"_remapVertices",value:function(e,t,r){for(var n=_e.allocateTyped(Float32Array,3*r),i=_e.allocateTyped(Float32Array,3*r),o=0;o<r;++o){var s=e[o];n[3*o]=s.x,n[3*o+1]=s.y,n[3*o+2]=s.z;var a=t[o].normalize();i[3*o]=a.x,i[3*o+1]=a.y,i[3*o+2]=a.z}this._position=n,this._normals=i}},{key:"vertexFusion",value:function(e,t){var r=this._indices.length,n=this._position,i=this._normals,o=0|n.length;if(0!==r&&0!=o){var s=_e.allocateTyped(Uint32Array,o);s[0]=0;for(var a=1,l=1;l<o;++l){for(var c=a-e<0?0:a-e,u=a<c+t?a:c+t,h=-1,d=c;d<u;++d)if(Math.abs(n[l]-n[d])<Number.EPSILON){h=d;break}-1!==h?s[l]=h:(n[a].copy(n[l]),i[a].copy(i[l]),s[l]=a,++a)}this._remapIndices(s,r),this._remapVertices(n,i,a)}}},{key:"setColorVolTex",value:function(e,s,t,r){var n,i,a,o,l,c,u=this._position.length/3,h=this._position,d=this._origin,f=this._volumetricData.getDimensions(),p=f[0]-1,m=f[1]-1,_=f[2]-1,v=e.getData(),g=e.getStrideX(),y=e.getStrideY(),x=e.getStrideZ();null!==r&&(a=t.getData(),o=t.getStrideX(),l=t.getStrideY(),c=t.getStrideZ());var b=1/this._xAxis.x,w=1/this._yAxis.y,S=1/this._zAxis.z,C=[],A=[],E=_e.allocateTyped(Float32Array,3*u);function k(e,t,r,n){n[0]=(1-e)*v[t]+e*v[r],n[1]=(1-e)*v[t+1]+e*v[r+1],n[2]=(1-e)*v[t+2]+e*v[r+2]}function T(e,t,r,n){var i=s[e];if(null!=i){C[i.index]=i;var o=t*r*n*a[e];void 0===A[i.index]?A[i.index]=o:A[i.index]+=o}}var R=_e.allocateTyped(Int32Array,u),M=0;for(n=0;n<u;n++){var P=3*n,N=(h[P]-d.x)*b,I=(h[1+P]-d.y)*w,L=(h[2+P]-d.z)*S,O=0|Math.min(Math.max(N,0),p),V=0|Math.min(Math.max(I,0),m),D=0|Math.min(Math.max(L,0),_),z=N-O,F=I-V,B=L-D;if(null!=r){C=[],A=[],T(i=t.getDirectIdx(O,V,D),1-z,1-F,1-B),T(i+o,z,1-F,1-B),T(i+l,1-z,F,1-B),T(i+o+l,z,F,1-B),T(i+c,1-z,1-F,B),T(i+o+c,z,1-F,B),T(i+l+c,1-z,F,B),T(i+o+l+c,z,F,B);var U=0,G=-1;for(var j in A)A[j]>U&&(U=A[G=j]);if(G<0||!r.includesAtom(C[G])){R[n]=-1;continue}}R[n]=M++;var H=O<p?g:0,W=V<m?y:0,Y=D<_?x:0,X=[0,0,0],q=[0,0,0],$=[0,0,0],Z=[0,0,0];k(z,i=e.getDirectIdx(O,V,D),i+H,X),k(z,i+W,i+H+W,q),k(z,i+Y,i+H+Y,$),k(z,i+W+Y,i+H+W+Y,Z);var K=[0,0,0];K[0]=(1-F)*X[0]+F*q[0],K[1]=(1-F)*X[1]+F*q[1],K[2]=(1-F)*X[2]+F*q[2];var Q=[0,0,0];Q[0]=(1-F)*$[0]+F*Z[0],Q[1]=(1-F)*$[1]+F*Z[1],Q[2]=(1-F)*$[2]+F*Z[2],E[P]=(1-B)*K[0]+B*Q[0],E[1+P]=(1-B)*K[1]+B*Q[1],E[2+P]=(1-B)*K[2]+B*Q[2]}if(this._colors=E,null!=r){for(n=0;n<u;++n){var J=R[n];J<0||(this._position[3*J]=this._position[3*n],this._position[3*J+1]=this._position[3*n+1],this._position[3*J+2]=this._position[3*n+2],this._normals[3*J]=this._normals[3*n],this._normals[3*J+1]=this._normals[3*n+1],this._normals[3*J+2]=this._normals[3*n+2],this._colors[3*J]=this._colors[3*n],this._colors[3*J+1]=this._colors[3*n+1],this._colors[3*J+2]=this._colors[3*n+2])}var ee=this._indices.length/3,te=0;for(n=0;n<ee;++n){var re=R[this._indices[3*n]],ne=R[this._indices[3*n+1]],ie=R[this._indices[3*n+2]];0<=re&&0<=ne&&0<=ie&&(this._indices[3*te]=re,this._indices[3*te+1]=ne,this._indices[3*te+2]=ie,++te)}this._position=new Float32Array(this._position.buffer.slice(0,3*M*4)),this._normals=new Float32Array(this._normals.buffer.slice(0,3*M*4)),this._colors=new Float32Array(this._colors.buffer.slice(0,3*M*4)),this._indices=new Uint32Array(this._indices.buffer.slice(0,3*te*4))}}},{key:"toMesh",value:function(){var e=new me.BufferGeometry;return e.setIndex(new me.BufferAttribute(this._indices,1)),e.setAttribute("position",new me.BufferAttribute(this._position,3)),e.setAttribute("normal",new me.BufferAttribute(this._normals,3)),e.setAttribute("color",new me.BufferAttribute(this._colors,3)),e.computeBoundingSphere(),e}}]),f}();Ce(fi,"_triTable",li.prototype.striIndicesMarchCube),Ce(fi,"_arrSize",12),Ce(fi,"_firstIndices",[0,1,2,3,4,5,6,7,0,1,2,3]),Ce(fi,"_secondIndices",[1,2,3,0,5,6,7,4,4,5,6,7]),Ce(fi,"_vertexList",di(fi._arrSize)),Ce(fi,"_normalList",di(fi._arrSize));var pi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ai),p(e,[{key:"_build",value:function(){var e=this._opts;this.numVoxels=[128,128,128],this.xAxis=new me.Vector3(1,0,0),this.yAxis=new me.Vector3(0,1,0),this.zAxis=new me.Vector3(0,0,1),this.origin=new me.Vector3(0,0,0),this._visibilitySelector=e.visibilitySelector,this._calcSurface(e)}},{key:"_findMinMax",value:function(e){for(var t=e.length/4,r=[e[0],e[1],e[2],e[3]],n=[e[0],e[1],e[2],e[3]],i=1;i<t;++i)for(var o=4*i,s=0;s<4;++s){var a=e[o+s];r[s]=Math.max(a,r[s]),n[s]=Math.min(a,n[s])}return{maxPosRad:r,minPosRad:n}}},{key:"_findNumVoxels",value:function(e,t){var r=this.numVoxels,n=this._findMinMax(e),i=n.minPosRad,o=n.maxPosRad;4<i[3]&&(t.gridSpacing*=i[3]);var s=t.radScale*o[3]*1.7,a=s;a=.65*Math.sqrt(4/3*Math.PI*a*a*a),s=Math.max(s,a);for(var l=0;l<3;++l)i[l]-=s,o[l]+=s;for(l=0;l<3;++l)r[l]=Math.ceil((o[l]-i[l])/t.gridSpacing);this.xAxis.x=(r[0]-1)*t.gridSpacing,this.yAxis.y=(r[1]-1)*t.gridSpacing,this.zAxis.z=(r[2]-1)*t.gridSpacing;var c=y(i,3);return this.origin.x=c[0],this.origin.y=c[1],this.origin.z=c[2],{bbox:n,dim:r}}},{key:"_makeSurface",value:function(e,t){var r=new fi;r.compute(e.volMap,this.origin,t.isoValue,1),r.vertexFusion(9,9),0<r._numTriangles?(r.setColorVolTex(e.volTexMap,e.atomMap,e.atomWeightMap,this._visibilitySelector),this.setIndex(new me.BufferAttribute(r._indices,1)),this.setAttribute("position",new me.BufferAttribute(r._position,3)),this.setAttribute("normal",new me.BufferAttribute(r._normals,3)),this.setAttribute("color",new me.BufferAttribute(r._colors,3))):this.setAttribute("position",new me.BufferAttribute(_e.allocateTyped(Float32Array,0),3))}},{key:"_calcSurface",value:function(e){var t={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};if(0!==t.posRad.length){var r=this._findNumVoxels(t.posRad,e),n=new me.Box3(this.origin,new me.Vector3(this.xAxis.x,this.yAxis.y,this.zAxis.z).add(this.origin)),i=this._computeSurface(t,n,r,e);this._makeSurface(i,e)}}}]),e}(),mi=Cr.Volume,_i=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,pi),p(e,[{key:"_computeSurface",value:function(e,t,r,n){this._shiftByOrigin(e.posRad);var i={volMap:new mi(Float32Array,this.numVoxels,t),volTexMap:new mi(Float32Array,this.numVoxels,t,3)};return null!=this._visibilitySelector&&(i.atomMap=[],i.atomWeightMap=new mi(Float32Array,this.numVoxels,t)),this.gaussdensity(i,e,null,n),i}},{key:"gaussdensity",value:function(e,t,r,n){var i,o=t.posRad.length/4,s=t.posRad,a=t.colors,l=this.numVoxels,c=n.radScale,u=n.gaussLim,h=n.gridSpacing,d=1/n.isoValue,f=1/h,p=l[0]-1,m=l[1]-1,_=l[2]-1,v=e.volMap,g=e.volTexMap,y=v.getData(),x=v.getStrideX(),b=g.getData(),w=g.getStrideX();null!=this._visibilitySelector&&(i=e.atomWeightMap.getData());for(var S=e.atomMap,C=0;C<o;++C){var A=4*C,E=s[3+A]*c,k=null===r?1:r[C],T=1/(2*E*E),R=u*E,M=R*R;R*=f;var P=s[A]*f,N=Math.max(P-R|0,0),I=Math.min(P+R|0,p);P=s[1+A]*f;var L=Math.max(P-R|0,0),O=Math.min(P+R|0,m);P=s[2+A]*f;for(var V=Math.max(P-R|0,0),D=Math.min(P+R|0,_),z=V*h-s[2+A],F=V;F<=D;++F,z+=h)for(var B=L*h-s[1+A],U=L;U<=O;++U,B+=h){var G=B*B+z*z;if(!(M<=G))for(var j=v.getDirectIdx(N,U,F),H=g.getDirectIdx(N,U,F),W=N*h-s[A],Y=N;Y<=I;++Y,W+=h,j+=x,H+=w){var X=-(W*W+G)*T,q=Math.exp(X)*k;null!=this._visibilitySelector&&q>i[j]&&(i[j]=q,S[j]=t.atoms[C]),y[j]+=q,q*=d;var $=3*C;b[H]+=q*a[$],b[H+1]+=q*a[1+$],b[H+2]+=q*a[2+$]}}}}},{key:"_shiftByOrigin",value:function(e){for(var t=this.origin.x,r=this.origin.y,n=this.origin.z,i=e.length/4,o=0;o<i;++o){var s=4*o;e[s]-=t,e[1+s]-=r,e[2+s]-=n}}}]),e}();function vi(E,e,t,r){var n=E.length/4,k=e[0],T=e[1],R=e[2],i=t[0],o=t[1],s=t[2];function M(e,t){return Math.floor((e-t)/r)}var P,N,a,l,c,I=M(i,k)+1,L=M(o,T)+1,O=M(s,R)+1,u=I*L*O,V=L*O,h=[];for(P=0;P<n;P++){var d=4*P;a=E[d],l=E[1+d],c=E[2+d],void 0===h[N=(M(a,k)*L+M(l,T))*O+M(c,R)]?h[N]=[P]:h[N].push(P)}var D,z=_e.allocateTyped(Uint32Array,u),F=_e.allocateTyped(Uint16Array,u),B=_e.allocateTyped(Uint32Array,n),f=0,p=0;for(P=0;P<u;P++){var m=z[P]=f,_=h[P];if(void 0!==_)for(D=0;D<_.length;D++)B[f]=_[D],f++;var v=f-m;p<(F[P]=v)&&(p=v)}this.neighbourListLength=27*p+1,this.withinRadii=function(e,t,r,n,i){var o=0,s=M(e,k),a=M(t,T),l=M(r,R),c=Math.max(0,s-1),u=Math.max(0,a-1),h=Math.max(0,l-1),d=Math.min(I-1,s+1),f=Math.min(L-1,a+1),p=Math.min(O-1,l+1);for(P=c;P<=d;++P){var m=P*V;for(D=u;D<=f;++D)for(var _=D*O,v=h;v<=p;++v)for(var g=z[N=m+_+v],y=g+F[N],x=g;x<y;x++){var b=4*B[x],w=E[b]-e,S=E[1+b]-t,C=E[2+b]-r,A=E[3+b]+n;w*w+S*S+C*C<=A*A&&(i[o++]=B[x])}}i[o]=-1}}function gi(e,t,r,n){var B,i,o,G,j,H,W,U,Y,X,q,$,Z,K,Q,J,ee,te=4,re=e.posRad,ne=e.colors,ie=e.atoms,oe=re.length/te,s=t.bbox,se=s.minPosRad,a=s.maxPosRad,ae=-1,le=null,ce=null,ue=null,he=new me.Vector3(0,0,0),de=new me.Vector3(0,0,0),fe=new me.Vector3(0,0,0);function l(e,t,r){for(var n=0;n<e.length;n++)e[n]=t+r*n}function c(){G=r.scaleFactor,H=t.dim,ee=Math.min(5,2+Math.floor(o*G));var e=H[0]*H[1]*H[2];W=function(e,t,r){for(var n=_e.allocateTyped(e,t),i=0;i<t;++i)n[i]=r;return n}(Float32Array,e,-1001),U=_e.allocateTyped(Float32Array,3*e),Y=_e.allocateTyped(Float32Array,e),ue&&(le=_e.allocateTyped(Float32Array,e),ce=[]),X=_e.allocateTyped(Float32Array,H[0]),q=_e.allocateTyped(Float32Array,H[1]),$=_e.allocateTyped(Float32Array,H[2]),l(X,se[0],1/G),l(q,se[1],1/G),l($,se[2],1/G)}function u(){o=r.probeRadius,G=r.scaleFactor,j=r.probePositions,ue=r.visibilitySelector,B=_e.allocateTyped(Float32Array,oe);for(var e=i=0;e<oe;++e){var t=re[e*te+3]+=o;i<t&&(i=t),B[e]=t*t}c(),function(){var e=0,t=2*Math.PI/j;K=_e.allocateTyped(Float32Array,j),Z=_e.allocateTyped(Float32Array,j);for(var r=0;r<j;r++)K[r]=Math.cos(e),Z[r]=Math.sin(e),e+=t}(),Q=new vi(re,se,a,2.01*i),J=new Int32Array(Q.neighbourListLength),ae=-1}function h(e,t,r,n){var i=te*e,o=B[e],s=re[i]-t,a=re[1+i]-r,l=re[2+i]-n;return s*s+a*a+l*l<o}function pe(e,t,r,n,i){var o;if(-1!==ae){if((o=ae)!==n&&o!==i&&h(o,e,t,r))return o;ae=-1}var s=0;for(o=J[s];0<=o;){if(o!==n&&o!==i&&h(o,e,t,r))return ae=o;o=J[++s]}return ae=-1}function d(e,t){var r,n,i=te*e,o=te*t,s=re[i],a=re[1+i],l=re[2+i],c=re[3+i],u=he.x=re[o]-s,h=he.y=re[1+o]-a,d=he.z=re[2+o]-l,f=re[3+o],p=u*u+h*h+d*d,m=Math.sqrt(p),_=c*((c*c+m*m-f*f)/(2*c*m));he.normalize(),n=he,(r=de).x=r.y=r.z=1,0!==n.x?r.x=(n.y+n.z)/-n.x:0!==n.y?r.y=(n.x+n.z)/-n.y:0!==n.z&&(r.z=(n.x+n.y)/-n.z),de.normalize(),fe.crossVectors(he,de),fe.normalize();var v=Math.sqrt(c*c-_*_);de.multiplyScalar(v),fe.multiplyScalar(v),he.multiplyScalar(_),he.x+=s,he.y+=a,he.z+=l,ae=-1;for(var g=ee,y=0;y<j;y++){var x=K[y],b=Z[y],w=he.x+x*de.x+b*fe.x,S=he.y+x*de.y+b*fe.y,C=he.z+x*de.z+b*fe.z;if(-1===pe(w,S,C,e,t))for(var A=Math.floor(G*(w-se[0])),E=Math.floor(G*(S-se[1])),k=Math.floor(G*(C-se[2])),T=Math.max(0,A-g),R=Math.max(0,E-g),M=Math.max(0,k-g),P=Math.min(H[0],A+g+2),N=Math.min(H[1],E+g+2),I=Math.min(H[2],k+g+2),L=M;L<I;L++){d=C-$[L];for(var O=H[1]*H[0]*L,V=R;V<N;V++)for(var D=d*d+(h=S-q[V])*h,z=O+H[0]*V,F=T;F<P;F++){p=D+(u=w-X[F])*u;var B=F+z,U=W[B];0<U&&p<U*U&&(W[B]=Math.sqrt(p))}}}}function f(){u(),function(){for(var e=0;e<oe;e++){var t=te*e,r=re[t],n=re[1+t],i=re[2+t],o=re[3+t],s=B[e];Q.withinRadii(r,n,i,o,J);for(var a=Math.ceil(o*G),l=Math.floor(G*(r-se[0])),c=Math.floor(G*(n-se[1])),u=Math.floor(G*(i-se[2])),h=Math.max(0,l-a),d=Math.max(0,c-a),f=Math.max(0,u-a),p=Math.min(H[0],l+a+2),m=Math.min(H[1],c+a+2),_=Math.min(H[2],u+a+2),v=3*e,g=ne[v],y=ne[1+v],x=ne[2+v],b=f;b<_;b++)for(var w=$[b]-i,S=H[1]*H[0]*b,C=d;C<m;C++)for(var A=q[C]-n,E=w*w+A*A,k=S+H[0]*C,T=h;T<p;T++){var R=T+k,M=X[T]-r,P=E+M*M;if(P<s){var N=Math.exp(.28125*-P),I=3*R;U[I]+=g*N,U[1+I]+=y*N,U[2+I]+=x*N,Y[R]+=N,null!==ue&&N>le[R]&&(le[R]=N,ce[R]=ie[e]),W[R]<0&&(W[R]=-W[R]);var L=Math.sqrt(P),O=o/L,V=M*O,D=A*O,z=w*O;if(-1===pe(V+=r,D+=n,z+=i,e,-1)){var F=o-L;F<W[R]&&(W[R]=F)}}}}}(),function(){for(var e=0;e<oe;e++){var t=te*e;Q.withinRadii(re[t],re[1+t],re[2+t],re[3+t],J);for(var r=0,n=J[r];0<=n;)e<n&&d(e,n),n=J[++r]}}(),function(){for(var e=0,t=W.length;e<t;e++){W[e]<0&&(W[e]=0);var r=Y[e];if(0<r){r=1/r;var n=3*e;U[n]*=r,U[1+n]*=r,U[2+n]*=r}}}()}this.build=function(){f(),this.volTexMap=U,this.weightsMap=le,this.atomMap=ce,this.volMap=W}}function yi(e,t){W(this,yi),this.coord=new me.Vector3,this.coord.copy(e),this.radius=t,this.colorX=.99999,this.colorY=0,this.colorZ=0,this.atomType=0,this.srcAtom=null}var xi=Cr.Volume,bi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,pi),p(e,[{key:"_computeSurface",value:function(e,t,r,n){var i=new gi(e,r,n);return i.build(),{volMap:new xi(Float32Array,this.numVoxels,t,1,i.volMap),volTexMap:new xi(Float32Array,this.numVoxels,t,3,i.volTexMap),atomMap:i.atomMap,atomWeightMap:new xi(Float32Array,this.numVoxels,t,1,i.weightsMap)}}}]),e}(),wi=function(){function o(e,t,r,n,i){W(this,o),this._numAtoms=e,this._atoms=t,this._vBoxMin=new me.Vector3,this._vBoxMax=new me.Vector3,this._vBoxMin.copy(r),this._vBoxMax.copy(n),this._probeRadius=i,this._atomsList=null,this._voxelList=null}return p(o,[{key:"createVoxels",value:function(){var e,t,r=0|this._numAtoms,n=this._atoms,i=this._vBoxMax.x-this._vBoxMin.x,o=this._vBoxMax.y-this._vBoxMin.y,s=this._vBoxMax.z-this._vBoxMin.z,a=i<o?i:o;a=s<a?s:a;var l,c=0,u=0;for(l=0;l<r;l++)c=c<(t=2*(n[l].radius+this._probeRadius))?t:c,u+=t;var h=Math.floor(a/c);h<2&&(h=2),u/=r,this._numCells=h,this._aveRad=u,this._maxRad=c;var d=h,f=h*h,p=h*h*h,m=this._xScale=1/(this._vBoxMax.x-this._vBoxMin.x),_=this._yScale=1/(this._vBoxMax.y-this._vBoxMin.y),v=this._zScale=1/(this._vBoxMax.z-this._vBoxMin.z),g=0,y=m*h,x=_*h,b=v*h;for(l=0;l<r;l++){var w=2*(4.5*(n[l].radius+this._probeRadius)),S=Math.floor(y*w+.8),C=Math.floor(x*w+.8),A=Math.floor(b*w+.8);g+=++S*++C*++A}this._voxelList=_e.allocateTyped(Int32Array,p);var E=[];if(E.length=g,null===this._voxelList||null===E)return-1;for(l=0;l<p;l++)this._voxelList[l]=-1;for(l=e=0;l<r;l++){t=4.5*(n[l].radius+this._probeRadius);var k=Math.floor((n[l].coord.x-this._vBoxMin.x-t)*h*m),T=Math.floor((n[l].coord.y-this._vBoxMin.y-t)*h*_),R=Math.floor((n[l].coord.z-this._vBoxMin.z-t)*h*v),M=Math.floor((n[l].coord.x-this._vBoxMin.x+t)*h*m),P=Math.floor((n[l].coord.y-this._vBoxMin.y+t)*h*_),N=Math.floor((n[l].coord.z-this._vBoxMin.z+t)*h*v);k=0<=k?k:0,T=0<=T?T:0,M=M<h?M:h-1,P=P<h?P:h-1,N=N<h?N:h-1;for(var I=R=0<=R?R:0;I<=N;I++)for(var L=T;L<=P;L++)for(var O=k;O<=M;O++){var V=O+L*d+I*f;if(this._voxelList[V]<0)E[2*e+0]=l,E[2*e+1]=-1,this._voxelList[V]=e,e++;else{var D=this._voxelList[V];E[2*(this._voxelList[V]=e)+0]=l,E[2*e+1]=D,e++}}}return this._atomsList=Int32Array.from(E),0}},{key:"destroyVoxels",value:function(){this._atomsList=null,this._voxelList=null,this._atoms=null,this._vertices=null,this._vBoxMin=null,this._vBoxMax=null}},{key:"forEachRelatedAtom",value:function(e,t){for(var r=Math.floor((e.x-this._vBoxMin.x)*this._numCells*this._xScale),n=Math.floor((e.y-this._vBoxMin.y)*this._numCells*this._yScale),i=Math.floor((e.z-this._vBoxMin.z)*this._numCells*this._zScale),o=r+n*this._numCells+i*this._numCells*this._numCells,s=this._atoms,a=this._voxelList[o];0<=a;a=this._atomsList[2*a+1]){t(s[this._atomsList[2*a]])}}},{key:"getClosestAtom",value:function(r){var n=null,i=Number.MAX_VALUE;return this.forEachRelatedAtom(r,function(e){var t=r.distanceToSquared(e.coord);t<i&&(i=t,n=e)}),n}},{key:"buildNormals",value:function(e,t,r){for(var o,s=this,a=0,l=0,c=0,u=0,h=0,d=0,f=0,p=0,m=0,n=2.5*this._aveRad,_=n*n,v=.1*-this._aveRad,i=function(e){var t=l-e.coord.x,r=c-e.coord.y,n=u-e.coord.z;if(!(_<(o=t*t+r*r+n*n))){var i=e.radius+s._probeRadius;(p=o-i*i)<0&&(p=-p),m=Math.exp(v*p),h+=t*m,d+=r*m,f+=n*m,a++}},g=0;g<e;g++)l=t[g].x,c=t[g].y,u=t[g].z,h=d=f=a=0,this.forEachRelatedAtom(t[g],i),o=h*h+d*d+f*f,0<a&&(p=1/Math.sqrt(o),h*=p,d*=p,f*=p),r[g].x=h,r[g].y=d,r[g].z=f;return 0}},{key:"buildColors",value:function(e,t,r,n){for(var s=this,a=0,l=0,c=0,u=0,h=0,d=n*n,f=[],p=[],m=0,i=function(e){var t=a-e.coord.x,r=l-e.coord.y,n=c-e.coord.z,i=t*t+r*r+n*n;if(!(d<i)){var o=e.radius+s._probeRadius;(u=i-o*o)<0&&(u=-u),h=1/(.8+u),f.push([e.colorX,e.colorY,e.colorZ]),p.push(h),m+=h}},o=0;o<e;o++){a=t[o].x,l=t[o].y,c=t[o].z,f=[],p=[],m=0,this.forEachRelatedAtom(t[o],i);for(var _=0;_<f.length;++_){var v=p[_]/m;r[o].x+=f[_][0]*v,r[o].y+=f[_][1]*v,r[o].z+=f[_][2]*v}}return 0}}]),o}(),Si=function(){function i(e,t,r){var n;for(W(this,i),this._maxNumVertices=e,this._maxNumTriangles=t,this._vertices=new Array(e),this._normals=new Array(e),this._colors=null,r&&(this._colors=new Array(e)),this._indices=new Array(3*t),this._numVertices=0,n=this._numTriangles=0;n<e;n++)this._vertices[n]=new me.Vector3,this._normals[n]=new me.Vector3;for(n=0;n<3*t;n++)this._indices[n]=-1;if(r)for(n=0;n<e;n++)this._colors[n]=new me.Vector3}return p(i,[{key:"destroy",value:function(){this._vertices=null,this._normals=null,this._indices=null}}]),i}(),Ci=Cr.Element;var Ai={InstancedSpheresGeometry:_n,SimpleSpheresGeometry:xn,Simple2CCylindersGeometry:Cn,Instanced2CCylindersGeometry:Nn,ExtrudedObjectsGeometry:Un,ChunkedLinesGeometry:Qn,TwoColorLinesGeometry:ei,CrossGeometry:oi,QuickSurfGeometry:_i,ContactSurfaceGeometry:bi,SSIsosurfaceGeometry:function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ai),p(e,[{key:"_build",value:function(){this._innerBuild();var e=this.getGeo();this.destroy(),this._fromGeo(e)}},{key:"_fromGeo",value:function(e){var t=null,r=_e.allocateTyped(Float32Array,3*e._numVertices),n=_e.allocateTyped(Float32Array,3*e._numVertices);null!==e._colors&&(t=_e.allocateTyped(Float32Array,3*e._numVertices));for(var i=_e.allocateTyped(Uint32Array,3*e._numTriangles),o=0,s=0;o<e._numVertices;o++)r[s+0]=e._vertices[o].x,r[s+1]=e._vertices[o].y,r[s+2]=e._vertices[o].z,n[s+0]=e._normals[o].x,n[s+1]=e._normals[o].y,n[s+2]=e._normals[o].z,s+=3;if(null!==t)for(var a=0,l=0;a<e._numVertices;a++,l+=3)t[l+0]=e._colors[a].x,t[l+1]=e._colors[a].y,t[l+2]=e._colors[a].z;for(var c=3*e._numTriangles,u=0;u<c;u++)i[u]=e._indices[u];this.setIndex(new me.BufferAttribute(i,1)),this.setAttribute("position",new me.BufferAttribute(r,3)),this.setAttribute("normal",new me.BufferAttribute(n,3)),this.setAttribute("color",new me.BufferAttribute(t,3)),this.computeBoundingBox(),this.computeBoundingSphere(),e.destroy()}},{key:"convertToAtomsColored",value:function(e,t){for(var r=e.atoms,n=e.colors,i=0,o=r.length;i<o;i++){var s=r[i].position,a=r[i].element.radius;t[i]=new yi(s,a);var l=r[i].element.number;t[i].atomType=this.getType(l);var c=3*i;t[i].colorX=n[c++],t[i].colorY=n[c++],t[i].colorZ=n[c],t[i].srcAtom=r[i]}}},{key:"getGeo",value:function(){return this.geoOut}},{key:"destroy",value:function(){this.atoms=null,this.hashLines=null,this.hashEntries=null}},{key:"getBoundingBox",value:function(e,t,r){t.x=t.y=t.z=1e7,r.x=r.y=r.z=-1e7;for(var n=this.probeRadius*this.atomRadiusScale,i=0,o=0,s=e.length;o<s;o++){var a=e[o].coord,l=e[o].radius+n;i=i<l?l:i,a.x-l<t.x&&(t.x=a.x-l),a.y-l<t.y&&(t.y=a.y-l),a.z-l<t.z&&(t.z=a.z-l),a.x+l>r.x&&(r.x=a.x+l),a.y+l>r.y&&(r.y=a.y+l),a.z+l>r.z&&(r.z=a.z+l)}t.x-=i,t.y-=i,t.z-=i,r.x+=i,r.y+=i,r.z+=i}},{key:"getCornerCoord",value:function(e,t,r,n,i,o,s){var a=1/(o-1),l=r*a,c=n*a,u=i*a;s.x=e.x*(1-l)+t.x*l,s.y=e.y*(1-c)+t.y*c,s.z=e.z*(1-u)+t.z*u}},{key:"buildEdgePoint",value:function(e,t,r,n,i,o){if(r[e]^r[t]){var s=(0-n.pointsValuesLinear[i+24+e])/(n.pointsValuesLinear[i+24+t]-n.pointsValuesLinear[i+24+e]),a=n.pointsValuesLinear[i+3*e+0],l=n.pointsValuesLinear[i+3*e+1],c=n.pointsValuesLinear[i+3*e+2],u=n.pointsValuesLinear[i+3*t+0],h=n.pointsValuesLinear[i+3*t+1],d=n.pointsValuesLinear[i+3*t+2];o.x=a*(1-s)+u*s,o.y=l*(1-s)+h*s,o.z=c*(1-s)+d*s}}},{key:"isTriangleVisible",value:function(e,t,r){var n=this.voxelWorld.getClosestAtom(e),i=this.voxelWorld.getClosestAtom(t),o=this.voxelWorld.getClosestAtom(r);return null!==n&&null!==i&&null!==o&&null!==n.srcAtom&&null!==i.srcAtom&&null!==o.srcAtom&&(this.visibilitySelector.includesAtom(n.srcAtom)&&this.visibilitySelector.includesAtom(i.srcAtom)&&this.visibilitySelector.includesAtom(o.srcAtom))}},{key:"addTriangle",value:function(e,t,r){if(this.visibilitySelector&&!this.isTriangleVisible(e,t,r))return!0;var n=this.geoOut;if(n._numTriangles>=this.maxNumTriangles)return!1;var i=this.addVertexToGeo(n,e),o=this.addVertexToGeo(n,t),s=this.addVertexToGeo(n,r);if((i|o|s)<0)return!1;var a=3*n._numTriangles;return n._indices[0+a]=i,n._indices[1+a]=o,n._indices[2+a]=s,n._numTriangles++,!0}},{key:"buildGeoFromCorners",value:function(e,t,r,n,i,o){for(var s=e-1,a=new Array(12),l=0;l<12;l++)a[l]=new me.Vector3;for(var c=[],u=0;u<8;u++)c[u]=1;for(var h=new me.Vector3,d=0,f=0;f<s;f++,0)for(var p=0;p<s;p++,0)for(var m=0;m<s;m++)if(o.hasIntersection[d]){var _=o.bitsInside[d];this.getCornerCoord(t,r,m,f,p,e,h);for(var v=32*d,g=0,y=0;g<8;g++)o.pointsValuesLinear[v+y++]=h.x,o.pointsValuesLinear[v+y++]=h.y,o.pointsValuesLinear[v+y++]=h.z;o.pointsValuesLinear[3+v]+=i.x,o.pointsValuesLinear[6+v]+=i.x,o.pointsValuesLinear[15+v]+=i.x,o.pointsValuesLinear[18+v]+=i.x,o.pointsValuesLinear[6+v+2]+=i.z,o.pointsValuesLinear[9+v+2]+=i.z,o.pointsValuesLinear[18+v+2]+=i.z,o.pointsValuesLinear[21+v+2]+=i.z,o.pointsValuesLinear[12+v+1]+=i.y,o.pointsValuesLinear[15+v+1]+=i.y,o.pointsValuesLinear[18+v+1]+=i.y,o.pointsValuesLinear[21+v+1]+=i.y;for(var x=24+v,b=0;b<8;++b)c[b]=o.pointsValuesLinear[x+b]<0?1:0;this.buildEdgePoint(0,1,c,o,v,a[0]),this.buildEdgePoint(1,2,c,o,v,a[1]),this.buildEdgePoint(2,3,c,o,v,a[2]),this.buildEdgePoint(3,0,c,o,v,a[3]),this.buildEdgePoint(4,5,c,o,v,a[4]),this.buildEdgePoint(5,6,c,o,v,a[5]),this.buildEdgePoint(6,7,c,o,v,a[6]),this.buildEdgePoint(7,4,c,o,v,a[7]),this.buildEdgePoint(0,4,c,o,v,a[8]),this.buildEdgePoint(1,5,c,o,v,a[9]),this.buildEdgePoint(2,6,c,o,v,a[10]),this.buildEdgePoint(3,7,c,o,v,a[11]);for(var w=16*_,S=0,C=0;S<6;S++,C+=3){var A=o.striIndicesMarchCube[w+C];if(A<0)break;var E=o.striIndicesMarchCube[w+C+1],k=o.striIndicesMarchCube[w+C+2];if(!this.addTriangle(a[A],a[E],a[k]))return-2}d++}else d++;return 0}},{key:"getNumIntersectedCells",value:function(e,t,r,n){for(var i=e*e,o=0,s=0,a=0,l=0;l<t;l++,a+=i)for(var c=0,u=0;u<t;u++,c+=e)for(var h=0;h<t;h++){var d=32*s+24,f=h+c+a;n.pointsValuesLinear[d]=r[f],n.pointsValuesLinear[1+d]=r[f+1],n.pointsValuesLinear[2+d]=r[f+e+1],n.pointsValuesLinear[3+d]=r[f+e],n.pointsValuesLinear[4+d]=r[i+f],n.pointsValuesLinear[5+d]=r[i+f+1],n.pointsValuesLinear[6+d]=r[i+f+e+1],n.pointsValuesLinear[7+d]=r[i+f+e];for(var p=0,m=0;m<8;++m)n.pointsValuesLinear[d+m]<0&&(p|=1<<m);0===p||255===p?n.hasIntersection[s]=!1:(n.hasIntersection[s]=!0,o++),n.bitsInside[s]=p,s++}return o}},{key:"getType",value:function(e){var t=[0,0,1,1,2,6,3,6,4,6,5,6,6,0,7,3,8,2,9,6,10,6,11,6,12,6,13,6,14,6,15,4,16,5,17,6,18,6,19,6,20,6,21,6,22,6,23,6,24,6,25,6,26,6,27,6,28,6,29,6,30,6,31,6,32,6,33,6,34,6,35,6,36,6,37,6,38,6,39,6,40,6,41,6,42,6,43,6,44,6,45,6,46,6,47,6,48,6,49,6,50,6,51,6,52,6,53,6,54,6,55,6,56,6,57,6,58,6,59,6,60,6,61,6,62,6,63,6,64,6,65,6,66,6,67,6,68,6,69,6,70,6,71,6,72,6,73,6,74,6,75,6,76,6,77,6,78,6,79,6,80,6,81,6,82,6,83,6,84,6,85,6,86,6,87,6,88,6,89,6,90,6,91,6,92,6,93,6,94,6,95,6,96,6,97,6,98,6,99,6,100,6,101,6,102,6,103,6,104,6,105,6,106,6,107,6,108,6,109,6];if(e<1||t.length/2<e||2*Object.keys(Ci.ByAtomicNumber).length!==t.length)throw new Error("atomT.length  should be equal Element.ByAtomicNumber.length * 2");return t[2*e]}},{key:"calculateGridCorners",value:function(e,t,r,n,i,o){for(var s=t*t,a=s*t,l=new me.Vector3,c=new me.Vector3,u=0;u<a;u++)e[u]=1e12;for(var h=(t-1)/(n.x-r.x),d=(t-1)/(n.y-r.y),f=(t-1)/(n.z-r.z),p=0,m=i.length;p<m;p++){var _=i[p],v=_.radius+o,g=(_.coord.x-v-r.x)*h,y=(_.coord.y-v-r.y)*d,x=(_.coord.z-v-r.z)*f,b=Math.floor(g),w=Math.floor(y),S=Math.floor(x),C=Math.floor((_.coord.x+v-r.x)*h),A=Math.floor((_.coord.y+v-r.y)*d),E=Math.floor((_.coord.z+v-r.z)*f);C=++C<=t-1?C:t-1,A=++A<=t-1?A:t-1,E=++E<=t-1?E:t-1;for(var k=w;k<=A;k++)for(var T=k*s,R=S;R<=E;R++)for(var M=R*t,P=b;P<=C;P++){var N=T+M+P;this.getCornerCoord(r,n,P,k,R,t,l),c.x=l.x-_.coord.x,c.y=l.y-_.coord.y,c.z=l.z-_.coord.z;var I=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z)-v;I<e[N]&&(e[N]=I)}}}},{key:"createVertexHash",value:function(e,t){if(this.hashLines=_e.allocateTyped(Int32Array,65536),null===this.hashLines)return-1;for(var r=0,n=0;r<32768;r++)this.hashLines[n++]=0,this.hashLines[n++]=-1;if(this.maxNumVertices=e,this.maxNumTriangles=t,this.numHashEtriesAllocated=e,this.hashEntries=_e.allocateTyped(Int32Array,2*this.numHashEtriesAllocated),null===this.hashEntries)return-1;for(var i=0,o=0;i<this.numHashEtriesAllocated;i++)this.hashEntries[o++]=-1,this.hashEntries[o++]=-1;return this.numHashEntryIndex=0}},{key:"getNewHashEntry",value:function(){if(this.numHashEntryIndex<this.numHashEtriesAllocated){var e=this.numHashEntryIndex;return this.numHashEntryIndex++,e}return-1}},{key:"addVertexToGeo",value:function(e,t){var r,n=this.marCubeResoultion<<2,i=new me.Vector3,o=Math.floor(n*(t.x-this.vBoxMin.x)/(this.vBoxMax.x+.01-this.vBoxMin.x)),s=Math.floor(n*(t.y-this.vBoxMin.y)/(this.vBoxMax.y+.01-this.vBoxMin.y)),a=815851*o+37633*Math.floor(n*(t.z-this.vBoxMin.z)/(this.vBoxMax.z+.01-this.vBoxMin.z))+2453543*s,l=(a&=32767)+a;if(null!==this.vBoxMin&&null!==this.vBoxMax)for(r=this.hashLines[1+l];0<=r;r=this.hashEntries[2*r+1]){var c=this.hashEntries[2*r+0];if(i.copy(e._vertices[c]),i.x-=t.x,i.y-=t.y,i.z-=t.z,i.x*i.x+i.y*i.y+i.z*i.z<1e-6)return c}if(e._numVertices>=this.maxNumVertices)return-1;var u=e._numVertices;if(e._vertices[u].copy(t),null!==this.vBoxMin&&null!==this.vBoxMax){if((r=this.getNewHashEntry())<0)return-1;var h=this.hashLines[1+l];this.hashLines[1+l]=r,this.hashEntries[2*r+0]=u,this.hashEntries[2*r+1]=h,this.hashLines[l]++}return e._numVertices++,u}},{key:"modifyExcludedFromGeo",value:function(e,t,r,n,i,o){var s,a,l;for(var c=e*e,u=(e-1)/(n.x-r.x),h=(e-1)/(n.y-r.y),d=(e-1)/(n.z-r.z),f=2*t*(2*t),p=1/(e-1),m=0;m<i._numVertices;m++){var _=i._vertices[m],v=1.1*t,g=Math.floor((_.x-v-r.x)*u),y=Math.floor((_.y-v-r.y)*h),x=Math.floor((_.z-v-r.z)*d),b=Math.floor((_.x+v-r.x)*u),w=Math.floor((_.y+v-r.y)*h),S=Math.floor((_.z+v-r.z)*d);g=0<=g?g:0,x=0<=x?x:0,b=b<=e-1?b:e-1,w=w<=e-1?w:e-1,S=S<=e-1?S:e-1;for(var C=y=0<=y?y:0;C<=w;C++)for(var A=C*c,E=x;E<=S;E++)for(var k=E*e,T=g;T<=b;T++){s=A+k+T;var R=T*p,M=r.x*(1-R)+n.x*R;R=C*p;var P=r.y*(1-R)+n.y*R;R=E*p;var N=r.z*(1-R)+n.z*R,I=M-_.x,L=P-_.y,O=N-_.z,V=I*I+L*L+O*O;V<f&&(a=Math.sqrt(V),0<(l=-(a-t))&&o[s]<0&&(o[s]=l),l>o[s]&&(o[s]=l))}}return 0}},{key:"_innerBuild",value:function(){var e,t={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};this.complex=this._opts.parent,this.atoms=t.atoms,this.meshResolution=this._opts.gridSpacing,this.atomRadiusScale=this._opts.radScale,this.colorMode=this._opts.colorMode,this.probeRadius=this._opts.probeRadius,this.useVertexColors=!0,this.excludeProbe=this._opts.excludeProbe,this.visibilitySelector=this._opts.visibilitySelector,this.geoOut=null,this.hashLines=null,this.hashEntries=null,this.numHashEtriesAllocated=0,this.numHashEntryIndex=0,this.maxNumVertices=0,this.maxNumTriangles=0;var r=new Array(this.atoms.length);this.convertToAtomsColored(t,r);var n=this.vBoxMin=new me.Vector3,i=this.vBoxMax=new me.Vector3;this.getBoundingBox(r,n,i);var o=this.marCubeResoultion=4*this.meshResolution,s=o,a=s*s*s,l=_e.allocateTyped(Float32Array,a),c=this.probeRadius*this.atomRadiusScale;this.calculateGridCorners(l,s,n,i,r,c);var u=o-1,h=new li;if((e=h.create(u))<0)return e;var d=new me.Vector3;d.x=(i.x-n.x)/u,d.y=(i.y-n.y)/u,d.z=(i.z-n.z)/u;var f=this.getNumIntersectedCells(s,u,l,h),p=Math.floor(1.2*f),m=Math.floor(1.2*f*2);if(this.geoOut=new Si(p,m,this.useVertexColors),(e=this.createVertexHash(p,m))<0)return e;var _=c;if(this.excludeProbe&&(_=.01),this.voxelWorld=new wi(r.length,r,n,i,_),this.voxelWorld.createVoxels(),e=this.buildGeoFromCorners(o,n,i,l,d,h),this.excludeProbe){if(this.modifyExcludedFromGeo(s,c,n,i,this.geoOut,l),this.geoOut._vertices=null,this.geoOut._colors=null,this.geoOut._indices=null,this.geoOut._normals=null,this.geoOut._numVertices=0,this.geoOut._numTriangles=0,this.geoOut=null,f=this.getNumIntersectedCells(s,u,l,h),p=Math.floor(1.2*f),m=Math.floor(1.2*f*2),this.geoOut=new Si(p,m,this.useVertexColors),(e=this.createVertexHash(p,m))<0)return e;e=this.buildGeoFromCorners(s,n,i,l,d,h)}this.voxelWorld.buildNormals(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._normals);var v=6.5;return this.excludeProbe&&(v-=1.5),this.useVertexColors&&this.voxelWorld.buildColors(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._colors,v),this.voxelWorld.destroyVoxels(),this.voxelWorld=null,h.destroy(),e}}]),e}(),LabelsGeometry:function(){function s(e,t){var r;W(this,s),(r=Y(this,X(s).call(this)))._opts=t,r.items=[],r.needsUpdate=!1;var n=-50,i=-50;switch(t.horizontalAlign){case"left":n=0;break;case"right":n=-100}switch(t.verticalAlign){case"top":i=-100;break;case"bottom":i=0}var o=new me.Vector3(t.dx||0,t.dy||0,t.dz||0);return r.userData={translation:"translate(".concat(n,"%, ").concat(i,"%)"),offset:o},r}return A(s,R),p(s,[{key:"setItem",value:function(e,t,r){var n=this._opts,i=this.items[e]||function(e,t){var r=document.createElement("div");if(r.className=t,"string"==typeof e){var n=document.createElement("span");n.style.fontSize="150%";for(var i=e.split("\n"),o=0,s=i.length;o<s;++o){var a=document.createElement("span"),l=document.createTextNode(i[o]);a.appendChild(l),n.appendChild(a),o<s-1&&n.appendChild(document.createElement("br"))}r.appendChild(n)}else r.appendChild(e);return r.worldPos=new me.Vector3,r}(r,"label");i.worldPos.copy(t),i.style.textAlign=n.horizontalAlign,i.style.verticalAlign=n.verticalAlign,this.items[e]=i}},{key:"setColor",value:function(e,t,r){this.items[e].opts={color:t,background:r}}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.needsUpdate=!0,this.dispatchEvent({type:"update"})}},{key:"finalize",value:function(){this.finishUpdate()}},{key:"raycast",value:function(){}},{key:"setOpacity",value:function(){}},{key:"getSubset",value:function(){return[]}}]),s}()};function Ei(e){return function(){function o(){var e,t;W(this,o);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=Y(this,(e=X(o)).call.apply(e,[this].concat(n)))).onBeforeRender=o.prototype.onBeforeRender,t}return A(o,e),p(o,[{key:"onBeforeRender",value:function(e,t,r,n,i,o){this._onBeforeRender(e,t,r,n,i,o),this._update()}},{key:"_onBeforeRender",value:function(){}},{key:"_update",value:function(){var e=this.material;e&&e instanceof jr&&e.updateUniforms()}}]),o}()}var ki=Ei(me.Mesh),Ti=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ki),p(e,[{key:"_onBeforeRender",value:function(e,t,r){ki.prototype._onBeforeRender.call(this,e,t,r);var n=this.material;n&&n.uniforms.invModelViewMatrix&&(this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),n.uniforms.invModelViewMatrix.value.getInverse(this.modelViewMatrix),n.uniformsNeedUpdate=!0)}}]),e}(),Ri=Ei(me.Mesh),Mi=function(){function c(e,t){var r;return W(this,c),(r=Y(this,X(c).call(this,e,t))).castShadow=!0,r.receiveShadow=!0,r}return A(c,Ri),p(c,[{key:"_onBeforeRender",value:function(e,t,r){Ri.prototype._onBeforeRender.call(this,e,t,r);var n=this.geometry,i=this.material;if(n.zClip&&i.uberOptions){var o=c._modelView,s=c._mvLength,a=c._center;o.multiplyMatrices(this.matrixWorld,r.matrixWorldInverse);var l=s.setFromMatrixColumn(o,0).length();a.copy(n.boundingSphere.center),this.localToWorld(a),i.uberOptions.zClipValue=r.position.z-a.z-l*(.5*n.boundingSphere.radius)}}}]),c}();Ce(Mi,"_mvLength",new me.Vector3),Ce(Mi,"_center",new me.Vector3),Ce(Mi,"_modelView",new me.Matrix4);var Pi=function(e){function i(e,t){var r;W(this,i),(r=Y(this,X(i).call(this))).geometry=e;var n=S(r);return n.initialized=!1,r.geometry.addEventListener("update",function(){n.update()}),r}return A(i,e),p(i,[{key:"init",value:function(){for(var e=this.children,t=e.length-1;0<=t;--t)this.remove(e[t]);for(var r=this.geometry,n=r.items,i=r.userData,o=0,s=n.length;o<s;++o){var a=n[o];if(a){var l=_e.shallowCloneNode(a),c=new Ar(l);c.userData=w.clone(i),c.getElement().style.visibility="visible",c.source=a,this.add(c)}}this.initialized=!0}},{key:"update",value:function(){if(this.geometry.needsUpdate){var e=this.children;this.initialized||this.init();for(var t=0,r=e.length;t<r;++t){var n=e[t],i=n.source;n.position.copy(i.worldPos),n.userData.color=i.opts.color,n.userData.background=i.opts.background}}}}]),i}(me.Group),Ni=Ei(me.Mesh);function Ii(e,t){Ni.call(this,e,t),this.castShadow=!0,this.receiveShadow=!0}(Ii.prototype=Object.create(Ni.prototype)).constructor=Ii;var Li=Ei(me.Mesh),Oi=new me.Vector2,Vi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Li),p(e,[{key:"_onBeforeRender",value:function(e,t,r){var n=this.material;n.uberOptions&&(n.uberOptions.projMatrixInv.getInverse(r.projectionMatrix,!0),e.getSize(Oi),n.uberOptions.viewport.set(Oi.width,Oi.height))}}]),e}(),Di=Ei(me.Mesh),zi=function(){function o(){var e,t;W(this,o);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=Y(this,(e=X(o)).call.apply(e,[this].concat(n)))).castShadow=!0,t.receiveShadow=!0,t}return A(o,Di),o}(),Fi={ZClipped:Mi,ZSprite:Ti,Text:Pi,Line:Ei(me.Line),LineSegments:Ei(me.LineSegments),Mesh:Ii,ThickLineMesh:Vi,Instanced:zi};function Bi(t,r){return function(e){e.setValues(t),e.setUberOptions(r)}}function Ui(r,n){return{Geometry:function(e,t){return new Ai.Instanced2CCylindersGeometry(e,t,r,n)},Object:r?Fi.ZSprite:Fi.Instanced,initMaterial:Bi({instancedMatrix:!0,attrColor:!0,attrColor2:!0,attrAlphaColor:!0,cylinderSprite:r})}}function Gi(e,t){var r=e.prototype instanceof Xn,n=t.lineWidth||0;return{Geometry:e,Object:r?Fi.ThickLineMesh:Fi.LineSegments,initMaterial:Bi({lights:!1,attrColor:!0,attrAlphaColor:!0,thickLine:r},{lineWidth:n})}}function ji(e,t,r,n){var i={wireframe:!!n.wireframe,fakeOpacity:r.now.isoSurfaceFakeOpacity,zClip:n.zClip};return{Geometry:e,Object:Fi.ZClipped,initMaterial:Bi({attrColor:!0,attrAlphaColor:!1,wireframe:i.wireframe,fakeOpacity:i.fakeOpacity,zClip:i.zClip})}}var Hi=function(){function e(){W(this,e)}return p(e,null,[{key:"createSpheres",value:function(e,t){var r=t.now.zSprites;return{Geometry:function(e,t){return new Ai.InstancedSpheresGeometry(e,t,r)},Object:r?Fi.ZSprite:Fi.Instanced,initMaterial:Bi({instancedPos:!0,attrColor:!0,attrAlphaColor:!0,sphereSprite:r})}}},{key:"create2CClosedCylinders",value:function(){return Ui(!1,!1)}},{key:"create2CCylinders",value:function(e,t){return Ui(t.now.zSprites,!0)}},{key:"create2CLines",value:function(e,t,r){return Gi(Ai.TwoColorLinesGeometry,r)}},{key:"createCrosses",value:function(e,t,r){return Gi(Ai.CrossGeometry,r)}},{key:"createExtrudedChains",value:function(){return{Geometry:Ai.ExtrudedObjectsGeometry,Object:Fi.Mesh,initMaterial:Bi({attrColor:!0,attrAlphaColor:!0})}}},{key:"createChunkedLines",value:function(e,t,r){return Gi(Ai.ChunkedLinesGeometry,r)}},{key:"createQuickSurface",value:function(e,t,r){return ji(Ai.QuickSurfGeometry,0,t,r)}},{key:"createContactSurface",value:function(e,t,r){return ji(Ai.ContactSurfaceGeometry,0,t,r)}},{key:"createSASSES",value:function(e,t,r){return ji(Ai.SSIsosurfaceGeometry,0,t,r)}},{key:"createLabels",value:function(){return{Geometry:Ai.LabelsGeometry,Object:Fi.Text,initMaterial:function(){}}}}]),e}(),Wi=function(e){function f(e,t,r,n){var i;W(this,f),(i=Y(this,X(f).call(this)))._geometry=e,i._geoParams=t;var o=r.createInstance();t.initMaterial(o),i._material=o,i._transforms=0<n.length?n:[new me.Matrix4];for(var s=i._createMeshes(e),a=0,l=s.length;a<l;++a)i.add(s[a]);return i}return A(f,e),p(f,[{key:"raycast",value:function(e,t){var r=f._ray,n=f._inverseMatrix,i=this.children;r.copy(e.ray);for(var o=0,s=i.length;o<s;++o){var a=i[o];if(tn.belongToSelectLayers(a)){a.updateMatrixWorld();var l=a.matrixWorld;n.getInverse(l),e.ray.copy(r).applyMatrix4(n);var c=[];this._geometry.raycast(e,c);for(var u=0,h=c.length;u<h;++u){var d=c[u];d.point&&(d.point.applyMatrix4(l),d.distance=r.origin.distanceTo(d.point)),d.object=a,t[t.length]=d}}}e.ray.copy(r)}},{key:"getSubset",value:function(e){for(var t=this._geometry.getSubset(e),r=[],n=0,i=0,o=t.length;i<o;++i)for(var s=this._createMeshes(t[i]),a=0,l=s.length;a<l;++a)r[n++]=s[a];return r}},{key:"_createMeshes",value:function(e){for(var t=this._transforms,r=this._geoParams.Object,n=this._material,i=[],o=0,s=t.length;o<s;++o){var a=new r(e,n);a.applyMatrix(t[o]),i[o]=a}return i}}]),f}(me.Object3D);Ce(Wi,"_inverseMatrix",new me.Matrix4),Ce(Wi,"_ray",new me.Ray);var Yi=function(){function h(e,t,r,n,i,o,s){var a,l,c,u;if(W(this,h),(a=Y(this,X(h).call(this))).constructor===h)throw new Error("Can not instantiate abstract class!");return a._selection=t,a._mode=n,a._colorer=r,a._chunksIdc=t.chunks,a._polyComplexity=o,a._geo=(l=e.Geometry,c=a._makeGeoArgs(),u=[l].concat(c),new(l.bind.apply(l,ln(u)))),a._mesh=new Wi(a._geo,e,s,i),a.add(a._mesh),a._build(),a}return A(h,Er),p(h,[{key:"_makeGeoArgs",value:function(){throw new Error("ChemGroup subclass must override _makeGeoArgs() method")}},{key:"getSubset",value:function(e,t){t=void 0!==t&&t;var r=this._calcChunksList(e,t);return 0===r.length?[]:this._mesh.getSubset(r)}},{key:"_changeSubsetOpacity",value:function(e,t,r){var n=this._calcChunksList(e,r);0!==n.length&&this._geo.setOpacity(n,t)}},{key:"enableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,1,t)}},{key:"disableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,0,t)}}]),h}(),Xi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Yi),p(e,[{key:"raycast",value:function(e,t){var r=this._selection.atoms,n=[];this._mesh.raycast(e,n);for(var i=this._chunksIdc,o=0,s=n.length;o<s;++o)if(n[o].hasOwnProperty("chunkIdx")){var a=i[n[o].chunkIdx];a<r.length&&(n[o].atom=r[a],t.push(n[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],r=this._selection.atoms,n=this._chunksIdc,i=0,o=n.length;i<o;++i){0!=(r[n[i]].mask&e)&&t.push(i)}return t}}]),e}(),qi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Xi),p(e,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,r=t.atoms,n=t.parent,i=this._mode,o=this._colorer,s=this._geo,a=0,l=e.length;a<l;++a){var c=r[e[a]];s.setItem(a,c.position,i.calcAtomRadius(c)),s.setColor(a,o.getAtomColor(c,n))}s.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,r=this._selection.atoms,n=this._mode,i=this._colorer,o=e.needsColorUpdate(i),s=this._geo,a=0,l=t.length;a<l;++a){var c=r[t[a]];s.setItem(a,e.getAtomPos(t[a]),n.calcAtomRadius(c)),o&&s.setColor(a,e.getAtomColor(i,c))}s.finalize()}}]),e}(),$i=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,qi),p(e,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,r=t.atoms,n=t.chunks,i=n.length,o=0;o<i;++o)e[o]=r[n[o]];var s=this._mode.getSurfaceOpts();return s.atoms=e,[i,s]}}]),e}(),Zi=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,qi),p(e,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,r=t.atoms,n=t.chunks,i=n.length,o=0;o<i;++o)e[o]=r[n[o]];var s=this._mode.getSurfaceOpts();return s.atoms=e,s.selection=this._selection,s.colorMode=this._colorer,[i,s]}}]),e}();function Ki(e){return null!==e.name.getNode()?e.name.getNode():e.getVisualName()}var Qi={none:function(e){return e},adjust:function(e){var t=e>>16&255,r=e>>8&255,n=255&e;return n=127<.2126*t+.7152*r+.0722*n?(t=3*t/10,r=3*r/10,3*n/10):(t=255-3*(255-t)/10,r=255-3*(255-r)/10,255-3*(255-n)/10),t<<16|r<<8|n},inverse:function(e){return 255-(e>>16&255)<<16|255-(e>>8&255)<<8|255-(255&e)}};function Ji(e,t){var r;if(Qi.hasOwnProperty(t))r=_e.hexColor(Qi[t](e));else{var n=parseInt(t,16);r=!Number.isNaN(n)&&t.toLowerCase().startsWith("0x")?_e.hexColor(n):"#000000"}return r}function eo(r,e){return e.replace(/\{\{(\s*\w+\s*)\}\}/g,function(e){var t=e.replace(/\s+/g,"");return t=t.substring(2,t.length-2).toLowerCase(),to.hasOwnProperty(t)?to[t](r):"null"})}var to={serial:function(e){return e.serial},name:function(e){return e.getVisualName()},elem:function(e){return e.element.name},residue:function(e){return e.residue.getType().getName()},sequence:function(e){return e.residue.getSequence()},chain:function(e){return e.residue.getChain().getName()},hetatm:function(e){return e.isHet()},water:function(e){return"HOH"===e.residue.getType().getName()||"WAT"===e.residue.getType().getName()}},ro=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Xi),p(e,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getLabelOpts();return[this._selection.chunks.length,e]}},{key:"_build",value:function(){for(var e=this._mode.getLabelOpts(),t=this._selection.chunks,r=this._selection,n=r.atoms,i=r.parent,o=this._colorer,s=this._geo,a=0,l=t.length;a<l;++a){var c=n[t[a]],u=e.template?eo(c,e.template):Ki(c);if(u){var h=o.getAtomColor(c,i),d=parseInt(Ji(h,e.fg).substring(1),16),f=e.showBg?parseInt(Ji(h,e.bg).substring(1),16):"transparent";s.setItem(a,c.position,u),s.setColor(a,d,f)}}s.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._mode.getLabelOpts(),r=this._selection.chunks,n=this._selection.atoms,i=this._colorer,o=this._geo,s=e.needsColorUpdate(i),a=0,l=r.length;a<l;++a){var c=n[r[a]],u=t.template?eo(c,t.template):Ki(c);if(u){var h=e.getAtomColor(i,c),d=parseInt(Ji(h,t.fg).substring(1),16),f=t.showBg?parseInt(Ji(h,t.bg).substring(1),16):"transparent";o.setItem(a,e.getAtomPos(r[a]),u),s&&o.setColor(a,d,f)}}o.finalize()}}]),e}();function no(e,t,r,n){var i=Math.sin(e);return t.clone().multiplyScalar(Math.sin((1-n)*e)/i).addScaledVector(r,Math.sin(n*e)/i)}var io=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Xi),p(e,[{key:"_buildInner",value:function(e,t){for(var r=this._selection.chunks,n=new me.Vector3,i=new me.Vector3,o=this._segmentsHeight,s=1/o,a=this._colorer,l=this._selection,c=l.cycles,u=l.parent,h=0,d=r[h],f=0,p=c.length;f<p;++f){var m=c[f],_=m.atoms,v=[],g=[],y=m.center,x=m.radius-e,b=_.length,w=0,S=_[b-1].position,C=_[w].position;n.subVectors(S,y),i.subVectors(C,y);for(var A=i.clone().cross(n).normalize();w<b;++w){var E=n.angleTo(i);g[w]=no(E,n,i,.5).normalize(),C=_[(w+1)%b].position,n.copy(i),i.subVectors(C,y)}for(w=0;w<b;++w)if(_[w].index===d){for(var k=g[w],T=g[(w+1)%b],R=a.getAtomColor(_[w],u),M=k.angleTo(T),P=0;P<=o;++P)v[P]=no(M,k,T,P*s).multiplyScalar(x).add(y);t(h++,R,v,y,A),d=r[h]}}}}]),e}();var oo=tn.calcChunkMatrix,so=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,io),p(e,[{key:"_build",value:function(){var l=this._segmentsHeight,e=this._mode.getAromRadius(),c=new me.Vector2(e,e),t=this._mode.calcStickRadius()+2*e,u=new me.Vector3,h=[],d=this._geo;this._buildInner(t,function(e,t,r,n,i){for(var o=0;o<=l;++o){var s=r[o],a=s.clone().sub(n).cross(i);u.addVectors(s,a),h[o]=oo(s,u,i,c)}d.setItem(e,h),d.setColor(e,t)}),d.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._polyComplexity,[function(e,t){for(var r=[],n=0;n<t;++n){var i=-2*n/t*Math.PI;r.push(new me.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return r}(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length]}}]),e}(),ao=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,io),p(e,[{key:"_build",value:function(){var s=this,a=this._geo,e=this._mode.getAromaticOffset();this._buildInner(e,function(e,t,r){for(var n=r[0],i=1;i<=s._segmentsHeight;++i){var o=r[i];a.setSegment(e,i-1,n,o),n=o}a.setColor(e,t)}),a.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._mode.getAromaticArcChunks(),[this._selection.chunks.length,this._segmentsHeight,!0]}}]),e}(),lo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Yi),p(e,[{key:"raycast",value:function(e,t){var r=this._selection.residues,n=[];this._mesh.raycast(e,n);for(var i=this._chunksIdc,o=0,s=n.length;o<s;++o)if(n[o].hasOwnProperty("chunkIdx")){var a=i[n[o].chunkIdx];a<r.length&&(n[o].residue=r[a],t.push(n[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],r=this._selection.residues,n=this._chunksIdc,i=0,o=n.length;i<o;++i){0!=(r[n[i]]._mask&e)&&t.push(i)}return t}}]),e}(),co=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,lo),p(e,[{key:"raycast",value:function(e,t){var r=this._selection.residues,n=[];this._mesh.raycast(e,n);for(var i=this._chunksIdc,o=0,s=n.length;o<s;++o)if(n[o].hasOwnProperty("chunkIdx")){var a=i[Math.floor(n[o].chunkIdx/2)];a<r.length&&(n[o].residue=r[a],t.push(n[o]))}}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,r=e.parent,n=this._colorer,i=this._geo,o=this._mode.calcStickRadius(),s=0,a=this._selection.chunks,l=0,c=a.length;l<c;++l){var u=t[a[l]],h=n.getResidueColor(u,r);this._processItem(s++,u._cylinders[0],u._cylinders[1],o,h)}i.finalize()}},{key:"_calcChunksList",value:function(e){for(var t=[],r=0,n=this._selection.residues,i=this._chunksIdc,o=0,s=i.length;o<s;++o){0!=(n[i[o]]._mask&e)&&(t[r++]=2*o,t[r++]=2*o+1)}return t}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),r=this._selection.parent,n=this._colorer,i=this._geo,o=this._mode.calcStickRadius(),s=0,a=this._selection.chunks,l=0,c=a.length;l<c;++l){var u=t[a[l]],h=n.getResidueColor(u,r);this._processItem(s++,u._cylinders[0],u._cylinders[1],o,h)}i.finishUpdate()}}]),e}(),uo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,co),p(e,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,r,n,i){var o=this._geo;o.setItem(e,t,r,n),o.setColor(e,i,i)}}]),e}(),ho=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,co),p(e,[{key:"_makeGeoArgs",value:function(){return[2*this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,r,n,i){var o=this._geo,s=2*e;o.setItem(s,t,n),o.setColor(s,i),s++,o.setItem(s,r,n),o.setColor(s,i)}}]),e}(),fo=g(function(e,I){
/*
  Smooth.js version 0.1.7

  Turn arrays into smooth functions.

  Copyright 2012 Spencer Cohen
  Licensed under MIT license (see "Smooth.js MIT license.txt")
  */
(function(){function e(e,t){for(var r in t)k.call(t,r)&&(e[r]=t[r]);function n(){this.constructor=e}return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e}var t,n,r,p,m,i,_,v,o,s,a,g,y,x,l,c,b,w,u,S,C,h,d,f,A,E,k=Object.prototype.hasOwnProperty;function T(e,t){if(this.array=e.slice(0),this.length=this.array.length,!(this.clipHelper={clamp:this.clipHelperClamp,zero:this.clipHelperZero,periodic:this.clipHelperPeriodic,mirror:this.clipHelperMirror}[t.clip]))throw"Invalid clip: "+t.clip}function R(){R.__super__.constructor.apply(this,arguments)}function M(){M.__super__.constructor.apply(this,arguments)}function P(e,t){this.tangentFactor=1-Math.max(-1,Math.min(1,t.cubicTension)),P.__super__.constructor.apply(this,arguments)}function N(e,t){if(N.__super__.constructor.apply(this,arguments),this.a=t.sincFilterSize,!t.sincWindow)throw"No sincWindow provided";this.kernel=u(t.sincWindow)}for(c in g={method:(r={METHOD_NEAREST:"nearest",METHOD_LINEAR:"linear",METHOD_CUBIC:"cubic",METHOD_LANCZOS:"lanczos",METHOD_SINC:"sinc",CLIP_CLAMP:"clamp",CLIP_ZERO:"zero",CLIP_PERIODIC:"periodic",CLIP_MIRROR:"mirror",CUBIC_TENSION_DEFAULT:0,CUBIC_TENSION_CATMULL_ROM:0}).METHOD_CUBIC,cubicTension:r.CUBIC_TENSION_DEFAULT,clip:r.CLIP_CLAMP,scaleTo:0,sincFilterSize:2,sincWindow:void 0},o=function(e,t){return Math.max(0,Math.min(e,t-1))},a=function(e,t){return(e%=t)<0&&(e+=t),e},s=function(e,t){var r;return t-1<(e=a(e,r=2*(t-1)))&&(e=r-e),e},T.prototype.getClippedInput=function(e){return 0<=e&&e<this.length?this.array[e]:this.clipHelper(e)},T.prototype.clipHelperClamp=function(e){return this.array[o(e,this.length)]},T.prototype.clipHelperZero=function(e){return 0},T.prototype.clipHelperPeriodic=function(e){return this.array[a(e,this.length)]},T.prototype.clipHelperMirror=function(e){return this.array[s(e,this.length)]},T.prototype.interpolate=function(e){throw"Subclasses of AbstractInterpolator must override the interpolate() method."},e(R,t=T),R.prototype.interpolate=function(e){return this.getClippedInput(Math.round(e))},m=R,e(M,t),M.prototype.interpolate=function(e){var t;return(1-(e-=t=Math.floor(e)))*this.getClippedInput(t)+e*this.getClippedInput(t+1)},p=M,e(P,t),P.prototype.getTangent=function(e){return this.tangentFactor*(this.getClippedInput(e+1)-this.getClippedInput(e-1))/2},P.prototype.interpolate=function(e){var t,r,n,i,o;return t=Math.floor(e),r=[this.getTangent(t),this.getTangent(t+1)],(2*(o=(e-=t)*(i=e*e))-3*i+1)*(n=[this.getClippedInput(t),this.getClippedInput(t+1)])[0]+(o-2*i+e)*r[0]+(-2*o+3*i)*n[1]+(o-i)*r[1]},n=P,h=Math.sin,i=Math.PI,d=function(e){return 0===e?1:h(i*e)/(i*e)},b=function(t){return function(e){return d(e/t)}},u=function(t){return function(e){return d(e)*t(e)}},e(N,t),N.prototype.interpolate=function(e){var t,r,n,i,o;for(n=0,r=i=(t=Math.floor(e))-this.a+1,o=t+this.a;i<=o?r<=o:o<=r;i<=o?r++:r--)n+=this.kernel(e-r)*this.getClippedInput(r);return n},_=N,y=function(e,t){var r,n,i,o;for(o=[],n=0,i=e.length;n<i;n++)r=e[n],o.push(r[t]);return o},w=function(t,e,r){var n,i;return"0,1"===r.join?t:(n=e/(r[1]-r[0]),i=r[0],function(e){return t(n*(e-i))})},x=function(e){return Object.prototype.toString.call(e).slice("[object ".length,-1)},A=function(e){if(isNaN(e))throw"NaN in Smooth() input";if("Number"!==x(e))throw"Non-number in Smooth() input";if(!isFinite(e))throw"Infinity in Smooth() input"},E=function(e,t){var r,n,i;if("Array"!==x(e))throw"Non-vector in Smooth() input";if(e.length!==t)throw"Inconsistent dimension in Smooth() input";for(n=0,i=e.length;n<i;n++)r=e[n],A(r)},l=function(e){return"Number"===x(e)&&isFinite(e)&&!isNaN(e)},S=function(e){var t;switch(t="scaleTo param must be number or array of two numbers",x(e)){case"Number":if(!l(e))throw t;e=[0,e];break;case"Array":if(2!==e.length)throw t;if(!l(e[0])||!l(e[1]))throw t;break;default:throw t}return e},C=function(e){var t,r,n;for(r in t={},e)k.call(e,r)&&(n=e[r],t[r]=n);return t},v=function(i,o){var e,s,a,l,c,u,t,h,d,r,f;for(t in null==o&&(o={}),d={},o=C(o),d.config=C(o),null==o.scaleTo&&(o.scaleTo=o.period),null==o.sincFilterSize&&(o.sincFilterSize=o.lanczosFilterSize),g)k.call(g,t)&&(f=g[t],null==o[t]&&(o[t]=f));if(!(c={nearest:m,linear:p,cubic:n,lanczos:_,sinc:_}[o.method]))throw"Invalid method: "+o.method;if("lanczos"===o.method&&(o.sincWindow=b(o.sincFilterSize)),i.length<2)throw"Array must have at least two elements";for(t in d.count=i.length,r=function(){var e,t,r,n;switch(x(i[0])){case"Number":if(d.dimension="scalar",v.deepValidation)for(e=0,r=i.length;e<r;e++)h=i[e],A(h);return l=new c(i,o),function(e){return l.interpolate(e)};case"Array":if(d.dimension=s=i[0].length,!s)throw"Vectors must be non-empty";if(v.deepValidation)for(t=0,n=i.length;t<n;t++)f=i[t],E(f,s);return u=function(){var e;for(e=[],a=0;0<=s?a<s:s<a;0<=s?a++:a--)e.push(new c(y(i,a),o));return e}(),function(e){var t,r,n,i;for(i=[],r=0,n=u.length;r<n;r++)t=u[r],i.push(t.interpolate(e));return i};default:throw"Invalid element type: "+x(i[0])}}(),e="periodic"===o.clip?i.length:i.length-1,o.scaleTo||(o.scaleTo=e),d.domain=S(o.scaleTo),r=w(r,e,d.domain),d.domain.sort(),d)k.call(d,t)&&(f=d[t],r[t]=f);return r},r)k.call(r,c)&&(f=r[c],v[c]=f);v.deepValidation=!0,(null!==I?I:window).Smooth=v}).call(v)}).Smooth,po=Cr.ResidueType,mo=tn.calcChunkMatrix;function _o(o,e){var s=fo(o,{method:fo.METHOD_CUBIC,clip:fo.CLIP_CLAMP,cubicTension:e,scaleTo:1});return function(e,t){var r=t;null===r&&(r=function(e){return(e*(o.length-1-2)+1)/(o.length-1)});var n=r(e),i=s(n);return new me.Vector3(i[0],i[1],i[2])}}function vo(e,t,r,n){if(!n._isValid)return e[r]=e[r-1],void(t[r]=t[r-1]);var i=n._controlPoint;e[r]=[i.x,i.y,i.z];var o=i.clone().add(n._wingVector);t[r]=[o.x,o.y,o.z]}function go(i,e,t,r){var n=r.start,o=r.end;function s(e){return n<e&&i[e-1]._isValid?e-1:e}function a(e){return e<o&&i[e+1]._isValid?e+1:e}var l=[],c=[],u=0;function h(e,t){var r=i[e]._controlPoint.clone().lerp(i[t]._controlPoint,-.25),n=r.clone().add(i[e]._wingVector);c[u]=[r.x,r.y,r.z],l[u++]=[n.x,n.y,n.z],c[u]=[r.x,r.y,r.z],l[u++]=[n.x,n.y,n.z]}var d=s(e),f=a(t);if(d===f)return function(e,t,r,n){var i,o,s=0!=(n._type.flags&po.Flags.NUCLEIC),a=s?"C5'":"N",l=s?"C3'":"C";if(n.forEachAtom(function(e){var t=e.getVisualName();i||t!==a?o||t!==l||(o=e.position):i=e.position}),i&&o||(i=n._firstAtom.position,o=n._lastAtom.position),i&&o){var c=o.clone().sub(i),u=n._wingVector,h=n._controlPoint,d=h.clone().add(u),f=h.clone().sub(c),p=f.clone().add(u);e[r]=[f.x,f.y,f.z],t[r]=[p.x,p.y,p.z],e[++r]=[f.x,f.y,f.z],t[r]=[p.x,p.y,p.z],e[++r]=[h.x,h.y,h.z],t[r]=[d.x,d.y,d.z],++r;var m=h.clone().add(c),_=m.clone().add(u);e[r]=[m.x,m.y,m.z],t[r]=[_.x,_.y,_.z],e[++r]=[m.x,m.y,m.z],t[r]=[_.x,_.y,_.z]}}(c,l,u,i[e]),{centerPoints:c,topPoints:l};e===d?h(e,a(e)):(vo(c,l,u++,i[s(d)]),vo(c,l,u++,i[d]));for(var p=e;p<=t;++p)vo(c,l,u++,i[p]);return f===a(f)?h(t,s(t)):(vo(c,l,u++,i[f]),vo(c,l,u,i[a(f)])),{centerPoints:c,topPoints:l}}var yo=function(){function a(e,t,r,n,i,o){W(this,a);var s=go(e,t,r,o);this._topInterp=_o(s.topPoints,i),this._centerInterp=_o(s.centerPoints,i),this._shift=.5/(r-t+2),this._valueStep=(1-2*this._shift)/(2*(r-t+1)*(n-1)),this._segmentsCount=n}return p(a,[{key:"prepareMatrices",value:function(e,t,r){for(var n=this._segmentsCount,i=new Array(n),o=new me.Vector2(0,0),s=this._topInterp,a=this._centerInterp,l=this._shift+this._valueStep*(n-1)*e,c=0;c<n;++c){var u=Math.min(1,c/(n-1));o.lerpVectors(t,r,u);var h=s(l,null),d=a(l,null),f=a(l+=this._valueStep,null);i[c]=mo(d.clone(),f.clone(),h.clone().sub(d),o)}return i}}]),a}();function xo(e,t,r,n,i,o){for(var s=0,a=e.length;s<a;++s)for(var l=e[s].arr,c=e[s].boundaries,u=0,h=l.length;u<h;++u)for(var d=[l[u].start,l[u].end],f=new yo(t,d[0],d[1],r,n,c),p=null,m=2*l[u].start,_=2*l[u].end+1,v=i.getResidueRadius(t[0],0),g=m;g<=_;++g){var y=t[g/2|0],x=i.getResidueRadius(y,g%2),b=i.getResidueRadius(y,1+g%2),w=f.prepareMatrices(g-2*d[0],x,b);w.unshift(null===p?w[0]:p),o(y,w,x.x!==b.x||x.y!==b.y,x.x!==v.x||x.y!==v.y),p=w[r],v=b}}var bo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,lo),p(e,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getHeightSegmentsRatio();return this._segmentsHeight=this._polyComplexity*e|0,[function(e,t){for(var r=[],n=0;n<t;++n){var i=Math.PI/2-2*Math.PI*n/t;r.push(new me.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return r}(1,this._polyComplexity),this._segmentsHeight+1,2*this._selection.chunks.length]}},{key:"_build",value:function(){var e=this._selection,t=e.residues,o=e.parent,r=this._mode,s=this._colorer,n=r.getTension(),a=this._geo,l=0,c=[];xo(this._selection.subdivs,t,this._segmentsHeight,n,r,function(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=s.getResidueColor(e,o);c[l]=e._index,a.setItem(l,t,r,n),a.setColor(l++,i)}),this._chunksIdc=c,a.finalize()}},{key:"updateToFrame",value:function(e){var r=this._selection.parent,t=this._mode,n=this._colorer,i=t.getTension(),o=this._geo,s=e.getResidues(),a=0,l=e.needsColorUpdate(n);xo(this._selection.subdivs,s,this._segmentsHeight,i,t,function(e,t){o.setItem(a,t),l&&o.setColor(a,n.getResidueColor(e,r)),a++}),o.finalize()}}]),e}(),wo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Yi),p(e,[{key:"_makeGeoArgs",value:function(){for(var e=this._selection.subdivs,t=0,r=0,n=e.length;r<n;++r)for(var i=e[r].arr,o=0,s=i.length;o<s;++o)t+=i[o].end-i[o].start;return[t,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,r=e.parent,n=this._mode,i=this._colorer,o=this._geo,s=0,a=[],l=this._selection.subdivs,c=n.calcStickRadius(),u=0,h=l.length;u<h;++u)for(var d=l[u].arr,f=0,p=d.length;f<p;++f)for(var m=d[f].start,_=d[f].end,v=t[m],g=m+1;g<=_;++g){var y=t[g];a[s]={first:v._index,second:y._index},o.setItem(s,v._controlPoint,y._controlPoint,c),o.setColor(s,i.getResidueColor(v,r),i.getResidueColor(y,r)),s++,v=y}this._chunksIdc=a,o.finalize()}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),r=this._selection.parent,n=this._mode,i=this._colorer,o=this._geo,s=0,a=this._selection.subdivs,l=n.calcStickRadius(),c=e.needsColorUpdate(i),u=0,h=a.length;u<h;++u)for(var d=a[u].arr,f=0,p=d.length;f<p;++f)for(var m=d[f].start,_=d[f].end,v=t[m],g=m+1;g<=_;++g){var y=t[g];o.setItem(s,v._controlPoint,y._controlPoint,l),c&&o.setColor(s,i.getResidueColor(v,r),i.getResidueColor(y,r)),s++,v=y}o.finalize()}},{key:"raycast",value:function(e,t){var r=[],n=this._selection.residues;this._mesh.raycast(e,r);for(var i=this._chunksIdc,o=0,s=r.length;o<s;++o)if(r[o].hasOwnProperty("chunkIdx")){var a=r[o].chunkIdx,l=i[Math.floor(a/2)],c=a%2==0?l.first:l.second;c<n.length&&(r[o].residue=n[c],t.push(r[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],r=this._chunksIdc,n=this._selection.residues,i=0,o=r.length;i<o;++i){var s=r[i];n[s.first]._mask&e&&t.push(2*i),n[s.second]._mask&e&&t.push(2*i+1)}return t}}]),e}();var So=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Yi),p(e,[{key:"_makeGeoArgs",value:function(){for(var e=this._mode.drawMultiorderBonds(),t=this._mode.showAromaticLoops(),r=this._selection.chunks,n=this._selection.bonds,i=0,o=0,s=r.length;o<s;++o)i+=this.getBondOrder(n[r[o]],e,t);return[i,this._polyComplexity]}},{key:"getBondOrder",value:function(e,t,r){var n,i=1;return!t||r&&e._type===Re.BondType.AROMATIC||(i=(n=e._order)<2?1:n),i}},{key:"raycast",value:function(e,t){var r=this._selection.bonds,n=[];this._mesh.raycast(e,n);for(var i=this._chunksIdc,o=0,s=n.length;o<s;++o)if(n[o].hasOwnProperty("chunkIdx")){var a=n[o].chunkIdx,l=i[Math.floor(a/2)];if(l<r.length){var c=r[l];n[o].atom=a%2==0?c._left:c._right,t.push(n[o])}}}},{key:"_calcChunksList",value:function(e,t){for(var r=[],n=this._selection.bonds,i=this._chunksIdc,o=0,s=i.length;o<s;++o){var a=n[i[o]];a._left.mask&e&&(!t||a._right.mask&e)&&r.push(2*o),a._right.mask&e&&(!t||a._left.mask&e)&&r.push(2*o+1)}return r}}]),e}(),Co={AtomsSphereGroup:qi,AtomsSurfaceGroup:$i,AtomsSASSESGroupStub:Zi,AtomsTextGroup:ro,AromaticTorusGroup:so,AromaticLinesGroup:ao,NucleicCylindersGroup:uo,NucleicSpheresGroup:ho,ResiduesSubseqGroup:bo,ResiduesTraceGroup:wo,BondsCylinderGroup:function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,So),p(e,[{key:"_build",value:function(){for(var e,t=this._selection.chunks,r=this._selection,n=r.bonds,i=r.parent,o=this._mode,s=this._colorer,a=this._geo,l=o.drawMultiorderBonds(),c=o.showAromaticLoops(),u=o.calcStickRadius(),h=o.calcSpaceFraction(),d=new me.Vector3,f=new me.Vector3,p=0,m=[],_=0,v=t.length;_<v;++_){var g=n[t[_]],y=g._left,x=g._right,b=y.position,w=x.position;e=g.calcNormalDir();for(var S=this.getBondOrder(g,l,c),C=2*Math.min(o.calcAtomRadius(y),o.calcAtomRadius(x))/S,A=l?Math.min(u,.5*C*(1-h)):u,E=0;E<S;++E){var k=C*(S%2==0?(.5+(E/2|0))*(1-E%2*2):((E+1)/2|0)*(E%2*2-1));m[p]=g._index,d.copy(b),d.addScaledVector(e,k),f.copy(w),f.addScaledVector(e,k),a.setItem(p,d,f,A),a.setColor(p++,s.getAtomColor(y,i),s.getAtomColor(x,i))}}a.finalize(),this._chunksIdc=m}},{key:"updateToFrame",value:function(e){for(var t,r=this._selection.chunks,n=this._selection.bonds,i=this._mode,o=this._colorer,s=this._geo,a=i.drawMultiorderBonds(),l=i.showAromaticLoops(),c=i.calcStickRadius(),u=i.calcSpaceFraction(),h=new me.Vector3,d=new me.Vector3,f=0,p=e.needsColorUpdate(o),m=0,_=r.length;m<_;++m){var v=n[r[m]],g=v._left,y=v._right,x=e.getAtomPos(g.index).clone(),b=e.getAtomPos(y.index);t=v.calcNormalDir();for(var w=this.getBondOrder(v,a,l),S=2*Math.min(i.calcAtomRadius(g),i.calcAtomRadius(y))/w,C=a?Math.min(c,.5*S*(1-u)):c,A=0;A<w;++A){var E=S*(w%2==0?(.5+(A/2|0))*(1-A%2*2):((A+1)/2|0)*(A%2*2-1));h.copy(x),h.addScaledVector(t,E),d.copy(b),d.addScaledVector(t,E),s.setItem(f,h,d,C),p&&s.setColor(f,e.getAtomColor(o,g),e.getAtomColor(o,y)),f++}}s.finalize()}}]),e}(),BondsLinesGroup:function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,So),p(e,[{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,r=t.bonds,n=t.parent,i=this._mode,o=this._colorer,s=this._geo,a=i.drawMultiorderBonds(),l=i.showAromaticLoops(),c=new me.Vector3,u=new me.Vector3,h=new me.Vector3,d=0,f=[],p=0,m=e.length;p<m;++p){var _=r[e[p]],v=_._left,g=_._right,y=v.position,x=g.position,b=1===v.bonds.length,w=1===g.bonds.length;c.subVectors(x,y);for(var S=c.length(),C=_.calcNormalDir(),A=this.getBondOrder(_,a,l),E=0;E<A;++E){u.copy(y),h.copy(x);var k=A%2==0?(.5+(E/2|0))*(1-E%2*2):((E+1)/2|0)*(E%2*2-1);f[d]=_._index,2!==A||b||w||(k-=.5,k*=-1),!b&&!w&&1<A&&0!==k&&(u.lerpVectors(y,x,.15/S),h.lerpVectors(y,x,1-.15/S)),k*=.15,u.addScaledVector(C,k),h.addScaledVector(C,k),s.setItem(d,u,h),s.setColor(d++,o.getAtomColor(v,n),o.getAtomColor(g,n))}}s.finalize(),this._chunksIdc=f}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,r=this._selection.bonds,n=this._mode,i=this._colorer,o=this._geo,s=n.drawMultiorderBonds(),a=n.showAromaticLoops(),l=new me.Vector3,c=new me.Vector3,u=new me.Vector3,h=0,d=e.needsColorUpdate(i),f=0,p=t.length;f<p;++f){var m=r[t[f]],_=m._left,v=m._right,g=e.getAtomPos(_.index).clone(),y=e.getAtomPos(v.index),x=1===_.bonds.length,b=1===v.bonds.length;l.subVectors(y,g);for(var w=l.length(),S=m.calcNormalDir(),C=this.getBondOrder(m,s,a),A=0;A<C;++A){c.copy(g),u.copy(y);var E=C%2==0?(.5+(A/2|0))*(1-A%2*2):((A+1)/2|0)*(A%2*2-1);2!==C||x||b||(E-=.5,E*=-1),!x&&!b&&1<C&&0!==E&&(c.lerpVectors(g,y,.15/w),u.lerpVectors(g,y,1-.15/w)),E*=.15,c.addScaledVector(S,E),u.addScaledVector(S,E),o.setItem(h,c,u),d&&o.setColor(h,e.getAtomColor(i,_),e.getAtomColor(i,v)),h++}}o.finalize()}}]),e}()},Ao=function(){function t(i,o,s,a,l,c,u,h){var e;W(this,t),e=Y(this,X(t).call(this));var d=S(e);e._complex=s,e._mode=l;var f=s.getAtoms(),p=s.getTransforms();return s.forEachComponent(function(e){var t=[],r=0;if(e.forEachAtom(function(e){d._checkAtom(e,u)&&(t[r++]=e.index)}),0!==r){var n=new i(o,{atoms:f,chunks:t,parent:s},a,l,p,c,h);n._component=e,d.add(n)}}),e}return A(t,Er),p(t,[{key:"_checkAtom",value:function(e,t){return e.mask&t}},{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=0,s=n.length;o<s;++o)if(n[o].getSubset)for(var a=n[o].getSubset(e,t),l=0,c=a.length;l<c;++l){var u=a[l];u._component=n[o]._component,r[i++]=u}return r}}]),t}(),Eo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Ao),p(e,[{key:"_checkAtom",value:function(e,t){if(!(e.mask&t))return!1;for(var r=e.bonds,n=0,i=r.length;n<i;++n)if(r[n]._left.mask&t&&r[n]._right.mask&t)return!1;return!0}}]),e}(),ko=function(){function t(i,o,s,a,l,c,u,h){var e;W(this,t),e=Y(this,X(t).call(this));var d=S(e),f=(e._complex=s).getResidues(),p=s.getTransforms();return s.forEachComponent(function(e){var t=0,r=[];if(e.forEachResidue(function(e){d._checkResidue(e,u)&&(r[t++]=e._index)}),0!==t){var n=new i(o,{residues:f,chunks:r,parent:s},a,l,p,c,h);n._component=e,d.add(n)}}),e}return A(t,Er),p(t,[{key:"checkResidue",value:function(e,t){return e._mask&t}},{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=0,s=n.length;o<s;++o)if(n[o].getSubset)for(var a=n[o].getSubset(e,t),l=0,c=a.length;l<c;++l){var u=a[l];u._component=n[o]._component,r[i++]=u}return r}}]),t}(),To={Atoms:Ao,OrphanAtoms:Eo,Residues:ko,Nucleic:function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ko),p(e,[{key:"_checkResidue",value:function(e,t){return t&e._mask&&null!==e._cylinders}}]),e}(),Subseqs:function(){function t(d,f,p,m,_,v,g,y){var e;W(this,t),e=Y(this,X(t).call(this));var x=S(e),b=(e._complex=p).getResidues(),w=p.getTransforms();return p.forEachComponent(function(e){for(var t=e.getMaskedSubdivSequences(g),r=0,n=[],i=0,o=t.length;i<o;++i)for(var s=t[i].arr,a=0,l=s.length;a<l;++a)for(var c=s[a].start,u=s[a].end;c<=u;++c)n[r++]=b[c]._index;if(0!==r){var h=new d(f,{residues:b,chunks:n,subdivs:t,parent:p},m,_,w,v,y);h._component=e,x.add(h)}}),e}return A(t,Er),p(t,[{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=0,s=n.length;o<s;++o)if(n[o].getSubset)for(var a=n[o].getSubset(e,t),l=0,c=a.length;l<c;++l){var u=a[l];u._component=n[o]._component,r[i++]=u}return r}}]),t}(),Bonds:function(){function t(r,o,s,a,l,c,u,h){var e;W(this,t),e=Y(this,X(t).call(this));var d=S(e),f=(e._complex=s).getBonds(),p=s.getTransforms();return s.forEachComponent(function(e){var n=[],i=0;if(e.forEachBond(function(e){var t=e._left,r=e._right;t.mask&u&&r.mask&u&&(n[i++]=e._index)}),0!==i){var t=new r(o,{bonds:f,chunks:n,parent:s},a,l,p,c,h);t._component=e,d.add(t)}}),e}return A(t,Er),p(t,[{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=0,s=n.length;o<s;++o)if(n[o].getSubset)for(var a=n[o].getSubset(e,t),l=0,c=a.length;l<c;++l){var u=a[l];u._component=n[o]._component,r[i++]=u}return r}}]),t}(),Aromatic:function(){function t(r,n,i,c,u,h,d,f){var e;W(this,t),e=Y(this,X(t).call(this));var p=S(e),m=(e._complex=i).getAtoms(),_=i.getTransforms();return u.showAromaticLoops()?(i.forEachComponent(function(e){var o=[],s=0,a=[],l=0;e.forEachCycle(function(e){for(var t=e.atoms,r=0,n=0,i=t.length;n<i;++n)0!=(t[n].mask&d)&&(++r,o[s++]=t[n].index);0<r&&(a[l++]=e)});var t=new r(n,{cycles:a,atoms:m,chunks:o,parent:i},c,u,_,h,f);t._component=e,p.add(t)}),e):Y(e)}return A(t,Er),p(t,[{key:"getSubset",value:function(e,t){for(var r=[],n=this.children,i=0,o=0,s=n.length;o<s;++o)if(n[o].getSubset)for(var a=n[o].getSubset(e,t),l=0,c=a.length;l<c;++l){var u=a[l];u._component=n[o]._component,r[i++]=u}return r}}]),t}()};function Ro(s,a,l){return function(e,t,r,n,i,o){return new a(l,s,e,t,r,n,i,o)}}var Mo=function(){function e(){W(this,e)}return p(e,null,[{key:"AtomsSpheres",value:function(e,t){return Ro(Hi.createSpheres(e,t),To.Atoms,Co.AtomsSphereGroup)}},{key:"OrphanedAtomsCrosses",value:function(e,t,r){return Ro(Hi.createCrosses(e,t,r),To.OrphanAtoms,Co.AtomsSphereGroup)}},{key:"BondsCylinders",value:function(e,t){return Ro(Hi.create2CCylinders(e,t),To.Bonds,Co.BondsCylinderGroup)}},{key:"BondsLines",value:function(e,t,r){return Ro(Hi.create2CLines(e,t,r),To.Bonds,Co.BondsLinesGroup)}},{key:"CartoonChains",value:function(e,t){return Ro(Hi.createExtrudedChains(e,t),To.Subseqs,Co.ResiduesSubseqGroup)}},{key:"TraceChains",value:function(e,t){return Ro(Hi.create2CClosedCylinders(e,t),To.Subseqs,Co.ResiduesTraceGroup)}},{key:"NucleicSpheres",value:function(e,t){return Ro(Hi.createSpheres(e,t),To.Nucleic,Co.NucleicSpheresGroup)}},{key:"NucleicCylinders",value:function(e,t){return Ro(Hi.create2CCylinders(e,t),To.Nucleic,Co.NucleicCylindersGroup)}},{key:"ALoopsTorus",value:function(e,t){return Ro(Hi.createExtrudedChains(e,t),To.Aromatic,Co.AromaticTorusGroup)}},{key:"ALoopsLines",value:function(e,t,r){return Ro(Hi.createChunkedLines(e,t,r),To.Aromatic,Co.AromaticLinesGroup)}},{key:"QuickSurfGeo",value:function(e,t,r){return Ro(Hi.createQuickSurface(e,t,r),To.Atoms,Co.AtomsSurfaceGroup)}},{key:"ContactSurfaceGeo",value:function(e,t,r){return Ro(Hi.createContactSurface(e,t,r),To.Atoms,Co.AtomsSurfaceGroup)}},{key:"SASSESSurfaceGeo",value:function(e,t,r){return Ro(Hi.createSASSES(e,t,r),To.Atoms,Co.AtomsSASSESGroupStub)}},{key:"TextLabelsGeo",value:function(e,t){return Ro(Hi.createLabels(e,t),To.Atoms,Co.AtomsTextGroup)}}]),e}(),Po=function(){function t(e){if(W(this,t),this.constructor===t)throw new Error("Can not instantiate abstract class!");this.opts=w.merge(_e.deriveDeep(this.settings.now.modes[this.id],!0),e)}return p(t,[{key:"identify",value:function(){var e=_e.objectsDiff(this.opts,this.settings.now.modes[this.id]);return w.isEmpty(e)?this.id:[this.id,e]}},{key:"buildGeometry",value:function(e,t,r,n){for(var i=this.opts.polyComplexity?this.opts.polyComplexity[this.settings.now.resolution]:0,o=this.depGroups,s=o.length,a=new tn.RCGroup,l=0;l<s;++l){var c=o[l],u={};if(w.isArray(c))u=c[1].call(this),c=y(c,1)[0];var h=new(Mo[c](null,this.settings,u))(e,t,this,i,r,n);0<h.children.length&&a.add(h)}return a}}]),t}();function No(){return{lineWidth:this.opts.lineWidth}}hn(Po.prototype),Po.prototype.id="__",Po.prototype.depGroups=[];var Io=function(){function o(e){var t;W(this,o),(t=Y(this,X(o).call(this,e))).depGroups=t.depGroups.slice(0);for(var r=t.depGroups,n=0,i=r.length;n<i;++n)r[n]=[r[n],No];return t}return A(o,Po),p(o,[{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}},{key:"calcAtomRadius",value:function(){return this.opts.atom}},{key:"getAromaticOffset",value:function(){return this.opts.offsarom}},{key:"getAromaticArcChunks",value:function(){return this.opts.chunkarom}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}}]),o}();Ce(Io,"id","LN"),Io.prototype.id="LN",Io.prototype.name="Lines",Io.prototype.shortName="Lines",Io.prototype.depGroups=["ALoopsLines","BondsLines","OrphanedAtomsCrosses"];var Lo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"calcAtomRadius",value:function(){return this.opts.bond}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),e}();Ce(Lo,"id","LC"),Lo.prototype.id="LC",Lo.prototype.name="Licorice",Lo.prototype.shortName="Licorice",Lo.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var Oo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"calcAtomRadius",value:function(e){return e.element.radius*this.opts.atom}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),e}();Ce(Oo,"id","BS"),Oo.prototype.id="BS",Oo.prototype.name="Balls and Sticks",Oo.prototype.shortName="Balls",Oo.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var Vo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"calcAtomRadius",value:function(e){return e.element.radius}}]),e}();Ce(Vo,"id","VW"),Vo.prototype.id="VW",Vo.prototype.name="Van der Waals",Vo.prototype.shortName="VDW",Vo.prototype.depGroups=["AtomsSpheres"];var Do=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"calcStickRadius",value:function(){return this.opts.radius}}]),e}();Ce(Do,"id","TR"),Do.prototype.id="TR",Do.prototype.name="Trace",Do.prototype.shortName="Trace",Do.prototype.depGroups=["TraceChains"];var zo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"getResidueRadius",value:function(){return this.TUBE_RADIUS}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,r,n){var i=this.opts.radius;return this.TUBE_RADIUS=new me.Vector2(i,i),Po.prototype.buildGeometry.call(this,e,t,r,n)}}]),e}();Ce(zo,"id","TU"),zo.prototype.id="TU",zo.prototype.name="Tube",zo.prototype.shortName="Tube",zo.prototype.depGroups=["CartoonChains"];var Fo=function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this,e))).secCache={},t}return A(r,Po),p(r,[{key:"getResidueStartRadius",value:function(e){var t=e.getSecondary();if(!t||!t.generic)return this.TUBE_RADIUS;var r=this.secCache[t.generic];return r?t.term===e?r.start:r.center:this.TUBE_RADIUS}},{key:"getResidueEndRadius",value:function(e){var t=e.getSecondary();if(null===t||!t.generic)return this.TUBE_RADIUS;var r=this.secCache[t.generic];return r?t.term===e?this.ARROW_END:r.center:this.TUBE_RADIUS}},{key:"getResidueRadius",value:function(e,t){var r=this.getResidueStartRadius(e);if(0===t)return r;var n=this.getResidueEndRadius(e);return 2===t?n:r.clone().lerp(n,t/2)}},{key:"calcStickRadius",value:function(){return this.opts.radius}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,r,n){var i=this.opts.radius,o=this.opts.depth;this.TUBE_RADIUS=new me.Vector2(i,i),this.ARROW_END=new me.Vector2(o,i);var s={},a=this.opts.ss;for(var l in a)s[l]={center:new me.Vector2(o,a[l].width),start:new me.Vector2(o,a[l].arrow)};return this.secCache=s,Po.prototype.buildGeometry.call(this,e,t,r,n)}}]),r}();Ce(Fo,"id","CA"),Fo.prototype.id="CA",Fo.prototype.name="Cartoon",Fo.prototype.shortName="Cartoon",Fo.prototype.depGroups=["CartoonChains","NucleicSpheres","NucleicCylinders"];var Bo=Cr.selectors;function Uo(){return{wireframe:this.opts.wireframe,zClip:this.opts.zClip}}var Go=function(){function s(e){var t;W(this,s),(t=Y(this,X(s).call(this,e))).depGroups=t.depGroups.slice(0);for(var r=t.surfaceNames,n=t.depGroups,i=0,o=r.length;i<o;++i)n[n.length]=[r[i],Uo];return t}return A(s,Po),p(s,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getVisibilitySelector",value:function(){var e=null;if(""!==this.opts.subset){var t=Bo.parse(this.opts.subset);t.error||(e=t.selector)}return e}}]),s}();Go.prototype.isSurface=!0,Go.prototype.surfaceNames=[];var jo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Go),p(e,[{key:"getSurfaceOpts",value:function(){return{useBeads:!1,isoValue:this.opts.isoValue,gaussLim:this.opts.gaussLim[this.settings.now.resolution],radScale:this.opts.scale,gridSpacing:this.opts.gridSpacing[this.settings.now.resolution],zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),e}();Ce(jo,"id","QS"),jo.prototype.id="QS",jo.prototype.name="Quick Surface",jo.prototype.shortName="Quick Surf",jo.prototype.surfaceNames=["QuickSurfGeo"];var Ho=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,t)))._excludeProbe=e,r}return A(n,Go),p(n,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getSurfaceOpts",value:function(){return{gridSpacing:this.opts.polyComplexity[this.settings.now.resolution],radScale:this._radScale,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector(),probeRadius:this.opts.probeRadius,excludeProbe:this._excludeProbe}}}]),n}();Ho.prototype.id="SU",Ho.prototype.name="Surface",Ho.prototype.shortName="Surface",Ho.prototype.surfaceNames=["SASSESSurfaceGeo"],Ho.prototype._radScale=1,Ho.prototype._excludeProbe=!1;var Wo=function(){function t(e){return W(this,t),Y(this,X(t).call(this,!1,e))}return A(t,Ho),t}();Ce(Wo,"id","SA"),Wo.prototype.id="SA",Wo.prototype.name="Solvent Accessible Surface",Wo.prototype.shortName="SAS";var Yo=function(){function t(e){return W(this,t),Y(this,X(t).call(this,!0,e))}return A(t,Ho),t}();Ce(Yo,"id","SE"),Yo.prototype.id="SE",Yo.prototype.name="Solvent Excluded Surface",Yo.prototype.shortName="SES";var Xo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Go),p(e,[{key:"getSurfaceOpts",value:function(){return{probeRadius:this.opts.probeRadius,radScale:this.opts.polyComplexity[this.settings.now.resolution],scaleFactor:this.opts.polyComplexity[this.settings.now.resolution],gridSpacing:1/this.opts.polyComplexity[this.settings.now.resolution],isoValue:this.opts.isoValue,probePositions:this.opts.probePositions,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),e}();Ce(Xo,"id","CS"),Xo.prototype.id="CS",Xo.prototype.name="Contact Surface",Xo.prototype.shortName="Contact Surf",Xo.prototype.isSurface=!0,Xo.prototype.surfaceNames=["ContactSurfaceGeo"];var qo=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Po),p(e,[{key:"getTemplateOptions",value:function(){return this.opts.template}},{key:"getLabelOpts",value:function(){return w.merge(this.opts,{colors:!0,adjustColor:!0,transparent:!0})}}]),e}();Ce(qo,"id","TX"),qo.prototype.id="TX",qo.prototype.name="Text mode",qo.prototype.shortName="Text",qo.prototype.depGroups=["TextLabelsGeo"];var $o=new un([Io,Lo,Oo,Vo,Do,zo,Fo,jo,Wo,Yo,Xo,qo]);function Zo(e,t,r){return e<=r?e<0?0:e:r}var Ko=function(){function r(e,t){W(this,r),this.name=e||"Custom",this.id=t||"CP"}return p(r,[{key:"getElementColor",value:function(e,t){var r=1<arguments.length&&void 0!==t&&t,n=this.elementColors[e];return void 0!==n||r?n:this.defaultElementColor}},{key:"getResidueColor",value:function(e,t){var r=1<arguments.length&&void 0!==t&&t,n=this.residueColors[e];return void 0!==n||r?n:this.defaultResidueColor}},{key:"getChainColor",value:function(e){var t=e.charCodeAt(0);return t=(31&(t<0?0:256<=t?t-256:t))%this.chainColors.length,this.chainColors[t]}},{key:"getSecondaryColor",value:function(e,t){var r=1<arguments.length&&void 0!==t&&t,n=this.secondaryColors[e];return void 0!==n||r?n:this.defaultSecondaryColor}},{key:"getSequentialColor",value:function(e){var t=this.colors,r=t.length;return e<0?t[e%r+r]:t[e%r]}},{key:"getGradientColor",value:function(e,t){var r=this.gradients[t];if(!r)return this.defaultNamedColor;var n,i,o,s,a=r.length,l=e*(a-1),c=Math.floor(l),u=Zo(c+1,0,a-1);return c=Zo(c,0,a-1),n=r[c],i=r[u],(s=1-(o=l-c))*(n>>16&255)+o*(i>>16&255)<<16|s*(n>>8&255)+o*(i>>8&255)<<8|s*(255&n)+o*(255&i)}},{key:"getNamedColor",value:function(e,t){var r=1<arguments.length&&void 0!==t&&t,n=this.namedColors[e];return void 0!==n||r?n:this.defaultNamedColor}}]),r}();w.assign(Ko.prototype,{colors:[16777215,16711680,65280,255,8421504],minRangeColor:0,midRangeColor:8355711,maxRangeColor:16777215,defaultElementColor:16777215,elementColors:{},defaultResidueColor:16777215,residueColors:{},chainColors:[16777215],defaultSecondaryColor:16777215,secondaryColors:{},defaultGradientColor:0,defaultNamedColor:16777215,namedColorsArray:[["indianred",13458524],["lightcoral",15761536],["salmon",16416882],["darksalmon",15308410],["lightsalmon",16752762],["crimson",14423100],["red",16711680],["firebrick",11674146],["darkred",9109504],["pink",16761035],["lightpink",16758465],["hotpink",16738740],["deeppink",16716947],["mediumvioletred",13047173],["palevioletred",14381203],["coral",16744272],["tomato",16737095],["orangered",16729344],["darkorange",16747520],["orange",16753920],["gold",16766720],["yellow",16776960],["lightyellow",16777184],["lemonchiffon",16775885],["lightgoldenrodyellow",16448210],["papayawhip",16773077],["moccasin",16770229],["peachpuff",16767673],["palegoldenrod",15657130],["khaki",15787660],["darkkhaki",12433259],["lavender",15132410],["thistle",14204888],["plum",14524637],["violet",15631086],["orchid",14315734],["fuchsia",16711935],["magenta",16711935],["mediumorchid",12211667],["mediumpurple",9662683],["rebeccapurple",6697881],["blueviolet",9055202],["darkviolet",9699539],["darkorchid",10040012],["darkmagenta",9109643],["purple",8388736],["indigo",4915330],["slateblue",6970061],["mediumslateblue",8087790],["darkslateblue",4734347],["greenyellow",11403055],["chartreuse",8388352],["lawngreen",8190976],["lime",65280],["limegreen",3329330],["palegreen",10025880],["lightgreen",9498256],["mediumspringgreen",64154],["springgreen",65407],["mediumseagreen",3978097],["seagreen",3050327],["forestgreen",2263842],["green",32768],["darkgreen",25600],["yellowgreen",10145074],["olivedrab",7048739],["olive",8421376],["darkolivegreen",5597999],["mediumaquamarine",6737322],["darkseagreen",9419919],["lightseagreen",2142890],["darkcyan",35723],["teal",32896],["aqua",65535],["cyan",65535],["lightcyan",14745599],["paleturquoise",11529966],["aquamarine",8388564],["turquoise",4251856],["mediumturquoise",4772300],["darkturquoise",52945],["cadetblue",6266528],["steelblue",4620980],["lightsteelblue",11584734],["powderblue",11591910],["lightblue",11393254],["skyblue",8900331],["lightskyblue",8900346],["deepskyblue",49151],["dodgerblue",2003199],["cornflowerblue",6591981],["royalblue",4286945],["blue",255],["mediumblue",205],["darkblue",139],["navy",128],["midnightblue",1644912],["cornsilk",16775388],["blanchedalmond",16772045],["bisque",16770244],["navajowhite",16768685],["wheat",16113331],["burlywood",14596231],["tan",13808780],["rosybrown",12357519],["sandybrown",16032864],["goldenrod",14329120],["darkgoldenrod",12092939],["peru",13468991],["chocolate",13789470],["saddlebrown",9127187],["sienna",10506797],["brown",10824234],["maroon",8388608],["white",16777215],["snow",16775930],["honeydew",15794160],["mintcream",16121850],["azure",15794175],["aliceblue",15792383],["ghostwhite",16316671],["whitesmoke",16119285],["seashell",16774638],["beige",16119260],["oldlace",16643558],["floralwhite",16775920],["ivory",16777200],["antiquewhite",16444375],["linen",16445670],["lavenderblush",16773365],["mistyrose",16770273],["gainsboro",14474460],["lightgray",13882323],["silver",12632256],["darkgray",11119017],["gray",8421504],["dimgray",6908265],["lightslategray",7833753],["slategray",7372944],["darkslategray",3100495],["black",0]],namedColors:{},gradients:{rainbow:[255,65535,65280,16776960,16711680],temp:[255,32767,16777215,16744192,16711680],hot:[16777215,16744192,16711680],cold:[16777215,32767,255],"blue-red":[255,16777215,16711680],reds:[16777215,16711680],blues:[16777215,255]}});for(var Qo=Ko.prototype,Jo=Qo.namedColorsArray,es=Qo.namedColors,ts=0,rs=Jo.length;ts<rs;++ts){var ns=y(Jo[ts],2),is=ns[0],os=ns[1];es[is]=os}var ss,as=new Ko("CPK","CP");as.elementColors={H:16777215,C:2105376,N:2121983,O:15605776,F:65280,P:8397055,S:16776960,CL:47872,FE:13684944,CO:13684944,NI:13684944,CU:13684944,BR:34816,I:21760};var ls=new Ko("Jmol","JM");ls.colors=[255,22015,44031,65535,65451,65365,65280,5635840,11271936,16776960,16755456,16733440,16711680,16711765,16711851,16711935,11206911,5570815],ls.elementColors={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:4366e3,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998},ls.defaultResidueColor=12492910,ls.residueColors={ALA:13158600,ARG:1334015,ASN:56540,ASP:15075850,CYS:15132160,GLN:56540,GLU:15075850,GLY:15461355,HIS:8553170,ILE:1016335,LEU:1016335,LYS:1334015,MET:15132160,PHE:3289770,PRO:14456450,SER:16422400,THR:16422400,TRP:11819700,TYR:3289770,VAL:1016335,A:10526975,C:16747595,G:16740464,I:8454143,T:10551200,U:16744576,DA:10526975,DC:16747595,DG:16740464,DI:8454143,DT:10551200,DU:16744576,"+A":10526975,"+C":16747595,"+G":16740464,"+I":8454143,"+T":10551200,"+U":16744576},ls.chainColors=[4294967295,4290826495,4289789872,4294951112,4294967168,4294951167,4289786096,4294955120,4293951616,4294303411,4278239231,4291648604,4284927402,4288335154,4293821166,4278243025,4278255487,4282168177,4278190219,4290623339,4278215680,4286578688,4286611456,4286578816,4278222976,4290283019,4289864226];var cs,us=He.Type;ls.secondaryColors=(Ce(ss={},us.HELIX_ALPHA,16711808),Ce(ss,us.HELIX_PI,6291584),Ce(ss,us.HELIX_310,10485888),Ce(ss,us.STRAND,16762880),Ce(ss,us.TURN,6324479),Ce(ss,"dna",11403518),Ce(ss,"rna",16580962),ss);var hs=new Ko("VMD","VM");hs.colors=[255,16711680,6316128,16744448,16776960,8421427,10066329,65280,16777215,16751001,4243648,10879142,8447590,15099571,8408320,8421568],hs.defaultElementColor=8408320,hs.elementColors={H:16777215,C:4243391,N:255,O:16711680,P:8421427,S:16776960},hs.defaultResidueColor=4243648,hs.residueColors={ALA:255,ARG:16777215,ASN:8421427,ASP:16711680,CYS:16776960,GLN:16744448,GLU:16751001,GLY:16777215,HIS:4243648,ILE:65280,LEU:16751001,LYS:4243648,MET:16776960,PHE:10879142,PRO:8408064,SER:16776960,THR:15099571,TRP:10066329,TYR:65280,VAL:8421427,A:255,C:16744448,G:16776960,T:10879142,U:65280,DA:255,DC:16744448,DG:16776960,DT:10879142,DU:65280,"+A":255,"+C":16744448,"+G":16776960,"+T":10879142,"+U":65280,WAT:4243648,H2O:4243648,HOH:4243648},hs.chainColors=[16777215].concat(hs.colors);var ds=He.Type;hs.secondaryColors=(Ce(cs={},ds.HELIX_ALPHA,10879142),Ce(cs,ds.HELIX_310,255),Ce(cs,ds.HELIX_PI,16711680),Ce(cs,ds.STRAND,16776960),Ce(cs,ds.BRIDGE,8421427),Ce(cs,ds.TURN,4243648),cs);var fs=new un([as,ls,hs]),ps=function(){function t(e){if(W(this,t),this.constructor===t)throw new Error("Can not instantiate abstract class!");this.opts=w.merge(_e.deriveDeep(Q.now.colorers[this.id],!0),e),this.palette=fs.first}return p(t,[{key:"identify",value:function(){var e=_e.objectsDiff(this.opts,Q.now.colorers[this.id]);return w.isEmpty(e)?this.id:[this.id,e]}}]),t}();ps.prototype.id="__";var ms=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e){var t=e.element.name;return"C"===t&&0<=this.opts.carbon?this.opts.carbon:this.palette.getElementColor(t)}},{key:"getResidueColor",value:function(){return this.palette.defaultResidueColor}}]),e}();Ce(ms,"id","EL"),ms.prototype.id="EL",ms.prototype.name="Element",ms.prototype.shortName="Element";var _s=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){return this.palette.getResidueColor(e._type._name)}}]),e}();Ce(_s,"id","RT"),_s.prototype.id="RT",_s.prototype.name="Residue Type",_s.prototype.shortName="Residue";var vs=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){var t=e._chain;if(t.minSequence===Number.POSITIVE_INFINITY&&t.maxSequence===Number.NEGATIVE_INFINITY)return this.palette.defaultNamedColor;var r=t.minSequence,n=t.maxSequence>r?t.maxSequence:r+1;return this.palette.getGradientColor((e._sequence-r)/(n-r),this.opts.gradient)}}]),e}();Ce(vs,"id","SQ"),vs.prototype.id="SQ",vs.prototype.name="Sequence",vs.prototype.shortName="Sequence";var gs=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){return this.palette.getChainColor(e.getChain()._name)}}]),e}();Ce(gs,"id","CH"),gs.prototype.id="CH",gs.prototype.name="Chain",gs.prototype.shortName="Chain";var ys=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){if(e._type.flags&Ve.Flags.DNA)return this.palette.getSecondaryColor("dna");if(e._type.flags&Ve.Flags.RNA)return this.palette.getSecondaryColor("rna");var t=e.getSecondary();if(t){var r=this.palette.getSecondaryColor(t.type,!0);return void 0===r&&(r=this.palette.getSecondaryColor(t.generic)),r}return this.palette.defaultSecondaryColor}}]),e}();Ce(ys,"id","SS"),ys.prototype.id="SS",ys.prototype.name="Secondary Structure",ys.prototype.shortName="Structure";var xs=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(){return this.opts.color}},{key:"getResidueColor",value:function(){return this.opts.color}}]),e}();Ce(xs,"id","UN"),xs.prototype.id="UN",xs.prototype.name="Uniform",xs.prototype.shortName="Uniform";var bs=function(){function n(e){var t;W(this,n),t=Y(this,X(n).call(this,e));var r=Ft.parse(t.opts.subset);return t._subsetCached=r.error?Ft.none():r.selector,t}return A(n,ps),p(n,[{key:"getAtomColor",value:function(e){return this._subsetCached.includesAtom(e)?this.opts.color:this.opts.baseColor}},{key:"getResidueColor",value:function(e){for(var t=this._subsetCached,r=!0,n=e._atoms,i=0,o=n.length;i<o;++i)r=r&&t.includesAtom(n[i]);return r?this.opts.color:this.opts.baseColor}}]),n}();Ce(bs,"id","CO"),bs.prototype.id="CO",bs.prototype.name="Conditional",bs.prototype.shortName="Conditional";var ws=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e){return this.palette.getChainColor(String.fromCharCode(e.location))}},{key:"getResidueColor",value:function(){return this.palette.defaultResidueColor}}]),e}();Ce(ws,"id","CF"),ws.prototype.id="CF",ws.prototype.name="Conformation",ws.prototype.shortName="Conformation";var Ss=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e){var t=this.opts,r=1;return e.temperature&&t?(r=t.min===t.max?e.temperature>t.max?1:0:(e.temperature-t.min)/(t.max-t.min),this.palette.getGradientColor(r,t.gradient)):this.palette.defaultGradientColor}},{key:"getResidueColor",value:function(e){var t=this.opts;if(!t)return this.palette.defaultGradientColor;if(e.temperature){var r=0;return r=t.min===t.max?e.temperature>t.max?1:0:(e.temperature-t.min)/(t.max-t.min),this.palette.getGradientColor(r,t.gradient)}return this.palette.defaultGradientColor}}]),e}();Ce(Ss,"id","TM"),Ss.prototype.id="TM",Ss.prototype.name="Temperature",Ss.prototype.shortName="Temperature";var Cs=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e){var t=this.opts;if(e.occupancy&&t){var r=1-e.occupancy;return this.palette.getGradientColor(r,t.gradient)}return this.palette.defaultGradientColor}},{key:"getResidueColor",value:function(e){var t=this.opts;if(!t)return this.palette.defaultGradientColor;if(0<e.occupancy){var r=1-e.occupancy;return this.palette.getGradientColor(r,t.gradient)}return this.palette.defaultGradientColor}}]),e}();Ce(Cs,"id","OC"),Cs.prototype.id="OC",Cs.prototype.name="Occupancy",Cs.prototype.shortName="Occupancy";var As=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){var t=this.palette.defaultResidueColor;if(e._type.hydrophobicity){t=this.palette.getGradientColor((e._type.hydrophobicity- -4.5)/9,this.opts.gradient)}return t}}]),e}();Ce(As,"id","HY"),As.prototype.id="HY",As.prototype.name="Hydrophobicity",As.prototype.shortName="Hydrophobicity";var Es=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){var r=e._molecule,n=t.getMoleculeCount();return 1<n?this.palette.getGradientColor((r.index-1)/(n-1),this.opts.gradient):this.palette.getGradientColor(0,this.opts.gradient)}}]),e}();Ce(Es,"id","MO"),Es.prototype.id="MO",Es.prototype.name="Molecule",Es.prototype.shortName="Molecule";var ks=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,ps),p(e,[{key:"getAtomColor",value:function(e){var t,r,n=this.opts.color,i=(t=n,(r=this.opts.factor)*(t>>16&255)<<16|r*(t>>8&255)<<8|r*(255&t));return e.flags&Ae.Flags.CARBON?n:i}},{key:"getResidueColor",value:function(){return this.opts.color}}]),e}();Ce(ks,"id","CB"),ks.prototype.id="CB",ks.prototype.name="Carbon",ks.prototype.shortName="Carbon";var Ts=new un([ms,_s,vs,gs,ys,xs,bs,ws,Ss,Cs,As,Es,ks]);function Rs(e){return new me.Color(e,e,e)}var Ms=new un([{id:"DF",name:"Diffuse",shortName:"Diffuse",uberOptions:{diffuse:Rs(1),specular:Rs(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"SF",name:"Soft Plastic",shortName:"Soft",uberOptions:{diffuse:Rs(1),specular:Rs(.1),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"PL",name:"Glossy Plastic",shortName:"Glossy",uberOptions:{diffuse:Rs(.56),specular:Rs(.28),shininess:100,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"ME",name:"Metal",shortName:"Metal",uberOptions:{diffuse:Rs(.56),specular:Rs(.55),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"TR",name:"Transparent",shortName:"Transparent",uberOptions:{diffuse:Rs(1),specular:Rs(0),shininess:1,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"GL",name:"Glass",shortName:"Glass",uberOptions:{diffuse:Rs(.5),specular:Rs(.65),shininess:100,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"BA",name:"Backdrop",shortName:"Backdrop",uberOptions:{diffuse:Rs(1),specular:Rs(0),shininess:1,opacity:1},values:{lights:!1,fog:!1,depthWrite:!1,transparent:!1,toonShading:!1}},{id:"TN",name:"Toon",shortName:"Toon",uberOptions:{diffuse:Rs(1),specular:Rs(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!0}},{id:"FL",name:"Flat",shortName:"Flat",uberOptions:{diffuse:Rs(1),specular:Rs(0),shininess:0,opacity:1},values:{lights:!1,fog:!0,depthWrite:!0,transparent:!1}}]),Ps=Cr.selectors,Ns=function(){function o(e,t,r,n){W(this,o);var i={clipPlane:Q.now.draft.clipPlane,fogTransparent:Q.now.bg.transparent,shadowmap:Q.now.shadow.on,shadowmapType:Q.now.shadow.type};this.index=e,this.mode=t,this.colorer=r,this.selector=n,this.selectorString="",this.count=0,this.material=new jr,this.material.setValues(i),this.material.setUberOptions({fogAlpha:Q.now.fogAlpha}),this.materialPreset=Ms.first,this.needsRebuild=!0,this.visible=!0,this.setMode(t)}return p(o,[{key:"markAtoms",value:function(e){return this.count=e.markAtoms(this.selector,1<<this.index),this.needsRebuild=!0,this.count}},{key:"unmarkAtoms",value:function(e){e.clearAtomBits(1<<this.index),this.count=0}},{key:"setMode",value:function(e){this.mode=e}},{key:"setMaterialPreset",value:function(e){this.materialPreset=e,this.material.setUberOptions(e.uberOptions),this.material.setValues(e.values)}},{key:"reset",value:function(){this.geo=null,this.selectionGeo=null}},{key:"buildGeometry",value:function(e){return this.reset(),this.needsRebuild=!1,Q.now.ao&&this.material.setValues({normalsToGBuffer:Q.now.ao}),this.geo=this.mode.buildGeometry(e,this.colorer,1<<this.index,this.material),this.material.uberOptions.opacity<.99&&"prepass"===Q.now.transparency&&tn.processTransparentMaterial(this.geo,this.material),this.geo.visible=this.visible,tn.processObjRenderOrder(this.geo,this.materialPreset.id),tn.processColFromPosMaterial(this.geo,this.material),Q.now.shadow.on&&tn.createShadowmapMaterial(this.geo,this.material),this.geo}},{key:"buildSelectionGeometry",value:function(e){var t=null;if(this.geo&&"getSubset"in this.geo){var r=this.geo.getSubset(e);if(r&&0<r.length){(t=new me.Group).matrixAutoUpdate=!1,t.matrix=this.geo.matrix;for(var n=0;n<r.length;n++){var i=r[n];t.add(i)}}}return t&&(t.visible=this.visible),this.selectionGeo=t,this.selectionGeo}},{key:"compare",value:function(e){var t={},r=String(this.selector);e&&r.valueOf()===String(e.selector).valueOf()||(t.selector=r);var n=this.mode.identify();e&&!Array.isArray(n)&&n===e.mode||(t.mode=n);var i=this.colorer.identify();return e&&!Array.isArray(i)&&i===e.colorer||(t.colorer=i),e&&this.materialPreset.id===e.material||(t.material=this.materialPreset.id),t}},{key:"change",value:function(e,t,r,n){var i={};if(e.selector){var o=Ps.parse(e.selector).selector,s=String(o);this.selectorString!==s&&(i.selector=s,this.selectorString=s,this.selector=o,this.markAtoms(t))}if(e.mode){var a=e.mode;w.isEqual(this.mode.identify(),a)||(i.mode=a,this.setMode(r))}if(e.colorer){var l=e.colorer;w.isEqual(this.colorer.identify(),l)||(i.colorer=l,this.colorer=n)}if(e.material){var c=e.material;w.isEqual(this.materialPreset.id,c)||(i.material=c,this.setMaterialPreset(Ms.get(e.material)))}return i}},{key:"show",value:function(e){this.visible=e,this.geo&&(this.geo.visible=e),this.selectionGeo&&(this.selectionGeo.visible=e)}}]),o}();function Is(){}var Ls={ComponentEditor:function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this)))._complexVisual=e,t._inProgress=!1,t}return A(r,Is),p(r,[{key:"begin",value:function(){var e=this._complexVisual.getComplex();this._componentTransforms=[];for(var t=0;t<e._components.length;++t){var r=e._components[t];this._componentTransforms[r._index]=new me.Object3D}return this._inProgress=!0}},{key:"apply",value:function(){if(this._inProgress){for(var e=this._complexVisual.getComplex(),t=0;t<e._components.length;++t)this._bakeComponentTransform(e._components[t]);e.onAtomPositionChanged(),this._resetComponentTransform(),this._complexVisual.finalizeEdit()}}},{key:"discard",value:function(){this._inProgress&&(this._resetComponentTransform(),this._complexVisual.finalizeEdit())}},{key:"getAltObj",value:function(){var t={objects:[],pivot:new me.Vector3(0,0,0)},e=this._complexVisual,r=e.getSelectedComponent();if(null===r)return t;var n,i,o,s,a=this._complexVisual.getSelectionGeo(),l=1<<e.getSelectionBit();for(!function e(t,r,n){var i=t.children;if(i)for(var o=0,s=i.length;o<s;++o){var a=i[o];a._component===r&&n(a),a instanceof tn.RCGroup&&e(a,r,n)}}(e,r,function(e){t.objects.push(e)}),n=0;n<a.children.length;++n)for(o=a.children[n],i=0;i<o.children.length;++i)(s=o.children[i]).hasOwnProperty("_component")&&s._component===r&&t.objects.push(s);t.objects.push(this._componentTransforms[r._index]);var c=new me.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),u=new me.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r.forEachResidue(function(e){var t=e._atoms;for(i=0;i<t.length;++i)t[i].mask&l&&(c.min(t[i].position),u.max(t[i].position))}),t.pivot.lerpVectors(c,u,.5),t}},{key:"_bakeComponentTransform",value:function(e){var n=this._componentTransforms[e._index];!n||0===n.position.x&&0===n.position.y&&0===n.position.z&&0===n.quaternion.x&&0===n.quaternion.y&&0===n.quaternion.z&&1===n.quaternion.w||(n.updateMatrix(),e.forEachResidue(function(e){for(var t=e._atoms,r=0;r<t.length;++r)t[r].position.applyMatrix4(n.matrix)}))}},{key:"_resetComponentTransform",value:function(){var e,t,r,n,i=this._complexVisual,o=this._complexVisual.getSelectionGeo();for(e=0;e<this._componentTransforms.length;++e)(n=this._componentTransforms[e]).position.set(0,0,0),n.quaternion.set(0,0,0,1);for(e=0;e<i.children.length;++e)for(r=i.children[e],t=0;t<r.children.length;++t)(n=r.children[t]).hasOwnProperty("_component")&&(n.position.set(0,0,0),n.quaternion.set(0,0,0,1));for(e=0;e<o.children.length;++e)for(r=o.children[e],t=0;t<r.children.length;++t)(n=r.children[t]).hasOwnProperty("_component")&&(n.position.set(0,0,0),n.quaternion.set(0,0,0,1))}}]),r}(),FragmentEditor:function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this)))._complexVisual=e,t._inProgress=!1,t}return A(r,Is),p(r,[{key:"begin",value:function(){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo(),r=this._getSelectionBorderAtoms();if(r.length<1||2<r.length)return I.error("Can only edit fragments with one or two bound atoms."),!1;this._fragmentBoundAtoms=r;var n=1<<e.getSelectionBit();e.disableSubset(n,!0);for(var i=0;i<t.children.length;++i)t.children[i].visible=!1;var o=r[0].position.clone();2===r.length&&o.lerp(r[1].position,.5),this._fragmentGeo=new me.Group,e.add(this._fragmentGeo),this._fragmentGeo.position.copy(o),this._fragmentSelectionGeo=new me.Group,t.add(this._fragmentSelectionGeo),this._fragmentSelectionGeo.position.copy(o);var s=o.clone();s.negate();for(var a=0;a<e.children.length;++a){var l=e.children[a];if("getSubset"in l){var c=new me.Group;this._fragmentGeo.add(c);var u=new me.Group;this._fragmentSelectionGeo.add(u);for(var h=l.getSubset(n,!0),d=0;d<h.length;d++){var f=h[d];c.add(f),f.position.copy(s)}for(var p=l.getSubset(n,!0),m=0;m<p.length;m++){var _=p[m];u.add(_),_.position.copy(s)}}}return tn.applySelectionMaterial(this._fragmentSelectionGeo),this._inProgress=!0}},{key:"apply",value:function(){if(this._inProgress){var e=this._complexVisual,t=e.getSelectionBit(),r=this._fragmentGeo.position,n=this._fragmentGeo.matrix.clone();n.multiply((new me.Matrix4).makeTranslation(-r.x,-r.y,-r.z)),this._bakeAtomTransform(n,1<<t),e.enableSubset(1<<t,!0),e.getComplex().onAtomPositionChanged(),e.finalizeEdit()}}},{key:"discard",value:function(){if(this._inProgress){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo();this._fragmentGeo.parent.remove(this._fragmentGeo),e.enableSubset(1<<e.getSelectionBit(),!0);for(var r=0;r<t.children.length;++r){var n=t.children[r];n.visible?t.remove(n):n.visible=!0}e.finalizeEdit()}}},{key:"isFreeRotationAllowed",value:function(){return this._fragmentBoundAtoms.length<2}},{key:"getAltObj",value:function(){var e={objects:[],pivot:new me.Vector3(0,0,0)};e.objects.push(this._fragmentGeo,this._fragmentSelectionGeo);var t=this._fragmentBoundAtoms;if(1===t.length){if(1===t[0].bonds.length){var r=t[0].bonds[0];e.axis=(new me.Vector3).subVectors(r._right.position,r._left.position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld)}}else 2===t.length&&(e.axis=(new me.Vector3).subVectors(t[1].position,t[0].position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld));return e}},{key:"_getSelectionBorderAtoms",value:function(){var e=this._complexVisual.getComplex(),t=1<<this._complexVisual.getSelectionBit(),r={};e.forEachBond(function(e){e._left.mask&t?0==(e._right.mask&t)&&(r[e._left.index]=1):e._right.mask&t&&(r[e._right.index]=1)});for(var n=[],i=Object.keys(r),o=0,s=i.length;o<s;++o){var a=i[o];n.push(e._atoms[a])}return n}},{key:"_bakeAtomTransform",value:function(t,r){this._complexVisual.getComplex().forEachAtom(function(e){e.mask&r&&e.position.applyMatrix4(t)})}}]),r}()},Os=Cr.selectors;function Vs(e,t){Array.isArray(t)||(t=[t]);var r=y(t,2),n=r[0],i=r[1];return new(e.get(n)||e.first)(i)}var Ds=function(){function a(e,t){var r;return W(this,a),(r=Y(this,X(a).call(this,e,t)))._complex=t,r._reprList=[],r._repr=null,r._reprListChanged=!0,r._selectionBit=0,r._reprUsedBits=0,r._selectionCount=0,r._selectionGeometry=new me.Group,r}return A(a,nn),p(a,[{key:"getBoundaries",value:function(){return this._complex.getBoundaries()}},{key:"release",value:function(){this._selectionGeometry.parent&&this._selectionGeometry.remove(this._selectionGeometry),nn.prototype.release.call(this)}},{key:"getComplex",value:function(){return this._complex}},{key:"getSelectionCount",value:function(){return this._selectionCount}},{key:"getSelectionGeo",value:function(){return this._selectionGeometry}},{key:"getSelectionBit",value:function(){return this._selectionBit}},{key:"getEditor",value:function(){return this._editor}},{key:"resetReps",value:function(e){this._complex&&this._complex.clearAtomBits(-1),this._reprListChanged=!0,this._reprUsedBits=0,this._reprList.length=e.length;for(var t=0,r=e.length;t<r;++t){var n=e[t],i=void 0,o=void 0;if("string"==typeof n.selector)o=n.selector,i=Os.parse(o).selector;else if(void 0===n.selector){o=Q.now.presets.default[0].selector,i=Os.parse(o).selector}else o=(i=n.selector).toString();var s=Vs($o,n.mode),a=Vs(Ts,n.colorer),l=Ms.get(n.material)||Ms.first;this._reprList[t]=new Ns(t,s,a,i),this._reprList[t].setMaterialPreset(l),this._reprList[t].selectorString=o,this._complex&&this._complex.markAtoms(i,1<<t),this._reprUsedBits|=1<<t}this._repr=0<e.length?this._reprList[0]:null,this._selectionBit=e.length,this._reprUsedBits|=1<<this._selectionBit,this._selectionCount=0,this._complex&&this._complex.update()}},{key:"repCount",value:function(){return this._reprList.length}},{key:"repCurrent",value:function(e){return 0<=e&&e<this._reprList.length?this._repr=this._reprList[e]:e=this._reprList.indexOf(this._repr),e}},{key:"rep",value:function(e,t){if(!t&&(void 0===e||e instanceof Object)&&(t=e,e=this.repCurrent()),e<0||e>this._reprList.length)return I.error("Rep ".concat(e," does not exist!")),null;if(e===this._reprList.length){var r=this.repAdd(t);return I.warn("Rep ".concat(e," does not exist! New representation was created.")),{desc:r.desc,index:e,status:"created"}}var n=this._reprList[e],i={selector:n.selectorString,mode:n.mode.identify(),colorer:n.colorer.identify(),material:n.materialPreset.id};if(t){var o=n.change(t,this._complex,Vs($o,t.mode),Vs(Ts,t.colorer));if(!w.isEmpty(o)){for(var s in n.needsRebuild=!0,o)o.hasOwnProperty(s)&&(i[s]=o[s],I.debug("rep[".concat(e,"].").concat(s," changed to ").concat(o[s])));return o.mode&&n.mode.isSurface&&("ultra"===Q.now.resolution||"high"===Q.now.resolution)&&(I.report('Surface resolution was changed to "medium" to avoid hang-ups.'),Q.set("resolution","medium")),{desc:i,index:e,status:"changed"}}}return{desc:i,index:e,status:""}}},{key:"repGet",value:function(e){return(void 0===e||e instanceof Object)&&(e=this.repCurrent()),e<0||e>=this._reprList.length?null:this._reprList[e]}},{key:"_getFreeReprIdx",value:function(){for(var e=this._reprUsedBits,t=0;t<=a.NUM_REPRESENTATION_BITS;++t,e>>=1)if(0==(1&e))return t;return-1}},{key:"repAdd",value:function(e){if(this._reprList.length>=a.NUM_REPRESENTATION_BITS)return null;var t=this._getFreeReprIdx();if(t<0)return null;var r=this.buildSelectorFromMask(1<<this._selectionBit),n=Q.now.presets.default[0],i=w.merge({selector:n.selector,mode:n.mode,colorer:n.colorer,material:n.material},e),o="string"==typeof i.selector?Os.parse(i.selector).selector:i.selector,s=new Ns(this._selectionBit,Vs($o,i.mode),Vs(Ts,i.colorer),o);return s.selectorString=o.toString(),s.setMaterialPreset(Ms.get(i.material)),s.markAtoms(this._complex),this._reprList.push(s),this._selectionBit=t,this._reprUsedBits|=1<<this._selectionBit,this._complex.markAtoms(r,1<<this._selectionBit),{desc:i,index:this._reprList.length-1}}},{key:"repRemove",value:function(e){void 0===e&&(e=this.repCurrent());var t=this._reprList.length;if(!(e<0||t<=e||t<=1)){var r=this._reprList[e];r.unmarkAtoms(this._complex),this._reprUsedBits&=~(1<<r.index),this._reprList.splice(e,1),r===this._repr&&(e=e<--t?e:t-1,this._repr=this._reprList[e]),this._reprListChanged=!0}}},{key:"repHide",value:function(e,t){void 0===t&&(t=!0),e<0||e>=this._reprList.length||this._reprList[e].show(!t)}},{key:"select",value:function(e,t){t?this._selectionCount+=this._complex.markAtomsAdditionally(e,1<<this._selectionBit):this._selectionCount=this._complex.markAtoms(e,1<<this._selectionBit),this._complex.updateStructuresMask(),this.rebuildSelectionGeometry()}},{key:"resetSelectionMask",value:function(){0!==this._selectionCount&&(this._selectionCount=0,this._complex&&this._complex.clearAtomBits(1<<this._selectionBit))}},{key:"updateSelectionMask",value:function(e){var r=this,t=e.atom,n=e.residue,i=e.chain,o=e.molecule,s=1<<this._selectionBit,a=~s;if(t)n=t.residue,i=n._chain,o=n._molecule,t.mask&s?(t.mask&=a,n._mask&=a,i._mask&=a,o&&(o.mask&=a),this._selectionCount--):(t.mask|=s,this._selectionCount++,n.collectMask(),i.collectMask(),o&&o.collectMask());else if(n)i=n._chain,o=n._molecule,n._mask&s?(n._mask&=a,i._mask&=a,n.forEachAtom(function(e){e.mask&s&&(e.mask&=a,r._selectionCount--)})):(n._mask|=s,n.forEachAtom(function(e){e.mask&s||(e.mask|=s,r._selectionCount++)}),i.collectMask(),o&&o.collectMask());else if(i||o){var l=i||o;l._mask&s?(l._mask&=a,l.forEachResidue(function(e){e._mask&s&&(e._mask&=a,e.forEachAtom(function(e){e.mask&s&&(e.mask&=a,r._selectionCount--)}),e._mask&=a)})):(l._mask|=s,l.forEachResidue(function(e){if(!(e._mask&s)){e._mask|=s,e.forEachAtom(function(e){e.mask&s||(e.mask|=s,r._selectionCount++)});var t=i?e.getMolecule():e.getChain();t&&t.collectMask()}}))}else this.resetSelectionMask()}},{key:"expandSelection",value:function(){var t=this,r=1<<this._selectionBit;this._complex.forEachBond(function(e){e._left.mask&r?0==(e._right.mask&r)&&(e._right.mask|=1<<31):e._right.mask&r&&(e._left.mask|=1<<31)});this._complex.forEachAtom(function(e){e.mask&1<<31&&(e.mask=e.mask&~(1<<31)|r,++t._selectionCount)}),this._complex.updateStructuresMask()}},{key:"shrinkSelection",value:function(){var t=this,r=1<<this._selectionBit;this._complex.forEachBond(function(e){e._left.mask&r?0==(e._right.mask&r)&&(e._left.mask|=1<<31):e._right.mask&r&&(e._right.mask|=1<<31)}),this._complex.forEachAtom(function(e){e.mask&r&&1===e.bonds.length&&(e.mask|=1<<31)});var n=~(r|1<<31);this._complex.forEachAtom(function(e){e.mask&1<<31&&(e.mask&=n,--t._selectionCount)}),this._complex.updateStructuresMask()}},{key:"getSelectedComponent",value:function(){var t=1<<this._selectionBit,r=null,n=!1;return this._complex.forEachAtom(function(e){e.mask&t&&(null===r?r=e.residue._component:r!==e.residue._component&&(n=!0))}),n?null:r}},{key:"getSelectionCenter",value:function(t,r,n){t.set(0,0,0);var i=0;return this._complex.forEachAtom(function(e){r(e,n)&&(t.add(e.position),i++)}),0!==i&&(t.divideScalar(i),t.applyMatrix4(this.matrix),!0)}},{key:"needsRebuild",value:function(){if(this._reprListChanged)return!0;for(var e=this._reprList,t=0,r=e.length;t<r;++t){if(e[t].needsRebuild)return!0}return!1}},{key:"rebuild",value:function(){var c=this;return tn.clearTree(this),new Promise(function(s){var a=c._complex;if(a){var l=!1;setTimeout(function(){for(var e=c._reprList,t=fs.get(Q.now.palette)||fs.first,r=!1,n=0,i=e.length;n<i;++n){var o=e[n];if(o.colorer.palette=t,o.needsRebuild){o.reset();try{o.buildGeometry(a)}catch(e){if(!(e instanceof _e.OutOfMemoryError))throw e;o.needsRebuild=!1,o.reset(),I.error("Not enough memory to build geometry for representation ".concat(o.index+1)),l=!0}}r=l||r||tn.groupHasGeometryToRender(o.geo),o.geo&&c.add(o.geo)}c._reprListChanged=!1,s()},10)}else s()})}},{key:"setNeedsRebuild",value:function(){for(var e=this._reprList,t=0,r=e.length;t<r;++t)e[t].needsRebuild=!0}},{key:"rebuildSelectionGeometry",value:function(){var e=1<<this._selectionBit;tn.clearTree(this._selectionGeometry);for(var t=0,r=this._reprList.length;t<r;++t){var n=this._reprList[t].buildSelectionGeometry(e);if(n){this._selectionGeometry.add(n);for(var i=0;i<n.children.length;i++){var o=n.children[i];if(this._editor&&this._editor._componentTransforms){var s=this._editor._componentTransforms[o._component._index];s&&(o.position.copy(s.position),o.quaternion.copy(s.quaternion))}}tn.applySelectionMaterial(n)}}}},{key:"_buildSelectorFromSortedLists",value:function(e,t,r){var n=this._complex;function i(e){for(var t=[],r=0,n=NaN,i=NaN,o=0,s=e.length;o<s;++o){var a=e[o];a===i+1?i=a:(Number.isNaN(n)||(t[r++]=new Os.Range(n,i)),n=i=a)}return Number.isNaN(n)||(t[r]=new Os.Range(n,i)),t}var o=null;if(r.length===n._chains.length)o=Os.all();else{var s;if(0<r.length&&(s=Os.chain(r),o=o?Os.or(o,s):s),0<Object.keys(t).length)for(var a in t)t.hasOwnProperty(a)&&(s=Os.and(Os.chain(a),Os.residx(i(t[a]))),o=o?Os.or(o,s):s);0<e.length&&(s=Os.serial(i(e)),o=o?Os.or(o,s):s),o=o||Os.none()}return o}},{key:"buildSelectorFromMask",value:function(r){var e=this._complex,t=[],n={},i=[];return e.forEachChain(function(e){e._mask&r&&t.push(e._name)}),e.forEachResidue(function(e){if(e._mask&r&&!(e._chain._mask&r)){var t=e._chain._name;t in n?n[t].push(e._index):n[t]=[e._index]}}),e.forEachAtom(function(e){e.mask&r&&!(e.residue._mask&r)&&i.push(e.serial)}),this._buildSelectorFromSortedLists(i,n,t)}},{key:"forSelectedResidues",value:function(t){var r=1<<this._selectionBit;this._complex.forEachResidue(function(e){e._mask&r&&t(e)})}},{key:"beginComponentEdit",value:function(){if(this._editor)return null;var e=new Ls.ComponentEditor(this);return e.begin()?this._editor=e:null}},{key:"beginFragmentEdit",value:function(){if(this._editor)return null;var e=new Ls.FragmentEditor(this);return e.begin()?this._editor=e:null}},{key:"finalizeEdit",value:function(){this._editor=null}},{key:"setMaterialValues",value:function(t,e,r){for(var n=1<arguments.length&&void 0!==e&&e,i=2<arguments.length&&void 0!==r?r:void 0,o=0,s=this._reprList.length;o<s;++o){var a=this._reprList[o];a.material.setValues(t),n&&a.geo.traverse(function(e){e instanceof me.Mesh&&(e.material.setValues(t),void 0!==i&&i(e),e.material.needsUpdate=!0)})}}},{key:"setUberOptions",value:function(e){for(var t=0,r=this._reprList.length;t<r;++t){this._reprList[t].material.setUberOptions(e)}}},{key:"within",value:function(e,t){var r=this._complex.getVoxelWorld();if(null===r)return!1;var n=1<<this._selectionBit;return this._complex.markAtoms(e,n),r&&r.forEachAtomWithinDistFromMasked(this._complex,n,Number(t),function(e){e.mask|=n}),this._selectionCount=this._complex.countAtomsByMask(n),this._complex.updateStructuresMask(),this.buildSelectorFromMask(n)}}]),a}();Ds.NUM_REPRESENTATION_BITS=30;var zs="varying vec3 pos;\r\n\r\nvoid main() {\r\n  // we're assuming local position is in [-0.5, 0.5]\r\n  // we need to offset it to be represented in RGB\r\n  pos = position.xyz + 0.5;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}",Fs="varying vec3 pos;\r\n\r\nvoid main() {\r\n  gl_FragColor = vec4(pos, 0.5);\r\n}",Bs=me.UniformsUtils.merge([{volumeDim:{type:"v3",value:new me.Vector3(512,512,512)},tileTex:{type:"t",value:null},tileTexSize:{type:"v2",value:new me.Vector2(512,512)},tileStride:{type:"v2",value:new me.Vector2(512,512)},boxAngles:{type:"v3",value:new me.Vector3(1,1,1)},delta:{type:"v3",value:new me.Vector3(0,0,0)},_isoLevel0:{type:"v2",value:new me.Vector3(.5,.75,1)},_flipV:{type:"f",value:0},_BFLeft:{type:"t",value:null},_BFRight:{type:"t",value:null},_FFLeft:{type:"t",value:null},_FFRight:{type:"t",value:null},_WFFLeft:{type:"t",value:null},_WFFRight:{type:"t",value:null}}]);function Us(e,t){var r=me.UniformsUtils.clone(t);for(var n in e)r.hasOwnProperty(n)&&(r[n].value=e[n]);return r}function Gs(e,t){return{uniforms:Us(e,{}),vertexShader:zs,fragmentShader:Fs,transparent:!1,depthTest:!1,depthWrite:!1,side:t}}function js(e,t,r,n){W(this,js),this.uniforms=Us(e,t),this.vertexShader=r,this.fragmentShader=n,this.transparent=!1,this.depthTest=!1,this.depthWrite=!1,this.side=me.FrontSide}var Hs=function(e){function r(e){W(this,r);var t=Gs(e,me.BackSide);return Y(this,X(r).call(this,t))}return A(r,e),r}(me.ShaderMaterial),Ws={BackFacePosMaterial:Hs,BackFacePosMaterialFarPlane:function(e){function n(e){W(this,n);var t=me.UniformsUtils.merge([{aspectRatio:{type:"f",value:0},farZ:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},matWorld2Volume:{type:"4fv",value:new me.Matrix4}}]),r=new js(e,t,"varying vec4 volPos;\r\nuniform float aspectRatio;\r\nuniform float farZ;\r\nuniform float tanHalfFOV;\r\nuniform mat4  matWorld2Volume;\r\n\r\nvoid main() {\r\n  // rescale plane to fill in the whole far plane area seen from camera\r\n  vec3 pos = position.xyz;\r\n  pos.x = pos.x * tanHalfFOV * farZ * aspectRatio;\r\n  pos.y = pos.y * tanHalfFOV * farZ;\r\n  // common transformation\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\r\n  // calc pos in volume CS\r\n  volPos = matWorld2Volume * modelMatrix * vec4(pos, 1.0);\r\n  // we're assuming local position is in [-0.5, 0.5]\r\n  // we need to offset it to be represented in RGB\r\n  volPos = volPos + 0.5;\r\n  volPos.w = 0.5;\r\n}\r\n","varying vec4 volPos;\r\n\r\nvoid main() {\r\n  gl_FragColor = volPos;\r\n}");return Y(this,X(n).call(this,r))}return A(n,e),n}(me.ShaderMaterial),FrontFacePosMaterial:function(e){function r(e){W(this,r);var t=Gs(e,me.FrontSide);return Y(this,X(r).call(this,t))}return A(r,e),r}(me.ShaderMaterial),VolumeMaterial:function(e){function n(e){var t;W(this,n);var r=new js(e,Bs,"varying vec4 screenSpacePos;\r\n\r\nvoid main() {\r\n  screenSpacePos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n  gl_Position = screenSpacePos;\r\n}","uniform mat4 projectionMatrix;\r\n\r\n// 3D volume texture\r\nuniform vec3 volumeDim;    // volume dimensions, pixels\r\nuniform sampler2D tileTex; // tiled texture containing all Z-slices of a 3D data\r\nuniform vec2 tileTexSize;  // size of tiled texture, pixels\r\nuniform vec2 tileStride;   // UV stride between slices in tile tex, pixels\r\n\r\nuniform vec3 boxAngles;//value of angles({x: alpha, y:beta, z:gamma}) types 1 - if angle is obtuse, 0 - if acute\r\nuniform vec3 delta; //Projection box delta's from non-orthogonal origin axes; {x: XY, y : XZ, z: YZ}\r\n\r\nuniform vec3 _isoLevel0;\r\nuniform float _flipV;\r\nuniform sampler2D _BFLeft;\r\nuniform sampler2D _BFRight;\r\nuniform sampler2D _FFLeft;\r\nuniform sampler2D _FFRight;\r\nuniform sampler2D _WFFLeft;\r\nuniform sampler2D _WFFRight;\r\n\r\nvarying vec4 screenSpacePos;\r\n\r\n#define NO_COLOR vec4(0., 0., 0., 0.)\r\n\r\nvec4 sample3DTexture(vec3 texCoord) {\r\n  // a pair of Z slices is determined by nearest slice border\r\n  float zSliceBorder = floor(texCoord.z * volumeDim.z + 0.5);\r\n  float zSliceNumber1 = max(zSliceBorder - 1.0, 0.0);\r\n  float zSliceNumber2 = min(zSliceBorder, volumeDim.z - 1.0);\r\n\r\n  float rowTiles = floor(tileTexSize.x / tileStride.x);\r\n\r\n  // calculate coords in tile texture for both slices\r\n  vec2 tileOffset = vec2(mod(zSliceNumber1, rowTiles), floor(zSliceNumber1 / rowTiles));\r\n  vec2 texCoordSlice1 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r\n  tileOffset = vec2(mod(zSliceNumber2, rowTiles), floor(zSliceNumber2 / rowTiles));\r\n  vec2 texCoordSlice2 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r\n\r\n  // bilinear filtering\r\n  vec4 colorSlice1 = texture2D(tileTex, texCoordSlice1);\r\n  vec4 colorSlice2 = texture2D(tileTex, texCoordSlice2);\r\n  float weightSlice2 = texCoord.z * volumeDim.z - (zSliceNumber1 + 0.5);\r\n  return mix(colorSlice1, colorSlice2, weightSlice2);\r\n}\r\n\r\nvec4 sample3DTextureInclined(vec3 boxCoord) { // delta:{ x: XY, y : XZ, z: YZ }\r\n  vec3 textCoord = boxCoord;\r\n  vec2 currDelta = mix(boxCoord.zz, vec2(1., 1.) - boxCoord.zz, boxAngles.yx) * delta.yz;\r\n\r\n  textCoord.y = (boxCoord.y  - currDelta.y) / (1. - delta.z);\r\n  if (textCoord.y < 0.0 || textCoord.y > 1.0)\r\n    return NO_COLOR;\r\n\r\n  currDelta.x += mix(textCoord.y, 1.0 - textCoord.y, boxAngles.z) * delta.x;\r\n\r\n  textCoord.x = (boxCoord.x - currDelta.x) / (1. - delta.x - delta.y);\r\n  if (textCoord.x < 0.0 || textCoord.x > 1.0)\r\n    return NO_COLOR;\r\n\r\n  return sample3DTexture(textCoord);\r\n}\r\n\r\nfloat CalcColor(vec3 iter, vec3 dir) {\r\n  float d = 1. / 128.;\r\n  vec3 dx = vec3(d, 0.0, 0.0);\r\n  vec3 dy = vec3(0.0, d, 0.0);\r\n  vec3 dz = vec3(0.0, 0.0, d);\r\n\r\n  // #Opt: coordInc.x:(iter + dx).x > 1. ? 0.: sample3DTextureInclined(iter + dx).x,\r\n  vec3 coordInc = mix(\r\n    vec3(\r\n      sample3DTextureInclined(iter + dx).x,\r\n      sample3DTextureInclined(iter + dy).x,\r\n      sample3DTextureInclined(iter + dz).x\r\n    ),\r\n    vec3(0. ,0. , 0.),\r\n    vec3(floor((iter + dx).x), floor((iter + dy).y), floor((iter + dz).z))\r\n  );\r\n\r\n  // #Opt: coordDec.x:(iter - dx).x < 0. ? 0.: sample3DTextureInclined(iter - dx).x,\r\n  vec3 coordDec = mix(\r\n    vec3(0. ,0. , 0.),\r\n    vec3(\r\n      sample3DTextureInclined(iter - dx).x,\r\n      sample3DTextureInclined(iter - dy).x,\r\n      sample3DTextureInclined(iter - dz).x\r\n    ),\r\n    vec3(ceil((iter - dx).x), ceil((iter - dy).y), ceil((iter - dz).z))\r\n  );\r\n\r\n  vec3 N = normalize(coordInc - coordDec);\r\n  float dif = max(0.0, dot(N, dir));\r\n  return dif;\r\n}\r\n\r\nvec3 AccuracyIso(vec3 left, vec3 right, float volLeft, float threshold) {\r\n  for (int i = 0; i < 5; i++) {\r\n    vec3 iterator = 0.5 * (left + right);\r\n    float vol = sample3DTextureInclined(iterator).r;\r\n    if ((volLeft - threshold) * (vol - threshold) < 0.)\r\n      right = iterator;\r\n    else\r\n      left = iterator;\r\n  }\r\n  return 0.5 * (left + right);\r\n}\r\n\r\nvec3 CorrectIso(vec3 left, vec3 right, float tr) {\r\n  for (int j = 0; j < 5; j++) {\r\n    vec3 iterator = 0.5 * (left + right);\r\n    float vol = sample3DTextureInclined(iterator).r;\r\n    if (vol < tr)\r\n      right = iterator;\r\n    else\r\n      left = iterator;\r\n  }\r\n  return 0.5 * (left + right);\r\n}\r\n\r\nvec4 GetIso1(vec3 start, vec3 back, float molDist, vec3 dir, float tr, int count) {\r\n  float vol, stepSize = (float(count) + 2.) / float(STEPS_COUNT);\r\n  vec3 step = stepSize * dir, iterator = start, left, right;\r\n  vec4 acc = NO_COLOR;\r\n\r\n  for (int i = 0; i < STEPS_COUNT; i++) {\r\n    iterator = iterator + step;\r\n    vol = sample3DTextureInclined(iterator).r;\r\n    if (length(iterator - back) <= stepSize || (vol > tr))\r\n      break;\r\n  }\r\n\r\n  if (vol > tr)\r\n    acc = vec4(CorrectIso(iterator, iterator - step, tr).xyz, 1.);\r\n\r\n  return acc;\r\n}\r\n\r\nfloat easeOut(float x0, float x1, float x) {\r\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r\n  return 1.0 - (1.0 - t) * (1.0 - t);\r\n}\r\n\r\nfloat easeIn(float x0, float x1, float x) {\r\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r\n  return t * t;\r\n}\r\n\r\nvec3 GetColSimple(float vol) {\r\n  float t = easeOut(_isoLevel0.x, _isoLevel0.y, vol);\r\n  float s = easeIn(_isoLevel0.y, _isoLevel0.z, vol);\r\n  return vec3(0.5, 0.6, 0.7) * (1.0 - t) + 2.0 * vec3(s, 0, 0);\r\n}\r\n\r\nvec4 VolRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  vec4 acc = NO_COLOR, iso;\r\n  vec3 iterator = start, sumColor = vec3(0., 0., 0.);\r\n  float stepSize, alpha, sumAlpha = 0.0, vol, curStepSize, molD;\r\n  vec3 step, col, colOld, right;\r\n  float tr0 = _isoLevel0.x;\r\n  float dif, r, kd, finish;\r\n  int count = 0, stopMol = 0;\r\n\r\n  for (int k = 0; k < 3; k++) {\r\n    stepSize = (float(k) + 2.) / float(STEPS_COUNT);\r\n    kd = 140. * tr0 * stepSize;\r\n    r = 1. - kd;\r\n    step = stepSize * dir;\r\n    iso = GetIso1(iterator, back, molDist, dir, tr0, k);\r\n    if (iso.a < 0.1 || length(iso.xyz - start) > molDist)\r\n      break;\r\n    iterator = iso.xyz;\r\n    dif = 1.;// CalcColor(iterator, dir);\r\n    colOld = GetColSimple(tr0);\r\n    curStepSize = stepSize;\r\n    for (int i = 0; i < STEPS_COUNT; i++) {\r\n      iterator = iterator + step;\r\n      molD = length(iterator - start);\r\n      vol = sample3DTextureInclined(iterator).r;\r\n      finish = distance(iterator, back) - stepSize;\r\n      if (finish < 0.0 || vol < tr0 || (sumAlpha > 0.97) || molD > molDist)\r\n        break;\r\n      alpha = (1. - r);\r\n      col = GetColSimple(vol);\r\n      vol = sample3DTextureInclined(iterator - 0.5 * step).r;\r\n      vec3 colMid = GetColSimple(vol);\r\n      sumColor += (1. - sumAlpha) * (colOld + 4.* colMid + col) * alpha / 6.;\r\n      sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r\n      colOld = col;\r\n    } // for i\r\n\r\n    if (finish < 0.0 || sumAlpha > 0.97)\r\n      break;\r\n\r\n    if (molD > molDist) {\r\n      curStepSize = stepSize - (molD - molDist);\r\n      right = iterator - (molD - molDist) * dir;\r\n      vol = sample3DTextureInclined(right).r;\r\n    } else {\r\n      vec3 left = iterator - step;\r\n      right = CorrectIso(left, iterator, tr0);\r\n      curStepSize = distance(left, right);\r\n      vol = tr0;\r\n    }\r\n\r\n    alpha = (1. - r) * curStepSize / stepSize;\r\n    dif = 1.;// CalcColor(right, dir);\r\n    col = GetColSimple(vol);\r\n    vol = sample3DTextureInclined(iterator - 0.5 * curStepSize / stepSize * step).r;\r\n    vec3 colMid = GetColSimple(vol);\r\n    sumColor += (1. - sumAlpha) * (colOld + 4. * colMid + col) * alpha / 6.;\r\n    sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r\n\r\n    if (molD > molDist)\r\n      break;\r\n  } // for k\r\n  acc.rgb = 1. * sumColor / sumAlpha;\r\n  acc.a = sumAlpha;\r\n  return acc;\r\n}\r\n\r\nvec4 VolRender1(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  float stepSize = 1.0 / float(STEPS_COUNT);\r\n  float len = length(back - start);\r\n  vec3 step = stepSize * dir;\r\n  vec3 iterator = start;\r\n  float acc = 0.0;\r\n\r\n  for (int i = 0; i < STEPS_COUNT; i++) {\r\n    if (float(i) * stepSize > len)\r\n      break;\r\n    iterator = iterator + step;\r\n    if (sample3DTextureInclined(iterator).r > _isoLevel0.x)\r\n      acc += 10. * sample3DTextureInclined(iterator).r / float(STEPS_COUNT);\r\n  }\r\n\r\n  return vec4(1.,1.,1., acc);\r\n}\r\n\r\nvec4 IsoRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  vec4 tst = GetIso1(start, back, 2., dir, _isoLevel0.x, 0);\r\n  vec4 col = NO_COLOR;\r\n\r\n  if (length(tst.xyz - start) < molDist && tst.a > 0.1) {\r\n    float dif =  CalcColor(tst.xyz, dir);\r\n    dif = 0.9 * dif * dif;\r\n    col = vec4(dif, dif, dif, 1);\r\n  }\r\n  return col;\r\n}\r\n\r\nvec4 VolRender2(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  return sample3DTexture(start);\r\n}\r\n\r\nvoid main() {\r\n  vec3 tc = screenSpacePos.xyz / screenSpacePos.w * 0.5 + 0.5;\r\n\r\n  if (_flipV > 0.0) {\r\n    tc.y = 1.0 - tc.y;\r\n  }\r\n\r\n  vec3 start;\r\n  vec3 back;\r\n  vec3 molBack;\r\n  if (projectionMatrix[0][2] < 0.0) {\r\n    start = texture2D(_FFLeft, tc.xy).xyz;\r\n    back = texture2D(_BFLeft, tc.xy).xyz;\r\n    molBack = texture2D(_WFFLeft, tc.xy).xyz;\r\n  } else {\r\n    start = texture2D(_FFRight, tc.xy).xyz;\r\n    back = texture2D(_BFRight, tc.xy).xyz;\r\n    molBack = texture2D(_WFFRight, tc.xy).xyz;\r\n  }\r\n\r\n  vec3 dir = normalize(back - start);\r\n\r\n  float molDist = 2.0;\r\n  if (length(molBack) > 0.001) {\r\n    molDist = distance(start, molBack);\r\n  }\r\n\r\n  #ifdef ISO_MODE\r\n    gl_FragColor = IsoRender(start, back, molDist, dir);\r\n  #else\r\n    gl_FragColor = VolRender(start, back, molDist, dir);\r\n  #endif\r\n}\r\n");return r.transparent=!0,r.depthTest=!0,(t=Y(this,X(n).call(this,r))).updateDefines(),t}return A(n,e),p(n,[{key:"updateDefines",value:function(){this.defines={ISO_MODE:Q.now.modes.VD.isoMode,STEPS_COUNT:100*Q.now.modes.VD.polyComplexity[Q.now.resolution]},this.needsUpdate=!0}}]),n}(me.ShaderMaterial)},Ys=function(e){function C(){var e;W(this,C);var t=new me.BufferGeometry;e=Y(this,X(C).call(this,t)),Ce(S(e),"volumeInfo",{}),e.clipPlane=new me.Plane;var r=new me.Vector3(.5,.5,.5);return e.size=r,e.cullFlag=[!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1],e.faces=[{indices:[],norm:new me.Vector3(0,0,-1)},{indices:[],norm:new me.Vector3(0,0,1)},{indices:[],norm:new me.Vector3(0,-1,0)},{indices:[],norm:new me.Vector3(0,1,0)},{indices:[],norm:new me.Vector3(-1,0,0)},{indices:[],norm:new me.Vector3(1,0,0)},{indices:[],norm:new me.Vector3(0,0,0)}],e.vertices=[new me.Vector3(-r.x,-r.y,-r.z),new me.Vector3(-r.x,r.y,-r.z),new me.Vector3(r.x,-r.y,-r.z),new me.Vector3(r.x,r.y,-r.z),new me.Vector3(-r.x,-r.y,r.z),new me.Vector3(-r.x,r.y,r.z),new me.Vector3(r.x,-r.y,r.z),new me.Vector3(r.x,r.y,r.z),new me.Vector3(0,0,0),new me.Vector3(0,0,0),new me.Vector3(0,0,0),new me.Vector3(0,0,0),new me.Vector3(0,0,0),new me.Vector3(0,0,0)],t.setAttribute("position",new me.BufferAttribute(new Float32Array(3*e.vertices.length),3)),e.name="VolumeMesh",e}return A(C,e),p(C,[{key:"_updateVertices",value:function(){var e,t=C._corners,r=C._edges,n=C._edgeIntersections,i=this.clipPlane.normal,o=this.clipPlane.constant,s=this.vertices,a=this.size,l=[0,0,0,0,0,0,0,0],c=[1,1,1,1,1,1,1,1,1,1,1,1],u=new me.Vector3,h=null;function d(){if(0===i.x)return 0;var e=-(i.dot(u)+o)/i.x;return-a.x<=e&&e<=a.x?(h.set(e,u.y,u.z),e===a.x?2:e==-a.x?-2:1):0}function f(){if(0===i.y)return 0;var e=-(i.dot(u)+o)/i.y;return-a.y<=e&&e<=a.y?(h.set(u.x,e,u.z),e===a.y?2:e==-a.y?-2:1):0}function p(){if(0===i.z)return 0;var e=-(i.dot(u)+o)/i.z;return-a.z<=e&&e<=a.z?(h.set(u.x,u.y,e),e===a.z?2:e==-a.z?-2:1):0}for(var m=0;m<12;++m){var _=r[m];h=n[m],u.set(_[2],_[3],_[4]),u.multiply(a);var v=0;0===_[2]&&(v=d()),0===_[3]&&(v=f()),0===_[4]&&(v=p()),-2===v?l[_[0]]=1:2===v?l[_[1]]=1:0===v&&(c[m]=0)}var g={indices:[],norm:i.clone().negate()},y=8;for(e=0;e<8;++e)1===l[e]&&(s[y].set(t[e][0],t[e][1],t[e][2]).multiply(a),g.indices.push(y++),c[t[e][3]]=0,c[t[e][4]]=0,c[t[e][5]]=0);for(e=0;e<12;++e)1===c[e]&&(s[y].copy(n[e]),g.indices.push(y++));this.faces[6]=g;var x=new me.Vector3,b=new me.Vector3;for(this.clipPlane.coplanarPoint(b),e=0;e<s.length;++e)this.cullFlag[e]=!1,e<8?(x.subVectors(s[e],b),this.cullFlag[e]=0<=i.dot(x)):e<8+g.indices.length&&(this.cullFlag[e]=!0);var w=this.geometry.getAttribute("position"),S=0;for(e=0;e<s.length;++e)w.array[S++]=s[e].x,w.array[S++]=s[e].y,w.array[S++]=s[e].z;w.needsUpdate=!0}},{key:"_collectVertices",value:function(e,t){var r,n=this.vertices;for(e.indices=[],r=0;r<n.length;++r)this.cullFlag[r]&&t(n[r])&&e.indices.push(r)}},{key:"_sortIndices",value:function(e,t){var r,n,i=this.vertices,o=[],s=new me.Vector3;for(r=1;r<e.indices.length;++r)s.subVectors(i[e.indices[r]],i[e.indices[0]]),s.normalize(),s.cross(t),s.negate(),o[r]=e.norm.dot(s);for(r=1;r<e.indices.length-1;++r)for(n=r+1;n<e.indices.length;++n)if(o[n]<o[r]){var a=o[r];o[r]=o[n],o[n]=a,a=e.indices[r],e.indices[r]=e.indices[n],e.indices[n]=a}}},{key:"_updateIndices",value:function(){var e,t,r,n=this.vertices,i=this.size;this._collectVertices(this.faces[0],function(e){return e.z===-i.z}),this._collectVertices(this.faces[1],function(e){return e.z===i.z}),this._collectVertices(this.faces[2],function(e){return e.y===-i.y}),this._collectVertices(this.faces[3],function(e){return e.y===i.y}),this._collectVertices(this.faces[4],function(e){return e.x===-i.x}),this._collectVertices(this.faces[5],function(e){return e.x===i.x});var o=new me.Vector3,s=new me.Vector3,a=new me.Vector3;for(t=0;t<this.faces.length;++t)if(0!==(r=this.faces[t]).indices.length){for(o.set(0,0,0),e=0;e<r.indices.length;++e)o.add(n[r.indices[e]]);o.multiplyScalar(1/r.indices.length),s.subVectors(n[r.indices[0]],o),s.normalize();var l=[];for(e=0;e<r.indices.length;++e)a.subVectors(n[r.indices[e]],o),l[e]=a.dot(s);for(e=1;e<r.indices.length;++e)if(l[e]<l[0]){var c=l[0];l[0]=l[e],l[e]=c,c=y(r.indices,1)[0],r.indices[0]=r.indices[e],r.indices[e]=c}this._sortIndices(r,s)}var u=0;for(t=0;t<this.faces.length;++t)3<=(r=this.faces[t]).indices.length&&(u+=3*(r.indices.length-2));var h=0,d=new Uint16Array(u);for(t=0;t<this.faces.length;++t)for(r=this.faces[t],e=0;e<r.indices.length-2;++e)d[h]=r.indices[0],d[h+1]=r.indices[e+1],d[h+2]=r.indices[e+2],h+=3;this.geometry.setIndex(new me.BufferAttribute(d,1))}},{key:"setDataSource",value:function(e){var t=new Ws.VolumeMaterial,r=e.getDimensions(),n=e.getTiledTextureStride(),i=e.buildTiledTexture(),o=e.getBox();t.uniforms.volumeDim.value.set(r[0],r[1],r[2]),t.uniforms.tileTex.value=i,t.uniforms.tileTexSize.value.set(i.image.width,i.image.height),t.uniforms.tileStride.value.set(n[0],n[1]),Object.assign(this.volumeInfo,e.getVolumeInfo());var s=this.volumeInfo;t.uniforms.delta.value.copy(s.delta),t.uniforms.boxAngles.value.set(s.obtuseAngle[0],s.obtuseAngle[1],s.obtuseAngle[2]),this.material=t,o.getSize(this.scale),o.getCenter(this.position)}},{key:"_updateIsoLevel",value:function(){function e(e){return(s+e*o.sd)/a}var t=Q.now.modes.VD,r=t.kSigma,n=t.kSigmaMed,i=t.kSigmaMax,o=this.volumeInfo,s=o.dmean-o.dmin,a=o.dmax-o.dmin;this.material.uniforms._isoLevel0.value.set(e(r),e(n),e(i))}},{key:"rebuild",value:function(e){var t=C._nearClipPlaneOffset,r=C._pos,n=C._norm,i=C._norm4D,o=C._matrixWorldToLocal,s=C._clipPlane;this._updateIsoLevel(),e.getWorldDirection(n),e.getWorldPosition(r),r.addScaledVector(n,e.near+t),o.getInverse(this.matrixWorld),r.applyMatrix4(o),i.set(n.x,n.y,n.z,0),i.applyMatrix4(o),n.copy(i),n.normalize(),s.setFromNormalAndCoplanarPoint(n,r),this.clipPlane.equals(s)||(this.clipPlane=s.clone(),this._updateVertices(),this._updateIndices())}}]),C}(me.Mesh);Ce(Ys,"_corners",[[-1,-1,-1,0,4,8],[1,-1,-1,0,5,9],[1,1,-1,1,5,10],[-1,1,-1,1,4,11],[-1,-1,1,2,6,8],[1,-1,1,2,7,9],[1,1,1,3,7,10],[-1,1,1,3,6,11]]),Ce(Ys,"_edges",[[0,1,0,-1,-1],[2,3,0,1,-1],[4,5,0,-1,1],[6,7,0,1,1],[0,3,-1,0,-1],[1,2,1,0,-1],[4,7,-1,0,1],[5,6,1,0,1],[0,4,-1,-1,0],[1,5,1,-1,0],[2,6,-1,1,0],[3,7,1,1,0]]),Ce(Ys,"_edgeIntersections",function(){for(var e=[],t=0;t<12;++t)e.push(new me.Vector3);return e}()),Ce(Ys,"_nearClipPlaneOffset",.2),Ce(Ys,"_pos",new me.Vector3),Ce(Ys,"_norm",new me.Vector3),Ce(Ys,"_norm4D",new me.Vector4),Ce(Ys,"_matrixWorldToLocal",new me.Matrix4),Ce(Ys,"_clipPlane",new me.Plane);var Xs=function(){function d(e,t){W(this,d);var r=t.delta,n=t.obtuseAngle,i=new me.Vector3;e.getSize(i),i.multiplyScalar(.5);for(var o=this._getBaseVertices(r,n),s=new me.Geometry,a=0;a<4;a++)s.vertices.push(o[a].clone().multiply(i)),s.vertices.push(o[(a+1)%4].clone().multiply(i));for(var l=new me.Vector3(2*i.x*(1-r.x-r.y),0,0),c=0;c<8;c++)s.vertices.push(s.vertices[c].clone().add(l));for(var u=0;u<4;u++)s.vertices.push(s.vertices[2*u].clone()),s.vertices.push(s.vertices[2*u+8].clone());var h=new me.Vector3;e.getCenter(h),s.vertices.forEach(function(e){return e.add(h)}),this._lines=new me.LineSegments(s,new me.LineBasicMaterial({color:16777215})),this._lines.layers.set(tn.LAYERS.VOLUME)}return p(d,[{key:"_getBaseVertices",value:function(n,i){function e(e,t){var r=n[o[e][0]];return(-.5*(t-1)+t*i[o[e][1]])*r}var o=d._projectionTable;return[new me.Vector3(2*(e("XZ",1)+e("XY",1))-1,2*e("YZ",1)-1,-1),new me.Vector3(2*(e("XZ",-1)+e("XY",1))-1,2*e("YZ",-1)-1,1),new me.Vector3(2*(e("XZ",-1)+e("XY",-1))-1,1-2*e("YZ",1),1),new me.Vector3(2*(e("XZ",1)+e("XY",-1))-1,1-2*e("YZ",-1),-1)]}},{key:"getMesh",value:function(){return this._lines}}]),d}();Ce(Xs,"_projectionTable",{XY:["x",2],XZ:["y",1],YZ:["z",0]});var qs=function(){function i(c,e,t){W(this,i);var r=this._initPlaneGeo(e,t),n=new Ws.BackFacePosMaterialFarPlane;this._plane=new Fi.Mesh(r,n),this._plane.frustumCulled=!1,this._plane.doubleSided=!0;var u=new me.Matrix4;this._plane._onBeforeRender=function(e,t,r,n,i,o){var s=this.material;if(c&&s){var a=new me.Vector4(0,0,-(r.far-.1),1);a.applyMatrix4(r.matrixWorld),this.matrix.identity(),this.matrix.makeTranslation(a.x,a.y,a.z),this.matrixWorld.copy(this.matrix),this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),this.normalMatrix.getNormalMatrix(this.modelViewMatrix);var l=c.matrixWorld;u.getInverse(l),s.uniforms.aspectRatio.value=r.aspect,s.uniforms.farZ.value=r.far,s.uniforms.tanHalfFOV.value=Math.tan(.5*me.Math.DEG2RAD*r.fov),s.uniforms.matWorld2Volume.value=u}},this._plane.layers.set(tn.LAYERS.VOLUME_BFPLANE)}return p(i,[{key:"_initPlaneGeo",value:function(e,t){var r=new me.Geometry;return e=e||1,t=t||1,r.vertices.push(new me.Vector3(-.5*e,.5*t,0)),r.vertices.push(new me.Vector3(.5*e,.5*t,0)),r.vertices.push(new me.Vector3(-.5*e,-.5*t,0)),r.vertices.push(new me.Vector3(.5*e,-.5*t,0)),r.faces.push(new me.Face3(0,2,1)),r.faces.push(new me.Face3(2,3,1)),r}},{key:"getMesh",value:function(){return this._plane}}]),i}();function $s(e,t){nn.call(this,e,t),this._mesh=new Ys,this._mesh.setDataSource(t),this.add(this._mesh),this._frame=new Xs(this.getBoundaries().boundingBox,this._mesh.volumeInfo),this.add(this._frame.getMesh()),this.showFrame(Q.now.modes.VD.frame),this._farPlane=new qs(this._mesh,2,2),this.add(this._farPlane.getMesh())}_e.deriveClass($s,nn),$s.prototype.getBoundaries=function(){var e=this._dataSource.getBox(),t=new me.Sphere;return e.getBoundingSphere(t),{boundingBox:e,boundingSphere:t}},$s.prototype.getMesh=function(){return this._mesh},$s.prototype.showFrame=function(e){this._frame.getMesh().material.visible=e};var Zs=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return W(this,t),Y(this,X(t).call(this,e,["types"]))}return A(t,un),p(t,[{key:"find",value:function(t){var e=[];if(t.type)e=this._dict.types[t.type.toLowerCase()]||[];else if(t.source)return this._list.filter(function(e){return e.canProbablyLoad&&e.canProbablyLoad(t.source)});return ln(e)}}]),t}(),Ks=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this)))._source=e,r._options=t||{},r._abort=!1,r._agent=null,r}return A(n,R),p(n,[{key:"load",value:function(){return Promise.reject(new Error("Loading from this source is not implemented"))}},{key:"abort",value:function(){this._abort=!0,this._agent&&this._agent.abort()}}],[{key:"extractName",value:function(){}}]),n}();hn(Ks.prototype);var Qs=function(){function n(e,t){var r;return W(this,n),t=(r=Y(this,X(n).call(this,e,t)))._options,r._binary=!0===t.binary,r}return A(n,Ks),p(n,[{key:"load",value:function(){var i=this;return new Promise(function(e,t){if(i._abort)throw new Error("Loading aborted");var r=i._source,n=i._agent=new FileReader;n.addEventListener("load",function(){e(n.result)}),n.addEventListener("error",function(){t(n.error)}),n.addEventListener("abort",function(){t(new Error("Loading aborted"))}),n.addEventListener("progress",function(e){i.dispatchEvent(e)}),i._binary?n.readAsArrayBuffer(r):n.readAsText(r)})}}],[{key:"canProbablyLoad",value:function(e){return File&&e instanceof File||Blob&&e instanceof Blob}},{key:"extractName",value:function(e){return e&&e.name}}]),n}();Qs.types=["file","blob"];var Js=/^(https?|ftp):\/\//i,ea=function(){function n(e,t){var r;return W(this,n),t=(r=Y(this,X(n).call(this,e,t)))._options,r._binary=!0===t.binary,r}return A(n,Ks),p(n,[{key:"load",value:function(){var i=this;return new Promise(function(e,t){if(i._abort)throw new Error("Loading aborted");var r=i._source,n=i._agent=new XMLHttpRequest;n.addEventListener("load",function(){200===n.status?e(n.response):t(new Error("HTTP ".concat(n.status," while fetching ").concat(r)))}),n.addEventListener("error",function(){t(new Error("HTTP request failed"))}),n.addEventListener("abort",function(){t(new Error("Loading aborted"))}),n.addEventListener("progress",function(e){i.dispatchEvent(e)}),n.open("GET",r),i._binary?n.responseType="arraybuffer":n.responseType="text",n.send()})}}],[{key:"canProbablyLoad",value:function(e){return w.isString(e)&&Js.test(e)}},{key:"extractName",value:function(e){if(e){var t=(e.indexOf("?")+1||e.lastIndexOf("#")+1||e.length+1)-1;return e.slice(e.lastIndexOf("/",t)+1,t)}}}]),n}();ea.types=["url"];var ta=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,Ks),p(e,[{key:"load",value:function(){var t=this;return new Promise(function(e){if(t._abort)throw new Error("Loading aborted");e(t._source)})}}],[{key:"canProbablyLoad",value:function(){return!1}}]),e}();ta.types=["immediate"];var ra=new Zs([Qs,ea,ta]),na=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return W(this,t),Y(this,X(t).call(this,e,["formats","extensions"]))}return A(t,un),p(t,[{key:"find",value:function(t){var e=[];return t.format?e=this._dict.formats[t.format.toLowerCase()]||[]:t.ext&&(e=this._dict.extensions[t.ext.toLowerCase()]||[]),0===e.length&&!t.format&&t.data?this._list.filter(function(e){return e.canProbablyParse&&e.canProbablyParse(t.data)}):ln(e)}}]),t}(),ia=function(){function r(e,t){W(this,r),this._data=e,this._options=t||{},this._abort=!1}return p(r,[{key:"parseSync",value:function(){throw new Error("Parsing this type of data is not implemented")}},{key:"parse",value:function(){var r=this;return new Promise(function(e,t){setTimeout(function(){try{return r._abort?t(new Error("Parsing aborted")):e(r.parseSync())}catch(e){return t(e)}})})}},{key:"getModel",value:function(){return this.model._parseHeader(this._data),this.model}},{key:"abort",value:function(){this._abort=!0}}]),r}();hn(ia.prototype);var oa=function(){function e(){W(this,e),this.matrices=[],this._matrix=null,this._matrixIndex=-1}return p(e,[{key:"parse",value:function(e){var t=this._matrix;if("  SMTRY"===e.readString(12,18)){var r=e.readCharCode(19)-49,n=e.readString(20,80).trim().split(/\s+/),i=parseInt(n[0],10);null!==this._matrix&&i===this._matrixIndex||(this._matrixIndex=i,this._matrix=t=new me.Matrix4,this.matrices[this.matrices.length]=t);var o=t.elements;o[r]=parseFloat(n[1]),o[4+r]=parseFloat(n[2]),o[8+r]=parseFloat(n[3]),o[12+r]=parseFloat(n[4])}}}]),e}();oa.prototype.id=290;var sa=Cr.Assembly,aa=function(){function t(e){W(this,t),this._complex=e,this.assemblies=[],this._assembly=null,this._matrix=null,this._matrixIndex=-1}return p(t,[{key:"parse",value:function(e){var t=this._assembly,r=this._matrix;if(t&&"  BIOMT"===e.readString(12,18)){var n=e.readCharCode(19)-49,i=e.readString(20,80).trim().split(/\s+/),o=parseInt(i[0],10);null!==this._matrix&&o===this._matrixIndex||(this._matrixIndex=o,this._matrix=r=new me.Matrix4,t.addMatrix(r));var s=r.elements;s[n]=parseFloat(i[1]),s[4+n]=parseFloat(i[2]),s[8+n]=parseFloat(i[3]),s[12+n]=parseFloat(i[4])}else if(t&&"CHAINS:"===e.readString(35,41))for(var a=e.readString(42,80).split(","),l=0,c=a.length;l<c;++l){var u=a[l].trim();0<u.length&&t.addChain(u)}else"BIOMOLECULE:"===e.readString(12,23)&&(this._matrix=null,this._matrixIndex=-1,this._assembly=t=new sa(this._complex),this.assemblies.push(t))}}]),t}();aa.prototype.id=350;var la=function(){function t(e){W(this,t),this._data=e,this._start=0,this._nextCR=-1,this._nextLF=-1,this._next=-1,this._end=e.length,this.next()}return p(t,[{key:"readLine",value:function(){return this._data.slice(this._start,this._next)}},{key:"readChar",value:function(e){return(e=this._start+e-1)<this._next?this._data[e]:" "}},{key:"readCharCode",value:function(e){return(e=this._start+e-1)<this._next?this._data.charCodeAt(e):32}},{key:"readString",value:function(e,t){var r=this._start+e-1,n=this._start+t;return this._data.slice(r,n<this._next?n:this._next)}},{key:"readInt",value:function(e,t){return parseInt(this.readString(e,t),10)}},{key:"readFloat",value:function(e,t){return parseFloat(this.readString(e,t))}},{key:"end",value:function(){return this._start>=this._end}},{key:"next",value:function(){var e=this._next+1;this._start=e<this._end?e:this._end,this._start>this._nextCR&&(this._nextCR=(this._data.indexOf("\r",this._start)+1||this._end+1)-1),this._start>this._nextLF&&(this._nextLF=(this._data.indexOf("\n",this._start)+1||this._end+1)-1),this._next=this._nextCR+1<this._nextLF?this._nextCR:this._nextLF}}]),t}(),ca=Cr.Complex,ua=Cr.Element,ha=Cr.Helix,da=Cr.Sheet,fa=Cr.Strand,pa=Cr.Bond,ma=Cr.Molecule;var _a=/^(HEADER\s|COMPND\s|REMARK\s|ATOM {2}|HETATM|MODEL )/i,va={290:oa,350:aa},ga=function(){function i(e,t){var r;return W(this,i),(r=Y(this,X(i).call(this,e,t)))._complex=null,r._chain=null,r._residue=null,r._sheet=null,r._serialAtomMap=null,r._modelId=1,r._compaundFound=!1,r._biomoleculeFound=!1,r._allowedChainsIDs=null,r._lastMolId=-1,r._remarks={},r._remark=null,r._molecules=[],r._molecule=null,r._compndCurrToken="",r._options.fileType="pdb",r}return A(i,ia),p(i,[{key:"_finalize",value:function(){this._fixBondsArray(),this._fixChains();var e=this._remarks[290];this._complex.symmetry=w.isUndefined(e)?[]:e.matrices;var t=this._remarks[350];this._complex.units=this._complex.units.concat(w.isUndefined(t)?[]:t.assemblies),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_finalizeMolecules",value:function(){var e,t={},r=this._complex._chains;for(e=0;e<r.length;++e){var n=r[e];t[n._name]=n}for(e=0;e<this._molecules.length;e++){for(var i=this._molecules[e],o=[],s=0;s<i._chains.length;s++){var a=t[i._chains[s]];o=o.concat(a._residues.slice())}var l=new ma(this._complex,i._name,e+1);l.residues=o,this._complex._molecules[e]=l}}},{key:"_fixChains",value:function(){for(var e={},t=this._complex,r=0;r<t._chains.length;r++){var n=t._chains[r];e[n._name.charCodeAt(0)]=n}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,r=t._atoms,n=0,i=r.length;n<i;++n){var o=r[n];e[o.serial]=o}for(var s=t._bonds,a=this.logger,l=0,c=s.length;l<c;++l){var u=s[l];u._right<u._left&&a.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseATOM",value:function(e){if(1===this._modelId){var t,r,n=72===e.readCharCode(1),i=n?e.readInt(7,11):e.readInt(6,11),o=e.readString(13,16),s=e.readChar(17),a=e.readString(18,20).trim(),l=e.readChar(22),c=e.readInt(23,26),u=e.readChar(27),h=e.readFloat(31,38),d=e.readFloat(39,46),f=e.readFloat(47,54),p=e.readFloat(55,60),m=e.readFloat(61,66),_=e.readString(77,78).trim()||(r=4===(t=o).trim().length,t.slice(0,r?1:2).trim()),v=e.readInt(79,80)||0;if(!this.settings.now.nowater||"HOH"!==a&&"WAT"!==a){o=o.trim();var g=ua.getByName(_),y=ua.Role[o],x=this._chain;x&&x.getName()===l||(this._chain=x=this._complex.getChain(l)||this._complex.addChain(l),this._residue=null);var b=this._residue;b&&b.getSequence()===c&&b.getICode()===u||(this._residue=b=x.addResidue(a,c,u));var w=new me.Vector3(h,d,f);b.addAtom(o,g,w,y,n,i,s,p,m,v)}}}},{key:"_parseENDMDL",value:function(){this._modelId+=1}},{key:"_parseCONECT",value:function(e){var t=e.readInt(7,11),r=e.readInt(12,16),n=e.readInt(17,21),i=e.readInt(22,26),o=e.readInt(27,31),s=this._complex;r&&t<r&&s.addBond(t,r,0,pa.BondType.UNKNOWN,!0),n&&t<n&&s.addBond(t,n,0,pa.BondType.UNKNOWN,!0),i&&t<i&&s.addBond(t,i,0,pa.BondType.UNKNOWN,!0),o&&t<o&&s.addBond(t,o,0,pa.BondType.UNKNOWN,!0)}},{key:"_parseCOMPND",value:function(e){var t=e.readString(11,80),r=t.indexOf(":");if(this._compndCurrToken=0<r?t.substring(0,r).trim():this._compndCurrToken,"MOL_ID"===this._compndCurrToken)this._molecule={_index:"",_chains:[]},this._molecule._index=parseInt(t.substring(r+1,t.indexOf(";")),10),this._molecules.push(this._molecule);else if("MOLECULE"===this._compndCurrToken&&null!=this._molecule)this._molecule._name=t.substring(r+1,t.indexOf(";")).trim();else if("CHAIN"===this._compndCurrToken&&null!=this._molecule){var n=t.substring(r+1,80).trim(),i=n[n.length-1];";"!==i&&","!==i||(n=n.slice(0,-1));var o=(n=n.replace(/\s+/g,"")).split(",");this._molecule._chains=this._molecule._chains.concat(o)}}},{key:"_parseREMARK",value:function(e){var t=e.readInt(8,10),r=this._remarks[t];if(w.isUndefined(r)){var n=va[t];w.isFunction(n)&&(this._remarks[t]=r=new n(this._complex))}w.isUndefined(r)||r.parse(e)}},{key:"_parseHELIX",value:function(e){var t=this;this._parseSTRUCTURE(e,[20,22,32,34],function(e){t._complex.addHelix(e),t._complex.structures.push(e)})}},{key:"_parseSHEET",value:function(e){var t=this;this._parseSTRUCTURE(e,[22,23,33,34],function(e){t._complex.addSheet(e)})}},{key:"_parseSTRUCTURE",value:function(e,t,r){var n=e.readInt(8,10),i=e.readString(12,14).trim(),o=e.readString(41,70).trim(),s=e.readInt(72,76),a=e.readInt(39,40),l=e.readInt(15,16),c=e.readInt(42,45),u=e.readInt(57,60),h=e.readString(t[0],t[2]+1).charCodeAt(0),d=e.readString(t[2],t[2]+1).charCodeAt(0),f=e.readInt(t[1],t[1]+3),p=e.readString(t[1]+4,t[1]+4),m=0;0<p.length&&(m=p.charCodeAt(0));var _,v=e.readInt(t[3],t[3]+3),g=0;0<(p=e.readString(t[3]+4,t[3]+4)).length&&(g=p.charCodeAt(0));var y=this._sheet;if(83===e.readCharCode(1)){null!==y&&y.getName()!==i&&(y=null,this._sheet=null),null===y?(this._sheet=_=new da(i,l),r(_)):_=y;var x=new fa(_,this._complex.getUnifiedSerial(h,f,m),this._complex.getUnifiedSerial(d,v,g),a,c,u);_.addStrand(x),this._complex.structures.push(x)}else r(_=new ha(a,this._complex.getUnifiedSerial(h,f,m),this._complex.getUnifiedSerial(d,v,g),n,i,o,s))}},{key:"_parseHEADER",value:function(e){var t=this._complex.metadata;t.classification=e.readString(11,50).trim(),t.date=e.readString(51,59).trim();var r=e.readString(63,66).trim();(t.id=r)&&(this._complex.name=r),t.format="pdb"}},{key:"_parseTITLE",value:function(e){var t=this._complex.metadata;t.title=t.title||[];var r=e.readInt(9,10)||1;t.title[r-1]=e.readString(11,80).trim()}},{key:"parseSync",value:function(){for(var e=new la(this._data),t=this._complex=new ca;!e.end();){var r=e.readString(1,6),n=i.tagParsers[r];w.isFunction(n)&&n.call(this,e),e.next()}if(this._finalize(),this._serialAtomMap=null,this._sheet=null,this._residue=null,this._chain=null,this._complex=null,0===t.getAtomCount())throw new Error("The data does not contain valid atoms");return t}}],[{key:"canProbablyParse",value:function(e){return w.isString(e)&&_a.test(e)}}]),i}();Ce(ga,"tagParsers",{HEADER:ga.prototype._parseHEADER,"TITLE ":ga.prototype._parseTITLE,"ATOM  ":ga.prototype._parseATOM,HETATM:ga.prototype._parseATOM,ENDMDL:ga.prototype._parseENDMDL,CONECT:ga.prototype._parseCONECT,COMPND:ga.prototype._parseCOMPND,REMARK:ga.prototype._parseREMARK,"HELIX ":ga.prototype._parseHELIX,"SHEET ":ga.prototype._parseSHEET,"ATOM 1":ga.prototype._parseATOM,"ATOM 2":ga.prototype._parseATOM,"ATOM 3":ga.prototype._parseATOM,"ATOM 4":ga.prototype._parseATOM,"ATOM 5":ga.prototype._parseATOM,"ATOM 6":ga.prototype._parseATOM,"ATOM 7":ga.prototype._parseATOM,"ATOM 8":ga.prototype._parseATOM,"ATOM 9":ga.prototype._parseATOM}),ga.formats=["pdb"],ga.extensions=[".pdb",".ent"];var ya=Cr.Complex,xa=Cr.Element,ba=Cr.SGroup,wa=Cr.Bond,Sa={A:0,S:1,D:2,T:3},Ca=/\s*<\?xml\b[^?>]*\?>\s*<(?:cml|molecule)\b/i,Aa=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._complex=null,r._residue=null,r._serialAtomMap=null,r._modelId=1,r._lastMolId=-1,r._readOnlyOneMolecule=!1,r._options.fileType="cml",r}return A(n,ia),p(n,[{key:"_rebuidBondIndexes",value:function(e,t){for(var r=e.length,n=0;n<r;n++)for(var i=e[n].id,o=t.length,s=0;s<o;s++){var a=t[s].atomRefs2.split(" ");a[0]===i&&(t[s].start=n),a[1]===i&&(t[s].end=n)}}},{key:"_createSGroup",value:function(e,t){var r=new ba(e.id,e.fieldData,new me.Vector3(parseFloat(e.x),parseFloat(e.y),0),e.atomRefs,e);"Relative"===e.placement&&(r._center=new me.Vector3(0,0,0)),"MDLBG_FRAGMENT_CHARGE"===e.fieldName&&(r._charge=parseInt(e.fieldData,10)||0),"MDLBG_FRAGMENT_COEFFICIENT"===e.fieldName&&(r._repeat=parseInt(e.fieldData,10)||1),t.push(r)}},{key:"_extractSGroup",value:function(e,t){if(Array.isArray(t)||(t=[]),e)if(Array.isArray(e))for(var r=e.length,n=0;n<r;n++)e[n].molecule&&(t=t.concat(this._extractSGroup(e[n].molecule))),this._createSGroup(e[n],t);else e.molecule&&e.molecule&&(t=t.concat(this._extractSGroup(e.molecule))),this._createSGroup(e,t);return t}},{key:"_extractSGroups",value:function(e,t){var r,n,i=this._extractSGroup(e),o=t.length;for(r=0;r<o;r++){var s=t[r].id;for(n=0;n<i.length;n++){i[n]._atoms.split(" ")[0]===s&&(t[r].sgroupRef||(t[r].sgroupRef=[]),t[r].sgroupRef.push(i[n]))}}var a,l={},c=null,u=new me.Vector3(1e8,1e8,1e8),h=new me.Vector3(-1e8,-1e8,-1e8);function d(e){(c=l[e])&&i[n]._atoms.push(c.a)}function f(e){(c=l[e])&&(u.set(Math.min(u.x,c.x),Math.min(u.y,c.y),Math.min(u.z,c.z)),h.set(Math.max(h.x,c.x),Math.max(h.y,c.y),Math.max(h.z,c.z)),d(e))}for(r=0;r<t.length;r++)l[t[r].id]={},l[t[r].id].x=t[r].x2,t[r].x3&&(l[t[r].id].x=t[r].x3),l[t[r].id].x=parseFloat(l[t[r].id].x),l[t[r].id].y=t[r].y2,t[r].y3&&(l[t[r].id].y=t[r].y3),l[t[r].id].y=parseFloat(l[t[r].id].y),l[t[r].id].z="0.0",t[r].z3&&(l[t[r].id].z=t[r].z3),l[t[r].id].z=parseFloat(l[t[r].id].z),l[t[r].id].a=t[r];for(n=0;n<i.length;n++)null!==i[n]._center?(u.set(1e8,1e8,1e8),h.set(-1e8,-1e8,-1e8),a=i[n]._atoms.split(" "),i[n]._atoms=[],a.forEach(f),i[n]._center.addVectors(u,h),i[n]._center.multiplyScalar(.5)):(a=i[n]._atoms.split(" "),i[n]._atoms=[],a.forEach(d));l=null}},{key:"_traverseData",value:function(e){var t={};return e.childNodes.length&&function e(t,r){if("#text"!==t.nodeName||""!==t.nodeValue.trim()){var n,i,o,s={},a=r[(s.xmlNode=t).nodeName];if(a?(n=a,"[object Array]"!==Object.prototype.toString.apply(n)?r[t.nodeName]=[a,s]:r[t.nodeName].push(s)):r[t.nodeName]=s,t.attributes)for(i=t.attributes.length,o=0;o<i;o++){var l=t.attributes[o];s[l.nodeName]=l.nodeValue}for(i=t.childNodes.length,o=0;o<i;o++)e(t.childNodes[o],s)}}(e.childNodes[0],t),t}},{key:"_findSuitableMolecule",value:function(e,t){for(var r in e)if("xmlNode"!==r)if("molecule"===r){if(e.molecule&&(e.molecule.atomArray&&e.molecule.atomArray.atom&&t.push(e),Array.isArray(e.molecule)))for(var n=0;n<e.molecule.length;n++)e.molecule[n].atomArray&&e.molecule[n].atomArray.atom&&t.push({molecule:e.molecule[n]})}else e[r]&&null!==e[r]&&"object"===x(e[r])&&this._findSuitableMolecule(e[r],t)}},{key:"_selectComponents",value:function(e){var t,m=(new DOMParser).parseFromString(e,"application/xml"),r=this._traverseData(m),_=this;t=r.cml?r.cml:r;var n=[],i=[];return this._findSuitableMolecule(t,i),this._readOnlyOneMolecule&&1<i.length&&i.splice(1,i.length-1),i.forEach(function(e){var t=function(e){var t,r=[];if(e.molecule&&e.molecule.atomArray&&e.molecule.atomArray.atom)Array.isArray(e.molecule.atomArray.atom)?r=e.molecule.atomArray.atom:r.push(e.molecule.atomArray.atom);else if(!e.molecule){var n={atomLabels:null,labelsCount:1};return n}e.molecule.molecule&&_._extractSGroups(e.molecule.molecule,r);for(var i=r.length,o=0;o<i;o++)(t=r[o]).edges=[];var s,a=[];e.molecule.bondArray&&e.molecule.bondArray.bond&&(Array.isArray(e.molecule.bondArray.bond)?a=e.molecule.bondArray.bond:a.push(e.molecule.bondArray.bond)),i=a.length,_._rebuidBondIndexes(r,a);for(var l=0;l<i;l++)if(s=a[l],(t=r[s.start])&&(t.edges.push(s.end),t=r[s.end])&&(t.edges.push(s.start),1)){var c=s.xmlNode.getAttribute("order"),u=parseInt(c,10);if(a[l].order=0,a[l].type=wa.BondType.UNKNOWN,1<u)a[l].order=u;else{var h=Sa[c];void 0!==h&&(a[l].order=h,"A"===c&&(a[l].type=wa.BondType.AROMATIC))}}i=r.length;for(var d=0;d<i;d++)(t=r[d]).edges.sort();var f=_._breadWidthSearch(r,0),p={};return p.atoms=r,p.bonds=a,p.labels=f.atomLabels,p.count=Math.min(1,f.labelsCount),p.curr=-1,p.originalCML=m,p}(e);0<t.atoms.length&&n.push(t)}),n}},{key:"_packLabel",value:function(e,t){return(t<<16)+e}},{key:"_unpackLabel",value:function(e){return{molId:e>>>16,compId:65535&e}}},{key:"_breadWidthSearch",value:function(e,t){var r,n=new Array(e.length);for(r=0;r<n.length;r++)n[r]=this._packLabel(0,t);for(var i=[],o=0,s=e.length;0<s;){o++;var a=-1;for(r=0;r<n.length;r++)if(0===this._unpackLabel(n[r]).compId){a=r;break}if(a<0)break;for(i.push(e[a]),n[a]=this._packLabel(o,t),s--;0<i.length;){var l=i.shift();if(l)for(var c=0;c<l.edges.length;c++)n[l.edges[c]]!==o&&(i.push(e[l.edges[c]]),n[l.edges[c]]=o,s--)}}var u={};return u.atomLabels=n,u.labelsCount=o,u}},{key:"_parseBond",value:function(e,t,r,n){if(0<=e){var i=[Math.min(e,t),Math.max(e,t)];this._complex.addBond(i[0],i[1],r,n,!0)}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,r=t._atoms,n=0,i=r.length;n<i;++n){var o=r[n];e[o.serial]=o}for(var s=t._bonds,a=this.logger,l=0,c=s.length;l<c;++l){var u=s[l];u._right<u._left&&a.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseSet",value:function(e){var t,r,n=this._complex=new ya,i=e,o=i.curr,s=i.atoms,a=i.labels,l=null,c=s.length;var u,h={},d=[];for(t=0;t<c;t++)d.push(t);for(d.sort(function(e,t){return a[e]-a[t]}),t=0;t<c;t++){var f=a[d[t]];if(this._unpackLabel(f).molId===this._unpackLabel(o).molId){var p=(l=s[d[t]]).elementType;if(l.sgroupRef)for(var m=l.sgroupRef.length,_=0;_<m;++_)n._sgroups.push(l.sgroupRef[_]);if(l.x3||l.x2){var v=this._unpackLabel(f).compId,g=v,y=v.toString();1===y.length&&(y="0".concat(y));var x="N".concat(y),b=h[" "];b&&" "===b.getName()||(h[" "]=b=this._complex.getChain(" ")||this._complex.addChain(" "),this._residue=null);var w=this._residue;w&&w.getSequence()===g&&" "===w.getICode()||(this._residue=w=b.addResidue(x,g," "));var S=null;l.x3?S=new me.Vector3(parseFloat(l.x3),parseFloat(l.y3),parseFloat(l.z3)):l.x2&&(S=new me.Vector3(parseFloat(l.x2),parseFloat(l.y2),0));var C=xa.ByName[l.elementType.toUpperCase()];C||((C=JSON.parse(JSON.stringify(xa.ByName[Object.keys(xa.ByName)[Object.keys(xa.ByName).length-1]]))).number+=1,C.name=l.elementType.toUpperCase(),C.fullName="Unknown",xa.ByName[l.elementType.toUpperCase()]=C);var A=parseInt(l.id.replace(/[^0-9]/,""),10),E=w.addAtom(p,C,S,xa.Role.SG,!0,A," ",1,0,0);l.hydrogenCount&&(E.hydrogenCount=parseInt(l.hydrogenCount,10)),l.mrvValence&&(E.valence=parseInt(l.mrvValence,10)),((u=E).xmlNodeRef=l).x2&&(l.x3=l.x2,delete l.x2),l.y2&&(l.y3=l.y2,delete l.y2),l.z3||(l.z3="0.0"),l.complexAtom=u}}}for(h=null,t=0;t<i.bonds.length;t++){var k=i.bonds[t];if(this._unpackLabel(a[k.start]).molId===this._unpackLabel(o).molId&&this._unpackLabel(a[k.end]).molId===this._unpackLabel(o).molId){if(!(l=s[k.start])||!s[k.end])continue;this._parseBond(parseInt(l.id.replace(/[^0-9]/,""),10),parseInt(s[k.end].id.replace(/[^0-9]/,""),10),k.order,k.type)}}for(t=0;t<this._complex.getSGroupCount();t++){var T=this._complex.getSGroups()[t];for(r=0;r<T._atoms.length;r++)T._atoms[r]=T._atoms[r].complexAtom}for(t=0;t<c;t++)this._unpackLabel(a[t]).molId===this._unpackLabel(o).molId&&((l=s[t]).complexAtom=null,delete l.complexAtom);return this._complex.originalCML=i.originalCML,this._fixBondsArray(),n.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._serialAtomMap=null,this._complex=null,n}},{key:"parseSync",value:function(){var r=[],n=this;this._selectComponents(this._data).forEach(function(e){e.curr=2,0===e.count&&(e.count=1);for(var t=0;t<e.count;t++)e.curr=t+1,r.push(n._parseSet(e,!1))});var t=0;if(r.forEach(function(e){t+=e.getAtomCount()}),t<=0)throw new Error("The data does not contain valid atoms");if(1<r.length){var e=new ya;return e.joinComplexes(r),e.originalCML=r[0].originalCML,e}return 1===r.length?r[0]:new ya}}],[{key:"canProbablyParse",value:function(e){return w.isString(e)&&Ca.test(e)}}]),n}();Aa.formats=["cml"],Aa.extensions=[".cml"];var Ea=g(function(e,t){function d(e,t,r){for(var n=(e.byteLength,0),i=r.length;n<i;n++){var o=r.charCodeAt(n);if(o<128)e.setUint8(t++,o>>>0&127|0);else if(o<2048)e.setUint8(t++,o>>>6&31|192),e.setUint8(t++,o>>>0&63|128);else if(o<65536)e.setUint8(t++,o>>>12&15|224),e.setUint8(t++,o>>>6&63|128),e.setUint8(t++,o>>>0&63|128);else{if(!(o<1114112))throw new Error("bad codepoint "+o);e.setUint8(t++,o>>>18&7|240),e.setUint8(t++,o>>>12&63|128),e.setUint8(t++,o>>>6&63|128),e.setUint8(t++,o>>>0&63|128)}}}function f(e){for(var t=0,r=0,n=e.length;r<n;r++){var i=e.charCodeAt(r);if(i<128)t+=1;else if(i<2048)t+=2;else if(i<65536)t+=3;else{if(!(i<1114112))throw new Error("bad codepoint "+i);t+=4}}return t}function r(e){var t=new ArrayBuffer(function e(t){var r=typeof t;if("string"==r){if((n=f(t))<32)return 1+n;if(n<256)return 2+n;if(n<65536)return 3+n;if(n<4294967296)return 5+n}if(t instanceof Uint8Array){if((n=t.byteLength)<256)return 2+n;if(n<65536)return 3+n;if(n<4294967296)return 5+n}if("number"==r){if(Math.floor(t)!==t)return 9;if(0<=t){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return 1;if(-128<=t)return 2;if(-32768<=t)return 3;if(-2147483648<=t)return 5;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"==r||null===t)return 1;if("object"!=r)throw new Error("Unknown type "+r);var n,i=0;if(Array.isArray(t)){n=t.length;for(var o=0;o<n;o++)i+=e(t[o])}else{var s=Object.keys(t);for(n=s.length,o=0;o<n;o++){var a=s[o];i+=e(a)+e(t[a])}}if(n<16)return 1+i;if(n<65536)return 3+i;if(n<4294967296)return 5+i;throw new Error("Array or object too long 0x"+n.toString(16))}(e));return function e(t,r,n){var i=typeof t;if("string"==i){if((o=f(t))<32)return r.setUint8(n,160|o),d(r,n+1,t),1+o;if(o<256)return r.setUint8(n,217),r.setUint8(n+1,o),d(r,n+2,t),2+o;if(o<65536)return r.setUint8(n,218),r.setUint16(n+1,o),d(r,n+3,t),3+o;if(o<4294967296)return r.setUint8(n,219),r.setUint32(n+1,o),d(r,n+5,t),5+o}if(t instanceof Uint8Array){var o=t.byteLength,s=new Uint8Array(r.buffer);if(o<256)return r.setUint8(n,196),r.setUint8(n+1,o),s.set(t,n+2),2+o;if(o<65536)return r.setUint8(n,197),r.setUint16(n+1,o),s.set(t,n+3),3+o;if(o<4294967296)return r.setUint8(n,198),r.setUint32(n+1,o),s.set(t,n+5),5+o}if("number"==i){if(!isFinite(t))throw new Error("Number not finite: "+t);if(Math.floor(t)!==t)return r.setUint8(n,203),r.setFloat64(n+1,t),9;if(0<=t){if(t<128)return r.setUint8(n,t),1;if(t<256)return r.setUint8(n,204),r.setUint8(n+1,t),2;if(t<65536)return r.setUint8(n,205),r.setUint16(n+1,t),3;if(t<4294967296)return r.setUint8(n,206),r.setUint32(n+1,t),5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return r.setInt8(n,t),1;if(-128<=t)return r.setUint8(n,208),r.setInt8(n+1,t),2;if(-32768<=t)return r.setUint8(n,209),r.setInt16(n+1,t),3;if(-2147483648<=t)return r.setUint8(n,210),r.setInt32(n+1,t),5;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(null===t)return r.setUint8(n,192),1;if("boolean"==i)return r.setUint8(n,t?195:194),1;if("object"!=i)throw new Error("Unknown type "+i);var a=0,l=Array.isArray(t);if(l)o=t.length;else{var c=Object.keys(t);o=c.length}if(o<16?(r.setUint8(n,o|(l?144:128)),a=1):o<65536?(r.setUint8(n,l?220:222),r.setUint16(n+1,o),a=3):o<4294967296&&(r.setUint8(n,l?221:223),r.setUint32(n+1,o),a=5),l)for(var u=0;u<o;u++)a+=e(t[u],r,n+a);else for(u=0;u<o;u++){var h=c[u];a+=e(h,r,n+a),a+=e(t[h],r,n+a)}return a}(e,new DataView(t),0),new Uint8Array(t)}function a(e,t,r){return t?new e(t.buffer,t.byteOffset,t.byteLength/(r||1)):void 0}function h(e){return a(DataView,e)}function l(e){return a(Uint8Array,e)}function c(e){return a(Int8Array,e)}function u(e){return a(Int32Array,e,4)}function p(e,t){var r=e.length/2;t=t||new Int16Array(r);for(var n=0,i=0;n<r;++n,i+=2)t[n]=e[i]<<8^e[i+1]<<0;return t}function m(e,t){var r=e.length/4;t=t||new Int32Array(r);for(var n=0,i=0;n<r;++n,i+=4)t[n]=e[i]<<24^e[i+1]<<16^e[i+2]<<8^e[i+3]<<0;return t}function n(e,t){for(var r=e.length,n=h(t=t||new Uint8Array(4*r)),i=0;i<r;++i)n.setInt32(4*i,e[i]);return l(t)}function _(e,t,r){var n=e.length,i=1/t;r=r||new Float32Array(n);for(var o=0;o<n;++o)r[o]=e[o]*i;return r}function i(e,t,r){var n=e.length;r=r||new Int32Array(n);for(var i=0;i<n;++i)r[i]=Math.round(e[i]*t);return r}function v(e,t){var r,n;if(!t){var i=0;for(r=0,n=e.length;r<n;r+=2)i+=e[r+1];t=new e.constructor(i)}var o=0;for(r=0,n=e.length;r<n;r+=2)for(var s=e[r],a=e[r+1],l=0;l<a;++l)t[o]=s,++o;return t}function o(e){if(0===e.length)return new Int32Array;var t,r,n=2;for(t=1,r=e.length;t<r;++t)e[t-1]!==e[t]&&(n+=2);var i=new Int32Array(n),o=0,s=1;for(t=1,r=e.length;t<r;++t)e[t-1]!==e[t]?(i[o]=e[t-1],i[o+1]=s,s=1,o+=2):++s;return i[o]=e[e.length-1],i[o+1]=s,i}function g(e,t){var r=e.length;t=t||new e.constructor(r),r&&(t[0]=e[0]);for(var n=1;n<r;++n)t[n]=e[n]+t[n-1];return t}function s(e,t){var r=e.length;(t=t||new e.constructor(r))[0]=e[0];for(var n=1;n<r;++n)t[n]=e[n]-e[n-1];return t}function y(e,t){var r,n,i=e instanceof Int8Array?127:32767,o=-i-1,s=e.length;if(!t){var a=0;for(r=0;r<s;++r)e[r]<i&&e[r]>o&&++a;t=new Int32Array(a)}for(n=r=0;r<s;){for(var l=0;e[r]===i||e[r]===o;)l+=e[r],++r;l+=e[r],++r,t[n]=l,++n}return t}function x(e,t,r){return _(y(e,u(r)),t,r)}function b(e,t,r){var n,i,o,s=y(e,u(r));return i=t,o=a(Float32Array,n=s,4),_(g(n,u(o)),i,o)}function w(e,t,r){return function(e,t){var r,n=t?127:32767,i=-n-1,o=e.length,s=0;for(r=0;r<o;++r){0===(c=e[r])?++s:s+=c===n||c===i?2:0<c?Math.ceil(c/n):Math.ceil(c/i)}var a=new(t?Int8Array:Int16Array)(s),l=0;for(r=0;r<o;++r){var c;if(0<=(c=e[r]))for(;n<=c;)a[l]=n,++l,c-=n;else for(;c<=i;)a[l]=i,++l,c-=i;a[l]=c,++l}return a}(s(i(e,t),n),r);var n}function S(e,t,r,n){var i=new ArrayBuffer(12+n.byteLength),o=new Uint8Array(i),s=new DataView(i);return s.setInt32(0,e),s.setInt32(4,t),r&&o.set(r,8),o.set(n,12),o}function C(e){return S(2,e.length,void 0,l(e))}function A(e){return S(4,e.length,void 0,n(e))}function E(e,t){return S(5,e.length/t,n([t]),l(e))}function k(e){return S(6,e.length,void 0,n(o(e)))}function T(e){return S(8,e.length,void 0,n(o(s(e))))}function R(e,t){return S(9,e.length,n([t]),n(o(i(e,t))))}function M(e,t){return S(10,e.length,n([t]),function(e,t){for(var r=e.length,n=h(t=t||new Uint8Array(2*r)),i=0;i<r;++i)n.setInt16(2*i,e[i]);return l(t)}(w(e,t)))}function P(t){var r={};return z.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),t.bondAtomList&&(r.bondAtomList=A(t.bondAtomList)),t.bondOrderList&&(r.bondOrderList=C(t.bondOrderList)),r.xCoordList=M(t.xCoordList,1e3),r.yCoordList=M(t.yCoordList,1e3),r.zCoordList=M(t.zCoordList,1e3),t.bFactorList&&(r.bFactorList=M(t.bFactorList,100)),t.atomIdList&&(r.atomIdList=T(t.atomIdList)),t.altLocList&&(r.altLocList=k(t.altLocList)),t.occupancyList&&(r.occupancyList=R(t.occupancyList,100)),r.groupIdList=T(t.groupIdList),r.groupTypeList=A(t.groupTypeList),t.secStructList&&(r.secStructList=C(t.secStructList)),t.insCodeList&&(r.insCodeList=k(t.insCodeList)),t.sequenceIndexList&&(r.sequenceIndexList=T(t.sequenceIndexList)),r.chainIdList=E(t.chainIdList,4),t.chainNameList&&(r.chainNameList=E(t.chainNameList,4)),r}function N(i){function n(e){for(var t={},r=0;r<e;r++){t[l()]=l()}return t}function o(e){var t=i.subarray(c,c+e);return c+=e,t}function s(e){var t=i.subarray(c,c+e);c+=e;if(65535<e){for(var r=[],n=0;n<t.length;n+=65535)r.push(String.fromCharCode.apply(null,t.subarray(n,n+65535)));return r.join("")}return String.fromCharCode.apply(null,t)}function a(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=l();return t}function l(){var e,t,r=i[c];if(0==(128&r))return c++,r;if(128==(240&r))return c++,n(t=15&r);if(144==(240&r))return c++,a(t=15&r);if(160==(224&r))return c++,s(t=31&r);if(224==(224&r))return e=u.getInt8(c),c++,e;switch(r){case 192:return c++,null;case 194:return c++,!1;case 195:return c++,!0;case 196:return t=u.getUint8(c+1),c+=2,o(t);case 197:return t=u.getUint16(c+1),c+=3,o(t);case 198:return t=u.getUint32(c+1),c+=5,o(t);case 202:return e=u.getFloat32(c+1),c+=5,e;case 203:return e=u.getFloat64(c+1),c+=9,e;case 204:return e=i[c+1],c+=2,e;case 205:return e=u.getUint16(c+1),c+=3,e;case 206:return e=u.getUint32(c+1),c+=5,e;case 208:return e=u.getInt8(c+1),c+=2,e;case 209:return e=u.getInt16(c+1),c+=3,e;case 210:return e=u.getInt32(c+1),c+=5,e;case 217:return t=u.getUint8(c+1),c+=2,s(t);case 218:return t=u.getUint16(c+1),c+=3,s(t);case 219:return t=u.getUint32(c+1),c+=5,s(t);case 220:return t=u.getUint16(c+1),c+=3,a(t);case 221:return t=u.getUint32(c+1),c+=5,a(t);case 222:return t=u.getUint16(c+1),c+=3,n(t);case 223:return t=u.getUint32(c+1),c+=5,n(t)}throw new Error("Unknown type 0x"+r.toString(16))}var c=0,u=new DataView(i.buffer);return l()}function I(e,t,r,n){switch(e){case 1:return function(e,t){for(var r=e.length,n=h(t=t||new Float32Array(r/4)),i=h(e),o=0,s=0,a=r/4;o<a;++o,s+=4)n.setFloat32(s,i.getFloat32(s),!0);return t}(t);case 2:return c(t);case 3:return p(t);case 4:return m(t);case 5:return l(t);case 6:return v(m(t),new Uint8Array(r));case 7:return v(m(t));case 8:return g(v(m(t)),a);case 9:return i=m(t),o=m(n)[0],_(v(i,u(s)),o,s);case 10:return b(p(t),m(n)[0]);case 11:return _(p(t),m(n)[0]);case 12:return x(p(t),m(n)[0]);case 13:return x(c(t),m(n)[0]);case 14:return y(p(t));case 15:return y(c(t))}var i,o,s,a}function L(l,e){var c=(e=e||{}).ignoreFields,u={};return F.forEach(function(e){var t,r,n,i,o,s=!!c&&-1!==c.indexOf(e),a=l[e];s||void 0===a||(a instanceof Uint8Array?u[e]=I.apply(null,(r=h(t=a),n=r.getInt32(0),i=r.getInt32(4),o=t.subarray(8,12),[n,t=t.subarray(12),i,o])):u[e]=a)}),u}function X(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function O(e,t){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),L(e instanceof Uint8Array?N(e):e,t)}function V(e,t,r,n){var i=new XMLHttpRequest;i.addEventListener("load",function(){try{var e=O(i.response);r(e)}catch(e){n(e)}},!0),i.addEventListener("error",n,!0),i.responseType="arraybuffer",i.open("GET",t+e.toUpperCase()),i.send()}var D,z,F,B,U,G;D=t,F=(z=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"]).concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]),U=(B="//mmtf.rcsb.org/v1.0/")+"full/",G=B+"reduced/",D.encode=function(e){return r(P(e))},D.decode=O,D.traverse=function(e,t,r){var n,i,o,s,a,l,c=(r=r||{}).firstModelOnly,u=t.onModel,h=t.onChain,d=t.onGroup,f=t.onAtom,p=t.onBond,m=0,_=0,v=0,g=0,y=0,x=-1,b=e.chainNameList,w=e.secStructList,S=e.insCodeList,C=e.sequenceIndexList,A=e.atomIdList,E=e.bFactorList,k=e.altLocList,T=e.occupancyList,R=e.bondAtomList,M=e.bondOrderList;for(n=0,i=e.chainsPerModel.length;n<i&&!(c&&0<m);++n){var P=e.chainsPerModel[m];for(u&&u({chainCount:P,modelIndex:m}),o=0;o<P;++o){var N=e.groupsPerChain[_];if(h){var I=X(e.chainIdList.subarray(4*_,4*_+4)),L=null;b&&(L=X(b.subarray(4*_,4*_+4))),h({groupCount:N,chainIndex:_,modelIndex:m,chainId:I,chainName:L})}for(s=0;s<N;++s){var O=e.groupList[e.groupTypeList[v]],V=O.atomNameList.length;if(d){var D=null;w&&(D=w[v]);var z=null;e.insCodeList&&(z=String.fromCharCode(S[v]));var F=null;C&&(F=C[v]),d({atomCount:V,groupIndex:v,chainIndex:_,modelIndex:m,groupId:e.groupIdList[v],groupType:e.groupTypeList[v],groupName:O.groupName,singleLetterCode:O.singleLetterCode,chemCompType:O.chemCompType,secStruct:D,insCode:z,sequenceIndex:F})}for(a=0;a<V;++a){if(f){var B=null;A&&(B=A[g]);var U=null;E&&(U=E[g]);var G=null;k&&(G=String.fromCharCode(k[g]));var j=null;T&&(j=T[g]),f({atomIndex:g,groupIndex:v,chainIndex:_,modelIndex:m,atomId:B,element:O.elementList[a],atomName:O.atomNameList[a],formalCharge:O.formalChargeList[a],xCoord:e.xCoordList[g],yCoord:e.yCoordList[g],zCoord:e.zCoordList[g],bFactor:U,altLoc:G,occupancy:j})}g+=1}if(p){var H=O.bondAtomList;for(a=0,l=O.bondOrderList.length;a<l;++a)p({atomIndex1:g-V+H[2*a],atomIndex2:g-V+H[2*a+1],bondOrder:O.bondOrderList[a]})}v+=1}_+=1}if(y=x+1,x=g-1,p&&R)for(a=0,l=R.length;a<l;a+=2){var W=R[a],Y=R[a+1];(y<=W&&W<=x||y<=Y&&Y<=x)&&p({atomIndex1:W,atomIndex2:Y,bondOrder:M?M[a/2]:null})}m+=1}},D.fetch=function(e,t,r){V(e,U,t,r)},D.fetchReduced=function(e,t,r){V(e,G,t,r)},D.version="v1.1.0dev",D.fetchUrl=U,D.fetchReducedUrl=G,D.encodeMsgpack=r,D.encodeMmtf=P,D.decodeMsgpack=N,D.decodeMmtf=L}),ka=Cr.Complex,Ta=Cr.Chain,Ra=Cr.Atom,Ma=Cr.Element,Pa=Cr.Helix,Na=Cr.Sheet,Ia=Cr.Strand,La=Cr.Bond,Oa=Cr.Assembly,Va=Cr.Molecule,Da=function(){function r(e){W(this,r),this._original=Array.from(e),this._original.sort();for(var t=this._sum=0;t<this._original.length;++t)this._sum+=this._original[t]}return p(r,[{key:"compare",value:function(e){var t=e.length;if(t!==this._original.length)return!1;var r,n=0;for(r=0;r<t;++r)n+=e[r];if(n!==this._sum)return!1;var i=Array.from(e);for(i.sort(),r=0;r<t;++r)if(i[r]!==this._original[r])return!1;return!0}}]),r}();Da.prototype.constructor=Da;var za=He.Type,Fa=[za.HELIX_PI,za.BEND,za.HELIX_ALPHA,za.STRAND,za.HELIX_310,za.BRIDGE,za.TURN,za.COIL];var Ba=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._options.fileType="mmtf",r}return A(n,ia),p(n,[{key:"_onModel",value:function(){}},{key:"_onChain",value:function(e){if(0===e.modelIndex){var t=new Ta(this._complex,e.chainName);(this._complex._chains[e.chainIndex]=t)._index=e.chainIndex}}},{key:"_onGroup",value:function(e){if(0===e.modelIndex&&(!this.settings.now.nowater||"HOH"!==e.groupName&&"WAT"!==e.groupName)){var t=this._complex._chains[e.chainIndex],r=e.insCode.charCodeAt(0)?e.insCode:"",n=t.addResidue(e.groupName,e.groupId,r);n._index=e.groupIndex,this._updateSecStructure(this._complex,n,e)}}},{key:"_onAtom",value:function(e){if(0===e.modelIndex){var t=e.altLoc.charCodeAt(0)?e.altLoc:"",r=new Ra(e.groupIndex,e.atomName,Ma.getByName(e.element.toUpperCase()),new me.Vector3(e.xCoord,e.yCoord,e.zCoord),Ma.Role[e.atomName],!1,e.atomId,t,e.occupancy,e.bFactor,e.formalCharge);(this._complex._atoms[e.atomIndex]=r).index=e.atomIndex,this._serialAtomMap[e.atomId]=r}}},{key:"_onBond",value:function(e){var t=Math.max(e.atomIndex1,e.atomIndex2);if(!(t>=this._complex._atoms.length)){var r=Math.min(e.atomIndex1,e.atomIndex2);this._complex.addBond(this._complex._atoms[r],this._complex._atoms[t],e.bondOrder,La.BondType.UNKNOWN,!0)}}},{key:"_updateSecStructure",value:function(e,t,r){if(!w.isUndefined(r)&&r.secStruct===this._ssType)return t._secondary=this._ssStruct,void(this._ssStruct&&(this._ssStruct.term=t));if(!w.isUndefined(r)){var n=Fa[r.secStruct];this._ssType=r.secStruct,this._ssStart=t;var i=null;switch(this._ssType){case-1:case 7:break;case 0:case 2:case 4:i=new Pa([3,-1,1,-1,5][this._ssType],t,t,0,"","",0),e._helices.push(i);break;case 3:var o=new Na("",0);e._sheets.push(o),i=new Ia(o,t,t,0,null,null);break;default:void 0!==n&&(i=new He(n,t,t))}this._ssStruct=i,(t._secondary=i)&&e.structures.push(i)}}},{key:"_updateMolecules",value:function(e){var t=e.entityList;if(t)for(var r=e.chainsPerModel[0],n=0;n<t.length;n++){for(var i=t[n],o=i.chainIndexList,s=[],a=0;a<o.length;a++){var l=o[a];if(!(r<=l)){var c=this._complex._chains[l];s=s.concat(c._residues.slice())}}var u=new Va(this._complex,i.description,n+1);u.residues=s,this._complex._molecules[n]=u}}},{key:"_traverse",value:function(e){var t=this,r=this._complex.metadata;r.id=e.structureId,r.title=[],r.title[0]=e.title,r.date=e.releaseDate,r.format="mmtf";var n={onModel:function(e){t._onModel(e)},onChain:function(e){t._onChain(e)},onGroup:function(e){t._onGroup(e)},onAtom:function(e){t._onAtom(e)},onBond:function(e){t._onBond(e)}};this._ssType=-1,this._ssStruct=null,this._ssStart=null,Ea.traverse(e,n),this._updateSecStructure(this._complex),this._updateMolecules(e)}},{key:"_linkAtomsToResidues",value:function(){for(var e=0;e<this._complex._atoms.length;++e){var t=this._complex._atoms[e],r=this._complex._residues[t.residue];(t.residue=r)._atoms.push(t)}}},{key:"_findSynonymousChains",value:function(){for(var e={},t=0;t<this._complex._chains.length;++t){var r=this._complex._chains[t],n=r.getName();e.hasOwnProperty(n)||(e[n]=[]),e[n].push(r._index)}return e}},{key:"_parseAssemblyInfo",value:function(e){var t,r,n,i=[],o=this.logger;for(t=0;t<e.bioAssemblyList.length;++t){var s=e.bioAssemblyList[t];if(0!==s.transformList.length){var a=s.transformList[0].chainIndexList,l=new Da(a),c={};for(r=0;r<a.length;++r)c[this._complex._chains[a[r]].getName()]=1;var u=[],h=void 0;for(h in c)c.hasOwnProperty(h)&&Array.prototype.push.apply(u,this._chainsByName[h]);l.compare(u)||o.debug("MMTF: Assembly is missing some of the synonymous chains. Skipping...");var d=new Oa(this._complex);for(h in c)c.hasOwnProperty(h)&&d.addChain(h);for(d.addMatrix((new me.Matrix4).fromArray(s.transformList[0].matrix).transpose()),r=1;r<s.transformList.length;++r){var f=s.transformList[r];if(l.compare(f.chainIndexList)){var p=(new me.Matrix4).fromArray(f.matrix).transpose();for(n=0;n<d.matrices.length&&!d.matrices[n].equals(p);++n);n===d.matrices.length&&d.addMatrix(p)}else o.debug("MMTF: Chain lists differ for different transforms in one assembly. Skipping...")}d.finalize(),i.push(d)}}return i}},{key:"_markHeteroAtoms",value:function(e){for(var t=e.chainsPerModel[0],r=0;r<e.entityList.length;++r){var n=e.entityList[r];if("polymer"!==n.type)for(var i=0;i<n.chainIndexList.length;++i){var o=n.chainIndexList[i];if(!(t<=o))for(var s=this._complex._chains[o],a=0;a<s._residues.length;++a)for(var l=s._residues[a],c=0;c<l._atoms.length;++c)l._atoms[c].het=!0}}}},{key:"_joinSynonymousChains",value:function(){var e,t,r=[],n={};for(e=0;e<this._complex._chains.length;++e){var i=this._complex._chains[e],o=i.getName();if(n.hasOwnProperty(o)){var s=n[o];for(t=0;t<i._residues.length;++t){var a=i._residues[t];s._residues.push(a),a._chain=s}}else(n[o]=i)._index=r.length,r.push(i)}this._complex._chains=r}},{key:"parseSync",value:function(){var e=Ea.decode(this._data);return this._complex=new ka,this._serialAtomMap={},this._traverse(e),this._linkAtomsToResidues(),this._markHeteroAtoms(e),this._chainsByName=this._findSynonymousChains(),Array.prototype.push.apply(this._complex.units,this._parseAssemblyInfo(e)),this._joinSynonymousChains(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex}}],[{key:"canProbablyParse",value:function(e){return w.isArrayBuffer(e)&&223==(1|new Uint8Array(e,0,1)[0])}}]),n}();Ba.formats=["mmtf"],Ba.extensions=[".mmtf"],Ba.binary=!0;var Ua=function(e){function i(e,t,r){var n;return W(this,i),n=Y(this,X(i).call(this,"data:".concat(t,":").concat(r,": ").concat(e))),Error.captureStackTrace&&Error.captureStackTrace(S(n),i),n.name="ParsingError",n.parseLine=t,n.parseColumn=r,n}return A(i,e),i}(k(Error));function Ga(e){return 32===e||10===e||13===e||9===e}function ja(e,t,r){for(var n=t.length,i=-1;r<n&&(i=t.charCodeAt(r))!==e&&10!==i;)++r;return i===e?r:-1}var Ha=Cr.Complex,Wa=Cr.Element,Ya=Cr.Helix,Xa=Cr.Sheet,qa=Cr.Strand,$a=Cr.Assembly,Za=Cr.Molecule,Ka=["auth_seq_id","Cartn_x","Cartn_y","Cartn_z","label_atom_id"],Qa={helx:"helix",turn:"turn",strn:"strand"};function Ja(e){return null==e||w.isArray(e)?e:[e]}var el=function(e){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this))).name="AtomDataError",t.message=e,t}return A(r,e),r}(k(Error));function tl(e,t){for(var r=(e=w.isString(e)?e:"".concat(e)).replace(/\)\s*\(/g,"!").replace(/[()']/g,"").split("!"),s=[],n=0,i=r.length;n<i;++n){for(var o=r[n].split(","),a=[],l=0,c=0,u=o.length;c<u;++c){var h=o[c];if(h.includes("-"))for(var d=h.split("-"),f=parseInt(d[0],10),p=parseInt(d[1],10);f<=p;++f)a[l++]=t[f];else a[l++]=t[h]}s.push(a)}var m=[],_=0;return function e(t,r){for(var n=0,i=s[t].length;n<i;++n){var o=r?r.clone():new me.Matrix4;o.multiplyMatrices(s[t][n],o),0===t?m[_++]=o:e(t-1,o)}}(s.length-1),m}var rl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t))).asymDict={},r.molecules=[],r._options.fileType="cif",r}return A(n,ia),p(n,[{key:"parseSync",value:function(){this.logger.info("Parsing CIF file..");var e=function(n){var e,t,r,i,o=0,s=0,a=n.length,l=NaN,c=!0,u=1,h=1,d=0,f={},p={},m=[],_=0,v="",g=[],y=0;function x(){var e;if((46===l||63===l)&&(a<=o+1||Ga(n.charCodeAt(o+1))))return++h,void++o;if(c&&59===l){s=o;var t=0;do{if(-1===(s=ja(10,n,s+1)))throw new Ua("Unterminated text block found",u,h);++t}while(s+1<a&&n.charCodeAt(s+1)!==l||a<=s+1);return e=n.substring(o+1,s).replace(/\r/g,""),o=s+2,u+=t,c=!(h=1),e}if(39===l||34===l){s=o;do{if(-1===(s=ja(l,n,s+1)))throw new Ua("Unterminated quoted string found",u,h)}while(s+1<a&&!Ga(n.charCodeAt(s+1)));return e=n.substring(o+1,s),h+=s-o+1,o=s+1,e}for(s=o;s<a&&!Ga(n.charCodeAt(s));)++s;e=n.substring(o,s),h+=s-o,o=s;var r=Number(e);return Number.isNaN(r)?e:r}for(;o<=a;){if(13!==(l=n.charCodeAt(o)))if(10===l)c=!0,++u,h=1;else{if(32!==l&&9!==l){if(35===l){if(-1===(o=ja(10,n,o+1)))break;continue}if(0===d){if(68!==l&&100!==l||"ata_"!==n.substr(o+1,4).toLowerCase()){if(Number.isNaN(l))break;throw new Ua("Unexpected character in state ".concat(d),u,h)}for(e=s=o+5;s<a&&!Ga(n.charCodeAt(s));)++s;if(h+=s-o,e<(o=s)){f[n.substring(e,o)]=p={},d=1;continue}throw new Ua("Data block name missing",u,h)}if(1===d){if(68!==l&&100!==l||"ata_"!==n.substr(o+1,4).toLowerCase()){if(95===l){for(e=s=o+1;s<a&&!Ga(n.charCodeAt(s));)++s;if(h+=s-o,e<(o=s)){v=n.substring(e,o),d=2;continue}throw new Ua("Tag name missing",u,h)}if(76!==l&&108!==l||"oop_"!==n.substr(o+1,4).toLowerCase()){if(Number.isNaN(l))break;throw new Ua("Unexpected character in state ".concat(d),u,h)}if(h+=5,(o+=5)<a&&!Ga(n.charCodeAt(o)))throw new Ua("Unexpected character in state ".concat(d),u,h);m=[],g=[],y=_=0,d=3;continue}d=0;continue}if(2===d){if(Number.isNaN(l))break;t=x(),w.set(p,v,t),d=1;continue}if(3===d){if(95===l){for(e=s=o+1;s<a&&!Ga(n.charCodeAt(s));)++s;if(h+=s-o,e<(o=s)){i=n.substring(e,o),m[_++]=i;continue}throw new Ua("Tag name missing",u,h)}if(0<_){for(var b=0;b<_;++b)t=[],g[b]=t,w.set(p,m[b],t);d=4;continue}throw new Ua("Data tags are missing inside a loop",u,h)}if(4!==d)throw new Ua("Unexpected internal state ".concat(d),u,h);68!==l&&100!==l||"ata_"!==n.substr(o+1,4).toLowerCase()?95!==l&&(76!==l&&108!==l||"oop_"!==n.substr(o+1,4).toLowerCase())?Number.isNaN(l)?d=0:(r=x(),g[y%_].push(r),++y):d=1:d=0;continue}c=!1,++h}++o}if(2===d)throw new Ua("Unexpected end of file in state ".concat(d),u,h);return f}(this._data);return this._toComplex(e)}},{key:"_toComplex",value:function(e){var t=new Ha,r=e[Object.keys(e)[0]];return this._extractAtoms(t,r),this._extractSecondary(t,r),this._extractAssemblies(t,r),this._extractMolecules(t,r),this._extractMetadata(t,r),t.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing}),t}},{key:"_extractMetadata",value:function(e,t){var r=e.metadata;r.id=t.entry.id,r.classification=t.struct_keywords.pdbx_keywords;var n=t.database_PDB_rev;r.date=n&&n.date_original?n.date_original:"",r.format="cif",r.title=[],r.title[0]=t.struct.title}},{key:"_extractMolecules",value:function(e,t){var r,n=Ja(t.entity.pdbx_description),i=n.length;for(r=0;r<i;r++)this.molecules[r].name=n[r];var o=e.getMolecules();for(r=0;r<i;r++){var s=this.molecules[r];o[r]=new Za(e,s.name,r+1),o[r].residues=s.residues}}},{key:"_extractAtoms",value:function(e,t){var r=t.atom_site;if(!r)throw new el("CIF parsing error: atom_site is not specified!");for(var n=0,i=Ka.length;n<i;++n)if(!r[Ka[n]])throw new el("CIF parsing error: requires field ".concat(Ka[n]," not found!"));for(var o,s,a=this.asymDict,l=Ja(r.auth_seq_id),c=Ja(r.Cartn_x),u=Ja(r.Cartn_y),h=Ja(r.Cartn_z),d=Ja(r.label_atom_id),f=d.length,p=Ja(r.group_PDB)||[],m=Ja(r.auth_asym_id)||[],_=Ja(r.label_asym_id)||[],v=Ja(r.id)||[],g=Ja(r.pdbx_PDB_ins_code)||[],y=Ja(r.label_comp_id)||[],x=Ja(r.type_symbol)||[],b=Ja(r.B_iso_or_equiv)||[],w=Ja(r.occupancy)||[],S=Ja(r.pdbx_formal_charge)||[],C=Ja(r.label_alt_id)||[],A=Ja(r.pdbx_PDB_model_num)||[],E=Ja(r.label_entity_id)||[],k=null,T=null,R=0;R<f;++R){if(1===(A[R]||1)){var M=String(m[R]||" ");k&&k.getName()===M||(k=e.getChain(M)||e.addChain(M)),a[String(_[R]||" ")]=M;var P=l[R],N=String(g[R]||" "),I=String(y[R]||"");if(!T||T.getSequence()!==P||T.getICode()!==N){T=k.addResidue(I,P,N);var L=E[R]-1,O=this.molecules[L];O||(this.molecules[L]={name:"",residues:[]},O=this.molecules[L]),O.residues.push(T)}var V=d[R],D=x[R]||(s=4===(o=V).trim().length,o.slice(0,s?1:2).trim()),z=Wa.getByName(D),F=Wa.Role[V.trim()],B=new me.Vector3(c[R],u[R],h[R]),U="HETATM"===p[R]||!1,G=v[R]||R,j=b[R]||0,H=w[R]||0,W=String(C[R]||""),Y=S[R]||0;T.addAtom(V,z,B,F,U,G,W,H,j,Y)}}}},{key:"_extractSecondary",value:function(e,t){t.struct_conf&&this._extractConfs(e,t.struct_conf),t.struct_sheet_range&&this._extractSheets(e,t.struct_sheet_range)}},{key:"_extractSheets",value:function(e,t){var r=this.asymDict;if(t.sheet_id&&t.id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var n=e._sheets,i=Ja(t.sheet_id),o=Ja(t.id),s=Ja(t.beg_auth_seq_id),a=Ja(t.end_auth_seq_id),l=Ja(t.beg_label_asym_id),c=Ja(t.pdbx_beg_PDB_ins_code)||[],u=Ja(t.pdbx_end_PDB_ins_code)||[],h=0,d=o.length;h<d;++h){var f=e.getChain(r[l[h]]),p=C(i[h]),m=s[h],_=a[h],v=c[h]||" ",g=u[h]||" ",y=f.findResidue(m,v),x=f.findResidue(_,g);if(y&&x){for(var b=new qa(p,y[0],x[0],0,null,null),w=f.getResidues(),S=y[1];S<=x[1];++S)w[S]._secondary=b;p.addStrand(b),e.structures.push(b)}}function C(e){for(var t=n.length,r=0;r<t;++r)if(n[r]._name===e)return n[r];return n[t]=new Xa(e,0),n[t]}}},{key:"_extractConfs",value:function(e,t){var r=this.asymDict;if(t.conf_type_id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var n,i,o=Ja(t.conf_type_id),s=Ja(t.beg_auth_seq_id),a=Ja(t.pdbx_beg_PDB_ins_code)||[],l=Ja(t.end_auth_seq_id),c=Ja(t.pdbx_end_PDB_ins_code)||[],u=Ja(t.details)||[],h=Ja(t.pdbx_PDB_helix_length)||[],d=Ja(t.pdbx_PDB_helix_class)||[],f=Ja(t.id)||[],p=Ja(t.beg_label_asym_id),m=0,_=o.length;m<_;++m){var v=(n=o[m],i=void 0,(i=/[A-Za-z]+/.exec(n))?Qa[i[0].toLowerCase()]:null);if(v){var g=f[m]||o[m],y=e.getChain(r[p[m]]),x=s[m],b=l[m],w=a[m]||" ",S=c[m]||" ",C=y.findResidue(x,w),A=y.findResidue(b,S);if(C&&A){var E=u[m]||"",k=h[m]||0,T=d[m]||" ",R=void 0;if("helix"===v){var M=e._helices.length;R=new Ya(T,C[0],A[0],M,g,E,k),e.addHelix(R),e.structures.push(R)}else"turn"===v?(R=new He(He.Type.TURN,C[0],A[0]),e.structures.push(R)):R=null;if(R)for(var P=y.getResidues(),N=C[1];N<=A[1];++N)P[N]._secondary=R}}}}},{key:"_extractAssemblies",value:function(e,t){var r=this.asymDict,n=t.pdbx_struct_assembly_gen;if(n){var i=Ja(n.assembly_id),o=Ja(n.oper_expression),s=Ja(n.asym_id_list);if(i&&o&&s){var a=function(e){if(!e)return null;var t=Ja(e.id),r=e.matrix,n=e.vector;if(!t||!r||!n)return null;for(var i=[],o=0,s=t.length;o<s;++o){for(var a=new me.Matrix4,l=a.elements,c=0;c<3;++c){var u=r[c+1];l[c]=Ja(u[1])[o],l[c+4]=Ja(u[2])[o],l[c+8]=Ja(u[3])[o],l[c+12]=Ja(n[c+1])[o]}i[t[o]]=a}return i}(t.pdbx_struct_oper_list);if(a)for(var l=0,c=i.length;l<c;++l){for(var u=new $a(e),h=tl(o[l],a),d=s[l].split(","),f=0,p=d.length;f<p;++f){var m=d[f].trim();0<m.length&&u.addChain(r[m])}u.matrices=h,e.units.push(u)}}}}}],[{key:"canProbablyParse",value:function(e){return w.isString(e)&&/^\s*data_/i.test(e)}}]),n}();rl.formats=["cif","mmcif"],rl.extensions=[".cif",".mmcif"];var nl=0,il=1,ol=2,sl=3,al=function(){function e(){W(this,e),Ce(this,"_xyz2crs",[]),Ce(this,"_origin",new me.Vector3(0,0,0)),this._header={},this._boxSize=new me.Vector3,this._boxStart=new me.Vector3,this._header.delta={},this._header.extent=[],this._header.nstart=[],this._header.grid=[],this._header.crs2xyz=[],this._header.cellDims=new me.Vector3,this._header.angles=[],this._header.origin=new me.Vector3(0,0,0),this._header.dmin=0,this._header.dmean=0,this._header.dmax=0}return p(e,[{key:"_typedCheck",value:function(){if(w.isTypedArray(this._buff))this._buff=this._buff.buffer;else if(!w.isArrayBuffer(this._buff))throw new TypeError("Expected ArrayBuffer or TypedArray")}},{key:"_fillHeader",value:function(e,t){for(var r in e)if(e.hasOwnProperty(r))switch(e[r][0]){case nl:this._header[r]=t[e[r][1]][e[r][2]];break;case ol:this._parseArray(this._header[r],t[e[r][1]],e[r][2]);break;case il:this._parseVector(this._header[r],t[e[r][1]],e[r][2]);break;case sl:this._header[r]=new Uint8Array(t[e[r][1]],4*[e[r][2]],4*[e[r][3]])}}},{key:"_parseVector",value:function(e,t,r){var n=[t[r],t[r+1],t[r+2]];e.x=n[0],e.y=n[1],e.z=n[2]}},{key:"_parseArray",value:function(e,t,r){e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}},{key:"_parseHeader",value:function(){}},{key:"_setAxisIndices",value:function(){}},{key:"_setOrigins",value:function(){}},{key:"_getAxis",value:function(){var e=this._header,t=e.cellDims.x/e.grid[0],r=e.cellDims.y/e.grid[1],n=e.cellDims.z/e.grid[2],i=y(e.angles,3),o=i[0],s=i[1],a=i[2],l=Math.cos(s),c=(Math.cos(o)-Math.cos(s)*Math.cos(a))/Math.sin(a),u=Math.sqrt(1-l*l-c*c);return[new me.Vector3(t,0,0),new me.Vector3(Math.cos(a)*r,Math.sin(a)*r,0),new me.Vector3(l*n,c*n,u*n)]}},{key:"_getXYZdim",value:function(){return[this._header.extent[this._xyz2crs[0]],this._header.extent[this._xyz2crs[1]],this._header.extent[this._xyz2crs[2]]]}},{key:"_getVolumeInfo",value:function(){var e=w.pick(this._header,["dmean","dmin","dmax","sd","delta"]);return e.obtuseAngle=this._header.angles.map(function(e){return Number(e>=Math.PI/2)}),e}},{key:"_setBoxParams",value:function(e,t,r){var n=this,i=0,o=0,s=y(this._header.angles,3),a=s[0],l=s[1];s[2]>=Math.PI/2&&(i+=Math.abs(t.x)),l>=Math.PI/2&&(i+=Math.abs(r.x)),a>=Math.PI/2&&(o+=Math.abs(r.y)),this._boxStart=new me.Vector3(this._origin.x-i,this._origin.y-o,this._origin.z),this._boxSize=new me.Vector3(Math.abs(e.x)+Math.abs(t.x)+Math.abs(r.x),Math.abs(t.y)+Math.abs(r.y),Math.abs(r.z));function c(e,t){return Math.abs(e[t])/n._boxSize[t]}this._header.delta.x=c(t,"x"),this._header.delta.y=c(r,"x"),this._header.delta.z=c(r,"y")}},{key:"_getXYZbox",value:function(){return new me.Box3(this._boxStart.clone(),this._boxStart.clone().add(this._boxSize))}},{key:"_toXYZData",value:function(){}},{key:"parse",value:function(e){return this._parseHeader(e),this._setOrigins(),new Sr(Float32Array,this._getXYZdim(),this._getXYZbox(),1,this._toXYZData(),this._getVolumeInfo())}}]),e}(),ll={extent:[ol,"u32",0],type:[nl,"u32",3],nstart:[ol,"i32",4],grid:[ol,"u32",7],cellDims:[il,"f32",10],angles:[ol,"f32",13],crs2xyz:[ol,"i32",16],dmin:[nl,"f32",19],dmax:[nl,"f32",20],dmean:[nl,"f32",21],ispg:[nl,"u32",22],nsymbt:[nl,"u32",23],lksflg:[nl,"u32",24],customData:[sl,"buffer",25,9],origin:[il,"f32",34],map:[sl,"buffer",52,1],machine:[nl,"u32",53],sd:[nl,"f32",54],nlabel:[nl,"f32",55],label:[sl,"buffer",56,200]},cl=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,al),p(e,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};t.u32=new Uint32Array(this._buff,0,56),t.i32=new Int32Array(this._buff,0,56),t.f32=new Float32Array(this._buff,0,56),t.buffer=this._buff;var r=this._header;this._fillHeader(ll,t),r.angles.forEach(function(e,t,r){r[t]*=Math.PI/180})}},{key:"_setAxisIndices",value:function(){var e=this._header;0===e.cellDims.x&&0===e.cellDims.y&&0===e.cellDims.z&&e.cellDims.set(1,1,1);var t=this._header.crs2xyz;0===t[0]&&0===t[1]&&0===t[2]&&(t[0]=1,t[1]=2,t[2]=3);var r=this._xyz2crs;r[t[0]-1]=0,r[t[1]-1]=1,r[t[2]-1]=2}},{key:"_setOrigins",value:function(){var e=this._getAxis(),t=y(e,3),r=t[0],n=t[1],i=t[2];this._setAxisIndices();var o=this._header,s=this._xyz2crs;if(0===o.origin.x&&0===o.origin.y&&0===o.origin.z?(this._origin.addScaledVector(r,o.nstart[s[0]]),this._origin.addScaledVector(n,o.nstart[s[1]]),this._origin.addScaledVector(i,o.nstart[s[2]])):this._origin=o.origin,r.multiplyScalar(o.extent[s[0]]-1),n.multiplyScalar(o.extent[s[1]]-1),i.multiplyScalar(o.extent[s[2]]-1),2!==o.type)throw new Error("CCP4: Unsupported format ".concat(o.type));this._data=new Float32Array(this._buff,1024+o.nsymbt,o.extent[0]*o.extent[1]*o.extent[2]),this._setBoxParams(r,n,i)}},{key:"_toXYZData",value:function(){var e=this._header,t=this._data,r=this._xyz2crs,n=new Float32Array(t.length),i=this._getXYZdim(),o=i[0],s=i[1],a=0,l=[];for(l[2]=0;l[2]<e.extent[2];l[2]++)for(l[1]=0;l[1]<e.extent[1];l[1]++)for(l[0]=0;l[0]<e.extent[0];l[0]++,a++)n[l[r[0]]+o*(l[r[1]]+s*l[r[2]])]=t[a];return n}}]),e}(),ul=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._options.fileType="ccp4",r.model=new cl,r}return A(n,ia),p(n,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canProbablyParse",value:function(){return!1}}]),n}();ul.formats=["ccp4"],ul.extensions=[".ccp4",".map",".mrc"],ul.binary=!0;var hl=Cr.Complex,dl=Cr.Element,fl=Cr.Molecule,pl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._complex=null,r._atomsInf=null,r._options.fileType="xyz",r._fileName=t.name,r}return A(n,ia),p(n,[{key:"_parseToAtomsInf",value:function(e){var t=e.indexOf("\n"),r=parseInt(e.substring(0,t),10),n=e.indexOf("\n",t+1),i=e.slice(t+1,n).trim();0===i.length&&(i=this._fileName);var o=n+e.substring(n).search(/\S/);this._atomsInf=e.substring(o).split(/[\s,]*\n[\s,]*/),Number.isNaN(r)||this._atomsInf.length-1===r?(this._complex.metadata.format="xyz",this._complex.name=i):this._complex.error={message:"wrong number of atoms"}}},{key:"_parseAtomsInf",value:function(){for(var e=this._complex.addChain("A").addResidue("UNK",1," "),t=0;t<this._atomsInf.length-1;t++){var r=this._atomsInf[t].split(/[\s,]+/);if(4!==r.length){this._complex.error={message:"missed parameters"};break}var n=t+1,i=r[0],o=new me.Vector3(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])),s=dl.getByName(i);e.addAtom(i,s,o,void 0,!0,n," ",1,1,0)}var a=new fl(this._complex,this._complex.name,1);a.residues=e,this._complex._molecules[0]=a}},{key:"parseSync",value:function(){var e=this._complex=new hl;if(this._parseToAtomsInf(this._data),this._parseAtomsInf(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex=null,this._atomsInf=null,e.error)throw new Error(e.error.message);return e}}],[{key:"canProbablyParse",value:function(e){return w.isString(e)&&/^\s*\d+ *\n[^\n]*\n\s*\w{1,3}\s+-?\d/.test(e)}}]),n}();Ce(pl,"formats",["xyz"]),Ce(pl,"extensions",[".xyz"]);var ml=Cr.Complex,_l=Cr.Element,vl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._options.fileType="pubchem+json",r}return A(n,ia),p(n,[{key:"parseSync",value:function(){return this.logger.info("Parsing PubChem JSON file..."),this._toComplex(JSON.parse(this._data))}},{key:"_toComplex",value:function(e){var t=new ml,r=e.PC_Compounds&&e.PC_Compounds[0];return r&&(this._extractAtoms(t,r),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing})),t}},{key:"_extractAtoms",value:function(e,t){var r=t.atoms&&t.atoms.aid,n=r&&t.atoms.element;if(!n||r.length!==n.length)throw new Error("Unable to parse atom elements");n=w.fromPairs(w.zip(r,n));var i={},o=t.coords&&t.coords[0],s=o&&o.conformers&&o.conformers[0],a=s&&s.x,l=s&&s.y,c=s&&s.z||[];if(!(r=o&&o.aid)||!a||!l)throw new Error("Coordinates are not found in the file");for(var u=e.addChain(" ").addResidue("UNK",1," "),h=0,d=r.length;h<d;++h){var f=r[h],p=_l.ByAtomicNumber[n[f]],m=new me.Vector3(a[h],l[h],c[h]||0);i[f]=u.addAtom(p.name,p,m,void 0,!0,f," ",1,0,0)}var _=t.bonds&&t.bonds.aid1,v=t.bonds&&t.bonds.aid2,g=t.bonds&&t.bonds.order||[];if(_&&v&&_.length===v.length)for(var y=0,x=_.length;y<x;++y)e.addBond(i[_[y]],i[v[y]],g[y]||1,0,!0)}}],[{key:"canProbablyParse",value:function(e){return w.isString(e)&&"{"===e[0]}}]),n}();vl.formats=["pubchem","pubchem+json","pc"],vl.extensions=[".json"];var gl=function(){function t(e){W(this,t),this._strings=e.split(/\r?\n|\r/),this._currentStart=0,this._currentStringIndx=0}return p(t,[{key:"setStart",value:function(e){e>=this._strings.length?(this._currentStart=this._strings.length-1,this._currentStringIndx=this._strings.length-1):(this._currentStart=e,this._currentStringIndx=e)}},{key:"getNextString",value:function(){return this._strings[++this._currentStringIndx]}},{key:"getCurrentString",value:function(){return this._strings[this._currentStringIndx]}},{key:"getStringFromStart",value:function(e){return this._currentStringIndx=this._currentStart+e,this._strings[this._currentStart+e]}},{key:"findNextDataItem",value:function(){for(var e=this.getNextString(),t=!1;!w.isUndefined(e)&&"$$$$"!==e.trim();){if(e.match(/>\s+<(.*)>/)){t=!0;break}e=this.getNextString()}return t}},{key:"findNextCompoundStart",value:function(){for(var e=this.getCurrentString();!w.isUndefined(e)&&"$$$$"!==e.trim();)e=this.getNextString();return this.setStart(++this._currentStringIndx),this.probablyHaveDataToParse()}},{key:"probablyHaveDataToParse",value:function(){return this._currentStringIndx<this._strings.length-2}}]),t}(),yl=Cr.Complex,xl=Cr.Element,bl=Cr.Bond,wl=Cr.Molecule,Sl=[0,3,2,1,0,-1,-2,-3],Cl=[0,1,2,3,1,1,1,2],Al=[bl.BondType.UNKNOWN,bl.BondType.COVALENT,bl.BondType.COVALENT,bl.BondType.COVALENT,bl.BondType.AROMATIC,bl.BondType.UNKNOWN,bl.BondType.AROMATIC,bl.BondType.AROMATIC],El=/.*(M\s\sEND).*|.*(^$$$$).*|.*>\s+<(.+)>.*/,kl=/.*($$$$).*|.*>\s+<(.+)>.*/,Tl="sdf",Rl="mol",Ml=["name","id","title"],Pl={name:["PUBCHEM_IUPAC_TRADITIONAL_NAME",/PUBCHEM_(.+)_NAME/,/(.+)name/,/(.+)NAME/],id:["PUBCHEM_COMPOUND_CID","id","ID",/.*CID/,/.*ID/,/.*id/],title:["msg","MSG","message","title","description","desc"]};var Nl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._format="sdf",r._complex=null,r._chain=null,r._residue=null,r._molecules=null,r._metadata={},r._metadata.molecules=[],r._currentMolProps={},r._compoundIndx=-1,r._assemblies=[],r._atomsParsed=0,r._atomsIndexes=[],r}return A(n,ia),p(n,[{key:"canProbablyParse",value:function(e){return w.isString(e)&&El.test(e)}},{key:"_parseHeader",value:function(e){var t={};t.name=e.getStringFromStart(0);var r=parseInt(e.getStringFromStart(1).substr(10,6).trim(),10);t.date=r.toString()||"",t.title=e.getStringFromStart(2),this._metadata.molecules.push(t)}},{key:"_parseAtoms",value:function(e,t){var r,n=this._atomsParsed,i=function(e){if(!e)return"A";for(var t=[];e;)t.push(65+e%26),e=Math.trunc(e/26);return 1<t.length&&(t.reverse(),--t[0]),String.fromCharCode.apply(String,t)}(this._compoundIndx);this._chain=this._complex.getChain(i)||this._complex.addChain(i),this._residue=this._chain.addResidue("UNK",1," ");for(var o=0;o<t;o++){r=e.getNextString(),n++;var s=parseFloat(r.substr(0,10)),a=parseFloat(r.substr(10,10)),l=parseFloat(r.substr(20,10)),c=Sl[parseInt(r.substr(36,3),10)],u=new me.Vector3(s,a,l),h=r.substr(31,3).trim().toUpperCase(),d=xl.getByName(h);this._atomsIndexes[h]||(this._atomsIndexes[h]=0),this._atomsIndexes[h]+=1,h+=this._atomsIndexes[h],this._residue.addAtom(h,d,u,void 0,!0,n," ",1,0,c)}}},{key:"_parseBonds",value:function(e,t){for(var r,n=0;n<t;n++){r=e.getNextString();var i=parseInt(r.substr(0,3),10)+this._atomsParsed,o=parseInt(r.substr(3,3),10)+this._atomsParsed,s=parseInt(r.substr(6,3),10);if(o<i){var a=[o,i];i=a[0],o=a[1]}this._complex.addBond(i,o,Cl[s]||1,Al[s]||bl.BondType.UNKNOWN,!0)}}},{key:"_parseMOL",value:function(e){this._compoundIndx++,this._parseHeader(e);var t=e.getStringFromStart(3),r=parseInt(t.substr(0,3),10),n=parseInt(t.substr(3,3),10);this._parseAtoms(e,r),this._parseBonds(e,n),this._atomsParsed+=r,this._metadata.molecules[this._compoundIndx]._residues=[],this._metadata.molecules[this._compoundIndx]._residues.push(this._residue)}},{key:"_parseDataItem",value:function(e){for(var t=e.getCurrentString(),r=[],n=e.getNextString();""!==n.trim();)r.push(n),n=e.getNextString();1===r.length&&(r=y(r,1)[0]);this._currentMolProps[t.replace(/[<>]/g,"").trim()]=r}},{key:"_parseCompound",value:function(e){if(this._parseMOL(e),this._format===Tl){for(this._currentMolProps={};e.findNextDataItem();)this._parseDataItem(e);if(0!==Object.keys(this._currentMolProps).length){var t=this._metadata.molecules[this._compoundIndx];t.props=this._currentMolProps,this._tryToUpdateMoleculeData(t)}}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap,t=this._complex._bonds,r=0;r<t.length;r++){var n=t[r];n._right,n._left,n._left=e[n._left]||null,n._right=e[n._right]||null}}},{key:"_buildAssemblies",value:function(){var e=this._complex._chains;if(1===e.length)return this._assemblies;for(var t=0;t<e.length;t++){var r=new Ut(this._complex),n=new me.Matrix4;r.addMatrix(n),r.addChain(e[t]._name),this._assemblies.push(r)}return this._assemblies}},{key:"_buildMolecules",value:function(){this._complex._molecules=[];for(var e=this._metadata.molecules,t=0;t<e.length;t++){var r=new wl(this._complex,e[t].name,t+1);r.residues=e[t]._residues,this._complex._molecules[t]=r}return this._complex._molecules}},{key:"_searchTag",value:function(e,t){for(var r=0;r<t.length;r++)if(e instanceof RegExp&&e.test(t[r].tag)||e===t[r].tag)return t[r].data}},{key:"_tryToFind",value:function(e,t){for(var r=0;r<e.length;r++){var n=this._searchTag(e[r],t);if(n)return n}}},{key:"_tryToUpdateMoleculeData",value:function(e){for(var t=!1,r=0;r<Ml.length;r++){var n=Pl[Ml[r]],i=this._tryToFind(n,e.props);i&&(e[Ml[r]]=i,t=!0)}return e.name=e.name||e.id,e.name.match(/^\d+$/)&&(e.name="CID: ".concat(e.name)),t}},{key:"_finalizeMetadata",value:function(){var e=this._metadata.molecules,t=this._complex.metadata,r=this._complex;if(1===e.length)r.name=e[0].name,t.title=e[0].title,t.date=e[0].date,t.properties=e[0].props;else if(1<e.length){t.molecules=[];for(var n=0;n<e.length;n++)t.molecules.push({name:e[n].name,date:e[n].date,title:e[n].title,properties:e[n].props})}}},{key:"_finalize",value:function(){for(var e=this._serialAtomMap={},t=this._complex._atoms,r=0;r<t.length;r++){var n=t[r];e[n.serial]=n}this._complex._finalizeBonds(),this._fixBondsArray(),this._finalizeMetadata(),this._buildAssemblies(),this._complex.units=this._complex.units.concat(this._assemblies),this._buildMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:!1,enableEditing:!1,serialAtomMap:this._serialAtomMap})}},{key:"defineFormat",value:function(e){return kl.test(e)?Tl:Rl}},{key:"parseSync",value:function(){var e=this._complex=new yl,t=new gl(this._data);for(this._format=this.defineFormat(this._data),e.metadata.format=this._format;this._parseCompound(t),t.findNextCompoundStart(););return this._finalize(),e}}]),n}();Nl.formats=["mol","sdf"],Nl.extensions=[".mol",".sdf"];var Il={nstart:[ol,"i16",0],extent:[ol,"i16",3],grid:[ol,"i16",6],cellDims:[il,"i16",9],angles:[ol,"i16",12],div:[nl,"i16",15],adder:[nl,"i16",16],scaleFactor:[nl,"i16",17]},Ll=function(){function e(){return W(this,e),Y(this,X(e).apply(this,arguments))}return A(e,al),p(e,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};if(t.i16=new Int16Array(this._buff),100!==t.i16[18])for(var r=0,n=t.i16.length;r<n;++r){var i=t.i16[r];t.i16[r]=(255&i)<<8|i>>8&255}if(100!==t.i16[18])throw new Error("DSN6: Incorrect format ");var o=this._header;this._fillHeader(Il,t),o.cellDims.multiplyScalar(1/o.scaleFactor),o.angles.forEach(function(e,t,r){r[t]*=Math.PI/180/o.scaleFactor}),o.div/=100}},{key:"_setAxisIndices",value:function(){this._xyz2crs[0]=0,this._xyz2crs[1]=1,this._xyz2crs[2]=2}},{key:"_setOrigins",value:function(){var e=this._header,t=this._getAxis(),r=y(t,3),n=r[0],i=r[1],o=r[2];this._setAxisIndices(),this._origin.addScaledVector(n,e.nstart[0]),this._origin.addScaledVector(i,e.nstart[1]),this._origin.addScaledVector(o,e.nstart[2]),n.multiplyScalar(e.extent[0]),i.multiplyScalar(e.extent[1]),o.multiplyScalar(e.extent[2]),this._setBoxParams(n,i,o)}},{key:"_pointCalculate",value:function(e,t,r,n,i,o,s){var a=this._header;return i<a.extent[0]&&n<a.extent[1]&&r<a.extent[2]?(e[i+a.extent[0]*(n+a.extent[1]*r)]=(t[o.counter]-a.adder)/a.div,++o.counter,!0):(o.counter+=8-s,!1)}},{key:"_blockCalculate",value:function(e,t,r,n,i,o){for(var s=0;s<8;++s)for(var a=8*r+s,l=0;l<8;++l)for(var c=8*n+l,u=!0,h=0;u&&h<8;){var d=8*i+h;u=this._pointCalculate(e,t,a,c,d,o,h),h++}}},{key:"_toXYZData",value:function(){for(var e=this._header,t=new Uint8Array(this._buff),r=new Float32Array(e.extent[0]*e.extent[1]*e.extent[2]),n=new me.Vector3(e.extent[0]/8,e.extent[1]/8,e.extent[2]/8),i={counter:512},o=0;o<n.z;++o)for(var s=0;s<n.y;++s)for(var a=0;a<n.x;++a)this._blockCalculate(r,t,o,s,a,i);return this._calculateInfoParams(r),r}},{key:"_calculateInfoParams",value:function(e){this._header.dmean/=e.length;for(var t=0,r=e[0],n=e[0],i=0;i<e.length;i++)t+=Math.pow(this._header.dmean-e[i],2),e[i]<r&&(r=e[i]),e[i]>n&&(n=e[i]);this._header.sd=Math.sqrt(t/e.length),this._header.dmax=n,this._header.dmin=r}}]),e}(),Ol=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._options.fileType="dsn6",r.model=new Ll,r}return A(n,ia),p(n,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canParse",value:function(e,t){return!!e&&(e instanceof ArrayBuffer&&ia.checkDataTypeOptions(t,"dsn6"))}},{key:"canProbablyParse",value:function(){return!1}}]),n}();Ol.formats=["dsn6"],Ol.extensions=[".dsn6",".omap"],Ol.binary=!0;var Vl=function(){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this,e)))._next=-1,t.next(),t}return A(r,la),p(r,[{key:"getNext",value:function(){return this._next}}]),r}(),Dl=Cr.Complex,zl=Cr.Element,Fl=Cr.Molecule,Bl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._time=null,r._numAtoms=null,r._residueNumber=null,r._residueName="",r._atomName="",r._atomNumber=null,r._atomPosition=[],r._atomVelocity=[],r._complex=null,r._molecules=[],r._molecule=null,r._options.filetype="gro",r}return A(n,ia),p(n,[{key:"canProbablyParse",value:function(e){return w.isString(this._data)&&/^\s*[^\n]*\n\s*\d+ *\n\s*\d+[^\n\d]{3}\s*\w+\s*\d+\s*-?\d/.test(e)}},{key:"_parseTitle",value:function(e){var t=this._complex.metadata;t.id=e.readLine().trim(),t.name=t.id.slice(t.id.lastIndexOf("\\")+1,t.id.lastIndexOf(".")),t.format="gro"}},{key:"_parseNumberOfAtoms",value:function(e){if(this._numAtoms=e.readInt(0,e.getNext()),Number.isNaN(this._numAtoms))throw new Error("Line 2 is not representing atom number. Consider checking input file")}},{key:"_parseAtom",value:function(e){this._residueNumber=e.readInt(1,5),this._residueName=e.readString(6,10).trim(),this._atomName=e.readString(11,15).trim(),this._atomNumber=e.readInt(16,20);var t=10*e.readFloat(21,28),r=10*e.readFloat(29,36),n=10*e.readFloat(37,45);if(Number.isNaN(t)||Number.isNaN(r)||Number.isNaN(n))this._complex.error={message:'Atom position is invalid in "'.concat(e.readLine(),'"')};else{var i=zl.getByName(this._atomName[0]);if("Unknown"!==i.fullName){var o=zl.Role[this._atomName],s=this._chain;s||(this._chain=s=this._complex.addChain("A"));var a=this._residue;a&&a.getSequence()===this._residueNumber||(this._residue=a=s.addResidue(this._residueName,this._residueNumber," ")),this._atomPosition=new me.Vector3(t,r,n);a.addAtom(this._atomName,i,this._atomPosition,o,!0,this._atomNumber," ",1,1,0)}else this._complex.error={message:"".concat(this._atomName[0]," hasn't been recognised as an atom name.")}}}},{key:"_finalize",value:function(){var e=new Fl(this._complex,this._complex.metadata.name,1);e.residues=this._chain._residues,e._chains=this._chain,this._complex._molecules[0]=e,this._molecules.push(e),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"parseSync",value:function(){var e=this._complex=new Dl,t=new Vl(this._data),r=0;for(this._parseTitle(t),t.next(),this._parseNumberOfAtoms(t),t.next(),r=0;r<this._numAtoms&&!t.end();++r)this._parseAtom(t),t.next();if(r<this._numAtoms&&(this._complex.error={message:"File ended unexpectedly."}),e.error)throw new Error(e.error.message);return this._finalize(),this._atomPosition=null,this._complex=null,this._molecules=null,this._molecule=null,e}}]),n}();Bl.formats=["gro"],Bl.extensions=[".gro"];var Ul=Cr.Complex,Gl=Cr.Element,jl=Cr.Bond,Hl=Cr.Molecule,Wl={un:0,1:1,2:2,3:3,ar:1,am:1,nc:0,du:1},Yl={un:jl.BondType.UNKNOWN,1:jl.BondType.COVALENT,2:jl.BondType.COVALENT,3:jl.BondType.COVALENT,ar:jl.BondType.AROMATIC,am:jl.BondType.COVALENT,nc:jl.BondType.UNKNOWN,du:jl.BondType.COVALENT},Xl=/\d+$/,ql=/\s+/;function $l(e){return e.trim().split(ql)}var Zl=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._complex=null,r._chain=null,r._residue=null,r._compoundIndx=-1,r._molecules=[],r._molecule=null,r._currPosIdx=0,r._currStartIdx=0,r._serialAtomMap={},r._options.fileType="mol2",r}return A(n,ia),p(n,[{key:"_parseRawStrings",value:function(e){return e.split(/\r?\n|\r/)}},{key:"_toStringFromStart",value:function(e,t){var r=this._currStartIdx+e;this._currPosIdx=r<t.length?r:this._currStartIdx}},{key:"_toHeaderString",value:function(e,t){for(this._toStringFromStart(0,t);this._currPosIdx<t.length;){if(t[this._currPosIdx].match("@<TRIPOS>".concat(e)))return;this._currPosIdx++}this._toStringFromStart(0,t)}},{key:"_toStringFromHeader",value:function(e,t,r){this._toHeaderString(e,r);var n=this._currPosIdx+t;r[this._currPosIdx].match("@<TRIPOS>".concat(e))&&n<r.length&&(this._currPosIdx=n)}},{key:"_setStart",value:function(e,t){e>=t.length?this._currStartIdx=this._currPosIdx=t.length-1:this._currStartIdx=this._currPosIdx=e}},{key:"_probablyHaveDataToParse",value:function(e){return this._currPosIdx<e.length-2}},{key:"_findNextCompoundStart",value:function(e){for(;this._currPosIdx<e.length&&"@<TRIPOS>MOLECULE>"!==e[this._currPosIdx].trim();)this._currPosIdx++;return this._setStart(++this._currPosIdx,e),this._probablyHaveDataToParse(e)}},{key:"_parseMolecule",value:function(e){this._toHeaderString("MOLECULE",e);var t=this._complex.metadata;t.name=e[++this._currPosIdx],t.format="mol2",this._molecule={_index:"",_chains:[]},this._molecule._index=this._compoundIndx+1,this._molecules.push(this._molecule)}},{key:"_parseAtoms",value:function(e,t){this._toHeaderString("ATOM",t);for(var r=0;r<e;r++){var n=$l(t[++this._currPosIdx]);if(n.length<6)throw new Error("MOL2 parsing error: Not enough information to create atom!");var i=parseInt(n[0],10),o=n[1],s=parseFloat(n[2]),a=parseFloat(n[3]),l=parseFloat(n[4]),c=n[5].split(".")[0].toUpperCase(),u=0;9<=n.length&&(u=parseFloat(n[8])||0);var h=this._chain;if(h||(this._chain=h=this._complex.getChain("A")||this._complex.addChain("A"),this._residue=null),this._setResidue(n)){var d=Gl.getByName(c),f=Gl.Role[o],p=new me.Vector3(s,a,l);this._residue.addAtom(o,d,p,f,!1,i," ",1,0,u)}}}},{key:"_setResidue",value:function(e){var t=1,r="UNK";if(7<=e.length&&(t=parseInt(e[6],10)),8<=e.length&&"<0>"!==e[7]&&(r=e[7].replace(Xl,"")),this.settings.now.nowater&&("HOH"===r||"WAT"===r))return!1;var n=this._residue,i=this._chain;return n&&n.getSequence()===t||(this._residue=i.addResidue(r,t,"A")),!0}},{key:"_parseBonds",value:function(e,t){this._toHeaderString("BOND",t);for(var r=0;r<e;r++){var n=$l(t[++this._currPosIdx]);if(n.length<3)throw new Error("MOL2 parsing error: Missing information about bonds!");var i=parseInt(n[1],10),o=parseInt(n[2],10),s=n[3];if(o<i){var a=[o,i];i=a[0],o=a[1]}this._complex.addBond(i,o,Wl[s]||0,Yl[s]||jl.BondType.UNKNOWN,!0)}}},{key:"_fixSerialAtoms",value:function(){for(var e=this._complex._atoms,t=0;t<e.length;t++){var r=e[t];this._serialAtomMap[r.serial]=r}}},{key:"_fixBondsArray",value:function(){var e=this._serialAtomMap,t=this._complex;if(0===Object.keys(e).length)throw new Error("MOL2 parsing error: Missing atom information!");for(var r=t._bonds,n=0;n<r.length;n++){var i=r[n];i._left=e[i._left]||null,i._right=e[i._right]||null}}},{key:"_finalizeMolecules",value:function(){var e=this._complex._chains[0];this._complex._molecules=[];for(var t=0;t<this._molecules.length;t++){var r=this._molecules[t],n=e._residues,i=new Hl(this._complex,r._name,t+1);i.residues=n,this._complex._molecules[t]=i}}},{key:"_finalize",value:function(){this._complex._finalizeBonds(),this._fixSerialAtoms(),this._fixBondsArray(),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_parseCompound",value:function(e){this._compoundIndx++,this._parseMolecule(e),this._toStringFromHeader("MOLECULE",2,e);var t=e[this._currPosIdx].trim().split(ql),r=t[0],n=t[1];this._parseAtoms(r,e),this._parseBonds(n,e)}},{key:"parseSync",value:function(){for(var e=this._complex=new Ul,t=this._parseRawStrings(this._data);this._parseCompound(t),this._findNextCompoundStart(t););return this._finalize(),e}}]),n}();Zl.formats=["mol2"],Zl.extensions=[".mol2",".ml2",".sy2"];var Kl=new na([ga,rl,Ba,pl,Aa,vl,Nl,ul,Ol,Bl,Zl]),Ql=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return W(this,t),Y(this,X(t).call(this,e,["formats"]))}return A(t,un),p(t,[{key:"find",value:function(e){var t=[];return e.format&&(t=this._dict.formats[e.format.toLowerCase()]||[]),ln(t)}}]),t}(),Jl=function(){function r(e,t){W(this,r),this._source=e,this._options=t||{},this._abort=!1}return p(r,[{key:"exportSync",value:function(){throw new Error("Exporting to this source is not implemented")}},{key:"export",value:function(){var r=this;return new Promise(function(e,t){setTimeout(function(){try{return r._abort?t(new Error("Export aborted")):e(r.exportSync())}catch(e){return t(e)}})})}},{key:"abort",value:function(){this._abort=!0}}]),r}();hn(Jl.prototype);var ec=function(){function e(){W(this,e),this._resultArray=[],this._currentStr=-1,this._tag=null,this._fixedNumeration=!1,this._numeration=!1,this._tagStrNum=0}return p(e,[{key:"getResult",value:function(){return this.writeString("\n",81,81),this._resultArray.join("")}},{key:"_currentStrLength",value:function(){var e=this._resultArray[this._currentStr];return e?e.length:0}},{key:"newTag",value:function(e,t){this._tag=e||null,w.isUndefined(t)?(this._numeration=!1,this._fixedNumeration=!1,this._tagStrNum=0):w.isNumber(t)?(this._tagStrNum=t,this._numeration=!0,this._fixedNumeration=!0):w.isBoolean(t)&&(this._tagStrNum=0,this._numeration=t,this._fixedNumeration=!1)}},{key:"newString",value:function(e){this.writeString("\n",81,81),this._currentStr++,this._resultArray.push(""),e?this.writeString(e,1,6):this._tag&&this.writeString(this._tag,1,6),this._numeration&&(this._fixedNumeration||this._tagStrNum++,1!==this._tagStrNum&&this.writeString(this._tagStrNum.toString(),10,8))}},{key:"writeEntireString",value:function(e,t,r){t=t||81;for(var n=0;n<e.length;n++)this._currentStrLength()===t&&n!==e.length-1&&(this.newString(),r&&this.writeString(r.tag,r.begin,r.end)),"\n"===e[n]?this.newString():this.writeString(e[n])}},{key:"writeString",value:function(e,t,r){var n,i=this._resultArray[this._currentStr],o=i?i.length:0;if(!w.isUndefined(e)){w.isNumber(t)||(t=o+1),w.isNumber(r)||(r=o+e.length);var s=t<r?r:t,a=t<r?t:r;if((n=w.isString(e)?e:e.toString()).length>Math.abs(t-r)+1&&(n=n.substr(0,Math.abs(t-r+1))),o+1<a)this._resultArray[this._currentStr]+=" ".repeat(a-o-1);else if(a<=o){var l=this._resultArray[this._currentStr];this._resultArray[this._currentStr]=l.slice(0,a-1)}if(r<t)n=" ".repeat(t-r+1-n.length)+n;11===a&&this._numeration&&1!==this._tagStrNum&&(n=" ".concat(n)),this._resultArray[this._currentStr]+=n,s>(i=this._resultArray[this._currentStr]).length&&(this._resultArray[this._currentStr]+=" ".repeat(s-i.length))}}},{key:"writeBondsArray",value:function(e,t){for(var r=this._getSubArrays(e,4),n=0;n<r.length;n++){this.newString(),this.writeString(t.serial,11,7);for(var i=0;i<r[n].length;i++){var o=r[n][i]._left.serial===t.serial?r[n][i]._right.serial:r[n][i]._left.serial;this.writeString(o,16+5*i,12+5*i)}}}},{key:"_getSubArrays",value:function(e,t){for(var r=[],n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}},{key:"writeMatrix",value:function(e,t,r){for(var n=0;n<3;n++){this.newString(),this.writeString(r,14,18),this.writeString((n+1).toString(),19,19),this.writeString(t.toString(),23,20);for(var i=0;i<3;i++){var o=parseFloat(e.elements[4*n+i]).toFixed(6);this.writeString(o.toString(),33+10*i,24+10*i)}var s=parseFloat(e.elements[4*n+3]).toFixed(5);this.writeString(s.toString(),68,55)}}},{key:"writeMatrices",value:function(e,t){if(e)for(var r=new me.Matrix4,n=0;n<e.length;n++)r.copy(e[n]).transpose(),this.writeMatrix(r,n+1,t)}}]),e}(),tc=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._tags=["HEADER","TITLE","COMPND","REMARK","HELIX","SHEET","ATOM and HETATM","CONECT"],r._result=null,r._tagExtractors={HEADER:r._extractHEADER,TITLE:r._extractTITLE,"ATOM and HETATM":r._extractATOM,CONECT:r._extractCONECT,COMPND:r._extractCOMPND,REMARK:r._extractREMARK,HELIX:r._extractHELIX,SHEET:r._extractSHEET},r._stringForRemark350="COORDINATES FOR A COMPLETE MULTIMER REPRESENTING THE KNOWN\nBIOLOGICALLY SIGNIFICANT OLIGOMERIZATION STATE OF THE\nMOLECULE CAN BE GENERATED BY APPLYING BIOMT TRANSFORMATIONS\nGIVEN BELOW.  BOTH NON-CRYSTALLOGRAPHIC AND\nCRYSTALLOGRAPHIC OPERATIONS ARE GIVEN.",r._stringForRemark290="CRYSTALLOGRAPHIC SYMMETRY TRANSFORMATIONS\nTHE FOLLOWING TRANSFORMATIONS OPERATE ON THE ATOM/HETATM\nRECORDS IN THIS ENTRY TO PRODUCE CRYSTALLOGRAPHICALLY\nRELATED MOLECULES.",r}return A(n,Jl),p(n,[{key:"exportSync",value:function(){var e=new ec;if(!this._source)return this._result;for(var t=0;t<this._tags.length;t++){var r=this._tags[t],n=this._tagExtractors[r];w.isFunction(n)&&n.call(this,e)}return this._result=e.getResult(),this._result}},{key:"_extractHEADER",value:function(e){if(this._source.metadata){var t=this._source.metadata;e.newTag("HEADER"),e.newString(),t.classification&&e.writeString(t.classification,11,50),t.date&&e.writeString(t.date,51,59),t.id&&e.writeString(t.id,63,66)}}},{key:"_extractTITLE",value:function(e){if(this._source.metadata){var t=this._source.metadata;if(t.title){e.newTag("TITLE",!0);for(var r=0;r<t.title.length;r++)e.newString(),e.writeString(t.title[r],11,80)}}}},{key:"_extractCONECT",value:function(e){if(this._source._atoms){var t=this._source._atoms;e.newTag("CONECT");for(var r=0;r<t.length;r++){var n=t[r].bonds.filter(function(e){return e._fixed});0!==n.length&&e.writeBondsArray(n.reverse(),t[r])}}}},{key:"_extractSHEET",value:function(e){if(this._source._sheets){e.newTag("SHEET");for(var t=this._source._sheets,r=0;r<t.length;r++)if(t[r]._strands)for(var n=t[r]._strands,i=0;i<n.length;i++)e.newString(),e.writeString(i+1,10,8),e.writeString(t[r]._name,14,12),e.writeString(n.length,16,15),e.writeString(n[i].init._type._name,18,20),e.writeString(n[i].init._chain._name,22,22),e.writeString(n[i].init._sequence,26,23),e.writeString(n[i].init._icode,27,27),e.writeString(n[i].term._type._name,29,31),e.writeString(n[i].init._chain._name,33,33),e.writeString(n[i].term._sequence,37,34),e.writeString(n[i].term._icode,38,38),e.writeString(n[i].sense,40,39)}}},{key:"_extractHELIX",value:function(e){if(this._source._helices){e.newTag("HELIX");for(var t=this._source._helices,r=0;r<t.length;r++){var n=t[r],i=w.invert(qe);e.newString(),e.writeString(n.serial,10,8),e.writeString(n.name,14,12),e.writeString(n.init._type._name,16,18),e.writeString(n.init._chain._name,20,20),e.writeString(n.init._sequence,25,22),e.writeString(n.init._icode,26,26),e.writeString(n.term._type._name,28,30),e.writeString(n.term._chain._name,32,32),e.writeString(n.term._sequence,37,34),e.writeString(n.term._icode,38,38),e.writeString(i[n.type],40,39),e.writeString(n.comment,41,70),e.writeString(n.length,76,72)}}}},{key:"_extractATOM",value:function(e){if(this._source._atoms)for(var t=this._source._atoms,r=0;r<t.length;r++){var n=t[r].het?"HETATM":"ATOM";e.newString(n);var i=1<t[r].element.name.length||3<t[r].name.length?13:14;e.writeString(t[r].serial,11,7),e.writeString(t[r].name,i,16),e.writeString(String.fromCharCode(t[r].location),17,17),e.writeString(t[r].residue._type._name,20,18),e.writeString(t[r].residue._chain._name,22,22),e.writeString(t[r].residue._sequence,26,23),e.writeString(t[r].residue._icode,27,27),e.writeString(t[r].position.x.toFixed(3),38,31),e.writeString(t[r].position.y.toFixed(3),46,39),e.writeString(t[r].position.z.toFixed(3),54,47),e.writeString(t[r].occupancy.toFixed(2),60,55),e.writeString(t[r].temperature.toFixed(2),66,61),e.writeString(t[r].element.name,78,77),t[r].charge&&e.writeString(t[r].charge,79,80)}}},{key:"_extractCOMPND",value:function(e){if(this._source._molecules){var t=this._source._molecules;e.newTag("COMPND",!0);for(var r=0;r<t.length;r++){var n=this._getMoleculeChains(t[r]);e.newString(),e.writeString("MOL_ID: ".concat(t[r].index,";"),11,80),e.newString(),e.writeString("MOLECULE: ".concat(t[r].name,";"),11,80),e.newString(),e.writeString("CHAIN: ",11,18);var i="".concat(n.join(", "),";");e.writeEntireString(i,81)}}}},{key:"_extractREMARK",value:function(e){this._Remark290(e),this._Remark350(e)}},{key:"_Remark290",value:function(e){if(this._source.symmetry&&0!==this._source.symmetry.length){var t=this._source.symmetry;e.newTag("REMARK",290),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark290),e.writeMatrices(t,"SMTRY"),e.newString(),e.newString(),e.writeString("REMARK: NULL",11,80)}}},{key:"_Remark350",value:function(e){if(this._source.units){var t=this._source.units,r=0;e.newTag("REMARK",350),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark350);for(var n=t.filter(function(e){return e instanceof Ut}),i=0;i<n.length;i++){e.newString(),e.newString(),r++,e.writeString("BIOMOLECULE: ".concat(r),11,80);var o=n[i].chains.join(", ");e.newString(),e.writeString("APPLY THE FOLLOWING TO CHAINS: "),e.writeEntireString(o,69,{tag:"AND CHAINS: ",begin:31,end:42});var s=n[i].matrices;e.writeMatrices(s,"BIOMT")}}}},{key:"_getMoleculeChains",value:function(e){var r=e.residues.map(function(e){return e._chain._name});return r.filter(function(e,t){return r.indexOf(e)===t})}}]),n}();tc.formats=["pdb"],tc.SourceClass=br;function rc(e,t,r,n){r[n]=e[t],r[n+1]=e[t+1],r[n+2]=e[t+2]}function nc(e,t,r,n,i){r[n]=e[t],r[n+1]=e[t+1],r[n+2]=e[t+2],r[n+3]=i}var ic=new me.Vector4;function oc(e,t,r,n,i){ic.set(e[t],e[t+1],e[t+2],i.w),ic.applyMatrix4(i.matrix),r[n]=ic.x,r[n+1]=ic.y,r[n+2]=ic.z}function sc(e,t,r,n,i){if(!((t.array.length-t.start)/t.stride<r||(e.array.length-e.start)/e.stride<r))if(e.stride===t.stride)t.array.set(e.array,t.start);else for(var o=t.start,s=e.start,a=0;a<r;++a,o+=t.stride,s+=e.stride)n(e.array,s,t.array,o,i)}var ac=function(){function e(){W(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.lastPos=0,this.lastNorm=0,this.lastCol=0,this.lastIdx=0}return p(e,[{key:"init",value:function(e,t){this.positions=new Float32Array(3*e),this.normals=new Float32Array(3*e),this.colors=new Float32Array(4*e),this.indices=new Int32Array(t)}},{key:"setPositions",value:function(e,t,r,n){sc({array:e,start:t,stride:n},{array:this.positions,start:this.lastPos,stride:3},r,rc),this.lastPos+=3*r}},{key:"setTransformedPositions",value:function(e,t,r,n,i){for(var o=this.lastPos,s=t,a={matrix:i,w:1},l=0;l<r;++l,s+=n,o+=3)oc(e,s,this.positions,o,a);this.lastPos+=3*r}},{key:"setNormals",value:function(e,t,r,n){sc({array:e,start:t,stride:n},{array:this.normals,start:this.lastNorm,stride:3},r,rc),this.lastNorm+=3*r}},{key:"setTransformedNormals",value:function(e,t,r,n,i){for(var o=this.lastNorm,s=t,a={matrix:i,w:0},l=0;l<r;++l,s+=n,o+=3)oc(e,s,this.normals,o,a);this.lastNorm+=3*r}},{key:"setColors",value:function(e,t,r,n){sc({array:e,start:t,stride:n},{array:this.colors,start:this.lastCol,stride:4},r,nc,1),this.lastCol+=4*r}},{key:"setIndices",value:function(e,t,r){this.indices.set(e,this.lastIdx),this.lastIdx+=r}},{key:"setShiftedIndices",value:function(e,t,r){var n=e.map(function(e){return e+r});this.setIndices(n,0,t)}},{key:"getVerticesNumber",value:function(){return this.lastPos/3}},{key:"addInstance",value:function(e,t){var r=this.getVerticesNumber();this.setShiftedIndices(t.indices,t.indices.length,r);var n=t.itemSize;this.setTransformedPositions(t.positions,0,t.vertsCount,n.position,e),this.setTransformedNormals(t.normals,0,t.vertsCount,n.normal,e),this.setColors(t.colors,0,t.vertsCount,n.color)}}]),e}(),lc=function(){function e(){W(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.vertsCount=0,this.itemSize=null}return p(e,[{key:"init",value:function(e){var t=e.attributes;this.itemSize={position:t.position.itemSize,normal:t.normal.itemSize,color:t.color.itemSize}}}]),e}(),cc=function(){function s(){return W(this,s),Y(this,X(s).apply(this,arguments))}return A(s,lc),p(s,[{key:"init",value:function(e,t){ft(X(s.prototype),"init",this).call(this,e,t);var r=e.attributes,n=r.position,i=r.normal,o=e.index;this.vertsCount=n.count,this.positions=n.array,this.normals=i.array,this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this.indices=o.array}},{key:"setColors",value:function(e){for(var t=0,r=0,n=this.colors.length,i=this.itemSize.color;r<n;r+=i)this.colors[t++]=e.r,this.colors[t++]=e.g,this.colors[t++]=e.b}}]),s}(),uc=function(){function i(){var e;return W(this,i),(e=Y(this,X(i).call(this)))._cutRawStart=0,e._cutRawEnd=0,e._facesPerSlice=0,e}return A(i,lc),p(i,[{key:"init",value:function(e,t){ft(X(i.prototype),"init",this).call(this,e,t);var r=e.attributes.position,n=e.index;this.vertsCount=r.count+t.addPerCylinder,this._facesPerSlice=t.addPerCylinder,this.positions=new Float32Array(this.vertsCount*r.itemSize),this.normals=new Float32Array(this.vertsCount*this.itemSize.normal),this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this._extendVertices(e,t),this.indices=new Uint32Array(n.count),this._extendIndices(e,t)}},{key:"_extendVertices",value:function(e,t){var r=e.attributes.position,n=e.attributes.normal,i=e.getGeoParams();this._cutRawStart=+i.radialSegments,this._cutRawEnd=this._cutRawStart+t.addPerCylinder;var o=r.array.slice(0,this._cutRawEnd*r.itemSize);this.positions.set(o,0),o=n.array.slice(0,this._cutRawEnd*n.itemSize),this.normals.set(o,0);var s=r.array.slice(this._cutRawStart*r.itemSize,r.array.length);this.positions.set(s,this._cutRawEnd*r.itemSize),s=n.array.slice(this._cutRawStart*n.itemSize,n.array.length),this.normals.set(s,this._cutRawEnd*n.itemSize)}},{key:"_extendIndices",value:function(e,t){var r=e.index,n=6*t.addPerCylinder,i=t.addPerCylinder,o=r.array.slice(n,r.count);o=o.map(function(e){return e+i}),this.indices.set(r.array,0),this.indices.set(o,n)}},{key:"_setColorRange",value:function(e,t,r,n){for(var i=n.length,o=e;o<t;o+=i)r.set(n,o)}},{key:"setColors",value:function(e,t){var r=this.itemSize.color,n=this._cutRawEnd*r,i=2*n;if(this._setColorRange(0,n,this.colors,e.toArray()),this._setColorRange(n,i,this.colors,t.toArray()),i<this.colors.length){var o=(this._facesPerSlice+1)*r,s=i+o;this._setColorRange(i,s,this.colors,t.toArray());var a=s+o;this._setColorRange(s,a,this.colors,e.toArray())}}}]),i}(),hc=function(){function e(){W(this,e),this._materials=[],this._models=[]}return p(e,[{key:"process",value:function(e){this._extractModelsAndMaterials(e);var t=this._flattenModels();return{name:e.name,models:t,materials:this._materials}}},{key:"_extractModelsAndMaterials",value:function(e){var t=this,r=new me.Layers;r.set(tn.LAYERS.DEFAULT),r.enable(tn.LAYERS.TRANSPARENT),e.traverse(function(e){e instanceof me.Mesh&&e.layers.test(r)&&t.checkExportAbility(e)&&("InstancedBufferGeometry"===e.geometry.type?t._collectInstancedGeoInfo(e):t._collectGeoInfo(e))})}},{key:"_reworkIndices",value:function(e){for(var t=2;t<e.length;t+=3)e[t]*=-1,e[t]--}},{key:"_flattenModels",value:function(){var t=0;function e(e){return e+t}for(var r=[],n=0,i=this._models.length;n<i;n++){for(var o=this._models[n],s=[],a=[],l=[],c=[],u=t=0;u<o.length;u++){var h=o[u];s.push(h.indices.map(e)),t+=h.getVerticesNumber(),a.push(h.positions),l.push(h.normals),c.push(h.colors)}s=_e.mergeTypedArraysUnsafe(s),this._reworkIndices(s),a=_e.mergeTypedArraysUnsafe(a),l=_e.mergeTypedArraysUnsafe(l),c=_e.mergeTypedArraysUnsafe(c),r.push({indices:s,positions:a,normals:l,colors:c,verticesCount:t})}return r}},{key:"checkExportAbility",value:function(e){return 0!==e.geometry.attributes.position.count&&(e instanceof Ti?(I.warn("Currently we cannot export 'sprites' modes, like BS, WV, LC. Please turn of settings 'zSprites' and try again"),!1):!(e instanceof Vi)||(I.warn("Currently we cannot export Lines mode"),!1))}},{key:"_collectGeoInfo",value:function(e){var t=e.geometry,r=t.attributes,n=r.position,i=r.color,o=r.normal,s=t.index,a=e.matrix,l=new ac,c=n.count;l.init(c,s.count),a.isIdentity()?(l.setPositions(n.array,0,c,n.itemSize),l.setNormals(o.array,0,c,o.itemSize)):(l.setTransformedPositions(n.array,0,c,n.itemSize,a),l.setTransformedNormals(o.array,0,c,o.itemSize,a)),l.setColors(i.array,0,c,i.itemSize),l.setIndices(s.array,0,s.count);var u=this._collectMaterialInfo(e);this._addToPool(l,u)}},{key:"_collectSpheresInfo",value:function(e){var t=e.geometry,r=t.attributes,n=r.position,i=r.color,o=t.index,s=e.matrix,a=new ac,l=e.geometry.maxInstancedCount,c=n.count,u=o.count;a.init(l*c,l*u);var h=new cc;h.init(e.geometry);for(var d=new me.Matrix4,f=new me.Matrix4,p=new me.Color,m=0;m<l;++m){var _=m*i.itemSize;p.fromArray(i.array,_),h.setColors(p),this._getSphereInstanceMatrix(e.geometry,m,d),f.multiplyMatrices(s,d),a.addInstance(f,h)}var v=this._collectMaterialInfo(e);this._addToPool(a,v)}},{key:"_collectCylindersInfo",value:function(e){var t=e.geometry,r=t.attributes,n=r.position,i=r.color,o=r.color2,s=t.index,a=e.matrix,l=new ac,c=e.geometry.maxInstancedCount,u=new cc;u.init(e.geometry);var h=this._gatherCylindersColoringInfo(e.geometry),d=null;0<h.needToSplit&&(d=new uc).init(e.geometry,h);var f=h.addPerCylinder*h.needToSplit,p=n.count,m=s.count;l.init(c*p+f,c*m);for(var _=new me.Matrix4,v=new me.Matrix4,g=new me.Color,y=new me.Color,x={},b=0;b<c;++b){var w=b*i.itemSize;h.is2Colored[b]?(g.fromArray(o.array,w),y.fromArray(i.array,w),d&&(d.setColors(g,y),x=d)):(g.fromArray(i.array,w),u.setColors(g),x=u),this._getCylinderInstanceMatrix(e.geometry,b,_),v.multiplyMatrices(a,_),l.addInstance(v,x)}var S=this._collectMaterialInfo(e);this._addToPool(l,S)}},{key:"_addToPool",value:function(e,t){var r=this._checkExistingMaterial(t);r<0?(this._models.push([e]),this._materials.push(t)):this._models[r].push(e)}},{key:"_checkExistingMaterial",value:function(t){return w.findIndex(this._materials,function(e){return w.isEqual(e,t)})}},{key:"_gatherCylindersColoringInfo",value:function(e){for(var t=e.maxInstancedCount,r=e.attributes.color.array,n=e.attributes.color2.array,i=e.attributes.color.itemSize,o=new Array(t),s=0,a=0,l=0;l<t;l++,a+=i){var c=1e-7<Math.abs(r[a]-n[a])||1e-7<Math.abs(r[a+1]-n[a+1])||1e-7<Math.abs(r[a+2]-n[a+2]);s+=o[l]=c}return{is2Colored:o,needToSplit:s,addPerCylinder:e.getGeoParams().radialSegments}}},{key:"_collectInstancedGeoInfo",value:function(e){e.geometry instanceof _n?this._collectSpheresInfo(e):e.geometry instanceof Nn&&this._collectCylindersInfo(e)}},{key:"_collectMaterialInfo",value:function(e){var t=e.material.uberOptions;return{diffuse:t.diffuse.toArray(),opacity:t.opacity,shininess:t.shininess,specular:t.specular.toArray()}}},{key:"_getCylinderInstanceMatrix",value:function(e,t,r){var n=e.attributes.matVector1.array,i=e.attributes.matVector2.array,o=e.attributes.matVector3.array,s=4*t;r.set(n[s],n[1+s],n[2+s],n[3+s],i[s],i[1+s],i[2+s],i[3+s],o[s],o[1+s],o[2+s],o[3+s],0,0,0,1)}},{key:"_getSphereInstanceMatrix",value:function(e,t,r){var n=e.attributes.offset,i=t*n.itemSize,o=n.array[i],s=n.array[1+i],a=n.array[2+i],l=n.array[3+i];r.set(l,0,0,o,0,l,0,s,0,0,l,a,0,0,0,1)}}]),e}(),dc=function(){function e(){W(this,e),this._resultArray=[],this._info=null}return p(e,[{key:"getResult",value:function(e){return this._info=e,this._resultArray.push(this._writeHeader()),this._resultArray.push(this._writeDefinitions()),this._resultArray.push(this._writeObjects(e.models,e.materials)),this._resultArray.push(this._writeRelations()),this._resultArray.push(this._writeConnections()),this._info=null,this._resultArray.join("")}},{key:"_writeHeader",value:function(){var e=new Date,t="Miew FBX Exporter v".concat(this._info.version);return"; FBX 6.1.0 project file\n; Created by ".concat(t," Copyright (c) 2015-2020 EPAM Systems, Inc.\n; For support please contact miew@epam.com\n; ----------------------------------------------------\n\nFBXHeaderExtension:  {\n  FBXHeaderVersion: ").concat(1003,"\n  FBXVersion: ").concat(6100,"\n  CreationTimeStamp:  {\n    Version: ").concat(1e3,"\n    Year: ").concat(e.getFullYear(),"\n    Month: ").concat(e.getMonth()+1," \n    Day: ").concat(e.getDate(),"\n    Hour: ").concat(e.getHours(),"\n    Minute: ").concat(e.getMinutes(),"\n    Second: ").concat(e.getSeconds(),"\n    Millisecond: ").concat(e.getMilliseconds(),'\n  }\n  Creator: "').concat(t,'"\n  OtherFlags:  {\n    FlagPLE: 0\n  }\n}\nCreationTime: "').concat(e,'"\nCreator: "').concat(t,'"  \n')}},{key:"_writeDefinitions",value:function(){return"\n; Object definitions\n;------------------------------------------------------------------\n\n".concat('\nDefinitions:  {\n  Version: 100\n  Count: 3\n  ObjectType: "Model" {\n    Count: 1\n  }\n  ObjectType: "Geometry" {\n    Count: 1\n  }\n  ObjectType: "Material" {\n    Count: 1\n  }\n  ObjectType: "Pose" {\n    Count: 1\n  }\n  ObjectType: "GlobalSettings" {\n    Count: 1\n  }\n} ',"\n")}},{key:"_models",value:function(){for(var e="",t=this._info.models,r=0;r<t.length;++r){var n=t[r],i=n.verticesCount;e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(r,'", "Mesh" {\n    Version: ').concat(232," \n    ").concat('Properties60: {\n      Property: "QuaternionInterpolate", "bool", "",0\n      Property: "Visibility", "Visibility", "A",1\n      Property: "Lcl Translation", "Lcl Translation", "A",0.000000000000000,0.000000000000000,-1789.238037109375000\n      Property: "Lcl Rotation", "Lcl Rotation", "A",0.000009334667643,-0.000000000000000,0.000000000000000\n      Property: "Lcl Scaling", "Lcl Scaling", "A",1.000000000000000,1.000000000000000,1.000000000000000\n      Property: "RotationOffset", "Vector3D", "",0,0,0\n      Property: "RotationPivot", "Vector3D", "",0,0,0\n      Property: "ScalingOffset", "Vector3D", "",0,0,0\n      Property: "ScalingPivot", "Vector3D", "",0,0,0\n      Property: "TranslationActive", "bool", "",0\n      Property: "TranslationMin", "Vector3D", "",0,0,0\n      Property: "TranslationMax", "Vector3D", "",0,0,0\n      Property: "TranslationMinX", "bool", "",0\n      Property: "TranslationMinY", "bool", "",0\n      Property: "TranslationMinZ", "bool", "",0\n      Property: "TranslationMaxX", "bool", "",0\n      Property: "TranslationMaxY", "bool", "",0\n      Property: "TranslationMaxZ", "bool", "",0\n      Property: "RotationOrder", "enum", "",0\n      Property: "RotationSpaceForLimitOnly", "bool", "",0\n      Property: "AxisLen", "double", "",10\n      Property: "PreRotation", "Vector3D", "",0,0,0\n      Property: "PostRotation", "Vector3D", "",0,0,0\n      Property: "RotationActive", "bool", "",0\n      Property: "RotationMin", "Vector3D", "",0,0,0\n      Property: "RotationMax", "Vector3D", "",0,0,0\n      Property: "RotationMinX", "bool", "",0\n      Property: "RotationMinY", "bool", "",0\n      Property: "RotationMinZ", "bool", "",0\n      Property: "RotationMaxX", "bool", "",0\n      Property: "RotationMaxY", "bool", "",0\n      Property: "RotationMaxZ", "bool", "",0\n      Property: "RotationStiffnessX", "double", "",0\n      Property: "RotationStiffnessY", "double", "",0\n      Property: "RotationStiffnessZ", "double", "",0\n      Property: "MinDampRangeX", "double", "",0\n      Property: "MinDampRangeY", "double", "",0\n      Property: "MinDampRangeZ", "double", "",0\n      Property: "MaxDampRangeX", "double", "",0\n      Property: "MaxDampRangeY", "double", "",0\n      Property: "MaxDampRangeZ", "double", "",0\n      Property: "MinDampStrengthX", "double", "",0\n      Property: "MinDampStrengthY", "double", "",0\n      Property: "MinDampStrengthZ", "double", "",0\n      Property: "MaxDampStrengthX", "double", "",0\n      Property: "MaxDampStrengthY", "double", "",0\n      Property: "MaxDampStrengthZ", "double", "",0\n      Property: "PreferedAngleX", "double", "",0\n      Property: "PreferedAngleY", "double", "",0\n      Property: "PreferedAngleZ", "double", "",0\n      Property: "InheritType", "enum", "",0\n      Property: "ScalingActive", "bool", "",0\n      Property: "ScalingMin", "Vector3D", "",1,1,1\n      Property: "ScalingMax", "Vector3D", "",1,1,1\n      Property: "ScalingMinX", "bool", "",0\n      Property: "ScalingMinY", "bool", "",0\n      Property: "ScalingMinZ", "bool", "",0\n      Property: "ScalingMaxX", "bool", "",0\n      Property: "ScalingMaxY", "bool", "",0\n      Property: "ScalingMaxZ", "bool", "",0\n      Property: "GeometricTranslation", "Vector3D", "",0,0,0\n      Property: "GeometricRotation", "Vector3D", "",0,0,0\n      Property: "GeometricScaling", "Vector3D", "",1,1,1\n      Property: "LookAtProperty", "object", ""\n      Property: "UpVectorProperty", "object", ""\n      Property: "Show", "bool", "",1\n      Property: "NegativePercentShapeSupport", "bool", "",1\n      Property: "DefaultAttributeIndex", "int", "",0\n      Property: "Color", "Color", "A+",0,0,0\n      Property: "Size", "double", "",100\n      Property: "Look", "enum", "",1\n    }',"\n    ").concat(this._verticesIndices(n.positions,n.indices),"\n    ").concat(this._normalLayer(n.normals)," \n    ").concat(this._colorLayer(n.colors,i)," \n    ").concat('\n    LayerElementMaterial: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "AllSame"\n      ReferenceInformationType: "Direct"\n      Materials: 0\n    }',"  \n    ").concat('\n    Layer: 0 {\n      Version: 100\n      LayerElement:  {\n        Type: "LayerElementNormal"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementColor"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementMaterial"\n        TypedIndex: 0\n      }\n    }',"\n  }")}return e}},{key:"_materials",value:function(){for(var e="",t=this._info.materials,r=0;r<t.length;++r){var n=t[r];e+='\n  Material: "Material::'.concat(this._info.name,"_").concat(r,'_default", "" {\n    Version: ').concat(102,'\n    ShadingModel: "lambert"\n    MultiLayer: 0\n    ').concat(this._materialProperties(n),"\n  }")}return e}},{key:"_writeObjects",value:function(){return"\n; Object properties\n;------------------------------------------------------------------\n\nObjects:  {\n  ".concat(this._models(),"\n  ").concat(this._materials(),"\n  ").concat('GlobalSettings: {\n    Version: 1000\n    Properties60:  {\n      Property: "UpAxis", "int", "",1\n      Property: "UpAxisSign", "int", "",1\n      Property: "FrontAxis", "int", "",2\n      Property: "FrontAxisSign", "int", "",1\n      Property: "CoordAxis", "int", "",0\n      Property: "CoordAxisSign", "int", "",1\n      Property: "UnitScaleFactor", "double", "",1\n    }\n  }',"\n}\n")}},{key:"_writeRelations",value:function(){for(var e="",t=0;t<this._info.models.length;++t)e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(t,'", "Mesh" {\n  }');for(var r="",n=0;n<this._info.materials.length;++n)r+='\n  Material: "Material::'.concat(this._info.name,"_").concat(n,'_default", "" {\n  }');return"\n; Object relations\n;------------------------------------------------------------------\n\nRelations:  {\n  ".concat(e,'\n  Model: "Model::Producer Perspective", "Camera" {\n  }\n  Model: "Model::Producer Top", "Camera" {\n  }\n  Model: "Model::Producer Bottom", "Camera" {\n  }\n  Model: "Model::Producer Front", "Camera" {\n  }\n  Model: "Model::Producer Back", "Camera" {\n  }\n  Model: "Model::Producer Right", "Camera" {\n  }\n  Model: "Model::Producer Left", "Camera" {\n  }\n  Model: "Model::Camera Switcher", "CameraSwitcher" {\n  }\n  ').concat(r,"\n}")}},{key:"_writeConnections",value:function(){for(var e="",t=this._info.name,r=0;r<this._info.models.length;++r)e+='\n  Connect: "OO", "Model::'.concat(t,"_").concat(r,'", "Model::Scene"');for(var n="",i=0;i<this._info.materials.length;++i)n+='\n  Connect: "OO", "Material::'.concat(t,"_").concat(i,'_default", "Model::').concat(t,"_").concat(i,'"');return"\n; Object connections\n;------------------------------------------------------------------\n\nConnections:  {\n  ".concat(e,"\n  ").concat(n,"\n}")}},{key:"_floatArrayToString",value:function(e){for(var t=[],r=0;r<e.length;++r)t[r]=e[r].toFixed(6);return t.join(",")}},{key:"_colorLayer",value:function(e,t){var r=this._floatArrayToString(e),n=ln(Array(t).keys());return"\n    LayerElementColor: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct"\n      Colors: ').concat(r,"\n      ColorIndex: ").concat(n,"\n    }")}},{key:"_normalLayer",value:function(e){var t=this._floatArrayToString(e);return"\n    LayerElementNormal: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct" \n      Normals: ').concat(t,"\n    }")}},{key:"_verticesIndices",value:function(e,t){var r=this._floatArrayToString(e);return"MultiLayer: ".concat(0,"\n    MultiTake: ").concat(1,"\n    Shading: ").concat("Y",'\n    Culling: "').concat("CullingOff",'"\n    Vertices: ').concat(r,"\n    PolygonVertexIndex: ").concat(t,"\n    GeometryVersion: ").concat(124)}},{key:"_materialProperties",value:function(e){return'Properties60:  {\n      Property: "ShadingModel", "KString", "", "Lambert"\n      Property: "MultiLayer", "bool", "",0\n      Property: "EmissiveColor", "ColorRGB", "",0,0,0\n      Property: "EmissiveFactor", "double", "",0.0000\n      Property: "AmbientColor", "ColorRGB", "",1,1,1\n      Property: "AmbientFactor", "double", "",0.0000\n      Property: "DiffuseColor", "ColorRGB", "",'.concat(e.diffuse,'\n      Property: "DiffuseFactor", "double", "",1.0000\n      Property: "Bump", "Vector3D", "",0,0,0\n      Property: "TransparentColor", "ColorRGB", "",1,1,1\n      Property: "TransparencyFactor", "double", "",0.0000\n      Property: "SpecularColor", "ColorRGB", "",').concat(e.specular,'\n      Property: "SpecularFactor", "double", "",1.0000\n      Property: "ShininessExponent", "double", "",').concat(e.shininess,'\n      Property: "ReflectionColor", "ColorRGB", "",0,0,0\n      Property: "ReflectionFactor", "double", "",1\n      Property: "Ambient", "ColorRGB", "",1,1,1\n      Property: "Diffuse", "ColorRGB", "",').concat(e.diffuse,'\n      Property: "Specular", "ColorRGB", "",').concat(e.specular,'\n      Property: "Shininess", "double", "",').concat(e.shininess,'\n      Property: "Opacity", "double", "",').concat(e.opacity,'\n      Property: "Reflectivity", "double", "",0\n    }')}}]),e}(),fc=function(){function n(e,t){var r;return W(this,n),(r=Y(this,X(n).call(this,e,t)))._data=e,r._version=t.miewVersion||"0.0-UNSPECIFIED",r._extractor=new hc,r}return A(n,Jl),p(n,[{key:"exportSync",value:function(){var e=new dc;if(!this._source)return this._result;var t=this._extractor.process(this._data);return t.version=this._version,this._result=e.getResult(t),this._result}}]),n}();fc.formats=["fbx"],fc.SourceClass=Ds;var pc,mc,_c,vc,gc,yc,xc,bc,wc,Sc,Cc,Ac,Ec,kc,Tc,Rc,Mc,Pc,Nc,Ic={loaders:ra,parsers:Kl,exporters:new Ql([tc,fc])},Lc=new me.Color,Oc=function(){function e(){W(this,e),this._width=0,this._height=0,this._widthHalf=0,this._heightHalf=0,this._vector=new me.Vector3,this._viewMatrix=new me.Matrix4,this._projectionMatrix=new me.Matrix4,this._domElement=document.createElement("div"),this._domElement.style.overflow="hidden",this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.zIndex="0",this._domElement.style.pointerEvents="none"}return p(e,[{key:"getElement",value:function(){return this._domElement}},{key:"reset",value:function(){for(var e=this.getElement();e.firstChild;)e.removeChild(e.firstChild)}},{key:"setSize",value:function(e,t){this._width=e,this._height=t,this._widthHalf=this._width/2,this._heightHalf=this._height/2,this._domElement.style.width="".concat(e,"px"),this._domElement.style.height="".concat(t,"px")}},{key:"_renderObject",value:function(e,t,r){function n(e,t,r){return Lc.setHex(e),Lc.lerp(t,r),"#".concat(Lc.getHexString())}function i(e){return Lc.setHex(e),"#".concat(Lc.getHexString())}if(e instanceof Ar){if(this._vector.setFromMatrixPosition(e.matrixWorld),void 0!==e.userData&&void 0!==e.userData.offset){var o=new me.Vector3(e.userData.offset.x,e.userData.offset.y,0);this._vector.add(o.multiplyScalar(e.matrixWorld.getMaxScaleOnAxis()))}this._vector.applyMatrix4(this._viewMatrix);var s=this._vector.z>-t.near?"hidden":"visible",a=1e4*(t.far- -this._vector.z)/(t.far-t.near),l=e.getElement();if(void 0===r.fog)l.style.color=i(e.userData.color),"transparent"!==e.userData.background&&(l.style.background=i(e.userData.background));else{var c=me.Math.smoothstep(-this._vector.z,r.fog.near,r.fog.far);l.style.color=n(e.userData.color,r.fog.color,c),"transparent"!==e.userData.background&&(l.style.background=n(e.userData.background,r.fog.color,c))}this._vector.applyMatrix4(this._projectionMatrix);var u="".concat(e.userData!=={}?e.userData.translation:"translate(-50%, -50%) ","translate(").concat(this._vector.x*this._widthHalf+this._widthHalf,"px,").concat(-this._vector.y*this._heightHalf+this._heightHalf,"px)");l.style.visibility=s,l.style.WebkitTransform=u,l.style.MozTransform=u,l.style.oTransform=u,l.style.transform=u,l.style.zIndex=Number(a).toFixed(0),l.parentNode!==this._domElement&&this._domElement.appendChild(l)}for(var h=0,d=e.children.length;h<d;h++)this._renderObject(e.children[h],t,r)}},{key:"render",value:function(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),this._viewMatrix.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),this._projectionMatrix.copy(t.projectionMatrix),this._renderObject(e,t,e)}}]),e}(),Vc=-1,Dc=0,zc=1,Fc=2,Bc=3,Uc=new me.Quaternion,Gc=new me.Matrix4;function jc(e,t,r,n){this.objects=e;var i=y(e,1);this.object=i[0],this.camera=t,this.pivot=r,this.axis=new me.Vector3(0,0,1),this.options=n,this.lastRotation={axis:new me.Vector3,angle:0}}function Hc(e,t,r,n,i){R.call(this);var o=this;this.object=e,this.objectPivot=t,this.camera=r,this.domElement=void 0!==n?n:document,this.getAltObj=i,this.enabled=!0,this.hotkeysEnabled=!0,this.screen={left:0,top:0,width:0,height:0},this.options={rotateFactor:Math.PI,axisRotateFactor:4*Math.PI,intertia:!0,dynamicDampingFactor:.1,intertiaThreshold:.001},this._state=Vc,this._mousePrevPos=new me.Vector2,this._mouseCurPos=new me.Vector2,this._mainObj=new jc([this.object],this.camera,new me.Vector3(0,0,0),this.options),this._altObj=new jc([this.object],this.camera,new me.Vector3(0,0,0),this.options),this._affectedObj=this._mainObj,this._isAltObjFreeRotationAllowed=!0,this._isTranslationAllowed=!0,this._isKeysTranslatingObj=!1,this._pressedKeys=[],this._clock=new c,this._clock.start(),this._lastUpdateTime=this._clock.getElapsedTime(),this._listeners=[{obj:o.domElement,type:"mousedown",handler:function(e){o.mousedown(e)}},{obj:o.domElement,type:"mouseup",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"mousemove",handler:function(e){o.mousemove(e)}},{obj:o.domElement,type:"mousewheel",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"DOMMouseScroll",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"mouseout",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"touchstart",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchend",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchmove",handler:function(e){o.touchmove(e)}},{obj:o.getKeyBindObject(),type:"keydown",handler:function(e){o.keydownup(e)}},{obj:o.getKeyBindObject(),type:"keyup",handler:function(e){o.keydownup(e)}},{obj:window,type:"resize",handler:function(){o.handleResize()}},{obj:window,type:"blur",handler:function(){o.resetKeys()}},{obj:o.domElement,type:"contextmenu",handler:function(e){o.contextmenu(e)}}];for(var s=0;s<this._listeners.length;s++){var a=this._listeners[s];a.obj.addEventListener(a.type,a.handler)}this.handleResize(),this.resetKeys(),this.update()}function Wc(e,t,r){R.call(this);var n=this;this.gfxObj=e,this.camera=t,this.domElement=void 0!==r?r:document,this.screen={left:0,top:0,width:0,height:0},this._lastMousePos=new me.Vector2(0,0),this._mouseTotalDist=0,this._lastClickBeginTime=-1e3,this._lastClickPos=new me.Vector2(0,0),this._clickBeginTime=0,this._clock=new c,this._clock.start(),this._listeners=[{obj:n.domElement,type:"mousedown",handler:function(e){n.mousedown(e)}},{obj:n.domElement,type:"mouseup",handler:function(e){n.mouseup(e)}},{obj:n.domElement,type:"mousemove",handler:function(e){n.mousemove(e)}},{obj:n.domElement,type:"touchstart",handler:function(e){n.touchstart(e)}},{obj:n.domElement,type:"touchend",handler:function(e){n.touchend(e)}},{obj:window,type:"resize",handler:function(){n.handleResize()}}];for(var i=0;i<this._listeners.length;i++){var o=this._listeners[i];o.obj.addEventListener(o.type,o.handler)}this.handleResize()}jc.prototype._rotate=(pc=new me.Vector3,mc=new me.Quaternion,_c=new me.Vector3,vc=new me.Matrix4,function(e){var t=0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z;if(vc.copy(this.object.matrix),t?vc.multiply(Gc.makeRotationFromQuaternion(e)):(vc.multiply(Gc.makeTranslation(this.pivot.x,this.pivot.y,this.pivot.z)),vc.multiply(Gc.makeRotationFromQuaternion(e)),vc.multiply(Gc.makeTranslation(-this.pivot.x,-this.pivot.y,-this.pivot.z))),vc.decompose(pc,mc,_c),!t)for(var r=0;r<this.objects.length;++r)this.objects[r].position.copy(pc);for(var n=0;n<this.objects.length;++n)this.objects[n].quaternion.copy(mc),this.objects[n].updateMatrix()}),jc.prototype.setObjects=function(e){this.objects=e;var t=y(e,1);this.object=t[0]},jc.prototype.rotate=(gc={axis:new me.Vector3,angle:0},function(e,t,r,n){this.mouse2rotation(gc,t,r,n),e.setFromAxisAngle(gc.axis,gc.angle),gc.angle&&this._rotate(e),this.lastRotation=gc}),jc.prototype.translate=(yc=new me.Vector3,xc=new me.Vector3,function(e){yc.set(e.x/this.camera.projectionMatrix.elements[0],e.y/this.camera.projectionMatrix.elements[5],0);var t=yc.length();yc.normalize(),yc.transformDirection(Gc.getInverse(this.object.matrixWorld)),xc.copy(this.pivot),this.object.localToWorld(xc),t*=Math.abs(xc.z-this.camera.position.z),t/=this.object.matrixWorld.getMaxScaleOnAxis();for(var r=0;r<this.objects.length;++r)this.objects[r].translateOnAxis(yc,t)}),jc.prototype.update=(bc=new me.Vector3,function(e,t){if(0!==Q.now.autoRotation)return Q.now.autoRotationAxisFixed||0===this.lastRotation.axis.length()?bc.set(0,1,0).transformDirection(Gc.getInverse(this.object.matrixWorld)):bc.copy(this.lastRotation.axis),this._rotate(Uc.setFromAxisAngle(bc,Q.now.autoRotation*e)),!0;if(this.options.intertia&&this.lastRotation.angle){var r=this.lastRotation.angle*Math.pow(1-this.options.dynamicDampingFactor,40*t);if(!(Math.abs(r)<=this.options.intertiaThreshold))return this._rotate(Uc.setFromAxisAngle(this.lastRotation.axis,r)),!0;this.lastRotation.angle=0}return!1}),jc.prototype.stop=function(){this.lastRotation.angle=0},jc.prototype.mouse2rotation=(wc=new me.Vector3,Sc=new me.Vector3,Cc=new me.Vector3,Ac=new me.Vector3,Ec=new me.Vector3,kc=new me.Vector3,Tc=new me.Vector2,function(e,t,r,n){if(n)e.axis.copy(this.axis),e.angle=this.options.axisRotateFactor*(r.y-t.y);else{Tc.subVectors(r,t);var i=Tc.length();if(0===i)return;wc.copy(this.pivot),this.object.localToWorld(wc),Sc.subVectors(this.camera.position,wc),Cc.copy(Sc).normalize(),Ac.copy(this.camera.up).normalize(),Ec.crossVectors(Ac,Cc).normalize(),Ac.setLength(Tc.y),Ec.setLength(Tc.x),kc.copy(Ac.add(Ec)),e.axis.crossVectors(kc,Sc),e.angle=-i*this.options.rotateFactor}e.axis.transformDirection(Gc.getInverse(this.object.matrixWorld)),e.angle<0&&(e.axis.negate(),e.angle=-e.angle)}),((Hc.prototype=Object.create(R.prototype)).constructor=Hc).prototype.resetKeys=function(){this._pressedKeys[37]=!1,this._pressedKeys[38]=!1,this._pressedKeys[39]=!1,this._pressedKeys[40]=!1},Hc.prototype.contextmenu=function(e){e.stopPropagation(),e.preventDefault()},Hc.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},Hc.prototype.enable=function(e){this.enabled=e},Hc.prototype.enableHotkeys=function(e){this.hotkeysEnabled=e},Hc.prototype.allowTranslation=function(e){this._isTranslationAllowed=e},Hc.prototype.allowAltObjFreeRotation=function(e){this._isAltObjFreeRotationAllowed=e},Hc.prototype.keysTranslateObj=function(e){this._isKeysTranslatingObj=e},Hc.prototype.isEditingAltObj=function(){return(this._state===Dc||this._state===zc)&&this._affectedObj===this._altObj},Hc.prototype.convertMouseToOnCircle=function(e,t,r){var n=Math.min(this.screen.width,this.screen.height);0!==n?e.set((t-.5*this.screen.width-this.screen.left)/n,(.5*this.screen.height+this.screen.top-r)/n):e.set(0,0)},Hc.prototype.convertMouseToViewport=function(e,t,r){0!==this.screen.width&&0!==this.screen.height?e.set(2*(t-.5*this.screen.width-this.screen.left)/this.screen.width,2*(.5*this.screen.height+this.screen.top-r)/this.screen.height):e.set(0,0)},Hc.prototype.stop=function(){this._mainObj.stop(),this._altObj.stop()},Hc.prototype.rotateByMouse=(Rc=new me.Quaternion,function(e){this._affectedObj.rotate(Rc,this._mousePrevPos,this._mouseCurPos,e),this.dispatchEvent({type:"change",action:"rotate",quaternion:Rc})}),Hc.prototype.rotate=function(e){this.object.quaternion.multiply(e),this.dispatchEvent({type:"change",action:"rotate",quaternion:e})},Hc.prototype.getOrientation=function(){return this.object.quaternion},Hc.prototype.setOrientation=function(e){this.object.quaternion.copy(e)},Hc.prototype.translate=(Mc=new me.Vector2,function(){Mc.subVectors(this._mouseCurPos,this._mousePrevPos),this._affectedObj.translate(Mc),this.dispatchEvent({type:"change",action:"translate"})}),Hc.prototype.getScale=function(){return this.object.scale.x},Hc.prototype.setScale=function(e){this.object.scale.set(e,e,e)},Hc.prototype.scale=function(e){e<=0||(this.setScale(this.object.scale.x*e),this.dispatchEvent({type:"change",action:"zoom",factor:e}))},Hc.prototype.update=(Pc=new me.Vector2,function(){var e=this._clock.getElapsedTime(),t=e-this._lastUpdateTime;if(this._state===Vc){var r=e-this._lastMouseMoveTime;(this._mainObj.update(t,r)||this._altObj.update(t,r))&&this.dispatchEvent({type:"change",action:"auto"})}if(this._isKeysTranslatingObj){var n=Number(this._pressedKeys[39])-Number(this._pressedKeys[37]),i=Number(this._pressedKeys[38])-Number(this._pressedKeys[40]);if(0!=n||0!=i){var o=t,s=this.getAltObj();0<s.objects.length&&(this._altObj.setObjects(s.objects),this._altObj.pivot=s.pivot,"axis"in s?this._altObj.axis=s.axis.clone():this._altObj.axis.set(0,0,1),Pc.set(o*n,o*i),this._altObj.translate(Pc),this.dispatchEvent({type:"change",action:"translate"}))}}this._lastUpdateTime=e}),Hc.prototype.reset=function(){this._state=Vc,this.object.quaternion.copy(Uc.set(0,0,0,1))},Hc.prototype.mousedown=function(e){if(!1!==this.enabled&&this._state===Vc){if(e.preventDefault(),e.stopPropagation(),this._state===Vc)if(0===e.button){this._affectedObj.stop();var t=!1;if(e.altKey){var r=this.getAltObj();(t=0<r.objects.length)&&(this._altObj.setObjects(r.objects),this._altObj.pivot=r.pivot,"axis"in r?this._altObj.axis=r.axis.clone():this._altObj.axis.set(0,0,1))}this._affectedObj=t?this._altObj:this._mainObj,this._state=t&&e.ctrlKey&&this._isTranslationAllowed?zc:Dc}else 2===e.button&&(this._state=Bc);this._state===Dc&&(this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos)),this._state!==zc&&this._state!==Bc||(this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos))}},Hc.prototype.mousemove=function(e){if(!1!==this.enabled&&this._state!==Vc)switch(e.preventDefault(),e.stopPropagation(),this._state){case Dc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this.rotateByMouse(e.altKey&&!this._isAltObjFreeRotationAllowed||e.shiftKey),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case zc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translate();break;case Bc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translatePivotByMouse()}},Hc.prototype.mousewheel=function(e){if(!1!==this.enabled&&Q.now.zooming&&this._state===Vc&&!e.shiftKey){e.preventDefault();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3);var r=1+.05*t;r=Math.max(r,.01),this.scale(r)}},Hc.prototype.mouseup=function(e){!1!==this.enabled&&this._state!==Vc&&(e.preventDefault(),e.stopPropagation(),this._state=Vc,.1<this._clock.getElapsedTime()-this._lastMouseMoveTime&&this._affectedObj.stop())},Hc.prototype.touchstartend=function(e){if(!1!==this.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this._state=Dc,this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this._mousePrevPos.copy(this._mouseCurPos);break;case 2:this._mainObj.stop(),this._altObj.stop(),this._state=Fc;var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=this._touchDistanceStart=Math.sqrt(t*t+r*r),this._scaleStart=this.object.scale.x;break;default:this._state=Vc}},Hc.prototype.touchmove=function(e){if(!1!==this.enabled&&this._state!==Vc)switch(e.preventDefault(),e.stopPropagation(),this._state){case Dc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this.rotateByMouse(!1),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case Fc:if(Q.now.zooming){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=Math.sqrt(t*t+r*r);var n=this._scaleStart*this._touchDistanceCur/this._touchDistanceStart/this.object.scale.x;this.scale(n)}}},Hc.prototype.keydownup=function(e){if(!1!==this.enabled&&!1!==this.hotkeysEnabled)switch(e.keyCode){case 37:case 38:case 39:case 40:this._pressedKeys[e.keyCode]="keydown"===e.type,e.preventDefault(),e.stopPropagation()}},Hc.prototype.getKeyBindObject=function(){return window.top},Hc.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}},Hc.prototype.translatePivotByMouse=(Nc=new me.Vector2,function(){Nc.subVectors(this._mouseCurPos,this._mousePrevPos),this.translatePivotInWorld(Q.now.translationSpeed*Nc.x,Q.now.translationSpeed*Nc.y,0)}),Hc.prototype.translatePivotInWorld=function(e,t,r){var n=this.objectPivot.position;n.applyMatrix4(this.object.matrixWorld),n.setX(n.x+e),n.setY(n.y+t),n.setZ(n.z+r),n.applyMatrix4(Gc.getInverse(this.object.matrixWorld)),this.dispatchEvent({type:"change",action:"translatePivot"})},Hc.prototype.translatePivot=function(e,t,r){var n=this.objectPivot.position;n.setX(n.x+e),n.setY(n.y+t),n.setZ(n.z+r),this.dispatchEvent({type:"change",action:"translatePivot"})},Hc.prototype.setPivot=function(e){this.objectPivot.position.copy(e),this.dispatchEvent({type:"change",action:"translatePivot"})},((Wc.prototype=Object.create(R.prototype)).constructor=Wc).prototype.reset=function(){this.picked={},this.dispatchEvent({type:"newpick",obj:{}})},Wc.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},Wc.prototype.pickObject=function(e){if(!this.gfxObj)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});var t=this.gfxObj,r=new me.Raycaster;r.ray.origin.setFromMatrixPosition(this.camera.matrixWorld),r.ray.direction.set(e.x,e.y,.5).unproject(this.camera).sub(r.ray.origin).normalize();var n=Q.now.draft.clipPlane&&this.clipPlaneValue?this.clipPlaneValue:1/0,i=Q.now.fog&&this.fogFarValue?this.fogFarValue:1/0,o=r.intersectVisibleObject(t,this.camera,n,i);if(!o)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});var s={};if(o.residue||o.atom){var a=o.residue||o.atom.residue;"chain"===Q.now.pick?s={chain:a.getChain()}:"molecule"===Q.now.pick?s={molecule:a.getMolecule()}:o.residue||"residue"===Q.now.pick?s={residue:a}:o.atom&&(s={atom:o.atom})}this.picked=s,this.dispatchEvent({type:"newpick",obj:s})},Wc.prototype.getMouseInViewport=function(e,t){return new me.Vector2((e-this.screen.left)/this.screen.width*2-1,-(t-this.screen.top)/this.screen.height*2+1)},Wc.prototype.mousedown=function(e){e.preventDefault(),e.stopPropagation(),0===e.button&&(this._lastMousePos=this.getMouseInViewport(e.pageX,e.pageY),this._mouseTotalDist=0,this._clickBeginTime=this._clock.getElapsedTime())},Wc.prototype.mousemove=function(e){e.preventDefault(),e.stopPropagation();var t=this.getMouseInViewport(e.pageX,e.pageY);this._mouseTotalDist+=t.sub(this._lastMousePos).length()},Wc.prototype.mouseup=function(e){var t=this;if(e.preventDefault(),e.stopPropagation(),0===e.button&&this._mouseTotalDist<.01){var r=this._clock.getElapsedTime(),n=this.getMouseInViewport(e.pageX,e.pageY);if(r-this._lastClickBeginTime<.7)if((new me.Vector2).subVectors(n,this._lastClickPos).length()<.01)return this.dispatchEvent({type:"dblclick",obj:this.picked}),this._lastClickPos=n,void(this._lastClickBeginTime=-1e3);setTimeout(function(){t.pickObject(n)},0),this._lastClickPos=n,this._lastClickBeginTime=this._clickBeginTime}},Wc.prototype.touchstart=function(e){e.preventDefault(),e.stopPropagation(),1===e.touches.length&&(this._lastTouchdownPos=this.getMouseInViewport(e.touches[0].pageX,e.touches[0].pageY))},Wc.prototype.touchend=function(e){var t=this;e.preventDefault(),e.stopPropagation(),0!==e.touches.length||1!==e.changedTouches.length||this.getMouseInViewport(e.changedTouches[0].pageX,e.changedTouches[0].pageY).sub(this._lastTouchdownPos).length()<.01&&setTimeout(function(){t.pickObject(t._lastTouchdownPos)},0)},Wc.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}};var Yc=function(){function r(e,t){W(this,r),this._target=e,this._targetCamera=t,this._camera=new me.PerspectiveCamera(t.fov,t.aspect,1,100),this._object=new me.AxesHelper(1),this._scene=new me.Scene,this._scene.add(this._object),this._full=new me.Vector2,this._update()}return p(r,[{key:"_update",value:function(){var e=this._targetCamera.fov,t=this._camera;t.aspect=this._targetCamera.aspect,t.setMinimalFov(e),t.setDistanceToFit(1,e),t.updateProjectionMatrix(),this._object.quaternion.copy(this._target.quaternion)}},{key:"render",value:function(e){this._update(),e.getSize(this._full);var t=.25*this._full.width,r=.25*this._full.height,n=e.autoClear;e.autoClear=!1,e.setViewport(0,0,t,r),e.clear(!1,!0,!1),e.render(this._scene,this._camera),e.setViewport(0,0,this._full.width,this._full.height),e.autoClear=n}}]),r}(),Xc=1<<19,qc=1<<20,$c=["helix","strand"],Zc=["fs","ps","ns","us"];function Kc(e,t){for(var r=t._residues,n=r.length,i=new Uint8Array(n),o=t._atoms,s=0,a=e.length;s<a;++s){i[o[s].residue._index]=e[s]}for(var l=[],c=0;c<n;){if(0!==i[c]){for(var u=c,h=i[c];c<n-1&&i[c+1]===h&&r[c].isConnected(r[c+1]);)++c;l.push({start:u,end:c,type:$c[h-1]})}++c}return l}function Qc(e){return Xc<=e?e-qc:e}var Jc=function(){function i(e,t,r){W(this,i),this._complex=e,this._secondary=null,this.isLoading=!1,this._framesRange={start:0,end:-1},this.frameIsReady=!1,this._buffer=null,this._frameRequest=null,this._callbacks=r,"function"==typeof t?(this._framesRequestLength=1,this._downloadDataFn=t):this.parseBinaryData(t,!0),this.reset(),this.setFrame(0)}return p(i,[{key:"_prepareBuffer",value:function(r,n){if(null==r&&(r=0),null==n&&(n=r+this._framesRequestLength),void 0!==this._framesCount&&(n=Math.min(this._framesCount-1,n)),this._downloadDataFn){var i=this;this._buffer||(this._buffer={}),this._buffer.state="downloading",this.isLoading=!0,i._callbacks&&"function"==typeof i._callbacks.onLoadStatusChanged&&i._callbacks.onLoadStatusChanged(),this._downloadDataFn({start:r,end:n+1},function(e){if(i.isLoading=!1,i._callbacks&&"function"==typeof i._callbacks.onLoadStatusChanged&&i._callbacks.onLoadStatusChanged(),i._buffer={data:e,state:"ready",start:r,end:n},null!==i._frameRequest){var t=i._frameRequest;i._frameRequest=null,i.setFrame(t)}},function(){i.isLoading=!1,i._callbacks&&"function"==typeof i._callbacks.onError&&i._callbacks.onError("Streaming failed")})}}},{key:"_parseBuffer",value:function(){if(this._buffer&&"ready"===this._buffer.state){this._framesRange={start:this._buffer.start,end:this._buffer.end},this.parseBinaryData(this._buffer.data,!1);var e=(this._buffer.end+1)%this._framesCount;if(e>=this._framesCount&&(e=0),this._buffer={state:"none"},this._prepareBuffer(e,e+this._framesRequestLength),null!==this._frameRequest){var t=this._frameRequest;this._frameRequest=null,this.setFrame(t)}}}},{key:"parseBinaryData",value:function(e){var t=new DataView(e),r=0,n=t.getUint32(r,!0);r+=4;var i=t.getUint32(r,!0);this._framesCount=i,this._framesRange.end=0<this._framesRange.end?Math.min(this._framesRange.end,i-1):i-1,r+=4,this._atomsCount=n;this._framesRequestLength=Math.ceil(1048576/(8*n));var o=this._framesRange.end-this._framesRange.start+1;if(n!==this._complex._atoms.length||e.byteLength!==12+o*n*8)throw new Error;for(var s=this._complex,a=t.getUint32(r,!0),l=0;1e3<a&&l<Zc.length-1;)a/=1e3,++l;this._timeStep="".concat(a.toString()," ").concat(Zc[l]),r+=4;for(var c=[],u=new Float32Array(o*n*3),h=0,d=new Int8Array(n),f=0;f<o;++f){for(var p=0;p<n;++p){var m=t.getUint32(r,!0);r+=4;var _=t.getUint32(r,!0);r+=4;var v=(4026531840&_)>>>28,g=Qc((268435200&_)>>>8>>0),y=Qc(((255&_)<<12|(4293918720&m)>>>20)>>0),x=Qc((1048575&m)>>0);(d[p]=0)<v&&v<4?d[p]=1:4==v&&(d[p]=2),u[h++]=g/100,u[h++]=y/100,u[h++]=x/100}c.push(Kc(d,s))}this._secondaryData=c,this._data=u}},{key:"nextFrame",value:function(){this.setFrame((this._currFrame+1)%this._framesCount)}},{key:"needsColorUpdate",value:function(e){return e instanceof ys}},{key:"getAtomColor",value:function(e,t){return e.getResidueColor(this._residues[t.residue._index],this._complex)}},{key:"getResidueColor",value:function(e,t){return e.getResidueColor(this._residues[t._index],this._complex)}},{key:"_updateSecondary",value:function(){var e,t=this._residues,r=t.length;for(e=0;e<r;++e)t[e]._secondary=null;var n=this._secondaryData[this._currFrame-this._framesRange.start];for(e=0,r=n.length;e<r;++e)for(var i=n[e],o=i.start,s=i.end,a={_start:t[o],_end:t[s],type:i.type,generic:i.generic},l=o;l<=s;++l)t[l]._secondary=a}},{key:"reset",value:function(){var e=this._complex._residues,t=e.length;this._residues=new Array(t);for(var r=this._residues,n=function(){return this._secondary},i=0;i<t;++i)r[i]={_type:e[i]._type,_isValid:e[i]._isValid,_controlPoint:null,_wingVector:null,_secondary:null,getSecondary:n}}},{key:"setFrame",value:function(e){if(this.frameIsReady=!1,e>=this._framesRange.start&&e<=this._framesRange.end)this._currFrame=e,this._cachedResidues=!1,this._updateSecondary(),this.frameIsReady=!0;else if(this._frameRequest=e,this._buffer){switch(this._buffer.state){case"none":this._prepareBuffer(e);break;case"ready":this._parseBuffer()}}else this._prepareBuffer(e)}},{key:"disableEvents",value:function(){this._callbacks=null}},{key:"getAtomPos",value:function(e){var t=i._vec,r=this._data,n=3*(this._atomsCount*(this._currFrame-this._framesRange.start)+e);return t.set(r[n],r[1+n],r[2+n]),t}},{key:"getResidues",value:function(){return this._cachedResidues||this._complex.updateToFrame(this),this._residues}}]),i}();Ce(Jc,"_vec",new me.Vector3);var eu=function(){function r(e,t){if(W(this,r),this.constructor===r)throw new Error("Can not instantiate abstract class!");this.params=e,this.opts=w.merge(_e.deriveDeep(Q.now.objects[this.type],!0),t),this.needsRebuild=!1,this._mesh=null,this.id=null}return p(r,[{key:"identify",value:function(){var e={type:this.type,params:this.params},t=_e.objectsDiff(this.opts,Q.now.modes[this.id]);return w.isEmpty(t)||(e.opts=t),e}},{key:"toString",value:function(){return"o=".concat(this.type,",").concat(this.params.join(","))+_e.compareOptionsWithDefaults(this.opts,Q.defaults.objects[this.type])}},{key:"getGeometry",value:function(){return this._mesh}},{key:"destroy",value:function(){this._mesh&&tn.destroyObject(this._mesh)}}]),r}();eu.prototype.type="__";var tu=function(){function i(e,t){var r;if(W(this,i),r=Y(this,X(i).call(this,e,t)),e.length<2)throw new Error("Wrong number of argumets on line object creation!");var n=y(e,2);return r._id1=n[0],r._id2=n[1],r}return A(i,eu),p(i,[{key:"_getAtomFromName",value:function(e,t){var r=e.getAtomByFullname(t);if(!r)throw new Error(t+" - Wrong atom format it must be '#CHAIN_NAME.#RESIDUE_NUMBER.#ATOM_NAME' (e.g. 'A.38.CO1')");return r}},{key:"build",value:function(e){var t=new me.Geometry;this._atom1=this._getAtomFromName(e,this._id1),this._atom2=this._getAtomFromName(e,this._id2),t.vertices[0]=this._atom1.position.clone(),t.vertices[1]=this._atom2.position.clone(),t.dynamic=!0,t.computeBoundingBox(),this._line=new Fi.Line(t,new jr({lights:!1,overrideColor:!0,dashedLine:!0,fogTransparent:Q.now.bg.transparent})),this._line.computeLineDistances(),this._line.material.setUberOptions({fixedColor:new me.Color(this.opts.color),dashedLineSize:this.opts.dashSize,dashedLinePeriod:this.opts.dashSize+this.opts.gapSize}),this._line.material.updateUniforms(),this._line.raycast=function(e,t){},this._mesh=this._line;var r=e.getTransforms();0<r.length&&(this._mesh=new me.Group,this._mesh.add(this._line),tn.applyTransformsToMeshes(this._mesh,r))}},{key:"updateToFrame",value:function(e){if(this._atom1&&this._atom2&&this._line){var t=this._line.geometry;t.vertices[0].copy(e.getAtomPos(this._atom1.index)),t.vertices[1].copy(e.getAtomPos(this._atom2.index)),this._line.computeLineDistances(),t.computeBoundingSphere(),t.verticesNeedUpdate=!0}}}]),i}();(tu.prototype.constructor=tu).prototype.type="line";var ru=function(e){function n(e){var t;W(this,n),t=Y(this,X(n).call(this,e));var r={uniforms:{srcTex:{type:"t",value:null},srcDepthTex:{type:"t",value:null},srcTexSize:{type:"v2",value:new me.Vector2(512,512)},color:{type:"v3",value:null},threshold:{type:"f",value:null},opacity:{type:"f",value:1},thickness:{type:"v2",value:new me.Vector2(1,1)}},vertexShader:kr,fragmentShader:"precision highp float;\r\n\r\nuniform sampler2D srcTex;\r\nuniform vec2 srcTexSize;\r\nuniform vec2 thickness;\r\nvarying vec2 vUv;\r\n\r\n#ifdef DEPTH_OUTLINE\r\n  uniform sampler2D srcDepthTex; //depthTexture\r\n  uniform vec3 color;\r\n  uniform float threshold;\r\n#endif\r\n\r\nvoid main() {\r\n\r\n  vec2 pixelSize = thickness / srcTexSize;\r\n\r\n  #ifdef DEPTH_OUTLINE\r\n    float c00 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,-pixelSize.y)).x;\r\n    float c01 = texture2D(srcDepthTex, vUv + vec2(0,-pixelSize.y)).x;\r\n    float c02 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,-pixelSize.y)).x;\r\n    float c10 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,0)).x;\r\n    float c12 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,0)).x;\r\n    float c20 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,pixelSize.y)).x;\r\n    float c21 = texture2D(srcDepthTex, vUv + vec2(0,pixelSize.y)).x;\r\n    float c22 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,pixelSize.y)).x;\r\n\r\n    float horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r\n    float vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r\n\r\n    float grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r\n\r\n    gl_FragColor = ( grad > threshold ) ? vec4(color.rgb, 1.0) : gl_FragColor = texture2D(srcTex, vUv);\r\n\r\n  #else\r\n    vec4 c00 = texture2D(srcTex, vUv + vec2(-pixelSize.x,-pixelSize.y));\r\n    vec4 c01 = texture2D(srcTex, vUv + vec2(0,-pixelSize.y));\r\n    vec4 c02 = texture2D(srcTex, vUv + vec2(pixelSize.x,-pixelSize.y));\r\n    vec4 c10 = texture2D(srcTex, vUv + vec2(-pixelSize.x,0));\r\n    vec4 c12 = texture2D(srcTex, vUv + vec2(pixelSize.x,0));\r\n    vec4 c20 = texture2D(srcTex, vUv + vec2(-pixelSize.x,pixelSize.y));\r\n    vec4 c21 = texture2D(srcTex, vUv + vec2(0,pixelSize.y));\r\n    vec4 c22 = texture2D(srcTex, vUv + vec2(pixelSize.x,pixelSize.y));\r\n\r\n    vec4 horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r\n    vec4 vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r\n\r\n    vec4 grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r\n    gl_FragColor = grad;\r\n  #endif\r\n}\r\n",transparent:!0,depthTest:!1,depthWrite:!1};return t.setValues(r),t}return A(n,e),p(n,[{key:"copy",value:function(e){ft(X(n.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){if(void 0!==e){ft(X(n.prototype),"setValues",this).call(this,e);var t={};this.depth&&(t.DEPTH_OUTLINE=1),this.defines=t}}}]),n}(me.RawShaderMaterial);ru.prototype.depth=!1;var nu=function(e){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this,e))).setValues.call(S(t),{uniforms:{srcTex:{type:"t",value:null},srcTexelSize:{type:"v2",value:new me.Vector2(1/512,1/512)},bgColor:{type:"c",value:new me.Color(16777215)}},vertexShader:kr,fragmentShader:"precision highp float;\r\n\r\n// edge end finding algorithm parameters\r\n#define FXAA_QUALITY_PS 8\r\n#define FXAA_QUALITY_P0 1.0\r\n#define FXAA_QUALITY_P1 1.5\r\n#define FXAA_QUALITY_P2 2.0\r\n#define FXAA_QUALITY_P3 2.0\r\n#define FXAA_QUALITY_P4 2.0\r\n#define FXAA_QUALITY_P5 2.0\r\n#define FXAA_QUALITY_P6 4.0\r\n#define FXAA_QUALITY_P7 12.0\r\n// constants\r\nfloat fxaaQualityEdgeThreshold = 0.125;\r\nfloat fxaaQualityEdgeThresholdMin = 0.0625;\r\nfloat fxaaQualitySubpix = 0.7; //0.65;\r\n// global params\r\nuniform sampler2D srcTex;\r\nuniform vec2 srcTexelSize;\r\nuniform vec3 bgColor;\r\n// from vs\r\nvarying vec2 vUv;\r\n//=====================================================================//\r\n// calc luminance from rgb\r\n//'float FxaaLuma(vec3 rgb) {return rgb.y * (0.587/0.299) + rgb.x; } // Lotte's idea about game luminance\r\nfloat FxaaLuma(vec3 rgb) {return dot(rgb, vec3(0.299, 0.587, 0.114)); } // real luminance calculation\r\n                                                                           // for non-real scene rendering\r\n// texture sampling by pixel position(coords) and offset(in pixels)\r\n vec3 FxaaTex(sampler2D tex, vec2 pos, vec2 off,  vec2 res ) {\r\n  #ifdef BG_TRANSPARENT\r\n    vec4 color = texture2D( tex, pos + off * res );\r\n    return mix(color.rgb, bgColor, 1.0 - color.a);\r\n  #else\r\n    return texture2D( tex, pos + off * res ).xyz;\r\n  #endif\r\n}\r\nvec3 FxaaTexTop(sampler2D tex, vec2 pos) {\r\n  #ifdef BG_TRANSPARENT\r\n    vec4 color = texture2D( tex, pos );\r\n    return mix(color.rgb, bgColor, 1.0 - color.a);\r\n  #else\r\n    return texture2D( tex, pos).xyz;\r\n  #endif\r\n}\r\nvec4 FxaaTexTopAlpha(sampler2D tex, vec2 pos) {\r\n  return texture2D( tex, pos);\r\n}\r\n\r\n//=====================================================================//\r\nvoid main() {\r\n  // renaming\r\n  vec2 posM = vUv;\r\n  // get luminance for neighbours\r\n  float lumaS = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, 1.0 ), srcTexelSize));\r\n  float lumaE = FxaaLuma(FxaaTex(srcTex, posM, vec2( 1.0, 0.0 ), srcTexelSize));\r\n  float lumaN = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, -1.0 ), srcTexelSize));\r\n  float lumaW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, 0.0 ), srcTexelSize));\r\n  float lumaM = FxaaLuma(FxaaTexTop(srcTex, posM));\r\n  // find max and min luminance\r\n  float rangeMax = max(max(lumaN, lumaW), max(lumaE, max(lumaS, lumaM)));\r\n  float rangeMin = min(min(lumaN, lumaW), min(lumaE, min(lumaS, lumaM)));\r\n  // calc maximum non-edge range\r\n  float rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;\r\n  float range = rangeMax - rangeMin;\r\n  float rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);\r\n  // exit when luma contrast is small (is not edge)\r\n  if(range < rangeMaxClamped){\r\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r\n    return;\r\n  }\r\n  float subpixRcpRange = 1.0/range;\r\n  // note: the sampling coordinates can be calculated in vertex shader but the approach doesn't affect performance\r\n  // visibly, thus we decided to leave calculation here for better readability.\r\n  // calc other neighbours luminance\r\n  float lumaNE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0, -1.0 ), srcTexelSize));\r\n  float lumaSW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0,  1.0 ), srcTexelSize));\r\n  float lumaSE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0,  1.0 ), srcTexelSize));\r\n  float lumaNW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, -1.0 ), srcTexelSize));\r\n/*--------------span calculation and subpix amount calulation-----------------*/\r\n  float lumaNS = lumaN + lumaS;\r\n  float lumaWE = lumaW + lumaE;\r\n  float subpixNSWE = lumaNS + lumaWE;\r\n  float edgeHorz1 = (-2.0 * lumaM) + lumaNS;\r\n  float edgeVert1 = (-2.0 * lumaM) + lumaWE;\r\n/*--------------------------------------------------------------------------*/\r\n  float lumaNESE = lumaNE + lumaSE;\r\n  float lumaNWNE = lumaNW + lumaNE;\r\n  float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;\r\n  float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;\r\n/*--------------------------------------------------------------------------*/\r\n  float lumaNWSW = lumaNW + lumaSW;\r\n  float lumaSWSE = lumaSW + lumaSE;\r\n  float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);\r\n  float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);\r\n  float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;\r\n  float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;\r\n  float edgeHorz = abs(edgeHorz3) + edgeHorz4;\r\n  float edgeVert = abs(edgeVert3) + edgeVert4;\r\n/*--------------------subpix amount calulation------------------------------*/\r\n  float subpixNWSWNESE = lumaNWSW + lumaNESE;\r\n  float lengthSign = srcTexelSize.x;\r\n  bool horzSpan = edgeHorz >= edgeVert;\r\n   // debug  code edge span visualization\r\n/*'  if (horzSpan)\r\n      gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\r\n  else\r\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\r\n  return;*/\r\n  float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;\r\n/*--------------------------------------------------------------------------*/\r\n  if(!horzSpan) lumaN = lumaW;\r\n  if(!horzSpan) lumaS = lumaE;\r\n  if(horzSpan) lengthSign = srcTexelSize.y;\r\n  float subpixB = (subpixA * (1.0/12.0)) - lumaM;\r\n/*--------------------------------------------------------------------------*/\r\n  float gradientN = lumaN - lumaM;\r\n  float gradientS = lumaS - lumaM;\r\n  float lumaNN = lumaN + lumaM;\r\n  float lumaSS = lumaS + lumaM;\r\n  bool pairN = abs(gradientN) >= abs(gradientS);\r\n  float gradient = max(abs(gradientN), abs(gradientS));\r\n  if(pairN) lengthSign = -lengthSign;\r\n  float subpixC = clamp(abs(subpixB) * subpixRcpRange, 0.0, 1.0);\r\n/*--------------------------------------------------------------------------*/\r\n  vec2 posB;\r\n  posB = posM;\r\n  vec2 offNP;\r\n  offNP.x = (!horzSpan) ? 0.0 : srcTexelSize.x;\r\n  offNP.y = ( horzSpan) ? 0.0 : srcTexelSize.y;\r\n  if(!horzSpan) posB.x += lengthSign * 0.5;\r\n  if( horzSpan) posB.y += lengthSign * 0.5;\r\n/*--------------------------------------------------------------------------*/\r\n  vec2 posN;\r\n  posN = posB - offNP * FXAA_QUALITY_P0;\r\n  vec2 posP;\r\n  posP = posB + offNP * FXAA_QUALITY_P0;\r\n  float subpixD = ((-2.0)*subpixC) + 3.0;\r\n  float lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN));\r\n  float subpixE = subpixC * subpixC;\r\n  float lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP));\r\n/*--------------------------------------------------------------------------*/\r\n  if(!pairN) lumaNN = lumaSS;\r\n  float gradientScaled = gradient * 1.0/4.0;\r\n  float lumaMM = lumaM - lumaNN * 0.5;\r\n  float subpixF = subpixD * subpixE;\r\n  bool lumaMLTZero = lumaMM < 0.0;\r\n/*---------------------looped edge-end search-------------------------------*/\r\n  lumaEndN -= lumaNN * 0.5;\r\n  lumaEndP -= lumaNN * 0.5;\r\n  bool doneN = abs(lumaEndN) >= gradientScaled;\r\n  bool doneP = abs(lumaEndP) >= gradientScaled;\r\n  if(!doneN) posN -= offNP * FXAA_QUALITY_P1;\r\n  bool doneNP = (!doneN) || (!doneP);\r\n  if(!doneP) posP += offNP * FXAA_QUALITY_P1;\r\n/*--------------------------------------------------------------------------*/\r\n  if(doneNP) {\r\n    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n    doneN = abs(lumaEndN) >= gradientScaled;\r\n    doneP = abs(lumaEndP) >= gradientScaled;\r\n    if(!doneN) posN -= offNP * FXAA_QUALITY_P2;\r\n    doneNP = (!doneN) || (!doneP);\r\n    if(!doneP) posP += offNP * FXAA_QUALITY_P2;\r\n/*--------------------------------------------------------------------------*/\r\n    #if (FXAA_QUALITY_PS > 3)\r\n      if(doneNP) {\r\n        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n        doneN = abs(lumaEndN) >= gradientScaled;\r\n        doneP = abs(lumaEndP) >= gradientScaled;\r\n        if(!doneN) posN -= offNP * FXAA_QUALITY_P3;\r\n        doneNP = (!doneN) || (!doneP);\r\n        if(!doneP) posP += offNP * FXAA_QUALITY_P3;\r\n/*--------------------------------------------------------------------------*/\r\n        #if (FXAA_QUALITY_PS > 4)\r\n          if(doneNP) {\r\n            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n            doneN = abs(lumaEndN) >= gradientScaled;\r\n            doneP = abs(lumaEndP) >= gradientScaled;\r\n            if(!doneN) posN -= offNP * FXAA_QUALITY_P4;\r\n            doneNP = (!doneN) || (!doneP);\r\n            if(!doneP) posP += offNP * FXAA_QUALITY_P4;\r\n/*--------------------------------------------------------------------------*/\r\n            #if (FXAA_QUALITY_PS > 5)\r\n               if(doneNP) {\r\n                 if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                 if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                 if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                 if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                 doneN = abs(lumaEndN) >= gradientScaled;\r\n                 doneP = abs(lumaEndP) >= gradientScaled;\r\n                 if(!doneN) posN -= offNP * FXAA_QUALITY_P5;\r\n                 doneNP = (!doneN) || (!doneP);\r\n                 if(!doneP) posP += offNP * FXAA_QUALITY_P5;\r\n/*--------------------------------------------------------------------------*/\r\n                 #if (FXAA_QUALITY_PS > 6)\r\n                   if(doneNP) {\r\n                     if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                     if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                     if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                     if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                     doneN = abs(lumaEndN) >= gradientScaled;\r\n                     doneP = abs(lumaEndP) >= gradientScaled;\r\n                     if(!doneN) posN -= offNP * FXAA_QUALITY_P6;\r\n                     doneNP = (!doneN) || (!doneP);\r\n                     if(!doneP) posP += offNP * FXAA_QUALITY_P6;\r\n/*--------------------------------------------------------------------------*/\r\n                     #if (FXAA_QUALITY_PS > 7)\r\n                       if(doneNP) {\r\n                         if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                         if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                         if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                         if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                         doneN = abs(lumaEndN) >= gradientScaled;\r\n                         doneP = abs(lumaEndP) >= gradientScaled;\r\n                         if(!doneN) posN -= offNP * FXAA_QUALITY_P7;\r\n                         doneNP = (!doneN) || (!doneP);\r\n                         if(!doneP) posP += offNP * FXAA_QUALITY_P7;\r\n/*--------------------------------------------------------------------------*/\r\n                       }\r\n                     #endif\r\n                   }\r\n                 #endif\r\n               }\r\n             #endif\r\n           }\r\n         #endif\r\n      }\r\n    #endif\r\n  }\r\n/*----------------calculate subpix offset due to edge ends-------------------*/\r\n  float dstN = posM.x - posN.x;\r\n  float dstP = posP.x - posM.x;\r\n  if(!horzSpan) dstN = posM.y - posN.y;\r\n  if(!horzSpan) dstP = posP.y - posM.y;\r\n/*--------------------------------------------------------------------------*/\r\n  bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;\r\n  float spanLength = (dstP + dstN);\r\n  bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;\r\n  float spanLengthRcp = 1.0 / spanLength;\r\n/*--------------------------------------------------------------------------*/\r\n  bool directionN = dstN < dstP;\r\n  float dst = min(dstN, dstP);\r\n  bool goodSpan = directionN ? goodSpanN : goodSpanP;\r\n  float subpixG = subpixF * subpixF;\r\n  float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;\r\n  float subpixH = subpixG * fxaaQualitySubpix;\r\n/*-----------------calc texture offest using subpix-------------------------*/\r\n  float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;\r\n  float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);\r\n\r\n  float offset = pixelOffsetSubpix * lengthSign;\r\n  #ifdef BG_TRANSPARENT\r\n    // get original texel\r\n    vec4 rgbaA = FxaaTexTopAlpha(srcTex, posM);\r\n    // calc step to blended texel\r\n    vec2 step = sign((!horzSpan) ? vec2 (offset, 0.0) : vec2 (0.0, offset));\r\n    // get neighboring texel\r\n    vec4 rgbaB = FxaaTexTopAlpha(srcTex, posM + step * srcTexelSize);\r\n    //  calc blend factor from offset\r\n    float f = (!horzSpan) ? offset / srcTexelSize.x : offset / srcTexelSize.y;\r\n    f = abs(f);\r\n    // calc alpha (special formula to emulate blending with bg)\r\n    gl_FragColor.a = 1.0 - mix(1.0 - rgbaA.a, 1.0 - rgbaB.a, f);\r\n    // calc color (special formula to emulate blending with bg)\r\n    gl_FragColor.rgb = mix(rgbaA.rgb * rgbaA.a, rgbaB.rgb * rgbaB.a, f) / gl_FragColor.a;\r\n  #else\r\n    if(!horzSpan) {\r\n       posM.x += offset;\r\n    } else {\r\n       posM.y += offset;\r\n    }\r\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r\n  #endif\r\n  return;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),t.setValues(e),t}return A(r,e),p(r,[{key:"copy",value:function(e){ft(X(r.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){if(void 0!==e){ft(X(r.prototype),"setValues",this).call(this,e);var t={};this.bgTransparent&&(t.BG_TRANSPARENT=1),this.defines=t}}}]),r}(me.RawShaderMaterial);nu.prototype.bgTransparent=!1;var iu=[new me.Vector3(.295184,.077723,.068429),new me.Vector3(-.271976,-.365221,.838363),new me.Vector3(.547713,.467576,.488515),new me.Vector3(.662808,-.031733,.584758),new me.Vector3(-.025717,.218955,.657094),new me.Vector3(-.310153,-.365223,.370701),new me.Vector3(-.101407,-.006313,.747665),new me.Vector3(-.769138,.360399,.086847),new me.Vector3(-.271988,-.27514,.905353),new me.Vector3(.09674,-.566901,.700151),new me.Vector3(.562872,-.735136,.094647),new me.Vector3(.379877,.359278,.190061),new me.Vector3(.519064,-.023055,.405068),new me.Vector3(-.301036,.114696,.088885),new me.Vector3(-.282922,.598305,.487214),new me.Vector3(-.181859,.25167,.679702),new me.Vector3(-.191463,-.635818,.512919),new me.Vector3(-.293655,.427423,.078921),new me.Vector3(-.267983,.680534,.13288),new me.Vector3(.139611,.319637,.477439),new me.Vector3(-.352086,.31104,.653913),new me.Vector3(.321032,.805279,.487345),new me.Vector3(.073516,.820734,.414183),new me.Vector3(-.155324,.589983,.41146),new me.Vector3(.335976,.170782,.527627),new me.Vector3(.46346,-.355658,.167689),new me.Vector3(.222654,.59655,.769406),new me.Vector3(.922138,-.04207,.147555),new me.Vector3(-.72705,-.329192,.369826),new me.Vector3(-.090731,.53382,.463767),new me.Vector3(-.323457,-.876559,.238524),new me.Vector3(-.663277,-.372384,.342856)],ou=function(e){function t(){var e;return W(this,t),(e=Y(this,X(t).call(this))).setValues.call(S(e),{uniforms:{noiseTexture:{type:"t",value:zr.noiseTexture},noiseTexelSize:{type:"v2",value:new me.Vector2(1/zr.noiseWidth,1/zr.noiseHeight)},diffuseTexture:{type:"t",value:null},normalTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new me.Vector2(1/512,1/512)},camNearFar:{type:"v2",value:new me.Vector2(1,10)},projMatrix:{type:"mat4",value:new me.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},samplesKernel:{type:"v3v",value:iu},kernelRadius:{type:"f",value:1},depthThreshold:{type:"f",value:1},factor:{type:"f",value:1}},vertexShader:kr,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 32\r\nuniform vec3 samplesKernel[MAX_SAMPLES_COUNT];\r\nuniform sampler2D noiseTexture;\r\nuniform vec2      noiseTexelSize;\r\nuniform sampler2D diffuseTexture;\r\nuniform sampler2D depthTexture;\r\nuniform sampler2D normalTexture;\r\nuniform vec2      srcTexelSize;\r\nuniform vec2      camNearFar;\r\nuniform mat4      projMatrix;\r\n\r\nuniform float aspectRatio;\r\nuniform float tanHalfFOV;\r\n\r\nuniform float kernelRadius;\r\nuniform float depthThreshold;\r\nuniform float factor;\r\n\r\nvarying vec2 vUv;\r\n\r\nfloat CalcViewZ(vec2 screenPos)\r\n{\r\n  float depth = texture2D(depthTexture, screenPos).x;\r\n  // [0, 1]->[-1, 1]\r\n  float clipedZ = 2.0 * depth - 1.0;\r\n  // see THREE.js camera.makeFrustum for projection details\r\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r\n}\r\n\r\nvec3 ViewPosFromDepth(vec2 screenPos)\r\n{\r\n  vec3 viewPos;\r\n  viewPos.z = CalcViewZ(screenPos);\r\n  //[0, 1]->[-1, 1]\r\n  vec2 projPos = 2.0 * screenPos - 1.0;\r\n  // reconstruct viewposition in right-handed sc with z to viewer\r\n  viewPos.xy = vec2(\r\n                    projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r\n                    projPos.y * tanHalfFOV * abs(viewPos.z)\r\n                   );\r\n  return viewPos;\r\n}\r\n\r\nvoid main() {\r\n  vec3 viewPos = ViewPosFromDepth(vUv);\r\n  // remap coordinates to prevent noise exture rescale\r\n  vec2 vUvNoise = vUv / srcTexelSize * noiseTexelSize;\r\n  vec4 normalData = texture2D(normalTexture, vUv);\r\n  // return for background fragments (their normals are zero vectors)\r\n  if (length(normalData.rgb) < EPSILON) {\r\n    // 0.0 in alpha component means that it is background fragment\r\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\r\n    return;\r\n  }\r\n  //[0, 1] -> [-1, 1]\r\n  vec3 normal = (normalData.rgb * 2.0 - 1.0);\r\n  // normalData.a store 1.0 if normal was build for frontfaced surface\r\n  // and 0.0 in other case\r\n  if (normalData.a < EPSILON) {\r\n    normal *= -1.0;\r\n  }\r\n  // get random vector for sampling sphere rotation\r\n  vec3 randN = texture2D(noiseTexture, vUvNoise).rgb * 2.0 - 1.0;\r\n  randN = normalize(randN);\r\n  // build TBN (randomly rotated around normal)\r\n  vec3 tangent   = normalize(randN - normal * dot(randN, normal));\r\n  vec3 bitangent = cross(tangent, normal);\r\n  mat3 TBN = mat3(tangent, bitangent, normal);\r\n  // calc AO value\r\n  float AO = 0.0;\r\n  for (int i = 0 ; i < MAX_SAMPLES_COUNT ; i++) {\r\n    // rotate sampling kernel around normal\r\n    vec3 reflectedSample = TBN * samplesKernel[i];\r\n    // get sample\r\n    vec3 samplePos = viewPos + reflectedSample * kernelRadius;\r\n\r\n    // project sample to screen to get sample's screen pos\r\n    vec4 SampleScrPos = vec4(samplePos, 1.0);\r\n    // eye -> clip\r\n    SampleScrPos = projMatrix * SampleScrPos;\r\n    // normalize\r\n    SampleScrPos.xy /= SampleScrPos.w;\r\n    //[-1, 1] -> [0, 1]\r\n    SampleScrPos.xy = (SampleScrPos.xy + vec2(1.0)) * 0.5;\r\n\r\n    // get view z for sample projected to the objct surface\r\n    float sampleDepth = CalcViewZ(SampleScrPos.xy);\r\n    // calc occlusion made by object surface at the sample\r\n    AO += step(samplePos.z, sampleDepth);\r\n  }\r\n  // calc result AO-map color\r\n  AO = 1.0 - max(0.0, AO / float(MAX_SAMPLES_COUNT) * factor);\r\n  // write value to AO-map\r\n  gl_FragColor = vec4(AO, AO, AO, 1.0);\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),e}return A(t,e),t}(me.RawShaderMaterial),su=[-2,-1,0,1,2],au=function(e){function t(){var e;return W(this,t),(e=Y(this,X(t).call(this))).setValues.call(S(e),{uniforms:{depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new me.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:su}},vertexShader:kr,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 5\r\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\r\nuniform sampler2D aoMap;\r\nuniform sampler2D depthTexture;\r\nuniform vec2      srcTexelSize;\r\n\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  float x = vUv.x;\r\n  float y = vUv.y;\r\n  vec4 res = vec4(0.0);\r\n  res.a = texture2D(aoMap, vec2(x, y )).a;\r\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\r\n  if (res.a < EPSILON) {\r\n    gl_FragColor = res;\r\n    return;\r\n  }\r\n\r\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r\n  float weightSum = 0.0;\r\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r\n    if (texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).a < EPSILON) {\r\n      continue;\r\n    }\r\n    vec2 samplePos = vec2(x + samplesOffsets[i] * srcTexelSize.x, y);\r\n    float depth = texture2D(depthTexture, samplePos).x;\r\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r\n    res.rgb += texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).rgb * weight;\r\n    weightSum += weight;\r\n  }\r\n  res.rgb = res.rgb / weightSum;\r\n  gl_FragColor = res;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),e}return A(t,e),t}(me.RawShaderMaterial),lu=[-2,-1,0,1,2],cu=function(e){function r(e){var t;return W(this,r),(t=Y(this,X(r).call(this,e))).setValues.call(S(t),{uniforms:{diffuseTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new me.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:lu},projMatrix:{type:"mat4",value:new me.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},fogNearFar:{type:"v2",value:new me.Vector2(100,100)},fogColor:{type:"v4",value:new me.Vector4(0,.5,0,1)}},vertexShader:kr,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 5\r\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\r\nuniform sampler2D diffuseTexture;\r\nuniform sampler2D aoMap;\r\nuniform sampler2D depthTexture;\r\nuniform vec2      srcTexelSize;\r\n\r\nuniform mat4  projMatrix;\r\nuniform float aspectRatio;\r\nuniform float tanHalfFOV;\r\n\r\n#ifdef USE_FOG\r\n  uniform vec2 fogNearFar;\r\n  uniform vec4 fogColor;\r\n#endif\r\nvarying vec2 vUv;\r\n\r\nfloat CalcViewZ(vec2 screenPos)\r\n{\r\n  float depth = texture2D(depthTexture, screenPos).x;\r\n  // [0, 1]->[-1, 1]\r\n  float clipedZ = 2.0 * depth - 1.0;\r\n  // see THREE.js camera.makeFrustum for projection details\r\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r\n}\r\n\r\nvec3 ViewPosFromDepth(vec2 screenPos)\r\n{\r\n  vec3 viewPos;\r\n  viewPos.z = CalcViewZ(screenPos);\r\n  //[0, 1]->[-1, 1]\r\n  vec2 projPos = 2.0 * screenPos - 1.0;\r\n  // reconstruct viewposition in right-handed sc with z to viewer\r\n  viewPos.xy = vec2(\r\n  projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r\n  projPos.y * tanHalfFOV * abs(viewPos.z)\r\n  );\r\n  return viewPos;\r\n}\r\n\r\nvoid main() {\r\n  vec3 viewPos = ViewPosFromDepth(vUv);\r\n  float x = vUv.x;\r\n  float y = vUv.y;\r\n  vec4 color = texture2D(diffuseTexture, vec2(x, y));\r\n  vec4 res = vec4(0.0);\r\n  res.a = texture2D(aoMap, vec2(x, y )).a;\r\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\r\n  if (res.a < EPSILON) {\r\n    gl_FragColor = color;\r\n    return;\r\n  }\r\n\r\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r\n  float weightSum = 0.0;\r\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r\n    if (texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).a < EPSILON) {\r\n      continue;\r\n    }\r\n    vec2 samplePos = vec2(x, y + samplesOffsets[i] * srcTexelSize.y);\r\n    float depth = texture2D(depthTexture, samplePos).x;\r\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r\n    res.rgb += texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).rgb * weight;\r\n    weightSum += weight;\r\n  }\r\n  res.rgb /= weightSum;\r\n\r\n  #if defined(USE_FOG) && !defined(FOG_TRANSPARENT)\r\n    // Add fog to the result value\r\n    // Proper way to get an image with fog and ao requires formula:\r\n    //          gl_FragColor = fragColor*AO*(1-fogFactor) + fogColor*fogFactor\r\n    // But we have already fogged molecule to add AO too. Let's split the straight formula into our real steps!\r\n    // We have:  AO, fogFactor, fogColor,\r\n    //          color = fragColor*(1-fogFactor) + fogColor*fogFactor (it comes from diffuseTexture,\r\n    //                                                                where molecule has been already drawn with fog)\r\n    // Transform:\r\n    //          fragColor*AO*(1-fogFactor) + fogColor*fogFactor =\r\n    //        = [fragColor*(1-fogFactor) = color - fogColor*fogFactor] =\r\n    //        = (color - fogColor*fogFactor)*AO + fogColor*fogFactor =\r\n    //        = color*AO + fogColor*fogFactor*(1 - AO)\r\n    // Result:  gl_FragColor = color*AO + fogColor*fogFactor*(1 - AO)\r\n    float fogFactor = smoothstep(fogNearFar.x, fogNearFar.y, - viewPos.z) * fogColor.a;\r\n    gl_FragColor.rgb = color.rgb * res.rgb + fogColor.rgb * fogFactor *(vec3(1.0, 1.0, 1.0) - res.rgb);\r\n  #else\r\n    gl_FragColor.rgb = color.rgb * res.rgb;\r\n  #endif\r\n  gl_FragColor.a = color.a;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),t.setValues(e),t}return A(r,e),p(r,[{key:"setValues",value:function(e){if(void 0!==e){ft(X(r.prototype),"setValues",this).call(this,e);var t={};this.useFog&&(t.USE_FOG=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.defines=t}}}]),r}(me.RawShaderMaterial);cu.prototype.useFog=!0,cu.prototype.fogTransparent=!1;var uu=function(e){function r(){var e;W(this,r),e=Y(this,X(r).call(this));var t={uniforms:{srcL:{type:"t",value:null},srcR:{type:"t",value:null}},vertexShader:kr,fragmentShader:"precision highp float;\r\n\r\nuniform sampler2D srcL;\r\nuniform sampler2D srcR;\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vec4 l = texture2D(srcL, vUv);\r\n  vec4 r = texture2D(srcR, vUv);\r\n  gl_FragColor = vec4(l.r, r.g, r.b, 1.0);\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1};return e.setValues(t),e}return A(r,e),r}(me.RawShaderMaterial),hu=function(){function e(){W(this,e),this.position=new me.Vector3(0,0,0),this.scale=1,this.orientation=new me.Quaternion(0,0,0,1)}return p(e,[{key:"set",value:function(e,t,r){this.position=e,this.scale=t,this.orientation=r}}]),e}(),du=function(){function e(){W(this,e)}return p(e,[{key:"setup",value:function(e,t){this._startTime=void 0,this._endTime=void 0,this._isPaused=!1,this._srcView=e,this._dstView=t,this._isMoving=!1}},{key:"isMoving",value:function(){return this._isMoving}},{key:"wasStarted",value:function(){return void 0!==this._startTime&&void 0!==this._endTime}},{key:"start",value:function(){this._startTime=Date.now();var e=Q.now.interpolateViews?1500:0;this._endTime=this._startTime+e,this._isMoving=!0}},{key:"getCurrentView",value:function(){if(void 0===this._srcView||void 0===this._dstView||!this._isMoving||!this.wasStarted())return{success:!1};var e=this.createView(),t=Date.now();if(t>this._endTime)return e=this._dstView,this.reset(),{success:!0,view:e};var r=(t-this._startTime)/(this._endTime-this._startTime);return e.position.copy(this._srcView.position),e.position.lerp(this._dstView.position,r),e.scale=(1-r)*this._srcView.scale+r*this._dstView.scale,e.orientation.copy(this._srcView.orientation),e.orientation.slerp(this._dstView.orientation,r),{success:!0,view:e}}},{key:"reset",value:function(){this._startTime=this._endTime=0,this._isMoving=!1}},{key:"pause",value:function(){this._isPaused||(this.setup(this.getCurrentView().view,this._dstView),this._isPaused=!0)}},{key:"resume",value:function(){this._isPaused=!1}},{key:"createView",value:function(){return new hu}}]),e}();function fu(e,t){this.context=e,this._opts=w.merge({path:"/"},t)}function pu(i){function e(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="transparent",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator){var r=document.createElement("button");return r.style.display="none",e(r),navigator.xr.isSessionSupported("immersive-vr").then(function(e){return e?function(t){t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR";var r=null;function n(){r.removeEventListener("end",n),t.textContent="ENTER VR",r=null}function e(e){e.addEventListener("end",n),i._gfx.renderer.xr.setReferenceSpaceType("local"),i._gfx.renderer.xr.setSession(e),t.textContent="EXIT VR",r=e}t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){if(null===r){navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}).then(e),i.moveSceneBehindHeadset()}else r.end()}}(r):((t=r).style.display="",t.style.cursor="auto",t.style.left="calc(50% - 75px)",t.style.width="150px",t.textContent="VR NOT FOUND",t.onmouseenter=null,t.onmouseleave=null,void(t.onclick=null));var t}),r}var t=document.createElement("a");return t.href="https://webvr.info",t.innerHTML="WEBXR NOT SUPPORTED",t.style.left="calc(50% - 90px)",t.style.width="180px",t.style.textDecoration="none",e(t),t}hn(fu.prototype),fu.prototype.removeCookie=function(e){var t=this._toCount(e),r=this._getSimpleCookie(t);if(r){this._removeSimpleCookie(t),r=parseInt(r,10);for(var n=0;n<r;++n)this._removeSimpleCookie(e+n)}else this._removeSimpleCookie(e)},fu.prototype.setCookie=function(e,t){this.removeCookie(e);var r=function(e,t){for(var r=e.length,n=[],i=0,o=0;o<r;i++,o+=t)n[i]=e.slice(o,o+t);return n}(t=encodeURIComponent(t),4e3-e.length-1),n=r.length;if(1!==n){var i=this._toCount(e);this._setSimpleCookie(i,n.toString());for(var o=0;o<n;++o)this._setSimpleCookie(e+o,r[o])}else this._setSimpleCookie(e,t)},fu.prototype.getCookie=function(e){var t=this._toCount(e),r=this._getSimpleCookie(t);if(!r)return this._getSimpleCookie(e);r=parseInt(r,10);for(var n=[],i=0;i<r;++i)n[i]=this._getSimpleCookie(e+i);return n.join("")},fu.prototype._toCount=function(e){return e+"Cnt"},fu.prototype._removeSimpleCookie=function(e){document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;")},fu.prototype._getExpirationDate=function(){var e=new Date;return e.setFullYear(e.getFullYear()+10),e},fu.prototype._setSimpleCookie=function(e,t){document.cookie="".concat(e,"=").concat(t,";expires=").concat(this._getExpirationDate().toUTCString(),";path=").concat(this._opts.path)},fu.prototype._getSimpleCookie=function(e){var t=document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")));return t?decodeURIComponent(t[1]):""},fu.prototype._exists=function(e){return document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")))};var mu,_u,vu,gu,yu,xu,bu,wu,Su,Cu,Au,Eu,ku,Tu,Ru,Mu,Pu,Nu,Iu,Lu,Ou,Vu,Du,zu,Fu,Bu,Uu,Gu=function(){function t(e){W(this,t),this._mainCamera=new me.PerspectiveCamera,this._button=null,this._onToggle=e,this._molContainer=new tn.RCGroup,this._user=new tn.RCGroup,this._scalingPivot=new me.Object3D,this._user.add(this._scalingPivot),this._controller1=null,this._controller2=null,this._pressedGripsCounter=0,this._distance=0,this._gfx=null}return p(t,[{key:"startScalingByControllers",value:function(){this._distance=this._controller1.position.distanceTo(this._controller2.position),tn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),this._scalingPivot.scale.set(1,1,1),this._scalingPivot.updateMatrix(),this._scalingPivot.updateMatrixWorld(),this._scalingPivot.addSavingWorldTransform(this._molContainer)}},{key:"stopScalingByControllers",value:function(){this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsDown",value:function(e){this._pressedGripsCounter++,2===this._pressedGripsCounter?this.startScalingByControllers():1===this._pressedGripsCounter&&e.target.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsUp",value:function(e){(this._pressedGripsCounter--,1===this._pressedGripsCounter)?(this.stopScalingByControllers(),(e.target===this._controller1?this._controller2:this._controller1).addSavingWorldTransform(this._molContainer)):0===this._pressedGripsCounter&&this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"enable",value:function(e){if(e){var t=(this._gfx=e).renderer,r=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");if(!r)throw new Error("No camera is available to toggle WebVR");t.xr.enabled=!0,this._button?this._button.style.display="block":(this._button=pu(this),document.body.appendChild(this._button)),this._mainFog=Q.now.fog,Q.set("fog",!1),this._plugVRNodesIntoScene(e,t),this._setControllersListeners(),this._onToggle&&this._onToggle(!0)}else I.warn("WebVR couldn't be enabled, because gfx is not defined")}},{key:"_plugVRNodesIntoScene",value:function(e,t){this._mainCamera.copy(e.camera),e.scene.add(this._user),e.scene.add(this._molContainer),this._molContainer.add(e.root),this._controller1=t.xr.getController(0),this._controller2=t.xr.getController(1);var r=this._createControllerMesh();this._controller1.add(r),this._controller2.add(r.clone()),this._user.add(this._controller1),this._user.add(this._controller2)}},{key:"_setControllersListeners",value:function(){var t=this;this._controller1.addEventListener("selectstart",function(e){t.handleGripsDown(e)}),this._controller1.addEventListener("selectend",function(e){t.handleGripsUp(e)}),this._controller2.addEventListener("selectstart",function(e){t.handleGripsDown(e)}),this._controller2.addEventListener("selectend",function(e){t.handleGripsUp(e)}),this._controller1.addEventListener("squeezestart",function(e){t.handleGripsDown(e)}),this._controller1.addEventListener("squeezeend",function(e){t.handleGripsUp(e)}),this._controller2.addEventListener("squeezestart",function(e){t.handleGripsDown(e)}),this._controller2.addEventListener("squeezeend",function(e){t.handleGripsUp(e)})}},{key:"disable",value:function(){if(this._gfx){var e=this._gfx,t=e.renderer,r=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");t.setAnimationLoop(null);var n=t.xr.getSession();n&&n.end(),t.xr.enabled=!1,this._button&&(this._button.style.display="none"),Q.set("fog",this._mainFog),this._unplugVRNodesFromScene(r),this._onToggle&&this._onToggle(!1)}}},{key:"_unplugVRNodesFromScene",value:function(e){this._mainCamera&&e&&e.copy(this._mainCamera);var t=this._molContainer.children[0];t&&this._gfx.scene.add(t),this._molContainer.parent.remove(this._molContainer),this._user&&this._gfx.scene.remove(this._user),this._molContainer=null,this._user=null,this._scalingPivot=null,this._user=null,this._controller1=null,this._controller2=null}},{key:"_createControllerMesh",value:function(){var e=new me.CylinderGeometry(.04,.04,.3),t=new jr({lights:!1,overrideColor:!0});t.setUberOptions({fixedColor:new me.Color(4474111)}),t.updateUniforms();var r=new me.Mesh(e,t);return r.rotateX(-Math.PI/2),r}},{key:"updateMoleculeScale",value:function(){if(this._controller1&&this._controller2){if(2===this._pressedGripsCounter){tn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position);var e=this._controller1.position.distanceTo(this._controller2.position),t=e/this._distance;this._scalingPivot.scale.multiplyScalar(t),this._distance=e}}}},{key:"moveSceneBehindHeadset",value:function(){var e=this._gfx,t=e.camera,r=this._molContainer;r.matrix.identity(),r.position.set(0,0,-4),r.updateMatrix(),r.matrixWorld.multiplyMatrices(t.matrixWorld,r.matrix),e.scene.addSavingWorldTransform(r),this._onToggle&&this._onToggle(!0)}},{key:"getCanvas",value:function(){var e=this._gfx;return e&&e.renderer?e.renderer.domElement:null}}]),t}(),ju=Cr.selectors,Hu=Cr.Atom,Wu=Cr.Residue,Yu=Cr.Chain,Xu=Cr.Molecule,qu=0,$u=1,Zu=2,Ku="Could not find suitable loader for this source",Qu=_e.createElement;function Ju(e){var t=e.lastIndexOf(".");return 0<=t&&(e=e.substr(0,t)),e}function eh(e,t,r){void 0!==r?e.debug("".concat(t,"... ").concat(Math.floor(100*r),"%")):e.debug("".concat(t,"..."))}function th(){return Q.now.fogColorEnable?Q.now.fogColor:Q.now.bg.color}function rh(e){R.call(this),this._opts=w.merge({settingsCookie:"settings",cookiePath:"/"},e),this._gfx=null,this._interpolator=new du,this._container=e&&e.container||document.getElementById("miew-container")||w.head(document.getElementsByClassName("miew-container"))||document.body,this._containerRoot=this._container,this._running=!1,this._halting=!1,this._building=!1,this._needRender=!0,this._hotKeysEnabled=!0,this.settings=Q;var t=I;t.console=!1,t.level="info",this.logger=t,this._cookies=new fu(this),this.restoreSettings(),e&&e.settings&&this.settings.set(e.settings),this._spinner=null,this._loading=[],this._animInterval=null,this._visuals={},this._curVisualName=null,this._objects=[],this._sourceWindow=null,this.reset(),this._repr&&t.debug("Selected ".concat(this._repr.mode.name," mode with ").concat(this._repr.colorer.name," colorer."));var r=this;rh.registeredPlugins.forEach(function(e){e.call(r)}),this._initOnSettingsChanged()}function nh(e,t){for(var r=e;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(t)}function ih(e){return e.getExtension("EXT_frag_depth")}function oh(e){return e.getExtension("WEBGL_depth_texture")&&e.getExtension("WEBGL_draw_buffers")}((rh.prototype=Object.create(R.prototype)).constructor=rh).prototype.getMaxRepresentationCount=function(){return Ds.NUM_REPRESENTATION_BITS},rh.prototype._updateShadowCamera=(mu=new me.Matrix4,_u=new me.Vector3,vu={center:new me.Vector3,halfSize:new me.Vector3},function(){this._gfx.scene.updateMatrixWorld();for(var e=0;e<this._gfx.scene.children.length;e++)if("DirectionalLight"===this._gfx.scene.children[e].type){var t=this._gfx.scene.children[e];mu.copy(t.shadow.camera.matrixWorldInverse),this.getOBB(mu,vu),_u.subVectors(t.target.position,t.position),t.position.subVectors(vu.center,_u),t.target.position.copy(vu.center),t.shadow.bias=.09,t.shadow.camera.bottom=-vu.halfSize.y,t.shadow.camera.top=vu.halfSize.y,t.shadow.camera.right=vu.halfSize.x,t.shadow.camera.left=-vu.halfSize.x,t.shadow.camera.near=_u.length()-vu.halfSize.z,t.shadow.camera.far=_u.length()+vu.halfSize.z,t.shadow.camera.updateProjectionMatrix()}}),rh.prototype.init=function(){var e=this._container,t=_e.createElement("div",{class:"miew-canvas"});nh(e,t),this._container=t;var r=document.createDocumentFragment();if(r.appendChild(this._msgMode=Qu("div",{class:"mode-message overlay"},Qu("p",{},"COMPONENT EDIT MODE"))),r.appendChild(this._msgAtomInfo=Qu("div",{class:"atom-info overlay"},Qu("p",{},""))),e.appendChild(r),null!==this._gfx)return!0;var n=this;this._showMessage("Viewer is being initialized...");try{this._initGfx(),this._initListeners(),this._spinner=new a({lines:13,length:28,width:14,radius:42,color:"#fff",zIndex:700}),window.top.addEventListener("keydown",function(e){n._onKeyDown(e)}),window.top.addEventListener("keyup",function(e){n._onKeyUp(e)}),this._objectControls=new Hc(this._gfx.root,this._gfx.pivot,this._gfx.camera,this._gfx.renderer.domElement,function(){return n._getAltObj()}),this._objectControls.addEventListener("change",function(e){switch(Q.now.shadow.on&&n._updateShadowCamera(),e.action){case"rotate":n.dispatchEvent({type:"rotate",quaternion:e.quaternion});break;case"zoom":n.dispatchEvent({type:"zoom",factor:e.factor});break;default:n.dispatchEvent({type:e.action})}n.dispatchEvent({type:"transform"}),n._needRender=!0});var i=this._gfx;this._picker=new Wc(i.root,i.camera,i.renderer.domElement),this._picker.addEventListener("newpick",function(e){n._onPick(e)}),this._picker.addEventListener("dblclick",function(e){n.center(e)})}catch(e){if("TypeError"===e.name&&"Cannot read property 'getExtension' of null"===e.message)this._showMessage("Could not create WebGL context.");else{if(!(1<e.message.search(/webgl/i)))throw this._showMessage("Viewer initialization failed."),e;this._showMessage(e.message)}return!1}var o=this._opts&&this._opts.load;if(o){var s=this._opts&&this._opts.type;this.load(o,{fileType:s,keepRepsInfo:!0})}return!0},rh.prototype.term=function(){this._showMessage("Viewer has been terminated."),this._loading.forEach(function(e){e.cancel()}),this._loading.length=0,this.halt(),this._gfx=null},rh.prototype._showMessage=function(e){var t=document.createElement("div");t.setAttribute("class","miew-message"),t.appendChild(document.createElement("p")).appendChild(document.createTextNode(e)),nh(this._container,t)},rh.prototype._showCanvas=function(){nh(this._container,this._gfx.renderer.domElement)},rh.prototype._requestAnimationFrame=function(e){var t=this._gfx.renderer.xr;t&&t.enabled?this._gfx.renderer.setAnimationLoop(e):requestAnimationFrame(e)},rh.prototype._initGfx=function(){var e={width:this._container.clientWidth,height:this._container.clientHeight},t={preserveDrawingBuffer:!0,alpha:!0,premultipliedAlpha:!1};Q.now.antialias&&(t.antialias=!0),e.renderer2d=new Oc,e.renderer=new me.WebGLRenderer(t),e.renderer.shadowMap.enabled=Q.now.shadow.on,e.renderer.shadowMap.autoUpdate=!1,e.renderer.shadowMap.type=me.PCFShadowMap,Mr.init(e.renderer),ih(e.renderer.getContext())||Q.set("zSprites",!1),oh(e.renderer.getContext())||Q.set("ao",!1),e.renderer.autoClear=!1,e.renderer.setPixelRatio(window.devicePixelRatio),e.renderer.setSize(e.width,e.height),e.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent)),e.renderer.clearColor(),e.renderer2d.setSize(e.width,e.height),e.camera=new me.PerspectiveCamera(Q.now.camFov,e.width/e.height,Q.now.camNear,Q.now.camFar),e.camera.setMinimalFov(Q.now.camFov),e.camera.position.z=Q.now.camDistance,e.camera.updateProjectionMatrix(),e.camera.layers.set(tn.LAYERS.DEFAULT),e.camera.layers.enable(tn.LAYERS.VOLUME),e.camera.layers.enable(tn.LAYERS.VOLUME_BFPLANE),e.stereoCam=new me.StereoCamera,e.scene=new me.Scene;var r=th();e.scene.fog=new me.Fog(r,Q.now.camNear,Q.now.camFar),e.root=new tn.RCGroup,e.scene.add(e.root),e.pivot=new tn.RCGroup,e.root.add(e.pivot),e.selectionScene=new me.Scene,e.selectionRoot=new me.Group,e.selectionRoot.matrixAutoUpdate=!1,e.selectionScene.add(e.selectionRoot),e.selectionPivot=new me.Group,e.selectionPivot.matrixAutoUpdate=!1,e.selectionRoot.add(e.selectionPivot);var n=new me.DirectionalLight(16777215,.45);n.position.set(0,.414,1),n.layers.enable(tn.LAYERS.TRANSPARENT),n.castShadow=!0,n.shadow=new me.DirectionalLightShadow,n.shadow.bias=.09,n.shadow.radius=Q.now.shadow.radius,n.shadow.camera.layers.set(tn.LAYERS.SHADOWMAP);var i=e.renderer.getPixelRatio(),o=Math.max(e.width,e.height)*i;n.shadow.mapSize.width=o,n.shadow.mapSize.height=o,n.target.position.set(0,0,0),e.scene.add(n),e.scene.add(n.target);var s=new me.AmbientLight(6710886);s.layers.enable(tn.LAYERS.TRANSPARENT),e.scene.add(s),e.axes=new Yc(e.root,e.camera);var a=e.width*i,l=e.height*i;e.offscreenBuf=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.NearestFilter,format:me.RGBAFormat,depthBuffer:!0}),e.renderer.getContext().getExtension("WEBGL_depth_texture")&&(e.offscreenBuf.depthTexture=new me.DepthTexture,e.offscreenBuf.depthTexture.type=me.UnsignedShortType),e.offscreenBuf2=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,depthBuffer:!1}),e.offscreenBuf3=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,depthBuffer:!1}),e.offscreenBuf4=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,depthBuffer:!1}),e.volBFTex=e.offscreenBuf3,e.volFFTex=e.offscreenBuf4,e.volWFFTex=e.offscreenBuf,e.renderer.getContext().getExtension("OES_texture_float")?(e.offscreenBuf5=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,type:me.FloatType,depthBuffer:!1}),e.offscreenBuf6=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,type:me.FloatType,depthBuffer:!1}),e.offscreenBuf7=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,type:me.FloatType,depthBuffer:!0}),e.volBFTex=e.offscreenBuf5,e.volFFTex=e.offscreenBuf6,e.volWFFTex=e.offscreenBuf7):this.logger.warn("Device doesn't support OES_texture_float extension"),e.stereoBufL=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,depthBuffer:!1}),e.stereoBufR=new me.WebGLRenderTarget(a,l,{minFilter:me.LinearFilter,magFilter:me.LinearFilter,format:me.RGBAFormat,depthBuffer:!1}),this._gfx=e,this._showCanvas(),this._embedWebXR("WEBVR"===Q.now.stereo),this._container.appendChild(e.renderer2d.getElement());var c=new _;c.domElement.style.position="absolute",c.domElement.style.right="0",c.domElement.style.bottom="0",this._container.appendChild(c.domElement),this._fps=c,this._fps.show(Q.now.fps)},rh.prototype._initListeners=function(){var e=this;window.addEventListener("resize",function(){e._onResize()})},rh.prototype._makeUniqueVisualName=function(e){if(!e)return Math.random().toString();for(var t=e,r=1;this._visuals.hasOwnProperty(t);)t="".concat(e," (").concat(r.toString(),")"),r++;return t},rh.prototype._addVisual=function(e){if(!e)return null;var t=this._makeUniqueVisualName(e.name);return e.name=t,this._visuals[t]=e,this._gfx.pivot.add(e),e.getSelectionGeo&&this._gfx.selectionPivot.add(e.getSelectionGeo()),t},rh.prototype._removeVisual=function(e){var t="",r=null;e instanceof nn?(t=e.name,r=e):"string"==typeof e&&(t=e,r=this._visuals[t]),r&&this._visuals.hasOwnProperty(t)&&this._visuals[t]===r&&(t===this._curVisualName&&(this._curVisualName=void 0),delete this._visuals[t],r.release(),this._needRender=!0)},rh.prototype._forEachVisual=function(e){for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&e(this._visuals[t])},rh.prototype._releaseAllVisuals=function(){if(this._gfx&&this._gfx.pivot){for(var e in this._visuals)this._visuals.hasOwnProperty(e)&&this._visuals[e].release();this._visuals={}}},rh.prototype._forEachComplexVisual=function(e){if(this._gfx&&this._gfx.pivot)for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&this._visuals[t]instanceof Ds&&e(this._visuals[t])},rh.prototype._getComplexVisual=function(t){t=t||this._curVisualName;var r=null,n=null;return this._forEachComplexVisual(function(e){(r=e).name===t&&(n=e)}),n||r},rh.prototype._getVolumeVisual=function(){var t=null;return this._forEachVisual(function(e){e instanceof $s&&(t=e)}),t},rh.prototype._getVisualForComplex=function(t){if(!t)return null;var r=null;return this._forEachComplexVisual(function(e){e.getComplex()===t&&(r=e)}),r},rh.prototype.getVisuals=function(){return Object.keys(this._visuals)},rh.prototype.getComplexVisualsCount=function(){var e=0;return this._forEachComplexVisual(function(){return e++}),e},rh.prototype.getCurrentVisual=function(){return this._curVisualName},rh.prototype.setCurrentVisual=function(e){this._visuals[e]&&(this._curVisualName=e)},rh.prototype.run=function(){var e=this;if(!this._running){if(this._running=!0,this._halting)return void(this._halting=!1);this._objectControls.enable(!0),this._interpolator.resume(),this._requestAnimationFrame(function(){return e._onTick()})}},rh.prototype.halt=function(){this._running&&(this._discardComponentEdit(),this._discardFragmentEdit(),this._objectControls.enable(!1),this._interpolator.pause(),this._halting=!0)},rh.prototype.enableHotKeys=function(e){this._hotKeysEnabled=e,this._objectControls.enableHotkeys(e)},rh.prototype._onResize=function(){this._needRender=!0;var e=this._gfx;e.width=this._container.clientWidth,e.height=this._container.clientHeight,e.camera.aspect=e.width/e.height,e.camera.setMinimalFov(Q.now.camFov),e.camera.updateProjectionMatrix(),e.renderer.setSize(e.width,e.height),e.renderer2d.setSize(e.width,e.height),this.dispatchEvent({type:"resize"})},rh.prototype._resizeOffscreenBuffers=function(e,t,r){var n=this._gfx,i="NONE"===(r=r||"NONE")||"ANAGLYPH"===r,o=i?1:.5;n.offscreenBuf.setSize(o*e,t),n.offscreenBuf2.setSize(o*e,t),n.offscreenBuf3.setSize(o*e,t),n.offscreenBuf4.setSize(o*e,t),n.offscreenBuf5&&n.offscreenBuf5.setSize(o*e,t),n.offscreenBuf6&&n.offscreenBuf6.setSize(o*e,t),n.offscreenBuf7&&n.offscreenBuf7.setSize(o*e,t),i&&(n.stereoBufL.setSize(e,t),n.stereoBufR.setSize(e,t))},rh.prototype._onTick=function(){var e=this;if(this._halting)return this._running=!1,void(this._halting=!1);this._fps.update(),this._requestAnimationFrame(function(){return e._onTick()}),this._onUpdate(),this._needRender&&(this._onRender(),this._needRender=!Q.now.suspendRender||"WEBVR"===Q.now.stereo)},rh.prototype._getBSphereRadius=function(){var t=0;return this._forEachVisual(function(e){t=Math.max(t,e.getBoundaries().boundingSphere.radius)}),t*this._objectControls.getScale()},rh.prototype.getOBB=(gu=new me.Sphere,yu=new me.Box3,xu=new me.Box3,bu=new me.Matrix4,wu=[new me.Vector3,new me.Vector3,new me.Vector3,new me.Vector3],function(t,e){xu.makeEmpty(),this._forEachVisual(function(e){gu.copy(e.getBoundaries().boundingSphere),gu.applyMatrix4(e.matrixWorld).applyMatrix4(t),gu.getBoundingBox(yu),xu.union(yu)}),xu.getCenter(e.center),bu.getInverse(t),e.center.applyMatrix4(bu);var r=xu.min,n=xu.max;wu[0].set(r.x,r.y,r.z),wu[1].set(n.x,r.y,r.z),wu[2].set(r.x,n.y,r.z),wu[3].set(r.x,r.y,n.z);for(var i=0,o=wu.length;i<o;i++)wu[i].applyMatrix4(bu);e.halfSize.set(Math.abs(wu[0].x-wu[1].x),Math.abs(wu[0].y-wu[2].y),Math.abs(wu[0].z-wu[3].z)).multiplyScalar(.5)}),rh.prototype._updateFog=function(){var e,t,r,n=this._gfx;if(Q.now.fog){if(void 0===n.scene.fog||null===n.scene.fog){var i=th();n.scene.fog=new me.Fog(i),this._setUberMaterialValues({fog:Q.now.fog})}e=n.scene.fog,t=n.camera.position.z,r=this._getBSphereRadius(),e.near=t-r*Q.now.fogNearFactor,e.far=t+r*Q.now.fogFarFactor}else n.scene.fog&&(n.scene.fog=void 0,this._setUberMaterialValues({fog:Q.now.fog}))},rh.prototype._onUpdate=function(){void 0!==this.isScriptingCommandAvailable&&this.isScriptingCommandAvailable()&&!this._building&&this.callNextCmd(),this._objectControls.update(),this._forEachComplexVisual(function(e){e.getComplex().update()}),Q.now.autobuild&&!this._loading.length&&!this._building&&this._needRebuild()&&this.rebuild(),this._loading.length||this._building||this._needRebuild()||this._updateView(),this._updateFog(),this._gfx.renderer.xr.enabled&&this.webVR.updateMoleculeScale()},rh.prototype._onRender=function(){var e=this._gfx;e.scene.updateMatrixWorld(),e.camera.updateMatrixWorld(),this._clipPlaneUpdateValue(this._getBSphereRadius()),this._fogFarUpdateValue(),e.renderer.setRenderTarget(null),e.renderer.clear(),this._renderFrame(Q.now.stereo)},rh.prototype._renderFrame=(Su=new uu,Cu=new me.Vector2,function(e){var t=this._gfx,r=t.renderer;r.getSize(Cu),"NONE"!==e&&(t.camera.focus=t.camera.position.z,t.stereoCam.aspect=1,"ANAGLYPH"===e?t.stereoCam.update(t.camera):t.stereoCam.updateHalfSized(t.camera,Q.now.camFov));var n=t.renderer.getPixelRatio();switch(this._resizeOffscreenBuffers(Cu.width*n,Cu.height*n,e),this._renderShadowMap(),e){case"WEBVR":case"NONE":this._renderScene(t.camera,!1);break;case"SIMPLE":case"DISTORTED":r.setScissorTest(!0),r.setScissor(0,0,Cu.width/2,Cu.height),r.setViewport(0,0,Cu.width/2,Cu.height),this._renderScene(this._gfx.stereoCam.cameraL,"DISTORTED"===e),r.setScissor(Cu.width/2,0,Cu.width/2,Cu.height),r.setViewport(Cu.width/2,0,Cu.width/2,Cu.height),this._renderScene(this._gfx.stereoCam.cameraR,"DISTORTED"===e),r.setScissorTest(!1);break;case"ANAGLYPH":this._renderScene(this._gfx.stereoCam.cameraL,!1,t.stereoBufL),this._renderScene(this._gfx.stereoCam.cameraR,!1,t.stereoBufR),r.setRenderTarget(null),Su.uniforms.srcL.value=t.stereoBufL.texture,Su.uniforms.srcR.value=t.stereoBufR.texture,t.renderer.renderScreenQuad(Su)}t.renderer2d.render(t.scene,t.camera),Q.now.axes&&t.axes&&!t.renderer.xr.enabled&&t.axes.render(r)}),rh.prototype._onBgColorChanged=function(){var e=this._gfx,t=th();e&&(e.scene.fog&&e.scene.fog.color.set(t),e.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent))),this._needRender=!0},rh.prototype._onFogColorChanged=function(){var e=this._gfx,t=th();e&&e.scene.fog&&e.scene.fog.color.set(t),this._needRender=!0},rh.prototype._setUberMaterialValues=function(t){this._gfx.root.traverse(function(e){(e instanceof me.Mesh||e instanceof me.LineSegments||e instanceof me.Line)&&e.material instanceof jr&&(e.material.setValues(t),e.material.needsUpdate=!0)})},rh.prototype._enableMRT=function(e,t,r){var n=this._gfx,i=n.renderer.getContext(),o=i.getExtension("WEBGL_draw_buffers"),s=n.renderer.properties;if(e){n.renderer.setRenderTarget(r);var a=s.get(r.texture).__webglTexture;i.bindTexture(i.TEXTURE_2D,a),n.renderer.setRenderTarget(t);var l=s.get(t).__webglFramebuffer,c=s.get(t.texture).__webglTexture;i.bindFramebuffer(i.FRAMEBUFFER,l),l.width=t.width,l.height=t.height,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,c,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,a,0),o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,o.COLOR_ATTACHMENT1_WEBGL])}else o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,null])},rh.prototype._renderScene=function(e,t,r){t=t||!1,r=r||null;var n=this._gfx;if(n.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent)),n.renderer.setRenderTarget(r),n.renderer.clear(),n.renderer.xr.enabled)n.renderer.render(n.scene,e);else{n.renderer.setClearColor(0,0),n.renderer.setRenderTarget(n.offscreenBuf4),n.renderer.clearColor(),n.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent)),n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.clear();var i=null!==this._getComplexVisual(),o=this._getVolumeVisual(),s=i&&Q.now.ao;s&&this._enableMRT(!0,n.offscreenBuf,n.offscreenBuf4),"prepass"===Q.now.transparency?this._renderWithPrepassTransparency(e,n.offscreenBuf):"standard"===Q.now.transparency&&(n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.render(n.scene,e)),s&&this._enableMRT(!1,null,null);var a=i&&Q.now.outline.on,l=i&&Q.now.fxaa,c=null!==o&&null!=o.getMesh().material,u=s||a||c||l||t?n.offscreenBuf2:r,h=n.offscreenBuf;s?(this._performAO(h,n.offscreenBuf4,n.offscreenBuf.depthTexture,u,n.offscreenBuf3,n.offscreenBuf2),l||t||c||a||(h=u,u=r,n.renderer.setRenderTarget(u),n.renderer.renderScreenQuadFromTex(h.texture,1))):(n.renderer.setRenderTarget(u),n.renderer.renderScreenQuadFromTex(h.texture,1)),a&&(h=u,u=c||l||t?n.offscreenBuf3:r,null!=h&&this._renderOutline(e,n.offscreenBuf,h,u)),this._renderSelection(e,n.offscreenBuf,u),c&&(n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.renderScreenQuadFromTex(u.texture,1),u=n.offscreenBuf,this._renderVolume(o,e,u,n.volBFTex,n.volFFTex,n.volWFFTex),l||t||(n.renderer.setRenderTarget(r),n.renderer.renderScreenQuadFromTex(u.texture,1))),h=u,l&&(u=t?n.offscreenBuf4:r,this._performFXAA(h,u),h=u),t&&(u=r,this._performDistortion(h,u,!0))}},rh.prototype._performDistortion=(Au=new me.Scene,Eu=new me.OrthographicCamera(-1,1,1,-1,-500,1e3),ku=new me.RawShaderMaterial({uniforms:{srcTex:{type:"t",value:null},aberration:{type:"fv3",value:new me.Vector3(1)}},vertexShader:kr,fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform vec3 aberration;\r\n\r\nvoid main() {\r\n  vec2 uv = vUv * 2.0 - 1.0;\r\n  \r\n  gl_FragColor.r = texture2D(srcTex, 0.5 * (uv * aberration[0] + 1.0)).r;\r\n  gl_FragColor.g = texture2D(srcTex, 0.5 * (uv * aberration[1] + 1.0)).g;\r\n  gl_FragColor.b = texture2D(srcTex, 0.5 * (uv * aberration[2] + 1.0)).b;\r\n  gl_FragColor.a = 1.0;\r\n}",transparent:!1,depthTest:!1,depthWrite:!1}),Tu=tn.buildDistorionMesh(10,10,Q.now.debug.stereoBarrel),Au.add(new Fi.Mesh(Tu,ku)),function(e,t,r){this._gfx.renderer.setRenderTarget(t),this._gfx.renderer.clear(),r?(ku.uniforms.srcTex.value=e.texture,ku.uniforms.aberration.value.set(.995,1,1.01),this._gfx.renderer.render(Au,Eu)):this._gfx.renderer.renderScreenQuadFromTexWithDistortion(e,Q.now.debug.stereoBarrel)}),rh.prototype._renderOutline=(Ru=new ru({depth:!0}),function(e,t,r,n){var i=this._gfx;Ru.uniforms.srcTex.value=r.texture,Ru.uniforms.srcDepthTex.value=t.depthTexture,Ru.uniforms.srcTexSize.value.set(t.width,t.height),Ru.uniforms.color.value=new me.Color(Q.now.outline.color),Ru.uniforms.threshold.value=Q.now.outline.threshold,Ru.uniforms.thickness.value=new me.Vector2(Q.now.outline.thickness,Q.now.outline.thickness),i.renderer.setRenderTarget(n),i.renderer.renderScreenQuad(Ru)}),rh.prototype._renderShadowMap=(Mu={minFilter:me.NearestFilter,magFilter:me.NearestFilter,format:me.RGBAFormat},function(){if(Q.now.shadow.on){var e=this._gfx,t=e.renderer.getRenderTarget(),r=e.renderer.getActiveCubeFace(),n=e.renderer.getActiveMipmapLevel(),i=e.renderer.state;i.setBlending(me.NoBlending),i.buffers.color.setClear(1,1,1,1),i.buffers.depth.setTest(!0),i.setScissorTest(!1);for(var o=0;o<e.scene.children.length;o++)if("DirectionalLight"===e.scene.children[o].type){var s=e.scene.children[o];null==s.shadow.map&&(s.shadow.map=new me.WebGLRenderTarget(s.shadow.mapSize.width,s.shadow.mapSize.height,Mu),s.shadow.camera.updateProjectionMatrix()),s.shadow.updateMatrices(s),e.renderer.setRenderTarget(s.shadow.map),e.renderer.clear(),e.renderer.render(e.scene,s.shadow.camera)}e.renderer.setRenderTarget(t,r,n)}}),rh.prototype._hasSelectionToRender=function(){for(var e=this._gfx.selectionPivot,t=0;t<e.children.length;t++){if(0<e.children[t].children.length)return!0}return!1},rh.prototype._renderSelection=(Pu=new ru,function(e,t,r){var n=this._gfx;n.renderer.setClearColor("black",0),n.renderer.setRenderTarget(t),n.renderer.clear(!0,!1,!1),this._hasSelectionToRender()?(n.selectionRoot.matrix=n.root.matrix,n.selectionPivot.matrix=n.pivot.matrix,n.renderer.render(n.selectionScene,e)):n.renderer.renderDummyQuad(),n.renderer.setRenderTarget(r),n.renderer.renderScreenQuadFromTex(t.texture,.6),Pu.uniforms.srcTex.value=t.texture,Pu.uniforms.srcTexSize.value.set(t.width,t.height),n.renderer.renderScreenQuad(Pu)}),rh.prototype._checkVolumeRenderingSupport=function(e){if(!e)return!1;var t=this._gfx,r=t.renderer.getRenderTarget();t.renderer.setRenderTarget(e);var n=t.renderer.getContext(),i=n.checkFramebufferStatus(n.FRAMEBUFFER);return t.renderer.setRenderTarget(r),i===n.FRAMEBUFFER_COMPLETE||(this.logger.warn("Device doesn't support electron density rendering"),!1)},rh.prototype._renderVolume=(Iu=new Ws.BackFacePosMaterial,Lu=new Ws.FrontFacePosMaterial,Ou=(new me.Matrix4).makeTranslation(.5,.5,.5),Vu=new me.Matrix4,function(e,t,r,n,i,o){var s=this._gfx;if(void 0===Nu&&(Nu=this._checkVolumeRenderingSupport(n)),Nu){var a=e.getMesh();a.rebuild(s.camera),s.renderer.setClearColor("black",0),s.renderer.setRenderTarget(n),s.renderer.clear(),s.renderer.setRenderTarget(i),s.renderer.clear(),s.renderer.setRenderTarget(o),s.renderer.clear(),s.renderer.setRenderTarget(n),t.layers.set(tn.LAYERS.VOLUME_BFPLANE),s.renderer.render(s.scene,t),t.layers.set(tn.LAYERS.VOLUME),s.scene.overrideMaterial=Iu,s.renderer.render(s.scene,t),s.renderer.setRenderTarget(i),t.layers.set(tn.LAYERS.VOLUME),s.scene.overrideMaterial=Lu,s.renderer.render(s.scene,t),s.scene.overrideMaterial=null,t.layers.set(tn.LAYERS.DEFAULT),Vu.getInverse(a.matrixWorld),jr.prototype.uberOptions.world2colorMatrix.multiplyMatrices(Ou,Vu),t.layers.set(tn.LAYERS.COLOR_FROM_POSITION),s.renderer.setRenderTarget(o),s.renderer.render(s.scene,t);var l=a.material;l.uniforms._BFRight.value=n.texture,l.uniforms._FFRight.value=i.texture,l.uniforms._WFFRight.value=o.texture,t.layers.set(tn.LAYERS.VOLUME),s.renderer.setRenderTarget(r),s.renderer.render(s.scene,t),t.layers.set(tn.LAYERS.DEFAULT)}}),rh.prototype._renderWithPrepassTransparency=function(e,t){var r=this._gfx;r.renderer.setRenderTarget(t),e.layers.set(tn.LAYERS.DEFAULT),r.renderer.render(r.scene,e),e.layers.set(tn.LAYERS.PREPASS_TRANSPARENT),r.renderer.getContext().colorMask(!1,!1,!1,!1),r.renderer.render(r.scene,e),r.renderer.getContext().colorMask(!0,!0,!0,!0),e.layers.set(tn.LAYERS.TRANSPARENT),r.renderer.render(r.scene,e),e.layers.set(tn.LAYERS.DEFAULT)},rh.prototype._performFXAA=(Du=new nu,function(e,t){if(void 0!==e&&void 0!==t){var r=this._gfx;r.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent)),r.renderer.setRenderTarget(t),r.renderer.clear(),Du.uniforms.srcTex.value=e.texture,Du.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),Du.uniforms.bgColor.value.set(Q.now.bg.color),Du.bgTransparent!==Q.now.bg.transparent&&(Du.setValues({bgTransparent:Q.now.bg.transparent}),Du.needsUpdate=!0),r.renderer.renderScreenQuad(Du)}}),rh.prototype._performAO=(zu=new ou,Fu=new au,Bu=new cu,Uu=new me.Vector3,function(e,t,r,n,i,o){if(e&&t&&r&&n&&i&&o){var s=this._gfx,a=Math.tan(.5*me.Math.DEG2RAD*s.camera.fov);zu.uniforms.diffuseTexture.value=e.texture,zu.uniforms.depthTexture.value=r,zu.uniforms.normalTexture.value=t.texture,zu.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),zu.uniforms.camNearFar.value.set(s.camera.near,s.camera.far),zu.uniforms.projMatrix.value=s.camera.projectionMatrix,zu.uniforms.aspectRatio.value=s.camera.aspect,zu.uniforms.tanHalfFOV.value=a,s.root.matrix.extractScale(Uu),zu.uniforms.kernelRadius.value=Q.now.debug.ssaoKernelRadius*Uu.x,zu.uniforms.depthThreshold.value=2*this._getBSphereRadius(),zu.uniforms.factor.value=Q.now.debug.ssaoFactor,s.renderer.setRenderTarget(o),s.renderer.renderScreenQuad(zu),Fu.uniforms.aoMap.value=o.texture,Fu.uniforms.srcTexelSize.value.set(1/o.width,1/o.height),Fu.uniforms.depthTexture.value=r,s.renderer.setRenderTarget(i),s.renderer.renderScreenQuad(Fu),Bu.uniforms.aoMap.value=i.texture,Bu.uniforms.diffuseTexture.value=e.texture,Bu.uniforms.srcTexelSize.value.set(1/i.width,1/i.height),Bu.uniforms.depthTexture.value=r,Bu.uniforms.projMatrix.value=s.camera.projectionMatrix,Bu.uniforms.aspectRatio.value=s.camera.aspect,Bu.uniforms.tanHalfFOV.value=a;var l=s.scene.fog;l&&(Bu.uniforms.fogNearFar.value.set(l.near,l.far),Bu.uniforms.fogColor.value.set(l.color.r,l.color.g,l.color.b,Q.now.fogAlpha)),Bu.useFog===Q.now.fog&&Bu.fogTransparent===Q.now.bg.transparent||(Bu.setValues({useFog:Q.now.fog,fogTransparent:Q.now.bg.transparent}),Bu.needsUpdate=!0),s.renderer.setRenderTarget(n),s.renderer.renderScreenQuad(Bu)}}),rh.prototype.reset=function(){this._picker&&this._picker.reset(),this._lastPick=null,this._releaseAllVisuals(),this._setEditMode(qu),this._resetObjects(),this._gfx&&(tn.clearTree(this._gfx.pivot),this._gfx.renderer2d.reset()),this.setNeedRender()},rh.prototype._resetScene=function(){this._objectControls.reset(),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.resetReps(),this.resetPivot(),this.rebuildAll()},rh.prototype.resetView=function(){this._picker&&this._picker.reset(),this._setEditMode(qu),this._resetScene(),this._forEachComplexVisual(function(e){e.updateSelectionMask({}),e.rebuildSelectionGeometry()})},rh.prototype._export=function(e){var t=w.head(Ic.exporters.find({format:e}));if(!t)return this.logger.error("Could not find suitable exporter for this source"),Promise.reject(new Error("Could not find suitable exporter for this source"));if(this.dispatchEvent({type:"exporting"}),this._visuals[this._curVisualName]instanceof Ds){var r=null;return t.SourceClass===Ds?r=this._visuals[this._curVisualName]:t.SourceClass===br&&(r=this._visuals[this._curVisualName]._complex),new t(r,{miewVersion:rh.VERSION}).export().then(function(e){return e})}return this._visuals[this._curVisualName]instanceof $s?Promise.reject(new Error("Sorry, exporter for volume data not implemented yet")):Promise.reject(new Error("Unexpected format of data"))};var sh,ah,lh,ch,uh,hh,dh=/^(?:(pdb|cif|mmtf|ccp4|dsn6):\s*)?(\d[a-z\d]{3})$/i,fh=/^(?:pc|pubchem):\s*([a-z]+)$/i,ph=/^([a-z][a-z\d\-+.]*):/i;function mh(p,m,_){return new Promise(function(e){if(_.shouldCancel())throw new Error("Operation cancelled");_.notify({type:"fetching"}),p=function(e,t){if(!w.isString(e))return e;var r=dh.exec(e);if(r){var n=y(r,3),i=n[1],o=void 0===i?"pdb":i,s=n[2];switch(o=o.toLowerCase(),s=s.toUpperCase(),o){case"pdb":e="https://files.rcsb.org/download/".concat(s,".pdb");break;case"cif":e="https://files.rcsb.org/download/".concat(s,".cif");break;case"mmtf":e="https://mmtf.rcsb.org/v1.0/full/".concat(s);break;case"ccp4":e="https://www.ebi.ac.uk/pdbe/coordinates/files/".concat(s.toLowerCase(),".ccp4");break;case"dsn6":e="https://edmaps.rcsb.org/maps/".concat(s.toLowerCase(),"_2fofc.dsn6");break;default:throw new Error("Unexpected data format shortcut")}return t.fileType=o,t.fileName="".concat(s,".").concat(o),t.sourceType="url",e}var a=fh.exec(e);if(a){var l=a[1].toLowerCase();return e="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/".concat(l,"/JSON?record_type=3d"),t.fileType="pubchem",t.fileName="".concat(l,".json"),t.sourceType="url",e}return"url"!==t.sourceType&&void 0!==t.sourceType||(t.sourceType="url",ph.test(e)||(e=_e.resolveURL(e))),e}(p,m);var t=w.head(Ic.loaders.find({type:m.sourceType,source:p}));if(!t)throw new Error(Ku);var r=m.fileName||t.extractName(p);if(r){var n=_e.splitFileName(r),i=y(n,2),o=i[0],s=i[1];w.defaults(m,{name:o,fileExt:s,fileName:r})}!function(e){var t=e.binary;if(void 0!==e.fileType){var r=w.head(Ic.parsers.find({format:e.fileType}));if(!r)throw new Error("Could not find suitable parser for this format");t=r.binary||!1}if(void 0===t&&void 0!==e.fileExt){var n=w.head(Ic.parsers.find({ext:e.fileExt}));n&&(t=n.binary||!1)}void 0!==e.fileExt&&".man"===e.fileExt.toLowerCase()&&(e.binary=!0,e.animation=!0),void 0!==t&&void 0!==e.binary&&e.binary!==t&&e.context.logger.warn("Overriding incorrect binary mode"),e.binary=t||!1}(m);var a=w.get(m,"preset.expression");if(!w.isUndefined(a)&&(a=JSON.parse(a))&&a.settings)for(var l=["singleUnit"],c=0,u=l.length;c<u;++c){var h=l[c],d=w.get(a.settings,h);w.isUndefined(d)||Q.set(h,d)}var f=new t(p,m);f.context=m.context,_.addEventListener("cancel",function(){return f.abort()}),f.addEventListener("progress",function(e){e.lengthComputable&&0<e.total?eh(f.logger,"Fetching",e.loaded/e.total):eh(f.logger,"Fetching")}),e(f.load().then(function(e){return m.context.logger.info("Fetching finished"),_.notify({type:"fetchingDone",data:e}),e}).catch(function(e){throw m.context.logger.debug(e.message),e.stack&&m.context.logger.debug(e.stack),m.context.logger.error("Fetching failed"),_.notify({type:"fetchingDone",error:e}),e}))})}function _h(e,t){return e.mask&1<<t}function vh(e,t){return t.selector.includesAtom(e)}rh.prototype.load=function(e,r){var n=this;r=w.merge({},r,{context:this}),this.settings.now.use.multiFile||(this._loading.length&&(this._loading.forEach(function(e){e.cancel()}),this._loading.length=0),r.animation||this.reset(!0)),this._interpolator.reset(),this.dispatchEvent({type:"loading",options:r,source:e});var i=new $;this._loading.push(i),i.addEventListener("notification",function(e){n.dispatchEvent(e.slaveEvent)}),this._spinner.spin(this._container);function o(e){var t=n._loading.indexOf(i);return-1!==t&&n._loading.splice(t,1),n._spinner.stop(),n._refreshTitle(),i.notify({type:"loadingDone",anything:e}),e}return mh(e,r,i).then(function(e){return function(e,t,r){if(r.shouldCancel())return Promise.reject(new Error("Operation cancelled"));r.notify({type:"parsing"});var n=w.head(Ic.parsers.find({format:t.fileType,ext:t.fileExt,data:e}));if(!n)return Promise.reject(new Error("Could not find suitable parser"));var i=new n(e,t);return i.context=t.context,r.addEventListener("cancel",function(){return i.abort()}),i.parse().then(function(e){return r.notify({type:"parsingDone",data:e}),e}).catch(function(e){throw t.error=e,t.context.logger.debug(e.message),e.stack&&t.context.logger.debug(e.stack),t.context.logger.error("Parsing failed"),r.notify({type:"parsingDone",error:e}),e})}(e,r,i)}).then(function(e){var t=n._onLoad(e,r);return o(t)}).catch(function(e){throw n.logger.error("Could not load data"),n.logger.debug(e),o(e)})},rh.prototype.unload=function(e){this._removeVisual(e||this.getCurrentVisual()),this.resetPivot(),Q.now.shadow.on&&this._updateShadowCamera()},rh.prototype._startAnimation=function(e){this._stopAnimation();var t=this,r=this._getComplexVisual();if(null!==r){try{this._frameInfo=new Jc(r.getComplex(),e,{onLoadStatusChanged:function(){t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:!t._frameInfo||t._frameInfo.isLoading}})},onError:function(e){t._stopAnimation(),t.logger.error(e)}})}catch(e){return void this.logger.error("Animation file does not fit to current complex!")}this._continueAnimation()}else this.logger.error("Unable to start animation - no molecule is loaded.")},rh.prototype._pauseAnimation=function(){null!==this._animInterval&&(this._isAnimating=!1,clearInterval(this._animInterval),this._animInterval=null,this._frameInfo&&this.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:this._isAnimating,isLoading:this._frameInfo.isLoading}}))},rh.prototype._continueAnimation=function(){this._isAnimating=!0;var e=1e3/Q.now.maxfps;e=Number.isNaN(e)?0:e;var t=this,r=t._gfx.pivot,n=this._getComplexVisual();n&&(n.resetSelectionMask(),n.rebuildSelectionGeometry(),this._msgAtomInfo.style.opacity=0),this._animInterval=setInterval(function(){if(t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:t._frameInfo.isLoading}}),t._frameInfo.frameIsReady){r.updateToFrame(t._frameInfo),t._updateObjsToFrame(t._frameInfo),t._refreshTitle(" Frame ".concat(t._frameInfo._currFrame," of ").concat(t._frameInfo._framesCount," time interval - ").concat(t._frameInfo._timeStep));try{t._frameInfo.nextFrame()}catch(e){return t.logger.error("Error during animation"),void t._stopAnimation()}t._needRender=!0}},e)},rh.prototype._stopAnimation=function(){null!==this._animInterval&&(clearInterval(this._animInterval),this._frameInfo.disableEvents(),this._frameInfo=null,this._animInterval=null,this.dispatchEvent({type:"mdPlayerStateChanged",state:null}))},rh.prototype._onLoad=function(e,t){var r,n=this._gfx,i=null;if(t.animation)return this._refreshTitle(),this._startAnimation(e),null;if(this._stopAnimation(),t&&t.keepRepsInfo||(this._opts.reps=null,this._opts._objects=null),"Complex"===e.id){var o=e;t.fileName?o.name=o.name||Ju(t.fileName).toUpperCase():t.amberFileName?o.name=o.name||Ju(t.amberFileName).toUpperCase():o.name="Dynamic ".concat(t.fileType," molecule"),i=this._addVisual(new Ds(o.name,o)),this._curVisualName=i;var s=this.info();if(this.logger.info("Parsed ".concat(t.fileName," (").concat(s.atoms," atoms, ").concat(s.bonds," bonds, ").concat(s.residues," residues, ").concat(s.chains," chains).")),w.isNumber(this._opts.unit)&&o.setCurrentUnit(this._opts.unit),!t.preset)if(Q.now.autoPreset)switch(t.fileType){case"cml":this.resetReps("small");break;case"pdb":case"mmtf":case"cif":r=!1,o.forEachComponent(function(e){e.forEachResidue(function(e){e._isValid&&(r=!0)})}),r?this.resetReps("macro"):this.resetReps("small");break;default:this.resetReps("default")}else this.resetReps("default")}else"Volume"===e.id&&(this.resetEd(),i=this._onLoadEd(e));return n.camera.updateProjectionMatrix(),this._updateFog(),n.root.resetTransform(),this.resetPivot(),this._objectControls.setScale(Q.now.radiusToFit/this._getBSphereRadius()),this._resetObjects(),Q.now.autoResolution&&this._tweakResolution(),Q.now.shadow.on&&this._updateShadowCamera(),this._opts.view&&(this.view(this._opts.view),delete this._opts.view),this._refreshTitle(),i},rh.prototype.resetEd=function(){this._edLoader&&(this._edLoader.abort(),this._edLoader=null),this._removeVisual(this._getVolumeVisual()),this._needRender=!0},rh.prototype.loadEd=function(e){var n=this;this.resetEd();var t=w.head(Ic.loaders.find({source:e}));if(!t)return this.logger.error(Ku),Promise.reject(new Error(Ku));var r=this._edLoader=new t(e,{binary:!0});return r.context=this,r.load().then(function(e){var t=w.head(Ic.parsers.find({format:"ccp4"}));if(!t)throw new Error("Could not find suitable parser for this source");var r=new t(e);return r.context=n,r.parse().then(function(e){n._onLoadEd(e)})}).catch(function(e){n.logger.error("Could not load ED data"),n.logger.debug(e)})},rh.prototype._onLoadEd=function(e){e.normalize();var t=new $s("volume",e);t.getMesh().layers.set(tn.LAYERS.VOLUME);var r=this._addVisual(t);return this._needRender=!0,r},rh.prototype._needRebuild=function(){var t=!1;return this._forEachComplexVisual(function(e){t=t||e.needsRebuild()}),t},rh.prototype._rebuildObjects=function(){var r,n,i=this,o=this._gfx,e=[];for(r=0;r<o.pivot.children.length;++r){var t=o.pivot.children[r];t instanceof nn||e.push(t)}for(r=0;r<e.length;++r)e[r].parent.remove(e[r]);setTimeout(function(){var e=i._objects;for(r=0,n=e.length;r<n;++r){var t=e[r];t.needsRebuild&&t.build(),t.getGeometry()&&o.pivot.add(t.getGeometry())}},10)},rh.prototype.changeUnit=function(e,t){var r=this._getComplexVisual(t);if(!r)throw new Error("There is no complex to change!");function n(){var e=r?r.getComplex().getCurrentUnit():0,t=0<e?"Bio molecule ".concat(e):"Asymmetric unit";return"Current unit: ".concat(e," (").concat(t,")")}return void 0===e||(w.isString(e)&&(e=Math.max(parseInt(e,10),0)),r.getComplex().setCurrentUnit(e)&&(this._resetScene(),this._updateInfoPanel())),n()},rh.prototype.rebuild=function(){var e=this;if(this._building)this.logger.warn("Miew.rebuild(): already building!");else{this._building=!0,this.dispatchEvent({type:"rebuilding"}),this._rebuildObjects(),this._gfx.renderer2d.reset();var r=[];this._forEachComplexVisual(function(t){t.needsRebuild()&&r.push(t.rebuild().then(function(){return new Promise(function(e){t.rebuildSelectionGeometry(),e()})}))});var t=this;this._spinner.spin(this._container),Promise.all(r).then(function(){t._spinner.stop(),t._needRender=!0,t._refreshTitle(),e.dispatchEvent({type:"buildingDone"}),t._building=!1})}},rh.prototype.rebuildAll=function(){this._forEachComplexVisual(function(e){e.setNeedsRebuild()})},rh.prototype._refreshTitle=function(e){var t;e=void 0===e?"":e;var r=this._getComplexVisual();if(r){t=r.getComplex().name;var n=r.repGet(r.repCurrent());t+=n?" – ".concat(n.mode.name," Mode"):""}else t=0<Object.keys(this._visuals).length?"Unknown":"No Data";t+=e,this.dispatchEvent({type:"titleChanged",data:t})},rh.prototype.setNeedRender=function(){this._needRender=!0},rh.prototype._extractRepresentation=function(){var i=this,o=[];this._forEachComplexVisual(function(e){if(0!==e.getSelectionCount()){var t=e.buildSelectorFromMask(1<<e.getSelectionBit()),r=Q.now.presets.default,n=e.repAdd({selector:t,mode:r[0].mode.id,colorer:r[0].colorer.id,material:r[0].material.id});n?(i.dispatchEvent({type:"repAdded",index:n.index,name:e.name}),e.repCurrent(n.index),o.push(e.name)):e.repCount()===Ds.NUM_REPRESENTATION_BITS&&i.logger.warn("Number of representations is limited to ".concat(Ds.NUM_REPRESENTATION_BITS))}}),0<o.length&&this.logger.report("New representation from selection for complexes: ".concat(o.join(", ")))},rh.prototype._setReps=function(t){t=t||this._opts&&this._opts.reps||[],this._forEachComplexVisual(function(e){return e.resetReps(t)})},rh.prototype.applyPreset=function(e){for(var t=Q.now.presets,r=[e||Q.defaults.preset,Q.defaults.preset,Object.keys(t)[0]],n=null,i=0;!n&&i<r.length;++i)Q.set("preset",r[i]),(n=t[Q.now.preset])||this.logger.warn('Unknown preset "'.concat(Q.now.preset,'"'));this._setReps(n)},rh.prototype.resetReps=function(e){var t=this._opts&&this._opts.reps;t?this._setReps(t):this.applyPreset(e)},rh.prototype.repCount=function(e){var t=this._getComplexVisual(e);return t?t.repCount():0},rh.prototype.repCurrent=function(e,t){var r=this._getComplexVisual(t),n=r?r.repCurrent(e):-1;return e&&n!==e&&this.logger.warn("Representation ".concat(e," was not found. Current rep remains unchanged.")),n},rh.prototype.rep=function(e,t){var r=this._getComplexVisual("");if(!r)return null;var n=r.rep(e,t);return"created"===n.status?this.dispatchEvent({type:"repAdded",index:n.index,name:r.name}):"changed"===n.status&&this.dispatchEvent({type:"repChanged",index:n.index,name:r.name}),n.desc},rh.prototype.repGet=function(e,t){var r=this._getComplexVisual(t);return r?r.repGet(e):null},rh.prototype.repAdd=function(e,t){var r=this._getComplexVisual(t);if(!r)return-1;var n=r.repAdd(e);return n?(this.dispatchEvent({type:"repAdded",index:n.index,name:t}),n.index):-1},rh.prototype.repRemove=function(e,t){var r=this._getComplexVisual(t);r&&(r.repRemove(e),this.dispatchEvent({type:"repRemoved",index:e,name:t}))},rh.prototype.repHide=function(e,t,r){this._needRender=!0;var n=this._getComplexVisual(r);return n?n.repHide(e,t):null},rh.prototype._setEditMode=function(e){this._editMode=e;var t=this._msgMode;t&&(t.style.opacity=e===qu?0:1,e!==qu&&(t.getElementsByTagName("p")[0].innerHTML=e===$u?"COMPONENT EDIT MODE":"FRAGMENT EDIT MODE"));this.dispatchEvent({type:"editModeChanged",data:e===qu})},rh.prototype._enterComponentEditMode=function(){if(this._editMode===qu){var r=[];this._forEachComplexVisual(function(e){var t=e.beginComponentEdit();t&&r.push(t)}),r!==[]&&(this._editors=r,this.logger.info("COMPONENT EDIT MODE -- ON"),this._setEditMode($u),this._objectControls.keysTranslateObj(!0))}},rh.prototype._applyComponentEdit=function(){if(this._editMode===$u){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (applied)"),this._setEditMode(qu),this.rebuildAll()}},rh.prototype._discardComponentEdit=function(){if(this._editMode===$u){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (discarded)"),this._setEditMode(qu),this._needRender=!0,this.rebuildAll()}},rh.prototype._enterFragmentEditMode=function(){if(this._editMode===qu){var t=[];if(this._forEachComplexVisual(function(e){e instanceof Ds&&0<e.getSelectionCount()&&t.push(e)}),1===t.length){var e=t[0].beginFragmentEdit();e&&(this._editors=[e],this.logger.info("FRAGMENT EDIT MODE -- ON (single bond)"),this._setEditMode(Zu),this._objectControls.allowTranslation(!1),this._objectControls.allowAltObjFreeRotation(e.isFreeRotationAllowed()),this._needRender=!0)}}},rh.prototype._applyFragmentEdit=function(){if(this._editMode===Zu){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (applied)"),this._setEditMode(qu),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.rebuildAll()}},rh.prototype._discardFragmentEdit=function(){if(this._editMode===Zu){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (discarded)"),this._setEditMode(qu),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this._needRender=!0}},rh.prototype._onPick=function(t){if(Q.now.picking&&null===this._animInterval&&this._editMode!==Zu&&!this._objectControls.isEditingAltObj()){var e=null;if(t.obj.atom?(e=t.obj.atom.residue.getChain().getComplex(),this._lastPick=t.obj.atom):t.obj.residue?(e=t.obj.residue.getChain().getComplex(),this._lastPick=t.obj.residue):t.obj.chain?(e=t.obj.chain.getComplex(),this._lastPick=t.obj.chain):t.obj.molecule?(e=t.obj.molecule.complex,this._lastPick=t.obj.molecule):this._lastPick=null,e){var r=this._getVisualForComplex(e);r&&(n(r),this._needRender=!0)}else this._forEachComplexVisual(n),this._needRender=!0;this._updateInfoPanel(),this.dispatchEvent(t)}function n(e){e.updateSelectionMask(t.obj),e.rebuildSelectionGeometry()}},rh.prototype._onKeyDown=function(e){if(this._running&&this._hotKeysEnabled)switch(e.keyCode){case"C".charCodeAt(0):Q.now.editing&&this._enterComponentEditMode();break;case"F".charCodeAt(0):Q.now.editing&&this._enterFragmentEditMode();break;case"A".charCodeAt(0):switch(this._editMode){case $u:this._applyComponentEdit();break;case Zu:this._applyFragmentEdit()}break;case"D".charCodeAt(0):switch(this._editMode){case $u:this._discardComponentEdit();break;case Zu:this._discardFragmentEdit()}break;case"S".charCodeAt(0):e.preventDefault(),e.stopPropagation(),Q.set("ao",!Q.now.ao),this._needRender=!0;break;case 107:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual(function(e){e.expandSelection(),e.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0;break;case 109:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual(function(e){e.shrinkSelection(),e.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0}},rh.prototype._onKeyUp=function(e){this._running&&this._hotKeysEnabled&&e.keyCode==="X".charCodeAt(0)&&this._extractRepresentation()},rh.prototype._updateInfoPanel=function(){var e,t,r=this._msgAtomInfo.getElementsByTagName("p")[0],n=0;for(this._forEachComplexVisual(function(e){n+=e.getSelectionCount()});r.firstChild;)r.removeChild(r.firstChild);if(0!==n){var i="".concat(String(n)," atom").concat(1!==n?"s":""," selected");null!==this._lastPick&&(i+=", the last pick:");var o="",s="",a="";if(this._lastPick instanceof Hu){t=(e=this._lastPick).residue,s=e.name;var l=32!==e.location?String.fromCharCode(e.location):"";o="".concat(e.element.fullName," #").concat(e.serial).concat(l,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim(),"."),o+=s,a="Coord: (".concat(e.position.x.toFixed(2).toString(),",     ").concat(e.position.y.toFixed(2).toString(),",     ").concat(e.position.z.toFixed(2).toString(),")")}else this._lastPick instanceof Wu?(t=this._lastPick,o="".concat(t._type._fullName,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim())):this._lastPick instanceof Yu?o="chain ".concat(this._lastPick._name):this._lastPick instanceof Xu&&(o="molecule ".concat(this._lastPick._name));r.appendChild(document.createTextNode(i)),""!==o&&(r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(o))),""!==a&&(r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(a))),this._msgAtomInfo.style.opacity=1}else this._msgAtomInfo.style.opacity=0},rh.prototype._getAltObj=function(){if(this._editors){for(var e=null,t=0;t<this._editors.length;++t){var r=this._editors[t].getAltObj();if(0<r.objects.length){if(e){e=null;break}e=r}}if(e)return e}return{objects:[],pivot:new me.Vector3(0,0,0)}},rh.prototype.resetPivot=(sh=new me.Box3,ah=new me.Vector3,function(){sh.makeEmpty(),this._forEachVisual(function(e){sh.union(e.getBoundaries().boundingBox)}),sh.getCenter(ah),this._objectControls.setPivot(ah.negate()),this.dispatchEvent({type:"transform"})}),rh.prototype.setPivotResidue=(lh=new me.Vector3,function(e){var t=this._getVisualForComplex(e.getChain().getComplex());if(t){if(e._controlPoint)lh.copy(e._controlPoint);else{for(var r=0,n=0,i=0,o=e._atoms.length,s=0;s<o;++s){var a=e._atoms[s].position;r+=a.x/o,n+=a.y/o,i+=a.z/o}lh.set(r,n,i)}lh.applyMatrix4(t.matrix).negate(),this._objectControls.setPivot(lh),this.dispatchEvent({type:"transform"})}}),rh.prototype.setPivotAtom=(ch=new me.Vector3,function(e){var t=this._getVisualForComplex(e.residue.getChain().getComplex());t&&(ch.copy(e.position),ch.applyMatrix4(t.matrix).negate(),this._objectControls.setPivot(ch),this.dispatchEvent({type:"transform"}))}),rh.prototype.getSelectionCenter=(uh=new me.Vector3(0,0,0),function(t,r,n){t.set(0,0,0);var i=0;return this._forEachComplexVisual(function(e){e.getSelectionCenter(uh,r,n||e.getSelectionBit())&&(t.add(uh),i++)}),0!==i&&(t.divideScalar(i),t.negate(),!0)}),rh.prototype.setPivotSubset=(hh=new me.Vector3(0,0,0),function(e){var t=e?vh:_h;this.getSelectionCenter(hh,t,e)?(this._objectControls.setPivot(hh),this.dispatchEvent({type:"transform"})):this.logger.warn("selection is empty. Center operation not performed")}),rh.prototype.screenshot=function(n,i){var e,t,r,o=this._gfx,s=o.renderer.domElement.width,a=o.renderer.domElement.height;function l(){var e;if(_e.getBrowser()===_e.browserType.SAFARI){var t=document.createElement("canvas"),r=t.getContext("2d");t.width=void 0===n?s:n,t.height=void 0===i?a:i,r.drawImage(o.renderer.domElement,0,0,t.width,t.height),e=t.toDataURL("image/png")}else e=o.renderer.domElement.toDataURL("image/png");return e}if(i=i||n,void 0===n&&void 0===i||n===s&&i===a)e=l();else{var c=o.camera.aspect,u=o.camera.fov,h=(r=o.camera.fov,Math.tan(me.Math.degToRad(.5*r)))*Math.min(o.width,o.height)/o.height,d=n/i;o.renderer.setPixelRatio(1),o.camera.aspect=d,o.camera.fov=(t=h/Math.min(d,1),2*me.Math.radToDeg(Math.atan(t))),o.camera.updateProjectionMatrix(),o.renderer.setDrawingBufferSize(n,i,1),this._renderFrame(Q.now.stereo),e=l(),o.renderer.setPixelRatio(window.devicePixelRatio),o.camera.aspect=c,o.camera.fov=u,o.camera.updateProjectionMatrix(),o.renderer.setDrawingBufferSize(o.width,o.height,window.devicePixelRatio),this._needRender=!0}return e},rh.prototype.screenshotSave=function(e,t,r){var n=this.screenshot(t,r);_e.shotDownload(n,e)},rh.prototype.save=function(r){var n=this;this._export(r.fileType).then(function(e){var t=n._visuals[n._curVisualName]._complex.name;_e.download(e,t,r.fileType),n._refreshTitle(),n.dispatchEvent({type:"exportingDone"})}).catch(function(e){n.logger.error("Could not export data"),n.logger.debug(e),n._refreshTitle(),n.dispatchEvent({type:"exportingDone",error:e})})},rh.prototype._tweakResolution=function(){var e=[["poor",100],["low",500],["medium",1e3],["high",5e3],["ultra",Number.MAX_VALUE]],t=0;if(this._forEachComplexVisual(function(e){t+=e.getComplex().getAtomCount()}),0<t)for(var r=1e6*this._gfxScore/t,n=0;n<e.length;++n)if(r<e[n][1]){this._autoChangeResolution(e[n][0]);break}},rh.prototype._autoChangeResolution=function(e){e!==Q.now.resolution&&this.logger.report('Your rendering resolution was changed to "'.concat(e,'" for best performance.')),Q.now.resolution=e},rh.prototype.saveSettings=function(){this._cookies.setCookie(this._opts.settingsCookie,JSON.stringify(this.settings.getDiffs(!0)))},rh.prototype.restoreSettings=function(){try{var e=this._cookies.getCookie(this._opts.settingsCookie),t=e?JSON.parse(e):{};this.settings.applyDiffs(t,!0)}catch(e){this.logger.error("Cookies parse error: ".concat(e.message))}},rh.prototype.resetSettings=function(){this.settings.reset()},rh.prototype.setOptions=function(e){"string"==typeof e&&(e=rh.options.fromAttr(e)),e.reps&&(this._opts.reps=null),w.merge(this._opts,e),e.settings&&this.set(e.settings),this._opts._objects=e._objects,this._resetObjects(),e.load&&this.load(e.load,{fileType:e.type}),e.preset&&(Q.now.preset=e.preset),e.reps&&this.resetReps(e.preset),this._opts.view&&(this.view(this._opts.view),delete this._opts.view);var t=this._getComplexVisual();t&&(t.getComplex().resetCurrentUnit(),w.isNumber(e.unit)&&t.getComplex().setCurrentUnit(e.unit),this.resetView(),this.rebuildAll())},rh.prototype.info=function(e){var t=this._getComplexVisual(e);if(!t)return{};var r=t.getComplex(),n=r.metadata;return{id:n.id||r.name||"UNKNOWN",title:n.title&&n.title.join(" ")||"UNKNOWN DATA",atoms:r.getAtomCount(),bonds:r.getBondCount(),residues:r.getResidueCount(),chains:r.getChainCount()}},rh.prototype.addObject=function(e,t){var r=null;if(e.type===tu.prototype.type&&(r=tu),null===r)throw new Error("Unknown scene object type - ".concat(e.type));try{var n=new r(e.params,e.opts);this._addSceneObject(n)}catch(e){if(t)throw e;this.logger.debug("Error during scene object creation: ".concat(e.message))}this._needRender=!0},rh.prototype._addSceneObject=function(e){var t=this._getComplexVisual();e.build&&t&&(e.build(t.getComplex()),this._gfx.pivot.add(e.getGeometry()));var r=this._objects;r[r.length]=e},rh.prototype._updateObjsToFrame=function(e){for(var t=this._objects,r=0,n=t.length;r<n;++r)t[r].updateToFrame&&t[r].updateToFrame(e)},rh.prototype._resetObjects=function(){var e=this._opts._objects;if(this._objects=[],e)for(var t=0,r=e.length;t<r;++t)this.addObject(e[t],!1)},rh.prototype.removeObject=function(e){var t=this._objects[e];if(!t)throw new Error("Scene object with index ".concat(e," does not exist"));t.destroy(),this._objects.splice(e,1),this._needRender=!0},rh.prototype.getURL=function(e){return Se.toURL(this.getState(w.defaults(e,{compact:!0,settings:!1,view:!1})))},rh.prototype.getScript=function(e){return Se.toScript(this.getState(w.defaults(e,{compact:!0,settings:!0,view:!0})))},rh.prototype._compareReps=function(e,t){var r={},n=0;e&&(n=e.repCount());var i=Q.defaults.presets[Q.now.preset],o=t;void 0===i||i.length>n?(o=!1,r.preset="empty"):Q.now.preset!==Q.defaults.preset&&(r.preset=Q.now.preset);for(var s=[],a=!0,l=0,c=n;l<c;++l)s[l]=e.repGet(l).compare(o?i[l]:null),w.isEmpty(s[l])||(a=!1);return a||(r.reps=s),r},rh.prototype.getState=function(e){var t={};e=w.defaults(e,{compact:!0,settings:!1,view:!1});var r=this._getComplexVisual();if(null!==r){var n=r.getComplex(),i=n.metadata;if(i.id){var o=i.format?"".concat(i.format,":"):"";t.load=o+i.id}var s=n.getCurrentUnit();1!==s&&(t.unit=s)}var a=this._compareReps(r,e.compact);a.preset&&(t.preset=a.preset),a.reps&&(t.reps=a.reps);for(var l=this._objects,c=[],u=0,h=l.length;u<h;++u)c[u]=l[u].identify();if(0<l.length&&(t._objects=c),e.view&&(t.view=this.view()),e.settings){var d=this.settings.getDiffs(!1);w.isEmpty(d)||(t.settings=d)}return t},rh.prototype.get=function(e,t){return Q.get(e,t)},rh.prototype._clipPlaneUpdateValue=function(e){var t=Math.max(this._gfx.camera.position.z-e*Q.now.draft.clipPlaneFactor,Q.now.camNear),r={clipPlaneValue:t};this._forEachComplexVisual(function(e){e.setUberOptions(r)});for(var n=0,i=this._objects.length;n<i;++n){var o=this._objects[n];o._line&&o._line.material.setUberOptions(r)}null!==this._picker&&(this._picker.clipPlaneValue=t)},rh.prototype._fogFarUpdateValue=function(){null!==this._picker&&(this._gfx.scene.fog?this._picker.fogFarValue=this._gfx.scene.fog.far:this._picker.fogFarValue=void 0)},rh.prototype._updateShadowmapMeshes=function(o){this._forEachComplexVisual(function(e){for(var t=e._reprList,r=0,n=t.length;r<n;++r){var i=t[r];o(i.geo,i.material)}})},rh.prototype._updateMaterials=function(t){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;this._forEachComplexVisual(function(e){return e.setMaterialValues(t,r,n)});for(var e=0,i=this._objects.length;e<i;++e){var o=this._objects[e];o._line&&(o._line.material.setValues(t),o._line.material.needsUpdate=!0)}},rh.prototype._fogAlphaChanged=function(){this._forEachComplexVisual(function(e){e.setUberOptions({fogAlpha:Q.now.fogAlpha})})},rh.prototype._embedWebXR=function(){var e=this;if("WEBVR"!==Q.now.stereo)return this.webVR&&this.webVR.disable(),void(this.webVR=null);this.webVR||(this.webVR=new Gu(function(){e._requestAnimationFrame(function(){return e._onTick()}),e._needRender=!0,e._onResize()})),this.webVR.enable(this._gfx)},rh.prototype._initOnSettingsChanged=function(){function e(e,t){(e=w.isArray(e)?e:[e]).forEach(function(e){n.settings.addEventListener("change:".concat(e),t)})}var n=this;e("modes.VD.frame",function(){var e=n._getVolumeVisual();null!==e&&(e.showFrame(Q.now.modes.VD.frame),n._needRender=!0)}),e("modes.VD.isoMode",function(){var e=n._getVolumeVisual();null!==e&&(e.getMesh().material.updateDefines(),n._needRender=!0)}),e("bg.color",function(){n._onBgColorChanged()}),e("ao",function(){if(Q.now.ao&&!oh(n._gfx.renderer.getContext()))n.logger.warn("Your device or browser does not support ao"),Q.set("ao",!1);else{var e={normalsToGBuffer:Q.now.ao};n._setUberMaterialValues(e)}}),e("zSprites",function(){Q.now.zSprites&&!ih(n._gfx.renderer.getContext())&&(n.logger.warn("Your device or browser does not support zSprites"),Q.set("zSprites",!1))}),e("fogColor",function(){n._onFogColorChanged()}),e("fogColorEnable",function(){n._onFogColorChanged()}),e("bg.transparent",function(e){var t=n._gfx;t&&t.renderer.setClearColor(Q.now.bg.color,Number(!Q.now.bg.transparent)),n._updateMaterials({fogTransparent:e.value}),n.rebuildAll()}),e("draft.clipPlane",function(e){n._updateMaterials({clipPlane:e.value}),n.rebuildAll()}),e("shadow.on",function(e){var t={shadowmap:e.value,shadowmapType:Q.now.shadow.type},r=n._gfx;r&&(r.renderer.shadowMap.enabled=Boolean(t.shadowmap)),n._updateMaterials(t,!0),t.shadowmap?(n._updateShadowCamera(),n._updateShadowmapMeshes(tn.createShadowmapMaterial)):n._updateShadowmapMeshes(tn.removeShadowmapMaterial),n._needRender=!0}),e("shadow.type",function(e){Q.now.shadow.on&&(n._updateMaterials({shadowmapType:e.value},!0),n._needRender=!0)}),e("shadow.radius",function(e){for(var t=0;t<n._gfx.scene.children.length;t++){if(void 0!==n._gfx.scene.children[t].shadow)n._gfx.scene.children[t].shadow.radius=e.value,n._needRender=!0}}),e("fps",function(){n._fps.show(Q.now.fps)}),e(["fog","fogNearFactor","fogFarFactor"],function(){n._updateFog(),n._needRender=!0}),e("fogAlpha",function(){var e=Q.now.fogAlpha;(e<0||1<e)&&n.logger.warn("fogAlpha must belong range [0,1]"),n._fogAlphaChanged(),n._needRender=!0}),e("autoResolution",function(e){e.value&&!n._gfxScore&&n.logger.warn("Benchmarks are missed, autoresolution will not work! Autoresolution should be set during miew startup.")}),e("stereo",function(){n._embedWebXR("WEBVR"===Q.now.stereo),n._needRender=!0}),e(["transparency","palette"],function(){n.rebuildAll()}),e("resolution",function(){n.rebuildAll();var e=n._getVolumeVisual();e&&(e.getMesh().material.updateDefines(),n._needRender=!0)}),e(["axes","fxaa","ao","outline.on","outline.color","outline.threshold","outline.thickness"],function(){n._needRender=!0})},rh.prototype.set=function(e,t){Q.set(e,t)},rh.prototype.select=function(e,t){var r=this._getComplexVisual();if(r){var n=e;w.isString(e)&&(n=ju.parse(e).selector),r.select(n,t),this._lastPick=null,this._updateInfoPanel(),this._needRender=!0}};var gh,yh,xh,bh,wh,Sh,Ch,Ah,Eh,kh,Th,Rh,Mh,Ph,Nh,Ih,Lh,Oh,Vh,Dh,zh,Fh,Bh,Uh,Gh,jh,Hh,Wh,Yh,Xh,qh,$h,Zh,Kh,Qh,Jh,ed,td,rd,nd,id,od,sd,ad,ld,cd,ud,hd,dd,fd,pd,md,_d,vd,gd,yd,xd,bd,wd,Sd,Cd,Ad,Ed,kd,Td,Rd,Md,Pd,Nd,Id,Ld,Od,Vd;function Dd(e,t,r,n){for(r=r||{},n=e.length;n--;r[e[n]]=t);return r}function zd(){this.yy={}}rh.prototype.view=function(i){var e,t,r,o=this,s=this._gfx.pivot,a=[],l="ZXY";return void 0===i?(e=s.position,t=o._objectControls.getScale()/Q.now.radiusToFit,(r=new me.Euler).setFromQuaternion(o._objectControls.getOrientation(),l),a=[e.x,e.y,e.z,t,r.x,r.y,r.z],"1"+_e.arrayToBase64(a,Float32Array)):(function(){40===i.length&&(i="0".concat(i));var e=i[0];if(a=_e.arrayFromBase64(i.substr(1),Float32Array),"1"!==e){if("0"!==e)return o.logger.warn("Encoded view version mismatch, stored as ".concat(e," vs ").concat("1"," expected"));a[3]/=8}var t=o._interpolator,r=t.createView();r.position.copy(s.position),r.scale=o._objectControls.getScale(),r.orientation.copy(o._objectControls.getOrientation());var n=t.createView();n.position.set(a[0],a[1],a[2]),o._getComplexVisual()&&n.position.sub(o._getComplexVisual().position),n.scale=a[3],n.orientation.setFromEuler(new me.Euler(a[4],a[5],a[6],l)),t.setup(r,n)}(),i)},rh.prototype._updateView=function(){var e=this._gfx.pivot,t=this._interpolator;if(t.wasStarted()||t.start(),t.isMoving()){var r=t.getCurrentView();if(r.success){var n=r.view;e.position.copy(n.position),this._objectControls.setScale(n.scale*Q.now.radiusToFit),this._objectControls.setOrientation(n.orientation),this.dispatchEvent({type:"transform"}),this._needRender=!0}}},rh.prototype.translate=function(e,t,r){this._objectControls.translatePivot(e,t,r),this.dispatchEvent({type:"transform"}),this._needRender=!0},rh.prototype.rotate=function(e,t,r){this._objectControls.rotate((new me.Quaternion).setFromEuler(new me.Euler(e,t,r,"XYZ"))),this.dispatchEvent({type:"transform"}),this._needRender=!0},rh.prototype.scale=function(e){if(e<=0)throw new RangeError("Scale should be greater than zero");this._objectControls.scale(e),this.dispatchEvent({type:"transform"}),this._needRender=!0},rh.prototype.center=function(e){if(void 0===e)return this.setPivotSubset(),void(this._needRender=!0);if(void 0!==e.obj&&("atom"in e.obj||"residue"in e.obj))return"atom"in e.obj?this.setPivotAtom(e.obj.atom):this.setPivotResidue(e.obj.residue),void(this._needRender=!0);if(void 0===e.obj&&""!==e){var t=ju.parse(e);if(void 0===t.error)return this.setPivotSubset(t),void(this._needRender=!0)}this.resetPivot(),this._needRender=!0},rh.prototype.within=function(e,t){var r=this._getComplexVisual();if(!r)return ju.None();e instanceof String&&(e=ju.parse(e));var n=r.within(e,t);return n&&(r.rebuildSelectionGeometry(),this._needRender=!0),n},rh.prototype.projected=function(e,t){var r=this._getComplexVisual(t);if(!r)return!1;var n=r.getComplex().getAtomByFullname(e);if(null===n)return!1;var i=n.position.clone();return this._gfx.pivot.updateMatrixWorldRecursive(),this._gfx.camera.updateMatrixWorldRecursive(),this._gfx.pivot.localToWorld(i),i.project(this._gfx.camera),{x:.5*(i.x+1)*this._gfx.width,y:.5*(1-i.y)*this._gfx.height}},rh.prototype.dssp=function(e){var t=this._getComplexVisual(e);t&&(t.getComplex().dssp(),t._reprList.forEach(function(e){"CA"!==e.mode.id&&"SS"!==e.colorer.id||(e.needsRebuild=!0)}))},rh.prototype.exportCML=function(){var e=this;var t,r,n,i,o,s,a=e._getComplexVisual(),l=a?a.getComplex():null;return l&&l.originalCML?(t=l,r=function(e){var t=new me.Vector3,r=new me.Vector3,n=new me.Vector3;e.extractBasis(t,r,n),t.normalize(),r.normalize(),n.normalize();var i=new me.Matrix4;return i.identity(),i.makeBasis(t,r,n),i}(e._gfx.root.matrixWorld),n=new me.Vector4(0,0,0,0),i=new me.Vector4(0,0,0,0),s=o=null,t.forEachAtom(function(e){e.xmlNodeRef&&e.xmlNodeRef.xmlNode&&(o=e.xmlNodeRef.xmlNode,s=e.position,n.set(s.x,s.y,s.z,1),n.applyMatrix4(r),o.setAttribute("x3",n.x.toString()),o.setAttribute("y3",n.y.toString()),o.setAttribute("z3",n.z.toString()),o.removeAttribute("x2"),o.removeAttribute("y2"))}),t.forEachSGroup(function(e){if(e.xmlNodeRef&&e.xmlNodeRef.xmlNode){o=e.xmlNodeRef.xmlNode,s=e.getPosition(),n.set(s.x,s.y,s.z,1);var t=e.getCentralPoint();null===t?n.applyMatrix4(r):(i.set(t.x,t.y,t.z,0),n.add(i),n.applyMatrix4(r),i.set(t.x,t.y,t.z,1),i.applyMatrix4(r),n.sub(i)),o.setAttribute("x",n.x.toString()),o.setAttribute("y",n.y.toString()),o.setAttribute("z",n.z.toString())}}),(new XMLSerializer).serializeToString(l.originalCML)):null},rh.prototype.motm=function(){Q.set({fogColorEnable:!0,fogColor:0,outline:{on:!0,threshold:.01},bg:{color:16777215}}),this._forEachComplexVisual(function(e){for(var t=[],r=e.getComplex(),n=fs.get(Q.now.palette),i=0;i<r.getChainCount();i++){var o=r._chains[i]._name,s=n.getChainColor(o);t[i]={selector:"chain ".concat(o),mode:"VW",colorer:["CB",{color:s,factor:.9}],material:"FL"}}e.resetReps(t)})},rh.prototype.VERSION="0.9.0",w.assign(rh,{VERSION:rh.prototype.VERSION,registeredPlugins:[],chem:Cr,io:Ic,modes:$o,colorers:Ts,materials:Ms,palettes:fs,options:Se,settings:Q,utils:_e,gfx:{Representation:Ns},thirdParty:{lodash:w,three:me}});var Fd={parser:(Md=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,71,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],Pd=[5,6,7,9,13,15,17,18,19,20,23,25,26,27,30,33,34,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,82,83,84,85,86,87,88,89,90,91,92,93,94,95],Nd=[5,70,72],Id=[5,74],Ld=[71,101],Od={trace:function(){},yy:{},symbols_:{error:2,Program:3,Command:4,EOF:5,RESET:6,BUILD:7,ALL:8,HELP:9,Path:10,MOTM:11,OneArgCommand:12,GET:13,STRING:14,SET:15,Value:16,SET_SAVE:17,SET_RESTORE:18,SET_RESET:19,PRESET:20,AddRepresentation:21,EditRepresentation:22,REMOVE:23,RepresentationReference:24,HIDE:25,SHOW:26,LIST:27,EXPAND_KEY:28,SELECTOR_KEY:29,SELECT:30,AS:31,WordAll:32,SELECTOR:33,WITHIN:34,NUMBER:35,OF:36,MATERIAL:37,IDENTIFIER:38,ModeCMD:39,ColorCMD:40,VIEW:41,BASE_64:42,UNIT:43,DSSP:44,SCALE:45,ROTATE:46,AxesList:47,TRANSLATE:48,CENTER:49,GetURLBranch:50,Screenshot:51,LINE:52,ArgList:53,LISTOBJ:54,REMOVEOBJ:55,URL:56,VIEW_KEY:57,SCREENSHOT:58,LOAD:59,Url:60,FILE_KEY:61,ADD:62,Description:63,REP:64,MODE:65,COLOR:66,Descriptor:67,RepresentationOwnProperty:68,RepresentationOwnPropertyOpts:69,DESC_KEY:70,"=":71,DESC_KEY_OPTS:72,AxesArg:73,DESC_KEY_AXES:74,Arg:75,PathWoDescKey:76,HEX:77,BOOL:78,Word:79,CommandSetWoDESC_KEY:80,DescKeys:81,CLEAR:82,FILE_LIST:83,FILE_REGISTER:84,FILE_DELETE:85,PRESET_ADD:86,PRESET_DELETE:87,PRESET_UPDATE:88,PRESET_RENAME:89,PRESET_OPEN:90,CREATE_SCENARIO:91,RESET_SCENARIO:92,DELETE_SCENARIO:93,ADD_SCENARIO_ITEM:94,LIST_SCENARIO:95,PDB_KEY:96,DELAY_KEY:97,PRST_KEY:98,DESCRIPTION_KEY:99,CommandSet:100,".":101,PresetPath:102,"/":103,HexOrNumber:104,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"RESET",7:"BUILD",8:"ALL",9:"HELP",11:"MOTM",13:"GET",14:"STRING",15:"SET",17:"SET_SAVE",18:"SET_RESTORE",19:"SET_RESET",20:"PRESET",23:"REMOVE",25:"HIDE",26:"SHOW",27:"LIST",28:"EXPAND_KEY",29:"SELECTOR_KEY",30:"SELECT",31:"AS",33:"SELECTOR",34:"WITHIN",35:"NUMBER",36:"OF",37:"MATERIAL",38:"IDENTIFIER",41:"VIEW",42:"BASE_64",43:"UNIT",44:"DSSP",45:"SCALE",46:"ROTATE",48:"TRANSLATE",49:"CENTER",52:"LINE",54:"LISTOBJ",55:"REMOVEOBJ",56:"URL",57:"VIEW_KEY",58:"SCREENSHOT",59:"LOAD",61:"FILE_KEY",62:"ADD",64:"REP",65:"MODE",66:"COLOR",70:"DESC_KEY",71:"=",72:"DESC_KEY_OPTS",74:"DESC_KEY_AXES",77:"HEX",78:"BOOL",82:"CLEAR",83:"FILE_LIST",84:"FILE_REGISTER",85:"FILE_DELETE",86:"PRESET_ADD",87:"PRESET_DELETE",88:"PRESET_UPDATE",89:"PRESET_RENAME",90:"PRESET_OPEN",91:"CREATE_SCENARIO",92:"RESET_SCENARIO",93:"DELETE_SCENARIO",94:"ADD_SCENARIO_ITEM",95:"LIST_SCENARIO",96:"PDB_KEY",97:"DELAY_KEY",98:"PRST_KEY",99:"DESCRIPTION_KEY",101:".",103:"/"},productions_:[0,[3,2],[3,1],[4,1],[4,1],[4,2],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,2],[4,2],[4,1],[4,2],[4,2],[4,2],[4,4],[4,2],[4,6],[4,2],[4,1],[4,1],[4,1],[4,2],[4,2],[4,1],[4,2],[4,1],[4,2],[4,2],[4,2],[4,1],[4,2],[4,1],[4,1],[4,3],[4,3],[4,4],[4,4],[4,1],[4,2],[50,1],[50,2],[50,2],[50,3],[50,3],[51,1],[51,2],[51,3],[12,2],[12,2],[12,2],[21,1],[21,2],[21,2],[21,3],[22,2],[22,3],[39,2],[39,3],[40,2],[40,3],[24,1],[24,1],[63,1],[63,2],[63,3],[63,4],[67,1],[67,1],[67,2],[68,3],[69,3],[47,1],[47,2],[73,2],[53,1],[53,2],[75,3],[16,1],[16,1],[16,1],[16,1],[16,1],[79,1],[79,1],[32,1],[32,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[100,1],[100,1],[76,1],[76,3],[76,3],[10,1],[10,1],[10,3],[10,3],[10,3],[60,1],[102,1],[102,3],[104,1],[104,1]],performAction:function(e,t,r,n,i,o){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=n.miew.reset(!1),n.ClearContext(),n.miew.resetReps("empty");break;case 4:this.$=n.miew.rebuild();break;case 5:this.$=n.miew.rebuildAll(),n.miew.rebuild();break;case 6:this.$=n.echo(n.utils.help().toString());break;case 7:this.$=n.echo(n.utils.help(o[s]).toString());break;case 8:this.$=n.miew.motm();break;case 10:case 11:this.$=n.utils.propagateProp(o[s]),n.echo(n.miew.get(o[s]).toString());break;case 12:case 13:this.$=n.miew.set(o[s-1],n.utils.propagateProp(o[s-1],o[s]));break;case 14:this.$=n.miew.saveSettings();break;case 15:this.$=n.miew.restoreSettings();break;case 16:this.$=n.miew.resetSettings();break;case 17:this.$=n.miew.resetReps();break;case 18:this.$=n.miew.applyPreset(o[s]);break;case 21:this.$=n.miew.repRemove(o[s]),n.representations.remove(o[s]);break;case 22:this.$=n.miew.repHide(o[s]);break;case 23:this.$=n.miew.repHide(o[s],!1);break;case 24:this.$=n.echo(n.utils.listRep(n.miew,n.representations,o[s],"-e"));break;case 25:this.$=n.echo(n.utils.list(n.miew,n.representations));break;case 26:this.$=n.echo(n.utils.list(n.miew,n.representations,o[s]));break;case 27:this.$=n.echo(n.utils.listSelector(n.miew,n.Context));break;case 28:this.$=n.miew.select(n.utils.checkArg(o[s-1].toLowerCase(),o[s],!0));break;case 29:this.$=n.Context[o[s].toLowerCase()]=n.utils.checkArg(o[s-3].toLowerCase(),o[s-2],!0),n.miew.select(n.Context[o[s].toLowerCase()]);break;case 30:this.$=n.miew.rep(n.miew.repCurrent(),{selector:n.utils.checkArg(o[s-1].toLowerCase(),o[s])});break;case 31:this.$=n.Context[o[s].toLowerCase()]=n.miew.within(n.utils.checkArg("select",o[s-2],!0),Number(o[s-4]));break;case 32:this.$=n.miew.rep(n.miew.repCurrent(),{material:n.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 35:this.$=n.echo(n.miew.view());break;case 36:case 37:this.$=n.miew.view(o[s]);break;case 38:this.$=n.echo(n.miew.changeUnit());break;case 39:this.$=n.echo(n.miew.changeUnit(o[s]));break;case 40:this.$=n.miew.dssp();break;case 41:this.$=n.miew.scale(o[s]);break;case 42:for(var a=0,l=o[s].length;a<l;a++)n.miew.rotate(o[s][a].x*Math.PI/180,o[s][a].y*Math.PI/180,o[s][a].z*Math.PI/180);break;case 43:for(a=0,l=o[s].length;a<l;a++)n.miew.translate(o[s][a].x||0,o[s][a].y||0,o[s][a].z||0);break;case 44:this.$=n.miew.center();break;case 45:this.$=n.miew.center(o[s]);break;case 48:case 49:this.$=n.miew.addObject({type:"line",params:[o[s-1],o[s]]},!0);break;case 50:case 51:this.$=n.miew.addObject({type:"line",params:[o[s-2],o[s-1]],opts:o[s].toJSO(n.utils,"objects","line")},!0);break;case 52:this.$=n.echo(n.utils.listObjs(n.miew));break;case 53:this.$=n.miew.removeObject(o[s]);break;case 54:this.$=n.echo(n.miew.getURL({view:!1,settings:!1}));break;case 55:this.$=n.echo(n.miew.getURL({view:!1,settings:!0}));break;case 56:this.$=n.echo(n.miew.getURL({view:!0,settings:!1}));break;case 57:case 58:this.$=n.echo(n.miew.getURL({view:!0,settings:!0}));break;case 59:this.$=n.miew.screenshotSave();break;case 60:this.$=n.miew.screenshotSave("",Number(o[s]));break;case 61:this.$=n.miew.screenshotSave("",Number(o[s-1]),Number(o[s]));break;case 62:case 63:case 64:this.$=n.utils.load(n.miew,o[s]),n.representations.clear();break;case 65:this.$=n.echo(n.representations.add(n.miew.repAdd()));break;case 66:this.$=n.echo(n.representations.add(o[s],n.miew.repAdd()));break;case 67:this.$=n.echo(n.representations.add(n.miew.repAdd(o[s])));break;case 68:this.$=n.echo(n.representations.add(o[s-1],n.miew.repAdd(o[s])));break;case 69:this.$=n.miew.rep(o[s]),n.miew.repCurrent(o[s]);break;case 70:this.$=n.miew.rep(o[s-1],o[s]),n.miew.repCurrent(o[s-1]);break;case 71:this.$=n.miew.rep(n.miew.repCurrent(),{mode:n.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 72:this.$=n.miew.rep(n.miew.repCurrent(),{mode:new Array(n.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(n.utils,o[s-2],o[s-1].toUpperCase()))});break;case 73:this.$=n.miew.rep(n.miew.repCurrent(),{colorer:n.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 74:this.$=n.miew.rep(n.miew.repCurrent(),{colorer:new Array(n.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(n.utils,o[s-2],o[s-1].toUpperCase()))});break;case 75:this.$=Number(n.representations.get(o[s]));break;case 76:case 92:this.$=Number(o[s]);break;case 77:this.$=o[s];break;case 78:this.$=n._.assign(o[s-1],o[s]);break;case 79:this.$=n._.assign(o[s-2],o[s-1],o[s]);break;case 80:this.$=n._.assign(o[s-3],o[s-2],o[s-1],o[s]);break;case 81:case 82:this.$=n.CreateObjectPair(o[s].key,o[s].val);break;case 83:this.$=n.CreateObjectPair(o[s-1].key,new Array(o[s-1].val,o[s].toJSO(n.utils,o[s-1].key,o[s-1].val)));break;case 84:case 85:this.$=Object.create({key:n.keyRemap(o[s-2]),val:n.utils.checkArg(o[s-2],o[s])});break;case 86:this.$=[o[s]];break;case 87:this.$=o[s-1].concat(o[s]);break;case 88:this.$=n.CreateObjectPair(o[s-1].toLowerCase(),Number(o[s]));break;case 89:this.$=new n.ArgList(o[s]);break;case 90:this.$=o[s-1].append(o[s]);break;case 91:this.$=new n.Arg(o[s-2],o[s]);break;case 93:this.$=parseInt(o[s]);break;case 94:this.$=JSON.parse(o[s]);break;case 95:case 96:this.$=String(o[s]);break;case 157:case 158:case 161:case 162:case 163:this.$=o[s-2]+o[s-1]+o[s];break;case 166:this.$=o[s-2]=o[s-2]+o[s-1]+o[s]}},table:[{3:1,4:2,5:[1,3],6:[1,4],7:[1,5],9:[1,6],11:[1,7],12:8,13:[1,9],15:[1,10],17:[1,11],18:[1,12],19:[1,13],20:[1,14],21:15,22:16,23:[1,17],25:[1,18],26:[1,19],27:[1,20],30:[1,21],33:[1,22],34:[1,23],37:[1,24],39:25,40:26,41:[1,27],43:[1,28],44:[1,29],45:[1,30],46:[1,31],48:[1,32],49:[1,33],50:34,51:35,52:[1,36],54:[1,37],55:[1,38],56:[1,44],58:[1,45],59:[1,39],62:[1,40],64:[1,41],65:[1,42],66:[1,43]},{1:[3]},{5:[1,46]},{1:[2,2]},{5:[2,3]},{5:[2,4],8:[1,47]},{5:[2,6],6:gh=[1,60],7:yh=[1,62],9:xh=[1,63],10:48,13:bh=[1,65],15:wh=[1,66],17:Sh=[1,67],18:Ch=[1,68],19:Ah=[1,69],20:Eh=[1,80],23:kh=[1,72],25:Th=[1,73],26:Rh=[1,74],27:Mh=[1,75],30:Ph=[1,99],33:Nh=[1,76],34:Ih=[1,100],37:Lh=[1,79],38:Oh=[1,51],41:Vh=[1,81],43:Dh=[1,82],45:zh=[1,84],46:Fh=[1,83],49:Bh=[1,85],52:Uh=[1,96],54:Gh=[1,97],55:jh=[1,98],56:Hh=[1,86],58:Wh=[1,87],59:Yh=[1,64],62:Xh=[1,70],64:qh=[1,71],65:$h=[1,77],66:Zh=[1,78],70:Kh=[1,53],72:Qh=[1,54],74:Jh=[1,55],79:49,80:52,81:50,82:ed=[1,61],83:td=[1,88],84:rd=[1,89],85:nd=[1,90],86:id=[1,91],87:od=[1,92],88:sd=[1,93],89:ad=[1,94],90:ld=[1,95],91:cd=[1,101],92:ud=[1,102],93:hd=[1,103],94:dd=[1,104],95:fd=[1,105],96:pd=[1,56],97:md=[1,57],98:_d=[1,58],99:vd=[1,59]},{5:[2,8]},{5:[2,9]},{6:gh,7:yh,9:xh,10:106,13:bh,14:[1,107],15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:49,80:52,81:50,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{6:gh,7:yh,9:xh,10:108,13:bh,14:[1,109],15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:49,80:52,81:50,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{5:[2,14]},{5:[2,15]},{5:[2,16]},{5:[2,17],14:gd=[1,115],16:110,35:yd=[1,111],38:xd=[1,114],77:bd=[1,112],78:wd=[1,113]},{5:[2,19]},{5:[2,20]},{24:116,35:Sd=[1,118],38:Cd=[1,117]},{24:119,35:Sd,38:Cd},{24:120,35:Sd,38:Cd},{5:[2,25],24:121,28:[1,122],29:[1,123],35:Sd,38:Cd},{14:[1,124]},{14:[1,125]},{35:[1,126]},{38:[1,127]},{5:[2,33]},{5:[2,34]},{5:[2,35],14:[1,128],42:[1,129]},{5:[2,38],35:[1,130]},{5:[2,40]},{35:[1,131]},{47:132,73:133,74:Ad=[1,134]},{47:135,73:133,74:Ad},{5:[2,44],14:[1,136]},{5:[2,46]},{5:[2,47]},{6:gh,7:yh,9:xh,10:138,13:bh,14:[1,137],15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:49,80:52,81:50,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{5:[2,52]},{35:[1,139]},{14:[1,143],38:[1,141],60:140,61:[1,142]},{5:[2,65],38:[1,144],63:145,67:146,68:147,69:148,70:Ed=[1,149],72:kd=[1,150]},{24:151,35:Sd,38:Cd},{38:[1,152]},{38:[1,153]},{5:[2,54],29:[1,154],57:[1,155]},{5:[2,59],35:[1,156]},{1:[2,1]},{5:[2,5]},{5:[2,7],101:Td=[1,157]},Dd(Rd=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],[2,159]),Dd(Rd,[2,160]),Dd(Md,[2,97]),Dd(Md,[2,98]),Dd(Rd,[2,147]),Dd(Rd,[2,148]),Dd(Rd,[2,149]),Dd(Rd,[2,150]),Dd(Rd,[2,151]),Dd(Rd,[2,152]),Dd(Rd,[2,153]),Dd(Md,[2,101]),Dd(Md,[2,102]),Dd(Md,[2,103]),Dd(Md,[2,104]),Dd(Md,[2,105]),Dd(Md,[2,106]),Dd(Md,[2,107]),Dd(Md,[2,108]),Dd(Md,[2,109]),Dd(Md,[2,110]),Dd(Md,[2,111]),Dd(Md,[2,112]),Dd(Md,[2,113]),Dd(Md,[2,114]),Dd(Md,[2,115]),Dd(Md,[2,116]),Dd(Md,[2,117]),Dd(Md,[2,118]),Dd(Md,[2,119]),Dd(Md,[2,120]),Dd(Md,[2,121]),Dd(Md,[2,122]),Dd(Md,[2,123]),Dd(Md,[2,124]),Dd(Md,[2,125]),Dd(Md,[2,126]),Dd(Md,[2,127]),Dd(Md,[2,128]),Dd(Md,[2,129]),Dd(Md,[2,130]),Dd(Md,[2,131]),Dd(Md,[2,132]),Dd(Md,[2,133]),Dd(Md,[2,134]),Dd(Md,[2,135]),Dd(Md,[2,136]),Dd(Md,[2,137]),Dd(Md,[2,138]),Dd(Md,[2,139]),Dd(Md,[2,140]),Dd(Md,[2,141]),Dd(Md,[2,142]),Dd(Md,[2,143]),Dd(Md,[2,144]),Dd(Md,[2,145]),Dd(Md,[2,146]),{5:[2,10],101:Td},{5:[2,11]},{14:gd,16:158,35:yd,38:xd,77:bd,78:wd,101:Td},{14:gd,16:159,35:yd,38:xd,77:bd,78:wd},{5:[2,18]},Dd(Pd,[2,92]),Dd(Pd,[2,93]),Dd(Pd,[2,94]),Dd(Pd,[2,95]),Dd(Pd,[2,96]),{5:[2,21]},Dd(Nd,[2,75]),Dd(Nd,[2,76]),{5:[2,22]},{5:[2,23]},{5:[2,24]},{5:[2,26]},{5:[2,27]},{5:[2,28],31:[1,160]},{5:[2,30]},{36:[1,161]},{5:[2,32]},{5:[2,36]},{5:[2,37]},{5:[2,39]},{5:[2,41]},{5:[2,42],73:162,74:Ad},Dd(Id,[2,86]),{35:[1,163]},{5:[2,43],73:162,74:Ad},{5:[2,45]},{14:[1,164]},{6:gh,7:yh,9:xh,10:165,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:49,80:52,81:50,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd,101:Td},{5:[2,53]},{5:[2,62]},{5:[2,63]},{5:[2,64]},{5:[2,164]},{5:[2,66],63:166,67:146,68:147,69:148,70:Ed,72:kd},{5:[2,67]},{5:[2,77],67:167,68:147,69:148,70:Ed,72:kd},Dd(Nd,[2,81]),Dd(Nd,[2,82],{80:52,53:168,75:169,76:170,79:171,6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd}),{71:[1,172]},{71:[1,173]},{5:[2,69],63:174,67:146,68:147,69:148,70:Ed,72:kd},{5:[2,71],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,53:175,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:169,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,73],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,53:176,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:169,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,55],57:[1,177]},{5:[2,56],29:[1,178]},{5:[2,60],35:[1,179]},{6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,35:[1,181],37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:180,80:52,81:182,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{5:[2,12]},{5:[2,13]},{6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,32:183,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:184,80:52,81:185,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{14:[1,186]},Dd(Id,[2,87]),Dd(Id,[2,88]),{5:[2,48],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,53:187,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:169,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,49],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,53:188,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:169,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,101:Td},{5:[2,68]},{5:[2,78],67:189,68:147,69:148,70:Ed,72:kd},Dd(Nd,[2,83],{80:52,76:170,79:171,75:190,6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd}),Dd(Pd,[2,89]),{71:[1,191],101:[1,192]},Dd(Ld,[2,156]),{14:gd,16:193,35:yd,38:xd,77:bd,78:wd},{14:gd,16:194,35:yd,38:xd,77:bd,78:wd},{5:[2,70]},{5:[2,72],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:190,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,74],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:190,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,57]},{5:[2,58]},{5:[2,61]},Dd(Rd,[2,161]),Dd(Rd,[2,162]),Dd(Rd,[2,163]),{5:[2,29]},{5:[2,99]},{5:[2,100]},{31:[1,195]},{5:[2,50],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:190,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,51],6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,75:190,76:170,79:171,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},{5:[2,79],67:196,68:147,69:148,70:Ed,72:kd},Dd(Pd,[2,90]),{14:gd,16:197,35:yd,38:xd,77:bd,78:wd},{6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,33:Nh,34:Ih,35:[1,199],37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,79:198,80:52,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd},Dd(Nd,[2,84]),Dd(Pd,[2,85]),{6:gh,7:yh,9:xh,13:bh,15:wh,17:Sh,18:Ch,19:Ah,20:Eh,23:kh,25:Th,26:Rh,27:Mh,30:Ph,32:200,33:Nh,34:Ih,37:Lh,38:Oh,41:Vh,43:Dh,45:zh,46:Fh,49:Bh,52:Uh,54:Gh,55:jh,56:Hh,58:Wh,59:Yh,62:Xh,64:qh,65:$h,66:Zh,70:Kh,72:Qh,74:Jh,79:184,80:52,81:185,82:ed,83:td,84:rd,85:nd,86:id,87:od,88:sd,89:ad,90:ld,91:cd,92:ud,93:hd,94:dd,95:fd,96:pd,97:md,98:_d,99:vd},{5:[2,80]},Dd(Pd,[2,91]),Dd(Ld,[2,157]),Dd(Ld,[2,158]),{5:[2,31]}],defaultActions:{3:[2,2],4:[2,3],7:[2,8],8:[2,9],11:[2,14],12:[2,15],13:[2,16],15:[2,19],16:[2,20],25:[2,33],26:[2,34],29:[2,40],34:[2,46],35:[2,47],37:[2,52],46:[2,1],47:[2,5],107:[2,11],110:[2,18],116:[2,21],119:[2,22],120:[2,23],121:[2,24],122:[2,26],123:[2,27],125:[2,30],127:[2,32],128:[2,36],129:[2,37],130:[2,39],131:[2,41],136:[2,45],139:[2,53],140:[2,62],141:[2,63],142:[2,64],143:[2,164],145:[2,67],158:[2,12],159:[2,13],166:[2,68],174:[2,70],177:[2,57],178:[2,58],179:[2,61],183:[2,29],184:[2,99],185:[2,100],196:[2,80],200:[2,31]},parseError:function(e,t){if(!t.recoverable){var r=new Error(e);throw r.hash=t,r}this.trace(e)},parse:function(e){var t=this,r=[0],n=[],i=[null],o=[],s=this.table,a="",l=0,c=0,u=1,h=o.slice.call(arguments,1),d=Object.create(this.lexer),f={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(f.yy[p]=this.yy[p]);d.setInput(e,f.yy),f.yy.lexer=d,f.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var m=d.yylloc;o.push(m);var _=d.options&&d.options.ranges;"function"==typeof f.yy.parseError?this.parseError=f.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var v,g,y,x,b,w,S,C,A,E={};;){if(g=r[r.length-1],void 0===(y=this.defaultActions[g]?this.defaultActions[g]:(null==v&&(A=void 0,"number"!=typeof(A=n.pop()||d.lex()||u)&&(A instanceof Array&&(A=(n=A).pop()),A=t.symbols_[A]||A),v=A),s[g]&&s[g][v]))||!y.length||!y[0]){var k="";for(b in C=[],s[g])this.terminals_[b]&&2<b&&C.push("'"+this.terminals_[b]+"'");k=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+C.join(", ")+", got '"+(this.terminals_[v]||v)+"'":"Parse error on line "+(l+1)+": Unexpected "+(v==u?"end of input":"'"+(this.terminals_[v]||v)+"'"),this.parseError(k,{text:d.match,token:this.terminals_[v]||v,line:d.yylineno,loc:m,expected:C})}if(y[0]instanceof Array&&1<y.length)throw new Error("Parse Error: multiple actions possible at state: "+g+", token: "+v);switch(y[0]){case 1:r.push(v),i.push(d.yytext),o.push(d.yylloc),r.push(y[1]),v=null,c=d.yyleng,a=d.yytext,l=d.yylineno,m=d.yylloc;break;case 2:if(w=this.productions_[y[1]][1],E.$=i[i.length-w],E._$={first_line:o[o.length-(w||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(w||1)].first_column,last_column:o[o.length-1].last_column},_&&(E._$.range=[o[o.length-(w||1)].range[0],o[o.length-1].range[1]]),void 0!==(x=this.performAction.apply(E,[a,c,l,f.yy,y[1],i,o].concat(h))))return x;w&&(r=r.slice(0,-1*w*2),i=i.slice(0,-1*w),o=o.slice(0,-1*w)),r.push(this.productions_[y[1]][0]),i.push(E.$),o.push(E._$),S=s[r[r.length-2]][r[r.length-1]],r.push(S);break;case 3:return!0}}return!0}},Vd={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,r=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(20<e.length?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(20<e.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var r,n,i;if(this.options.backtrack_lexer&&(i={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(i.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],r=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var o in i)this[o]=i[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,r,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((r=this._input.match(this.rules[i[o]]))&&(!t||r[0].length>t[0].length)){if(t=r,n=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(r,i[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,i[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return 0<this.conditionStack.length-1?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return 0<=(e=this.conditionStack.length-1-Math.abs(e||0))?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,r){switch(r){case 0:break;case 1:case 2:return"";case 3:return 42;case 4:return 35;case 5:return 77;case 6:case 7:return 78;case 8:return 8;case 9:return 6;case 10:return 82;case 11:return 7;case 12:return 9;case 13:return 59;case 14:return 13;case 15:return 15;case 16:return 17;case 17:return 18;case 18:return 19;case 19:return 20;case 20:return 11;case 21:return 62;case 22:return 64;case 23:return 23;case 24:return 25;case 25:return 26;case 26:return 27;case 27:return 30;case 28:return 34;case 29:return 33;case 30:return 65;case 31:return 66;case 32:return 37;case 33:return 41;case 34:return 43;case 35:return 52;case 36:return 54;case 37:return 55;case 38:return 46;case 39:return 48;case 40:return 45;case 41:return 49;case 42:return 56;case 43:return 58;case 44:return 44;case 45:return 83;case 46:return 84;case 47:return 85;case 48:return 86;case 49:return 87;case 50:return 88;case 51:return 89;case 52:return 90;case 53:return 91;case 54:return 92;case 55:return 93;case 56:return 94;case 57:return 95;case 58:case 59:return 70;case 60:case 61:return 72;case 62:case 63:case 64:return 74;case 65:return 31;case 66:return 36;case 67:return 96;case 68:return 97;case 69:return 98;case 70:return 99;case 71:return t.yytext=e.utils.unquoteString(t.yytext),14;case 72:return 38;case 73:return 5;case 74:return 101;case 75:return 103;case 76:return"\\";case 77:return 28;case 78:return 61;case 79:return 29;case 80:return 57;case 81:return 71}},rules:[/^(?:\s+)/i,/^(?:[#].*)/i,/^(?:\/\/.*)/i,/^(?:([_A-Z0-9\/\+]+==))/i,/^(?:-?[0-9]+(\.[0-9]+)?\b)/i,/^(?:0[xX][0-9A-F]+\b)/i,/^(?:false\b)/i,/^(?:true\b)/i,/^(?:all\b)/i,/^(?:reset\b)/i,/^(?:clear\b)/i,/^(?:build\b)/i,/^(?:help\b)/i,/^(?:load\b)/i,/^(?:get\b)/i,/^(?:set\b)/i,/^(?:set_save\b)/i,/^(?:set_restore\b)/i,/^(?:set_reset\b)/i,/^(?:preset\b)/i,/^(?:motm\b)/i,/^(?:add\b)/i,/^(?:rep\b)/i,/^(?:remove\b)/i,/^(?:hide\b)/i,/^(?:show\b)/i,/^(?:list\b)/i,/^(?:select\b)/i,/^(?:within\b)/i,/^(?:selector\b)/i,/^(?:mode\b)/i,/^(?:color\b)/i,/^(?:material\b)/i,/^(?:view\b)/i,/^(?:unit\b)/i,/^(?:line\b)/i,/^(?:listobj\b)/i,/^(?:removeobj\b)/i,/^(?:rotate\b)/i,/^(?:translate\b)/i,/^(?:scale\b)/i,/^(?:center\b)/i,/^(?:url\b)/i,/^(?:screenshot\b)/i,/^(?:dssp\b)/i,/^(?:file_list\b)/i,/^(?:file_register\b)/i,/^(?:file_delete\b)/i,/^(?:preset_add\b)/i,/^(?:preset_delete\b)/i,/^(?:preset_update\b)/i,/^(?:preset_rename\b)/i,/^(?:preset_open\b)/i,/^(?:create_scenario\b)/i,/^(?:reset_scenario\b)/i,/^(?:delete_scenario\b)/i,/^(?:add_scenario_item\b)/i,/^(?:list_scenario\b)/i,/^(?:s\b)/i,/^(?:mt\b)/i,/^(?:m\b)/i,/^(?:c\b)/i,/^(?:x\b)/i,/^(?:y\b)/i,/^(?:z\b)/i,/^(?:as\b)/i,/^(?:of\b)/i,/^(?:pdb\b)/i,/^(?:delay\b)/i,/^(?:prst\b)/i,/^(?:desc\b)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:\.)/i,/^(?:\/)/i,/^(?:\\)/i,/^(?:-e\b)/i,/^(?:-f\b)/i,/^(?:-s\b)/i,/^(?:-v\b)/i,/^(?:=)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81],inclusive:!0}}},Od.lexer=Vd,new((zd.prototype=Od).Parser=zd))}.parser,Bd={$help:["Rendering mode shortcut","    BS - balls and sticks mode","    LN - lines mode","    LC - licorice mode","    VW - van der waals mode","    TR - trace mode","    TU - tube mode","    CA - cartoon mode","    SA - isosurface mode","    QS - quick surface mode","    SE - solvent excluded mode","    TX - text mode"],BS:{$help:["   Balls and sticks","      aromrad = <number> #aromatic radius","      atom = <number>    #atom radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},CA:{$help:["   Cartoon","      arrow = <number>   #arrow size","      depth = <number>   #depth of surface","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> #","      width = <number>  #secondary width\n"]},LN:{$help:["   Lines","      atom = <number>    #atom radius","      chunkarom = <number>","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      offsarom = <number>\n"]},LC:{$help:["   Licorice","      aromrad = <number> #aromatic radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},VW:{$help:["   Van der Waals","      nothing\n"]},TR:{$help:["   Trace","      radius = <number>  #tube radius\n"]},TU:{$help:["   Tube","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> \n"]},SA:{$help:["   Surface","      zClip = <bool> #clip z plane\n"]},QS:{$help:["   Quick surface","      isoValue = <number>","      scale = <number>","      wireframe = <bool>","      zClip = <bool> #clip z plane\n"]},SE:{$help:["   Solvent excluded surface","      zClip = <bool> #clip z plane\n"]},TX:{$help:["   Text mode",'      template = <format string> string that can include "{{ id }}"',"          it will be replaced by value, id can be one of next:","          serial, name, type, sequence, residue, chain, hetatm, water\n",'      horizontalAlign = <string> {"left", "right", "center"}','      verticalAlign = <string> {"top", "bottom", "middle"}',"      dx = <number> #offset along x","      dy = <number> #offset along y","      dz = <number> #offset along z","      fg = <string> #text color modificator","           could be keyword, named color or hex","      fg = <string> #back color modificator","           could be keyword, named color or hex","      showBg = <bool> #if set show background","           plate under text"]}},Ud={$help:["Coloring mode shortcut","    EL - color by element","    CH - color by chain","    SQ - color by sequence","    RT - color by residue type","    SS - color by secondary structure","    UN - uniform"],UN:{$help:["Parameters of coloring modes customization","   Uniform","      color = <number|color> #RGB->HEX->dec\n"],color:{$help:Object.keys(fs.get(Q.now.palette).namedColors).sort().join("\n")}}},Gd={$help:["Material shortcut","    DF - diffuse","    TR - transparent","    SF - soft plastic","    PL - glossy plastic","    ME - metal","    GL - glass"]},jd={$help:["Short (packed) representation description as a set of variables","    s=<EXPRESSION>","        selector property","    m=<MODE_ID>[!<PARAMETER>:<VALUE>[,...]]","        render mode property","    c=<COLORER_ID>[!<PARAMETER>:<VALUE>[,...]]","        color mode property","    mt=<MATERIAL_ID>","        material property"],s:{$help:"Selection expression string as it is in menu->representations->selection"},m:Bd,c:Ud,mt:Gd},Hd={$help:["Parameters of rendering modes customization: modes","Parameters of colorer customization: colorers","Autobuild: autobuild = (<number>|<bool>)"],modes:Bd,colorers:Ud},Wd={$help:["help (<cmd name>| <path to property>)","You can get detailed information about command options",'   using "help cmd.opt.opt.[...]"\n',"   you can use one line comments","   everything started from (#|//) will be skipped","   Example: >build //some comment\n","List of available commands:"],reset:{$help:["Reload current object, delete all representations","    Nothing will work until load new object"]},load:{$help:["load (<PDBID>|<URL>|-f [<*.NC FILE URL STRING>])","    Load new pdb object from selected source"],PDBID:{$help:"pdb id in remote molecule database"},URL:{$help:"url to source file"},f:{$help:["open file system dialog to fetch local file","optionally you can determine trajectory file","via URL for *.top model"]}},clear:{$help:"No args. Clear terminal"},add:{$help:["add [<REP_NAME>] [<DESCRIPTION>]","    Add new item to representation set with","    default or <DESCRIPTION> params"],REP_NAME:{$help:"Identifier string [_,a-z,A-Z,0-9] can not start from digit"},DESCRIPTION:jd},rep:{$help:["rep [<REP_NAME>|<REP_INDEX>] [<DESCRIPTION>]","    set current representation by name or index","    edit current representation by <DESCRIPTION>"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"},DESCRIPTION:jd},remove:{$help:["remove (<REP_NAME>|<REP_INDEX>)","Remove representation by name or index"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"}},selector:{$help:["selector <EXPRESSION>","   set selector from EXPRESSION to current representation"],EXPRESSION:{$help:"Selection expression string as it is in menu->representations->selection"}},mode:{$help:["mode <MODE_ID> [<PARAMETER>=<VALUE>...]","   set rendering mode and apply parameters to current representation"],MODE_ID:Bd},color:{$help:["color <COLORER_ID> [<PARAMETER>=<VALUE>...]","   set colorer and apply parameters to current representation"],COLORER_ID:Ud},material:{$help:["material <MATERIAL_ID>","   set material to current representation"],MATERIAL_ID:Gd},build:{$help:"build help str",add:{$help:"build.add",new:{$help:["add.new","add.new new line 1","add.new new line 2","add.new new line 3"]}},del:{$help:"build.del"}},list:{$help:["list [-e|-s|<REP_NAME>|<REP_INDEX>]","Print representations if no args print list of representations","    -e expand list and show all representations","    -s show all user-registered selectors","    <REP_NAME>|<REP_INDEX> show only current representation"]},hide:{$help:["hide (<REP_NAME>|<REP_INDEX>)","Hide representation referenced in args"]},show:{$help:["show (<REP_NAME>|<REP_INDEX>)","Show representation referenced in args"]},get:{$help:["get <PARAMETER>","Print <PARAMETER> value","    <PARAMETER> - path to option use get.PARAMETER to get more info"],PARAMETER:Hd},set:{$help:["set <PARAMETER> <VALUE>","Set <PARAMETER> with <VALUE>","    <PARAMETER> - path to option use set.PARAMETER to get more info"],PARAMETER:Hd},set_save:{$help:["set_save","Save current settings to cookie"]},set_restore:{$help:["set_restore","Load and apply settings from cookie"]},set_reset:{$help:["set_reset","Reset current settings to the defaults"]},preset:{$help:["preset [<PRESET>]","Reset current representation or set preset to <PRESET>"],PRESET:{$help:["default","wire","small","macro"]}},unit:{$help:["unit [<unit_id>]","Change current biological structure view. Zero <unit_id> value means asymmetric unit,","positive values set an assembly with corresponding number.","Being called with no parameters command prints current unit information."]},view:{$help:["view [<ENCODED_VIEW>]","Get current encoded view or set if ENCODED_VIEW placed as argument"],ENCODED_VIEW:{$help:["encoded view matrix string (binary code)"]}},rotate:{$help:["rotate (x|y|z) [<DEGREES>] [(x|y|z) [<DEGREES>]]...","Rotate scene"]},scale:{$help:["scale <SCALE>","Scale scene"]},select:{$help:["select <SELECTOR_STRING> [as <SELECTOR_NAME>]","Select atoms using selector defined in SELECTOR_STRING","    and if SELECTOR_NAME is defined register it in viewer","    you can use it later as a complex selector"]},within:{$help:["within <DISTANCE> of <SELECTOR_STRING> as <SELECTOR_NAME>","Build within named selector","    DISTANCE        <number>","    SELECTOR_STRING <string(selection language)>","    SELECTOR_NAME   <identifier>"]},url:{$help:["url [-s] [-v]","Report URL encoded scene","    if -s set that include settings in the URL","    if -v set that include view in the URL"]},screenshot:{$help:["screenshot [<WIDTH> [<HEIGHT>]]","Make a screenshot of the scene","    WIDTH  <number> in pixels","    HEIGHT <number> in pixels, equal to WIDTH by default"]},line:{$help:["line <first_atom_path> <second_atom_path> [<PARAMETER>=<VALUE>]","Draw dashed line between two specified atoms"]},removeobj:{$help:["removeobj <id>","Remove scene object by its index. Indices could be obtained by <listobj> command"]},listobj:{$help:["listobj","Display the list of all existing scene objects"]}},Yd=rh.chem.selectors,Xd=rh.modes,qd=rh.colorers,$d=rh.materials,Zd=rh.palettes,Kd=rh.options,Qd=rh.settings;function Jd(){}var ef,tf=(ef=new Jd,function(){return ef}),rf=new(function(){function e(){W(this,e),this.representationMap={},this.representationID={}}return p(e,[{key:"get",value:function(e){return this.representationMap[e]||this.representationID[e]||"<no name>"}},{key:"add",value:function(e,t){if(-1===e)return"Can not create representation: there is no data";if(void 0!==t){if(this.representationMap.hasOwnProperty(e))return"This name has already existed, registered without name";this.representationMap[e.toString()]=t,this.representationID[t]=e.toString()}return"Representation ".concat(e," successfully added")}},{key:"remove",value:function(e){e&&this.representationID.hasOwnProperty(e)&&(delete this.representationMap[this.representationID[e]],delete this.representationID[e]);var t=Object.keys(this.representationID).sort();for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];e<n&&(this.representationID[n-1]=this.representationID[n],--this.representationMap[this.representationID[n]],delete this.representationID[n])}}},{key:"clear",value:function(){this.representationMap={},this.representationID={}}}]),e}());function nf(e){var t={s:"selector",m:"mode",c:"colorer",mt:"material",mode:"modes",color:"colorers",colorer:"colorers",select:"selector",material:"materials",selector:"selector"}[e];return void 0===t?e:t}var of=new(function(){function e(){W(this,e)}return p(e,[{key:"list",value:function(e,t,r){var n="";if(e&&void 0!==t&&(void 0===r||"-e"===r))for(var i=e.repCount(),o=0;o<i;o++)n+=this.listRep(e,t,o,r);return n}},{key:"listRep",value:function(e,t,r,n){var i="",o=e.repGet(r);if(!o)return I.warn("Rep ".concat(r," does not exist!")),i;var s=r,a=t.get(s),l=o.mode,c=o.colorer,u=o.selectorString,h=o.materialPreset;return i+="#".concat(s," : ").concat(l.name).concat("<no name>"===a?"":", ".concat(a),"\n"),void 0!==n&&(i+='    selection : "'.concat(u,'"\n'),i+="    mode      : (".concat(l.id,"), ").concat(l.name,"\n"),i+="    colorer   : (".concat(c.id,"), ").concat(c.name,"\n"),i+="    material  : (".concat(h.id,"), ").concat(h.name,"\n")),i}},{key:"listSelector",value:function(e,t){var r="";for(var n in t)t.hasOwnProperty(n)&&(r+="".concat(n,' : "').concat(t[n],'"\n'));return r}},{key:"listObjs",value:function(e){var t=e._objects;if(!t||!Array.isArray(t)||0===t.length)return"There are no objects on the scene";for(var r=[],n=0,i=t.length;n<i;++n)r[n]="".concat(n,": ").concat(t[n].toString());return r.join("\n")}},{key:"joinHelpStr",value:function(e){return e instanceof Array?e.join("\n"):e}},{key:"help",value:function(e){if(w.isUndefined(e))return"".concat(this.joinHelpStr(Wd.$help),"\n").concat(w.slice(w.sortBy(w.keys(Wd)),1).join(", "),"\n");var t=w.get(Wd,e);return w.isUndefined(t)?this.help():"".concat(this.joinHelpStr(t.$help),"\n")}},{key:"load",value:function(e,t){if(void 0!==e&&void 0!==t&&"-f"!==t){e.awaitWhileCMDisInProcess();var r=function(){return e.finishAwaitingCMDInProcess()};e.load(t).then(r,r)}}},{key:"checkArg",value:function(e,t,r){if(void 0===e||void 0===t)return tf;if("selector"===nf(e)){var n=Yd.parse(t);if(void 0===n.error)return void 0!==r&&r?n.selector:t;throw{message:n.error}}for(var i,o={colorers:qd,modes:Xd,materials:$d},s=e;s!==i;)s=nf(i=s);if(void 0!==o[s].get(t))return t;throw{message:"".concat(t," is not existed in ").concat(s)}}},{key:"propagateProp",value:function(e,t){if(void 0!==e){var r=Kd.adapters[x(w.get(Qd.defaults,e))];if(void 0===r)throw{message:"".concat(e," is not existed")};if((e.endsWith(".color")||e.endsWith(".baseColor")||e.endsWith(".EL.carbon"))&&"number"!=typeof t&&(t=Zd.get(Qd.now.palette).getNamedColor(t)),e.endsWith(".fg")||e.endsWith(".bg"))if("number"!=typeof t){var n=Zd.get(Qd.now.palette).getNamedColor(t,!0);void 0!==n&&(t="0x".concat(n.toString(16)))}else t="0x".concat(t.toString(16));if(e.endsWith(".template")&&(t=t.replace(/\\n/g,"\n")),void 0!==t&&r(t)!==t&&r(t)!==0<t)throw{message:"".concat(e,' must be a "').concat(x(w.get(Qd.defaults,e)),'"')}}return t}},{key:"unquoteString",value:function(e){return _e.unquoteString(e)}}]),e}());function sf(e){if(e instanceof this.constructor)return e;e instanceof Array?this._values=e.slice(0):this._values=e?[e]:[]}sf.prototype.append=function(e){var t=this._values;return t[t.length]=e,this},sf.prototype.remove=function(e){var t=this._values,r=t.indexOf(e);return 0<=r&&t.splice(r,1),this},sf.prototype.toJSO=function(e,t,r){for(var n={},i=this._values,o=0,s=i.length;o<s;++o)w.set(n,i[o].id,e.propagateProp("".concat(nf(t),".").concat(r,".").concat(i[o].id),i[o].val));return n};var af=Object.create({});return af.Arg=function(e,t){this.id=e,this.val=t},af.ArgList=sf,af.miew=null,af.echo=null,af.representations=rf,af.utils=of,af._=w,af.CreateObjectPair=function(e,t){var r={};return r[e]=t,r},af.keyRemap=nf,af.Context=Yd.Context,af.ClearContext=Yd.ClearContext,af.NULL=tf,af.notimplemented=function(){return this.NULL},rh.prototype.script=function(e,t,r){Fd.yy.miew=this,Fd.yy.echo=t,Fd.yy.error=r,void 0===this.cmdQueue&&(this.cmdQueue=[]),void 0===this.commandInAction&&(this.commandInAction=!1),this.cmdQueue=this.cmdQueue.concat(e.split("\n"))},rh.prototype.awaitWhileCMDisInProcess=function(){this.commandInAction=!0},rh.prototype.finishAwaitingCMDInProcess=function(){this.commandInAction=!1},rh.prototype.isScriptingCommandAvailable=function(){return void 0!==this.commandInAction&&!this.commandInAction&&void 0!==this.cmdQueue&&0<this.cmdQueue.length},rh.prototype.callNextCmd=function(){if(this.isScriptingCommandAvailable()){var e=this.cmdQueue.shift(),t={success:!1};try{Fd.parse(e),t.success=!0}catch(e){t.error=e.message,Fd.yy.error(t.error),this.finishAwaitingCMDInProcess()}return t}return""},Fd.yy=af,Fd.yy.parseError=Fd.parseError,rh});
//# sourceMappingURL=Miew.min.js.map