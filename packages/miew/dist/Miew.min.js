/*! Miew - 3D Molecular Viewer v0.11.1 Copyright (c) 2015-2025 EPAM Systems, Inc. */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("three")):"function"==typeof define&&define.amd?define(["lodash","three"],t):"object"==typeof exports?exports.Miew=t(require("lodash"),require("three")):e.Miew=t(e._,e.THREE)}(this,((e,t)=>(()=>{var r={89:e=>{var t=function(){var e=function(e,t,r,n){for(r=r||{},n=e.length;n--;r[e[n]]=t);return r},t=[1,60],r=[1,62],n=[1,63],s=[1,65],i=[1,66],o=[1,67],a=[1,68],l=[1,69],c=[1,80],h=[1,72],u=[1,73],d=[1,74],p=[1,75],m=[1,99],f=[1,76],_=[1,100],g=[1,79],y=[1,51],x=[1,81],b=[1,82],w=[1,84],S=[1,83],v=[1,85],C=[1,96],A=[1,97],E=[1,98],T=[1,86],R=[1,87],M=[1,64],P=[1,70],N=[1,71],L=[1,77],I=[1,78],O=[1,53],V=[1,54],D=[1,55],k=[1,61],z=[1,88],F=[1,89],B=[1,90],U=[1,91],G=[1,92],j=[1,93],H=[1,94],$=[1,95],W=[1,101],Y=[1,102],X=[1,103],q=[1,104],Z=[1,105],K=[1,56],Q=[1,57],J=[1,58],ee=[1,59],te=[1,115],re=[1,111],ne=[1,114],se=[1,112],ie=[1,113],oe=[1,118],ae=[1,117],le=[1,134],ce=[1,149],he=[1,150],ue=[1,157],de=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],pe=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,71,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],me=[5,6,7,9,13,15,17,18,19,20,23,25,26,27,30,33,34,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,82,83,84,85,86,87,88,89,90,91,92,93,94,95],fe=[5,70,72],_e=[5,74],ge=[71,101],ye={trace:function(){},yy:{},symbols_:{error:2,Program:3,Command:4,EOF:5,RESET:6,BUILD:7,ALL:8,HELP:9,Path:10,MOTM:11,OneArgCommand:12,GET:13,STRING:14,SET:15,Value:16,SET_SAVE:17,SET_RESTORE:18,SET_RESET:19,PRESET:20,AddRepresentation:21,EditRepresentation:22,REMOVE:23,RepresentationReference:24,HIDE:25,SHOW:26,LIST:27,EXPAND_KEY:28,SELECTOR_KEY:29,SELECT:30,AS:31,WordAll:32,SELECTOR:33,WITHIN:34,NUMBER:35,OF:36,MATERIAL:37,IDENTIFIER:38,ModeCMD:39,ColorCMD:40,VIEW:41,BASE_64:42,UNIT:43,DSSP:44,SCALE:45,ROTATE:46,AxesList:47,TRANSLATE:48,CENTER:49,GetURLBranch:50,Screenshot:51,LINE:52,ArgList:53,LISTOBJ:54,REMOVEOBJ:55,URL:56,VIEW_KEY:57,SCREENSHOT:58,LOAD:59,Url:60,FILE_KEY:61,ADD:62,Description:63,REP:64,MODE:65,COLOR:66,Descriptor:67,RepresentationOwnProperty:68,RepresentationOwnPropertyOpts:69,DESC_KEY:70,"=":71,DESC_KEY_OPTS:72,AxesArg:73,DESC_KEY_AXES:74,Arg:75,PathWoDescKey:76,HEX:77,BOOL:78,Word:79,CommandSetWoDESC_KEY:80,DescKeys:81,CLEAR:82,FILE_LIST:83,FILE_REGISTER:84,FILE_DELETE:85,PRESET_ADD:86,PRESET_DELETE:87,PRESET_UPDATE:88,PRESET_RENAME:89,PRESET_OPEN:90,CREATE_SCENARIO:91,RESET_SCENARIO:92,DELETE_SCENARIO:93,ADD_SCENARIO_ITEM:94,LIST_SCENARIO:95,PDB_KEY:96,DELAY_KEY:97,PRST_KEY:98,DESCRIPTION_KEY:99,CommandSet:100,".":101,PresetPath:102,"/":103,HexOrNumber:104,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"RESET",7:"BUILD",8:"ALL",9:"HELP",11:"MOTM",13:"GET",14:"STRING",15:"SET",17:"SET_SAVE",18:"SET_RESTORE",19:"SET_RESET",20:"PRESET",23:"REMOVE",25:"HIDE",26:"SHOW",27:"LIST",28:"EXPAND_KEY",29:"SELECTOR_KEY",30:"SELECT",31:"AS",33:"SELECTOR",34:"WITHIN",35:"NUMBER",36:"OF",37:"MATERIAL",38:"IDENTIFIER",41:"VIEW",42:"BASE_64",43:"UNIT",44:"DSSP",45:"SCALE",46:"ROTATE",48:"TRANSLATE",49:"CENTER",52:"LINE",54:"LISTOBJ",55:"REMOVEOBJ",56:"URL",57:"VIEW_KEY",58:"SCREENSHOT",59:"LOAD",61:"FILE_KEY",62:"ADD",64:"REP",65:"MODE",66:"COLOR",70:"DESC_KEY",71:"=",72:"DESC_KEY_OPTS",74:"DESC_KEY_AXES",77:"HEX",78:"BOOL",82:"CLEAR",83:"FILE_LIST",84:"FILE_REGISTER",85:"FILE_DELETE",86:"PRESET_ADD",87:"PRESET_DELETE",88:"PRESET_UPDATE",89:"PRESET_RENAME",90:"PRESET_OPEN",91:"CREATE_SCENARIO",92:"RESET_SCENARIO",93:"DELETE_SCENARIO",94:"ADD_SCENARIO_ITEM",95:"LIST_SCENARIO",96:"PDB_KEY",97:"DELAY_KEY",98:"PRST_KEY",99:"DESCRIPTION_KEY",101:".",103:"/"},productions_:[0,[3,2],[3,1],[4,1],[4,1],[4,2],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,2],[4,2],[4,1],[4,2],[4,2],[4,2],[4,4],[4,2],[4,6],[4,2],[4,1],[4,1],[4,1],[4,2],[4,2],[4,1],[4,2],[4,1],[4,2],[4,2],[4,2],[4,1],[4,2],[4,1],[4,1],[4,3],[4,3],[4,4],[4,4],[4,1],[4,2],[50,1],[50,2],[50,2],[50,3],[50,3],[51,1],[51,2],[51,3],[12,2],[12,2],[12,2],[21,1],[21,2],[21,2],[21,3],[22,2],[22,3],[39,2],[39,3],[40,2],[40,3],[24,1],[24,1],[63,1],[63,2],[63,3],[63,4],[67,1],[67,1],[67,2],[68,3],[69,3],[47,1],[47,2],[73,2],[53,1],[53,2],[75,3],[16,1],[16,1],[16,1],[16,1],[16,1],[79,1],[79,1],[32,1],[32,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[100,1],[100,1],[76,1],[76,3],[76,3],[10,1],[10,1],[10,3],[10,3],[10,3],[60,1],[102,1],[102,3],[104,1],[104,1]],performAction:function(e,t,r,n,s,i,o){var a=i.length-1;switch(s){case 1:return i[a-1];case 3:this.$=n.miew.reset(!1),n.ClearContext(),n.miew.resetReps("empty");break;case 4:this.$=n.miew.rebuild();break;case 5:this.$=n.miew.rebuildAll(),n.miew.rebuild();break;case 6:this.$=n.echo(n.utils.help().toString());break;case 7:this.$=n.echo(n.utils.help(i[a]).toString());break;case 8:this.$=n.miew.motm();break;case 10:case 11:this.$=n.utils.propagateProp(i[a]),n.echo(n.miew.get(i[a]).toString());break;case 12:case 13:this.$=n.miew.set(i[a-1],n.utils.propagateProp(i[a-1],i[a]));break;case 14:this.$=n.miew.saveSettings();break;case 15:this.$=n.miew.restoreSettings();break;case 16:this.$=n.miew.resetSettings();break;case 17:this.$=n.miew.resetReps();break;case 18:this.$=n.miew.applyPreset(i[a]);break;case 21:this.$=n.miew.repRemove(i[a]),n.representations.remove(i[a]);break;case 22:this.$=n.miew.repHide(i[a]);break;case 23:this.$=n.miew.repHide(i[a],!1);break;case 24:this.$=n.echo(n.utils.listRep(n.miew,n.representations,i[a],"-e"));break;case 25:this.$=n.echo(n.utils.list(n.miew,n.representations));break;case 26:this.$=n.echo(n.utils.list(n.miew,n.representations,i[a]));break;case 27:this.$=n.echo(n.utils.listSelector(n.miew,n.Context));break;case 28:this.$=n.miew.select(n.utils.checkArg(i[a-1].toLowerCase(),i[a],!0));break;case 29:this.$=n.Context[i[a].toLowerCase()]=n.utils.checkArg(i[a-3].toLowerCase(),i[a-2],!0),n.miew.select(n.Context[i[a].toLowerCase()]);break;case 30:this.$=n.miew.rep(n.miew.repCurrent(),{selector:n.utils.checkArg(i[a-1].toLowerCase(),i[a])});break;case 31:this.$=n.Context[i[a].toLowerCase()]=n.miew.within(n.utils.checkArg("select",i[a-2],!0),Number(i[a-4]));break;case 32:this.$=n.miew.rep(n.miew.repCurrent(),{material:n.utils.checkArg(i[a-1].toLowerCase(),i[a].toUpperCase())});break;case 35:this.$=n.echo(n.miew.view());break;case 36:case 37:this.$=n.miew.view(i[a]);break;case 38:this.$=n.echo(n.miew.changeUnit());break;case 39:this.$=n.echo(n.miew.changeUnit(i[a]));break;case 40:this.$=n.miew.dssp();break;case 41:this.$=n.miew.scale(i[a]);break;case 42:for(var l=0,c=i[a].length;l<c;l++)n.miew.rotate(i[a][l].x*Math.PI/180,i[a][l].y*Math.PI/180,i[a][l].z*Math.PI/180);break;case 43:for(l=0,c=i[a].length;l<c;l++)n.miew.translate(i[a][l].x||0,i[a][l].y||0,i[a][l].z||0);break;case 44:this.$=n.miew.center();break;case 45:this.$=n.miew.center(i[a]);break;case 48:case 49:this.$=n.miew.addObject({type:"line",params:[i[a-1],i[a]]},!0);break;case 50:case 51:this.$=n.miew.addObject({type:"line",params:[i[a-2],i[a-1]],opts:i[a].toJSO(n.utils,"objects","line")},!0);break;case 52:this.$=n.echo(n.utils.listObjs(n.miew));break;case 53:this.$=n.miew.removeObject(i[a]);break;case 54:this.$=n.echo(n.miew.getURL({view:!1,settings:!1}));break;case 55:this.$=n.echo(n.miew.getURL({view:!1,settings:!0}));break;case 56:this.$=n.echo(n.miew.getURL({view:!0,settings:!1}));break;case 57:case 58:this.$=n.echo(n.miew.getURL({view:!0,settings:!0}));break;case 59:this.$=n.miew.screenshotSave();break;case 60:this.$=n.miew.screenshotSave("",Number(i[a]));break;case 61:this.$=n.miew.screenshotSave("",Number(i[a-1]),Number(i[a]));break;case 62:case 63:case 64:this.$=n.utils.load(n.miew,i[a]),n.representations.clear();break;case 65:this.$=n.echo(n.representations.add(n.miew.repAdd()));break;case 66:this.$=n.echo(n.representations.add(i[a],n.miew.repAdd()));break;case 67:this.$=n.echo(n.representations.add(n.miew.repAdd(i[a])));break;case 68:this.$=n.echo(n.representations.add(i[a-1],n.miew.repAdd(i[a])));break;case 69:this.$=n.miew.rep(i[a]),n.miew.repCurrent(i[a]);break;case 70:this.$=n.miew.rep(i[a-1],i[a]),n.miew.repCurrent(i[a-1]);break;case 71:this.$=n.miew.rep(n.miew.repCurrent(),{mode:n.utils.checkArg(i[a-1].toLowerCase(),i[a].toUpperCase())});break;case 72:this.$=n.miew.rep(n.miew.repCurrent(),{mode:new Array(n.utils.checkArg(i[a-2].toLowerCase(),i[a-1].toUpperCase()),i[a].toJSO(n.utils,i[a-2],i[a-1].toUpperCase()))});break;case 73:this.$=n.miew.rep(n.miew.repCurrent(),{colorer:n.utils.checkArg(i[a-1].toLowerCase(),i[a].toUpperCase())});break;case 74:this.$=n.miew.rep(n.miew.repCurrent(),{colorer:new Array(n.utils.checkArg(i[a-2].toLowerCase(),i[a-1].toUpperCase()),i[a].toJSO(n.utils,i[a-2],i[a-1].toUpperCase()))});break;case 75:this.$=Number(n.representations.get(i[a]));break;case 76:case 92:this.$=Number(i[a]);break;case 77:this.$=i[a];break;case 78:this.$=n._.assign(i[a-1],i[a]);break;case 79:this.$=n._.assign(i[a-2],i[a-1],i[a]);break;case 80:this.$=n._.assign(i[a-3],i[a-2],i[a-1],i[a]);break;case 81:case 82:this.$=n.CreateObjectPair(i[a].key,i[a].val);break;case 83:this.$=n.CreateObjectPair(i[a-1].key,new Array(i[a-1].val,i[a].toJSO(n.utils,i[a-1].key,i[a-1].val)));break;case 84:case 85:this.$=Object.create({key:n.keyRemap(i[a-2]),val:n.utils.checkArg(i[a-2],i[a])});break;case 86:this.$=[i[a]];break;case 87:this.$=i[a-1].concat(i[a]);break;case 88:this.$=n.CreateObjectPair(i[a-1].toLowerCase(),Number(i[a]));break;case 89:this.$=new n.ArgList(i[a]);break;case 90:this.$=i[a-1].append(i[a]);break;case 91:this.$=new n.Arg(i[a-2],i[a]);break;case 93:this.$=parseInt(i[a]);break;case 94:this.$=JSON.parse(i[a]);break;case 95:case 96:this.$=String(i[a]);break;case 157:case 158:case 161:case 162:case 163:this.$=i[a-2]+i[a-1]+i[a];break;case 166:this.$=i[a-2]=i[a-2]+i[a-1]+i[a]}},table:[{3:1,4:2,5:[1,3],6:[1,4],7:[1,5],9:[1,6],11:[1,7],12:8,13:[1,9],15:[1,10],17:[1,11],18:[1,12],19:[1,13],20:[1,14],21:15,22:16,23:[1,17],25:[1,18],26:[1,19],27:[1,20],30:[1,21],33:[1,22],34:[1,23],37:[1,24],39:25,40:26,41:[1,27],43:[1,28],44:[1,29],45:[1,30],46:[1,31],48:[1,32],49:[1,33],50:34,51:35,52:[1,36],54:[1,37],55:[1,38],56:[1,44],58:[1,45],59:[1,39],62:[1,40],64:[1,41],65:[1,42],66:[1,43]},{1:[3]},{5:[1,46]},{1:[2,2]},{5:[2,3]},{5:[2,4],8:[1,47]},{5:[2,6],6:t,7:r,9:n,10:48,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:49,80:52,81:50,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{5:[2,8]},{5:[2,9]},{6:t,7:r,9:n,10:106,13:s,14:[1,107],15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:49,80:52,81:50,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{6:t,7:r,9:n,10:108,13:s,14:[1,109],15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:49,80:52,81:50,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{5:[2,14]},{5:[2,15]},{5:[2,16]},{5:[2,17],14:te,16:110,35:re,38:ne,77:se,78:ie},{5:[2,19]},{5:[2,20]},{24:116,35:oe,38:ae},{24:119,35:oe,38:ae},{24:120,35:oe,38:ae},{5:[2,25],24:121,28:[1,122],29:[1,123],35:oe,38:ae},{14:[1,124]},{14:[1,125]},{35:[1,126]},{38:[1,127]},{5:[2,33]},{5:[2,34]},{5:[2,35],14:[1,128],42:[1,129]},{5:[2,38],35:[1,130]},{5:[2,40]},{35:[1,131]},{47:132,73:133,74:le},{47:135,73:133,74:le},{5:[2,44],14:[1,136]},{5:[2,46]},{5:[2,47]},{6:t,7:r,9:n,10:138,13:s,14:[1,137],15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:49,80:52,81:50,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{5:[2,52]},{35:[1,139]},{14:[1,143],38:[1,141],60:140,61:[1,142]},{5:[2,65],38:[1,144],63:145,67:146,68:147,69:148,70:ce,72:he},{24:151,35:oe,38:ae},{38:[1,152]},{38:[1,153]},{5:[2,54],29:[1,154],57:[1,155]},{5:[2,59],35:[1,156]},{1:[2,1]},{5:[2,5]},{5:[2,7],101:ue},e(de,[2,159]),e(de,[2,160]),e(pe,[2,97]),e(pe,[2,98]),e(de,[2,147]),e(de,[2,148]),e(de,[2,149]),e(de,[2,150]),e(de,[2,151]),e(de,[2,152]),e(de,[2,153]),e(pe,[2,101]),e(pe,[2,102]),e(pe,[2,103]),e(pe,[2,104]),e(pe,[2,105]),e(pe,[2,106]),e(pe,[2,107]),e(pe,[2,108]),e(pe,[2,109]),e(pe,[2,110]),e(pe,[2,111]),e(pe,[2,112]),e(pe,[2,113]),e(pe,[2,114]),e(pe,[2,115]),e(pe,[2,116]),e(pe,[2,117]),e(pe,[2,118]),e(pe,[2,119]),e(pe,[2,120]),e(pe,[2,121]),e(pe,[2,122]),e(pe,[2,123]),e(pe,[2,124]),e(pe,[2,125]),e(pe,[2,126]),e(pe,[2,127]),e(pe,[2,128]),e(pe,[2,129]),e(pe,[2,130]),e(pe,[2,131]),e(pe,[2,132]),e(pe,[2,133]),e(pe,[2,134]),e(pe,[2,135]),e(pe,[2,136]),e(pe,[2,137]),e(pe,[2,138]),e(pe,[2,139]),e(pe,[2,140]),e(pe,[2,141]),e(pe,[2,142]),e(pe,[2,143]),e(pe,[2,144]),e(pe,[2,145]),e(pe,[2,146]),{5:[2,10],101:ue},{5:[2,11]},{14:te,16:158,35:re,38:ne,77:se,78:ie,101:ue},{14:te,16:159,35:re,38:ne,77:se,78:ie},{5:[2,18]},e(me,[2,92]),e(me,[2,93]),e(me,[2,94]),e(me,[2,95]),e(me,[2,96]),{5:[2,21]},e(fe,[2,75]),e(fe,[2,76]),{5:[2,22]},{5:[2,23]},{5:[2,24]},{5:[2,26]},{5:[2,27]},{5:[2,28],31:[1,160]},{5:[2,30]},{36:[1,161]},{5:[2,32]},{5:[2,36]},{5:[2,37]},{5:[2,39]},{5:[2,41]},{5:[2,42],73:162,74:le},e(_e,[2,86]),{35:[1,163]},{5:[2,43],73:162,74:le},{5:[2,45]},{14:[1,164]},{6:t,7:r,9:n,10:165,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:49,80:52,81:50,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee,101:ue},{5:[2,53]},{5:[2,62]},{5:[2,63]},{5:[2,64]},{5:[2,164]},{5:[2,66],63:166,67:146,68:147,69:148,70:ce,72:he},{5:[2,67]},{5:[2,77],67:167,68:147,69:148,70:ce,72:he},e(fe,[2,81]),e(fe,[2,82],{80:52,53:168,75:169,76:170,79:171,6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z}),{71:[1,172]},{71:[1,173]},{5:[2,69],63:174,67:146,68:147,69:148,70:ce,72:he},{5:[2,71],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,53:175,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:169,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,73],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,53:176,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:169,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,55],57:[1,177]},{5:[2,56],29:[1,178]},{5:[2,60],35:[1,179]},{6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,35:[1,181],37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:180,80:52,81:182,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{5:[2,12]},{5:[2,13]},{6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,32:183,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:184,80:52,81:185,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{14:[1,186]},e(_e,[2,87]),e(_e,[2,88]),{5:[2,48],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,53:187,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:169,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,49],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,53:188,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:169,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,101:ue},{5:[2,68]},{5:[2,78],67:189,68:147,69:148,70:ce,72:he},e(fe,[2,83],{80:52,76:170,79:171,75:190,6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z}),e(me,[2,89]),{71:[1,191],101:[1,192]},e(ge,[2,156]),{14:te,16:193,35:re,38:ne,77:se,78:ie},{14:te,16:194,35:re,38:ne,77:se,78:ie},{5:[2,70]},{5:[2,72],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:190,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,74],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:190,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,57]},{5:[2,58]},{5:[2,61]},e(de,[2,161]),e(de,[2,162]),e(de,[2,163]),{5:[2,29]},{5:[2,99]},{5:[2,100]},{31:[1,195]},{5:[2,50],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:190,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,51],6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,75:190,76:170,79:171,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},{5:[2,79],67:196,68:147,69:148,70:ce,72:he},e(me,[2,90]),{14:te,16:197,35:re,38:ne,77:se,78:ie},{6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,33:f,34:_,35:[1,199],37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,79:198,80:52,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z},e(fe,[2,84]),e(me,[2,85]),{6:t,7:r,9:n,13:s,15:i,17:o,18:a,19:l,20:c,23:h,25:u,26:d,27:p,30:m,32:200,33:f,34:_,37:g,38:y,41:x,43:b,45:w,46:S,49:v,52:C,54:A,55:E,56:T,58:R,59:M,62:P,64:N,65:L,66:I,70:O,72:V,74:D,79:184,80:52,81:185,82:k,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:$,91:W,92:Y,93:X,94:q,95:Z,96:K,97:Q,98:J,99:ee},{5:[2,80]},e(me,[2,91]),e(ge,[2,157]),e(ge,[2,158]),{5:[2,31]}],defaultActions:{3:[2,2],4:[2,3],7:[2,8],8:[2,9],11:[2,14],12:[2,15],13:[2,16],15:[2,19],16:[2,20],25:[2,33],26:[2,34],29:[2,40],34:[2,46],35:[2,47],37:[2,52],46:[2,1],47:[2,5],107:[2,11],110:[2,18],116:[2,21],119:[2,22],120:[2,23],121:[2,24],122:[2,26],123:[2,27],125:[2,30],127:[2,32],128:[2,36],129:[2,37],130:[2,39],131:[2,41],136:[2,45],139:[2,53],140:[2,62],141:[2,63],142:[2,64],143:[2,164],145:[2,67],158:[2,12],159:[2,13],166:[2,68],174:[2,70],177:[2,57],178:[2,58],179:[2,61],183:[2,29],184:[2,99],185:[2,100],196:[2,80],200:[2,31]},parseError:function(e,t){if(!t.recoverable){var r=new Error(e);throw r.hash=t,r}this.trace(e)},parse:function(e){var t=this,r=[0],n=[],s=[null],i=[],o=this.table,a="",l=0,c=0,h=0,u=i.slice.call(arguments,1),d=Object.create(this.lexer),p={yy:{}};for(var m in this.yy)Object.prototype.hasOwnProperty.call(this.yy,m)&&(p.yy[m]=this.yy[m]);d.setInput(e,p.yy),p.yy.lexer=d,p.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var f=d.yylloc;i.push(f);var _=d.options&&d.options.ranges;"function"==typeof p.yy.parseError?this.parseError=p.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var g,y,x,b,w,S,v,C,A,E,T={};;){if(x=r[r.length-1],this.defaultActions[x]?b=this.defaultActions[x]:(null==g&&(E=void 0,"number"!=typeof(E=n.pop()||d.lex()||1)&&(E instanceof Array&&(E=(n=E).pop()),E=t.symbols_[E]||E),g=E),b=o[x]&&o[x][g]),void 0===b||!b.length||!b[0]){var R="";for(S in A=[],o[x])this.terminals_[S]&&S>2&&A.push("'"+this.terminals_[S]+"'");R=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[g]||g)+"'":"Parse error on line "+(l+1)+": Unexpected "+(1==g?"end of input":"'"+(this.terminals_[g]||g)+"'"),this.parseError(R,{text:d.match,token:this.terminals_[g]||g,line:d.yylineno,loc:f,expected:A})}if(b[0]instanceof Array&&b.length>1)throw new Error("Parse Error: multiple actions possible at state: "+x+", token: "+g);switch(b[0]){case 1:r.push(g),s.push(d.yytext),i.push(d.yylloc),r.push(b[1]),g=null,y?(g=y,y=null):(c=d.yyleng,a=d.yytext,l=d.yylineno,f=d.yylloc,h>0&&h--);break;case 2:if(v=this.productions_[b[1]][1],T.$=s[s.length-v],T._$={first_line:i[i.length-(v||1)].first_line,last_line:i[i.length-1].last_line,first_column:i[i.length-(v||1)].first_column,last_column:i[i.length-1].last_column},_&&(T._$.range=[i[i.length-(v||1)].range[0],i[i.length-1].range[1]]),void 0!==(w=this.performAction.apply(T,[a,c,l,p.yy,b[1],s,i].concat(u))))return w;v&&(r=r.slice(0,-1*v*2),s=s.slice(0,-1*v),i=i.slice(0,-1*v)),r.push(this.productions_[b[1]][0]),s.push(T.$),i.push(T._$),C=o[r[r.length-2]][r[r.length-1]],r.push(C);break;case 3:return!0}}return!0}},xe={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,r=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var s=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[s[0],s[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var r,n,s;if(this.options.backtrack_lexer&&(s={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(s.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],r=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var i in s)this[i]=s[i];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,r,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var s=this._currentRules(),i=0;i<s.length;i++)if((r=this._input.match(this.rules[s[i]]))&&(!t||r[0].length>t[0].length)){if(t=r,n=i,this.options.backtrack_lexer){if(!1!==(e=this.test_match(r,s[i])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,s[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,r,n){switch(r){case 0:break;case 1:case 2:return"";case 3:return 42;case 4:return 35;case 5:return 77;case 6:case 7:return 78;case 8:return 8;case 9:return 6;case 10:return 82;case 11:return 7;case 12:return 9;case 13:return 59;case 14:return 13;case 15:return 15;case 16:return 17;case 17:return 18;case 18:return 19;case 19:return 20;case 20:return 11;case 21:return 62;case 22:return 64;case 23:return 23;case 24:return 25;case 25:return 26;case 26:return 27;case 27:return 30;case 28:return 34;case 29:return 33;case 30:return 65;case 31:return 66;case 32:return 37;case 33:return 41;case 34:return 43;case 35:return 52;case 36:return 54;case 37:return 55;case 38:return 46;case 39:return 48;case 40:return 45;case 41:return 49;case 42:return 56;case 43:return 58;case 44:return 44;case 45:return 83;case 46:return 84;case 47:return 85;case 48:return 86;case 49:return 87;case 50:return 88;case 51:return 89;case 52:return 90;case 53:return 91;case 54:return 92;case 55:return 93;case 56:return 94;case 57:return 95;case 58:case 59:return 70;case 60:case 61:return 72;case 62:case 63:case 64:return 74;case 65:return 31;case 66:return 36;case 67:return 96;case 68:return 97;case 69:return 98;case 70:return 99;case 71:return t.yytext=e.utils.unquoteString(t.yytext),14;case 72:return 38;case 73:return 5;case 74:return 101;case 75:return 103;case 76:return"\\";case 77:return 28;case 78:return 61;case 79:return 29;case 80:return 57;case 81:return 71}},rules:[/^(?:\s+)/i,/^(?:[#].*)/i,/^(?:\/\/.*)/i,/^(?:([_A-Z0-9\/\+]+==))/i,/^(?:-?[0-9]+(\.[0-9]+)?\b)/i,/^(?:0[xX][0-9A-F]+\b)/i,/^(?:false\b)/i,/^(?:true\b)/i,/^(?:all\b)/i,/^(?:reset\b)/i,/^(?:clear\b)/i,/^(?:build\b)/i,/^(?:help\b)/i,/^(?:load\b)/i,/^(?:get\b)/i,/^(?:set\b)/i,/^(?:set_save\b)/i,/^(?:set_restore\b)/i,/^(?:set_reset\b)/i,/^(?:preset\b)/i,/^(?:motm\b)/i,/^(?:add\b)/i,/^(?:rep\b)/i,/^(?:remove\b)/i,/^(?:hide\b)/i,/^(?:show\b)/i,/^(?:list\b)/i,/^(?:select\b)/i,/^(?:within\b)/i,/^(?:selector\b)/i,/^(?:mode\b)/i,/^(?:color\b)/i,/^(?:material\b)/i,/^(?:view\b)/i,/^(?:unit\b)/i,/^(?:line\b)/i,/^(?:listobj\b)/i,/^(?:removeobj\b)/i,/^(?:rotate\b)/i,/^(?:translate\b)/i,/^(?:scale\b)/i,/^(?:center\b)/i,/^(?:url\b)/i,/^(?:screenshot\b)/i,/^(?:dssp\b)/i,/^(?:file_list\b)/i,/^(?:file_register\b)/i,/^(?:file_delete\b)/i,/^(?:preset_add\b)/i,/^(?:preset_delete\b)/i,/^(?:preset_update\b)/i,/^(?:preset_rename\b)/i,/^(?:preset_open\b)/i,/^(?:create_scenario\b)/i,/^(?:reset_scenario\b)/i,/^(?:delete_scenario\b)/i,/^(?:add_scenario_item\b)/i,/^(?:list_scenario\b)/i,/^(?:s\b)/i,/^(?:mt\b)/i,/^(?:m\b)/i,/^(?:c\b)/i,/^(?:x\b)/i,/^(?:y\b)/i,/^(?:z\b)/i,/^(?:as\b)/i,/^(?:of\b)/i,/^(?:pdb\b)/i,/^(?:delay\b)/i,/^(?:prst\b)/i,/^(?:desc\b)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:\.)/i,/^(?:\/)/i,/^(?:\\)/i,/^(?:-e\b)/i,/^(?:-f\b)/i,/^(?:-s\b)/i,/^(?:-v\b)/i,/^(?:=)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81],inclusive:!0}}};function be(){this.yy={}}return ye.lexer=xe,be.prototype=ye,ye.Parser=be,new be}();e.exports={parser:t}},99:e=>{var t=function(){var e=function(e,t,r,n){for(r=r||{},n=e.length;n--;r[e[n]]=t);return r},t=[1,4],r=[1,5],n=[1,6],s=[1,7],i=[1,8],o=[1,9],a=[1,11],l=[1,12],c=[5,7,8,11],h=[1,17],u=[1,22],d=[1,20],p=[1,21],m=[5,7,8,11,19],f={trace:function(){},yy:{},symbols_:{error:2,Program:3,Expression:4,EOF:5,Selector:6,OR:7,AND:8,NOT:9,"(":10,")":11,SELECTOR:12,NAMED_SELECTOR:13,SELECTOR_RANGED:14,RangeList:15,SELECTOR_NAMED:16,NameList:17,Range:18,",":19,NUMBER:20,":":21,Name:22,IDENTIFIER:23,STRING:24,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"OR",8:"AND",9:"NOT",10:"(",11:")",12:"SELECTOR",13:"NAMED_SELECTOR",14:"SELECTOR_RANGED",16:"SELECTOR_NAMED",19:",",20:"NUMBER",21:":",23:"IDENTIFIER",24:"STRING"},productions_:[0,[3,2],[4,1],[4,3],[4,3],[4,2],[4,3],[6,1],[6,1],[6,2],[6,2],[15,1],[15,3],[18,1],[18,3],[17,1],[17,3],[22,1],[22,1],[22,1]],performAction:function(e,t,r,n,s,i,o){var a=i.length-1;switch(s){case 1:return i[a-1];case 3:this.$=n.keyword("or")(i[a-2],i[a]);break;case 4:this.$=n.keyword("and")(i[a-2],i[a]);break;case 5:this.$=n.keyword("not")(i[a]);break;case 6:this.$=i[a-1];break;case 7:this.$=n.keyword(i[a])();break;case 8:this.$=n.GetSelector(i[a].toLowerCase().slice(1,i[a].length));break;case 9:case 10:this.$=n.keyword(i[a-1])(i[a]);break;case 11:this.$=new n.RangeList(i[a]);break;case 12:case 16:this.$=i[a-2].append(i[a]);break;case 13:this.$=new n.Range(Number(i[a]));break;case 14:this.$=new n.Range(Number(i[a-2]),Number(i[a]));break;case 15:this.$=new n.ValueList(i[a])}},table:[{3:1,4:2,6:3,9:t,10:r,12:n,13:s,14:i,16:o},{1:[3]},{5:[1,10],7:a,8:l},e(c,[2,2]),{4:13,6:3,9:t,10:r,12:n,13:s,14:i,16:o},{4:14,6:3,9:t,10:r,12:n,13:s,14:i,16:o},e(c,[2,7]),e(c,[2,8]),{15:15,18:16,20:h},{17:18,20:u,22:19,23:d,24:p},{1:[2,1]},{4:23,6:3,9:t,10:r,12:n,13:s,14:i,16:o},{4:24,6:3,9:t,10:r,12:n,13:s,14:i,16:o},e(c,[2,5]),{7:a,8:l,11:[1,25]},e(c,[2,9],{19:[1,26]}),e(m,[2,11]),e(m,[2,13],{21:[1,27]}),e(c,[2,10],{19:[1,28]}),e(m,[2,15]),e(m,[2,17]),e(m,[2,18]),e(m,[2,19]),e([5,7,11],[2,3],{8:l}),e(c,[2,4]),e(c,[2,6]),{18:29,20:h},{20:[1,30]},{20:u,22:31,23:d,24:p},e(m,[2,12]),e(m,[2,14]),e(m,[2,16])],defaultActions:{10:[2,1]},parseError:function(e,t){if(!t.recoverable){var r=new Error(e);throw r.hash=t,r}this.trace(e)},parse:function(e){var t=this,r=[0],n=[],s=[null],i=[],o=this.table,a="",l=0,c=0,h=0,u=i.slice.call(arguments,1),d=Object.create(this.lexer),p={yy:{}};for(var m in this.yy)Object.prototype.hasOwnProperty.call(this.yy,m)&&(p.yy[m]=this.yy[m]);d.setInput(e,p.yy),p.yy.lexer=d,p.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var f=d.yylloc;i.push(f);var _=d.options&&d.options.ranges;"function"==typeof p.yy.parseError?this.parseError=p.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var g,y,x,b,w,S,v,C,A,E,T={};;){if(x=r[r.length-1],this.defaultActions[x]?b=this.defaultActions[x]:(null==g&&(E=void 0,"number"!=typeof(E=n.pop()||d.lex()||1)&&(E instanceof Array&&(E=(n=E).pop()),E=t.symbols_[E]||E),g=E),b=o[x]&&o[x][g]),void 0===b||!b.length||!b[0]){var R="";for(S in A=[],o[x])this.terminals_[S]&&S>2&&A.push("'"+this.terminals_[S]+"'");R=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[g]||g)+"'":"Parse error on line "+(l+1)+": Unexpected "+(1==g?"end of input":"'"+(this.terminals_[g]||g)+"'"),this.parseError(R,{text:d.match,token:this.terminals_[g]||g,line:d.yylineno,loc:f,expected:A})}if(b[0]instanceof Array&&b.length>1)throw new Error("Parse Error: multiple actions possible at state: "+x+", token: "+g);switch(b[0]){case 1:r.push(g),s.push(d.yytext),i.push(d.yylloc),r.push(b[1]),g=null,y?(g=y,y=null):(c=d.yyleng,a=d.yytext,l=d.yylineno,f=d.yylloc,h>0&&h--);break;case 2:if(v=this.productions_[b[1]][1],T.$=s[s.length-v],T._$={first_line:i[i.length-(v||1)].first_line,last_line:i[i.length-1].last_line,first_column:i[i.length-(v||1)].first_column,last_column:i[i.length-1].last_column},_&&(T._$.range=[i[i.length-(v||1)].range[0],i[i.length-1].range[1]]),void 0!==(w=this.performAction.apply(T,[a,c,l,p.yy,b[1],s,i].concat(u))))return w;v&&(r=r.slice(0,-1*v*2),s=s.slice(0,-1*v),i=i.slice(0,-1*v)),r.push(this.productions_[b[1]][0]),s.push(T.$),i.push(T._$),C=o[r[r.length-2]][r[r.length-1]],r.push(C);break;case 3:return!0}}return!0}},_={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,r=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var s=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[s[0],s[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var r,n,s;if(this.options.backtrack_lexer&&(s={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(s.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],r=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var i in s)this[i]=s[i];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,r,n;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var s=this._currentRules(),i=0;i<s.length;i++)if((r=this._input.match(this.rules[s[i]]))&&(!t||r[0].length>t[0].length)){if(t=r,n=i,this.options.backtrack_lexer){if(!1!==(e=this.test_match(r,s[i])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,s[n]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,r,n){switch(r){case 0:break;case 1:return 20;case 2:return 7;case 3:return 8;case 4:return 9;case 5:return 12;case 6:return 16;case 7:return 14;case 8:return 10;case 9:return 11;case 10:return 19;case 11:return 21;case 12:return"<=";case 13:return">=";case 14:return"<";case 15:return">";case 16:return t.yytext=t.yytext.substr(1,t.yyleng-2),24;case 17:return 13;case 18:return 23;case 19:return 5;case 20:return"INVALID"}},rules:[/^(?:\s+)/i,/^(?:(-?(?:[1-9][0-9]+|[0-9]))\b)/i,/^(?:OR\b)/i,/^(?:AND\b)/i,/^(?:NOT\b)/i,/^(?:((ALL|NONE|HETATM|PROTEIN|BASIC|ACIDIC|CHARGED|POLAR|NONPOLAR|AROMATIC|NUCLEIC|PURINE|PYRIMIDINE|WATER|POLARH|NONPOLARH))\b)/i,/^(?:((NAME|ELEM|TYPE|RESIDUE|ICODE|CHAIN|ALTLOC))\b)/i,/^(?:((SERIAL|SEQUENCE|RESIDX))\b)/i,/^(?:\()/i,/^(?:\))/i,/^(?:,)/i,/^(?::)/i,/^(?:<=)/i,/^(?:>=)/i,/^(?:<)/i,/^(?:>)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:(@[_A-Z0-9]+))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],inclusive:!0}}};function g(){this.yy={}}return f.lexer=_,g.prototype=f,f.Parser=g,new g}();e.exports={parser:t}},690:function(e,t){
/*
Smooth.js version 0.1.7

Turn arrays into smooth functions.

Copyright 2012 Spencer Cohen
Licensed under MIT license (see "Smooth.js MIT license.txt")
*/
(function(){var e,r,n,s,i,o,a,l,c,h,u,d,p,m,f,_,g,y,x,b,w,S,v,C,A,E,T=Object.prototype.hasOwnProperty,R=function(e,t){for(var r in t)T.call(t,r)&&(e[r]=t[r]);function n(){this.constructor=e}return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};for(_ in d={method:(n={METHOD_NEAREST:"nearest",METHOD_LINEAR:"linear",METHOD_CUBIC:"cubic",METHOD_LANCZOS:"lanczos",METHOD_SINC:"sinc",CLIP_CLAMP:"clamp",CLIP_ZERO:"zero",CLIP_PERIODIC:"periodic",CLIP_MIRROR:"mirror",CUBIC_TENSION_DEFAULT:0,CUBIC_TENSION_CATMULL_ROM:0}).METHOD_CUBIC,cubicTension:n.CUBIC_TENSION_DEFAULT,clip:n.CLIP_CLAMP,scaleTo:0,sincFilterSize:2,sincWindow:void 0},c=function(e,t){return Math.max(0,Math.min(e,t-1))},u=function(e,t){return(e%=t)<0&&(e+=t),e},h=function(e,t){var r;return(e=u(e,r=2*(t-1)))>t-1&&(e=r-e),e},e=function(){function e(e,t){if(this.array=e.slice(0),this.length=this.array.length,!(this.clipHelper={clamp:this.clipHelperClamp,zero:this.clipHelperZero,periodic:this.clipHelperPeriodic,mirror:this.clipHelperMirror}[t.clip]))throw"Invalid clip: "+t.clip}return e.prototype.getClippedInput=function(e){return 0<=e&&e<this.length?this.array[e]:this.clipHelper(e)},e.prototype.clipHelperClamp=function(e){return this.array[c(e,this.length)]},e.prototype.clipHelperZero=function(e){return 0},e.prototype.clipHelperPeriodic=function(e){return this.array[u(e,this.length)]},e.prototype.clipHelperMirror=function(e){return this.array[h(e,this.length)]},e.prototype.interpolate=function(e){throw"Subclasses of AbstractInterpolator must override the interpolate() method."},e}(),i=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return R(t,e),t.prototype.interpolate=function(e){return this.getClippedInput(Math.round(e))},t}(e),s=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return R(t,e),t.prototype.interpolate=function(e){var t;return(1-(e-=t=Math.floor(e)))*this.getClippedInput(t)+e*this.getClippedInput(t+1)},t}(e),r=function(e){function t(e,r){this.tangentFactor=1-Math.max(-1,Math.min(1,r.cubicTension)),t.__super__.constructor.apply(this,arguments)}return R(t,e),t.prototype.getTangent=function(e){return this.tangentFactor*(this.getClippedInput(e+1)-this.getClippedInput(e-1))/2},t.prototype.interpolate=function(e){var t,r,n,s,i;return t=Math.floor(e),r=[this.getTangent(t),this.getTangent(t+1)],(2*(i=(e-=t)*(s=e*e))-3*s+1)*(n=[this.getClippedInput(t),this.getClippedInput(t+1)])[0]+(i-2*s+e)*r[0]+(-2*i+3*s)*n[1]+(i-s)*r[1]},t}(e),S=Math.sin,o=Math.PI,v=function(e){return 0===e?1:S(o*e)/(o*e)},g=function(e){return function(t){return v(t/e)}},x=function(e){return function(t){return v(t)*e(t)}},a=function(e){function t(e,r){if(t.__super__.constructor.apply(this,arguments),this.a=r.sincFilterSize,!r.sincWindow)throw"No sincWindow provided";this.kernel=x(r.sincWindow)}return R(t,e),t.prototype.interpolate=function(e){var t,r,n,s,i;for(n=0,r=s=(t=Math.floor(e))-this.a+1,i=t+this.a;s<=i?r<=i:r>=i;s<=i?r++:r--)n+=this.kernel(e-r)*this.getClippedInput(r);return n},t}(e),p=function(e,t){var r,n,s,i;for(i=[],n=0,s=e.length;n<s;n++)r=e[n],i.push(r[t]);return i},y=function(e,t,r){var n,s;return"0,1"===r.join?e:(n=t/(r[1]-r[0]),s=r[0],function(t){return e(n*(t-s))})},m=function(e){return Object.prototype.toString.call(e).slice(8,-1)},A=function(e){if(isNaN(e))throw"NaN in Smooth() input";if("Number"!==m(e))throw"Non-number in Smooth() input";if(!isFinite(e))throw"Infinity in Smooth() input"},E=function(e,t){var r,n,s;if("Array"!==m(e))throw"Non-vector in Smooth() input";if(e.length!==t)throw"Inconsistent dimension in Smooth() input";for(n=0,s=e.length;n<s;n++)r=e[n],A(r)},f=function(e){return"Number"===m(e)&&isFinite(e)&&!isNaN(e)},b=function(e){var t;switch(t="scaleTo param must be number or array of two numbers",m(e)){case"Number":if(!f(e))throw t;e=[0,e];break;case"Array":if(2!==e.length)throw t;if(!f(e[0])||!f(e[1]))throw t;break;default:throw t}return e},w=function(e){var t,r,n;for(r in t={},e)T.call(e,r)&&(n=e[r],t[r]=n);return t},l=function(e,t){var n,o,c,h,u,f,_,x,S,v,C;for(_ in null==t&&(t={}),S={},t=w(t),S.config=w(t),null==t.scaleTo&&(t.scaleTo=t.period),null==t.sincFilterSize&&(t.sincFilterSize=t.lanczosFilterSize),d)T.call(d,_)&&(C=d[_],null==t[_]&&(t[_]=C));if(!(u={nearest:i,linear:s,cubic:r,lanczos:a,sinc:a}[t.method]))throw"Invalid method: "+t.method;if("lanczos"===t.method&&(t.sincWindow=g(t.sincFilterSize)),e.length<2)throw"Array must have at least two elements";for(_ in S.count=e.length,v=function(){var r,n,s,i;switch(m(e[0])){case"Number":if(S.dimension="scalar",l.deepValidation)for(r=0,s=e.length;r<s;r++)x=e[r],A(x);return h=new u(e,t),function(e){return h.interpolate(e)};case"Array":if(S.dimension=o=e[0].length,!o)throw"Vectors must be non-empty";if(l.deepValidation)for(n=0,i=e.length;n<i;n++)C=e[n],E(C,o);return f=function(){var r;for(r=[],c=0;0<=o?c<o:c>o;0<=o?c++:c--)r.push(new u(p(e,c),t));return r}(),function(e){var t,r,n,s;for(s=[],r=0,n=f.length;r<n;r++)t=f[r],s.push(t.interpolate(e));return s};default:throw"Invalid element type: "+m(e[0])}}(),n="periodic"===t.clip?e.length:e.length-1,t.scaleTo||(t.scaleTo=n),S.domain=b(t.scaleTo),v=y(v,n,S.domain),S.domain.sort(),S)T.call(S,_)&&(C=S[_],v[_]=C);return v},n)T.call(n,_)&&(C=n[_],l[_]=C);l.deepValidation=!0,(null!==t?t:window).Smooth=l}).call(this)},660:function(e,t){var r,n,s;n=[t],void 0===(s="function"==typeof(r=function(e){"use strict";function t(e,t,r){for(var n=(e.byteLength,0),s=r.length;s>n;n++){var i=r.charCodeAt(n);if(128>i)e.setUint8(t++,i>>>0&127|0);else if(2048>i)e.setUint8(t++,i>>>6&31|192),e.setUint8(t++,i>>>0&63|128);else if(65536>i)e.setUint8(t++,i>>>12&15|224),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128);else{if(!(1114112>i))throw new Error("bad codepoint "+i);e.setUint8(t++,i>>>18&7|240),e.setUint8(t++,i>>>12&63|128),e.setUint8(t++,i>>>6&63|128),e.setUint8(t++,i>>>0&63|128)}}}function r(e){for(var t=0,r=0,n=e.length;n>r;r++){var s=e.charCodeAt(r);if(128>s)t+=1;else if(2048>s)t+=2;else if(65536>s)t+=3;else{if(!(1114112>s))throw new Error("bad codepoint "+s);t+=4}}return t}function n(e,s,i){var o=typeof e;if("string"===o){if(32>(a=r(e)))return s.setUint8(i,160|a),t(s,i+1,e),1+a;if(256>a)return s.setUint8(i,217),s.setUint8(i+1,a),t(s,i+2,e),2+a;if(65536>a)return s.setUint8(i,218),s.setUint16(i+1,a),t(s,i+3,e),3+a;if(4294967296>a)return s.setUint8(i,219),s.setUint32(i+1,a),t(s,i+5,e),5+a}if(e instanceof Uint8Array){var a=e.byteLength,l=new Uint8Array(s.buffer);if(256>a)return s.setUint8(i,196),s.setUint8(i+1,a),l.set(e,i+2),2+a;if(65536>a)return s.setUint8(i,197),s.setUint16(i+1,a),l.set(e,i+3),3+a;if(4294967296>a)return s.setUint8(i,198),s.setUint32(i+1,a),l.set(e,i+5),5+a}if("number"===o){if(!isFinite(e))throw new Error("Number not finite: "+e);if(Math.floor(e)!==e)return s.setUint8(i,203),s.setFloat64(i+1,e),9;if(e>=0){if(128>e)return s.setUint8(i,e),1;if(256>e)return s.setUint8(i,204),s.setUint8(i+1,e),2;if(65536>e)return s.setUint8(i,205),s.setUint16(i+1,e),3;if(4294967296>e)return s.setUint8(i,206),s.setUint32(i+1,e),5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return s.setInt8(i,e),1;if(e>=-128)return s.setUint8(i,208),s.setInt8(i+1,e),2;if(e>=-32768)return s.setUint8(i,209),s.setInt16(i+1,e),3;if(e>=-2147483648)return s.setUint8(i,210),s.setInt32(i+1,e),5;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if(null===e)return s.setUint8(i,192),1;if("boolean"===o)return s.setUint8(i,e?195:194),1;if("object"===o){var c=0,h=Array.isArray(e);if(h)a=e.length;else{var u=Object.keys(e);a=u.length}if(16>a?(s.setUint8(i,a|(h?144:128)),c=1):65536>a?(s.setUint8(i,h?220:222),s.setUint16(i+1,a),c=3):4294967296>a&&(s.setUint8(i,h?221:223),s.setUint32(i+1,a),c=5),h)for(var d=0;a>d;d++)c+=n(e[d],s,i+c);else for(d=0;a>d;d++){var p=u[d];c+=n(p,s,i+c),c+=n(e[p],s,i+c)}return c}throw new Error("Unknown type "+o)}function s(e){var t=typeof e;if("string"===t){if(32>(n=r(e)))return 1+n;if(256>n)return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if(e instanceof Uint8Array){if(256>(n=e.byteLength))return 2+n;if(65536>n)return 3+n;if(4294967296>n)return 5+n}if("number"===t){if(Math.floor(e)!==e)return 9;if(e>=0){if(128>e)return 1;if(256>e)return 2;if(65536>e)return 3;if(4294967296>e)return 5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1;if(e>=-128)return 2;if(e>=-32768)return 3;if(e>=-2147483648)return 5;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"===t||null===e)return 1;if("object"===t){var n,i=0;if(Array.isArray(e)){n=e.length;for(var o=0;n>o;o++)i+=s(e[o])}else{var a=Object.keys(e);for(n=a.length,o=0;n>o;o++){var l=a[o];i+=s(l)+s(e[l])}}if(16>n)return 1+i;if(65536>n)return 3+i;if(4294967296>n)return 5+i;throw new Error("Array or object too long 0x"+n.toString(16))}throw new Error("Unknown type "+t)}function i(e){var t=new ArrayBuffer(s(e));return n(e,new DataView(t),0),new Uint8Array(t)}function o(e,t,r){return t?new e(t.buffer,t.byteOffset,t.byteLength/(r||1)):void 0}function a(e){return o(DataView,e)}function l(e){return o(Uint8Array,e)}function c(e){return o(Int8Array,e)}function h(e){return o(Int32Array,e,4)}function u(e){return o(Float32Array,e,4)}function d(e,t){var r=e.length/2;t||(t=new Int16Array(r));for(var n=0,s=0;r>n;++n,s+=2)t[n]=e[s]<<8^e[s+1]<<0;return t}function p(e,t){var r=e.length;t||(t=new Uint8Array(2*r));for(var n=a(t),s=0;r>s;++s)n.setInt16(2*s,e[s]);return l(t)}function m(e,t){var r=e.length/4;t||(t=new Int32Array(r));for(var n=0,s=0;r>n;++n,s+=4)t[n]=e[s]<<24^e[s+1]<<16^e[s+2]<<8^e[s+3]<<0;return t}function f(e,t){var r=e.length;t||(t=new Uint8Array(4*r));for(var n=a(t),s=0;r>s;++s)n.setInt32(4*s,e[s]);return l(t)}function _(e,t){var r=e.length;t||(t=new Float32Array(r/4));for(var n=a(t),s=a(e),i=0,o=0,l=r/4;l>i;++i,o+=4)n.setFloat32(o,s.getFloat32(o),!0);return t}function g(e,t,r){var n=e.length,s=1/t;r||(r=new Float32Array(n));for(var i=0;n>i;++i)r[i]=e[i]*s;return r}function y(e,t,r){var n=e.length;r||(r=new Int32Array(n));for(var s=0;n>s;++s)r[s]=Math.round(e[s]*t);return r}function x(e,t){var r,n;if(!t){var s=0;for(r=0,n=e.length;n>r;r+=2)s+=e[r+1];t=new e.constructor(s)}var i=0;for(r=0,n=e.length;n>r;r+=2)for(var o=e[r],a=e[r+1],l=0;a>l;++l)t[i]=o,++i;return t}function b(e){if(0===e.length)return new Int32Array;var t,r,n=2;for(t=1,r=e.length;r>t;++t)e[t-1]!==e[t]&&(n+=2);var s=new Int32Array(n),i=0,o=1;for(t=1,r=e.length;r>t;++t)e[t-1]!==e[t]?(s[i]=e[t-1],s[i+1]=o,o=1,i+=2):++o;return s[i]=e[e.length-1],s[i+1]=o,s}function w(e,t){var r=e.length;t||(t=new e.constructor(r)),r&&(t[0]=e[0]);for(var n=1;r>n;++n)t[n]=e[n]+t[n-1];return t}function S(e,t){var r=e.length;t||(t=new e.constructor(r)),t[0]=e[0];for(var n=1;r>n;++n)t[n]=e[n]-e[n-1];return t}function v(e,t){var r,n,s=e instanceof Int8Array?127:32767,i=-s-1,o=e.length;if(!t){var a=0;for(r=0;o>r;++r)e[r]<s&&e[r]>i&&++a;t=new Int32Array(a)}for(r=0,n=0;o>r;){for(var l=0;e[r]===s||e[r]===i;)l+=e[r],++r;l+=e[r],++r,t[n]=l,++n}return t}function C(e,t){var r,n=t?127:32767,s=-n-1,i=e.length,o=0;for(r=0;i>r;++r)0===(c=e[r])?++o:o+=c===n||c===s?2:c>0?Math.ceil(c/n):Math.ceil(c/s);var a=t?new Int8Array(o):new Int16Array(o),l=0;for(r=0;i>r;++r){var c;if((c=e[r])>=0)for(;c>=n;)a[l]=n,++l,c-=n;else for(;s>=c;)a[l]=s,++l,c-=s;a[l]=c,++l}return a}function A(e,t){return w(x(e),t)}function E(e){return b(S(e))}function T(e,t,r){return g(x(e,h(r)),t,r)}function R(e,t){return b(y(e,t))}function M(e,t,r){return g(w(e,h(r)),t,r)}function P(e,t,r){return S(y(e,t),r)}function N(e,t,r){return g(v(e,h(r)),t,r)}function L(e,t,r){var n=v(e,h(r));return M(n,t,u(n))}function I(e,t,r){return C(P(e,t),r)}function O(e){var t=a(e),r=t.getInt32(0),n=t.getInt32(4),s=e.subarray(8,12);return[r,e=e.subarray(12),n,s]}function V(e,t,r,n){var s=new ArrayBuffer(12+n.byteLength),i=new Uint8Array(s),o=new DataView(s);return o.setInt32(0,e),o.setInt32(4,t),r&&i.set(r,8),i.set(n,12),i}function D(e){return V(2,e.length,void 0,l(e))}function k(e){return V(4,e.length,void 0,f(e))}function z(e,t){return V(5,e.length/t,f([t]),l(e))}function F(e){return V(6,e.length,void 0,f(b(e)))}function B(e){return V(8,e.length,void 0,f(E(e)))}function U(e,t){return V(9,e.length,f([t]),f(R(e,t)))}function G(e,t){return V(10,e.length,f([t]),p(I(e,t)))}function j(e){var t={};return ee.forEach((function(r){void 0!==e[r]&&(t[r]=e[r])})),e.bondAtomList&&(t.bondAtomList=k(e.bondAtomList)),e.bondOrderList&&(t.bondOrderList=D(e.bondOrderList)),t.xCoordList=G(e.xCoordList,1e3),t.yCoordList=G(e.yCoordList,1e3),t.zCoordList=G(e.zCoordList,1e3),e.bFactorList&&(t.bFactorList=G(e.bFactorList,100)),e.atomIdList&&(t.atomIdList=B(e.atomIdList)),e.altLocList&&(t.altLocList=F(e.altLocList)),e.occupancyList&&(t.occupancyList=U(e.occupancyList,100)),t.groupIdList=B(e.groupIdList),t.groupTypeList=k(e.groupTypeList),e.secStructList&&(t.secStructList=D(e.secStructList,1)),e.insCodeList&&(t.insCodeList=F(e.insCodeList)),e.sequenceIndexList&&(t.sequenceIndexList=B(e.sequenceIndexList)),t.chainIdList=z(e.chainIdList,4),e.chainNameList&&(t.chainNameList=z(e.chainNameList,4)),t}function H(e){function t(e){for(var t={},r=0;e>r;r++)t[i()]=i();return t}function r(t){var r=e.subarray(o,o+t);return o+=t,r}function n(t){var r=e.subarray(o,o+t);o+=t;var n=65535;if(t>n){for(var s=[],i=0;i<r.length;i+=n)s.push(String.fromCharCode.apply(null,r.subarray(i,i+n)));return s.join("")}return String.fromCharCode.apply(null,r)}function s(e){for(var t=new Array(e),r=0;e>r;r++)t[r]=i();return t}function i(){var i,l,c=e[o];if(0==(128&c))return o++,c;if(128==(240&c))return o++,t(l=15&c);if(144==(240&c))return o++,s(l=15&c);if(160==(224&c))return o++,n(l=31&c);if(224==(224&c))return i=a.getInt8(o),o++,i;switch(c){case 192:return o++,null;case 194:return o++,!1;case 195:return o++,!0;case 196:return l=a.getUint8(o+1),o+=2,r(l);case 197:return l=a.getUint16(o+1),o+=3,r(l);case 198:return l=a.getUint32(o+1),o+=5,r(l);case 202:return i=a.getFloat32(o+1),o+=5,i;case 203:return i=a.getFloat64(o+1),o+=9,i;case 204:return i=e[o+1],o+=2,i;case 205:return i=a.getUint16(o+1),o+=3,i;case 206:return i=a.getUint32(o+1),o+=5,i;case 208:return i=a.getInt8(o+1),o+=2,i;case 209:return i=a.getInt16(o+1),o+=3,i;case 210:return i=a.getInt32(o+1),o+=5,i;case 217:return l=a.getUint8(o+1),o+=2,n(l);case 218:return l=a.getUint16(o+1),o+=3,n(l);case 219:return l=a.getUint32(o+1),o+=5,n(l);case 220:return l=a.getUint16(o+1),o+=3,s(l);case 221:return l=a.getUint32(o+1),o+=5,s(l);case 222:return l=a.getUint16(o+1),o+=3,t(l);case 223:return l=a.getUint32(o+1),o+=5,t(l)}throw new Error("Unknown type 0x"+c.toString(16))}var o=0,a=new DataView(e.buffer);return i()}function $(e,t,r,n){switch(e){case 1:return _(t);case 2:return c(t);case 3:return d(t);case 4:return m(t);case 5:return l(t);case 6:return x(m(t),new Uint8Array(r));case 7:return x(m(t));case 8:return A(m(t));case 9:return T(m(t),m(n)[0]);case 10:return L(d(t),m(n)[0]);case 11:return g(d(t),m(n)[0]);case 12:return N(d(t),m(n)[0]);case 13:return N(c(t),m(n)[0]);case 14:return v(d(t));case 15:return v(c(t))}}function W(e,t){var r=(t=t||{}).ignoreFields,n={};return re.forEach((function(t){var s=!!r&&-1!==r.indexOf(t),i=e[t];s||void 0===i||(i instanceof Uint8Array?n[t]=$.apply(null,O(i)):n[t]=i)})),n}function Y(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function X(e,t,r){var n,s,i,o,a,l,c=(r=r||{}).firstModelOnly,h=t.onModel,u=t.onChain,d=t.onGroup,p=t.onAtom,m=t.onBond,f=0,_=0,g=0,y=0,x=0,b=-1,w=e.chainNameList,S=e.secStructList,v=e.insCodeList,C=e.sequenceIndexList,A=e.atomIdList,E=e.bFactorList,T=e.altLocList,R=e.occupancyList,M=e.bondAtomList,P=e.bondOrderList;for(n=0,s=e.chainsPerModel.length;s>n&&!(c&&f>0);++n){var N=e.chainsPerModel[f];for(h&&h({chainCount:N,modelIndex:f}),i=0;N>i;++i){var L=e.groupsPerChain[_];if(u){var I=Y(e.chainIdList.subarray(4*_,4*_+4)),O=null;w&&(O=Y(w.subarray(4*_,4*_+4))),u({groupCount:L,chainIndex:_,modelIndex:f,chainId:I,chainName:O})}for(o=0;L>o;++o){var V=e.groupList[e.groupTypeList[g]],D=V.atomNameList.length;if(d){var k=null;S&&(k=S[g]);var z=null;e.insCodeList&&(z=String.fromCharCode(v[g]));var F=null;C&&(F=C[g]),d({atomCount:D,groupIndex:g,chainIndex:_,modelIndex:f,groupId:e.groupIdList[g],groupType:e.groupTypeList[g],groupName:V.groupName,singleLetterCode:V.singleLetterCode,chemCompType:V.chemCompType,secStruct:k,insCode:z,sequenceIndex:F})}for(a=0;D>a;++a){if(p){var B=null;A&&(B=A[y]);var U=null;E&&(U=E[y]);var G=null;T&&(G=String.fromCharCode(T[y]));var j=null;R&&(j=R[y]),p({atomIndex:y,groupIndex:g,chainIndex:_,modelIndex:f,atomId:B,element:V.elementList[a],atomName:V.atomNameList[a],formalCharge:V.formalChargeList[a],xCoord:e.xCoordList[y],yCoord:e.yCoordList[y],zCoord:e.zCoordList[y],bFactor:U,altLoc:G,occupancy:j})}y+=1}if(m){var H=V.bondAtomList;for(a=0,l=V.bondOrderList.length;l>a;++a)m({atomIndex1:y-D+H[2*a],atomIndex2:y-D+H[2*a+1],bondOrder:V.bondOrderList[a]})}g+=1}_+=1}if(x=b+1,b=y-1,m&&M)for(a=0,l=M.length;l>a;a+=2){var $=M[a],W=M[a+1];($>=x&&b>=$||W>=x&&b>=W)&&m({atomIndex1:$,atomIndex2:W,bondOrder:P?P[a/2]:null})}f+=1}}function q(e){return i(j(e))}function Z(e,t){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),W(e instanceof Uint8Array?H(e):e,t)}function K(e,t,r,n){function s(){try{var e=Z(i.response);r(e)}catch(e){n(e)}}var i=new XMLHttpRequest;i.addEventListener("load",s,!0),i.addEventListener("error",n,!0),i.responseType="arraybuffer",i.open("GET",t+e.toUpperCase()),i.send()}function Q(e,t,r){K(e,ie,t,r)}function J(e,t,r){K(e,oe,t,r)}var ee=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],te=["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],re=ee.concat(te),ne="v1.1.0dev",se="//mmtf.rcsb.org/v1.0/",ie=se+"full/",oe=se+"reduced/";e.encode=q,e.decode=Z,e.traverse=X,e.fetch=Q,e.fetchReduced=J,e.version=ne,e.fetchUrl=ie,e.fetchReducedUrl=oe,e.encodeMsgpack=i,e.encodeMmtf=j,e.decodeMsgpack=H,e.decodeMmtf=W})?r.apply(t,n):r)||(e.exports=s)},535:t=>{"use strict";t.exports=e},698:e=>{"use strict";e.exports=t}},n={};function s(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={exports:{}};return r[e].call(i.exports,i,i.exports,s),i.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i={};return(()=>{"use strict";s.d(i,{default:()=>Mu});var e=s(535),t=s.n(e),r=s(698),n=function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},n.apply(this,arguments)},o={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",fadeColor:"transparent",animation:"spinner-line-fade-default",rotate:0,direction:1,speed:1,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:"0 0 1px transparent",position:"absolute"},a=function(){function e(e){void 0===e&&(e={}),this.opts=n(n({},o),e)}return e.prototype.spin=function(e){return this.stop(),this.el=document.createElement("div"),this.el.className=this.opts.className,this.el.setAttribute("role","progressbar"),this.el.style.position=this.opts.position,this.el.style.width="0",this.el.style.zIndex=this.opts.zIndex.toString(),this.el.style.left=this.opts.left,this.el.style.top=this.opts.top,this.el.style.transform="scale(".concat(this.opts.scale,")"),e&&e.insertBefore(this.el,e.firstChild||null),function(e,t){var r=Math.round(t.corners*t.width*500)/1e3+"px",n="none";!0===t.shadow?n="0 2px 4px #000":"string"==typeof t.shadow&&(n=t.shadow);for(var s=function(e){for(var t=/^\s*([a-zA-Z]+\s+)?(-?\d+(\.\d+)?)([a-zA-Z]*)\s+(-?\d+(\.\d+)?)([a-zA-Z]*)(.*)$/,r=[],n=0,s=e.split(",");n<s.length;n++){var i=s[n].match(t);if(null!==i){var o=+i[2],a=+i[5],l=i[4],c=i[7];0!==o||l||(l=c),0!==a||c||(c=l),l===c&&r.push({prefix:i[1]||"",x:o,y:a,xUnits:l,yUnits:c,end:i[8]})}}return r}(n),i=0;i<t.lines;i++){var o=~~(360/t.lines*i+t.rotate),a=document.createElement("div");a.style.position="absolute",a.style.top="".concat(-t.width/2,"px"),a.style.width=t.length+t.width+"px",a.style.height=t.width+"px",a.style.background=l(t.fadeColor,i),a.style.borderRadius=r,a.style.transformOrigin="left",a.style.transform="rotate(".concat(o,"deg) translateX(").concat(t.radius,"px)");var h=i*t.direction/t.lines/t.speed;h-=1/t.speed;var u=document.createElement("div");u.style.width="100%",u.style.height="100%",u.style.background=l(t.color,i),u.style.borderRadius=r,u.style.boxShadow=c(s,o),u.style.animation="".concat(1/t.speed,"s linear ").concat(h,"s infinite ").concat(t.animation),a.appendChild(u),e.appendChild(a)}}(this.el,this.opts),this},e.prototype.stop=function(){return this.el&&(this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=void 0),this},e}();function l(e,t){return"string"==typeof e?e:e[t%e.length]}function c(e,t){for(var r=[],n=0,s=e;n<s.length;n++){var i=s[n],o=h(i.x,i.y,t);r.push(i.prefix+o[0]+i.xUnits+" "+o[1]+i.yUnits+i.end)}return r.join(", ")}function h(e,t,r){var n=r*Math.PI/180,s=Math.sin(n),i=Math.cos(n);return[Math.round(1e3*(e*i+t*s))/1e3,Math.round(1e3*(-e*s+t*i))/1e3]}class u{constructor(){this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=u.now(),this.oldTime=this.startTime,this.running=!0}stop(){this.getElapsedTime(),this.running=!1}getElapsedTime(){return this.update(),this.elapsedTime}update(){let e=0;if(this.running){const t=u.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}u.now=function(){const e="undefined"!=typeof window&&window.performance;return e&&e.now?e.now.bind(e):Date.now}();const{now:d}=u;function p(e,t,r){const n=document.createElement(e);return n.id=t,n.style.cssText=r,n}const m=class{constructor(){this.domElement=p("div","stats","padding:8px"),this._text=p("p","fps","margin:0;color:silver;font-size:large"),this.domElement.appendChild(this._text),this._startTime=d(),this._prevTime=this._startTime,this._deltas=new Array(20),this._index=0,this._total=0,this._count=0}end(){const e=d(),t=e-this._startTime;return this._count<this._deltas.length?this._count++:this._total-=this._deltas[this._index],this._total+=t,this._deltas[this._index]=t,this._index=(this._index+1)%this._deltas.length,this.ms=this._total/this._count,this.fps=1e3/this.ms,e>this._prevTime+1e3&&(this._text.textContent=this.fps.toPrecision(2),this._prevTime=e),e}update(){this._startTime=this.end()}show(e){void 0===e&&(e=!0),this.domElement.style.display=e?"block":"none"}};function f(e,t){return!e||e===t}function _(){this._handlers={}}_.prototype.addEventListener=function(e,r,n){let s=this._handlers[e];s||(this._handlers[e]=[],s=this._handlers[e]);const i=[r,n];void 0===t().find(s,(function(e){return e[0]===i[0]&&e[1]===i[1]}))&&s.push(i)},_.prototype.removeEventListener=function(e,r,n){const s=this;t().forEach(s._handlers,((i,o)=>{t().remove(i,(t=>f(e,o)&&f(r,t[0])&&f(n,t[1]||s)))})),this._handlers=t().omitBy(s._handlers,(e=>0===e.length))},_.prototype.dispatchEvent=function(e){const r=this;t().forEach(this._handlers[e.type],(t=>{const n=t[1]||r;t[0].apply(n,[e])}))};const g=_,y={debug:0,info:1,report:2,warn:3,error:4};function x(){g.call(this),this.console=!1,this._priority=y.warn}function b(e){if(!t().isNumber(e))throw new Error("Wrong log level specified!");return e}x.prototype=Object.create(g.prototype),x.prototype.constructor=x,x.prototype.instantiate=function(){return new x},Object.defineProperty(x.prototype,"level",{get(){return t().findKey(y,(e=>e===this._priority))},set(e){this._priority=b(y[e])}}),x.prototype.levels=function(){return Object.keys(y)},x.prototype.message=function(e,t){const r=b(y[e]);this._message(r,t)},x.prototype.debug=function(e){this._message(y.debug,e)},x.prototype.info=function(e){this._message(y.info,e)},x.prototype.report=function(e){this._message(y.report,e)},x.prototype.warn=function(e){this._message(y.warn,e)},x.prototype.error=function(e){this._message(y.error,e)},x.prototype._message=function(e,r){if(e<this._priority)return;const n=t().findKey(y,(t=>t===e));if(r=String(r),this.console){}this.dispatchEvent({type:"message",level:n,message:r})};const w=new x,S={DEFAULT:0,SAFARI:1};function v(e){return decodeURIComponent(e.replace(/\+/g," "))}function C(e){const t=(e=e||window.location.search).substring(e.indexOf("?")+1),r=/([^&=]+)=?([^&]*)/g,n=[];let s;for(;null!==(s=r.exec(t));)n.push([v(s[1]),v(s[2])]);return n}function A(e){let t=!1;this.enable=function(e){t=e};let r=0;const n=Object.keys(e);function s(e,n){return function(){const s=A.spaces.substr(0,2*r);t&&w.debug(`${s+n} {`),r++;for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];const l=e.apply(this,o);return r--,t&&w.debug(`${s}} // ${n}`),l}}for(let t=0,r=n.length;t<r;++t){const r=n[t],i=e[r];i instanceof Function&&"constructor"!==r&&(e[r]=s(i,r))}}A.spaces="                                                                                          ";class E extends Error{constructor(e){super(),this.name="OutOfMemoryError",this.message=e}}function T(e){const t=new Uint8Array(e);let r="";for(let e=0;e<t.byteLength;e++)r+=String.fromCharCode(t[e]);return window.btoa(r)}function R(e){const t=window.atob(e),r=new Uint8Array(t.length);for(let e=0;e<r.length;++e)r[e]=t[e].charCodeAt(0);return r.buffer}function M(e){if(t().isPlainObject(e))return!0;const r=e&&Object.getPrototypeOf(e);return!!r&&!r.hasOwnProperty("constructor")&&M(r)}function P(e){return e.slice(Math.max(0,e.lastIndexOf("."))||1/0)}function N(e){const t=e.split(/[:;,]/),r=t.length;return r>=3&&"base64"===t[r-2]?new Blob([R(t[r-1])]):null}const L=/^[a-zA-Z0-9_]*$/,I=['"',"",'"'];const O={browserType:S,encodeQueryComponent:function(e,t){return encodeURIComponent(e).replace(t,(e=>String.fromCharCode(parseInt(e.substr(1),16)))).replace(/%20/g,"+")},decodeQueryComponent:v,getUrlParameters:C,getUrlParametersAsDict:function(e){const t={},r=C(e);for(let e=0;e<r.length;++e){const[n,s]=r[e];t[n]=s}return t},resolveURL:function(e){if("undefined"!=typeof URL)try{return"undefined"!=typeof window?new URL(e,window.location).href:new URL(e).href}catch(e){}if("undefined"!=typeof document){const t=document.createElement("a");return t.href=e,t.href}return e},generateRegExp:function(e){const t=[];for(let r=0,n=e.length;r<n;++r)t[t.length]=e[r].charCodeAt(0).toString(16);const r=t.join("|");return new RegExp(`%(?:${r})`,"gi")},createElement:function(e,t,r){const n=document.createElement(e);let s,i;if(t){const e=Object.keys(t);for(s=0,i=e.length;s<i;++s){const r=e[s];n.setAttribute(r,t[r])}}if(r)for(r instanceof Array||(r=[r]),s=0,i=r.length;s<i;++s){const e=r[s];"string"==typeof e?n.appendChild(document.createTextNode(e)):e instanceof HTMLElement&&n.appendChild(e)}return n},deriveClass:function(e,r,n,s){return e.prototype=t().assign(Object.create(r.prototype),{constructor:e},n),s&&t().assign(e,s),e},deriveDeep:function e(t,r){let n,s,i=t;if(t instanceof Array)for(i=new Array(t.length),n=0,s=t.length;n<s;++n)i[n]=e(t[n]);else if(t instanceof Object){i=Object.create(t);const o=Object.keys(t);for(n=0,s=o.length;n<s;++n){const r=o[n],s=t[r],a=e(s);a!==s&&(i[r]=a)}r&&Object.keys(i).length>0&&(i=Object.create(i))}return i},hexColor:function(e){return`#${`0000000${e.toString(16)}`.substr(-6)}`},DebugTracer:A,OutOfMemoryError:E,allocateTyped:function(e,t){let r=null;try{r=new e(t)}catch(e){throw e instanceof RangeError?new E(e.message):e}return r},bytesFromBase64:R,bytesToBase64:T,arrayFromBase64:function(e,t){return Array.prototype.slice.call(new t(R(e)))},arrayToBase64:function(e,t){return T(new t(e).buffer)},compareOptionsWithDefaults:function(e,t){const r=[];if(t&&e){const n=Object.keys(e);for(let s=0;s<n.length;++s){const i=n[s],o=e[i];o instanceof Object||void 0===t[i]||t[i]===o||r.push(`${i}:${o}`)}if(r.length>0)return`!${r.join()}`}return""},objectsDiff:function e(r,n){const s={};return t().forIn(r,((r,i)=>{const o=n[i];if(M(r)&&M(o)){const n=e(r,o);t().isEmpty(n)||(s[i]=n)}else t().isEqual(r,o)||(s[i]=r)})),s},forInRecursive:function(e,r){!function e(n,s){t().forIn(n,((t,n)=>{const i=s+(s.length>0?".":"");t instanceof Object?e(t,i+n):void 0!==t&&r(t,i+n)}))}(e,"")},enquoteString:function(e){return t().isString(e)?`"${e.replace(/"/g,'\\"')}"`:e},unquoteString:function(e){if(!t().isString(e))return e;if('"'===e[0]&&'"'===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\"/g,'"');if("'"===e[0]&&"'"===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\'/g,"'");throw new SyntaxError("Incorrect string format, can't unqute it")},getBrowser:function(){return navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&-1===navigator.userAgent.indexOf("CriOS")&&-1===navigator.userAgent.indexOf("FxiOS")?S.SAFARI:S.DEFAULT},shotOpen:function(e){"undefined"!=typeof window&&window.open().document.write(`<body style="margin:0"><img src="${e}" /></body>`)},shotDownload:function(e,t){if(e&&"data:"===e.substr(0,5))if(t||(t=["screenshot-",+new Date,".png"].join("")),"undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(N(e),t);else if("undefined"!=typeof document){const r=document.createElement("a");r.download=t,r.innerHTML="download",r.href=window.URL.createObjectURL(N(e)),document.body.appendChild(r),r.click(),document.body.removeChild(r)}},copySubArrays:function(e,t,r,n){for(let s=0,i=r.length;s<i;++s)for(let i=0;i<n;++i)t[s*n+i]=e[r[s]*n+i]},shallowCloneNode:function(e){const t=e.cloneNode(!0);return t.worldPos=e.worldPos,t},correctSelectorIdentifier:function(e){return L.test(e)?e:(I[1]=e,I.join(""))},getFileExtension:P,splitFileName:function(e){const t=P(e);return[e.slice(0,e.length-t.length),t]},download:function(e,t,r){const n=new Blob([e]);if(t||(t=["data",+new Date].join("")),t+=r?`.${r}`:n.type||".bin","undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(n,t);else if("undefined"!=typeof document){const e=document.createElement("a");e.download=t,e.innerHTML="download",e.href=window.URL.createObjectURL(n),document.body.appendChild(e),e.click(),document.body.removeChild(e)}},concatTypedArraysUnsafe:function(e,t){const r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},mergeTypedArraysUnsafe:function(e){if(e.length<=0)return null;const t=e.reduce(((e,t)=>e+t.length),0),r=new e[0].constructor(t);for(let t=0,n=0;t<e.length;t++){const s=e[t].length;r.set(e[t],n),n+=s}return r}};class V extends g{constructor(){super(),this._shouldCancel=!1}cancel(){this._shouldCancel=!0,this.dispatchEvent({type:"cancel"})}shouldCancel(){return this._shouldCancel}notify(e){this.dispatchEvent({type:"notification",slaveEvent:e})}}const D={modes:{BS:{atom:.23,bond:.15,space:.5,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},VW:{polyComplexity:{poor:4,low:6,medium:8,high:16,ultra:32}},LN:{multibond:!0,showarom:!0,offsarom:.2,chunkarom:10,atom:.23,lineWidth:2},LC:{bond:.2,space:0,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},SA:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},SE:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},QS:{isoValue:.5,gaussLim:{poor:1.5,low:2,medium:2.5,high:3,ultra:4},scale:1,wireframe:!1,gridSpacing:{poor:2,low:1.5,medium:1,high:.5,ultra:.25},subset:"",zClip:!1},CS:{probeRadius:1.4,isoValue:1.5,wireframe:!1,probePositions:30,polyComplexity:{poor:.5,low:1,medium:1.5,high:1.75,ultra:2},subset:"",zClip:!1},TR:{radius:.3,polyComplexity:{poor:12,low:16,medium:32,high:64,ultra:64}},TU:{radius:.3,heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},CA:{radius:.3,depth:.25,ss:{helix:{width:1,arrow:2},strand:{width:1,arrow:2}},heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},TX:{template:"{{Chain}}.{{Residue}}{{Sequence}}.{{Name}}",horizontalAlign:"center",verticalAlign:"middle",dx:0,dy:0,dz:1,fg:"none",bg:"0x202020",showBg:!0},VD:{kSigma:1,kSigmaMed:2,kSigmaMax:4,frame:!0,isoMode:!1,polyComplexity:{poor:2,low:3,medium:4,high:8,ultra:10}}},colorers:{EL:{carbon:-1},UN:{color:16777215},CO:{subset:"charged",color:16711680,baseColor:16777215},CB:{color:9474192,factor:.6},SQ:{gradient:"rainbow"},TM:{gradient:"temp",min:5,max:40},OC:{gradient:"reds"},HY:{gradient:"blue-red"},MO:{gradient:"rainbow"}},antialias:!0,camFov:45,camNear:.5,camFar:100,camDistance:2.5,radiusToFit:1,fogNearFactor:.5,fogFarFactor:1,fogAlpha:1,fogColor:0,fogColorEnable:!1,palette:"JM",resolution:"medium",autoResolution:!1,autoPreset:!0,preset:"default",presets:{default:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],empty:[],wire:[{mode:"LN",colorer:"EL",selector:"all",material:"SF"}],small:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],macro:[{mode:"CA",colorer:"SS",selector:"not hetatm",material:"SF"},{mode:"BS",colorer:"EL",selector:"hetatm and not water",material:"SF"}]},objects:{line:{color:4294967295,dashSize:.3,gapSize:.05}},bg:{color:2105376,transparent:!1},draft:{clipPlane:!1,clipPlaneFactor:.5,clipPlaneSpeed:3e-5},plugins:{},axes:!0,fog:!0,fps:!0,zSprites:!0,isoSurfaceFakeOpacity:!0,suspendRender:!0,nowater:!1,autobuild:!0,fxaa:!0,outline:{on:!1,color:0,threshold:.1,thickness:1},ao:!1,shadow:{on:!1,type:"random",radius:1},autoRotation:0,maxfps:30,fbxprec:4,autoRotationAxisFixed:!0,zooming:!0,picking:!0,pick:"atom",editing:!1,aromatic:!1,singleUnit:!0,stereo:"NONE",interpolateViews:!0,transparency:"prepass",translationSpeed:2,debug:{example:3.5,text:"hello!",good:!0,ssaoKernelRadius:.7,ssaoFactor:.7,stereoBarrel:.25},use:{multiFile:!1}};function k(){g.call(this),this.old=null,this.now={},this._changed={},this.reset()}O.deriveClass(k,g,{defaults:D,set(e,r){if(t().isString(e)){t().get(this.now,e)!==r&&(t().set(this.now,e,r),this._notifyChange(e,r))}else{const r=O.objectsDiff(e,this.now);t().isEmpty(r)||(t().merge(this.now,r),this._notifyChanges(r))}},get(e,r){return t().get(this.now,e,r)},reset(){const e=O.objectsDiff(D,this.now);this.now=t().cloneDeep(D),this.old=null,this._notifyChanges(e),this._changed={}},checkpoint(){this.old=t().cloneDeep(this.now),this._changed={}},_notifyChange(e,t){this._changed[e]=!0,this.dispatchEvent({type:`change:${e}`,value:t})},_notifyChanges(e){O.forInRecursive(e,((e,t)=>{this._notifyChange(t,e)}))},changed(){if(!this.old)return[];const{old:e,now:r}=this;return t().filter(Object.keys(this._changed),(n=>t().get(e,n)!==t().get(r,n)))},applyDiffs(e){if(e.hasOwnProperty("VERSION")&&0!==e.VERSION)throw new Error("Settings version does not match!");delete e.VERSION,this.reset(),this.set(e)},getDiffs(e){const t=O.objectsDiff(this.now,D);return e&&(t.VERSION=0),t},setPluginOpts(e,r){D.plugins[e]=t().cloneDeep(r),this.now.plugins[e]=t().cloneDeep(r)}});const z=new k;let F=0;function B(e){return!(!e||"0"===e||t().isString(e)&&"false"===e.toLowerCase())}const U={string:String,number:Number,boolean:B},G="!",j=":",H=",",$="$;@/?";const W=O.generateRegExp($+":,");function Y(e){return O.encodeQueryComponent(e,W)}const X=O.generateRegExp($+" ");function q(e){return O.encodeQueryComponent(e,X)}function Z(e){let{reps:t}=e;if(!t){const{presets:r}=z.now;let n=e.preset||z.now.preset;t=r[n],t||(w.warn(`Unknown preset "${n}"`),[n]=Object.keys(r),t=r[n]),e.preset=n,e.reps=O.deriveDeep(t,!0)}}function K(e,t,r){Z(e);const n=e.reps[F];n.hasOwnProperty(t)&&(F=e.reps.length,e.reps[F]=O.deriveDeep(n,!0)),void 0!==r&&(e.reps[F][t]=r)}function Q(e,r,n){if(e){const s=e.indexOf(G),i=function(e,t){const r=e.indexOf(",");return r>=0?(t.push(e.substr(r+1).split(",")),e.substr(0,r)):e}(e.substr(0,s>=0?s:void 0),n);if(s>=0){const n=e.substr(s+1).split(H);if(e=i,r){const s=r[e],i=O.deriveDeep(s,!0);n.forEach((r=>{const n=r.split(j,2),o=decodeURIComponent(n[0]),a=decodeURIComponent(n[1]),l=U[typeof t().get(s,o)];l?t().set(i,o,l(a)):w.warn(`Unknown argument "${o}" for option "${e}"`)})),Object.keys(i).length>0&&(e=[e,i])}}else e=i}return e}const J={l:"load",load:String,t:"type",type:String,v:"view",view:String,u:"unit",unit:Number,menu:B,o:"object",object(e,t){const r=[];let n=Q(e,z.defaults.objects,r);Array.isArray(n)||(n=[n]),function(e,t,r){void 0===e._objects&&(e._objects=[]);const[n,s]=r,i={type:n,params:t};void 0!==s&&(i.opts=s),e._objects[e._objects.length]=i}(t,r[0],n)},p:"preset",preset(e,t){t.preset=e,t.reps=null,Z(t)},r:"rep",rep(e,t){Z(t),F=Number(e),F=F<=t.reps.length?F<0?0:F:t.reps.length,F===t.reps.length&&(t.reps[F]=F>0?O.deriveDeep(t.reps[F-1],!0):O.deriveDeep(z.defaults.presets.default[0],!0))},s:"select",select(e,t){K(t,"selector",e)},m:"mode",mode(e,t){K(t,"mode",Q(e,z.defaults.modes))},c:"color",color(e,t){K(t,"colorer",Q(e,z.defaults.colorers))},mt:"material",material(e,t){K(t,"material",Q(e,z.defaults.materials))},dup(e,t){Z(t);const{reps:r}=t,n=r[F];F=r.length,r[F]=O.deriveDeep(n,!0)},ar:"autoResolution"};function ee(e){F=0;const r={};for(let n=0,s=e.length;n<s;++n){const s=e[n];let i=s[0];const o=s[1];let a=J[i];for(;t().isString(a);)i=a,a=J[i];if(a){if(t().isFunction(a)){const e=a(o,r);void 0!==e&&(r[i]=e)}}else{const e=U[typeof t().get(z.defaults,i)];e?t().set(r,`settings.${i}`,e(o)):w.warn(`Unknown option "${i}"`)}}return r}function te(e){const t=[];let r=0;return O.forInRecursive(e,((e,n)=>{t[r++]=q(n)+j+q(e)})),t.join(H)}function re(e){return t().isArray(e)?e.length<2?e[0]:`${e[0]}${G}${te(e[1])}`:e}function ne(e){if(!e||!e.type)return;let r=e.type;return t().isArray(e.params)&&e.params.length>0&&(r+=`,${e.params.join(",")}`),e.opts&&(r+=G+te(e.opts)),r}function se(e){const t=[];let r=0;return O.forInRecursive(e,((e,n)=>{t[r++]=`${n}=${O.enquoteString(e)}`})),t.join(" ")}function ie(e){return t().isArray(e)?e.length<2?e[0]:`${e[0]} ${se(e[1])}`:e}function oe(e){if(!e||!e.type)return;let r=e.type;return t().isArray(e.params)&&e.params.length>0&&(r+=` ${e.params.map(O.enquoteString).join(" ")}`),e.opts&&(r+=` ${se(e.opts)}`),r}function ae(e,r){const n=[];let s=0;function i(e,t){null!=t&&(n[s++]=e+t)}return t().isEmpty(e)?null:(i("",r),i("s=",O.enquoteString(e.selector)),i("m=",ie(e.mode)),i("c=",ie(e.colorer)),i("mt=",ie(e.material)),n.join(" "))}const le={fromURL:function(e){return ee(O.getUrlParameters(e))},fromAttr:function(e){return ee(O.getUrlParameters(`?${e||""}`))},adapters:U,toURL:function(e){const r=[];let n=0;function s(e,t){null!=t&&(r[n++]=Y(e)+"="+Y(t))}s("l",e.load),s("u",e.unit),s("p",e.preset),function(e){if(e)for(let r=0,n=e.length;r<n;++r)t().isEmpty(e[r])||(s("r",r),s("s",e[r].selector),s("m",re(e[r].mode)),s("c",re(e[r].colorer)),s("mt",re(e[r].material)))}(e.reps),function(e){if(e)for(let t=0,r=e.length;t<r;++t)s("o",ne(e[t]))}(e._objects),s("v",e.view),O.forInRecursive(e.settings,((e,t)=>{"preset"!==t&&s(t,e)}));let i="";if("undefined"!=typeof window){const{location:e}=window;i=`${e.protocol}//${e.host}${e.pathname}`}return r.length>0&&(i+=`?${r.join("&")}`),i},toScript:function(e){const t=[];let r=0;function n(e,n,s){if(null!=n){const i="string"==typeof n&&s?'"':"";t[r++]=`${e} ${i}${n}${i}`.trim()}}return n("set","autobuild false"),n("load",e.load,!0),n("unit",e.unit),n("preset",e.preset),function(e){if(e)for(let t=0,r=e.length;t<r;++t)n("rep",ae(e[t],t))}(e.reps),function(e){if(e)for(let t=0,r=e.length;t<r;++t)n("",oe(e[t]))}(e._objects),O.forInRecursive(e.settings,((e,t)=>{"preset"!==t&&n(`set ${t}`,e,!0)})),n("view",e.view),n("set","autobuild true"),t.join("\n")}};class ce{constructor(e,t,r,n,s,i,o,a,l,c,h){this.index=-1,this.residue=e,this.name=t,this.element=r,this.position=n,this.role=s,this.mask=1,this.het=i,this.serial=o,this.location=(a||" ").charCodeAt(0),this.occupancy=l||1,this.temperature=c,this.charge=h,this.hydrogenCount=-1,this.radicalCount=0,this.valence=-1,this.bonds=[],this.flags=0,"H"===r.name?this.flags|=ce.Flags.HYDROGEN:"C"===r.name&&(this.flags|=ce.Flags.CARBON)}isHet(){return this.het}isHydrogen(){return 1===this.element.number}getVisualName(){const{name:e}=this;return e.length>0?e:this.element.name.trim()}forEachBond(e){const{bonds:t}=this;for(let r=0,n=t.length;r<n;++r)e(t[r])}getFullName(){let e="";return null!==this.residue&&(null!==this.residue._chain&&(e+=`${this.residue._chain.getName()}.`),e+=`${this.residue._sequence}.`),e+=this.name,e}static Flags={CARBON:1,HYDROGEN:8,NONPOLARH:4104}}const he=ce;class ue{constructor(e,t,r,n,s,i,o){this.number=e,this.name=t,this.fullName=r,this.weight=n,this.radius=s,this.radiusBonding=i,this.hydrogenValency=o}static Constants={U1:1,Lead:2,U2:3,Wing:4,U18:18};static Role=(()=>({N:ue.Constants.U1,CA:ue.Constants.Lead,C:ue.Constants.U2,O:ue.Constants.Wing,SG:ue.Constants.U18}))();static ByAtomicNumber=(()=>[null,new ue(1,"H","Hydrogen",1.008,1.2,.23,[1]),new ue(2,"HE","Helium",4.003,1.4,.93,[0]),new ue(3,"LI","Lithium",6.941,1.82,.68,[1]),new ue(4,"BE","Beryllium",9.012,1.7,.35,[2]),new ue(5,"B","Boron",10.81,2.08,.83,[3]),new ue(6,"C","Carbon",12.011,1.95,.68,[4]),new ue(7,"N","Nitrogen",14.007,1.85,.68,[3,5]),new ue(8,"O","Oxygen",15.999,1.7,.68,[2,4]),new ue(9,"F","Fluorine",18.998,1.73,.64,[1]),new ue(10,"NE","Neon",20.18,1.54,1.12,[0]),new ue(11,"NA","Sodium",22.99,2.27,.97,[1]),new ue(12,"MG","Magnesium",24.305,1.73,1.1,[2]),new ue(13,"AL","Aluminum",26.981,2.05,1.35,[3]),new ue(14,"SI","Silicon",28.086,2.1,1.2,[4]),new ue(15,"P","Phosphorus",30.974,2.08,.75,[3,5]),new ue(16,"S","Sulfur",32.07,2,1.02,[2,4,6]),new ue(17,"CL","Chlorine",35.453,1.97,.99,[1,3,5,7]),new ue(18,"AR","Argon",39.948,1.88,1.57,[0]),new ue(19,"K","Potassium",39.1,2.75,1.33,[1]),new ue(20,"CA","Calcium",40.08,1.973,.99,[2]),new ue(21,"SC","Scandium",44.956,1.7,1.44,[0]),new ue(22,"TI","Titanium",47.88,1.7,1.47,[0]),new ue(23,"V","Vanadium",50.941,1.7,1.33,[0]),new ue(24,"CR","Chromium",52,1.7,1.35,[0]),new ue(25,"MN","Manganese",54.938,1.7,1.35,[0]),new ue(26,"FE","Iron",55.847,1.7,1.34,[0]),new ue(27,"CO","Cobalt",58.93,1.7,1.33,[0]),new ue(28,"NI","Nickel",58.69,1.63,1.5,[0]),new ue(29,"CU","Copper",63.55,1.4,1.52,[0]),new ue(30,"ZN","Zinc",65.39,1.39,1.45,[0]),new ue(31,"GA","Gallium",69.72,1.87,1.22,[3]),new ue(32,"GE","Germanium",72.61,1.7,1.17,[4]),new ue(33,"AS","Arsenic",74.92,1.85,1.21,[3,5]),new ue(34,"SE","Selenium",78.96,1.9,1.22,[2,4,6]),new ue(35,"BR","Bromine",79.9,2.1,1.21,[1,3,5,7]),new ue(36,"KR","Krypton",83.8,2.02,1.91,[0]),new ue(37,"RB","Rubidium",85.47,1.7,1.47,[1]),new ue(38,"SR","Strontium",87.62,1.7,1.12,[2]),new ue(39,"Y","Yttrium",88.91,1.7,1.78,[0]),new ue(40,"ZR","Zirconium",91.22,1.7,1.56,[0]),new ue(41,"NB","Niobium",92.91,1.7,1.48,[0]),new ue(42,"MO","Molybdenum",95.94,1.7,1.47,[0]),new ue(43,"TC","Technetium",98.91,1.7,1.35,[0]),new ue(44,"RU","Ruthenium",101.07,1.7,1.4,[0]),new ue(45,"RH","Rhodium",102.91,1.7,1.45,[0]),new ue(46,"PD","Palladium",106.42,1.63,1.5,[0]),new ue(47,"AG","Silver",107.87,1.72,1.59,[0]),new ue(48,"CD","Cadmium",112.41,1.58,1.69,[0]),new ue(49,"IN","Indium",114.82,1.93,1.63,[3]),new ue(50,"SN","Tin",118.71,2.17,1.46,[2,4]),new ue(51,"SB","Antimony",121.75,2.2,1.46,[3,5]),new ue(52,"TE","Tellurium",127.6,2.06,1.47,[2,4,6]),new ue(53,"I","Iodine",126.91,2.15,1.4,[1,3,5,7]),new ue(54,"XE","Xenon",131.29,2.16,1.98,[0]),new ue(55,"CS","Cesium",132.91,1.7,1.67,[1]),new ue(56,"BA","Barium",137.33,1.7,1.34,[2]),new ue(57,"LA","Lanthanum",138.91,1.7,1.87,[0]),new ue(58,"CE","Cerium",140.12,1.7,1.83,[0]),new ue(59,"PR","Praseodymium",140.91,1.7,1.82,[0]),new ue(60,"ND","Neodymium",144.24,1.7,1.81,[0]),new ue(61,"PM","Promethium",144.9,1.7,1.8,[0]),new ue(62,"SM","Samarium",150.36,1.7,1.8,[0]),new ue(63,"EU","Europium",151.96,1.7,1.99,[0]),new ue(64,"GD","Gadolinium",157.25,1.7,1.79,[0]),new ue(65,"TB","Terbium",158.93,1.7,1.76,[0]),new ue(66,"DY","Dysprosium",162.5,1.7,1.75,[0]),new ue(67,"HO","Holmium",164.93,1.7,1.74,[0]),new ue(68,"ER","Erbium",167.26,1.7,1.73,[0]),new ue(69,"TM","Thulium",168.93,1.7,1.72,[0]),new ue(70,"YB","Ytterbium",173.04,1.7,1.94,[0]),new ue(71,"LU","Lutetium",174.97,1.7,1.72,[0]),new ue(72,"HF","Hafnium",178.49,1.7,1.57,[0]),new ue(73,"TA","Tantalum",180.95,1.7,1.43,[0]),new ue(74,"W","Tungsten",183.85,1.7,1.37,[0]),new ue(75,"RE","Rhenium",186.21,1.7,1.35,[0]),new ue(76,"OS","Osmium",190.2,1.7,1.37,[0]),new ue(77,"IR","Iridium",192.22,1.7,1.32,[0]),new ue(78,"PT","Platinum",195.08,1.72,1.5,[0]),new ue(79,"AU","Gold",196.97,1.66,1.5,[0]),new ue(80,"HG","Mercury",200.59,1.55,1.7,[0]),new ue(81,"TL","Thallium",204.38,1.96,1.55,[1,3]),new ue(82,"PB","Lead",207.2,2.02,1.54,[2,4]),new ue(83,"BI","Bismuth",208.98,1.7,1.54,[3,5]),new ue(84,"PO","Polonium",210,1.7,1.68,[2,4,6]),new ue(85,"AT","Astatine",210,1.7,1.7,[1,3,5,7]),new ue(86,"RN","Radon",222,1.7,2.4,[0]),new ue(87,"FR","Francium",223,1.7,2,[1]),new ue(88,"RA","Radium",226.03,1.7,1.9,[2]),new ue(89,"AC","Actinium",227.03,1.7,1.88,[0]),new ue(90,"TH","Thorium",232.04,1.7,1.79,[0]),new ue(91,"PA","Protactinium",231.04,1.7,1.61,[0]),new ue(92,"U","Uranium",238.03,1.86,1.58,[0]),new ue(93,"NP","Neptunium",237.05,1.7,1.55,[0]),new ue(94,"PU","Plutonium",239.1,1.7,1.53,[0]),new ue(95,"AM","Americium",243.1,1.7,1.51,[0]),new ue(96,"CM","Curium",247.1,1.7,1.5,[0]),new ue(97,"BK","Berkelium",247.1,1.7,1.5,[0]),new ue(98,"CF","Californium",252.1,1.7,1.5,[0]),new ue(99,"ES","Einsteinium",252.1,1.7,1.5,[0]),new ue(100,"FM","Fermium",257.1,1.7,1.5,[0]),new ue(101,"MD","Mendelevium",256.1,1.7,1.5,[0]),new ue(102,"NO","Nobelium",259.1,1.7,1.5,[0]),new ue(103,"LR","Lawrencium",260.1,1.7,1.5,[0]),new ue(104,"RF","Rutherfordium",261,1.7,1.6,[0]),new ue(105,"DB","Dubnium",262,1.7,1.6,[0]),new ue(106,"SG","Seaborgium",263,1.7,1.6,[0]),new ue(107,"BH","Bohrium",262,1.7,1.6,[0]),new ue(108,"HS","Hassium",265,1.7,1.6,[0]),new ue(109,"MT","Meitnerium",268,1.7,1.6,[0])])();static ByName=(()=>({D:new ue(1,"D","Deuterium",2.014,1.2,.23,[1]),T:new ue(1,"T","Tritium",3.016,1.2,.23,[1])}))()}!function(){const e=ue.ByAtomicNumber,t=ue.ByName;for(let r=0,n=e.length;r<n;++r){const n=e[r];n&&(t[n.name]=n)}}(),ue.getByName=function(e){let t=ue.ByName[e];return t||(t=ue.ByName[e]=new ue(0,e,"Unknown",0,1,.01,[0])),t};const de=ue,pe={UNKNOWN:0,COVALENT:1,AROMATIC:2};function me(e){return e.position}class fe{constructor(e,t,r,n,s){if(this._left=e,this._right=t,this._fixed=s,this._index=-1,e>t)throw new Error("In a bond atom indices must be in increasing order");this._order=r,this._type=n}getLeft(){return this._left}getRight(){return this._right}getOrder(){return this._order}calcLength(){return this._left.position.distanceTo(this._right.position)}_forEachNeighbour(e,t){const{bonds:r}=e;for(let n=0,s=r.length;n<s;++n)t(r[n]._left!==e?r[n]._left:r[n]._right)}forEachLevelOne(e){const t=this._left,r=this._right;this._forEachNeighbour(t,(t=>{t!==r&&e(t)})),this._forEachNeighbour(r,(r=>{r!==t&&e(r)}))}forEachLevelTwo(e){const t=this._left,r=this._right,n=this;n._forEachNeighbour(t,(s=>{s!==r&&n._forEachNeighbour(s,(r=>{r!==t&&e(r)}))})),n._forEachNeighbour(r,(s=>{s!==t&&n._forEachNeighbour(s,(t=>{t!==r&&e(t)}))}))}_fixDir(e,t,r){let n=0,s=0;const i=e.clone();function o(o){i.copy(r(o)),i.sub(e);t.dot(i)>0?++n:++s}function a(e){"C"===e.element.name&&o(e)}const l=[[this.forEachLevelOne,a],[this.forEachLevelOne,o],[this.forEachLevelTwo,a],[this.forEachLevelTwo,o]];for(let e=0;e<l.length;++e){if(l[e][0].call(this,l[e][1]),s>n)return t.multiplyScalar(-1);if(s<n)return t}return t}calcNormalDir(e){const t=this._left,r=this._right;let n=t,s=r;e=void 0===e?me:e,t.bonds.length>r.bonds.length&&(n=r,s=t);let i=n,o=0;const{bonds:a}=s;for(let e=0,t=a.length;e<t;++e){let t=a[e]._left;a[e]._left===s&&(t=a[e]._right),t.bonds.length>o&&t!==n&&(i=t,o=t.bonds.length)}const l=e(s),c=e(n).clone().sub(l),h=e(i).clone().sub(l);return h.crossVectors(c,h),h.lengthSq()<1e-4&&h.set(0,1,0),c.normalize(),h.normalize(),c.crossVectors(h,c),c.lengthSq()<1e-4&&c.set(0,1,0),c.normalize(),this._fixDir(l,c,e)}static BondType=(()=>pe)()}fe.prototype.BondType=pe;const _e=fe,ge=["C3'","C3*","P","H5T","H3T"],ye=["OP1","O1P"],xe=["OP2","O2P"],be=["C3'","C3*","C1","C1'","C1*","P"],we=[{types:["A","DA","G","DG"],atoms:["N1"]},{types:["C","DC"],atoms:["N3"]},{types:["T","DT","U","DU"],atoms:["O4"]}];const Se=class{constructor(e,t,r,n){this._chain=e,this._component=null,this._type=t,this._sequence=r,this._icode=n,this._mask=1,this._index=-1,this._atoms=[],this._secondary=null,this._firstAtom=null,this._leadAtom=null,this._wingAtom=null,this._lastAtom=null,this._controlPoint=null,this._midPoint=null,this._wingVector=null,this._cylinders=null,this._isValid=!0,this._het=!1,this._molecule=null,this.temperature=null,this.occupancy=null}getChain(){return this._chain}getMolecule(){return this._molecule}getType(){return this._type}getSequence(){return this._sequence}getSecondary(){return this._secondary}getICode(){return this._icode}addAtom(e,t,r,n,s,i,o,a,l,c){const h=new he(this,e,t,r,n,s,i,o,a,l,c);return this._chain.getComplex().addAtom(h),this._atoms.push(h),this._het=this._het||s,h}getAtomCount(){return this._atoms.length}forEachAtom(e){const t=this._atoms;for(let r=0,n=t.length;r<n&&!e(t[r]);++r);}_findAtomByName(e){let t=null;return this.forEachAtom((r=>r.name===e&&(t=r,!0))),t}_findFirstAtomInList(e){let t=null;for(let r=0;r<e.length;++r)if(t=this._findAtomByName(e[r]),null!==t)return t;return t}collectMask(){let e=4294967295;const t=this._atoms;for(let r=0,n=t.length;r<n;++r)e&=t[r].mask;this._mask=e}getCylinderTargetList(){const e=this._type._name;for(let t=0,r=we.length;t<r;++t)for(let r=0,n=we[t].types.length;r<n;++r)if(e===we[t].types[r])return we[t].atoms;return null}_detectLeadWing(e,t,r){const n=this._findFirstAtomInList(ge);let s=this._findFirstAtomInList(ye),i=this._findFirstAtomInList(xe);if(null===s&&null!==t&&(s=t._findFirstAtomInList(ye)),null===i&&null!==t&&(i=t._findFirstAtomInList(xe)),null===n||null===s||null===i)return;e._leadAtom=n,e._controlPoint=r(n),e._wingVector=r(i).clone().sub(r(s)),e._isValid=!0;const o=this._findFirstAtomInList(be),a=this.getCylinderTargetList(),l=null!==a?this._findFirstAtomInList(a):null;null!==o&&null!==l&&(e._cylinders=[r(o),r(l)])}calcWing(e,t,r,n){const s=t.clone().sub(e),i=e.clone().sub(r);if(i.crossVectors(s,i),i.crossVectors(s,i).normalize(),null!==n&&n.length()>1e-4){i.length()>1e-4&&Math.abs(n.angleTo(i))>Math.PI/2&&i.negate()}return i}_innerFinalize(e,t,n,s,i,o){const a=null===t,l=o(this._leadAtom),c=new r.Vector3(l.x,l.y,l.z);if(i)this._detectLeadWing(s,n,o);else{if(a)s._midPoint=o(this._firstAtom).clone();else{const r=t._controlPoint;s._midPoint=r.clone().lerp(c,.5),s._wingVector=this.calcWing(r,c,o(e._wingAtom),t._wingVector)}s._controlPoint=c}}_finalize2(e,t,r){this._innerFinalize(e,e,t,this,r,(e=>e.position))}isConnected(e){if(this._chain!==e._chain)return!1;if(this===e)return!0;let t=!1;return this.forEachAtom((r=>{const{bonds:n}=r;for(let r=0,s=n.length;r<s;++r){const s=n[r];if(s._left.residue===e||s._right.residue===e)return t=!0,!0}return!1})),t}_finalize(){const e=this;[this._firstAtom]=this._atoms,this._lastAtom=this._atoms[this._atoms.length-1],this._leadAtom=null,this._wingAtom=null;let t=0,r=0,n=0,s=0;this.forEachAtom((i=>(null===e._leadAtom&&i.role===de.Constants.Lead&&(e._leadAtom=i),null===e._wingAtom&&i.role===de.Constants.Wing&&(e._wingAtom=i),i.temperature&&(r+=i.temperature,t++),i.occupancy&&(s+=i.occupancy,n++),null!==e._leadAtom&&null!==e._wingAtom))),t>0&&(this.temperature=r/t),n>0&&(this.occupancy=s/n),null!==this._leadAtom&&null!==this._wingAtom||(this._isValid=!1),null===this._leadAtom&&(this._leadAtom=this._firstAtom),null===this._wingAtom&&(this._wingAtom=this._lastAtom)}};class ve{constructor(e,t,r){this._name=e,this._fullName=t,this.letterCode=r,this.flags=0}getName(){return this._name}static StandardTypes=(()=>({ALA:new ve("ALA","Alanine","A"),ARG:new ve("ARG","Arginine","R"),ASN:new ve("ASN","Asparagine","N"),ASP:new ve("ASP","Aspartic Acid","D"),CYS:new ve("CYS","Cysteine","C"),GLN:new ve("GLN","Glutamine","Q"),GLU:new ve("GLU","Glutamic Acid","E"),GLY:new ve("GLY","Glycine","G"),HIS:new ve("HIS","Histidine","H"),ILE:new ve("ILE","Isoleucine","I"),LEU:new ve("LEU","Leucine","L"),LYS:new ve("LYS","Lysine","K"),MET:new ve("MET","Methionine","M"),PHE:new ve("PHE","Phenylalanine","F"),PRO:new ve("PRO","Proline","P"),PYL:new ve("PYL","Pyrrolysine","O"),SEC:new ve("SEC","Selenocysteine","U"),SER:new ve("SER","Serine","S"),THR:new ve("THR","Threonine","T"),TRP:new ve("TRP","Tryptophan","W"),TYR:new ve("TYR","Tyrosine","Y"),VAL:new ve("VAL","Valine","V"),A:new ve("A","Adenine","A"),C:new ve("C","Cytosine","C"),G:new ve("G","Guanine","G"),I:new ve("I","Inosine","I"),T:new ve("T","Thymine","T"),U:new ve("U","Uracil","U"),DA:new ve("DA","Adenine","A"),DC:new ve("DC","Cytosine","C"),DG:new ve("DG","Guanine","G"),DI:new ve("DI","Inosine","I"),DT:new ve("DT","Thymine","T"),DU:new ve("DU","Uracil","U"),"+A":new ve("+A","Adenine","A"),"+C":new ve("+C","Cytosine","C"),"+G":new ve("+G","Guanine","G"),"+I":new ve("+I","Inosine","I"),"+T":new ve("+T","Thymine","T"),"+U":new ve("+U","Uracil","U"),WAT:new ve("WAT","Water",""),H2O:new ve("H2O","Water",""),HOH:new ve("HOH","Water",""),DOD:new ve("DOD","Water",""),UNK:new ve("UNK","Unknown",""),UNL:new ve("UNL","Unknown Ligand","")}))();static Flags={PROTEIN:1,BASIC:2,ACIDIC:4,POLAR:8,NONPOLAR:16,AROMATIC:32,NUCLEIC:256,PURINE:512,PYRIMIDINE:1024,DNA:2048,RNA:4096,WATER:65536}}function Ce(e,t){for(let r=0,n=t.length;r<n;++r){const n=ve.StandardTypes[t[r]];n&&(n.flags|=e)}}const{Flags:Ae}=ve;Ce(Ae.WATER,["WAT","H2O","HOH","DOD"]),Ce(Ae.PROTEIN,["ALA","ARG","ASN","ASP","CYS","GLY","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","PRO","PYL","SEC","SER","THR","TRP","TYR","VAL"]),Ce(Ae.BASIC,["ARG","HIS","LYS"]),Ce(Ae.ACIDIC,["ASP","GLU"]),Ce(Ae.POLAR,["ASN","CYS","GLN","SER","THR","TYR"]),Ce(Ae.NONPOLAR,["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL","GLY"]),Ce(Ae.AROMATIC,["PHE","TRP","TYR"]),Ce(Ae.NUCLEIC,["A","G","I","DA","DG","DI","+A","+G","+I","C","T","U","DC","DT","DU","+C","+T","+U"]),Ce(Ae.PURINE,["A","G","I","DA","DG","DI","+A","+G","+I"]),Ce(Ae.PYRIMIDINE,["C","T","U","DC","DT","DU","+C","+T","+U"]),Ce(Ae.DNA,["DA","DG","DI","DC","DT","DU"]),Ce(Ae.RNA,["A","G","I","C","T","U"]);!function(e,t){const r=Object.keys(t);for(let n=0,s=r.length;n<s;++n){const s=r[n],i=t[s];ve.StandardTypes[s][e]=i}}("hydrophobicity",{ILE:4.5,VAL:4.2,LEU:3.8,PHE:2.8,CYS:2.5,MET:1.9,ALA:1.8,GLY:-.4,THR:-.7,SER:-.8,TRP:-.9,TYR:-1.3,PRO:-1.6,HIS:-3.2,GLU:-3.5,GLN:-3.5,ASP:-3.5,ASN:-3.5,LYS:-3.9,ARG:-4.5});const Ee=ve,Te=0,Re=1,Me=2;const Pe=class{constructor(e,t){this._complex=e,this._name=t,this._mask=1,this._index=-1,this._residues=[],this.minSequence=Number.POSITIVE_INFINITY,this.maxSequence=Number.NEGATIVE_INFINITY}getComplex(){return this._complex}getName(){return this._name}getResidues(){return this._residues}_determineType(){const e=this._residues,{PROTEIN:t,NUCLEIC:r}=Ee.Flags;this.type=Te;for(let n=0,s=e.length;n<s;++n){const{flags:s}=e[n]._type;if(0!=(s&r)){this.type=Me;break}if(0!=(s&t)){this.type=Re;break}}}findResidue(e,t){const r=this._residues;for(let n=0,s=r.length;n<s;++n){const s=r[n];if(s._sequence===e&&s._icode===t)return[s,n]}return null}_finalize(){this._determineType();const e=this._residues;let t=null;for(let r=0,n=e.length;r<n;++r){const s=r+1<n?e[r+1]:null,i=e[r];i._finalize2(t,s,this.type===Me),t=i}if(e.length>1&&e[1]._wingVector){const t=e[1]._wingVector;e[0]._wingVector=new r.Vector3(t.x,t.y,t.z)}else e.length>0&&(e[0]._wingVector=new r.Vector3(1,0,0))}updateToFrame(e){const t=this._residues;let n=null,s=null;const i=e._residues,o=t.length;function a(t){return e.getAtomPos(t.index)}for(let e=0;e<o;++e){const r=t[e],l=i[r._index],c=e+1<o?t[e+1]:null;r._innerFinalize(n,s,c,l,this.type===Me,a),n=r,s=l}i[t[0]._index]._wingVector=o>1?i[t[1]._index]._wingVector:new r.Vector3(1,0,0)}addResidue(e,t,r){let n=this._complex.getResidueType(e);null===n&&(n=this._complex.addResidueType(e));const s=new Se(this,n,t,r);return this._complex.addResidue(s),this._residues.push(s),n.flags&(Ee.Flags.NUCLEIC|Ee.Flags.PROTEIN)&&(this.maxSequence<t&&(this.maxSequence=t),this.minSequence>t&&(this.minSequence=t)),s}getResidueCount(){return this._residues.length}forEachResidue(e){const t=this._residues;for(let r=0,n=t.length;r<n;++r)e(t[r])}collectMask(){let e=4294967295;const t=this._residues;for(let r=0,n=t.length;r<n;++r)e&=t[r]._mask;this._mask=e}};class Ne{constructor(e,t,r){this.type=e,this.generic=Ne.genericByType[this.type]||"loop",this.init=t,this.term=r}_finalize(e,t,r){if(this.init instanceof Se&&this.term instanceof Se)return;const n=r.splitUnifiedSerial(this.init),s=r.splitUnifiedSerial(this.term);for(let e=n.chain;e<=s.chain;e++)for(let i=n.serial;i<=s.serial;i++)for(let{iCode:o}=n;o<=s.iCode;o++){const n=r.getUnifiedSerial(e,i,o);t[n]&&(t[n]._secondary=this)}this.init=t[this.init],this.term=t[this.term]}}Ne.Type={STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",HELIX:"X",TURN_310:"3",TURN_ALPHA:"4",TURN_PI:"5",TURN:"T",BEND:"S",COIL:"C"},Ne.Generic={STRAND:"strand",HELIX:"helix",LOOP:"loop"};const Le=Ne.Type,Ie=Ne.Generic;Ne.genericByType={[Le.STRAND]:Ie.STRAND,[Le.HELIX_310]:Ie.HELIX,[Le.HELIX_ALPHA]:Ie.HELIX,[Le.HELIX_PI]:Ie.HELIX,[Le.HELIX]:Ie.HELIX};const Oe=Ne,Ve=Oe.Type,De={1:Ve.HELIX_ALPHA,3:Ve.HELIX_PI,5:Ve.HELIX_310};const ke=class extends Oe{constructor(e,t,r,n,s,i,o){super(De[e]||Oe.Type.HELIX,t,r),this.serial=n,this.name=s,this.comment=i,this.length=o}};const ze=class extends Oe{constructor(e,t,r,n,s,i){super(Oe.Type.STRAND,t,r),this.sheet=e,this.sense=n,this.atomCur=s,this.atomPrev=i}_finalize(e,t,r){super._finalize(e,t,r);let n=this.atomCur;null===n||Number.isNaN(n)||(this.atomCur=e[n]),n=this.atomPrev,null===n||Number.isNaN(n)||(this.atomPrev=e[n])}};const Fe=class{constructor(e,t){this._name=e,this._width=t,this._strands=[]}getName(){return this._name}getWidth(){return this._width}addStrand(e){this._strands.push(e),this._width=this._strands.length}addEmptyStrand(){this._strands.push(new ze(null,null,null,null,null,null))}_finalize(e,t,r){const n=this._strands;for(let s=0,i=n.length;s<i;++s)n[s]._finalize(e,t,r);if(this._width||(this._width=n.length),n.length!==this._width)throw new Error(`Sheet ${this._name} is inconsistent.`)}};const Be=class{constructor(e,t,n,s,i){this._id=e,this._name=t,this._position=n||new r.Vector3,this._atoms=s||[],this._charge=0,this._repeat=1,this._center=null,this.xmlNodeRef=i||null}getName(){return this._name}getPosition(){return this._position}getCentralPoint(){return this._center}_rebuildSGroupOnAtomChange(){const e=1e8;if(null===this._center)return;const t=new r.Vector3(e,e,e),n=new r.Vector3(-e,-e,-e);for(let e=0,r=this._atoms.length;e<r;e++){const r=this._atoms[e].position;t.set(Math.min(t.x,r.x),Math.min(t.y,r.y),Math.min(t.z,r.z)),n.set(Math.max(n.x,r.x),Math.max(n.y,r.y),Math.max(n.z,r.z))}this._center.addVectors(t,n),this._center.multiplyScalar(.5)}};var Ue=s(99);class Ge{constructor(e){if(e instanceof this.constructor)return e;this._values=e instanceof Array?e.slice(0):e?[e]:[]}append(e){const t=this._values;return t[t.length]=e,this}remove(e){const t=this._values,r=t.indexOf(e);return r>=0&&t.splice(r,1),this}toString(){return this._values.join(",")}toJSON(){const e=this._values,t=[];for(let r=0,n=e.length;r<n;++r){const n=e[r];t[r]=n.toJSON?n.toJSON():n}return t}}class je extends Ge{includes(e){const t=this._values;for(let r=0,n=t.length;r<n;++r)if(t[r].includes(e))return!0;return!1}}const He=[];class $e extends Ge{constructor(e,t){const r=super(e);if(t){this.upperOnly=!0;const e=r._values;for(let t=0,r=e.length;t<r;++t){const r=e[t];"string"==typeof r&&(e[t]=r.toUpperCase())}}else this.upperOnly=!1;return r}includes(e){return-1!==this._values.indexOf(e)}toString(){const e=this._values;He.length=0;for(let t=0,r=e.length;t<r;++t)He[t]=O.correctSelectorIdentifier(String(e[t]));return He.join(",")}_validate(e){return this.upperOnly&&"string"==typeof e?e.toUpperCase():e}append(e){return super.append(this._validate(e)),this}remove(e){return super.remove(this._validate(e)),this}}class We{toString(){return this.keyword}toJSON(){return[this.name]}}We.prototype.name="Error",We.prototype.keyword="error";class Ye extends We{constructor(e){super(),this.list=e}toString(){return`${this.keyword} ${this.list}`}toJSON(){return[this.name,this.list.toJSON()]}}class Xe extends Ye{constructor(e){super(new je(e))}}class qe extends Ye{constructor(e,t){super(new $e(e,!t))}}class Ze extends We{includesAtom(e){return!1}}Ze.prototype.name="None",Ze.prototype.keyword="none";class Ke extends We{includesAtom(e){return!0}}Ke.prototype.name="All",Ke.prototype.keyword="all";const Qe=new Ze;class Je extends We{constructor(e){super(),this.rhs=e||Qe}toString(){const e=this.rhs.priority&&this.rhs.priority>this.priority?`(${this.rhs})`:this.rhs;return`${this.keyword} ${e}`}toJSON(){return[this.name,this.rhs.toJSON()]}}Je.prototype.priority=1;class et extends We{constructor(e,t){super(),this.lhs=e||Qe,this.rhs=t||Qe}toString(){const e=this.lhs.priority&&this.lhs.priority>this.priority?`(${this.lhs})`:this.lhs,t=this.rhs.priority&&this.rhs.priority>this.priority?`(${this.rhs})`:this.rhs;return`${e} ${this.keyword} ${t}`}toJSON(){return[this.name,this.lhs.toJSON(),this.rhs.toJSON()]}}et.prototype.priority=1e3;const tt={};function rt(e,t){const r=e.toLowerCase();t.prototype.keyword=r,t.prototype.name=e;const n=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return new t(...r)};return n.SelectorClass=t,tt[r]=n,t}rt("Serial",class extends Xe{includesAtom(e){return this.list.includes(e.serial)}}),rt("Name",class extends qe{includesAtom(e){return this.list.includes(e.name)}}),rt("AltLoc",class extends qe{includesAtom(e){return this.list.includes(String.fromCharCode(e.location))}}),rt("Elem",class extends qe{includesAtom(e){return this.list.includes(e.element.name)}}),rt("Residue",class extends qe{includesAtom(e){return this.list.includes(e.residue._type._name)}}),rt("Sequence",class extends Xe{includesAtom(e){return this.list.includes(e.residue._sequence)}}),rt("ICode",class extends qe{constructor(e){super(e,!0)}includesAtom(e){return this.list.includes(e.residue._icode)}}),rt("ResIdx",class extends Xe{includesAtom(e){return this.list.includes(e.residue._index)}}),rt("Chain",class extends qe{constructor(e){super(e,!0)}includesAtom(e){return this.list.includes(e.residue._chain._name)}}),rt("Hetatm",class extends We{includesAtom(e){return e.het}}),rt("PolarH",class extends We{includesAtom(e){return(e.flags&he.Flags.NONPOLARH)===he.Flags.HYDROGEN}}),rt("NonPolarH",class extends We{includesAtom(e){return(e.flags&he.Flags.NONPOLARH)===he.Flags.NONPOLARH}}),rt("All",Ke),rt("None",Ze);const nt=tt.none();function st(e,t,r){return r.prototype.priority=t,rt(e,r)}function it(e,t){return rt(t,class extends We{includesAtom(t){return 0!=(t.residue._type.flags&e)}})}st("Not",1,class extends Je{includesAtom(e){return!this.rhs.includesAtom(e)}}),st("And",2,class extends et{includesAtom(e){return this.lhs.includesAtom(e)&&this.rhs.includesAtom(e)}}),st("Or",3,class extends et{includesAtom(e){return this.lhs.includesAtom(e)||this.rhs.includesAtom(e)}}),it(Ee.Flags.PROTEIN,"Protein"),it(Ee.Flags.BASIC,"Basic"),it(Ee.Flags.ACIDIC,"Acidic"),it(Ee.Flags.BASIC|Ee.Flags.ACIDIC,"Charged"),it(Ee.Flags.POLAR,"Polar"),it(Ee.Flags.NONPOLAR,"NonPolar"),it(Ee.Flags.AROMATIC,"Aromatic"),it(Ee.Flags.NUCLEIC,"Nucleic"),it(Ee.Flags.PURINE,"Purine"),it(Ee.Flags.PYRIMIDINE,"Pyrimidine"),it(Ee.Flags.WATER,"Water");const ot=Object.create(tt);ot.Selector=We,ot.RangeListSelector=Xe,ot.ValueListSelector=qe,ot.Range=class{constructor(e,t){this.min=e,this.max=void 0===t?e:t}includes(e){return this.min<=e&&e<=this.max}toString(){const{min:e,max:t}=this;return e===t?String(e):[e,t].join(":")}toJSON(){return[this.min,this.max]}},ot.RangeList=je,ot.ValueList=$e,ot.PrefixOperator=Je,ot.InfixOperator=et,ot.Context=Object.create({}),ot.GetSelector=function(e){if(!ot.Context.hasOwnProperty(e)){throw{message:`selector ${e} is not registered`}}return ot.Context[e]||nt},ot.ClearContext=function(){Object.keys(ot.Context).forEach((e=>{delete ot.Context[e]}))},ot.keyword=function(e){return tt[e.toLowerCase()]||tt.none},ot.parse=function(e){const t={};try{t.selector=Ue.parser.parse(e)}catch(e){t.selector=nt,t.error=e.message}return t},Ue.parser.yy=ot,Ue.parser.yy.parseError=Ue.parser.parseError;const at=ot;const lt=class{constructor(e){this._complex=e,this._selector=at.keyword("All")(),this._boundaries={boundingBox:new r.Box3,boundingSphere:new r.Sphere}}computeBoundaries(){const e=this._complex._atoms,t=e.length,n=this._selector,{boundingBox:s}=this._boundaries;if(s.makeEmpty(),1===t){s.expandByPoint(e[0].position);const t=new r.Vector3;s.getCenter(t);const n=2*e[0].element.radius;s.setFromCenterAndSize(t,new r.Vector3(n,n,n))}else for(let r=0;r<t;++r)n.includesAtom(e[r])&&s.expandByPoint(e[r].position);let i=0;const o=new r.Vector3;if(s.getCenter(o),1===t)this._boundaries.boundingSphere.set(o,e[0].element.radius);else{for(let r=0;r<t;++r){if(!n.includesAtom(e[r]))continue;const t=e[r].position,s=o.distanceToSquared(t);i<s&&(i=s)}this._boundaries.boundingSphere.set(o,Math.sqrt(i))}}getTransforms(){return[]}getSelector(){return this._selector}getBoundaries(){return this._boundaries}finalize(){}};const ct=class extends lt{constructor(e){super(e),this.chains=[],this.matrices=[]}computeBoundaries(){super.computeBoundaries();const{matrices:e}=this,t=this._boundaries.boundingSphere.center,n=this._boundaries.boundingSphere.radius,s=this._boundaries.boundingBox=new r.Box3;s.makeEmpty();for(let r=0,n=e.length;r<n;++r)s.expandByPoint(t.clone().applyMatrix4(e[r]));const i=s.max.distanceTo(s.min)/2+n,o=new r.Vector3;s.getCenter(o),this._boundaries.boundingSphere=(new r.Sphere).set(o,i),s.max.addScalar(n),s.min.subScalar(n)}addChain(e){this.chains[this.chains.length]=e}addMatrix(e){this.matrices[this.matrices.length]=e}getTransforms(){return this.matrices}finalize(){this.chains.length>0?this._selector=at.keyword("Chain")(this.chains):this._selector=at.keyword("None")()}};const ht=class{constructor(e){this._complex=e,this._index=-1,this._residueIndices=[],this._cycles=[],this._subDivs=[],this._residueCount=0}getResidues(){return this._complex._residues}getResidueCount(){return this._residueCount}forEachResidue(e){const t=this._complex._residues,r=this._residueIndices;for(let n=0,s=r.length;n<s;++n)for(let s=r[n].start,i=r[n].end;s<=i;++s)e(t[s])}setSubDivs(e){this._subDivs=e;let t=0;const r=[];let n=0;for(let s=0,i=e.length;s<i;++s)if(s===i-1||e[s].end+1!==e[s+1].start){const{start:i}=e[t],{end:o}=e[s];r[r.length]={start:i,end:o},n+=o-i+1,t=s+1}this._residueIndices=r,this._residueCount=n}getComplex(){return this._complex}forEachBond(e){const t=this._complex._bonds;for(let r=0,n=t.length;r<n;++r){const n=t[r];n._left.residue._component===this&&e(n)}}update(){this.forEachCycle((e=>{e.update()}))}forEachAtom(e){this.forEachResidue((t=>{t.forEachAtom(e)}))}addCycle(e){this._cycles.push(e)}forEachCycle(e){const t=this._cycles;for(let r=0,n=t.length;r<n;++r)e(t[r])}markResidues(){const e=this;e.forEachResidue((t=>{t._component=e}))}_forEachSubChain(e,t){const r=this._complex._residues,n=this._subDivs;for(let s=0,i=n.length;s<i;++s)for(let i=n[s].start,o=n[s].end;i<=o;++i){const n=r[i];if(e&n._mask&&n._isValid){let n=i+1;for(;n<=o;++n){const t=r[n];if(!(e&t._mask&&t._isValid))break}t(s,i,n-1),i=n}}}getMaskedSequences(e){const t=[];let r=0;return this._forEachSubChain(e,((e,n,s)=>{t[r++]={start:n,end:s}})),t}getMaskedSubdivSequences(e){const t=[];let r=-1,n=-1;const s=this._subDivs;return this._forEachSubChain(e,((e,i,o)=>{n!==e&&(++r,t[r]={arr:[],boundaries:s[e]},n=e),t[r].arr[t[r].arr.length]={start:i,end:o}})),t}};const ut=class{constructor(e){this.numPairs=0,this.numMaxPairs=e,this.intBuffer=O.allocateTyped(Int32Array,4*e);for(let t=0;t<4*e;t++)this.intBuffer[t]=-1;this.hashBuffer=O.allocateTyped(Int32Array,33554432);for(let e=0;e<33554432;e++)this.hashBuffer[e]=-1}destroy(){this.intBuffer=null,this.hashBuffer=null}addPair(e,t){const r=e<t?e:t,n=e>t?e:t,s=r+(n<<14);let i=32*(r+89237*n&1048575),o=0;for(;o<32;o++){const e=this.hashBuffer[i+o];if(-1===e)break;if(e===s)return!1}if(o>=32)throw new Error("addPair: increase cMaxPairsForHashCode");if(this.hashBuffer[i+o]=s,this.numPairs>=this.numMaxPairs)throw new Error("addPair: increase num pairs");return i=4*this.numPairs,this.intBuffer[i]=r,this.intBuffer[i+1]=n,this.intBuffer[i+2]=s,this.numPairs++,!0}};function dt(e){const{element:t}=e;if(t)return t.radiusBonding;throw new Error("_getBondingRadius: Logic error.")}const pt=class{constructor(e){this._complex=e,this._maxRad=1.8;const t=this._complex.getDefaultBoundaries().boundingBox;this._vBoxMin=t.min.clone(),this._vBoxMax=t.max.clone(),this._pairCollection=null}_addExistingPairs(){const e=this._complex.getAtoms(),t=e.length;let r=0;const n=this._pairCollection;for(;r<t;r++){const{bonds:t}=e[r],s=t.length;for(let e=0;e<s;e++){const s=t[e];s._left.index===r&&n.addPair(r,s._right.index)}}return 0}_findPairs(){const e=this._complex.getVoxelWorld();if(null===e)return;const t=this._complex._atoms,r=t.length,n=this;let s,i,o,a,l;const c=function(e){if(i&&e.isHydrogen())return;const t=e.location;if(32!==a&&32!==t&&a!==t)return;const r=o.distanceToSquared(e.position),c=e.element.radiusBonding,h=s+c+.45;r>h*h||r<.001||n._pairCollection.addPair(l.index,e.index)};for(let n=0;n<r;++n)l=t[n],(!(h=l).isHet()||h.bonds&&0===h.bonds.length)&&(s=l.element.radiusBonding,i=l.isHydrogen(),o=l.position,a=l.location,e.forEachAtomWithinRadius(o,2*this._maxRad+.45,c));var h}_addPairs(){const e=this._complex._atoms;for(let t=0,r=0;t<this._pairCollection.numPairs;t++,r+=4){const t=this._pairCollection.intBuffer[r],n=this._pairCollection.intBuffer[r+1];this._addPair(e[t],e[n])}}_addPair(e,t){const r=e.bonds,n=e.index,s=t.index;for(let e=0,t=r.length;e<t;++e){const t=r[e];if(t._left.index===s||t._right.index===s)return}const i=n<s?e:t,o=n<s?t:e,a=this._complex.addBond(i,o,0,_e.BondType.UNKNOWN,!1);r.push(a),t.bonds.push(a)}build(){this._buildInner()}_buildInner(){const e=this._complex._atoms;if(!(e.length<2)){if(e[0].index<0)throw new Error("AutoBond: Atoms in complex were not indexed.");this._calcBoundingBox(),this._pairCollection=new ut(4*e.length),this._addExistingPairs(),this._findPairs(),this._addPairs()}}_calcBoundingBox(){const e=this._complex._atoms,t=e.length;let r=dt(e[0]);for(let n=1;n<t;++n)r=Math.max(r,dt(e[n]));this._vBoxMax.addScalar(r),this._vBoxMin.addScalar(-r),this._maxRad=1.2*r}destroy(){this._pairCollection&&this._pairCollection.destroy()}},mt=_e.BondType.AROMATIC,ft=[de.ByName.C.number,de.ByName.N.number],_t=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Vector3;return function(r,s){return e.copy(r).normalize(),t.copy(s).normalize(),n.crossVectors(e,t),!(n.length()>.1)&&e.dot(t)>=0}}();function gt(e,t){let r=0;for(;r<e.length&&e[r]<t;)++r;e.splice(r,0,t)}function yt(e,t){return e._left===t?e._right:e._left}function xt(e){e._type=mt}class bt{constructor(e){this.atoms=e,this.update()}update(){const{atoms:e}=this,t=new r.Vector3,n=e.length;for(let r=0;r<n;++r)t.add(e[r].position);t.multiplyScalar(1/n),this.center=t,this.radius=t.distanceTo(e[0].position.clone().lerp(e[1].position,.5))}forEachBond(e){const{atoms:t}=this,r=t.length;let n,s=t[0];function i(t){t._left!==n&&t._right!==n||e(t)}for(let e=0;e<r;++e)n=t[(e+1)%r],s.forEachBond(i),s=n}}function wt(e){return e._type===mt}function St(e){if(e.type===mt)return!0;const t=ft.indexOf(e._right.element.number),r=ft.indexOf(e._left.element.number);return-1!==t&&-1!==r}function vt(e){return e.length>3}function Ct(e){return!0}const At=class{constructor(e){this._complex=e;const t=new Array(e._bonds.length),r=new Array(e._bonds.length);for(let e=0,n=t.length;e<n;++e)t[e]=[],r[e]=!1;this._bondsData=t,this._bondMarks=r,this._resetCycles()}_resetCycles(){this._cycles=[],this._currIdx=-1}_haveSameCycle(e,t,r){const n=e[t._index],s=e[r._index],i=n.length,o=s.length;let a=0,l=0;for(;a<i&&l<o;){if(n[a]===s[l])return!0;n[a]>s[l]?++l:++a}return!1}_tryBond(e,t,n){const s=[],i=this._bondsData,o=yt(e,t),a=t.position.clone().sub(o.position),l=this._currStart,c=this,h=this._bondMarks;let u=this._checkBond;h[e._index]=!0,u=void 0===u?wt:u,t.forEachBond((o=>{if(!u(o)||o===e||h[o._index]||c._haveSameCycle(i,e,o))return;const d=yt(o,t),p=d.position.clone().sub(t.position),m=d===l?-2:1-function(e,t){const n=e.dot(t)/Math.sqrt(e.lengthSq()*t.lengthSq());return r.MathUtils.clamp(n,-1,1)}(a,p),f=p.cross(a);if(!_t(f,n))return;let _=0;for(;_<s.length&&s[_].val<m;)++_;s.splice(_,0,{bond:o,val:m,dir:f})}));for(let r=0,n=s.length;r<n;++r){const{bond:n}=s[r],o=n._left===t?n._right:n._left;if(o===l)return++this._currIdx,this._cycles.push([t]),h[e._index]=!1,!0;if(this._tryBond(n,o,s[r].dir))return gt(i[n._index],this._currIdx),this._cycles[this._currIdx].push(t),h[e._index]=!1,!0}return h[e._index]=!1,!1}_startCycle(e){this._currStart=e._left,this._tryBond(e,e._right,new r.Vector3)&&(gt(this._bondsData[e._index],this._currIdx),this._cycles[this._currIdx].push(e._left))}_findLoops(e,t){this._checkBond=e;const r=this._complex,n=this;r.forEachComponent((r=>{n._resetCycles(),r.forEachBond((t=>{e(t)&&n._startCycle(t)}));const s=n._cycles;for(let e=0,n=s.length;e<n;++e){const n=s[e];if(!t(n))continue;const i=new bt(n);i.forEachBond(xt),r.addCycle(i)}}))}markCycles(){this._findLoops(wt,vt)}detectCycles(){this._findLoops(St,Ct)}};function Et(e,t,r,n){const s=r-e.z,i=n-e.z,o=Math.sqrt(Math.max(t*t-s*s,0)),a=Math.sqrt(Math.max(t*t-i*i,0)),l=Math.min(o,a);let c;return c=r<=e.z&&n>=e.z?t:Math.max(o,a),[l,c]}function Tt(e,t,r,n){const s=r-e.y,i=n-e.y,o=Math.sqrt(Math.max(t*t-s*s,0)),a=Math.sqrt(Math.max(t*t-i*i,0)),l=Math.min(o,a);let c;return c=r<=e.y&&n>=e.y?t:Math.max(o,a),[l,c]}class Rt{constructor(e,t){this._box=e.clone();const n=new r.Vector3;e.getSize(n),this._count=n.clone().divide(t).floor().max(new r.Vector3(1,1,1)),this._last=this._count.clone().subScalar(1),this._cellSize=n.clone().divide(this._count),this._cellInnerR=.5*Math.min(Math.min(this._cellSize.x,this._cellSize.y),this._cellSize.z),this._cellOuterR=.5*Math.sqrt(this._cellSize.dot(this._cellSize));const s=this._count.x*this._count.y*this._count.z;this._voxels=O.allocateTyped(Int32Array,s);for(let e=0;e<s;++e)this._voxels[e]=-1;this._atoms=[]}addAtoms(e){const t=this;let r=this._atoms.length;this._atoms.length+=2*e.getAtomCount(),e.forEachAtom((e=>{const n=t._findVoxel(e.position);t._atoms[r]=e,t._atoms[r+1]=t._voxels[n],t._voxels[n]=r,r+=2}))}static _zero=(()=>new r.Vector3(0,0,0))();static _voxel=(()=>new r.Vector3)();_findVoxel(e){const t=Rt._zero,r=Rt._voxel;return r.copy(e).sub(this._box.min).divide(this._cellSize).floor().clamp(t,this._last),r.x+this._count.x*(r.y+this._count.y*r.z)}_forEachAtomInVoxel(e,t){for(let r=this._voxels[e];r>=0;r=this._atoms[r+1])t(this._atoms[r])}static _xRange=(()=>new r.Vector2)();static _yRange=(()=>new r.Vector2)();static _zRange=(()=>new r.Vector2)();_forEachVoxelWithinRadius(e,t,r){const n=Rt._xRange,s=Rt._yRange,i=Rt._zRange;if(t/this._cellInnerR<10)return void this._forEachVoxelWithinRadiusSimple(e,t,r);let o,a,l,c,h,u,d,p;i.set(e.z-t,e.z+t),i.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor().clampScalar(0,this._count.z-1);for(let m=i.x;m<=i.y;++m){h=[this._box.min.z+m*this._cellSize.z,this._box.min.z+(m+1)*this._cellSize.z],p=e.z-t<=h[0]&&h[1]<=e.z+t,o=Et(e,t,h[0],h[1]),s.set(e.y-o[1],e.y+o[1]),s.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor().clampScalar(0,this._count.y-1);for(let t=s.x;t<=s.y;++t){c=[this._box.min.y+t*this._cellSize.y,this._box.min.y+(t+1)*this._cellSize.y],d=e.y-o[0]<=c[0]&&c[1]<=e.y+o[0],a=Tt(e,o[1],c[0],c[1]),n.set(e.x-a[1],e.x+a[1]),n.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor().clampScalar(0,this._count.x-1);for(let{x:s}=n;s<=n.y;++s)l=[this._box.min.x+s*this._cellSize.x,this._box.min.x+(s+1)*this._cellSize.x],u=e.x-a[0]<=l[0]&&l[1]<=e.x+a[0],r(s+this._count.x*(t+this._count.y*m),u&&d&&p)}}}static _vCenter=(()=>new r.Vector3)();_forEachVoxelWithinRadiusSimple(e,t,r){const n=Rt._xRange,s=Rt._yRange,i=Rt._zRange,o=Rt._vCenter,a=(t+this._cellOuterR)*(t+this._cellOuterR);let l=-1;t>this._cellOuterR&&(l=(t-this._cellOuterR)*(t-this._cellOuterR)),n.set(e.x-t,e.x+t),n.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor(),n.x=Math.min(Math.max(n.x,0),this._count.x-1),n.y=Math.min(Math.max(n.y,0),this._count.x-1),s.set(e.y-t,e.y+t),s.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor(),s.x=Math.min(Math.max(s.x,0),this._count.y-1),s.y=Math.min(Math.max(s.y,0),this._count.y-1),i.set(e.z-t,e.z+t),i.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor(),i.x=Math.min(Math.max(i.x,0),this._count.z-1),i.y=Math.min(Math.max(i.y,0),this._count.z-1);for(let t=i.x;t<=i.y;++t){const i=[this._box.min.z+t*this._cellSize.z,this._box.min.z+(t+1)*this._cellSize.z];o.z=.5*(i[0]+i[1]);for(let i=s.x;i<=s.y;++i){const s=[this._box.min.y+i*this._cellSize.y,this._box.min.y+(i+1)*this._cellSize.y];o.y=.5*(s[0]+s[1]);for(let{x:s}=n;s<=n.y;++s){const n=[this._box.min.x+s*this._cellSize.x,this._box.min.x+(s+1)*this._cellSize.x];o.x=.5*(n[0]+n[1]);const c=e.distanceToSquared(o);c<=a&&r(s+this._count.x*(i+this._count.y*t),c<=l)}}}}forEachAtomWithinRadius(e,t,r){const n=this,s=t*t;n._forEachVoxelWithinRadius(e,t,((t,i)=>{i?n._forEachAtomInVoxel(t,r):n._forEachAtomInVoxel(t,(t=>{e.distanceToSquared(t.position)<=s&&r(t)}))}))}forEachAtomWithinDistFromMasked(e,t,r,n){this._forEachAtomWithinDistFromGroup((r=>{e.forEachAtom((e=>{0!=(e.mask&t)&&r(e)}))}),r,n)}forEachAtomWithinDistFromSelected(e,t,r,n){this._forEachAtomWithinDistFromGroup((r=>{e.forEachAtom((e=>{t.includesAtom(e)&&r(e)}))}),r,n)}_forEachAtomWithinDistFromGroup(e,t,r){const n=this,s=t*t,i=[],o=[];let a,l=0;e((e=>{n._forEachVoxelWithinRadius(e.position,t,((t,r)=>{r?i[t]=-1:void 0===i[t]?(o.push(e),o.push(-1),i[t]=l,l+=2):-1!==i[t]&&(o.push(e),o.push(i[t]),i[t]=l,l+=2)}))}));const c=function(e){if(void 0!==i[a])if(l=i[a],-1!==l){for(;l>=0;l=o[l+1])if(e.position.distanceToSquared(o[l].position)<s){r(e);break}}else r(e)};for(a in i)i.hasOwnProperty(a)&&n._forEachAtomInVoxel(a,c)}}const Mt=Rt,Pt=.5,Nt=-9.9,Lt=-27.888;class It{constructor(e){this._complex=e,this._hbonds=[],this._complex._residues.length>1e3?this._buildVW():this._build()}isBond(e,t){if(this._hbonds[e]){const[r,n]=this._hbonds[e].acceptor;if(r&&r.residue===t&&r.energy<-.5)return!0;if(n&&n.residue===t&&n.energy<-.5)return!0}return!1}_build(){const e=this;for(let t=0;t<this._complex._residues.length-1;++t){const r=this._complex._residues[t];if(0==(r.getType().flags&Ee.Flags.PROTEIN))continue;let n=null;t>0&&this._complex._residues[t-1].getType().flags&Ee.Flags.PROTEIN&&r._sequence===this._complex._residues[t-1]._sequence+1&&(n=this._complex._residues[t-1]);for(let s=t+1;s<this._complex._residues.length;++s){const i=this._complex._residues[s];if(0==(i.getType().flags&Ee.Flags.PROTEIN))continue;let o=null;this._complex._residues[s-1].getType().flags&Ee.Flags.PROTEIN&&i._sequence===this._complex._residues[s-1]._sequence+1&&(o=this._complex._residues[s-1]),e._calcHBondEnergy(n,r,i),s!==t+1&&e._calcHBondEnergy(o,i,r)}}}_buildVW(){const e=this,t=this._complex._residues;let r,n;const s=this._complex.getVoxelWorld();if(null===s)return;const i=new ut(this._complex._residues.length*this._complex._residues.length/2);function o(s){const o=s.residue;if(o._index===r._index)return;if(0==(o.getType().flags&Ee.Flags.PROTEIN))return;if(!i.addPair(r._index,o._index))return;let a=o._index>0?t[o._index-1]:null;!a||0!=(a.getType().flags&Ee.Flags.PROTEIN)&&o._sequence===a._sequence+1||(a=null),e._calcHBondEnergy(n,r,o),o._index!==r._index+1&&e._calcHBondEnergy(a,o,r)}for(let e=0;e<t.length-1;++e)r=t[e],0!=(r.getType().flags&Ee.Flags.PROTEIN)&&(n=e>0?t[e-1]:null,!n||0!=(n.getType().flags&Ee.Flags.PROTEIN)&&r._sequence===n._sequence+1||(n=null),s.forEachAtomWithinRadius(this._residueGetCAlpha(r),5,o))}_residueGetCAlpha(e){for(let t=0;t<e._atoms.length;++t){const{name:r}=e._atoms[t];if("CA"===r||"C1"===r)return e._atoms[t].position}return null}_residueGetCO(e){let t=null,r=null;return e.forEachAtom((e=>{"C"===e.name?t=e.position:"O"===e.name&&(r=e.position)})),[t,r]}_residueGetNH(e,t){const[r,n]=this._residueGetCO(e);let s;if(t.forEachAtom((e=>{"N"===e.name&&(s=e.position)})),r&&n&&s){const e=r.clone();return e.sub(n),e.multiplyScalar(1/e.length()),e.add(s),[s,e]}return[null,null]}_calcHBondEnergy(e,t,r){let n=0;if(null===e)return n;if("PRO"!==t.getType().getName()){const[s,i]=this._residueGetNH(e,t),[o,a]=this._residueGetCO(r);if(null===s||null===i||null===o||null===a)return n;const l=i.distanceTo(a),c=i.distanceTo(o),h=s.distanceTo(o),u=s.distanceTo(a);n=l<Pt||c<Pt||h<Pt||u<Pt?Nt:Lt/l-Lt/c+Lt/h-Lt/u,n=Math.round(1e3*n)/1e3,n<Nt&&(n=Nt)}void 0===this._hbonds[t._index]&&(this._hbonds[t._index]={donor:[],acceptor:[]});const s=this._hbonds[t._index];s.acceptor.length<2&&s.acceptor.push({residue:r._index,energy:n}),s.acceptor.length>1&&(n<s.acceptor[0].energy?(s.acceptor[1].residue=s.acceptor[0].residue,s.acceptor[1].energy=s.acceptor[0].energy,s.acceptor[0].residue=r._index,s.acceptor[0].energy=n):n<s.acceptor[1].energy&&(s.acceptor[1].residue=r._index,s.acceptor[1].energy=n)),void 0===this._hbonds[r._index]&&(this._hbonds[r._index]={donor:[],acceptor:[]});const i=this._hbonds[r._index];return i.donor.length<2&&i.donor.push({residue:t._index,energy:n}),i.donor.length>1&&(n<i.donor[0].energy?(i.donor[1].residue=i.donor[0].residue,i.donor[1].energy=i.donor[0].energy,i.donor[0].residue=t._index,i.donor[0].energy=n):n<i.donor[1].energy&&(i.donor[1].residue=t._index,i.donor[1].energy=n)),n}}const Ot=Object.freeze({NO_BRIDGE:0,PARALLEL:1,ANTI_PARALLEL:2}),Vt=Object.freeze({START:1,MIDDLE:2,END:3,START_AND_END:4}),Dt=Object.freeze({STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",TURN:"T",BEND:"S",LOOP:" "});class kt{constructor(e){this._complex=e,this._build()}_build(){const e=this;this._hbonds=new It(this._complex),this._ss=[],this._sheet=[],this._betaPartners=[],this._bend=[];for(let e=0;e<this._complex.getResidues().length;++e)this._betaPartners[e]=[];this._helixFlags=[],this._helixFlags[3]=[],this._helixFlags[4]=[],this._helixFlags[5]=[],this._chainLengths=[];for(let e=0;e<this._complex._chains.length;++e){const t=this._complex._chains[e].getResidues();let r=0;for(;r<t.length&&0!=(t[r].getType().flags&Ee.Flags.PROTEIN);++r);this._chainLengths[e]=r}this._buildBetaSheets();for(let t=0;t<this._complex._chains.length;++t)e._buildAlphaHelices(this._complex._chains[t].getResidues(),this._chainLengths[t],!1)}_buildAlphaHelices(e,t,r){for(let r=3;r<=5&&!(e.length<r);++r)for(let n=0;n+r<t;++n)if(this._hbonds.isBond(e[n+r]._index,e[n]._index)){this._helixFlags[r][e[n+r]._index]=Vt.END;for(let t=n+1;t<n+r;++t)void 0===this._helixFlags[r][e[t]._index]&&(this._helixFlags[r][e[t]._index]=Vt.MIDDLE);this._helixFlags[r][e[n]._index]===Vt.END?this._helixFlags[r][e[n]._index]=Vt.START_AND_END:this._helixFlags[r][e[n]._index]=Vt.START}for(let r=2;r<t-2;++r){const t=this._kappa(e[r-2],e[r],e[r+2]);this._bend[e[r]._index]=360!==t&&t>70}for(let r=1;r+4<t;++r)if(this._isHelixStart(e[r]._index,4)&&this._isHelixStart(e[r-1]._index,4))for(let t=r;t<=r+3;++t)this._ss[e[t]._index]=Dt.HELIX_ALPHA;for(let r=1;r+3<t;++r)if(this._isHelixStart(e[r]._index,3)&&this._isHelixStart(e[r-1]._index,3)){let t=!0;for(let n=r;t&&n<=r+2;++n)t=void 0===this._ss[e[n]._index]||this._ss[e[n]._index]===Dt.HELIX_310;if(t)for(let t=r;t<=r+2;++t)this._ss[e[t]._index]=Dt.HELIX_310}for(let n=1;n+5<t;++n)if(this._isHelixStart(e[n]._index,5)&&this._isHelixStart(e[n-1]._index,5)){let t=!0;for(let s=n;t&&s<=n+4;++s)t=void 0===this._ss[e[s]._index]||this._ss[e[s]._index]===Dt.HELIX_PI||r&&this._ss[e[s]._index]===Dt.HELIX_ALPHA;if(t)for(let t=n;t<=n+4;++t)this._ss[e[t]._index]=Dt.HELIX_PI}for(let r=1;r+1<t;++r)if(void 0===this._ss[e[r]._index]){let t=!1;for(let n=3;n<=5&&!t;++n)for(let s=1;s<n&&!t;++s)t=r>=s&&this._isHelixStart(e[r-s]._index,n);t?this._ss[e[r]._index]=Dt.TURN:this._bend[e[r]._index]&&(this._ss[e[r]._index]=Dt.BEND)}}_residueGetCAlpha(e){for(let t=0;t<e._atoms.length;++t){const{name:r}=e._atoms[t];if("CA"===r||"C1"===r)return e._atoms[t].position}return null}_cosinusAngle(e,t,r,n){const s=e.clone().sub(t),i=r.clone().sub(n);let o=0;const a=s.dot(s)*i.dot(i);return a>0&&(o=s.dot(i)/Math.sqrt(a)),o}_kappa(e,t,r){const n=this._residueGetCAlpha(t),s=this._residueGetCAlpha(e),i=this._residueGetCAlpha(r);if(null===n||null===s||null===i)return 180;const o=this._cosinusAngle(n,s,i,n),a=Math.sqrt(1-o*o);return 180*Math.atan2(a,o)/Math.PI}_isHelixStart(e,t){return this._helixFlags[t][e]===Vt.START||this._helixFlags[t][e]===Vt.START_AND_END}_buildBetaSheets(){const e=[];for(let t=0;t<this._complex._chains.length;++t){const r=this._chainLengths[t];if(r<=4)continue;const n=this._complex._chains[t].getResidues();for(let s=t;s<this._complex._chains.length;++s){const i=this._chainLengths[s];if(i<=4)continue;const o=this._complex._chains[s].getResidues();for(let a=1;a+1<r;++a){const r=n[a];let l=1;for(s===t&&(l=a+3);l+1<i;++l){const t=o[l],s=this._testBridge(n,a,o,l);if(s===Ot.NO_BRIDGE)continue;let i=!1;for(const n of e)if(s===n.type&&r._index===n.i[n.i.length-1]+1){if(s===Ot.PARALLEL&&n.j[n.j.length-1]+1===t._index){n.i.push(r._index),n.j.push(t._index),i=!0;break}if(s===Ot.ANTI_PARALLEL&&n.j[0]-1===t._index){n.i.push(r._index),n.j.unshift(t._index),i=!0;break}}i||e.push({type:s,i:[r._index],chainI:r.getChain()._index,j:[t._index],chainJ:t.getChain()._index})}}}}e.sort(((e,t)=>e.chainI<t.chainI||e.chainI===t.chainI&&e.i[0]<t.i[0]?-1:1));for(let t=0;t<e.length;++t)for(let r=t+1;r<e.length;++r){const n=e[t].i[0],s=e[t].i[e[t].i.length-1],i=e[t].j[0],o=e[t].j[e[t].j.length-1],a=e[r].i[0],l=e[r].i[e[r].i.length-1],c=e[r].j[0],h=e[r].j[e[r].j.length-1];if(e[t].type!==e[r].type||this._hasChainBreak(Math.min(n,a),Math.max(s,l))||this._hasChainBreak(Math.min(i,c),Math.max(o,h))||a-s>=6||s>=a&&n<=l)continue;let u=!1;u=e[t].type===Ot.PARALLEL?c-o<6&&a-s<3||c-o<3:i-h<6&&a-s<3||i-h<3,u&&(e[t].i=e[t].i.concat(e[r].i),e[t].type===Ot.PARALLEL?e[t].j=e[t].j.concat(e[r].j):e[t].j=e[r].j.concat(e[t].j),e.splice(r--,1))}const t=new Set;for(let r=0;r<e.length;++r)t.add(e[r]);let r=1,n=0;for(;t.size>0;){let e=t.values().next().value;t.delete(e);const s=new Set;let i;s.add(e);do{i=new Set;for(const e of s.values())for(const r of t.values())this._areBridgesLinked(e,r)&&i.add(r);for(e of i.values())s.add(e),t.delete(e)}while(i.size>0);for(e of s.values())e.ladder=n,e.sheet=r,e.link=s,++n;++r}for(let t=0;t<e.length;++t){const r=e[t];let n=0,s=0;for(let e=0;e<r.i.length;++e)if(this._betaPartners[r.i[e]][0]){n=1;break}for(let e=0;e<r.j.length;++e)if(this._betaPartners[r.j[e]][0]){s=1;break}let i=Dt.BRIDGE;if(r.i.length>1&&(i=Dt.STRAND),r.type===Ot.PARALLEL){let e=0;for(let t=0;t<r.i.length;++t)this._betaPartners[r.i[t]][n]={residue:r.j[e++],ladder:r.ladder,parallel:!0};e=0;for(let t=0;t<r.j.length;++t)this._betaPartners[r.j[t]][s]={residue:r.i[e++],ladder:r.ladder,parallel:!0}}else{let e=r.j.length-1;for(let t=0;t<r.i.length;++t)this._betaPartners[r.i[t]][n]={residue:r.j[e--],ladder:r.ladder,parallel:!1};e=r.i.length-1;for(let t=0;t<r.j.length;++t)this._betaPartners[r.j[t]][s]={residue:r.i[e--],ladder:r.ladder,parallel:!1}}for(let e=r.i[0];e<=r.i[r.i.length-1];++e)this._ss[e]!==Dt.STRAND&&(this._ss[e]=i,this._sheet[e]=r.sheet);for(let e=r.j[0];e<=r.j[r.j.length-1];++e)this._ss[e]!==Dt.STRAND&&(this._ss[e]=i,this._sheet[e]=r.sheet)}}_testBridge(e,t,r,n){let s=Ot.NO_BRIDGE;const i=e[t-1]._index,o=e[t]._index,a=e[t+1]._index,l=r[n-1]._index,c=r[n]._index,h=r[n+1]._index,u=this._hbonds.isBond.bind(this._hbonds);return u(a,c)&&u(c,i)||u(h,o)&&u(o,l)?s=Ot.PARALLEL:(u(a,l)&&u(h,i)||u(c,o)&&u(o,c))&&(s=Ot.ANTI_PARALLEL),s}_areBridgesLinked(e,t){const r=new Set(e.i),n=new Set(e.j);for(const e of t.i)if(r.has(e)||n.has(e))return!0;for(const e of t.j)if(r.has(e)||n.has(e))return!0;return!1}_hasChainBreak(e,t){for(let r=e+1;r<=t;++r)if(this._complex._residues[r]._sequence!==this._complex._residues[r-1]._sequence+1)return!0;return!1}}kt.StructureType=Dt;const{StructureType:zt}=kt,Ft=Oe.Type,Bt={[zt.HELIX_ALPHA]:1,[zt.HELIX_PI]:3,[zt.HELIX_310]:5},Ut={[zt.BRIDGE]:Ft.BRIDGE,[zt.TURN]:Ft.TURN,[zt.BEND]:Ft.BEND,[zt.LOOP]:Ft.COIL};class Gt{constructor(){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._residueTypes=Object.create(Ee.StandardTypes),this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[],this._molecules=[],this._maskNeedsUpdate=!1,this.metadata={},this.symmetry=[],this.units=[new lt(this)],this._currentUnit=0}addAtom(e){const t=this._atoms.length;return this._atoms.push(e),t}addSheet(e){const t=this._sheets.length;return this._sheets.push(e),t}addHelix(e){const t=this._helices.length;return this._helices.push(e),t}getAtoms(){return this._atoms}getBonds(){return this._bonds}getAtomCount(){return this._atoms.length}addResidue(e){const t=this._residues.length;return this._residues.push(e),t}updateToFrame(e){this.forEachChain((t=>{t.updateToFrame(e)}))}addResidueType(e){return this._residueTypes[e]=new Ee(e,"Unknown","")}getResidueCount(){return this._residues.length}getResidues(){return this._residues}getSGroupCount(){return this._sgroups.length}getSGroups(){return this._sgroups}getAtomByFullname(e){const t=e.split(".");if(3!==t.length)return null;const r=t[0],n=parseInt(t[1],10);if(Number.isNaN(n))return null;const s=t[2].toUpperCase();let i=null;return this.forEachChain((e=>{i||0===e._name.localeCompare(r)&&e.forEachResidue((e=>{i||e._sequence===n&&e.forEachAtom((e=>{i||0===s.localeCompare(e.name)&&(i=e)}))}))})),i}addChain(e){const t=new Pe(this,e);return this._chains.push(t),t}getChain(e){for(let t=0,r=this._chains.length;t<r;++t){const r=this._chains[t];if(r.getName()===e)return r}return null}getChainCount(){return this._chains.length}getMolecules(){return this._molecules}getMoleculeCount(){return this._molecules.length}forEachAtom(e){const t=this._atoms;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachBond(e){const t=this._bonds;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachResidue(e){const t=this._residues;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachChain(e){const t=this._chains;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachMolecule(e){const t=this._molecules,r=t.length;for(let n=0;n<r;++n)e(t[n])}forEachSGroup(e){const t=this._sgroups;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachComponent(e){const t=this._components;for(let r=0,n=t.length;r<n;++r)e(t[r])}forEachVisibleComponent(e){const t=this._components;for(let r=0,n=t.length;r<n;++r)e(t[r])}addBond(e,t,r,n,s){const i=new _e(e,t,r,n,s);return this._bonds.push(i),i}getBondCount(){return this._bonds.length}getResidueType(e){return this._residueTypes[e]||null}getUnifiedSerial(e,t,r){return t+65536*r+16777216*e}splitUnifiedSerial(e){const t=65536,r=16777216,n=Math.floor(e/r),s=e-n*r,i=Math.floor(s/t);return{chain:n,serial:s-i*t,iCode:i}}_fillCmpEdit(){const e=this,t=this._components;function r(){const r=new ht(e);return r._index=t.length,t[r._index]=r,r}this.forEachChain((e=>{const t=e._residues,n=t.length;if(n<1)return;let s=r(),i=t[0]._index;for(let e=0;e<n;++e){const o=t[e];o._component=s;const a=e===n-1?null:t[e+1];a&&o.isConnected(a)&&o._index===a._index-1||(s.setSubDivs([{start:i,end:o._index}]),a&&(i=a._index,s=r()))}}))}_fillCmpNoedit(){const e=new ht(this);e._index=0;const t=this._residues,r=t.length;if(0===r)return;const n=[];let s=0;for(let i=0;i<r;++i){const o=t[i];o._component=e;const a=i===r-1?null:t[i+1];a&&o.isConnected(a)||(n[n.length]={start:s,end:i},a&&(s=i+1))}e.setSubDivs(n),this._components[e._index]=e}_fillComponents(e){e?this._fillCmpEdit():this._fillCmpNoedit()}getCurrentUnit(){return this._currentUnit}getDefaultBoundaries(){return this.units[0].getBoundaries()}getBoundaries(){return this.units[this._currentUnit].getBoundaries()}getTransforms(){return this.units[this._currentUnit].getTransforms()}getSelector(){return this.units[this._currentUnit].getSelector()}resetCurrentUnit(){this._currentUnit=0,this.setCurrentUnit(1)}setCurrentUnit(e){return null!=e&&e!==this._currentUnit&&e>=0&&e<this.units.length&&(this._currentUnit=e,!0)}_computeBounds(){const{units:e}=this;for(let t=0,r=e.length;t<r;++t)e[t].computeBoundaries()}onAtomPositionChanged(){this.forEachChain((e=>{e._finalize()})),this.forEachComponent((e=>{e.update()})),this._computeBounds(),this._finalizeBonds(),this.forEachSGroup((e=>{e._rebuildSGroupOnAtomChange()}))}update(){this._maskNeedsUpdate&&(this.updateStructuresMask(),this._maskNeedsUpdate=!1)}_finalizeBonds(){const e=this.getBonds(),t=e.length;for(let r=0;r<t;++r)e[r]._index=r}finalize(e){e=e||{};const t=this._bonds;let r,n;for(r=t.length-1;r>=0;r--){const e=t[r];null===e._left||null===e._right?t.splice(r,1):(e._left.bonds.push(e),e._right.bonds.push(e))}const s=this._residues;for(r=0,n=s.length;r<n;++r)s[r]._finalize();this.forEachChain((e=>{e._finalize()}));const{units:i}=this;for(r=0,n=i.length;r<n;++r)i[r].finalize();this.setCurrentUnit(1);const o={};for(r=0,n=s.length;r<n;++r){const e=s[r];o[this.getUnifiedSerial(e.getChain().getName().charCodeAt(0),e.getSequence(),e.getICode().charCodeAt(0))]=e}const{structures:a}=this;for(r=0,n=a.length;r<n;++r)a[r]._finalize(e.serialAtomMap,o,this);const l=this._helices;for(r=0,n=l.length;r<n;++r)l[r]._finalize(e.serialAtomMap,o,this);const c=this._sheets;for(r=0,n=c.length;r<n;++r)c[r]._finalize(e.serialAtomMap,o,this);this._computeBounds();const h=this._atoms;for(r=0,n=h.length;r<n;++r){h[r].index=r}if(e.needAutoBonding)try{const e=new pt(this);e.build(),e.destroy()}catch(e){}const u=this._chains;for(r=0,n=u.length;r<n;++r)u[r]._index=r;for(r=0,n=s.length;r<n;++r)s[r]._index=r;for(r=0,n=h.length;r<n;++r){const e=h[r];if(e.flags&he.Flags.HYDROGEN&&1===e.bonds.length){const t=e.bonds[0];(t._left!==e&&t._left||t._right).flags&he.Flags.CARBON&&(e.flags|=he.Flags.NONPOLARH)}}this._finalizeBonds(),this._fillComponents(e.enableEditing);const d=new At(this);d.markCycles(),e.detectAromaticLoops&&d.detectCycles(),this._finalizeMolecules()}_finalizeMolecules(){for(let e=0;e<this._molecules.length;e++){const t=this._molecules[e],r=t.residues.length;for(let e=0;e<r;e++){t.residues[e]._molecule=t}}}updateStructuresMask(){const e=e=>e.collectMask();this.forEachResidue(e),this.forEachChain(e),this.forEachMolecule(e)}countAtomsByMask(e){let t=0;return this.forEachAtom((r=>{0!=(r.mask&e)&&t++})),t}getNumAtomsBySelector(e){let t=0;return this.forEachAtom((r=>{e.includesAtom(r)&&t++})),t}resetAtomMask(e){this.forEachAtom((t=>{t.mask=e}))}markAtoms(e,t){const r=t,n=~r;let s=0;const i=at.keyword("And")(e,this.getSelector());return this.forEachAtom((e=>{i.includesAtom(e)?(e.mask|=r,s++):e.mask&=n})),this._maskNeedsUpdate=!0,s}markAtomsAdditionally(e,t){const r=t;let n=0;return this.forEachAtom((s=>{e.includesAtom(s)&&(s.mask&t)!==t&&(s.mask|=r,n++)})),n}clearAtomBits(e){const t=~e;this.forEachAtom((e=>{e.mask&=t}));const r=e=>{e._mask&=t};this.forEachAtom(r),this.forEachResidue(r),this.forEachChain(r),this.forEachMolecule(r)}getAtomNames(){if(this.hasOwnProperty("_atomNames"))return this._atomNames;const e={};return this.forEachAtom((t=>{e[t.name]=1})),this._atomNames=Object.keys(e),this._atomNames}getElements(){if(this.hasOwnProperty("_elements"))return this._elements;const e={};return this.forEachAtom((t=>{e[t.element.name]=1})),this._elements=Object.keys(e),this._elements}getResidueNames(){if(this.hasOwnProperty("_residueNames"))return this._residueNames;const e={};return this.forEachResidue((t=>{e[t._type._name]=1})),this._residueNames=Object.keys(e),this._residueNames}getChainNames(){if(this.hasOwnProperty("_chainNames"))return this._chainNames;const e={};return this.forEachChain((t=>{e[t._name]=1})),this._chainNames=Object.keys(e),this._chainNames}getAltLocNames(){if(this.hasOwnProperty("_altlocNames"))return this._altlocNames;const e={};return this.forEachAtom((t=>{e[String.fromCharCode(t.location)]=1})),this._altlocNames=Object.keys(e),this._altlocNames}getVoxelWorld(){if(!this.hasOwnProperty("_voxelWorld"))try{this._voxelWorld=new Mt(this.getDefaultBoundaries().boundingBox,new r.Vector3(5,5,5)),this._voxelWorld.addAtoms(this)}catch(e){w.warn("Unable to create voxel world"),this._voxelWorld=null}return this._voxelWorld}addElement(e,t,r,n){const{length:s}=e;for(let i=0;i<s;++i){const s=e[i];n(s,r),t.push(s)}}joinComplexes(e){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[];const t=this;let r=0,n=0,s=0,i=0,o=0;function a(e,t){e.serial+=t,e.index+=t}function l(e,t){e._index+=t}function c(e,t){e._index+=t}function h(e,r){e._complex=t,e._index+=r}function u(e,r){e._complex=t,e._index+=r}function d(){}for(let t=0;t<e.length;++t){const p=e[t];this.addElement(p._atoms,this._atoms,r,a),this.addElement(p._bonds,this._bonds,n,l),this.addElement(p._residues,this._residues,s,c),this.addElement(p._chains,this._chains,i,h),this.addElement(p._sheets,this._sheets,0,d),this.addElement(p._helices,this._helices,0,d),this.addElement(p._sgroups,this._sgroups,0,d),this.addElement(p._components,this._components,o,u),this.addElement(p.structures,this.structures,0,d);for(const e in p._residueTypes)p._residueTypes.hasOwnProperty(e)&&(this._residueTypes[e]=p._residueTypes[e]);r+=p._atoms.length,n+=p._bonds.length,s+=p._residues.length,i+=p._chains.length,o+=p._components.length}this._computeBounds()}dssp(){const e=new kt(this),t=this.structures=[],r=this._helices=[],n=this._sheets=[],s=e=>{let t=n[e];return t||(t=n[e]=new Fe(String(e),0)),t};let i,o,a=0,l=null;for(let n=0,c=this._residues.length;n<c;++n){const c=e._ss[n],h=this._residues[n],u=e._sheet[n];if(c===i&&u===o){h._secondary=l,l&&(l.term=h),l instanceof ke&&l.length++;continue}const d=Bt[c],p=Ut[c];if(c===zt.STRAND){const e=s(u);l=new ze(e,h,h,0,null,null),e.addStrand(l)}else void 0!==d?(a++,l=new ke(d,h,h,a,String(a),"",1),r.push(l)):l=void 0!==p?new Oe(p,h,h):null;l&&t.push(l),h._secondary=l,i=c,o=u}this._sheets=n.filter((e=>!0))}}Gt.prototype.id="Complex",Gt.prototype.name="";const jt=Gt;function Ht(e){let t=2;for(e=e-1>>1;e;)t<<=1,e>>=1;return t}class $t{constructor(e,t,r,n,s,i){switch(this._box=r.clone(),this._dimVec=Math.max(Math.floor(n||1),1),this._volumeInfo=i,t instanceof Array?[this._dimX,this._dimY,this._dimZ]=t:(this._dimX=t.x,this._dimY=t.y,this._dimZ=t.z),this._dimX=Math.max(Math.floor(this._dimX),1),this._dimY=Math.max(Math.floor(this._dimY),1),this._dimZ=Math.max(Math.floor(this._dimZ),1),this._rowElements=this._dimVec*this._dimX,this._planeElements=this._rowElements*this._dimY,this._totalElements=this._planeElements*this._dimZ,this._data=s||O.allocateTyped(e,this._totalElements),this._dimVec){case 1:break;case 2:this.getValue=function(e,t,r){const n=e*this._dimVec+t*this._rowElements+r*this._planeElements;return[this._data[n],this._data[n+1]]},this.setValue=function(e,t,r,n,s){const i=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[i]=n,this._data[i+1]=s},this.addValue=function(e,t,r,n,s){const i=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[i]+=n,this._data[i+1]+=s};break;case 3:this.getValue=function(e,t,r){const n=e*this._dimVec+t*this._rowElements+r*this._planeElements;return[this._data[n],this._data[n+1],this._data[n+2]]},this.setValue=function(e,t,r,n,s,i){const o=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[o]=n,this._data[o+1]=s,this._data[o+2]=i},this.addValue=function(e,t,r,n,s,i){const o=e*this._dimVec+t*this._rowElements+r*this._planeElements;this._data[o]+=n,this._data[o+1]+=s,this._data[o+2]+=i};break;default:throw new Error("Volume: invalid vector dimension")}}getValue(e,t,r){return this._data[e+t*this._rowElements+r*this._planeElements]}setValue(e,t,r,n){this._data[e+t*this._rowElements+r*this._planeElements]=n}addValue(e,t,r,n){this._data[e+t*this._rowElements+r*this._planeElements]+=n}getDimensions(){return[this._dimX,this._dimY,this._dimZ]}getBox(){return this._box}getVolumeInfo(){return this._volumeInfo}getCellSize(){const e=new r.Vector3;this._box.getSize(e);const t=new r.Vector3;return t.x=this._dimX>1?e.x/(this._dimX-1):0,t.y=this._dimY>1?e.y/(this._dimY-1):0,t.z=this._dimZ>1?e.z/(this._dimZ-1):0,t}computeGradient(){if(1!==this._dimVec)return null;const e=new $t(Float32Array,[this._dimX,this._dimY,this._dimZ],this._box,3),t=this.getCellSize(),n=new r.Vector3(-.5/t.x,-.5/t.y,-.5/t.z);function s(e,t,r){return Math.min(r,Math.max(t,e))}const i=this._dimX,o=this._dimY,a=this._dimZ,l=this._data;function c(e,t,r){return l[r*i*o+t*i+e]}for(let t=0;t<a;++t){const r=s(t-1,0,a-1),l=s(t+1,0,a-1);for(let a=0;a<o;++a){const h=s(a-1,0,o-1),u=s(a+1,0,o-1);for(let o=0;o<i;++o){const d=s(o-1,0,i-1),p=s(o+1,0,i-1);e.setValue(o,a,t,(c(p,a,t)-c(d,a,t))*n.x,(c(o,u,t)-c(o,h,t))*n.y,(c(o,a,l)-c(o,a,r))*n.z)}}}return e}normalize(){const e=this._data;let t=e[0],r=e[0];for(let n=1;n<e.length;++n)t=Math.min(t,e[n]),r=Math.max(r,e[n]);const n=1/(r-t);if(0!==n)for(let r=0;r<e.length;++r)e[r]=n*(e[r]-t)}getTiledTextureStride(){return[this._dimX+2,this._dimY+2]}buildTiledTexture(){let e=Math.ceil(Math.sqrt(this._dimZ*this._dimY/this._dimX)),t=e*(this._dimX+2)-1;t=Ht(t),e=Math.floor(t/(this._dimX+2));const n=Math.ceil(this._dimZ/e);let s=n*(this._dimY+2)-1;s=Ht(s);const i=new Uint8Array(t*s);let o,a;for(let r=0;r<n;++r)for(let n=0;n<this._dimY;++n){o=r*e*this._planeElements+n*this._rowElements,a=t*(r*(this._dimY+2)+n);for(let t=0;t<e;++t){for(let e=0;e<this._dimX;++e)i[a++]=255*this._data[o++];i[a++]=255*this._data[o-1],t<e-1&&(o+=this._planeElements-this._rowElements,i[a++]=255*this._data[o])}}for(let e=0;e<n;++e){o=t*(e*(this._dimY+2)+this._dimY-1),a=o+t;for(let e=0;e<t;++e)i[a++]=i[o++];if(e<n-1){o=t*(e+1)*(this._dimY+2),a=o-t;for(let e=0;e<t;++e)i[a++]=i[o++]}}const l=new r.DataTexture(i,t,s,r.LuminanceFormat,r.UnsignedByteType,r.UVMapping,r.ClampToEdgeWrapping,r.ClampToEdgeWrapping,r.LinearFilter,r.LinearFilter);return l.needsUpdate=!0,l}getData(){return this._data}getDirectIdx(e,t,r){return e*this._dimVec+t*this._rowElements+r*this._planeElements}getStrideX(){return this._dimVec}getStrideY(){return this._rowElements}getStrideZ(){return this._planeElements}}$t.prototype.id="Volume";const Wt=$t;const Yt={Atom:he,Element:de,Bond:_e,Residue:Se,ResidueType:Ee,Chain:Pe,Helix:ke,Strand:ze,Sheet:Fe,SGroup:Be,Assembly:ct,Complex:jt,Volume:Wt,VoxelWorld:Mt,selectors:at,Molecule:class{constructor(e,t,r){this.complex=e,this.name=t||"",this.residues=[],this.mask=1,this.index=r||-1}forEachResidue(e){const{residues:t}=this;for(let r=0,n=t.length;r<n;++r)e(t[r])}collectMask(){let e=4294967295;const{residues:t}=this;for(let r=0,n=t.length;r<n;++r)e&=t[r]._mask;this.mask=e}}};class Xt extends r.Object3D{constructor(e){super();const t=this;this._element=e,this._element.style.position="absolute",this.addEventListener("removed",(()=>{null!==t._element.parentNode&&t._element.parentNode.removeChild(t._element)}))}getElement(){return this._element}setTransparency(e){const t=this.getElement();if(null===t)return;if(1===e)return void(t.style.display="none");t.style.display="inline";const r=1-e,n=r.toString(),s=100*r;t.style.opacity=n,t.style.filter=`alpha(opacity=${s})`}clone(){const e=new Xt(this._element);return e.copy(this),e}}const qt=Xt;class Zt extends r.Group{raycast(e,t){if(!this.visible)return;const{children:r}=this;for(let n=0,s=r.length;n<s;++n)r[n].raycast(e,t)}enableSubset(e,t){const{children:r}=this;for(let n=0,s=r.length;n<s;++n)r[n].enableSubset&&r[n].enableSubset(e,t)}disableSubset(e,t){const{children:r}=this;for(let n=0,s=r.length;n<s;++n)r[n].disableSubset&&r[n].disableSubset(e,t)}isEmpty(){return 0===this.children.length}updateToFrame(e){const{children:t}=this;for(let r=0,n=t.length;r<n;++r)t[r].updateToFrame&&t[r].updateToFrame(e)}getSubset(e,t){const r=[],{children:n}=this;for(let s=0,i=n.length;s<i;++s)n[s].getSubset&&Array.prototype.push.apply(r,n[s].getSubset(e,t));return r}}const Kt=Zt,Qt="uniform mat4 projectionMatrix;\r\nuniform mat4 modelViewMatrix;\r\n\r\nattribute vec2 uv;\r\nattribute vec3 position;\r\n\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vUv = uv;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n}\r\n",Jt={DEFAULT:0,VOLUME:1,TRANSPARENT:2,PREPASS_TRANSPARENT:3,VOLUME_BFPLANE:4,COLOR_FROM_POSITION:5,SHADOWMAP:6},er=[Jt.DEFAULT,Jt.TRANSPARENT];r.Object3D.prototype.resetTransform=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.scale.set(1,1,1)},r.Object3D.prototype.updateMatrixWorldRecursive=function(){null!=this.parent&&this.parent.updateMatrixWorldRecursive(),this.updateMatrixWorld()},r.Object3D.prototype.addSavingWorldTransform=function(){const e=new r.Matrix4;return function(t){t instanceof r.Object3D&&(e.copy(this.matrixWorld).invert(),e.multiply(t.matrixWorld),t.matrix.copy(e),t.matrix.decompose(t.position,t.quaternion,t.scale),this.add(t))}}(),r.WebGLRenderer.prototype.renderDummyQuad=function(){const e=new r.MeshBasicMaterial({transparent:!0,opacity:0,depthWrite:!1}),t=new r.Scene,n=new r.Mesh(new r.PlaneGeometry(.01,.01),e);t.add(n);const s=new r.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return s.position.z=100,function(){this.render(t,s)}}(),r.WebGLRenderer.prototype.renderScreenQuad=function(){const e=new r.Scene,t=new r.Mesh(new r.PlaneGeometry(1,1));e.add(t);const n=new r.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(r){t.material=r,this.render(e,n)}}(),r.Matrix4.prototype.isIdentity=function(){const e=new r.Matrix4;return function(){return e.equals(this)}}(),r.Matrix4.prototype.applyToPointsArray=function(e,t,r){if(!e||!t||t<3)return e;r=r||0;const n=this.elements;for(let s=0;s<e.length;s+=t){const t=e[s],i=e[s+1],o=e[s+2],a=1/(n[3]*t+n[7]*i+n[11]*o+n[15]);e[s]=(n[0]*t+n[4]*i+n[8]*o+n[12]*r)*a,e[s+1]=(n[1]*t+n[5]*i+n[9]*o+n[13]*r)*a,e[s+2]=(n[2]*t+n[6]*i+n[10]*o+n[14]*r)*a}return e};class tr extends r.RawShaderMaterial{constructor(e){void 0===e.uniforms&&(e.uniforms={}),e.uniforms.srcTex={type:"t",value:null},e.vertexShader=Qt,e.transparent=!1,e.depthTest=!1,e.depthWrite=!1,super(e)}}function rr(e){e.traverse((e=>{(e instanceof r.Mesh||e instanceof r.LineSegments||e instanceof r.Line)&&e.geometry.dispose()})),function(e){const{children:t}=e;for(let e=0,r=t.length;e<r;++e){const r=t[e];r.parent=null,r.dispatchEvent({type:"removed"})}e.children=[]}(e)}r.WebGLRenderer.prototype.renderScreenQuadFromTex=function(){const e=new tr({uniforms:{opacity:{type:"f",value:1}},fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform float opacity;\r\n\r\nvoid main() {\r\n  vec4 color = texture2D(srcTex, vUv);\r\n  gl_FragColor = vec4(color.xyz, color.a * opacity);\r\n}\r\n",transparent:!0});return function(t,r){e.uniforms.srcTex.value=t,e.transparent=r<1,e.uniforms.opacity.value=r,this.renderScreenQuad(e)}}(),r.WebGLRenderer.prototype.renderScreenQuadFromTexWithDistortion=function(){const e=new tr({uniforms:{coef:{type:"f",value:1}},fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform float coef;\r\n\r\nvoid main() {\r\n  vec2 uv = vUv * 2.0 - 1.0;\r\n  float r2 = dot(uv, uv);\r\n  vec2 tc = uv * (1.0 + coef * r2);\r\n  if (!all(lessThan(abs(tc), vec2(1.0))))\r\n    discard;\r\n  tc = 0.5 * (tc + 1.0);\r\n  gl_FragColor = texture2D(srcTex, tc);\r\n}\r\n"});return function(t,r){e.uniforms.srcTex.value=t,e.uniforms.coef.value=r,this.renderScreenQuad(e)}}(),r.PerspectiveCamera.prototype.setMinimalFov=function(e){this.aspect>=1?this.fov=e:this.fov=r.MathUtils.radToDeg(2*Math.atan(Math.tan(.5*r.MathUtils.degToRad(e))/this.aspect))},r.StereoCamera.prototype.updateHalfSized=function(e,t){const r=e.aspect,n=e.fov;e.aspect=r/2,e.setMinimalFov(t),e.updateProjectionMatrix(),this.update(e),e.aspect=r,e.fov=n,e.updateProjectionMatrix()},r.PerspectiveCamera.prototype.setDistanceToFit=function(e,t){this.position.z=e/Math.sin(.5*r.MathUtils.degToRad(t))},r.Raycaster.prototype.intersectVisibleObject=function(e,t,n,s){const i=this.intersectObject(e,!1);if(0===i.length)return null;const o=Math.min(t.near,n);let a,l=i[0];const c=new r.Vector3;for(a=0;a<i.length&&(l=i[a],c.copy(l.point),c.applyMatrix4(t.matrixWorldInverse),!(c.z<=-o));++a);if(a===i.length)return null;const h=Math.min(t.far,s);return c.copy(l.point),c.applyMatrix4(t.matrixWorldInverse),c.z<=-h?null:l},r.Matrix4.prototype.extractScale=function(){const e=new r.Vector3;return function(t){void 0===t&&(w.debug("extractScale(): new is too expensive operation to do it on-the-fly"),t=e.clone());const r=this.elements;t.x=e.set(r[0],r[1],r[2]).length(),t.y=e.set(r[4],r[5],r[6]).length(),t.z=e.set(r[8],r[9],r[10]).length();return this.determinant()<0&&(t.x=-t.x),t}}(),r.BufferAttribute.prototype.copyAtList=function(e,t){const{itemSize:r}=this;for(let n=0,s=t.length;n<s;++n)for(let s=0;s<r;++s)this.array[n*r+s]=e.array[t[n]*r+s];return this};const nr=r.InstancedBufferGeometry.prototype.copy;r.InstancedBufferGeometry.prototype.copy=function(e){nr.call(this,e),void 0===this.instanceCount&&(this.instanceCount=1/0)};const sr={calcCylinderMatrix:function(e,t,n){const s=e.clone().lerp(t,.5),i=new r.Matrix4;i.makeScale(n,e.distanceTo(t),n);const o=new r.Matrix4;o.makeRotationX(Math.PI/2);const a=new r.Matrix4,l=new r.Vector3(0,1,0);return a.lookAt(s,t,l),a.multiply(o),a.multiply(i),a.setPosition(s),a},calcChunkMatrix:function(e,t,n,s){const i=new r.Matrix4;i.makeScale(s.x,s.y,0);const o=new r.Matrix4;return o.lookAt(e,t,n),o.multiply(i),o.setPosition(e),o},groupHasGeometryToRender:function(e){let t=!1;return e.traverse((e=>{(e.hasOwnProperty("geometry")||e instanceof qt)&&(t=!0)})),t},buildDistorionMesh:function(e,t,n){function s(e){let t=0,r=e,s=1;for(;Math.abs(r-t)>1e-5;)s=1+n*r,t=r,r=e/(s*s);return 1/s}const i=new r.PlaneGeometry(2,2,e,t),o=i.getAttribute("position");for(let e=0;e<o.count;++e){const t=o.array[3*e],r=o.array[3*e+1],n=s(t*t+r*r);o.setXY(e,n*t,n*r)}return i},RCGroup:Kt,fillArray:function(e,t,r,n){r=void 0!==r?r:0,n=void 0!==n?n:e.length;for(let s=r;s<n;++s)e[s]=t},clearTree:rr,destroyObject:function(e){rr(e),e.parent?e.parent.remove(e):e.dispatchEvent({type:"removed"})},belongToSelectLayers:function(e){for(let t=0;t<er.length;t++)if(1==(e.layers.mask>>er[t]&1))return!0;return!1},processObjRenderOrder:function(e,t){const r=+("BA"!==t);e.traverse((e=>{e.isGroup&&(e.renderOrder=r)}))},applySelectionMaterial:function(e){e.traverse((e=>{"material"in e&&(e.material=e.material.clone(!0),e.material.setValues({depthFunc:r.LessEqualDepth,overrideColor:!0,fog:!1,lights:!1,shadowmap:!1}),e.material.setUberOptions({fixedColor:new r.Color(16776960),zOffset:-1e-6}))}))},getMiddlePoint:function(e,t,n){const s=n||new r.Vector3;return s.set(0,0,0),s.addScaledVector(e,.5),s.addScaledVector(t,.5),s},LAYERS:Jt},ir={boundingBox:new r.Box3(new r.Vector3(-1,-1,-1),new r.Vector3(1,1,1)),boundingSphere:new r.Sphere(new r.Vector3(0,0,0),1)};class or extends sr.RCGroup{constructor(e,t){super(e,t),this.name=e,this._dataSource=t}release(){this.parent&&this.parent.remove(this)}getDataSource(){return this._dataSource}getBoundaries(){return ir}}const ar=or;function lr(e){return null==e||Array.isArray(e)?e:[e]}class cr{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["id"];this._list=[],this._dict={},this._indices=[...t],this._indices.forEach((e=>{this._dict[e]={}})),e.forEach((e=>this.register(e)))}static registerInList(e,t){e.includes(t)||e.push(t)}static unregisterFromList(e,t){const r=e.indexOf(t);-1!==r&&e.splice(r,1)}static registerInDict(e,t,r){t.forEach((t=>{t=t.toLowerCase();const n=e[t]=e[t]||[];n.includes(r)||n.push(r)}))}static unregisterFromDict(e,t,r){t.forEach((t=>{t=t.toLowerCase();const n=e[t];if(n){const s=n.indexOf(r);-1!==s&&n.splice(s,1),0===n.length&&delete e[t]}}))}register(e){cr.registerInList(this._list,e),this._indices.forEach((t=>{cr.registerInDict(this._dict[t],lr(e[t]),e)}))}unregister(e){cr.unregisterFromList(this._list,e),this._indices.forEach((t=>{cr.unregisterFromDict(this._dict[t],lr(e[t]),e)}))}get all(){return[...this._list]}get first(){return this._list[0]}keys(e){return Object.keys(this._dict[e||this._indices[0]])}get(e,t){const r=this._dict[t||this._indices[0]];if(r){const t=r[e&&e.toLowerCase()];return t&&t.length>0?t[0]:void 0}}}const hr=cr;const ur=function(e){Object.defineProperties(e,{logger:{get(){return this.context&&this.context.logger?this.context.logger:w}},settings:{get(){return this.context&&this.context.settings?this.context.settings:z}}})};class dr{constructor(e,t){this._position=e,this._radius=t}static _sphere=(()=>new r.Sphere)();raycast(e){const t=dr._sphere;t.set(this._position,this._radius);const n=new r.Vector3;return e.ray.intersectSphere(t,n)?{distance:e.ray.origin.distanceTo(n),point:n}:null}}const pr=e=>class extends e{constructor(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];super(...r),this._objects=new Array(e),this.boundingSphere=null,this.boundingBox=null}setSphere(e,t,r){this._objects[e]=new dr(t,r)}raycast(e,t){for(let r=0,n=this._objects.length;r<n;++r){const n=this._objects[r].raycast(e);n&&(n.chunkIdx=r,t.push(n))}}computeBoundingBox(){const e=this._objects;let{boundingBox:t}=this;null===t&&(this.boundingBox=t=new r.Box3),t.makeEmpty();for(let r=0,n=e.length;r<n;++r)t.expandByPoint(e[r]._position)}computeBoundingSphere(){this.computeBoundingBox();const e=this._objects,{boundingBox:t}=this;let n=0;const s=new r.Vector3;t.getCenter(s);for(let t=0,r=e.length;t<r;++t){const r=e[t]._position,i=s.distanceToSquared(r);n<i&&(n=i)}null===this.boundingSphere&&(this.boundingSphere=new r.Sphere),this.boundingSphere.set(s,Math.sqrt(n))}},mr=new r.Color,{copySubArrays:fr}=O;class _r extends(pr(r.InstancedBufferGeometry)){constructor(e,t,n){super(e),this._sphGeometry=n?new r.PlaneGeometry(2,2,1,1):new r.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI),this._init(e,this._sphGeometry)}setItem(e,t,r){var n,s,i,o,a,l;n=this._offsets,s=4*e,i=t.x,o=t.y,a=t.z,l=r,n[s]=i,n[s+1]=o,n[s+2]=a,n[s+3]=l,this.setSphere(e,t,r)}setColor(e,t){var r,n,s,i,o;mr.set(t),r=this._colors,n=3*e,s=mr.r,i=mr.g,o=mr.b,r[n]=s,r[n+1]=i,r[n+2]=o}startUpdate(){return!0}finishUpdate(){this.getAttribute("offset").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}finalize(){this.finishUpdate(),this.computeBoundingSphere()}setOpacity(e,t){const r=this._alpha;for(let n=0,s=e.length;n<s;++n)r[e[n]]=t;this.getAttribute("alphaColor").needsUpdate=!0}getSubset(e){const t=e.length,n=new r.InstancedBufferGeometry;return this._init.call(n,t,this._sphGeometry),fr(this._offsets,n._offsets,e,4),fr(this._colors,n._colors,e,3),n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}_init(e,n){this.copy(n),this._offsets=O.allocateTyped(Float32Array,4*e),this._colors=O.allocateTyped(Float32Array,3*e);const s=this._alpha=O.allocateTyped(Float32Array,e);t().fill(s,1),this.setAttribute("offset",new r.InstancedBufferAttribute(this._offsets,4,!1,1)),this.setAttribute("color",new r.InstancedBufferAttribute(this._colors,3,!1,1)),this.setAttribute("alphaColor",new r.InstancedBufferAttribute(s,1,!1,1))}}const gr=_r,yr=new r.Color;class xr extends r.BufferGeometry{constructor(e,t){if(super(),this.constructor===xr)throw new Error("Can not instantiate abstract class!");this._chunkGeo=e,this._init(e,t)}startUpdate(){return!0}finishUpdate(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("normal").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}setColor(e,t){yr.set(t);const r=this._colors,n=this._chunkSize;for(let t=e*n,s=t+n;t<s;++t){const e=3*t;r[e]=yr.r,r[e+1]=yr.g,r[e+2]=yr.b}}finalize(){this.finishUpdate(),this.computeBoundingSphere()}setOpacity(e,r){const n=this._alpha,s=this._chunkSize;for(let i=0,o=e.length;i<o;++i){const o=e[i]*s;t().fill(n,r,o,o+s)}this.getAttribute("alphaColor").needsUpdate=!0}raycast(e,t){const n=[],s=new r.Mesh;s.geometry=this,s.raycast(e,n);const i=this._chunkGeo.index.count/3;for(let e=0,r=n.length;e<r;++e)n[e].hasOwnProperty("faceIndex")&&(n[e].chunkIdx=Math.floor(n[e].faceIndex/i),t.push(n[e]))}getSubset(e){const t=e.length,n=new r.BufferGeometry;this._init.call(n,this._chunkGeo,t);const s=this._positions,i=this._normals,o=this._colors,a=n._positions,l=n._normals,c=n._colors,h=3*this._chunkSize;for(let t=0,r=e.length;t<r;++t){const r=t*h,n=e[t]*h,u=n+h;a.set(s.subarray(n,u),r),l.set(i.subarray(n,u),r),c.set(o.subarray(n,u),r)}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}_init(e,n){const s=this._chunkSize=e.attributes.position.count,i=e.index.array,o=i.length,a=this._chunkSize*n,l=a>65535,c=o*n,h=this._index=O.allocateTyped(l?Uint32Array:Uint16Array,c);this._positions=O.allocateTyped(Float32Array,3*a),this._normals=O.allocateTyped(Float32Array,3*a),this._colors=O.allocateTyped(Float32Array,3*a);const u=this._alpha=O.allocateTyped(Float32Array,a);t().fill(u,1);for(let e=0;e<n;++e){const t=e*o,r=e*s;h.set(i,t);for(let e=0;e<o;++e)h[t+e]+=r}this.setIndex(new r.BufferAttribute(this._index,1)),this.setAttribute("position",new r.BufferAttribute(this._positions,3)),this.setAttribute("normal",new r.BufferAttribute(this._normals,3)),this.setAttribute("color",new r.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new r.BufferAttribute(u,1))}}const br=xr;class wr extends(pr(br)){constructor(e,t){const n=new r.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI);super(e,n,e);const s=this._normals,i=n.attributes.normal.array,o=this._chunkSize;this._chunkPos=this._chunkGeo.attributes.position.array,this._tmpPositions=O.allocateTyped(Float32Array,3*o);for(let t=0;t<e;++t)s.set(i,3*o*t)}setItem(e,t,r){const n=this._tmpPositions,s=this._chunkSize,i=this._chunkPos;for(let e=0;e<s;++e){const s=3*e;n[s]=t.x+i[s]*r,n[s+1]=t.y+i[s+1]*r,n[s+2]=t.z+i[s+2]*r}this._positions.set(n,s*e*3),this.setSphere(e,t,r)}}const Sr=wr,vr=new r.Vector3,Cr=new r.Vector3,Ar=new r.Matrix3;const Er=class extends br{constructor(e,t){super(new r.CylinderGeometry(1,1,1,Math.max(3,t),2,!0),2*e);const n=this._chunkSize;this._chunkPos=this._chunkGeo.attributes.position.array,this._chunkNorms=this._chunkGeo.attributes.normal.array,this._tmpVector=O.allocateTyped(Float32Array,3*n)}setItem(e,t,r,n){const s=this._chunkSize,i=2*s*e*3,o=i+3*s,a=this._tmpVector,l=this._chunkPos,c=this._chunkNorms;vr.lerpVectors(t,r,.5);const h=sr.calcCylinderMatrix(t,vr,n);let u;Ar.getNormalMatrix(h);for(let e=0;e<s;++e)u=3*e,Cr.fromArray(l,u),Cr.applyMatrix4(h),Cr.toArray(a,u);this._positions.set(a,i),vr.sub(t);for(let e=0;e<s;++e)u=3*e,a[u]+=vr.x,a[u+1]+=vr.y,a[u+2]+=vr.z;this._positions.set(a,o);for(let e=0;e<s;++e)u=3*e,Cr.fromArray(c,u),Cr.applyMatrix3(Ar),Cr.toArray(a,u);this._normals.set(a,i),this._normals.set(a,o)}setColor(e,t,r){const n=2*e;super.setColor(n,t);const s=n+1;super.setColor(s,r)}};class Tr extends r.BufferGeometry{constructor(e,t,n,s,i,o){super();const a=2*Math.PI;this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:s,heightSegments:i,openEnded:o};const l=!1===o&&e>0,c=!1===o&&t>0,h=(i+1)*s+l*(s+1)+c*(s+1),u=(2*i+l+c)*s,d=n/2,p=new r.BufferAttribute(O.allocateTyped(Float32Array,3*h),3),m=new r.BufferAttribute(O.allocateTyped(Float32Array,3*h),3),f=new r.Uint16BufferAttribute(O.allocateTyped(Uint16Array,3*u),1),_=new r.BufferAttribute(O.allocateTyped(Float32Array,2*h),2);let g=0,y=0;const x=-(t-e)/n;for(let o=0;o<=i;o++){if(o!==i)for(let e=0;e<s;e++){const t=g+e,r=g+s+e,n=g+s+(e+1)%s,i=g+(e+1)%s;f.setXYZ(3*y,t,i,r),y++,f.setXYZ(3*y,r,i,n),y++}const l=o/i,c=l*(t-e)+e;for(let e=0;e<s;e++){const t=e/s,i=c*Math.sin(t*a+0),o=l*n-d,h=c*Math.cos(t*a+0),u=new r.Vector3(i,Math.sqrt(i*i+h*h)*x,h).normalize();p.setXYZ(g,i,o,h),m.setXYZ(g,u.x,u.y,u.z),_.setXY(g,t,l),++g}}if(l){const e=g,t=g+s;for(let r=0;r<s;++r){const n=g-s;p.setXYZ(g,p.getX(n),p.getY(n),p.getZ(n)),m.setXYZ(g,0,1,0),_.setXY(g,1,1);const i=e+(r+1)%s;f.setXYZ(3*y,g,i,t),y++,g++}p.setXYZ(g,0,d,0),m.setXYZ(g,0,1,0),_.setXY(g,1,1),++g}if(c){const e=g,t=g+s;for(let r=0;r<s;++r){const n=r;p.setXYZ(g,p.getX(n),p.getY(n),p.getZ(n)),m.setXYZ(g,0,-1,0),_.setXY(g,0,0);const i=e+(r+1)%s;f.setXYZ(3*y,i,g,t),y++,g++}p.setXYZ(g,0,-d,0),m.setXYZ(g,0,-1,0),_.setXY(g,0,0)}this.setIndex(f),this.setAttribute("position",p),this.setAttribute("normal",m),this.setAttribute("uv",_)}clone(){const{parameters:e}=this;return new Tr(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded)}}const Rr=Tr,Mr=new r.Color,Pr=new r.Matrix4,{copySubArrays:Nr}=O;function Lr(e,t,r,n,s){e[t]=r,e[t+1]=n,e[t+2]=s}function Ir(e,t,r,n,s,i){e[t]=r,e[t+1]=n,e[t+2]=s,e[t+3]=i}function Or(e,t){return e-t}class Vr extends r.InstancedBufferGeometry{constructor(e,t,n,s){super(),this._useZSprites=n,this._cylGeometry=n?new r.PlaneGeometry(2,2,1,1):new Rr(1,1,1,Math.max(3,t),2,s),this._init(e,this._cylGeometry,this._useZSprites),this._collisionGeo=new Er(e,3)}setItem(e,t,r,n){const s=sr.calcCylinderMatrix(t,r,n);let i=s.elements;const o=4*e;this._collisionGeo.setItem(e,t,r,n),Ir(this._matVector1,o,i[0],i[4],i[8],i[12]),Ir(this._matVector2,o,i[1],i[5],i[9],i[13]),Ir(this._matVector3,o,i[2],i[6],i[10],i[14]),this._useZSprites&&(Pr.copy(s).invert(),i=Pr.elements,Ir(this._invmatVector1,o,i[0],i[4],i[8],i[12]),Ir(this._invmatVector2,o,i[1],i[5],i[9],i[13]),Ir(this._invmatVector3,o,i[2],i[6],i[10],i[14]))}setColor(e,t,r){const n=3*e;Mr.set(t),Lr(this._color1,n,Mr.r,Mr.g,Mr.b),Mr.set(r),Lr(this._color2,n,Mr.r,Mr.g,Mr.b)}computeBoundingSphere(){this._collisionGeo.computeBoundingSphere(),this.boundingSphere=this._collisionGeo.boundingSphere}computeBoundingBox(){this._collisionGeo.computeBoundingBox(),this.boundingBox=this._collisionGeo.boundingBox}raycast(e,t){this._collisionGeo.raycast(e,t)}startUpdate(){return!0}finishUpdate(){this.getAttribute("matVector1").needsUpdate=!0,this.getAttribute("matVector2").needsUpdate=!0,this.getAttribute("matVector3").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("color2").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this._useZSprites&&(this.getAttribute("invmatVector1").needsUpdate=!0,this.getAttribute("invmatVector2").needsUpdate=!0,this.getAttribute("invmatVector3").needsUpdate=!0),this._collisionGeo.finishUpdate()}finalize(){this.finishUpdate(),this.computeBoundingSphere()}setOpacity(e,t){const r=this._alpha;for(let n=0,s=e.length;n<s;++n)r[Math.floor(e[n]/2)]=t;this.getAttribute("alphaColor").needsUpdate=!0}getSubset(e){const t=function(e){e.sort(Or);const t=[],r=[];for(let n=0,s=e.length;n<s;++n){const i=e[n],o={first:!1,second:!1};(0|i)%2==0?(o.first=!0,o.second=n+1<s&&e[n+1]===e[n]+1,o.second&&++n):o.second=!0,t.push(Math.floor(i/2)),r.push(o)}return{indices:t,cylinderInfo:r}}(e),n=t.indices,s=n.length,i=new r.InstancedBufferGeometry;return this._init.call(i,s,this._cylGeometry,this._useZSprites),Nr(this._matVector1,i._matVector1,n,4),Nr(this._matVector2,i._matVector2,n,4),Nr(this._matVector3,i._matVector3,n,4),this._useZSprites&&(Nr(this._invmatVector1,i._invmatVector1,n,4),Nr(this._invmatVector2,i._invmatVector2,n,4),Nr(this._invmatVector3,i._invmatVector3,n,4)),Nr(this._color1,i._color1,n,3),Nr(this._color2,i._color2,n,3),function(e,t,r){for(let n=0,s=e.length;n<s;++n){const s=e[n];s.first||(t[3*n]=-.5),s.second||(r[3*n]=-.5)}}(t.cylinderInfo,i._color1,i._color2),i.boundingSphere=this.boundingSphere,i.boundingBox=this.boundingBox,[i]}getGeoParams(){return this._cylGeometry.parameters}_init(e,n,s){this.copy(n),this._matVector1=O.allocateTyped(Float32Array,4*e),this._matVector2=O.allocateTyped(Float32Array,4*e),this._matVector3=O.allocateTyped(Float32Array,4*e),this._color1=O.allocateTyped(Float32Array,3*e),this._color2=O.allocateTyped(Float32Array,3*e);const i=this._alpha=O.allocateTyped(Float32Array,e);t().fill(i,1),this.setAttribute("matVector1",new r.InstancedBufferAttribute(this._matVector1,4,!1,1)),this.setAttribute("matVector2",new r.InstancedBufferAttribute(this._matVector2,4,!1,1)),this.setAttribute("matVector3",new r.InstancedBufferAttribute(this._matVector3,4,!1,1)),this.setAttribute("color",new r.InstancedBufferAttribute(this._color1,3,!1,1)),this.setAttribute("color2",new r.InstancedBufferAttribute(this._color2,3,!1,1)),this.setAttribute("alphaColor",new r.InstancedBufferAttribute(this._alpha,1,!1,1)),s&&(this._invmatVector1=O.allocateTyped(Float32Array,4*e),this._invmatVector2=O.allocateTyped(Float32Array,4*e),this._invmatVector3=O.allocateTyped(Float32Array,4*e),this.setAttribute("invmatVector1",new r.InstancedBufferAttribute(this._invmatVector1,4,!1,1)),this.setAttribute("invmatVector2",new r.InstancedBufferAttribute(this._invmatVector2,4,!1,1)),this.setAttribute("invmatVector3",new r.InstancedBufferAttribute(this._invmatVector3,4,!1,1)))}}const Dr=Vr,kr=new r.Vector3,zr=new r.Vector3,Fr=new r.Vector3,Br=new r.Vector3(1,0,0),Ur=new r.Vector3,Gr=new r.Vector3;const jr=class extends br{constructor(e,t,n){const s=function(e,t){const n=new r.BufferGeometry,s=e.length,i=s*t,o=i<=65536?Uint16Array:Uint32Array,a=(t-1)*s*2,l=new r.BufferAttribute(O.allocateTyped(o,3*a),1);let c=0,h=0;for(let e=0;e<t;e++){if(e!==t-1)for(let e=0;e<s;e++){const t=c+e,r=c+s+e,n=c+s+(e+1)%s,i=c+(e+1)%s;l.setXYZ(3*h,t,i,r),h++,l.setXYZ(3*h,r,i,n),h++}c+=s}n.setIndex(l);const u=O.allocateTyped(Float32Array,3*i);return n.setAttribute("position",new r.BufferAttribute(u,3)),n._positions=e,n}(e,t);super(s,n),this._ringsCount=t;const i=this._tmpShape=[];for(let t=0;t<e.length;++t)i[t]=new r.Vector3}setItem(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=this._chunkGeo._positions.length,i=this._ringsCount,o=s*this._ringsCount*e*3;this._setPoints(t,s,i,o),r?this._setSlopeNormals(s,i,o):this._setBaseNormals(s,i,o),n&&this._addCut(s,i,o)}_setPoints(e,t,r,n){const s=this._tmpShape,i=this._positions,o=this._chunkGeo._positions;for(let a=0,l=n;a<r;++a){const r=e[a];for(let e=0;e<t;++e,l+=3)s[e].copy(o[e]).applyMatrix4(r).toArray(i,l)}}_setBaseNormals(e,t,r){const n=3*e;for(let s=0,i=r;s<t;++s,i+=n)this._countNormalsInRing(e,i,!1)}_setSlopeNormals(e,t,r){const n=this._normals,s=3*e;let i=r;for(let t=0;t<e;++t,i+=3)Br.toArray(n,i);if(i-2*s>0)for(let t=0;t<e;++t,i+=3)Fr.fromArray(n,i-2*s).toArray(n,i);else this._countNormalsInRing(e,i,!0,+s),i+=s;for(let r=2;r<t;++r,i+=s)this._countNormalsInRing(e,i,!0,-s)}_countNormalsInRing(e,t,r,n){const s=this._tmpShape,i=this._normals;s[0].fromArray(this._positions,t),s[e-1].fromArray(this._positions,t+3*(e-1));for(let o=0;o<e;++o,t+=3)o<e-1&&s[o+1].fromArray(this._positions,t+3),r?(Gr.fromArray(this._positions,t+n),kr.subVectors(s[(o+e-1)%e],s[(o+1)%e]).normalize(),zr.subVectors(s[o],Gr).normalize(),Fr.crossVectors(zr,kr).normalize().toArray(i,t)):(kr.subVectors(s[o],s[(o+e-1)%e]).normalize(),zr.subVectors(s[o],s[(o+1)%e]).normalize(),Fr.addVectors(kr,zr).normalize().toArray(i,t))}_addCut(e,t,r){if(e<3||t<2)return;const n=this._positions,s=this._normals,i=this._tmpShape,o=3*e;i[0].fromArray(n,r),i[1].fromArray(n,r+3),i[2].fromArray(n,r+6),kr.subVectors(i[1],i[0]).normalize(),zr.subVectors(i[1],i[2]).normalize(),Ur.crossVectors(kr,zr).normalize();let a=r;for(let t=0;t<2*e;++t,a+=3)Ur.toArray(s,a);if(t>2)for(let t=0;t<e;++t,a+=3)Fr.fromArray(n,a-o).toArray(n,a)}},Hr=new r.Color,$r=new r.Vector3;function Wr(e,t,r,n,s){e[t]=r,e[t+1]=n,e[t+2]=s}function Yr(e,t,r,n,s,i){e[t]=r,e[t+1]=n,e[t+2]=s,e[t+3]=i}function Xr(e,t,r,n){const s=4*t,i=s+4*r;return e.subarray(s*n,i*n)}class qr extends r.BufferGeometry{constructor(e){super(),this._initVertices(e)}startUpdate(){return!0}finishUpdate(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this.getAttribute("direction").needsUpdate=!0}setColor(e,t){Hr.set(t);let r=4*e*3;Wr(this._colors,r,Hr.r,Hr.g,Hr.b),r+=3,Wr(this._colors,r,Hr.r,Hr.g,Hr.b),r+=3,Wr(this._colors,r,Hr.r,Hr.g,Hr.b),r+=3,Wr(this._colors,r,Hr.r,Hr.g,Hr.b)}setSegment(e,t,r){$r.subVectors(t,r),$r.normalize();const n=this._positions,s=this._directions;let i=4*e*4,o=4*e*3;Yr(n,i,t.x,t.y,t.z,.5),Wr(s,o,$r.x,$r.y,$r.z),i+=4,o+=3,Yr(n,i,t.x,t.y,t.z,-.5),Wr(s,o,$r.x,$r.y,$r.z),i+=4,o+=3,Yr(n,i,r.x,r.y,r.z,.5),Wr(s,o,$r.x,$r.y,$r.z),i+=4,o+=3,Yr(n,i,r.x,r.y,r.z,-.5),Wr(s,o,$r.x,$r.y,$r.z)}setOpacity(e,r,n){const s=4*e,i=4*r;t().fill(this.alpha,n,i,s),this.getAttribute("alphaColor").needsUpdate=!0}getSubsetSegments(e,t){return[Xr(this._positions,e,t,4),Xr(this._directions,e,t,3)]}getSubsetColors(e,t){return Xr(this._colors,e,t,3)}getSubsetOpacities(e,t){return Xr(this._alpha,e,t,1)}getNumVertexPerSegment(){return 4}getPositionSize(){return 4}setSegments(e,t){const r=4*e*4;if(t instanceof Array&&2===t.length){this._positions.set(t[0],r);const n=4*e*3;this._directions.set(t[1],n)}else this._positions.set(t,r)}setColors(e,t){const r=4*e*3;this._colors.set(t,r)}_initVertices(e){this._buffersSize=4*e;const n=this._buffersSize,s=n>65535;this._index=O.allocateTyped(s?Uint32Array:Uint16Array,6*e),this._positions=O.allocateTyped(Float32Array,4*n),this._colors=O.allocateTyped(Float32Array,3*n),this._directions=O.allocateTyped(Float32Array,3*n);const i=this._alpha=O.allocateTyped(Float32Array,n);t().fill(i,1);const o=this._index;let a=0,l=0;for(let t=0;t<e;t++,a+=6,l+=4)o[a]=l,o[a+1]=l+1,o[a+2]=l+3,o[a+3]=l,o[a+4]=l+2,o[a+5]=l+3;this.setIndex(new r.BufferAttribute(this._index,1)),this.setAttribute("position",new r.BufferAttribute(this._positions,4)),this.setAttribute("color",new r.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new r.BufferAttribute(i,1)),this.setAttribute("direction",new r.BufferAttribute(this._directions,3))}}const Zr=qr;const Kr=class extends Zr{startUpdate(){return!0}computeBoundingSphere(){const{boundingBox:e}=this;let t=0;const n=new r.Vector3;e&&e.getCenter(n);const s=this._positions,i=this.boundingSphere||new r.Sphere,o=this._positions.length,a=new r.Vector3,l=this.getPositionSize();for(let e=0;e<o;e+=l){a.set(s[e],s[e+1],s[e+2]);const r=n.distanceToSquared(a);t<r&&(t=r)}i.set(n,Math.sqrt(t)),this.boundingSphere=i}computeBoundingBox(){const e=this._positions,t=new r.Box3,n=this._positions.length,s=new r.Vector3,i=this.getPositionSize();for(let r=0;r<n;r+=i)s.set(e[r],e[r+1],e[r+2]),t.expandByPoint(s);this.boundingBox=t}finalize(){this.finishUpdate(),this.computeBoundingSphere()}},Qr=new r.Vector3,Jr=new r.Matrix3;const en=class extends br{constructor(e,t){super(new r.CylinderGeometry(1,1,1,Math.max(3,t),2,!0),e);const n=this._chunkSize;this._chunkPos=this._chunkGeo.attributes.position.array,this._chunkNorms=this._chunkGeo.attributes.normal.array,this._tmpVector=O.allocateTyped(Float32Array,3*n)}setItem(e,t,r,n){const s=this._chunkSize,i=s*e*3,o=this._tmpVector,a=this._chunkPos,l=this._chunkNorms,c=sr.calcCylinderMatrix(t,r,n);let h;Jr.getNormalMatrix(c);for(let e=0;e<s;++e)h=3*e,Qr.fromArray(a,h),Qr.applyMatrix4(c),Qr.toArray(o,h);this._positions.set(o,i);for(let e=0;e<s;++e)h=3*e,Qr.fromArray(l,h),Qr.applyMatrix3(Jr),Qr.toArray(o,h);this._normals.set(o,i)}};class tn extends Kr{constructor(e,t,r){super(e*t),this._init(t),this._collisionGeo=r?new en(e*t,3):null}startUpdate(){return!0}computeBoundingSphere(){const e=this._collisionGeo;if(e)return e.computeBoundingSphere(),void(this.boundingSphere=e.boundingSphere);super.computeBoundingSphere()}computeBoundingBox(){const e=this._collisionGeo;if(e)return e.computeBoundingBox(),void(this.boundingBox=e.boundingBox);super.computeBoundingBox()}raycast(e,t){if(!this._collisionGeo)return;const r=this._chunkSize;this._collisionGeo.raycast(e,t);for(let e=0,n=t.length;e<n;++e){let{chunkIdx:n}=t[e];void 0!==n&&(n=n/r|0,t[e].chunkIdx=n)}}setColor(e,t){const r=this._chunkSize;for(let n=e*r,s=n+r;n<s;++n)super.setColor(n,t)}setSegment(e,t,r,n){const s=this._chunkSize,i=e*s+t;super.setSegment(i,r,n),this._collisionGeo&&this._collisionGeo.setItem(e*s+t,r,n,.1)}finalize(){this.finishUpdate(),this.computeBoundingSphere()}setOpacity(e,t){const r=this._chunkSize;for(let n=0,s=e.length;n<s;++n){const s=e[n]*r;super.setOpacity(s,s+r-1,t)}}getSubset(e){const t=e.length,r=this._chunkSize,n=new tn(t,r,!1);for(let t=0,s=e.length;t<s;++t){const s=t*r,i=e[t]*r;n.setSegments(s,this.getSubsetSegments(i,r)),n.setColors(s,this.getSubsetColors(i,r))}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}_init(e){this._chunkSize=e}}const rn=tn,nn=new r.Vector3;class sn extends Kr{constructor(e){super(2*e),this._init(e),this._collisionGeo=new Er(e,3)}setItem(e,t,r){this._collisionGeo.setItem(e,t,r,.3);const n=2*e;nn.lerpVectors(t,r,.5),super.setSegment(n,t,nn),super.setSegment(n+1,nn,r)}setColor(e,t,r){const n=2*e;super.setColor(n,t),super.setColor(n+1,r)}raycast(e,t){this._collisionGeo&&this._collisionGeo.raycast(e,t)}getSubset(e){const t=e.length,r=new sn(t,!1);for(let n=0,s=t;n<s;++n){const t=e[n];r.setSegments(n,this.getSubsetSegments(t,1)),r.setColors(n,this.getSubsetColors(t,1))}return r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}_init(e){this._segCounts=2*e}}const on=sn,an=[new r.Vector3(1,0,0),new r.Vector3(-1,0,0),new r.Vector3(0,1,0),new r.Vector3(0,-1,0),new r.Vector3(0,0,1),new r.Vector3(0,0,-1)],ln=an.length,cn=new r.Vector3,hn=new r.Vector3;class un extends(pr(rn)){constructor(e){super(e,e,ln/2|0,!1)}setItem(e,t,r){this.setSphere(e,t,r);for(let n=0;n<ln/2;++n){const s=2*n;cn.x=t.x+an[s].x*r,cn.y=t.y+an[s].y*r,cn.z=t.z+an[s].z*r;const i=s+1;hn.x=t.x+an[i].x*r,hn.y=t.y+an[i].y*r,hn.z=t.z+an[i].z*r,this.setSegment(e,n,cn,hn)}}}const dn=un,pn=new r.Color;class mn extends r.BufferGeometry{constructor(e,t){super(),this._opts=t,this.zClip=this._opts.zClip,this._posRad=O.allocateTyped(Float32Array,4*e),this._colors=O.allocateTyped(Float32Array,3*e)}setItem(e,t,r){const n=this._posRad;let s=4*e;n[s++]=t.x,n[s++]=t.y,n[s++]=t.z,n[s]=r}setColor(e,t){pn.set(t);const r=this._colors;let n=3*e;r[n++]=pn.r,r[n++]=pn.g,r[n]=pn.b}finalize(){this.finishUpdate(),this.computeBoundingSphere()}finishUpdate(){this._build()}setOpacity(){}raycast(){}getSubset(){return[]}}const fn=mn;class _n{constructor(){this.pointsValuesLinear=null,this.hasIntersection=null,this.bitsInside=null}create(e){const t=e*e*e;if(t>117440512)throw new Error("Too large cube dimension: lead to memory huge uasge");return this.pointsValuesLinear=O.allocateTyped(Float32Array,32*t),this.hasIntersection=O.allocateTyped(Int32Array,t),this.bitsInside=O.allocateTyped(Int32Array,t),0}destroy(){this.bitsInside=null,this.hasIntersection=null,this.pointsValuesLinear=null}}_n.prototype.striIndicesMarchCube=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];const gn=_n,yn=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0];function xn(e,t,r){const n=e.getValue(t.x,t.y,t.z);r.set(n[0],n[1],n[2])}class bn{constructor(){this._arrSize=8,this.p=new Array(this._arrSize),this.g=new Array(this._arrSize),this.val=new Array(this._arrSize);for(let e=0;e<this._arrSize;++e)this.p[e]=new r.Vector3,this.g[e]=new r.Vector3;this.cubeIndex=0}}class wn{constructor(){this.a={p:new r.Vector3,n:new r.Vector3},this.b={p:new r.Vector3,n:new r.Vector3},this.c={p:new r.Vector3,n:new r.Vector3}}}function Sn(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=new r.Vector3;return t}class vn{constructor(){this._numTriangles=0,this._numVertices=0,this._position=[],this._normals=[],this._colors=null,this._indices=[],this._volumetricData=null,this._xAxis=new r.Vector3,this._yAxis=new r.Vector3,this._zAxis=new r.Vector3,this._xDir=new r.Vector3,this._yDir=new r.Vector3,this._zDir=new r.Vector3}_prepareAxesAndDirs(){const e=this._volumetricData.getCellSize(),t=this._xAxis,n=this._yAxis,s=this._zAxis,i=this._xDir,o=this._yDir,a=this._zDir;t.set(e.x,0,0),n.set(0,e.y,0),s.set(0,0,e.z),i.set(1,0,0),o.set(0,1,0),a.set(0,0,1);const l=new r.Vector3;if(l.crossVectors(i,o),l.dot(a)<0&&(i.negate(),o.negate(),a.negate()),i.x<0||i.y<0||i.z<0||o.x<0||o.y<0||o.z<0||a.x<0||a.y<0||a.z<0)return!1;const c=e=>Math.abs(e)>Number.EPSILON;return!(c(t.y)||c(t.z)||c(n.x)||c(n.z)||c(s.x)||c(s.y))}_vertexInterp(e,t,r,n,s,i){const o=t.p[r],a=t.p[n],l=t.g[r],c=t.g[n],h=t.val[r],u=e-h,d=t.val[n]-h;let p=0;Math.abs(d)>0&&(p=u/d),p=p>1?1:p,s.lerpVectors(o,a,p),i.lerpVectors(l,c,p)}static _triTable=(()=>gn.prototype.striIndicesMarchCube)();static _arrSize=12;static _firstIndices=[0,1,2,3,4,5,6,7,0,1,2,3];static _secondIndices=[1,2,3,0,5,6,7,4,4,5,6,7];static _vertexList=(()=>Sn(vn._arrSize))();static _normalList=(()=>Sn(vn._arrSize))();_polygonize(e,t,r){const{cubeIndex:n}=e;let s=0;const i=vn._arrSize,o=vn._firstIndices,a=vn._secondIndices,l=vn._vertexList,c=vn._normalList;for(;s<i;++s)yn[n]&1<<s&&this._vertexInterp(t,e,o[s],a[s],l[s],c[s]);let h=0;const u=16*n,d=vn._triTable;for(s=0;-1!==d[u+s];s+=3)r[h].a.p.copy(l[d[u+s]]),r[h].a.n.copy(c[d[u+s]]),r[h].b.p.copy(l[d[u+s+1]]),r[h].b.n.copy(c[d[u+s+1]]),r[h].c.p.copy(l[d[u+s+2]]),r[h].c.n.copy(c[d[u+s+2]]),++h;return h}_doGridPosNorms(e,t,n){const s=this._volumetricData,i=this._volumetricData.getData(),o=s.getDimensions(),a=o[0],l=o[1],c=o[2],h=t*s.getStrideX(),u=t*s.getStrideY(),d=t*s.getStrideZ(),p=new bn,m=p.val,f=p.val.length,_=[new r.Vector3(0,0,0),new r.Vector3(t,0,0),new r.Vector3(t,t,0),new r.Vector3(0,t,0),new r.Vector3(0,0,t),new r.Vector3(t,0,t),new r.Vector3(t,t,t),new r.Vector3(0,t,t)],g=new Array(5);for(let e=0;e<5;++e)g[e]=new wn;let y;const x=this,b=this._position,w=this._normals;y=n?function(){const e=new r.Vector3(x._xAxis.x,x._yAxis.y,x._zAxis.z);return function(t){const r=t.p.clone();r.multiply(e),b.push(r.add(x._origin)),w.push(t.n.clone())}}():function(){const e=new r.Matrix3;e.set(x._xAxis.x,x._yAxis.x,x._zAxis.x,x._xAxis.y,x._yAxis.y,x._zAxis.y,x._xAxis.z,x._yAxis.z,x._zAxis.z);const t=new r.Matrix3;return t.set(x._xDir.x,x._yDir.x,x._zDir.x,x._xDir.y,x._yDir.y,x._zDir.y,x._xDir.z,x._yDir.z,x._zDir.z),function(r){b.push(r.p.clone().applyMatrix3(e).add(x._origin)),w.push(r.n.clone().applyMatrix3(t))}}();const S=this._indices;let v=0;for(let r=0;r<c-t;r+=t)for(let n=0;n<l-t;n+=t){let o=s.getDirectIdx(0,n,r);for(let s=0;s<a-t;s+=t,o+=h){m[0]=i[o],m[1]=i[o+h],m[3]=i[o+u],m[2]=i[o+h+u],m[4]=i[o+d],m[5]=i[o+h+d],m[7]=i[o+u+d],m[6]=i[o+h+u+d];let t=0,a=0;for(;a<f;++a)m[a]<e&&(t|=1<<a);if(0===yn[t])continue;for(p.cubeIndex=t,a=0;a<f;++a)p.p[a].set(s+_[a].x,n+_[a].y,r+_[a].z),xn(this._gradient,p.p[a],p.g[a]);const l=this._polygonize(p,e,g);for(v+=l,a=0;a<l;++a)S.push(3*this._numTriangles),S.push(3*this._numTriangles+1),S.push(3*this._numTriangles+2),++this._numTriangles,y(g[a].a),y(g[a].b),y(g[a].c)}}return v}compute(e,t,r,n){this._volumetricData=e,this._origin=t,this._gradient=e.computeGradient(),this._doGridPosNorms(r,n,this._prepareAxesAndDirs())}_remapIndices(e,t){const r=this._indices,n=O.allocateTyped(Uint32Array,t);for(let s=0;s<t;++s)r[s]=e[r[s]],n[s]=r[s];this._indices=n}_remapVertices(e,t,r){const n=O.allocateTyped(Float32Array,3*r),s=O.allocateTyped(Float32Array,3*r);for(let i=0;i<r;++i){const r=e[i];n[3*i]=r.x,n[3*i+1]=r.y,n[3*i+2]=r.z;const o=t[i].normalize();s[3*i]=o.x,s[3*i+1]=o.y,s[3*i+2]=o.z}this._position=n,this._normals=s}vertexFusion(e,t){const r=this._indices.length,n=this._position,s=this._normals,i=0|n.length;if(0===r||0===i)return;const o=O.allocateTyped(Uint32Array,i);o[0]=0;let a=1,l=1;for(;l<i;++l){const r=a-e<0?0:a-e,i=r+t>a?a:r+t;let c=-1;for(let e=r;e<i;++e)if(Math.abs(n[l]-n[e])<Number.EPSILON){c=e;break}-1!==c?o[l]=c:(n[a].copy(n[l]),s[a].copy(s[l]),o[l]=a,++a)}this._remapIndices(o,r),this._remapVertices(n,s,a)}setColorVolTex(e,t,r,n){let s,i;const o=this._position.length/3,a=this._position,l=this._origin,c=this._volumetricData.getDimensions(),h=c[0]-1,u=c[1]-1,d=c[2]-1,p=e.getData(),m=e.getStrideX(),f=e.getStrideY(),_=e.getStrideZ();let g,y,x,b;null!==n&&(g=r.getData(),y=r.getStrideX(),x=r.getStrideY(),b=r.getStrideZ());const w=1/this._xAxis.x,S=1/this._yAxis.y,v=1/this._zAxis.z;let C=[],A=[];const E=O.allocateTyped(Float32Array,3*o);function T(e,t,r,n){n[0]=(1-e)*p[t]+e*p[r],n[1]=(1-e)*p[t+1]+e*p[r+1],n[2]=(1-e)*p[t+2]+e*p[r+2]}function R(e,r,n,s){const i=t[e];if(null!=i){C[i.index]=i;const t=r*n*s*g[e];void 0===A[i.index]?A[i.index]=t:A[i.index]+=t}}const M=O.allocateTyped(Int32Array,o);let P=0;for(s=0;s<o;s++){const t=3*s,o=(a[t]-l.x)*w,c=(a[t+1]-l.y)*S,p=(a[t+2]-l.z)*v,g=0|Math.min(Math.max(o,0),h),N=0|Math.min(Math.max(c,0),u),L=0|Math.min(Math.max(p,0),d),I=o-g,O=c-N,V=p-L;if(null!=n){C=[],A=[],i=r.getDirectIdx(g,N,L),R(i,1-I,1-O,1-V),R(i+y,I,1-O,1-V),R(i+x,1-I,O,1-V),R(i+y+x,I,O,1-V),R(i+b,1-I,1-O,V),R(i+y+b,I,1-O,V),R(i+x+b,1-I,O,V),R(i+y+x+b,I,O,V);let e=0,t=-1;for(const r in A)A[r]>e&&(t=r,e=A[r]);if(t<0||!n.includesAtom(C[t])){M[s]=-1;continue}}M[s]=P++;const D=g<h?m:0,k=N<u?f:0,z=L<d?_:0,F=[0,0,0],B=[0,0,0],U=[0,0,0],G=[0,0,0];i=e.getDirectIdx(g,N,L),T(I,i,i+D,F),T(I,i+k,i+D+k,B),T(I,i+z,i+D+z,U),T(I,i+k+z,i+D+k+z,G);const j=[0,0,0];j[0]=(1-O)*F[0]+O*B[0],j[1]=(1-O)*F[1]+O*B[1],j[2]=(1-O)*F[2]+O*B[2];const H=[0,0,0];H[0]=(1-O)*U[0]+O*G[0],H[1]=(1-O)*U[1]+O*G[1],H[2]=(1-O)*U[2]+O*G[2],E[t]=(1-V)*j[0]+V*H[0],E[t+1]=(1-V)*j[1]+V*H[1],E[t+2]=(1-V)*j[2]+V*H[2]}if(this._colors=E,null!=n){for(s=0;s<o;++s){const e=M[s];e<0||(this._position[3*e]=this._position[3*s],this._position[3*e+1]=this._position[3*s+1],this._position[3*e+2]=this._position[3*s+2],this._normals[3*e]=this._normals[3*s],this._normals[3*e+1]=this._normals[3*s+1],this._normals[3*e+2]=this._normals[3*s+2],this._colors[3*e]=this._colors[3*s],this._colors[3*e+1]=this._colors[3*s+1],this._colors[3*e+2]=this._colors[3*s+2])}const e=this._indices.length/3;let t=0;for(s=0;s<e;++s){const e=M[this._indices[3*s]],r=M[this._indices[3*s+1]],n=M[this._indices[3*s+2]];e>=0&&r>=0&&n>=0&&(this._indices[3*t]=e,this._indices[3*t+1]=r,this._indices[3*t+2]=n,++t)}this._position=new Float32Array(this._position.buffer.slice(0,3*P*4)),this._normals=new Float32Array(this._normals.buffer.slice(0,3*P*4)),this._colors=new Float32Array(this._colors.buffer.slice(0,3*P*4)),this._indices=new Uint32Array(this._indices.buffer.slice(0,3*t*4))}}toMesh(){const e=new r.BufferGeometry;return e.setIndex(new r.BufferAttribute(this._indices,1)),e.setAttribute("position",new r.BufferAttribute(this._position,3)),e.setAttribute("normal",new r.BufferAttribute(this._normals,3)),e.setAttribute("color",new r.BufferAttribute(this._colors,3)),e.computeBoundingSphere(),e}}const Cn=vn;const An=class extends fn{_build(){const e=this._opts;this.numVoxels=[128,128,128],this.xAxis=new r.Vector3(1,0,0),this.yAxis=new r.Vector3(0,1,0),this.zAxis=new r.Vector3(0,0,1),this.origin=new r.Vector3(0,0,0),this._visibilitySelector=e.visibilitySelector,this._calcSurface(e)}_findMinMax(e){const t=e.length/4,r=[e[0],e[1],e[2],e[3]],n=[e[0],e[1],e[2],e[3]];for(let s=1;s<t;++s){const t=4*s;for(let s=0;s<4;++s){const i=e[t+s];r[s]=Math.max(i,r[s]),n[s]=Math.min(i,n[s])}}return{maxPosRad:r,minPosRad:n}}_findNumVoxels(e,t){const{numVoxels:r}=this,n=this._findMinMax(e),s=n.minPosRad,i=n.maxPosRad;s[3]>4&&(t.gridSpacing*=s[3]);let o=t.radScale*i[3]*1.7,a=o;a=.65*Math.sqrt(4/3*Math.PI*a*a*a),o=Math.max(o,a);let l=0;for(;l<3;++l)s[l]-=o,i[l]+=o;for(l=0;l<3;++l)r[l]=Math.ceil((i[l]-s[l])/t.gridSpacing);return this.xAxis.x=(r[0]-1)*t.gridSpacing,this.yAxis.y=(r[1]-1)*t.gridSpacing,this.zAxis.z=(r[2]-1)*t.gridSpacing,[this.origin.x,this.origin.y,this.origin.z]=s,{bbox:n,dim:r}}_makeSurface(e,t){const n=new Cn;n.compute(e.volMap,this.origin,t.isoValue,1),n.vertexFusion(9,9),n._numTriangles>0?(n.setColorVolTex(e.volTexMap,e.atomMap,e.atomWeightMap,this._visibilitySelector),this.setIndex(new r.BufferAttribute(n._indices,1)),this.setAttribute("position",new r.BufferAttribute(n._position,3)),this.setAttribute("normal",new r.BufferAttribute(n._normals,3)),this.setAttribute("color",new r.BufferAttribute(n._colors,3))):this.setAttribute("position",new r.BufferAttribute(O.allocateTyped(Float32Array,0),3))}_calcSurface(e){const t={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};if(0===t.posRad.length)return;const n=this._findNumVoxels(t.posRad,e),s=new r.Box3(this.origin,new r.Vector3(this.xAxis.x,this.yAxis.y,this.zAxis.z).add(this.origin)),i=this._computeSurface(t,s,n,e);this._makeSurface(i,e)}},{Volume:En}=Yt;const Tn=class extends An{_computeSurface(e,t,r,n){this._shiftByOrigin(e.posRad);const s={volMap:new En(Float32Array,this.numVoxels,t),volTexMap:new En(Float32Array,this.numVoxels,t,3)};return null!=this._visibilitySelector&&(s.atomMap=[],s.atomWeightMap=new En(Float32Array,this.numVoxels,t)),this.gaussdensity(s,e,null,n),s}gaussdensity(e,t,r,n){const s=t.posRad.length/4,{posRad:i,colors:o}=t,{numVoxels:a}=this,{radScale:l,gaussLim:c,gridSpacing:h}=n,u=1/n.isoValue,d=1/h,p=a[0]-1,m=a[1]-1,f=a[2]-1,{volMap:_,volTexMap:g}=e,y=_.getData(),x=_.getStrideX(),b=g.getData(),w=g.getStrideX();let S;null!=this._visibilitySelector&&(S=e.atomWeightMap.getData());const{atomMap:v}=e;for(let e=0;e<s;++e){const n=4*e,s=i[n+3]*l,a=null===r?1:r[e],C=1/(2*s*s);let A=c*s;const E=A*A;A*=d;let T=i[n]*d;const R=Math.max(T-A|0,0),M=Math.min(T+A|0,p);T=i[n+1]*d;const P=Math.max(T-A|0,0),N=Math.min(T+A|0,m);T=i[n+2]*d;const L=Math.max(T-A|0,0),I=Math.min(T+A|0,f);let O=L*h-i[n+2];for(let r=L;r<=I;++r,O+=h){let s=P*h-i[n+1];for(let l=P;l<=N;++l,s+=h){const c=s*s+O*O;if(c>=E)continue;let d=_.getDirectIdx(R,l,r),p=g.getDirectIdx(R,l,r),m=R*h-i[n];for(let r=R;r<=M;++r,m+=h,d+=x,p+=w){const r=-(m*m+c)*C;let n=Math.exp(r)*a;null!=this._visibilitySelector&&n>S[d]&&(S[d]=n,v[d]=t.atoms[e]),y[d]+=n,n*=u;const s=3*e;b[p]+=n*o[s],b[p+1]+=n*o[s+1],b[p+2]+=n*o[s+2]}}}}}_shiftByOrigin(e){const t=this.origin.x,r=this.origin.y,n=this.origin.z,s=e.length/4;for(let i=0;i<s;++i){const s=4*i;e[s]-=t,e[s+1]-=r,e[s+2]-=n}}};function Rn(e,t,r,n){const s=e.length/4,i=t[0],o=t[1],a=t[2],l=r[0],c=r[1],h=r[2];function u(e,t){return Math.floor((e-t)/n)}const d=u(l,i)+1,p=u(c,o)+1,m=u(h,a)+1,f=d*p*m,_=p*m,g=[];let y,x;for(y=0;y<s;y++){const t=4*y;b=e[t],w=e[t+1],S=e[t+2],x=(u(b,i)*p+u(w,o))*m+u(S,a),void 0===g[x]?g[x]=[y]:g[x].push(y)}var b,w,S;const v=O.allocateTyped(Uint32Array,f),C=O.allocateTyped(Uint16Array,f),A=O.allocateTyped(Uint32Array,s);let E,T=0,R=0;for(y=0;y<f;y++){const e=v[y]=T,t=g[y];if(void 0!==t)for(E=0;E<t.length;E++)A[T]=t[E],T++;const r=T-e;C[y]=r,r>R&&(R=r)}this.neighbourListLength=27*R+1,this.withinRadii=function(t,r,n,s,l){let c=0;const h=u(t,i),f=u(r,o),g=u(n,a),b=Math.max(0,h-1),w=Math.max(0,f-1),S=Math.max(0,g-1),T=Math.min(d-1,h+1),R=Math.min(p-1,f+1),M=Math.min(m-1,g+1);for(y=b;y<=T;++y){const i=y*_;for(E=w;E<=R;++E){const o=E*m;for(let a=S;a<=M;++a){x=i+o+a;const h=v[x],u=h+C[x];for(let i=h;i<u;i++){const o=4*A[i],a=e[o]-t,h=e[o+1]-r,u=e[o+2]-n,d=e[o+3]+s;a*a+h*h+u*u<=d*d&&(l[c++]=A[i])}}}}l[c]=-1}}const Mn=function(e,t,n,s){const i=4,{posRad:o,colors:a,atoms:l}=e,c=o.length/i,{bbox:h}=t,u=h.minPosRad,d=h.maxPosRad;let p,m,f,_,g,y,x,b,w,S,v,C,A,E,T,R,M=-1,P=null,N=null,L=null;const I=new r.Vector3(0,0,0),V=new r.Vector3(0,0,0),D=new r.Vector3(0,0,0);let k;function z(e,t,r){for(let n=0;n<e.length;n++)e[n]=t+r*n}function F(){({scaleFactor:_}=n),({dim:y}=t),k=Math.min(5,2+Math.floor(f*_));const e=y[0]*y[1]*y[2];x=function(e,t,r){const n=O.allocateTyped(e,t);for(let e=0;e<t;++e)n[e]=r;return n}(Float32Array,e,-1001),b=O.allocateTyped(Float32Array,3*e),w=O.allocateTyped(Float32Array,e),L&&(P=O.allocateTyped(Float32Array,e),N=[]),S=O.allocateTyped(Float32Array,y[0]),v=O.allocateTyped(Float32Array,y[1]),C=O.allocateTyped(Float32Array,y[2]),z(S,u[0],1/_),z(v,u[1],1/_),z(C,u[2],1/_)}function B(){({probeRadius:f,scaleFactor:_,probePositions:g,visibilitySelector:L}=n),p=O.allocateTyped(Float32Array,c),m=0;for(let e=0;e<c;++e){const t=o[e*i+3]+=f;t>m&&(m=t),p[e]=t*t}F(),function(){let e=0;const t=2*Math.PI/g;E=O.allocateTyped(Float32Array,g),A=O.allocateTyped(Float32Array,g);for(let r=0;r<g;r++)E[r]=Math.cos(e),A[r]=Math.sin(e),e+=t}(),T=new Rn(o,u,d,2.01*m),R=new Int32Array(T.neighbourListLength),M=-1}function U(e,t,r,n){const s=i*e,a=p[e],l=o[s]-t,c=o[s+1]-r,h=o[s+2]-n;return l*l+c*c+h*h<a}function G(e,t,r,n,s){let i;if(-1!==M){if(i=M,i!==n&&i!==s&&U(i,e,t,r))return i;M=-1}let o=0;for(i=R[o];i>=0;){if(i!==n&&i!==s&&U(i,e,t,r))return M=i,i;i=R[++o]}return M=-1,-1}function j(e,t){const r=i*e,n=i*t,s=o[r],a=o[r+1],l=o[r+2],c=o[r+3];let h=I.x=o[n]-s,d=I.y=o[n+1]-a,p=I.z=o[n+2]-l;const m=o[n+3];let f=h*h+d*d+p*p;const b=Math.sqrt(f),w=c*((c*c+b*b-m*m)/(2*c*b));var T,R;I.normalize(),R=I,(T=V).x=T.y=T.z=1,0!==R.x?T.x=(R.y+R.z)/-R.x:0!==R.y?T.y=(R.x+R.z)/-R.y:0!==R.z&&(T.z=(R.x+R.y)/-R.z),V.normalize(),D.crossVectors(I,V),D.normalize();const P=Math.sqrt(c*c-w*w);V.multiplyScalar(P),D.multiplyScalar(P),I.multiplyScalar(w),I.x+=s,I.y+=a,I.z+=l,M=-1;const N=k;for(let r=0;r<g;r++){const n=E[r],s=A[r],i=I.x+n*V.x+s*D.x,o=I.y+n*V.y+s*D.y,a=I.z+n*V.z+s*D.z;if(-1===G(i,o,a,e,t)){const e=Math.floor(_*(i-u[0])),t=Math.floor(_*(o-u[1])),r=Math.floor(_*(a-u[2])),n=Math.max(0,e-N),s=Math.max(0,t-N),l=Math.max(0,r-N),c=Math.min(y[0],e+N+2),m=Math.min(y[1],t+N+2),g=Math.min(y[2],r+N+2);for(let e=l;e<g;e++){p=a-C[e];const t=y[1]*y[0]*e;for(let e=s;e<m;e++){d=o-v[e];const r=p*p+d*d,s=t+y[0]*e;for(let e=n;e<c;e++){h=i-S[e],f=r+h*h;const t=e+s,n=x[t];n>0&&f<n*n&&(x[t]=Math.sqrt(f))}}}}}}function H(){B(),function(){for(let e=0;e<c;e++){const t=i*e,r=o[t],n=o[t+1],s=o[t+2],c=o[t+3],h=p[e];T.withinRadii(r,n,s,c,R);const d=Math.ceil(c*_),m=Math.floor(_*(r-u[0])),f=Math.floor(_*(n-u[1])),g=Math.floor(_*(s-u[2])),A=Math.max(0,m-d),E=Math.max(0,f-d),M=Math.max(0,g-d),I=Math.min(y[0],m+d+2),O=Math.min(y[1],f+d+2),V=Math.min(y[2],g+d+2),D=3*e,k=a[D],z=a[D+1],F=a[D+2];for(let t=M;t<V;t++){const i=C[t]-s,o=y[1]*y[0]*t;for(let t=E;t<O;t++){const a=v[t]-n,u=i*i+a*a,d=o+y[0]*t;for(let t=A;t<I;t++){const o=t+d,p=S[t]-r,m=u+p*p;if(m<h){const t=Math.exp(.28125*-m),h=3*o;b[h]+=k*t,b[h+1]+=z*t,b[h+2]+=F*t,w[o]+=t,null!==L&&t>P[o]&&(P[o]=t,N[o]=l[e]),x[o]<0&&(x[o]=-x[o]);const u=Math.sqrt(m),d=c/u;let f=p*d,_=a*d,g=i*d;if(f+=r,_+=n,g+=s,-1===G(f,_,g,e,-1)){const e=c-u;e<x[o]&&(x[o]=e)}}}}}}}(),function(){for(let e=0;e<c;e++){const t=i*e;T.withinRadii(o[t],o[t+1],o[t+2],o[t+3],R);let r=0,n=R[r];for(;n>=0;)e<n&&j(e,n),n=R[++r]}}(),function(){for(let e=0,t=x.length;e<t;e++){x[e]<0&&(x[e]=0);let t=w[e];if(t>0){t=1/t;const r=3*e;b[r]*=t,b[r+1]*=t,b[r+2]*=t}}}()}this.build=function(){H(),this.volTexMap=b,this.weightsMap=P,this.atomMap=N,this.volMap=x}},{Volume:Pn}=Yt;const Nn=class extends An{_computeSurface(e,t,r,n){const s=new Mn(e,r,n);s.build();return{volMap:new Pn(Float32Array,this.numVoxels,t,1,s.volMap),volTexMap:new Pn(Float32Array,this.numVoxels,t,3,s.volTexMap),atomMap:s.atomMap,atomWeightMap:new Pn(Float32Array,this.numVoxels,t,1,s.weightsMap)}}};const Ln=class{constructor(e,t){this.coord=new r.Vector3,this.coord.copy(e),this.radius=t,this.colorX=.99999,this.colorY=0,this.colorZ=0,this.atomType=0,this.srcAtom=null}};const In=class{constructor(e,t,n,s,i){this._numAtoms=e,this._atoms=t,this._vBoxMin=new r.Vector3,this._vBoxMax=new r.Vector3,this._vBoxMin.copy(n),this._vBoxMax.copy(s),this._probeRadius=i,this._atomsList=null,this._voxelList=null}createVoxels(){let e,t;const r=0|this._numAtoms,n=this._atoms,s=this._vBoxMax.x-this._vBoxMin.x,i=this._vBoxMax.y-this._vBoxMin.y,o=this._vBoxMax.z-this._vBoxMin.z;let a=s<i?s:i;a=o<a?o:a;let l,c=0,h=0;for(l=0;l<r;l++)t=2*(n[l].radius+this._probeRadius),c=t>c?t:c,h+=t;let u=Math.floor(a/c);u<2&&(u=2),h/=r,this._numCells=u,this._aveRad=h,this._maxRad=c;const d=u,p=u*u,m=u*u*u,f=this._xScale=1/(this._vBoxMax.x-this._vBoxMin.x),_=this._yScale=1/(this._vBoxMax.y-this._vBoxMin.y),g=this._zScale=1/(this._vBoxMax.z-this._vBoxMin.z);let y=0;const x=f*u,b=_*u,w=g*u;for(l=0;l<r;l++){const e=2*(4.5*(n[l].radius+this._probeRadius));let t=Math.floor(x*e+.8),r=Math.floor(b*e+.8),s=Math.floor(w*e+.8);t++,r++,s++,y+=t*r*s}this._voxelList=O.allocateTyped(Int32Array,m);const S=[];if(S.length=y,null===this._voxelList||null===S)return-1;for(l=0;l<m;l++)this._voxelList[l]=-1;for(e=0,l=0;l<r;l++){t=4.5*(n[l].radius+this._probeRadius);let r=Math.floor((n[l].coord.x-this._vBoxMin.x-t)*u*f),s=Math.floor((n[l].coord.y-this._vBoxMin.y-t)*u*_),i=Math.floor((n[l].coord.z-this._vBoxMin.z-t)*u*g),o=Math.floor((n[l].coord.x-this._vBoxMin.x+t)*u*f),a=Math.floor((n[l].coord.y-this._vBoxMin.y+t)*u*_),c=Math.floor((n[l].coord.z-this._vBoxMin.z+t)*u*g);r=r>=0?r:0,s=s>=0?s:0,i=i>=0?i:0,o=o<u?o:u-1,a=a<u?a:u-1,c=c<u?c:u-1;for(let t=i;t<=c;t++)for(let n=s;n<=a;n++)for(let s=r;s<=o;s++){const r=s+n*d+t*p;if(this._voxelList[r]<0){S[2*e+0]=l,S[2*e+1]=-1,this._voxelList[r]=e,e++;continue}const i=this._voxelList[r];this._voxelList[r]=e,S[2*e+0]=l,S[2*e+1]=i,e++}}return this._atomsList=Int32Array.from(S),0}destroyVoxels(){this._atomsList=null,this._voxelList=null,this._atoms=null,this._vertices=null,this._vBoxMin=null,this._vBoxMax=null}forEachRelatedAtom(e,t){const r=Math.floor((e.x-this._vBoxMin.x)*this._numCells*this._xScale),n=Math.floor((e.y-this._vBoxMin.y)*this._numCells*this._yScale),s=Math.floor((e.z-this._vBoxMin.z)*this._numCells*this._zScale),i=r+n*this._numCells+s*this._numCells*this._numCells,o=this._atoms;for(let e=this._voxelList[i];e>=0;e=this._atomsList[2*e+1]){t(o[this._atomsList[2*e]])}}getClosestAtom(e){let t=null,r=Number.MAX_VALUE;return this.forEachRelatedAtom(e,(n=>{const s=e.distanceToSquared(n.coord);s<r&&(r=s,t=n)})),t}buildNormals(e,t,r){const n=this;let s,i=0,o=0,a=0,l=0,c=0,h=0,u=0,d=0,p=0;const m=2.5*this._aveRad,f=m*m,_=.1*-this._aveRad,g=function(e){const t=o-e.coord.x,r=a-e.coord.y,m=l-e.coord.z;if(s=t*t+r*r+m*m,s>f)return;const g=e.radius+n._probeRadius;d=s-g*g,d<0&&(d=-d),p=Math.exp(_*d),c+=t*p,h+=r*p,u+=m*p,i++};let y=0;for(let n=0;n<e;n++)o=t[n].x,a=t[n].y,l=t[n].z,i=0,c=h=u=0,this.forEachRelatedAtom(t[n],g),y=i>y?i:y,s=c*c+h*h+u*u,i>0&&(d=1/Math.sqrt(s),c*=d,h*=d,u*=d),r[n].x=c,r[n].y=h,r[n].z=u;return 0}buildColors(e,t,r,n){const s=this;let i=0,o=0,a=0,l=0,c=0;const h=n*n;let u=[],d=[],p=0;const m=function(e){const t=i-e.coord.x,r=o-e.coord.y,n=a-e.coord.z,m=t*t+r*r+n*n;if(m>h)return;const f=e.radius+s._probeRadius;l=m-f*f,l<0&&(l=-l),c=1/(.8+l),u.push([e.colorX,e.colorY,e.colorZ]),d.push(c),p+=c};for(let n=0;n<e;n++){i=t[n].x,o=t[n].y,a=t[n].z,u=[],d=[],p=0,this.forEachRelatedAtom(t[n],m);for(let e=0;e<u.length;++e){const t=d[e]/p;r[n].x+=u[e][0]*t,r[n].y+=u[e][1]*t,r[n].z+=u[e][2]*t}}return 0}};const On=class{constructor(e,t,n){let s;for(this._maxNumVertices=e,this._maxNumTriangles=t,this._vertices=new Array(e),this._normals=new Array(e),this._colors=null,n&&(this._colors=new Array(e)),this._indices=new Array(3*t),this._numVertices=0,this._numTriangles=0,s=0;s<e;s++)this._vertices[s]=new r.Vector3,this._normals[s]=new r.Vector3;for(s=0;s<3*t;s++)this._indices[s]=-1;if(n)for(s=0;s<e;s++)this._colors[s]=new r.Vector3}destroy(){this._vertices=null,this._normals=null,this._indices=null}},Vn=32768,{Element:Dn}=Yt;const kn=class extends fn{_build(){this._innerBuild();const e=this.getGeo();this.destroy(),this._fromGeo(e)}_fromGeo(e){let t=null;const n=O.allocateTyped(Float32Array,3*e._numVertices),s=O.allocateTyped(Float32Array,3*e._numVertices);null!==e._colors&&(t=O.allocateTyped(Float32Array,3*e._numVertices));const i=O.allocateTyped(Uint32Array,3*e._numTriangles);for(let t=0,r=0;t<e._numVertices;t++)n[r+0]=e._vertices[t].x,n[r+1]=e._vertices[t].y,n[r+2]=e._vertices[t].z,s[r+0]=e._normals[t].x,s[r+1]=e._normals[t].y,s[r+2]=e._normals[t].z,r+=3;if(null!==t)for(let r=0,n=0;r<e._numVertices;r++,n+=3)t[n+0]=e._colors[r].x,t[n+1]=e._colors[r].y,t[n+2]=e._colors[r].z;const o=3*e._numTriangles;for(let t=0;t<o;t++)i[t]=e._indices[t];this.setIndex(new r.BufferAttribute(i,1)),this.setAttribute("position",new r.BufferAttribute(n,3)),this.setAttribute("normal",new r.BufferAttribute(s,3)),this.setAttribute("color",new r.BufferAttribute(t,3)),this.computeBoundingBox(),this.computeBoundingSphere(),e.destroy()}convertToAtomsColored(e,t){const{atoms:r,colors:n}=e;for(let e=0,s=r.length;e<s;e++){const s=r[e].position,{radius:i}=r[e].element;t[e]=new Ln(s,i);const o=r[e].element.number;t[e].atomType=this.getType(o);let a=3*e;t[e].colorX=n[a++],t[e].colorY=n[a++],t[e].colorZ=n[a],t[e].srcAtom=r[e]}}getGeo(){return this.geoOut}destroy(){this.atoms=null,this.hashLines=null,this.hashEntries=null}getBoundingBox(e,t,r){const n=1e7;t.x=t.y=t.z=n,r.x=r.y=r.z=0-n;const s=this.probeRadius*this.atomRadiusScale;let i=0;for(let n=0,o=e.length;n<o;n++){const o=e[n].coord,a=e[n].radius+s;i=a>i?a:i,o.x-a<t.x&&(t.x=o.x-a),o.y-a<t.y&&(t.y=o.y-a),o.z-a<t.z&&(t.z=o.z-a),o.x+a>r.x&&(r.x=o.x+a),o.y+a>r.y&&(r.y=o.y+a),o.z+a>r.z&&(r.z=o.z+a)}t.x-=i,t.y-=i,t.z-=i,r.x+=i,r.y+=i,r.z+=i}getCornerCoord(e,t,r,n,s,i,o){const a=1/(i-1),l=r*a,c=n*a,h=s*a;o.x=e.x*(1-l)+t.x*l,o.y=e.y*(1-c)+t.y*c,o.z=e.z*(1-h)+t.z*h}buildEdgePoint(e,t,r,n,s,i){if(r[e]^r[t]){const r=24,o=(0-n.pointsValuesLinear[s+r+e])/(n.pointsValuesLinear[s+r+t]-n.pointsValuesLinear[s+r+e]),a=n.pointsValuesLinear[s+3*e+0],l=n.pointsValuesLinear[s+3*e+1],c=n.pointsValuesLinear[s+3*e+2],h=n.pointsValuesLinear[s+3*t+0],u=n.pointsValuesLinear[s+3*t+1],d=n.pointsValuesLinear[s+3*t+2];i.x=a*(1-o)+h*o,i.y=l*(1-o)+u*o,i.z=c*(1-o)+d*o}}isTriangleVisible(e,t,r){const n=this.voxelWorld.getClosestAtom(e),s=this.voxelWorld.getClosestAtom(t),i=this.voxelWorld.getClosestAtom(r);return null!==n&&null!==s&&null!==i&&null!==n.srcAtom&&null!==s.srcAtom&&null!==i.srcAtom&&(this.visibilitySelector.includesAtom(n.srcAtom)&&this.visibilitySelector.includesAtom(s.srcAtom)&&this.visibilitySelector.includesAtom(i.srcAtom))}addTriangle(e,t,r){if(this.visibilitySelector&&!this.isTriangleVisible(e,t,r))return!0;const n=this.geoOut;if(n._numTriangles>=this.maxNumTriangles)return!1;const s=this.addVertexToGeo(n,e),i=this.addVertexToGeo(n,t),o=this.addVertexToGeo(n,r);if((s|i|o)<0)return!1;const a=3*n._numTriangles;return n._indices[a+0]=s,n._indices[a+1]=i,n._indices[a+2]=o,n._numTriangles++,!0}buildGeoFromCorners(e,t,n,s,i,o){const a=e-1,l=e,c=e*e,h=new Array(12);for(let e=0;e<12;e++)h[e]=new r.Vector3;const u=[];for(let e=0;e<8;e++)u[e]=1;const d=new r.Vector3;let p=0,m=0;for(let r=0;r<a;r++,m+=c){let s=0;for(let c=0;c<a;c++,s+=l)for(let s=0;s<a;s++){if(!o.hasIntersection[p]){p++;continue}const a=o.bitsInside[p];this.getCornerCoord(t,n,s,r,c,e,d);const l=32*p;for(let e=0,t=0;e<8;e++)o.pointsValuesLinear[l+t++]=d.x,o.pointsValuesLinear[l+t++]=d.y,o.pointsValuesLinear[l+t++]=d.z;o.pointsValuesLinear[l+3]+=i.x,o.pointsValuesLinear[l+6]+=i.x,o.pointsValuesLinear[l+15]+=i.x,o.pointsValuesLinear[l+18]+=i.x,o.pointsValuesLinear[l+6+2]+=i.z,o.pointsValuesLinear[l+9+2]+=i.z,o.pointsValuesLinear[l+18+2]+=i.z,o.pointsValuesLinear[l+21+2]+=i.z,o.pointsValuesLinear[l+12+1]+=i.y,o.pointsValuesLinear[l+15+1]+=i.y,o.pointsValuesLinear[l+18+1]+=i.y,o.pointsValuesLinear[l+21+1]+=i.y;const m=l+24;for(let e=0;e<8;++e)u[e]=o.pointsValuesLinear[m+e]<0?1:0;this.buildEdgePoint(0,1,u,o,l,h[0]),this.buildEdgePoint(1,2,u,o,l,h[1]),this.buildEdgePoint(2,3,u,o,l,h[2]),this.buildEdgePoint(3,0,u,o,l,h[3]),this.buildEdgePoint(4,5,u,o,l,h[4]),this.buildEdgePoint(5,6,u,o,l,h[5]),this.buildEdgePoint(6,7,u,o,l,h[6]),this.buildEdgePoint(7,4,u,o,l,h[7]),this.buildEdgePoint(0,4,u,o,l,h[8]),this.buildEdgePoint(1,5,u,o,l,h[9]),this.buildEdgePoint(2,6,u,o,l,h[10]),this.buildEdgePoint(3,7,u,o,l,h[11]);const f=16*a;for(let e=0,t=0;e<6;e++,t+=3){const e=o.striIndicesMarchCube[f+t];if(e<0)break;const r=o.striIndicesMarchCube[f+t+1],n=o.striIndicesMarchCube[f+t+2];if(!this.addTriangle(h[e],h[r],h[n]))return-2}p++}}return 0}getNumIntersectedCells(e,t,r,n){const s=e*e;let i=0,o=0,a=0;for(let l=0;l<t;l++,a+=s){let l=0;for(let c=0;c<t;c++,l+=e)for(let c=0;c<t;c++){const t=32*o+24,h=c+l+a;n.pointsValuesLinear[t]=r[h],n.pointsValuesLinear[t+1]=r[h+1],n.pointsValuesLinear[t+2]=r[h+e+1],n.pointsValuesLinear[t+3]=r[h+e],n.pointsValuesLinear[t+4]=r[s+h],n.pointsValuesLinear[t+5]=r[s+h+1],n.pointsValuesLinear[t+6]=r[s+h+e+1],n.pointsValuesLinear[t+7]=r[s+h+e];let u=0;for(let e=0;e<8;++e)n.pointsValuesLinear[t+e]<0&&(u|=1<<e);0===u||255===u?n.hasIntersection[o]=!1:(n.hasIntersection[o]=!0,i++),n.bitsInside[o]=u,o++}}return i}getType(e){const t=[0,0,1,1,2,6,3,6,4,6,5,6,6,0,7,3,8,2,9,6,10,6,11,6,12,6,13,6,14,6,15,4,16,5,17,6,18,6,19,6,20,6,21,6,22,6,23,6,24,6,25,6,26,6,27,6,28,6,29,6,30,6,31,6,32,6,33,6,34,6,35,6,36,6,37,6,38,6,39,6,40,6,41,6,42,6,43,6,44,6,45,6,46,6,47,6,48,6,49,6,50,6,51,6,52,6,53,6,54,6,55,6,56,6,57,6,58,6,59,6,60,6,61,6,62,6,63,6,64,6,65,6,66,6,67,6,68,6,69,6,70,6,71,6,72,6,73,6,74,6,75,6,76,6,77,6,78,6,79,6,80,6,81,6,82,6,83,6,84,6,85,6,86,6,87,6,88,6,89,6,90,6,91,6,92,6,93,6,94,6,95,6,96,6,97,6,98,6,99,6,100,6,101,6,102,6,103,6,104,6,105,6,106,6,107,6,108,6,109,6];if(e<1||e>t.length/2||2*Object.keys(Dn.ByAtomicNumber).length!==t.length)throw new Error("atomT.length  should be equal Element.ByAtomicNumber.length * 2");return t[2*e]}calculateGridCorners(e,t,n,s,i,o){const a=t*t,l=a*t,c=new r.Vector3,h=new r.Vector3;for(let t=0;t<l;t++)e[t]=1e12;const u=(t-1)/(s.x-n.x),d=(t-1)/(s.y-n.y),p=(t-1)/(s.z-n.z);for(let r=0,l=i.length;r<l;r++){const l=i[r],m=l.radius+o,f=(l.coord.x-m-n.x)*u,_=(l.coord.y-m-n.y)*d,g=(l.coord.z-m-n.z)*p,y=Math.floor(f),x=Math.floor(_),b=Math.floor(g);let w=Math.floor((l.coord.x+m-n.x)*u),S=Math.floor((l.coord.y+m-n.y)*d),v=Math.floor((l.coord.z+m-n.z)*p);w++,S++,v++,w=w<=t-1?w:t-1,S=S<=t-1?S:t-1,v=v<=t-1?v:t-1;for(let r=x;r<=S;r++){const i=r*a;for(let o=b;o<=v;o++){const a=o*t;for(let u=y;u<=w;u++){const d=i+a+u;this.getCornerCoord(n,s,u,r,o,t,c),h.x=c.x-l.coord.x,h.y=c.y-l.coord.y,h.z=c.z-l.coord.z;const p=Math.sqrt(h.x*h.x+h.y*h.y+h.z*h.z)-m;p<e[d]&&(e[d]=p)}}}}}createVertexHash(e,t){if(this.hashLines=O.allocateTyped(Int32Array,65536),null===this.hashLines)return-1;for(let e=0,t=0;e<Vn;e++)this.hashLines[t++]=0,this.hashLines[t++]=-1;if(this.maxNumVertices=e,this.maxNumTriangles=t,this.numHashEtriesAllocated=e,this.hashEntries=O.allocateTyped(Int32Array,2*this.numHashEtriesAllocated),null===this.hashEntries)return-1;for(let e=0,t=0;e<this.numHashEtriesAllocated;e++)this.hashEntries[t++]=-1,this.hashEntries[t++]=-1;return this.numHashEntryIndex=0,0}getNewHashEntry(){if(this.numHashEntryIndex<this.numHashEtriesAllocated){const e=this.numHashEntryIndex;return this.numHashEntryIndex++,e}return-1}addVertexToGeo(e,t){let n;const s=.01,i=this.marCubeResoultion<<2,o=new r.Vector3,a=Math.floor(i*(t.x-this.vBoxMin.x)/(this.vBoxMax.x+s-this.vBoxMin.x)),l=Math.floor(i*(t.y-this.vBoxMin.y)/(this.vBoxMax.y+s-this.vBoxMin.y));let c=815851*a+37633*Math.floor(i*(t.z-this.vBoxMin.z)/(this.vBoxMax.z+s-this.vBoxMin.z))+2453543*l;c&=32767;const h=c+c;if(null!==this.vBoxMin&&null!==this.vBoxMax)for(n=this.hashLines[h+1];n>=0;n=this.hashEntries[2*n+1]){const r=this.hashEntries[2*n+0];o.copy(e._vertices[r]),o.x-=t.x,o.y-=t.y,o.z-=t.z;if(o.x*o.x+o.y*o.y+o.z*o.z<1e-6)return r}if(e._numVertices>=this.maxNumVertices)return-1;const u=e._numVertices;if(e._vertices[u].copy(t),null!==this.vBoxMin&&null!==this.vBoxMax){if(n=this.getNewHashEntry(),n<0)return-1;const e=this.hashLines[h+1];this.hashLines[h+1]=n,this.hashEntries[2*n+0]=u,this.hashEntries[2*n+1]=e,this.hashLines[h+0]++}return e._numVertices++,u}modifyExcludedFromGeo(e,t,r,n,s,i){let o,a,l;const c=e*e,h=(e-1)/(n.x-r.x),u=(e-1)/(n.y-r.y),d=(e-1)/(n.z-r.z),p=2*t*(2*t),m=1/(e-1);for(let f=0;f<s._numVertices;f++){const _=s._vertices[f],g=1.1*t;let y=Math.floor((_.x-g-r.x)*h),x=Math.floor((_.y-g-r.y)*u),b=Math.floor((_.z-g-r.z)*d),w=Math.floor((_.x+g-r.x)*h),S=Math.floor((_.y+g-r.y)*u),v=Math.floor((_.z+g-r.z)*d);y=y>=0?y:0,x=x>=0?x:0,b=b>=0?b:0,w=w<=e-1?w:e-1,S=S<=e-1?S:e-1,v=v<=e-1?v:e-1;for(let s=x;s<=S;s++){const h=s*c;for(let c=b;c<=v;c++){const u=c*e;for(let e=y;e<=w;e++){o=h+u+e;let d=e*m;const f=r.x*(1-d)+n.x*d;d=s*m;const g=r.y*(1-d)+n.y*d;d=c*m;const y=r.z*(1-d)+n.z*d,x=f-_.x,b=g-_.y,w=y-_.z,S=x*x+b*b+w*w;S<p&&(a=Math.sqrt(S),l=-(a-t),l>0?(i[o]<0&&(i[o]=l),l>i[o]&&(i[o]=l)):l>i[o]&&(i[o]=l))}}}}return 0}_innerBuild(){let e;const t=1.2,n={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};this.complex=this._opts.parent,this.atoms=n.atoms,this.meshResolution=this._opts.gridSpacing,this.atomRadiusScale=this._opts.radScale,this.colorMode=this._opts.colorMode,this.probeRadius=this._opts.probeRadius,this.useVertexColors=!0,this.excludeProbe=this._opts.excludeProbe,this.visibilitySelector=this._opts.visibilitySelector,this.geoOut=null,this.hashLines=null,this.hashEntries=null,this.numHashEtriesAllocated=0,this.numHashEntryIndex=0,this.maxNumVertices=0,this.maxNumTriangles=0;const s=new Array(this.atoms.length);this.convertToAtomsColored(n,s);const i=this.vBoxMin=new r.Vector3,o=this.vBoxMax=new r.Vector3;this.getBoundingBox(s,i,o);const a=this.marCubeResoultion=4*this.meshResolution,l=a,c=l*l*l,h=O.allocateTyped(Float32Array,c),u=this.probeRadius*this.atomRadiusScale;this.calculateGridCorners(h,l,i,o,s,u);const d=a-1,p=new gn;if(e=p.create(d),e<0)return e;const m=new r.Vector3;m.x=(o.x-i.x)/d,m.y=(o.y-i.y)/d,m.z=(o.z-i.z)/d;let f=this.getNumIntersectedCells(l,d,h,p),_=Math.floor(f*t),g=Math.floor(f*t*2);if(this.geoOut=new On(_,g,this.useVertexColors),e=this.createVertexHash(_,g),e<0)return e;let y=u;if(this.excludeProbe&&(y=.01),this.voxelWorld=new In(s.length,s,i,o,y),this.voxelWorld.createVoxels(),e=this.buildGeoFromCorners(a,i,o,h,m,p),this.excludeProbe){if(this.modifyExcludedFromGeo(l,u,i,o,this.geoOut,h),this.geoOut._vertices=null,this.geoOut._colors=null,this.geoOut._indices=null,this.geoOut._normals=null,this.geoOut._numVertices=0,this.geoOut._numTriangles=0,this.geoOut=null,f=this.getNumIntersectedCells(l,d,h,p),_=Math.floor(f*t),g=Math.floor(f*t*2),this.geoOut=new On(_,g,this.useVertexColors),e=this.createVertexHash(_,g),e<0)return e;e=this.buildGeoFromCorners(l,i,o,h,m,p)}this.voxelWorld.buildNormals(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._normals);let x=6.5;return this.excludeProbe&&(x-=1.5),this.useVertexColors&&this.voxelWorld.buildColors(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._colors,x),this.voxelWorld.destroyVoxels(),this.voxelWorld=null,p.destroy(),e}};const zn={InstancedSpheresGeometry:gr,SimpleSpheresGeometry:Sr,Simple2CCylindersGeometry:Er,Instanced2CCylindersGeometry:Dr,ExtrudedObjectsGeometry:jr,ChunkedLinesGeometry:rn,TwoColorLinesGeometry:on,CrossGeometry:dn,QuickSurfGeometry:Tn,ContactSurfaceGeometry:Nn,SSIsosurfaceGeometry:kn,LabelsGeometry:class extends g{constructor(e,t){super(),this._opts=t,this.items=[],this.needsUpdate=!1;let n=-50,s=-50;switch(t.horizontalAlign){case"left":n=0;break;case"right":n=-100}switch(t.verticalAlign){case"top":s=-100;break;case"bottom":s=0}const i=new r.Vector3(t.dx||0,t.dy||0,t.dz||0);this.userData={translation:`translate(${n}%, ${s}%)`,offset:i}}setItem(e,t,n){const s=this._opts,i=this.items[e]||function(e,t){const n=document.createElement("div");if(n.className=t,"string"==typeof e){const t=document.createElement("span");t.style.fontSize="150%";const r=e.split("\n");for(let e=0,n=r.length;e<n;++e){const s=document.createElement("span"),i=document.createTextNode(r[e]);s.appendChild(i),t.appendChild(s),e<n-1&&t.appendChild(document.createElement("br"))}n.appendChild(t)}else n.appendChild(e);return n.worldPos=new r.Vector3,n}(n,"label");i.worldPos.copy(t),i.style.textAlign=s.horizontalAlign,i.style.verticalAlign=s.verticalAlign,this.items[e]=i}setColor(e,t,r){this.items[e].opts={color:t,background:r}}startUpdate(){return!0}finishUpdate(){this.needsUpdate=!0,this.dispatchEvent({type:"update"})}finalize(){this.finishUpdate()}raycast(){}setOpacity(){}getSubset(){return[]}}},Fn={precision:"mediump",init(e){this.precision=e.capabilities.getMaxPrecision("highp")}},Bn=new Uint8Array([24,52,0,255,254,145,0,255,122,0,0,255,7,170,0,255,34,214,0,255,173,8,0,255,86,249,0,255,160,4,0,255,226,46,0,255,224,211,0,255,3,157,0,255,174,247,0,255,12,182,0,255,220,216,0,255,1,109,0,255,253,154,0,255]),Un=r.RepeatWrapping,Gn=r.RepeatWrapping,jn=r.NearestFilter,Hn=r.NearestFilter,$n=r.UVMapping,Wn=new r.DataTexture(Bn,4,4,r.RGBAFormat,r.UnsignedByteType,$n,Un,Gn,Hn,jn,1);Wn.needsUpdate=!0;const Yn={noiseWidth:4,noiseHeight:4,noiseTexture:Wn},Xn=[new r.Vector2(-.541978,.840393),new r.Vector2(.125533,-.992089),new r.Vector2(.374329,.927296),new r.Vector2(-.105475,.994422)],qn=r.UniformsUtils.merge([r.UniformsLib.fog,r.UniformsLib.lights,{diffuse:{value:new r.Color(15658734)},opacity:{value:1},specular:{type:"c",value:new r.Color(1118481)},shininess:{type:"f",value:30},fixedColor:{type:"c",value:new r.Color(16777215)},zOffset:{type:"f",value:0},zClipValue:{type:"f",value:0},clipPlaneValue:{type:"f",value:0},nearPlaneValue:{type:"f",value:-.5},invModelViewMatrix:{type:"4fv",value:new r.Matrix4},world2colorMatrix:{type:"4fv",value:new r.Matrix4},dashedLineSize:{type:"f",value:.1},dashedLinePeriod:{type:"f",value:.2},projMatrixInv:{type:"4fv",value:new r.Matrix4},viewport:{type:"v2",value:new r.Vector2},lineWidth:{type:"f",value:2},fogAlpha:{type:"f",value:1},samplesKernel:{type:"v2v",value:null},noiseTex:{type:"t",value:null},noiseTexelSize:{type:"v2",value:null},srcTexelSize:{type:"v2",value:null}}]),Zn=["shininess","opacity","zOffset","diffuse","specular","fixedColor","zClipCoef","zClipValue","clipPlaneValue","world2colorMatrix","dashedLineSize","dashedLinePeriod","projMatrixInv","viewport","lineWidth","fogAlpha","samplesKernel","noiseTex","noiseTexelSize","srcTexelSize"],Kn={diffuse:new r.Color(16777215),specular:new r.Color(1118481),shininess:30,opacity:1,fixedColor:new r.Color(16777215),zOffset:0,zClipCoef:2,zClipValue:0,clipPlaneValue:0,world2colorMatrix:new r.Matrix4,dashedLineSize:.1,dashedLinePeriod:.3,projMatrixInv:new r.Matrix4,viewport:new r.Vector2(800,600),lineWidth:2,fogAlpha:1,samplesKernel:Xn,noiseTex:Yn.noiseTexture,noiseTexelSize:new r.Vector2(1/Yn.noiseWidth,1/Yn.noiseHeight),srcTexelSize:new r.Vector2(1/800,1/600),copy(e){this.diffuse.copy(e.diffuse),this.specular.copy(e.specular),this.shininess=e.shininess,this.opacity=e.opacity,this.fixedColor.copy(e.fixedColor),this.zOffset=e.zOffset,this.zClipCoef=e.zClipCoef,this.zClipValue=e.zClipValue,this.clipPlaneValue=e.clipPlaneValue,this.world2colorMatrix.copy(e.world2colorMatrix),this.dashedLineSize=e.dashedLineSize,this.dashedLinePeriod=e.dashedLinePeriod,this.projMatrixInv=e.projMatrixInv,this.viewport=e.viewport,this.lineWidth=e.lineWidth,this.toonShading=e.toonShading,this.fogAlpha=e.fogAlpha,this.samplesKernel=e.samplesKernel,this.noiseTex=e.noiseTex,this.noiseTexelSize=e.noiseTexelSize,this.srcTexelSize=e.srcTexelSize}};class Qn extends r.RawShaderMaterial{constructor(e){super(e),this.fog=!0,this.instancedPos=!1,this.instancedMatrix=!1,this.attrColor=!1,this.attrColor2=!1,this.attrAlphaColor=!1,this.overrideColor=!1,this.sphereSprite=!1,this.cylinderSprite=!1,this.zClip=!1,this.clipPlane=!1,this.fakeOpacity=!1,this.prepassTransparancy=!1,this.colorFromPos=!1,this.shadowmap=!1,this.shadowmapType="random",this.colorFromDepth=!1,this.orthoCam=!1,this.dashedLine=!1,this.transparent=!0,this.thickLine=!1,this.fogTransparent=!1,this.normalsToGBuffer=!1,this.toonShading=!1,this.uberOptions=Object.create(Qn.prototype.uberOptions),super.setValues({uniforms:r.UniformsUtils.clone(qn),vertexShader:this.precisionString()+"float INSTANCED_SPRITE_OVERSCALE = 1.3;\r\n\r\nattribute vec3 normal;\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  varying vec3 viewNormal;\r\n#endif\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  varying vec3 vNormal;\r\n#endif\r\n\r\n#ifdef THICK_LINE\r\n  attribute vec4 position; // W contains vert pos or neg offset\r\n#else\r\n  attribute vec3 position;\r\n#endif\r\n\r\nvarying vec3 vWorldPosition;\r\nvarying vec3 vViewPosition;\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  attribute float alphaColor;\r\n  varying float alphaCol;\r\n#endif\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  attribute vec3 color;\r\n  varying vec3 vColor;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  attribute vec3 color2;\r\n  varying vec3 vColor2;\r\n  attribute vec2 uv;\r\n  #ifndef CYLINDER_SPRITE\r\n    varying vec2 vUv;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_POS\r\n  attribute vec4 offset;\r\n  #ifdef SPHERE_SPRITE\r\n    varying vec4 instOffset;\r\n  varying vec4 spritePosEye;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  attribute vec4 matVector1;\r\n  attribute vec4 matVector2;\r\n  attribute vec4 matVector3;\r\n  attribute vec4 invmatVector1;\r\n  attribute vec4 invmatVector2;\r\n  attribute vec4 invmatVector3;\r\n\r\n  #ifdef CYLINDER_SPRITE\r\n    varying vec4 matVec1;\r\n    varying vec4 matVec2;\r\n    varying vec4 matVec3;\r\n    varying vec4 invmatVec1;\r\n    varying vec4 invmatVec2;\r\n    varying vec4 invmatVec3;\r\n    varying vec4 spritePosEye;\r\n  #endif\r\n#endif\r\n\r\nuniform mat4 modelViewMatrix; // optional\r\nuniform mat4 projectionMatrix; // optional\r\nuniform mat3 normalMatrix; // optional\r\nuniform mat4 modelMatrix; // optional\r\n\r\n#ifdef DASHED_LINE\r\n  attribute float lineDistance;\r\n  varying float vLineDistance;\r\n#endif\r\n\r\n#ifdef THICK_LINE\r\n  attribute vec3 direction;\r\n  uniform mat4 projMatrixInv;\r\n  uniform vec2 viewport;\r\n  uniform float lineWidth;\r\n\r\n  vec4 transform(vec4 coord){\r\n    return projectionMatrix * modelViewMatrix * coord;\r\n  }\r\n\r\n  vec2 project(vec4 device){\r\n    vec3 device_normal = device.xyz/device.w;\r\n    vec2 clip_pos = (device_normal*0.5+0.5).xy;\r\n    return clip_pos * viewport;\r\n  }\r\n\r\n  vec4 unproject(vec2 screen, float z, float w){\r\n    vec2 clip_pos = screen/viewport;\r\n    vec2 device_normal = clip_pos*2.0-1.0;\r\n    return vec4(device_normal*w, z, w);\r\n  }\r\n#endif\r\n\r\n\r\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\r\nvoid main() {\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  alphaCol = alphaColor;\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  vec3 objectNormal = vec3(\r\n    dot(normal, matVector1.xyz),\r\n    dot(normal, matVector2.xyz),\r\n    dot(normal, matVector3.xyz));\r\n#else\r\n  vec3 objectNormal = vec3( normal );\r\n#endif\r\n\r\nvec3 transformedNormal = normalMatrix * objectNormal;\r\n\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  vNormal = normalize(transformedNormal);\r\n#endif\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  viewNormal = normalize(mat3(modelViewMatrix)*objectNormal);\r\n#endif\r\n\r\n  vec4 localPos = vec4(position.xyz, 1.0);\r\n  vec4 worldPos = modelMatrix * localPos;\r\n  vec4 mvPosition = modelViewMatrix * localPos;\r\n\r\n// make thick line offset\r\n#ifdef THICK_LINE\r\n   // get screen pos\r\n   vec4 dPos = transform(vec4(position.xyz, 1.0));\r\n   vec2 sPos = project(dPos);\r\n   // move pos forward\r\n   vec3 position2 = position.xyz + direction.xyz * 0.5;\r\n   // get screen offset pos\r\n   vec4 dPos2 = transform(vec4(position2.xyz, 1.0));\r\n   vec2 sPos2 = project(dPos2);\r\n   // screen line direction\r\n   vec2 sDir = normalize(sPos2 - sPos);\r\n   // vertex offset (orthogonal to line direction)\r\n   vec2 offset1 = vec2(-sDir.y, sDir.x);\r\n   // move screen vertex\r\n   vec2 newPos = sPos + offset1 * position.w * lineWidth;\r\n   // get moved pos in view space\r\n   vec4 dNewPos =  unproject(newPos, dPos.z, dPos.w);\r\n   mvPosition.xyz = (projMatrixInv * dNewPos).xyz;\r\n#endif // THICK_LINE\r\n\r\n#ifdef INSTANCED_POS\r\n  #ifdef SPHERE_SPRITE\r\n    instOffset = offset;\r\n\r\n    vec4 posEye = modelViewMatrix * vec4( offset.xyz, 1.0 );\r\n    float scale = length(modelViewMatrix[0]);\r\n    mvPosition = posEye + vec4( position.xyz * offset.w * scale * INSTANCED_SPRITE_OVERSCALE, 0.0 );\r\n    posEye.w = offset.w * scale;\r\n\r\n    spritePosEye = posEye;\r\n #else\r\n    localPos = vec4( offset.xyz + position.xyz * offset.w, 1.0 );\r\n    worldPos = modelMatrix * localPos;\r\n    mvPosition = modelViewMatrix * localPos;\r\n  #endif\r\n#endif\r\n\r\n#ifdef INSTANCED_MATRIX\r\n  #ifdef CYLINDER_SPRITE\r\n    matVec1 = matVector1;\r\n    matVec2 = matVector2;\r\n    matVec3 = matVector3;\r\n    invmatVec1 = invmatVector1;\r\n    invmatVec2 = invmatVector2;\r\n    invmatVec3 = invmatVector3;\r\n\r\n    // calculate eye coords of cylinder endpoints\r\n    vec4 v = vec4(0, -0.5, 0, 1);\r\n    vec4 p1 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r\n    v.y = 0.5;\r\n    vec4 p2 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r\n\r\n    // sprite is placed at the center of cylinder\r\n    vec4 posEye;\r\n    posEye.xyz = mix(p1.xyz, p2.xyz, 0.5);\r\n    posEye.w = 1.0;\r\n    spritePosEye = posEye;\r\n\r\n    // cylinder radius in eye space\r\n    float rad = length(modelViewMatrix[0]) * length(vec3(matVector1.x, matVector2.x, matVector3.x));\r\n    vec2 spriteSize;\r\n    #ifdef ORTHOGRAPHIC_CAMERA\r\n      // In ortho projection we skip z coordinate\r\n      // basic sprite size at screen plane (covers only cylinder axis)\r\n      vec2 spriteSizeScreen = abs(p2.xy - p1.xy);\r\n\r\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * (spriteSizeScreen + 2.0 * rad);\r\n    #else\r\n      // basic sprite size at screen plane (covers only cylinder axis)\r\n      vec2 spriteSizeScreen = abs(p2.xy / p2.z - p1.xy / p1.z);\r\n\r\n      // full sprite size in eye coords\r\n      float minZ = min(abs(p1.z), abs(p2.z));\r\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * abs(posEye.z) * (spriteSizeScreen + 2.0 * rad / minZ);\r\n    #endif\r\n\r\n    mvPosition = posEye + vec4( position.xy * 0.5 * spriteSize, 0, 0 );\r\n  #else\r\n    localPos = vec4(dot(localPos, matVector1), dot(localPos, matVector2), dot(localPos, matVector3), 1.0);\r\n    worldPos = modelMatrix * localPos;\r\n    mvPosition = modelViewMatrix * localPos;\r\n  #endif\r\n#endif\r\n\r\n  gl_Position = projectionMatrix * mvPosition;\r\n\r\n  vWorldPosition = worldPos.xyz;\r\n  vViewPosition = - mvPosition.xyz;\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t  vec4 worldPosition;\r\n\t  // see THREE.WebGLProgram.unrollLoops\r\n\t  #pragma unroll_loop_start\r\n\t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n      vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * vec4(vWorldPosition, 1.0);\r\n      vDirectionalShadowNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(objectNormal, 0.0))).xyz;\r\n\t  }\r\n\t  #pragma unroll_loop_end\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  vColor = color.xyz;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  vColor2 = color2;\r\n  #ifndef CYLINDER_SPRITE\r\n    vUv = uv;\r\n  #endif\r\n#endif\r\n\r\n#ifdef DASHED_LINE\r\n  vLineDistance = lineDistance;\r\n#endif\r\n}\r\n",fragmentShader:this.precisionString()+"#if defined (NORMALS_TO_G_BUFFER)\r\n  #define fragColor gl_FragData[0]\r\n#else\r\n  #define fragColor gl_FragColor\r\n#endif\r\n\r\n#ifdef ATTR_ALPHA_COLOR\r\n  varying float alphaCol;\r\n#endif\r\n\r\n#ifdef COLOR_FROM_POS\r\n  uniform mat4 world2colorMatrix;\r\n#endif\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n\t#if NUM_DIR_LIGHTS > 0\r\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\r\n    uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ]; //only for sprites\r\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r\n    vec4 vDirLightWorldCoord[ NUM_DIR_LIGHTS ];\r\n    vec3 vDirLightWorldNormal[ NUM_DIR_LIGHTS ];\r\n\r\n    #ifdef SHADOWMAP_PCF_RAND\r\n      // We use 4 instead uniform variable or define because this value is used in for(... i < value; ...) with\r\n      // unroll_loop and unroll_loop has pattern:\r\n      // /#pragma unroll_loop[\\s]+?for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g\r\n      uniform vec2 samplesKernel[4]; // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n      uniform sampler2D noiseTex;\r\n      uniform vec2 noiseTexelSize;\r\n      uniform vec2 srcTexelSize;\r\n      uniform mat4 projectionMatrix;\r\n    #endif\r\n\t#endif\r\n#endif\r\n\r\n#ifdef ATTR_COLOR\r\n  varying vec3 vColor;\r\n#endif\r\n\r\n#ifdef ATTR_COLOR2\r\n  varying vec3 vColor2;\r\n  #ifndef CYLINDER_SPRITE\r\n    varying vec2 vUv;\r\n  #endif\r\n#endif\r\n\r\nuniform vec3 diffuse;\r\nuniform vec3 emissive;\r\nuniform vec3 specular;\r\nuniform float shininess;\r\nuniform vec3 fixedColor;\r\nuniform float opacity;\r\nuniform float zClipValue;\r\nuniform float clipPlaneValue;\r\n\r\n#ifdef NORMALS_TO_G_BUFFER\r\n  varying vec3 viewNormal;\r\n#endif\r\n\r\n#define RECIPROCAL_PI 0.31830988618\r\n#define saturate(a) clamp( a, 0.0, 1.0 )\r\n\r\n#ifdef USE_FOG\r\n  uniform vec3 fogColor;\r\n  uniform float fogAlpha;\r\n  uniform float fogNear;\r\n  uniform float fogFar;\r\n#endif\r\n\r\nvarying vec3 vWorldPosition; // world position of the pixel (invalid when INSTANCED_SPRITE is defined)\r\nvarying vec3 vViewPosition;\r\n\r\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n  varying vec3 vNormal;\r\n#endif\r\n\r\n/////////////////////////////////////////// ZSprites ////////////////////////////////////////////////\r\n#if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\r\n  uniform float nearPlaneValue;\r\n#endif\r\n\r\n#ifdef SPHERE_SPRITE\r\n  varying vec4 spritePosEye;\r\n#endif\r\n\r\n#if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n  uniform float zOffset;\r\n\r\n  #if !defined(USE_LIGHTS) || !defined(SHADOWMAP) || !defined(SHADOWMAP_PCF_RAND) || !(NUM_DIR_LIGHTS > 0)\r\n    uniform mat4 projectionMatrix;\r\n  #endif\r\n\r\n  float calcDepthForSprites(vec4 pixelPosEye, float zOffset, mat4 projMatrix) {\r\n    vec4 pixelPosScreen = projMatrix * pixelPosEye;\r\n    return 0.5 * (pixelPosScreen.z / pixelPosScreen.w + 1.0) + zOffset;\r\n  }\r\n#endif\r\n\r\n#ifdef SPHERE_SPRITE\r\n  varying vec4 instOffset;\r\n  uniform mat4 modelMatrix;\r\n  uniform mat4 modelViewMatrix;\r\n  uniform mat4 invModelViewMatrix;\r\n  uniform mat3 normalMatrix;\r\n\r\n\r\n  bool intersect_ray_sphere(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\r\n\r\n    // intersect XZ-projected ray with circle\r\n    float a = dot(ray, ray);\r\n    float b = dot(ray, origin);\r\n    float c = dot(origin, origin) - 1.0;\r\n    float det = b * b - a * c;\r\n    if (det < 0.0) return false;\r\n    float t1 = (-b - sqrt(det)) / a;\r\n    float t2 = (-b + sqrt(det)) / a;\r\n\r\n    // calculate both intersection points\r\n    vec3 p1 = origin + ray * t1;\r\n    vec3 p2 = origin + ray * t2;\r\n\r\n    // choose nearest point inside frustum\r\n    #ifdef ORTHOGRAPHIC_CAMERA\r\n      // orthografic camera is used for dirLight sources. So in it for all spheres the point with smaller 't' is visible\r\n      // t1 is always smaller than t2 (from calculations)\r\n      point = p1;\r\n      frontFaced = 1.0;\r\n      return true;\r\n    #else\r\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\r\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\r\n      if (t1 >= 0.0) {\r\n        point = p1;\r\n        frontFaced = 1.0;\r\n        return true;\r\n      }\r\n      if (t2 >= 0.0) {\r\n        point = p2;\r\n        frontFaced = -1.0;\r\n        return true;\r\n      }\r\n    #endif\r\n\r\n    return false;\r\n  }\r\n\r\n  bool get_sphere_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\r\n    vec3 origin, ray;\r\n\r\n    #ifdef ORTHOGRAPHIC_CAMERA\r\n      // transform vector from sprite center to curPixel into sphere local coords\r\n      origin = pixelPosEye.xyz - spritePosEye.xyz;\r\n      origin = (invModelViewMatrix * vec4(origin, 0.0)).xyz / instOffset.w;\r\n\r\n      // transform camera orientation vector into sphere local coords\r\n      ray = (invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0)).xyz;\r\n    #else\r\n      // find point of intersection near plane by the ray from camera to curPixel\r\n      vec4 v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\r\n\r\n      // transform intersection point into sphere local coords\r\n      v = invModelViewMatrix * v;\r\n      origin = (v.xyz - instOffset.xyz) / instOffset.w;\r\n\r\n      // transform vector from camera pos to curPixel into sphere local coords\r\n      ray = (invModelViewMatrix * vec4(pixelPosEye, 0.0)).xyz;\r\n    #endif\r\n    ray = normalize(ray);\r\n\r\n    return intersect_ray_sphere(origin, ray, point, frontFaced);\r\n  }\r\n#endif\r\n\r\n#ifdef CYLINDER_SPRITE\r\n  varying vec4 matVec1;\r\n  varying vec4 matVec2;\r\n  varying vec4 matVec3;\r\n  varying vec4 invmatVec1;\r\n  varying vec4 invmatVec2;\r\n  varying vec4 invmatVec3;\r\n\r\n  uniform mat4 modelMatrix;\r\n  uniform mat4 modelViewMatrix;\r\n  uniform mat4 invModelViewMatrix;\r\n  uniform mat3 normalMatrix;\r\n\r\n  varying vec4 spritePosEye;\r\n\r\n  bool intersect_ray_cylinder(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\r\n\r\n    // intersect XZ-projected ray with circle\r\n    float a = dot(ray.xz, ray.xz);\r\n    float b = dot(ray.xz, origin.xz);\r\n    float c = dot(origin.xz, origin.xz) - 1.0;\r\n    float det = b * b - a * c;\r\n    if (det < 0.0) return false;\r\n    float t1 = (-b - sqrt(det)) / a;\r\n    float t2 = (-b + sqrt(det)) / a;\r\n\r\n    // calculate both intersection points\r\n    vec3 p1 = origin + ray * t1;\r\n    vec3 p2 = origin + ray * t2;\r\n\r\n    float halfHeight = 0.5;\r\n\r\n    // choose nearest point\r\n    #ifdef ORTHOGRAPHIC_CAMERA\r\n      // orthografic camera is used for dirLight sources. So in it for all cylinders the point with smaller 't' is visible\r\n      // if it is not outside of cylinnder (t1 is always smaller than t2).\r\n      if (p1.y >= -halfHeight && p1.y <= halfHeight) {\r\n        point = p1;\r\n        frontFaced = 1.0;\r\n        return true;\r\n      }\r\n      if (p2.y >= -halfHeight && p2.y <= halfHeight) {\r\n        point = p2;\r\n        frontFaced = -1.0;\r\n        return true;\r\n      }\r\n    #else\r\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\r\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\r\n      if (t1 >= 0.0 && p1.y >= -halfHeight && p1.y <= halfHeight) {\r\n        point = p1;\r\n        frontFaced = 1.0;\r\n        return true;\r\n      }\r\n      if (t2 >= 0.0 && p2.y >= -halfHeight && p2.y <= halfHeight) {\r\n        point = p2;\r\n        frontFaced = -1.0;\r\n        return true;\r\n      }\r\n    #endif\r\n\r\n    return false;\r\n  }\r\n\r\n  bool get_cylinder_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\r\n    vec3 origin, ray;\r\n    vec4 v;\r\n\r\n    #ifdef ORTHOGRAPHIC_CAMERA\r\n      // transform vector from sprite center to curPixel into cylinder local coords\r\n      v = invModelViewMatrix * vec4(pixelPosEye.xyz - spritePosEye.xyz, 0.0);\r\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r\n\r\n      // transform camera orientation vector into cylinder local coords\r\n      v = invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0);\r\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r\n    #else\r\n      // find point of intersection near plane by the ray from camera to curPixel\r\n      v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\r\n\r\n      // transform intersection point into cylinder local coords\r\n      v = invModelViewMatrix * v;\r\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r\n\r\n      // transform vector from camera pos to curPixel into cylinder local coords\r\n      v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\r\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r\n    #endif\r\n    ray = normalize(ray);\r\n\r\n    return intersect_ray_cylinder(origin, ray, point, frontFaced);\r\n  }\r\n#endif\r\n\r\n///////////////////////////////////// Pack and unpack ///////////////////////////////////////////////\r\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\r\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\r\n\r\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\r\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\r\n\r\n\r\nconst float ShiftRight8 = 1. / 256.;\r\n\r\nvec4 packDepthToRGBA( const in float v ) {\r\n  vec4 r = vec4( fract( v * PackFactors ), v );\r\n  r.yzw -= r.xyz * ShiftRight8; // tidy overflow\r\n  return r * PackUpscale;\r\n}\r\n\r\nfloat unpackRGBAToDepth( const in vec4 v ) {\r\n  return dot( v, UnpackFactors );\r\n}\r\n\r\n////////////////////////////////////////// All Lighting /////////////////////////////////////////////////\r\n#ifdef TOON_SHADING\r\n  #define LOW_TOON_BORDER 0.0\r\n  #define MEDIUM_TOON_BORDER 0.7\r\n  #define HIGH_TOON_BORDER 1.0\r\n\r\n  #define MEDIUM_TOON_RANGE 0.5\r\n  #define HIGH_TOON_RANGE 0.95\r\n#endif\r\n#if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r\n  struct ReflectedLight {\r\n    vec3 directDiffuse;\r\n    vec3 directSpecular;\r\n    vec3 indirectDiffuse;\r\n  };\r\n\r\n  struct BlinnPhongMaterial {\r\n    vec3  diffuseColor;\r\n    vec3  specularColor;\r\n    float specularShininess;\r\n  };\r\n\r\n  struct GeometricContext {\r\n    vec3 normal;\r\n    vec3 viewDir;\r\n  };\r\n\r\n  struct DirectionalLight {\r\n    vec3 direction;\r\n    vec3 color;\r\n  };\r\n  uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\r\n\r\n  struct DirectionalLightShadow {\r\n     vec2 shadowMapSize;\r\n     float shadowBias;\r\n     float shadowRadius;\r\n   };\r\n  uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHTS ];\r\n\r\n  uniform vec3 ambientLightColor;\r\n\r\n  /////////////////////////////////////////// Shadowmap ////////////////////////////////////////////////\r\n\r\n  #if defined(SHADOWMAP)\r\n  \tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\r\n  \t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\r\n  \t}\r\n\r\n    float getShadow( sampler2D shadowMap, DirectionalLightShadow dirLight, vec4 shadowCoord, vec3 vViewPosition, vec3 vNormal ) {\r\n   \t  float shadow = 0.0;\r\n\r\n      // When shadows for sprites will appear use here for them normals as it done for G-buffer\r\n      shadowCoord.xyz += dirLight.shadowBias * vNormal;\r\n      shadowCoord.xyz /= shadowCoord.w;\r\n\r\n      bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r\n      bool inFrustum = all( inFrustumVec );\r\n      bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r\n      bool frustumTest = all( frustumTestVec );\r\n\r\n      if ( frustumTest ) {\r\n        #ifdef SHADOWMAP_BASIC\r\n      \t  shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\r\n      \t#endif\r\n\r\n      \t#ifdef SHADOWMAP_PCF_SHARP\r\n      \t  vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r\n\r\n            float dx0 = - texelSize.x * dirLight.shadowRadius;\r\n            float dy0 = - texelSize.y * dirLight.shadowRadius;\r\n            float dx1 = + texelSize.x * dirLight.shadowRadius;\r\n            float dy1 = + texelSize.y * dirLight.shadowRadius;\r\n\r\n            shadow = (\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\r\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\r\n            ) * ( 1.0 / 9.0 );\r\n        #endif\r\n\r\n        #ifdef SHADOWMAP_PCF_RAND\r\n          vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r\n\r\n          vec4 vUv = ((projectionMatrix * vec4(vViewPosition, 1.0)) + 1.0) / 2.0;\r\n          vec2 vUvNoise = vUv.xy / srcTexelSize * noiseTexelSize;\r\n\r\n          vec2 noiseVec = normalize(texture2D(noiseTex, vUvNoise).rg);\r\n          mat2 mNoise = mat2(noiseVec.x, noiseVec.y, -noiseVec.y, noiseVec.x);\r\n\r\n          vec2 offset;\r\n          #pragma unroll_loop_start\r\n          for ( int i = 0; i < 4; i ++ ) { // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n            offset = mNoise * ( normalize( samplesKernel[ i ]) * texelSize * dirLight.shadowRadius );\r\n            shadow +=  texture2DCompare( shadowMap, shadowCoord.xy + offset, shadowCoord.z );\r\n          }\r\n          #pragma unroll_loop_end\r\n          shadow /= float( 4 ); // 4 is length of _samplesKernel which is defined in UberMaterial.js\r\n        #endif\r\n      }\r\n      return shadow;//(shadow != 1.0) ? 0.5 : 1.0;//vec4(shadow, shadow, shadow, 1.0);\r\n   }\r\n  #endif\r\n\r\n  /////////////////////////////////////////// Lighting /////////////////////////////////////////////////\r\n\r\n  vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\r\n    return RECIPROCAL_PI * diffuseColor;\r\n  } // validated\r\n\r\n  vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\r\n    // Original approximation by Christophe Schlick '94\r\n    //;float fresnel = pow( 1.0 - dotLH, 5.0 );\r\n    // Optimized variant (presented by Epic at SIGGRAPH '13)\r\n    float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\r\n    return ( 1.0 - specularColor ) * fresnel + specularColor;\r\n  } // validated\r\n\r\n  float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\r\n    // geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\r\n    return 0.25;\r\n  }\r\n\r\n  float D_BlinnPhong( const in float shininess, const in float dotNH ) {\r\n    return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\r\n  }\r\n\r\n  vec3 BRDF_Specular_BlinnPhong( const in DirectionalLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\r\n    vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\r\n    float dotNH = saturate(dot( geometry.normal, halfDir ));\r\n    float dotLH = saturate(dot( incidentLight.direction, halfDir ));\r\n\r\n    vec3 F = F_Schlick( specularColor, dotLH );\r\n    float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\r\n    float D = D_BlinnPhong( shininess, dotNH );\r\n\r\n    return F * ( G * D );\r\n  } // validated\r\n\r\n  void RE_Direct_BlinnPhong( const in DirectionalLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight, float penumbra ) {\r\n\r\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ));\r\n    #ifdef TOON_SHADING\r\n      if(dotNL < MEDIUM_TOON_RANGE){\r\n        dotNL = LOW_TOON_BORDER;\r\n      }\r\n      else if(dotNL < HIGH_TOON_RANGE){\r\n        dotNL = MEDIUM_TOON_BORDER;\r\n      }\r\n      else{\r\n        dotNL = HIGH_TOON_BORDER;\r\n      }\r\n    #endif\r\n\r\n    vec3 irradiance = dotNL * directLight.color;\r\n    reflectedLight.directDiffuse += penumbra * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r\n    reflectedLight.directSpecular += penumbra * irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess );\r\n  }\r\n\r\n  void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\r\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r\n  }\r\n\r\n  vec3 calcLighting(const in GeometricContext geometry, const in BlinnPhongMaterial material, vec3 vViewPosition) {\r\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ));\r\n    vec3 irradiance = ambientLightColor;\r\n\r\n    float shadowMask = 1.0;\r\n    // see THREE.WebGLProgram.unrollLoops\r\n  \t#pragma unroll_loop_start\r\n  \t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n  \t    #ifdef SHADOWMAP\r\n  \t      shadowMask = getShadow( directionalShadowMap[ i ], directionalLightShadows[ i ], vDirLightWorldCoord[ i ], vViewPosition, vDirLightWorldNormal[ i ] );\r\n        #endif\r\n\r\n  \t\t  if ( shadowMask > 0.0 ) RE_Direct_BlinnPhong( directionalLights[ i ], geometry, material, reflectedLight, shadowMask );\r\n  \t\t}\r\n  \t\t#pragma unroll_loop_end\r\n\r\n    RE_IndirectDiffuse_BlinnPhong(irradiance, material, reflectedLight);\r\n\r\n    return saturate(reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular);\r\n  }\r\n#endif\r\n\r\n/////////////////////////////////////////// Dashed Line ///////////////////////////////////////////////\r\n#ifdef DASHED_LINE\r\n  uniform float dashedLineSize;\r\n  uniform float dashedLinePeriod;\r\n  varying float vLineDistance;\r\n#endif\r\n\r\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\r\nvoid main() {\r\n\r\n#ifdef CLIP_PLANE\r\n  if (vViewPosition.z < clipPlaneValue) discard;\r\n#endif\r\n\r\n#ifdef ZCLIP\r\n  if (vViewPosition.z < zClipValue) discard;\r\n#endif\r\n\r\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n  #if NUM_DIR_LIGHTS > 0\r\n    // see THREE.WebGLProgram.unrollLoops\r\n    #pragma unroll_loop_start\r\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n      vDirLightWorldCoord[ i ] = vDirectionalShadowCoord[ i ];\r\n      vDirLightWorldNormal[ i ] = vDirectionalShadowNormal[ i ];\r\n    }\r\n    #pragma unroll_loop_end\r\n  #endif\r\n#endif\r\n\r\n  vec4 pixelPosWorld = vec4(vWorldPosition, 1.0);\r\n  vec4 pixelPosEye;\r\n\r\n#ifdef SPHERE_SPRITE\r\n\r\n  vec3 viewNormalSprites;\r\n  float frontFaced = 1.0;\r\n  vec3 normal;\r\n\r\n/* quick-and-dirty method\r\n  normal.xy = ' + INSTANCED_SPRITE_OVERSCALE + ' * (2.0 * vUv - 1.0);\r\n  float r2 = dot(normal.xy, normal.xy);\r\n  if (r2 > 1.0) discard;\r\n  float normalZ = sqrt(1.0 - r2);\r\n  normal.z = normalZ;\r\n  normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\r\n  pixelPosEye = vec4(spritePosEye.xyz, 1.0);\r\n  pixelPosEye.z += spritePosEye.w * normalZ;\r\n*/\r\n\r\n  // ray-trace sphere surface\r\n  {\r\n    vec3 p;\r\n    if (!get_sphere_point(-vViewPosition, p, frontFaced)) discard;\r\n    vec4 v = vec4(instOffset.xyz + p * instOffset.w, 1.0);\r\n    pixelPosWorld = modelMatrix * v;\r\n    pixelPosEye = modelViewMatrix * v;\r\n    normal = normalize(normalMatrix * p);\r\n    #ifdef NORMALS_TO_G_BUFFER\r\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*p);\r\n    #endif\r\n\r\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n      #if NUM_DIR_LIGHTS > 0\r\n        // see THREE.WebGLProgram.unrollLoops\r\n        #pragma unroll_loop_start\r\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\r\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(p, 0.0))).xyz;\r\n          }\r\n        #pragma unroll_loop_end\r\n      #endif\r\n    #endif\r\n  }\r\n#endif\r\n\r\n#ifdef CYLINDER_SPRITE\r\n  vec3 normal;\r\n  vec3 viewNormalSprites;\r\n  float frontFaced = 1.0;\r\n  float cylinderY = 0.0;\r\n\r\n  // ray-trace cylinder surface\r\n  {\r\n    vec3 p;\r\n    if (!get_cylinder_point(-vViewPosition, p, frontFaced)) discard;\r\n\r\n    cylinderY = 0.5 * (p.y + 1.0);\r\n\r\n    vec4 v = vec4(p, 1.0);\r\n    v = vec4(dot(v, matVec1), dot(v, matVec2), dot(v, matVec3), 1.0);\r\n    pixelPosWorld = modelMatrix * v;\r\n    pixelPosEye = modelViewMatrix * v;\r\n\r\n    vec3 localNormal = normalize(vec3(p.x, 0.0, p.z));\r\n    normal = vec3(\r\n      dot(localNormal, matVec1.xyz),\r\n      dot(localNormal, matVec2.xyz),\r\n      dot(localNormal, matVec3.xyz));\r\n    #ifdef NORMALS_TO_G_BUFFER\r\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*normal);\r\n    #endif\r\n\r\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\r\n      #if NUM_DIR_LIGHTS > 0\r\n        // see THREE.WebGLProgram.unrollLoops\r\n        #pragma unroll_loop_start\r\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\r\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(normal, 0.0))).xyz;\r\n          }\r\n        #pragma unroll_loop_end\r\n      #endif\r\n    #endif\r\n\r\n    normal = normalize(normalMatrix * normal);\r\n  }\r\n#endif\r\n\r\n  #ifdef ATTR_COLOR\r\n    vec3 vertexColor = vColor;\r\n  #else\r\n    vec3 vertexColor = vec3(1.0, 1.0, 1.0);\r\n  #endif\r\n\r\n  #ifdef ATTR_COLOR2\r\n    #ifdef CYLINDER_SPRITE\r\n      float colorCoef = cylinderY; // cylinder parameter is calculated from ray-tracing\r\n    #else\r\n      float colorCoef = vUv.y; // cylinder parameter is interpolated as tex coord\r\n    #endif\r\n      // choose either color or color2\r\n    vertexColor = mix(vColor2, vColor, step(0.5, colorCoef));\r\n  #endif\r\n\r\n  // negative red component is a special condition\r\n  if (vertexColor.x < 0.0) discard;\r\n\r\n  #ifdef DASHED_LINE\r\n    if ( mod( vLineDistance, dashedLinePeriod ) > dashedLineSize ) discard;\r\n  #endif\r\n\r\n  // transparency prepass writes only z, so we don't need to calc the color\r\n  #ifdef PREPASS_TRANSP\r\n    fragColor = vec4(1.0, 1.0, 1.0, 1.0);\r\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n    #endif\r\n    return;\r\n  #endif\r\n\r\n    float totalOpacity = opacity;\r\n\r\n  #ifdef ATTR_ALPHA_COLOR\r\n    totalOpacity *= alphaCol;\r\n  #endif\r\n\r\n  // discard fully transparent pixels\r\n  if (totalOpacity == 0.0) discard;\r\n\r\n  #ifdef FAKE_OPACITY\r\n    // discard pixels in checker pattern\r\n    vec2 dm_coord = floor(gl_FragCoord.xy);\r\n    dm_coord = fract(dm_coord * 0.5);\r\n    if (totalOpacity < 1.0 && (dm_coord.x < 0.5 ^^ dm_coord.y < 0.5)) discard;\r\n    vec4 diffuseColor = vec4(diffuse, 1.0);\r\n  #else\r\n    vec4 diffuseColor = vec4(diffuse, totalOpacity);\r\n  #endif\r\n\r\n  float flipNormal;\r\n  #if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r\n    flipNormal = 1.0;\r\n    #ifdef DOUBLE_SIDED\r\n      flipNormal = float( gl_FrontFacing );\r\n    #endif\r\n    vec3 normal = normalize( vNormal ) * flipNormal;\r\n  #endif\r\n\r\n    diffuseColor.rgb *= vertexColor;\r\n\r\n  #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n    gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n  #endif\r\n\r\n  #ifdef NORMALS_TO_G_BUFFER\r\n    #if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\r\n      vec3 viewNormaInColor = viewNormalSprites;\r\n    #else\r\n      vec3 viewNormaInColor = viewNormal;\r\n      float frontFaced = float( gl_FrontFacing );\r\n    #endif\r\n    // [-1, 1] -> [0, 1]\r\n    viewNormaInColor = 0.5 * viewNormaInColor + 0.5;\r\n    gl_FragData[1] = vec4(viewNormaInColor, frontFaced);\r\n  #endif\r\n\r\n  #if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r\n    vec3 viewDir;\r\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n      viewDir = -pixelPosEye.xyz;\r\n    #else\r\n      viewDir = vViewPosition;\r\n    #endif\r\n    GeometricContext geometry = GeometricContext(normal, normalize( viewDir ));\r\n    BlinnPhongMaterial material = BlinnPhongMaterial(diffuseColor.rgb, specular, shininess);\r\n    vec3 outgoingLight = calcLighting(geometry, material, viewDir);\r\n  #else\r\n    vec3 outgoingLight = diffuseColor.rgb;\r\n  #endif\r\n\r\n  #ifdef COLOR_FROM_DEPTH\r\n    float depth = 0.0;\r\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r\n      depth = gl_FragDepthEXT;\r\n    #else\r\n      depth = gl_FragCoord.z;\r\n    #endif\r\n    fragColor = packDepthToRGBA(depth);\r\n    return;\r\n  #endif\r\n\r\n  #ifdef COLOR_FROM_POS\r\n    fragColor = world2colorMatrix * pixelPosWorld;\r\n  #else\r\n    #ifdef OVERRIDE_COLOR\r\n      fragColor = vec4(fixedColor, diffuseColor.a);\r\n    #else\r\n      fragColor = vec4(outgoingLight, diffuseColor.a);//vec4(vNormal, 1.0);\r\n    #endif\r\n\r\n    #ifdef USE_FOG\r\n      float viewDistance;\r\n      #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r\n        viewDistance = abs(pixelPosEye.z);\r\n      #else\r\n        viewDistance = vViewPosition.z;\r\n      #endif\r\n      float fogFactor = smoothstep( fogNear, fogFar, viewDistance) * fogAlpha;\r\n      #ifdef FOG_TRANSPARENT\r\n        fragColor.a = fragColor.a * (1.0 - fogFactor);\r\n      #else\r\n        fragColor.rgb = mix( fragColor.rgb, fogColor, fogFactor );\r\n      #endif\r\n    #endif\r\n\r\n  #endif\r\n}\r\n",lights:!0,fog:!0,side:r.DoubleSide}),this.setValues(e)}precisionString(){const{precision:e}=Fn;return`precision ${e} float;\nprecision ${e} int;\n\n`}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=r.UniformsUtils.clone(e.uniforms),this.defines={...e.defines},this.extensions=e.extensions,this.fog=e.fog,this.instancedPos=e.instancedPos,this.instancedMatrix=e.instancedMatrix,this.attrColor=e.attrColor,this.attrColor2=e.attrColor2,this.attrAlphaColor=e.attrAlphaColor,this.overrideColor=e.overrideColor,this.sphereSprite=e.sphereSprite,this.cylinderSprite=e.cylinderSprite,this.zClip=e.zClip,this.clipPlane=e.clipPlane,this.fakeOpacity=e.fakeOpacity,this.colorFromPos=e.colorFromPos,this.shadowmap=e.shadowmap,this.shadowmapType=e.shadowmapType,this.colorFromDepth=e.colorFromDepth,this.orthoCam=e.orthoCam,this.prepassTransparancy=e.prepassTransparancy,this.dashedLine=e.dashedLine,this.thickLine=e.thickLine,this.fogTransparent=e.fogTransparent,this.normalsToGBuffer=e.normalsToGBuffer,this.toonShading=e.toonShading,this.uberOptions.copy(e.uberOptions),this}createInstance(){const e=new Qn;return e.copy(this),e.uberOptions=Object.create(this.uberOptions),e}setValues(e){if(void 0===e)return;super.setValues(e);const t={},r={};this.fog&&(t.USE_FOG=1),this.instancedPos&&(t.INSTANCED_POS=1),this.instancedMatrix&&(t.INSTANCED_MATRIX=1),this.attrColor&&(t.ATTR_COLOR=1),this.attrColor2&&(t.ATTR_COLOR2=1),this.attrAlphaColor&&(t.ATTR_ALPHA_COLOR=1),this.overrideColor&&(t.OVERRIDE_COLOR=1),this.sphereSprite&&(t.SPHERE_SPRITE=1,r.fragDepth=!0),this.cylinderSprite&&(t.CYLINDER_SPRITE=1,r.fragDepth=!0),this.zClip&&(t.ZCLIP=1),this.clipPlane&&(t.CLIP_PLANE=1),this.fakeOpacity&&(t.FAKE_OPACITY=1),this.lights&&(t.USE_LIGHTS=1),this.colorFromPos&&(t.COLOR_FROM_POS=1),this.shadowmap&&(t.SHADOWMAP=1,"pcf"===this.shadowmapType?t.SHADOWMAP_PCF_SHARP=1:"random"===this.shadowmapType?t.SHADOWMAP_PCF_RAND=1:t.SHADOWMAP_BASIC=1),this.colorFromDepth&&(t.COLOR_FROM_DEPTH=1),this.orthoCam&&(t.ORTHOGRAPHIC_CAMERA=1),this.prepassTransparancy&&(t.PREPASS_TRANSP=1),this.dashedLine&&(t.DASHED_LINE=1),this.thickLine&&(t.THICK_LINE=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.normalsToGBuffer&&(r.drawBuffers=!0,t.NORMALS_TO_G_BUFFER=1),this.toonShading&&(t.TOON_SHADING=1),this.defines=t,this.extensions=r}setUberOptions(e){if(void 0!==e)for(const t in e)e.hasOwnProperty(t)&&(this.uberOptions[t]instanceof r.Color?this.uberOptions[t]=e[t].clone():this.uberOptions[t]=e[t])}clone(e){return e?this.createInstance():super.clone()}updateUniforms(){const e=this;Zn.forEach((t=>{e.uniforms.hasOwnProperty(t)&&(e.uberOptions[t]instanceof r.Color||e.uberOptions[t]instanceof r.Matrix4?e.uniforms[t].value=e.uberOptions[t].clone():e.uniforms[t].value=e.uberOptions[t])}))}}Qn.prototype.uberOptions=Kn;const Jn=Qn;function es(e){class t extends e{constructor(){super(...arguments),this.onBeforeRender=t.prototype.onBeforeRender}onBeforeRender(e,t,r,n,s,i){this._onBeforeRender(e,t,r,n,s,i),this._update()}_onBeforeRender(){}_update(){const{material:e}=this;e&&e instanceof Jn&&e.updateUniforms()}}return t}const ts=es(r.Mesh);const rs=class extends ts{constructor(){super(...arguments),this.castShadow=!0,this.receiveShadow=!0}_onBeforeRender(e,t,r,n,s,i){ts.prototype._onBeforeRender.call(this,e,t,r);const{material:o}=this;o&&o.uniforms.invModelViewMatrix&&(this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),o.uniforms.invModelViewMatrix.value.copy(this.modelViewMatrix).invert(),o.uniforms.nearPlaneValue.value=r.near,o.uniformsNeedUpdate=!0)}},ns=es(r.Mesh);class ss extends ns{constructor(e,t){super(e,t),this.castShadow=!0,this.receiveShadow=!0}static _mvLength=(()=>new r.Vector3)();static _center=(()=>new r.Vector3)();static _modelView=(()=>new r.Matrix4)();_onBeforeRender(e,t,r){ns.prototype._onBeforeRender.call(this,e,t,r);const n=this.geometry,{material:s}=this;if(!n.zClip||!s.uberOptions)return;const i=ss._modelView,o=ss._mvLength,a=ss._center;i.multiplyMatrices(this.matrixWorld,r.matrixWorldInverse);const l=o.setFromMatrixColumn(i,0).length();a.copy(n.boundingSphere.center),this.localToWorld(a),s.uberOptions.zClipValue=r.position.z-a.z-l*(.5*n.boundingSphere.radius)}}const is=ss;class os extends r.Group{constructor(e,t){super(),this.geometry=e;const r=this;r.initialized=!1,this.geometry.addEventListener("update",(()=>{r.update()}))}init(){const{children:e}=this;for(let t=e.length-1;t>=0;--t)this.remove(e[t]);const{items:r,userData:n}=this.geometry;for(let e=0,s=r.length;e<s;++e){const s=r[e];if(!s)continue;const i=O.shallowCloneNode(s),o=new qt(i);o.userData=t().clone(n);o.getElement().style.visibility="visible",o.source=s,this.add(o)}this.initialized=!0}update(){if(!this.geometry.needsUpdate)return;const{children:e}=this;this.initialized||this.init();for(let t=0,r=e.length;t<r;++t){const r=e[t],n=r.source;r.position.copy(n.worldPos),r.userData.color=n.opts.color,r.userData.background=n.opts.background}}}const as=os,ls=es(r.Mesh);const cs=class extends ls{constructor(e,t){super(e,t),this.castShadow=!0,this.receiveShadow=!0}},hs=es(r.Mesh),us=new r.Vector2;const ds=class extends hs{_onBeforeRender(e,t,r,n,s,i){const{material:o}=this;o.uberOptions&&(o.uberOptions.projMatrixInv.copy(r.projectionMatrix).invert(),e.getSize(us),o.uberOptions.viewport.set(us.width,us.height))}},ps=es(r.Mesh);const ms=class extends ps{constructor(){super(...arguments),this.castShadow=!0,this.receiveShadow=!0}},fs={ZClipped:is,ZSprite:rs,Text:as,Line:es(r.Line),LineSegments:es(r.LineSegments),Mesh:cs,ThickLineMesh:ds,Instanced:ms};function _s(e,t){return function(r){r.setValues(e),r.setUberOptions(t)}}function gs(e,t){return{Geometry:function(r,n){return new zn.Instanced2CCylindersGeometry(r,n,e,t)},Object:e?fs.ZSprite:fs.Instanced,initMaterial:_s({instancedMatrix:!0,attrColor:!0,attrColor2:!0,attrAlphaColor:!0,cylinderSprite:e})}}function ys(e,t){const r=e.prototype instanceof Zr,n=t.lineWidth||0;return{Geometry:e,Object:r?fs.ThickLineMesh:fs.LineSegments,initMaterial:_s({lights:!1,attrColor:!0,attrAlphaColor:!0,thickLine:r},{lineWidth:n})}}function xs(e,t,r,n){const s={wireframe:!!n.wireframe,fakeOpacity:r.now.isoSurfaceFakeOpacity,zClip:n.zClip};return{Geometry:e,Object:fs.ZClipped,initMaterial:_s({attrColor:!0,attrAlphaColor:!1,wireframe:s.wireframe,fakeOpacity:s.fakeOpacity,zClip:s.zClip})}}const bs=class{static createSpheres(e,t){const r=t.now.zSprites;return{Geometry:function(e,t){return new zn.InstancedSpheresGeometry(e,t,r)},Object:r?fs.ZSprite:fs.Instanced,initMaterial:_s({instancedPos:!0,attrColor:!0,attrAlphaColor:!0,sphereSprite:r})}}static create2CClosedCylinders(e,t){return gs(!1,!1)}static create2CCylinders(e,t){return gs(t.now.zSprites,!0)}static create2CLines(e,t,r){return ys(zn.TwoColorLinesGeometry,r)}static createCrosses(e,t,r){return ys(zn.CrossGeometry,r)}static createExtrudedChains(e,t){return{Geometry:zn.ExtrudedObjectsGeometry,Object:fs.Mesh,initMaterial:_s({attrColor:!0,attrAlphaColor:!0})}}static createChunkedLines(e,t,r){return ys(zn.ChunkedLinesGeometry,r)}static createQuickSurface(e,t,r){return xs(zn.QuickSurfGeometry,0,t,r)}static createContactSurface(e,t,r){return xs(zn.ContactSurfaceGeometry,0,t,r)}static createSASSES(e,t,r){return xs(zn.SSIsosurfaceGeometry,0,t,r)}static createLabels(e,t){return{Geometry:zn.LabelsGeometry,Object:fs.Text,initMaterial(){}}}};class ws extends r.Object3D{static _inverseMatrix=(()=>new r.Matrix4)();static _ray=(()=>new r.Ray)();constructor(e,t,n,s){super(),this._geometry=e,this._geoParams=t;const i=n.createInstance();t.initMaterial(i),this._material=i,this._transforms=s.length>0?s:[new r.Matrix4];const o=this._createMeshes(e);for(let e=0,t=o.length;e<t;++e)this.add(o[e])}raycast(e,t){const r=ws._ray,n=ws._inverseMatrix,{children:s}=this;r.copy(e.ray);for(let i=0,o=s.length;i<o;++i){const o=s[i];if(!sr.belongToSelectLayers(o))continue;o.updateMatrixWorld();const a=o.matrixWorld;n.copy(a).invert(),e.ray.copy(r).applyMatrix4(n);const l=[];this._geometry.raycast(e,l);for(let e=0,n=l.length;e<n;++e){const n=l[e];n.point&&(n.point.applyMatrix4(a),n.distance=r.origin.distanceTo(n.point)),n.object=o,t[t.length]=n}}e.ray.copy(r)}getSubset(e){const t=this._geometry.getSubset(e),r=[];let n=0;for(let e=0,s=t.length;e<s;++e){const s=this._createMeshes(t[e]);for(let e=0,t=s.length;e<t;++e)r[n++]=s[e]}return r}_createMeshes(e){const t=this._transforms,r=this._geoParams.Object,n=this._material,s=[];for(let i=0,o=t.length;i<o;++i){const o=new r(e,n);o.applyMatrix4(t[i]),s[i]=o}return s}}const Ss=ws;class vs extends Kt{constructor(e,t,r,n,s,i,o){if(super(),this.constructor===vs)throw new Error("Can not instantiate abstract class!");this._selection=t,this._mode=n,this._colorer=r,this._chunksIdc=t.chunks,this._polyComplexity=i,this._geo=new(function(e,t){const r=[e].concat(t);return e.bind(...r)}(e.Geometry,this._makeGeoArgs())),this._mesh=new Ss(this._geo,e,o,s),this.add(this._mesh),this._build()}_makeGeoArgs(){throw new Error("ChemGroup subclass must override _makeGeoArgs() method")}getSubset(e,t){t=void 0!==t&&t;const r=this._calcChunksList(e,t);return 0===r.length?[]:this._mesh.getSubset(r)}_changeSubsetOpacity(e,t,r){const n=this._calcChunksList(e,r);0!==n.length&&this._geo.setOpacity(n,t)}enableSubset(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,1,t)}disableSubset(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,0,t)}}const Cs=vs;const As=class extends Cs{raycast(e,t){const{atoms:r}=this._selection,n=[];this._mesh.raycast(e,n);const s=this._chunksIdc;for(let e=0,i=n.length;e<i;++e){if(!n[e].hasOwnProperty("chunkIdx"))continue;const i=s[n[e].chunkIdx];i<r.length&&(n[e].atom=r[i],t.push(n[e]))}}_calcChunksList(e){const t=[],{atoms:r}=this._selection,n=this._chunksIdc;for(let s=0,i=n.length;s<i;++s){0!=(r[n[s]].mask&e)&&t.push(s)}return t}};const Es=class extends As{_makeGeoArgs(){return[this._selection.chunks.length,this._polyComplexity]}_build(){const e=this._selection.chunks,{atoms:t,parent:r}=this._selection,n=this._mode,s=this._colorer,i=this._geo;for(let o=0,a=e.length;o<a;++o){const a=t[e[o]];i.setItem(o,a.position,n.calcAtomRadius(a)),i.setColor(o,s.getAtomColor(a,r))}i.finalize()}updateToFrame(e){const t=this._selection.chunks,{atoms:r}=this._selection,n=this._mode,s=this._colorer,i=e.needsColorUpdate(s),o=this._geo;for(let a=0,l=t.length;a<l;++a){const l=r[t[a]];o.setItem(a,e.getAtomPos(t[a]),n.calcAtomRadius(l)),i&&o.setColor(a,e.getAtomColor(s,l))}o.finalize()}};const Ts=class extends Es{_makeGeoArgs(){const e=[],{atoms:t,chunks:r}=this._selection,n=r.length;for(let s=0;s<n;++s)e[s]=t[r[s]];const s=this._mode.getSurfaceOpts();return s.atoms=e,[n,s]}};const Rs=class extends Es{_makeGeoArgs(){const e=[],{atoms:t,chunks:r}=this._selection,n=r.length;for(let s=0;s<n;++s)e[s]=t[r[s]];const s=this._mode.getSurfaceOpts();return s.atoms=e,s.selection=this._selection,s.colorMode=this._colorer,[n,s]}};function Ms(e){return null!==e.name.getNode()?e.name.getNode():e.getVisualName()}const Ps={none:e=>e,adjust:function(e){let t=e>>16&255,r=e>>8&255,n=255&e;return.2126*t+.7152*r+.0722*n>127?(t=3*t/10,r=3*r/10,n=3*n/10):(t=255-3*(255-t)/10,r=255-3*(255-r)/10,n=255-3*(255-n)/10),t<<16|r<<8|n},inverse:function(e){return 255-(e>>16&255)<<16|255-(e>>8&255)<<8|255-(255&e)}};function Ns(e,t){let r;if(Ps.hasOwnProperty(t))r=O.hexColor(Ps[t](e));else{const e=parseInt(t,16);r=!Number.isNaN(e)&&t.toLowerCase().startsWith("0x")?O.hexColor(e):"#000000"}return r}const Ls={serial:e=>e.serial,name:e=>e.getVisualName(),elem:e=>e.element.name,residue:e=>e.residue.getType().getName(),sequence:e=>e.residue.getSequence(),chain:e=>e.residue.getChain().getName(),hetatm:e=>e.isHet(),water:e=>"HOH"===e.residue.getType().getName()||"WAT"===e.residue.getType().getName()},Is=function(e,t){return t.replace(/\{\{(\s*\w+\s*)\}\}/g,(t=>{let r=t.replace(/\s+/g,"");return r=r.substring(2,r.length-2).toLowerCase(),Ls.hasOwnProperty(r)?Ls[r](e):"null"}))};const Os=class extends As{_makeGeoArgs(){const e=this._mode.getLabelOpts();return[this._selection.chunks.length,e]}_build(){const e=this._mode.getLabelOpts(),t=this._selection.chunks,{atoms:r,parent:n}=this._selection,s=this._colorer,i=this._geo;for(let o=0,a=t.length;o<a;++o){const a=r[t[o]],l=e.template?Is(a,e.template):Ms(a);if(!l)continue;const c=s.getAtomColor(a,n),h=parseInt(Ns(c,e.fg).substring(1),16),u=e.showBg?parseInt(Ns(c,e.bg).substring(1),16):"transparent";i.setItem(o,a.position,l),i.setColor(o,h,u)}i.finalize()}updateToFrame(e){const t=this._mode.getLabelOpts(),r=this._selection.chunks,{atoms:n}=this._selection,s=this._colorer,i=this._geo,o=e.needsColorUpdate(s);for(let a=0,l=r.length;a<l;++a){const l=n[r[a]],c=t.template?Is(l,t.template):Ms(l);if(!c)continue;const h=e.getAtomColor(s,l),u=parseInt(Ns(h,t.fg).substring(1),16),d=t.showBg?parseInt(Ns(h,t.bg).substring(1),16):"transparent";i.setItem(a,e.getAtomPos(r[a]),c),o&&i.setColor(a,u,d)}i.finalize()}};function Vs(e,t,r,n){const s=Math.sin(e);return t.clone().multiplyScalar(Math.sin((1-n)*e)/s).addScaledVector(r,Math.sin(n*e)/s)}const Ds=class extends As{_buildInner(e,t){const n=this._selection.chunks,s=new r.Vector3,i=new r.Vector3,o=this._segmentsHeight,a=1/o,l=this._colorer,{cycles:c,parent:h}=this._selection;let u=0,d=n[u];for(let r=0,p=c.length;r<p;++r){const p=c[r],m=p.atoms,f=[],_=[],{center:g}=p,y=p.radius-e,x=m.length;let b=0;const w=m[x-1].position;let S=m[b].position;s.subVectors(w,g),i.subVectors(S,g);const v=i.clone().cross(s).normalize();for(;b<x;++b){const e=s.angleTo(i);_[b]=Vs(e,s,i,.5).normalize(),S=m[(b+1)%x].position,s.copy(i),i.subVectors(S,g)}for(b=0;b<x;++b){if(m[b].index!==d)continue;const e=_[b],r=_[(b+1)%x],s=l.getAtomColor(m[b],h),i=e.angleTo(r);for(let t=0;t<=o;++t)f[t]=Vs(i,e,r,t*a).multiplyScalar(y).add(g);t(u++,s,f,g,v),d=n[u]}}}};function ks(e,t){const n=[];for(let s=0;s<t;++s){const i=-2*s/t*Math.PI;n.push(new r.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}const{calcChunkMatrix:zs}=sr;const Fs=class extends Ds{_build(){const e=this._segmentsHeight,t=this._mode.getAromRadius(),n=new r.Vector2(t,t),s=this._mode.calcStickRadius()+2*t,i=new r.Vector3,o=[],a=this._geo;this._buildInner(s,((t,r,s,l,c)=>{for(let t=0;t<=e;++t){const e=s[t],r=e.clone().sub(l).cross(c);i.addVectors(e,r),o[t]=zs(e,i,c,n)}a.setItem(t,o),a.setColor(t,r)})),a.finalize()}_makeGeoArgs(){return this._segmentsHeight=this._polyComplexity,[ks(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length]}};const Bs=class extends Ds{_build(){const e=this._geo,t=this._mode.getAromaticOffset();this._buildInner(t,((t,r,n)=>{let s=n[0];for(let r=1;r<=this._segmentsHeight;++r){const i=n[r];e.setSegment(t,r-1,s,i),s=i}e.setColor(t,r)})),e.finalize()}_makeGeoArgs(){return this._segmentsHeight=this._mode.getAromaticArcChunks(),[this._selection.chunks.length,this._segmentsHeight,!0]}};const Us=class extends Cs{raycast(e,t){const{residues:r}=this._selection,n=[];this._mesh.raycast(e,n);const s=this._chunksIdc;for(let e=0,i=n.length;e<i;++e){if(!n[e].hasOwnProperty("chunkIdx"))continue;const i=s[n[e].chunkIdx];i<r.length&&(n[e].residue=r[i],t.push(n[e]))}}_calcChunksList(e){const t=[],{residues:r}=this._selection,n=this._chunksIdc;for(let s=0,i=n.length;s<i;++s){0!=(r[n[s]]._mask&e)&&t.push(s)}return t}};const Gs=class extends Us{raycast(e,t){const{residues:r}=this._selection,n=[];this._mesh.raycast(e,n);const s=this._chunksIdc;for(let e=0,i=n.length;e<i;++e){if(!n[e].hasOwnProperty("chunkIdx"))continue;const i=s[Math.floor(n[e].chunkIdx/2)];i<r.length&&(n[e].residue=r[i],t.push(n[e]))}}_build(){const{residues:e,parent:t}=this._selection,r=this._colorer,n=this._geo,s=this._mode.calcStickRadius();let i=0;const o=this._selection.chunks;for(let n=0,a=o.length;n<a;++n){const a=e[o[n]],l=r.getResidueColor(a,t);this._processItem(i++,a._cylinders[0],a._cylinders[1],s,l)}n.finalize()}_calcChunksList(e){const t=[];let r=0;const{residues:n}=this._selection,s=this._chunksIdc;for(let i=0,o=s.length;i<o;++i){0!=(n[s[i]]._mask&e)&&(t[r++]=2*i,t[r++]=2*i+1)}return t}updateToFrame(e){const t=e.getResidues(),{parent:r}=this._selection,n=this._colorer,s=this._geo,i=this._mode.calcStickRadius();let o=0;const a=this._selection.chunks;for(let e=0,s=a.length;e<s;++e){const s=t[a[e]],l=n.getResidueColor(s,r);this._processItem(o++,s._cylinders[0],s._cylinders[1],i,l)}s.finishUpdate()}};const js=class extends Gs{_makeGeoArgs(){return[this._selection.chunks.length,this._polyComplexity]}_processItem(e,t,r,n,s){const i=this._geo;i.setItem(e,t,r,n),i.setColor(e,s,s)}};const Hs=class extends Gs{_makeGeoArgs(){return[2*this._selection.chunks.length,this._polyComplexity]}_processItem(e,t,r,n,s){const i=this._geo;let o=2*e;i.setItem(o,t,n),i.setColor(o,s),o++,i.setItem(o,r,n),i.setColor(o,s)}};var $s=s(690);const{ResidueType:Ws}=Yt,Ys=sr.calcChunkMatrix;function Xs(e,t){const n=(0,$s.Smooth)(e,{method:$s.Smooth.METHOD_CUBIC,clip:$s.Smooth.CLIP_CLAMP,cubicTension:t,scaleTo:1});return function(t,s){let i=s;null===i&&(i=function(t){return(t*(e.length-1-2)+1)/(e.length-1)});const o=i(t),a=n(o);return new r.Vector3(a[0],a[1],a[2])}}function qs(e,t,r,n){if(!n._isValid)return e[r]=e[r-1],void(t[r]=t[r-1]);const s=n._controlPoint;e[r]=[s.x,s.y,s.z];const i=s.clone().add(n._wingVector);t[r]=[i.x,i.y,i.z]}function Zs(e,t,r,n){const s=n.start,i=n.end;function o(t){return t>s&&e[t-1]._isValid?t-1:t}function a(t){return t<i&&e[t+1]._isValid?t+1:t}const l=[],c=[];let h=0;function u(t,r){const n=e[t]._controlPoint.clone().lerp(e[r]._controlPoint,-.25),s=n.clone().add(e[t]._wingVector);c[h]=[n.x,n.y,n.z],l[h++]=[s.x,s.y,s.z],c[h]=[n.x,n.y,n.z],l[h++]=[s.x,s.y,s.z]}const d=o(t),p=a(r);if(d===p)return function(e,t,r,n){const s=0!=(n._type.flags&Ws.Flags.NUCLEIC),i=s?"C5'":"N",o=s?"C3'":"C";let a,l;if(n.forEachAtom((e=>{const t=e.getVisualName();a||t!==i?l||t!==o||(l=e.position):a=e.position})),a&&l||(a=n._firstAtom.position,l=n._lastAtom.position),a&&l){const s=l.clone().sub(a),i=n._wingVector,o=n._controlPoint,c=o.clone().add(i),h=o.clone().sub(s),u=h.clone().add(i);e[r]=[h.x,h.y,h.z],t[r]=[u.x,u.y,u.z],e[++r]=[h.x,h.y,h.z],t[r]=[u.x,u.y,u.z],e[++r]=[o.x,o.y,o.z],t[r]=[c.x,c.y,c.z],++r;const d=o.clone().add(s),p=d.clone().add(i);e[r]=[d.x,d.y,d.z],t[r]=[p.x,p.y,p.z],e[++r]=[d.x,d.y,d.z],t[r]=[p.x,p.y,p.z]}}(c,l,h,e[t]),{centerPoints:c,topPoints:l};t===d?u(t,a(t)):(qs(c,l,h++,e[o(d)]),qs(c,l,h++,e[d]));for(let n=t;n<=r;++n)qs(c,l,h++,e[n]);return p===a(p)?u(r,o(r)):(qs(c,l,h++,e[p]),qs(c,l,h,e[a(p)])),{centerPoints:c,topPoints:l}}const Ks=class{constructor(e,t,r,n,s,i){const o=Zs(e,t,r,i);this._topInterp=Xs(o.topPoints,s),this._centerInterp=Xs(o.centerPoints,s),this._shift=.5/(r-t+2),this._valueStep=(1-2*this._shift)/(2*(r-t+1)*(n-1)),this._segmentsCount=n}prepareMatrices(e,t,n){const s=this._segmentsCount,i=new Array(s),o=new r.Vector2(0,0),a=this._topInterp,l=this._centerInterp;let c=this._shift+this._valueStep*(s-1)*e;for(let e=0;e<s;++e){const r=Math.min(1,e/(s-1));o.lerpVectors(t,n,r);const h=a(c,null),u=l(c,null);c+=this._valueStep;const d=l(c,null);i[e]=Ys(u.clone(),d.clone(),h.clone().sub(u),o)}return i}};function Qs(e,t){const n=[];for(let s=0;s<t;++s){const i=Math.PI/2-2*Math.PI*s/t;n.push(new r.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}function Js(e,t,r,n,s,i){for(let o=0,a=e.length;o<a;++o){const a=e[o].arr,{boundaries:l}=e[o];for(let e=0,o=a.length;e<o;++e){const o=[a[e].start,a[e].end],c=new Ks(t,o[0],o[1],r,n,l);let h=null;const u=2*a[e].start,d=2*a[e].end+1;let p=s.getResidueRadius(t[0],0);for(let e=u;e<=d;++e){const n=t[e/2|0],a=s.getResidueRadius(n,e%2),l=s.getResidueRadius(n,1+e%2),u=c.prepareMatrices(e-2*o[0],a,l);u.unshift(null===h?u[0]:h);i(n,u,a.x!==l.x||a.y!==l.y,a.x!==p.x||a.y!==p.y),h=u[r],p=l}}}}const ei=class extends Us{_makeGeoArgs(){const e=this._mode.getHeightSegmentsRatio();return this._segmentsHeight=this._polyComplexity*e|0,[Qs(1,this._polyComplexity),this._segmentsHeight+1,2*this._selection.chunks.length]}_build(){const{residues:e,parent:t}=this._selection,r=this._mode,n=this._colorer,s=r.getTension(),i=this._geo;let o=0;const a=[];Js(this._selection.subdivs,e,this._segmentsHeight,s,r,(function(e,r){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],l=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const c=n.getResidueColor(e,t);a[o]=e._index,i.setItem(o,r,s,l),i.setColor(o++,c)})),this._chunksIdc=a,i.finalize()}updateToFrame(e){const{parent:t}=this._selection,r=this._mode,n=this._colorer,s=r.getTension(),i=this._geo,o=e.getResidues();let a=0;const l=e.needsColorUpdate(n);Js(this._selection.subdivs,o,this._segmentsHeight,s,r,((e,r)=>{i.setItem(a,r),l&&i.setColor(a,n.getResidueColor(e,t)),a++})),i.finalize()}};const ti=class extends Cs{_makeGeoArgs(){const e=this._selection.subdivs;let t=0;for(let r=0,n=e.length;r<n;++r){const n=e[r].arr;for(let e=0,r=n.length;e<r;++e)t+=n[e].end-n[e].start}return[t,this._polyComplexity]}_build(){const{residues:e,parent:t}=this._selection,r=this._mode,n=this._colorer,s=this._geo;let i=0;const o=[],a=this._selection.subdivs,l=r.calcStickRadius();for(let r=0,c=a.length;r<c;++r){const c=a[r].arr;for(let r=0,a=c.length;r<a;++r){const a=c[r].start,h=c[r].end;let u=e[a];for(let r=a+1;r<=h;++r){const a=e[r];o[i]={first:u._index,second:a._index},s.setItem(i,u._controlPoint,a._controlPoint,l),s.setColor(i,n.getResidueColor(u,t),n.getResidueColor(a,t)),i++,u=a}}}this._chunksIdc=o,s.finalize()}updateToFrame(e){const t=e.getResidues(),{parent:r}=this._selection,n=this._mode,s=this._colorer,i=this._geo;let o=0;const a=this._selection.subdivs,l=n.calcStickRadius(),c=e.needsColorUpdate(s);for(let e=0,n=a.length;e<n;++e){const n=a[e].arr;for(let e=0,a=n.length;e<a;++e){const a=n[e].start,h=n[e].end;let u=t[a];for(let e=a+1;e<=h;++e){const n=t[e];i.setItem(o,u._controlPoint,n._controlPoint,l),c&&i.setColor(o,s.getResidueColor(u,r),s.getResidueColor(n,r)),o++,u=n}}}i.finalize()}raycast(e,t){const r=[],{residues:n}=this._selection;this._mesh.raycast(e,r);const s=this._chunksIdc;for(let e=0,i=r.length;e<i;++e){if(!r[e].hasOwnProperty("chunkIdx"))continue;const{chunkIdx:i}=r[e],o=s[Math.floor(i/2)],a=i%2==0?o.first:o.second;a<n.length&&(r[e].residue=n[a],t.push(r[e]))}}_calcChunksList(e){const t=[],r=this._chunksIdc,{residues:n}=this._selection;for(let s=0,i=r.length;s<i;++s){const i=r[s];n[i.first]._mask&e&&t.push(2*s),n[i.second]._mask&e&&t.push(2*s+1)}return t}};const ri=class extends Cs{_makeGeoArgs(){const e=this._mode.drawMultiorderBonds(),t=this._mode.showAromaticLoops(),r=this._selection.chunks,{bonds:n}=this._selection;let s=0;for(let i=0,o=r.length;i<o;++i)s+=this.getBondOrder(n[r[i]],e,t);return[s,this._polyComplexity]}getBondOrder(e,t,r){let n=1;return!t||r&&e._type===_e.BondType.AROMATIC||(n=function(e){return e<2?1:e}(e._order)),n}raycast(e,t){const{bonds:r}=this._selection,n=[];this._mesh.raycast(e,n);const s=this._chunksIdc;for(let e=0,i=n.length;e<i;++e){if(!n[e].hasOwnProperty("chunkIdx"))continue;const{chunkIdx:i}=n[e],o=s[Math.floor(i/2)];if(o<r.length){const s=r[o];n[e].atom=i%2==0?s._left:s._right,t.push(n[e])}}}_calcChunksList(e,t){const r=[],{bonds:n}=this._selection,s=this._chunksIdc;for(let i=0,o=s.length;i<o;++i){const o=n[s[i]];o._left.mask&e&&(!t||o._right.mask&e)&&r.push(2*i),o._right.mask&e&&(!t||o._left.mask&e)&&r.push(2*i+1)}return r}};const ni=class extends ri{_build(){const e=this._selection.chunks,{bonds:t,parent:n}=this._selection,s=this._mode,i=this._colorer,o=this._geo,a=s.drawMultiorderBonds(),l=s.showAromaticLoops(),c=s.calcStickRadius(),h=s.calcSpaceFraction();let u;const d=new r.Vector3,p=new r.Vector3;let m=0;const f=[];for(let r=0,_=e.length;r<_;++r){const _=t[e[r]],g=_._left,y=_._right,x=g.position,b=y.position;u=_.calcNormalDir();const w=this.getBondOrder(_,a,l),S=2*Math.min(s.calcAtomRadius(g),s.calcAtomRadius(y))/w,v=a?Math.min(c,.5*S*(1-h)):c;for(let e=0;e<w;++e){const t=S*(w%2==0?(.5+(e/2|0))*(1-e%2*2):((e+1)/2|0)*(e%2*2-1));f[m]=_._index,d.copy(x),d.addScaledVector(u,t),p.copy(b),p.addScaledVector(u,t),o.setItem(m,d,p,v),o.setColor(m++,i.getAtomColor(g,n),i.getAtomColor(y,n))}}o.finalize(),this._chunksIdc=f}updateToFrame(e){const t=this._selection.chunks,{bonds:n}=this._selection,s=this._mode,i=this._colorer,o=this._geo,a=s.drawMultiorderBonds(),l=s.showAromaticLoops(),c=s.calcStickRadius(),h=s.calcSpaceFraction();let u;const d=new r.Vector3,p=new r.Vector3;let m=0;const f=e.needsColorUpdate(i);for(let r=0,_=t.length;r<_;++r){const _=n[t[r]],g=_._left,y=_._right,x=e.getAtomPos(g.index).clone(),b=e.getAtomPos(y.index);u=_.calcNormalDir();const w=this.getBondOrder(_,a,l),S=2*Math.min(s.calcAtomRadius(g),s.calcAtomRadius(y))/w,v=a?Math.min(c,.5*S*(1-h)):c;for(let t=0;t<w;++t){const r=S*(w%2==0?(.5+(t/2|0))*(1-t%2*2):((t+1)/2|0)*(t%2*2-1));d.copy(x),d.addScaledVector(u,r),p.copy(b),p.addScaledVector(u,r),o.setItem(m,d,p,v),f&&o.setColor(m,e.getAtomColor(i,g),e.getAtomColor(i,y)),m++}}o.finalize()}},si=.15;const ii={AtomsSphereGroup:Es,AtomsSurfaceGroup:Ts,AtomsSASSESGroupStub:Rs,AtomsTextGroup:Os,AromaticTorusGroup:Fs,AromaticLinesGroup:Bs,NucleicCylindersGroup:js,NucleicSpheresGroup:Hs,ResiduesSubseqGroup:ei,ResiduesTraceGroup:ti,BondsCylinderGroup:ni,BondsLinesGroup:class extends ri{_build(){const e=this._selection.chunks,{bonds:t,parent:n}=this._selection,s=this._mode,i=this._colorer,o=this._geo,a=s.drawMultiorderBonds(),l=s.showAromaticLoops(),c=new r.Vector3,h=new r.Vector3,u=new r.Vector3;let d=0;const p=[];for(let r=0,s=e.length;r<s;++r){const s=t[e[r]],m=s._left,f=s._right,_=m.position,g=f.position,y=1===m.bonds.length,x=1===f.bonds.length;c.subVectors(g,_);const b=c.length(),w=s.calcNormalDir(),S=this.getBondOrder(s,a,l);for(let e=0;e<S;++e){h.copy(_),u.copy(g);let t=S%2==0?(.5+(e/2|0))*(1-e%2*2):((e+1)/2|0)*(e%2*2-1);p[d]=s._index,2!==S||y||x||(t-=.5,t*=-1),!y&&!x&&S>1&&0!==t&&(h.lerpVectors(_,g,si/b),u.lerpVectors(_,g,1-si/b)),t*=si,h.addScaledVector(w,t),u.addScaledVector(w,t),o.setItem(d,h,u),o.setColor(d++,i.getAtomColor(m,n),i.getAtomColor(f,n))}}o.finalize(),this._chunksIdc=p}updateToFrame(e){const t=this._selection.chunks,{bonds:n}=this._selection,s=this._mode,i=this._colorer,o=this._geo,a=s.drawMultiorderBonds(),l=s.showAromaticLoops(),c=new r.Vector3,h=new r.Vector3,u=new r.Vector3;let d=0;const p=e.needsColorUpdate(i);for(let r=0,s=t.length;r<s;++r){const s=n[t[r]],m=s._left,f=s._right,_=e.getAtomPos(m.index).clone(),g=e.getAtomPos(f.index),y=1===m.bonds.length,x=1===f.bonds.length;c.subVectors(g,_);const b=c.length(),w=s.calcNormalDir(),S=this.getBondOrder(s,a,l);for(let t=0;t<S;++t){h.copy(_),u.copy(g);let r=S%2==0?(.5+(t/2|0))*(1-t%2*2):((t+1)/2|0)*(t%2*2-1);2!==S||y||x||(r-=.5,r*=-1),!y&&!x&&S>1&&0!==r&&(h.lerpVectors(_,g,si/b),u.lerpVectors(_,g,1-si/b)),r*=si,h.addScaledVector(w,r),u.addScaledVector(w,r),o.setItem(d,h,u),p&&o.setColor(d,e.getAtomColor(i,m),e.getAtomColor(i,f)),d++}}o.finalize()}}};const oi=class extends Kt{constructor(e,t,r,n,s,i,o,a){super();const l=this;this._complex=r,this._mode=s;const c=r.getAtoms(),h=r.getTransforms();r.forEachComponent((u=>{const d=[];let p=0;if(u.forEachAtom((e=>{l._checkAtom(e,o)&&(d[p++]=e.index)})),0===p)return;const m=new e(t,{atoms:c,chunks:d,parent:r},n,s,h,i,a);m._component=u,l.add(m)}))}_checkAtom(e,t){return e.mask&t}getSubset(e,t){const r=[],{children:n}=this;let s=0;for(let i=0,o=n.length;i<o;++i)if(n[i].getSubset){const o=n[i].getSubset(e,t);for(let e=0,t=o.length;e<t;++e){const t=o[e];t._component=n[i]._component,r[s++]=t}}return r}};const ai=class extends oi{_checkAtom(e,t){if(!(e.mask&t))return!1;const{bonds:r}=e;for(let e=0,n=r.length;e<n;++e)if(r[e]._left.mask&t&&r[e]._right.mask&t)return!1;return!0}};const li=class extends Kt{constructor(e,t,r,n,s,i,o,a){super();const l=this;this._complex=r;const c=r.getResidues(),h=r.getTransforms();r.forEachComponent((u=>{let d=0;const p=[];if(u.forEachResidue((e=>{l._checkResidue(e,o)&&(p[d++]=e._index)})),0===d)return;const m=new e(t,{residues:c,chunks:p,parent:r},n,s,h,i,a);m._component=u,l.add(m)}))}checkResidue(e,t){return e._mask&t}getSubset(e,t){const r=[],{children:n}=this;let s=0;for(let i=0,o=n.length;i<o;++i)if(n[i].getSubset){const o=n[i].getSubset(e,t);for(let e=0,t=o.length;e<t;++e){const t=o[e];t._component=n[i]._component,r[s++]=t}}return r}};const ci=class extends li{_checkResidue(e,t){return t&e._mask&&null!==e._cylinders}};const hi=class extends Kt{constructor(e,t,r,n,s,i,o,a){super();const l=this;this._complex=r;const c=r.getResidues(),h=r.getTransforms();r.forEachComponent((u=>{const d=u.getMaskedSubdivSequences(o);let p=0;const m=[];for(let e=0,t=d.length;e<t;++e){const t=d[e].arr;for(let e=0,r=t.length;e<r;++e)for(let r=t[e].start,n=t[e].end;r<=n;++r)m[p++]=c[r]._index}if(0===p)return;const f=new e(t,{residues:c,chunks:m,subdivs:d,parent:r},n,s,h,i,a);f._component=u,l.add(f)}))}getSubset(e,t){const r=[],{children:n}=this;let s=0;for(let i=0,o=n.length;i<o;++i)if(n[i].getSubset){const o=n[i].getSubset(e,t);for(let e=0,t=o.length;e<t;++e){const t=o[e];t._component=n[i]._component,r[s++]=t}}return r}};const ui=class extends Kt{constructor(e,t,r,n,s,i,o,a){super();const l=this;this._complex=r;const c=r.getBonds(),h=r.getTransforms();r.forEachComponent((u=>{const d=[];let p=0;if(u.forEachBond((e=>{const t=e._left,r=e._right;t.mask&o&&r.mask&o&&(d[p++]=e._index)})),0===p)return;const m=new e(t,{bonds:c,chunks:d,parent:r},n,s,h,i,a);m._component=u,l.add(m)}))}getSubset(e,t){const r=[],{children:n}=this;let s=0;for(let i=0,o=n.length;i<o;++i)if(n[i].getSubset){const o=n[i].getSubset(e,t);for(let e=0,t=o.length;e<t;++e){const t=o[e];t._component=n[i]._component,r[s++]=t}}return r}};const di=class extends Kt{constructor(e,t,r,n,s,i,o,a){super();const l=this;this._complex=r;const c=r.getAtoms(),h=r.getTransforms();s.showAromaticLoops()&&r.forEachComponent((u=>{const d=[];let p=0;const m=[];let f=0;u.forEachCycle((e=>{const t=e.atoms;let r=0;for(let e=0,n=t.length;e<n;++e)0!=(t[e].mask&o)&&(++r,d[p++]=t[e].index);r>0&&(m[f++]=e)}));const _=new e(t,{cycles:m,atoms:c,chunks:d,parent:r},n,s,h,i,a);_._component=u,l.add(_)}))}getSubset(e,t){const r=[],{children:n}=this;let s=0;for(let i=0,o=n.length;i<o;++i)if(n[i].getSubset){const o=n[i].getSubset(e,t);for(let e=0,t=o.length;e<t;++e){const t=o[e];t._component=n[i]._component,r[s++]=t}}return r}},pi={Atoms:oi,OrphanAtoms:ai,Residues:li,Nucleic:ci,Subseqs:hi,Bonds:ui,Aromatic:di};function mi(e,t,r){return function(n,s,i,o,a,l){return new t(r,e,n,s,i,o,a,l)}}const fi=class{static AtomsSpheres(e,t){return mi(bs.createSpheres(e,t),pi.Atoms,ii.AtomsSphereGroup)}static OrphanedAtomsCrosses(e,t,r){return mi(bs.createCrosses(e,t,r),pi.OrphanAtoms,ii.AtomsSphereGroup)}static BondsCylinders(e,t){return mi(bs.create2CCylinders(e,t),pi.Bonds,ii.BondsCylinderGroup)}static BondsLines(e,t,r){return mi(bs.create2CLines(e,t,r),pi.Bonds,ii.BondsLinesGroup)}static CartoonChains(e,t){return mi(bs.createExtrudedChains(e,t),pi.Subseqs,ii.ResiduesSubseqGroup)}static TraceChains(e,t){return mi(bs.create2CClosedCylinders(e,t),pi.Subseqs,ii.ResiduesTraceGroup)}static NucleicSpheres(e,t){return mi(bs.createSpheres(e,t),pi.Nucleic,ii.NucleicSpheresGroup)}static NucleicCylinders(e,t){return mi(bs.create2CCylinders(e,t),pi.Nucleic,ii.NucleicCylindersGroup)}static ALoopsTorus(e,t){return mi(bs.createExtrudedChains(e,t),pi.Aromatic,ii.AromaticTorusGroup)}static ALoopsLines(e,t,r){return mi(bs.createChunkedLines(e,t,r),pi.Aromatic,ii.AromaticLinesGroup)}static QuickSurfGeo(e,t,r){return mi(bs.createQuickSurface(e,t,r),pi.Atoms,ii.AtomsSurfaceGroup)}static ContactSurfaceGeo(e,t,r){return mi(bs.createContactSurface(e,t,r),pi.Atoms,ii.AtomsSurfaceGroup)}static SASSESSurfaceGeo(e,t,r){return mi(bs.createSASSES(e,t,r),pi.Atoms,ii.AtomsSASSESGroupStub)}static TextLabelsGeo(e,t){return mi(bs.createLabels(e,t),pi.Atoms,ii.AtomsTextGroup)}};class _i{constructor(e){if(this.constructor===_i)throw new Error("Can not instantiate abstract class!");this.opts=t().merge(O.deriveDeep(this.settings.now.modes[this.id],!0),e)}identify(){const e=O.objectsDiff(this.opts,this.settings.now.modes[this.id]);return t().isEmpty(e)?this.id:[this.id,e]}buildGeometry(e,r,n,s){const i=this.opts.polyComplexity?this.opts.polyComplexity[this.settings.now.resolution]:0,o=this.depGroups,a=o.length,l=new sr.RCGroup,c=this;for(let h=0;h<a;++h){let a=o[h],u={};t().isArray(a)&&(u=a[1].call(this),[a]=a);const d=new(fi[a](null,this.settings,u))(e,r,c,i,n,s);d.children.length>0&&l.add(d)}return l}}ur(_i.prototype),_i.prototype.id="__",_i.prototype.depGroups=[];const gi=_i;function yi(){return{lineWidth:this.opts.lineWidth}}class xi extends gi{static id="LN";constructor(e){super(e),this.depGroups=this.depGroups.slice(0);const t=this.depGroups;for(let e=0,r=t.length;e<r;++e)t[e]=[t[e],yi]}drawMultiorderBonds(){return this.opts.multibond}calcAtomRadius(){return this.opts.atom}getAromaticOffset(){return this.opts.offsarom}getAromaticArcChunks(){return this.opts.chunkarom}showAromaticLoops(){return this.opts.showarom}}xi.prototype.id="LN",xi.prototype.name="Lines",xi.prototype.shortName="Lines",xi.prototype.depGroups=["ALoopsLines","BondsLines","OrphanedAtomsCrosses"];const bi=xi;class wi extends gi{static id="LC";calcAtomRadius(e){return this.opts.bond}calcStickRadius(){return this.opts.bond}calcSpaceFraction(){return this.opts.space}getAromRadius(){return this.opts.aromrad}showAromaticLoops(){return this.opts.showarom}drawMultiorderBonds(){return this.opts.multibond}}wi.prototype.id="LC",wi.prototype.name="Licorice",wi.prototype.shortName="Licorice",wi.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];const Si=wi;class vi extends gi{static id="BS";calcAtomRadius(e){return e.element.radius*this.opts.atom}calcStickRadius(){return this.opts.bond}getAromRadius(){return this.opts.aromrad}showAromaticLoops(){return this.opts.showarom}calcSpaceFraction(){return this.opts.space}drawMultiorderBonds(){return this.opts.multibond}}vi.prototype.id="BS",vi.prototype.name="Balls and Sticks",vi.prototype.shortName="Balls",vi.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];const Ci=vi;class Ai extends gi{static id="VW";calcAtomRadius(e){return e.element.radius}}Ai.prototype.id="VW",Ai.prototype.name="Van der Waals",Ai.prototype.shortName="VDW",Ai.prototype.depGroups=["AtomsSpheres"];const Ei=Ai;class Ti extends gi{static id="TR";calcStickRadius(){return this.opts.radius}}Ti.prototype.id="TR",Ti.prototype.name="Trace",Ti.prototype.shortName="Trace",Ti.prototype.depGroups=["TraceChains"];const Ri=Ti;class Mi extends gi{static id="TU";getResidueRadius(e){return this.TUBE_RADIUS}getHeightSegmentsRatio(){return this.opts.heightSegmentsRatio}getTension(){return this.opts.tension}buildGeometry(e,t,n,s){const i=this.opts.radius;return this.TUBE_RADIUS=new r.Vector2(i,i),gi.prototype.buildGeometry.call(this,e,t,n,s)}}Mi.prototype.id="TU",Mi.prototype.name="Tube",Mi.prototype.shortName="Tube",Mi.prototype.depGroups=["CartoonChains"];const Pi=Mi;class Ni extends gi{static id="CA";constructor(e){super(e),this.secCache={}}getResidueStartRadius(e){const t=e.getSecondary();if(!t||!t.generic)return this.TUBE_RADIUS;const r=this.secCache[t.generic];return r?t.term===e?r.start:r.center:this.TUBE_RADIUS}getResidueEndRadius(e){const t=e.getSecondary();if(null===t||!t.generic)return this.TUBE_RADIUS;const r=this.secCache[t.generic];return r?t.term===e?this.ARROW_END:r.center:this.TUBE_RADIUS}getResidueRadius(e,t){const r=this.getResidueStartRadius(e);if(0===t)return r;const n=this.getResidueEndRadius(e);return 2===t?n:r.clone().lerp(n,t/2)}calcStickRadius(e){return this.opts.radius}getHeightSegmentsRatio(){return this.opts.heightSegmentsRatio}getTension(){return this.opts.tension}buildGeometry(e,t,n,s){const i=this.opts.radius,o=this.opts.depth;this.TUBE_RADIUS=new r.Vector2(i,i),this.ARROW_END=new r.Vector2(o,i);const a={},l=this.opts.ss;for(const e in l)a[e]={center:new r.Vector2(o,l[e].width),start:new r.Vector2(o,l[e].arrow)};return this.secCache=a,gi.prototype.buildGeometry.call(this,e,t,n,s)}}Ni.prototype.id="CA",Ni.prototype.name="Cartoon",Ni.prototype.shortName="Cartoon",Ni.prototype.depGroups=["CartoonChains","NucleicSpheres","NucleicCylinders"];const Li=Ni,{selectors:Ii}=Yt;function Oi(){return{wireframe:this.opts.wireframe,zClip:this.opts.zClip}}class Vi extends gi{constructor(e){super(e),this.depGroups=this.depGroups.slice(0);const t=this.surfaceNames,r=this.depGroups;for(let e=0,n=t.length;e<n;++e)r[r.length]=[t[e],Oi]}calcAtomRadius(e){return e.element.radius}getVisibilitySelector(){let e=null;if(""!==this.opts.subset){const t=Ii.parse(this.opts.subset);t.error||(e=t.selector)}return e}}Vi.prototype.isSurface=!0,Vi.prototype.surfaceNames=[];const Di=Vi;class ki extends Di{static id="QS";getSurfaceOpts(){return{useBeads:!1,isoValue:this.opts.isoValue,gaussLim:this.opts.gaussLim[this.settings.now.resolution],radScale:this.opts.scale,gridSpacing:this.opts.gridSpacing[this.settings.now.resolution],zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}ki.prototype.id="QS",ki.prototype.name="Quick Surface",ki.prototype.shortName="Quick Surf",ki.prototype.surfaceNames=["QuickSurfGeo"];const zi=ki;class Fi extends Di{constructor(e,t){super(t),this._excludeProbe=e}calcAtomRadius(e){return e.element.radius}getSurfaceOpts(){return{gridSpacing:this.opts.polyComplexity[this.settings.now.resolution],radScale:this._radScale,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector(),probeRadius:this.opts.probeRadius,excludeProbe:this._excludeProbe}}}Fi.prototype.id="SU",Fi.prototype.name="Surface",Fi.prototype.shortName="Surface",Fi.prototype.surfaceNames=["SASSESSurfaceGeo"],Fi.prototype._radScale=1,Fi.prototype._excludeProbe=!1;const Bi=Fi;class Ui extends Bi{static id="SA";constructor(e){super(!1,e)}}Ui.prototype.id="SA",Ui.prototype.name="Solvent Accessible Surface",Ui.prototype.shortName="SAS";const Gi=Ui;class ji extends Bi{static id="SE";constructor(e){super(!0,e)}}ji.prototype.id="SE",ji.prototype.name="Solvent Excluded Surface",ji.prototype.shortName="SES";const Hi=ji;class $i extends Di{static id="CS";getSurfaceOpts(){return{probeRadius:this.opts.probeRadius,radScale:this.opts.polyComplexity[this.settings.now.resolution],scaleFactor:this.opts.polyComplexity[this.settings.now.resolution],gridSpacing:1/this.opts.polyComplexity[this.settings.now.resolution],isoValue:this.opts.isoValue,probePositions:this.opts.probePositions,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}$i.prototype.id="CS",$i.prototype.name="Contact Surface",$i.prototype.shortName="Contact Surf",$i.prototype.isSurface=!0,$i.prototype.surfaceNames=["ContactSurfaceGeo"];const Wi=$i;class Yi extends gi{static id="TX";getTemplateOptions(){return this.opts.template}getLabelOpts(){return t().merge(this.opts,{colors:!0,adjustColor:!0,transparent:!0})}}Yi.prototype.id="TX",Yi.prototype.name="Text mode",Yi.prototype.shortName="Text",Yi.prototype.depGroups=["TextLabelsGeo"];const Xi=new hr([bi,Si,Ci,Ei,Ri,Pi,Li,zi,Gi,Hi,Wi,Yi]);function qi(e,t,r){return e<=r?e<0?0:e:r}class Zi{constructor(e,t){this.name=e||"Custom",this.id=t||"CP"}getElementColor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this.elementColors[e];return void 0!==r||t?r:this.defaultElementColor}getResidueColor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this.residueColors[e];return void 0!==r||t?r:this.defaultResidueColor}getChainColor(e){let t=e.charCodeAt(0);return t=(31&(t<0?0:t>=256?t-256:t))%this.chainColors.length,this.chainColors[t]}getSecondaryColor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this.secondaryColors[e];return void 0!==r||t?r:this.defaultSecondaryColor}getSequentialColor(e){const{colors:t}=this,r=t.length;return e<0?t[e%r+r]:t[e%r]}getGradientColor(e,t){const r=this.gradients[t];if(!r)return this.defaultNamedColor;const n=r.length,s=e*(n-1);let i=Math.floor(s);const o=qi(i+1,0,n-1);return i=qi(i,0,n-1),function(e,t,r){const n=1-r;return n*(e>>16&255)+r*(t>>16&255)<<16|n*(e>>8&255)+r*(t>>8&255)<<8|n*(255&e)+r*(255&t)}(r[i],r[o],s-i)}getNamedColor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this.namedColors[e];return void 0!==r||t?r:this.defaultNamedColor}}t().assign(Zi.prototype,{colors:[16777215,16711680,65280,255,8421504],minRangeColor:0,midRangeColor:8355711,maxRangeColor:16777215,defaultElementColor:16777215,elementColors:{},defaultResidueColor:16777215,residueColors:{},chainColors:[16777215],defaultSecondaryColor:16777215,secondaryColors:{},defaultGradientColor:0,defaultNamedColor:16777215,namedColorsArray:[["indianred",13458524],["lightcoral",15761536],["salmon",16416882],["darksalmon",15308410],["lightsalmon",16752762],["crimson",14423100],["red",16711680],["firebrick",11674146],["darkred",9109504],["pink",16761035],["lightpink",16758465],["hotpink",16738740],["deeppink",16716947],["mediumvioletred",13047173],["palevioletred",14381203],["coral",16744272],["tomato",16737095],["orangered",16729344],["darkorange",16747520],["orange",16753920],["gold",16766720],["yellow",16776960],["lightyellow",16777184],["lemonchiffon",16775885],["lightgoldenrodyellow",16448210],["papayawhip",16773077],["moccasin",16770229],["peachpuff",16767673],["palegoldenrod",15657130],["khaki",15787660],["darkkhaki",12433259],["lavender",15132410],["thistle",14204888],["plum",14524637],["violet",15631086],["orchid",14315734],["fuchsia",16711935],["magenta",16711935],["mediumorchid",12211667],["mediumpurple",9662683],["rebeccapurple",6697881],["blueviolet",9055202],["darkviolet",9699539],["darkorchid",10040012],["darkmagenta",9109643],["purple",8388736],["indigo",4915330],["slateblue",6970061],["mediumslateblue",8087790],["darkslateblue",4734347],["greenyellow",11403055],["chartreuse",8388352],["lawngreen",8190976],["lime",65280],["limegreen",3329330],["palegreen",10025880],["lightgreen",9498256],["mediumspringgreen",64154],["springgreen",65407],["mediumseagreen",3978097],["seagreen",3050327],["forestgreen",2263842],["green",32768],["darkgreen",25600],["yellowgreen",10145074],["olivedrab",7048739],["olive",8421376],["darkolivegreen",5597999],["mediumaquamarine",6737322],["darkseagreen",9419919],["lightseagreen",2142890],["darkcyan",35723],["teal",32896],["aqua",65535],["cyan",65535],["lightcyan",14745599],["paleturquoise",11529966],["aquamarine",8388564],["turquoise",4251856],["mediumturquoise",4772300],["darkturquoise",52945],["cadetblue",6266528],["steelblue",4620980],["lightsteelblue",11584734],["powderblue",11591910],["lightblue",11393254],["skyblue",8900331],["lightskyblue",8900346],["deepskyblue",49151],["dodgerblue",2003199],["cornflowerblue",6591981],["royalblue",4286945],["blue",255],["mediumblue",205],["darkblue",139],["navy",128],["midnightblue",1644912],["cornsilk",16775388],["blanchedalmond",16772045],["bisque",16770244],["navajowhite",16768685],["wheat",16113331],["burlywood",14596231],["tan",13808780],["rosybrown",12357519],["sandybrown",16032864],["goldenrod",14329120],["darkgoldenrod",12092939],["peru",13468991],["chocolate",13789470],["saddlebrown",9127187],["sienna",10506797],["brown",10824234],["maroon",8388608],["white",16777215],["snow",16775930],["honeydew",15794160],["mintcream",16121850],["azure",15794175],["aliceblue",15792383],["ghostwhite",16316671],["whitesmoke",16119285],["seashell",16774638],["beige",16119260],["oldlace",16643558],["floralwhite",16775920],["ivory",16777200],["antiquewhite",16444375],["linen",16445670],["lavenderblush",16773365],["mistyrose",16770273],["gainsboro",14474460],["lightgray",13882323],["silver",12632256],["darkgray",11119017],["gray",8421504],["dimgray",6908265],["lightslategray",7833753],["slategray",7372944],["darkslategray",3100495],["black",0]],namedColors:{},gradients:{rainbow:[255,65535,65280,16776960,16711680],temp:[255,32767,16777215,16744192,16711680],hot:[16777215,16744192,16711680],cold:[16777215,32767,255],"blue-red":[255,16777215,16711680],reds:[16777215,16711680],blues:[16777215,255]}});const{namedColorsArray:Ki,namedColors:Qi}=Zi.prototype;for(let e=0,{length:t}=Ki;e<t;++e){const[t,r]=Ki[e];Qi[t]=r}const Ji=Zi,eo=new Ji("CPK","CP");eo.elementColors={H:16777215,C:2105376,N:2121983,O:15605776,F:65280,P:8397055,S:16776960,CL:47872,FE:13684944,CO:13684944,NI:13684944,CU:13684944,BR:34816,I:21760};const to=eo,ro=new Ji("Jmol","JM");ro.colors=[255,22015,44031,65535,65451,65365,65280,5635840,11271936,16776960,16755456,16733440,16711680,16711765,16711851,16711935,11206911,5570815],ro.elementColors={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:4366e3,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998},ro.defaultResidueColor=12492910,ro.residueColors={ALA:13158600,ARG:1334015,ASN:56540,ASP:15075850,CYS:15132160,GLN:56540,GLU:15075850,GLY:15461355,HIS:8553170,ILE:1016335,LEU:1016335,LYS:1334015,MET:15132160,PHE:3289770,PRO:14456450,SER:16422400,THR:16422400,TRP:11819700,TYR:3289770,VAL:1016335,A:10526975,C:16747595,G:16740464,I:8454143,T:10551200,U:16744576,DA:10526975,DC:16747595,DG:16740464,DI:8454143,DT:10551200,DU:16744576,"+A":10526975,"+C":16747595,"+G":16740464,"+I":8454143,"+T":10551200,"+U":16744576},ro.chainColors=[4294967295,4290826495,4289789872,4294951112,4294967168,4294951167,4289786096,4294955120,4293951616,4294303411,4278239231,4291648604,4284927402,4288335154,4293821166,4278243025,4278255487,4282168177,4278190219,4290623339,4278215680,4286578688,4286611456,4286578816,4278222976,4290283019,4289864226];const no=Oe.Type;ro.secondaryColors={[no.HELIX_ALPHA]:16711808,[no.HELIX_PI]:6291584,[no.HELIX_310]:10485888,[no.STRAND]:16762880,[no.TURN]:6324479,dna:11403518,rna:16580962};const so=ro,io=new Ji("VMD","VM");io.colors=[255,16711680,6316128,16744448,16776960,8421427,10066329,65280,16777215,16751001,4243648,10879142,8447590,15099571,8408320,8421568],io.defaultElementColor=8408320,io.elementColors={H:16777215,C:4243391,N:255,O:16711680,P:8421427,S:16776960},io.defaultResidueColor=4243648,io.residueColors={ALA:255,ARG:16777215,ASN:8421427,ASP:16711680,CYS:16776960,GLN:16744448,GLU:16751001,GLY:16777215,HIS:4243648,ILE:65280,LEU:16751001,LYS:4243648,MET:16776960,PHE:10879142,PRO:8408064,SER:16776960,THR:15099571,TRP:10066329,TYR:65280,VAL:8421427,A:255,C:16744448,G:16776960,T:10879142,U:65280,DA:255,DC:16744448,DG:16776960,DT:10879142,DU:65280,"+A":255,"+C":16744448,"+G":16776960,"+T":10879142,"+U":65280,WAT:4243648,H2O:4243648,HOH:4243648},io.chainColors=[16777215].concat(io.colors);const oo=Oe.Type;io.secondaryColors={[oo.HELIX_ALPHA]:10879142,[oo.HELIX_310]:255,[oo.HELIX_PI]:16711680,[oo.STRAND]:16776960,[oo.BRIDGE]:8421427,[oo.TURN]:4243648};const ao=new hr([to,so,io]);class lo{constructor(e){if(this.constructor===lo)throw new Error("Can not instantiate abstract class!");this.opts=t().merge(O.deriveDeep(z.now.colorers[this.id],!0),e),this.palette=ao.first}identify(){const e=O.objectsDiff(this.opts,z.now.colorers[this.id]);return t().isEmpty(e)?this.id:[this.id,e]}}lo.prototype.id="__";const co=lo;class ho extends co{static id="EL";getAtomColor(e,t){const r=e.element.name;return"C"===r&&this.opts.carbon>=0?this.opts.carbon:this.palette.getElementColor(r)}getResidueColor(e,t){return this.palette.defaultResidueColor}}ho.prototype.id="EL",ho.prototype.name="Element",ho.prototype.shortName="Element";const uo=ho;class po extends co{static id="RT";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){return this.palette.getResidueColor(e._type._name)}}po.prototype.id="RT",po.prototype.name="Residue Type",po.prototype.shortName="Residue";const mo=po;class fo extends co{static id="SQ";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){const r=e._chain;if(r.minSequence===Number.POSITIVE_INFINITY&&r.maxSequence===Number.NEGATIVE_INFINITY)return this.palette.defaultNamedColor;const n=r.minSequence,s=r.maxSequence>n?r.maxSequence:n+1;return this.palette.getGradientColor((e._sequence-n)/(s-n),this.opts.gradient)}}fo.prototype.id="SQ",fo.prototype.name="Sequence",fo.prototype.shortName="Sequence";const _o=fo;class go extends co{static id="CH";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){return this.palette.getChainColor(e.getChain()._name)}}go.prototype.id="CH",go.prototype.name="Chain",go.prototype.shortName="Chain";const yo=go;class xo extends co{static id="SS";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){if(e._type.flags&Ee.Flags.DNA)return this.palette.getSecondaryColor("dna");if(e._type.flags&Ee.Flags.RNA)return this.palette.getSecondaryColor("rna");const r=e.getSecondary();if(r){let e=this.palette.getSecondaryColor(r.type,!0);return void 0===e&&(e=this.palette.getSecondaryColor(r.generic)),e}return this.palette.defaultSecondaryColor}}xo.prototype.id="SS",xo.prototype.name="Secondary Structure",xo.prototype.shortName="Structure";const bo=xo;class wo extends co{static id="UN";getAtomColor(e,t){return this.opts.color}getResidueColor(e,t){return this.opts.color}}wo.prototype.id="UN",wo.prototype.name="Uniform",wo.prototype.shortName="Uniform";const So=wo;class vo extends co{static id="CO";constructor(e){super(e);const t=at.parse(this.opts.subset);this._subsetCached=t.error?at.none():t.selector}getAtomColor(e,t){return this._subsetCached.includesAtom(e)?this.opts.color:this.opts.baseColor}getResidueColor(e,t){const r=this._subsetCached,n=e._atoms;for(let e=0,t=n.length;e<t;++e)if(!r.includesAtom(n[e]))return this.opts.baseColor;return this.opts.color}}vo.prototype.id="CO",vo.prototype.name="Conditional",vo.prototype.shortName="Conditional";const Co=vo;class Ao extends co{static id="CF";getAtomColor(e,t){return this.palette.getChainColor(String.fromCharCode(e.location))}getResidueColor(e,t){return this.palette.defaultResidueColor}}Ao.prototype.id="CF",Ao.prototype.name="Conformation",Ao.prototype.shortName="Conformation";const Eo=Ao;class To extends co{static id="TM";getAtomColor(e,t){const{opts:r}=this;let n=1;return e.temperature&&r?(n=r.min===r.max?e.temperature>r.max?1:0:(e.temperature-r.min)/(r.max-r.min),this.palette.getGradientColor(n,r.gradient)):this.palette.defaultGradientColor}getResidueColor(e,t){const{opts:r}=this;if(!r)return this.palette.defaultGradientColor;if(e.temperature){let t=0;return t=r.min===r.max?e.temperature>r.max?1:0:(e.temperature-r.min)/(r.max-r.min),this.palette.getGradientColor(t,r.gradient)}return this.palette.defaultGradientColor}}To.prototype.id="TM",To.prototype.name="Temperature",To.prototype.shortName="Temperature";const Ro=To;class Mo extends co{static id="OC";_getColorByOccupancy(e,t){if(void 0!==e){const r=1-e;return this.palette.getGradientColor(r,t.gradient)}return this.palette.defaultGradientColor}getAtomColor(e,t){const{opts:r}=this;return this._getColorByOccupancy(e.occupancy,r)}getResidueColor(e,t){const{opts:r}=this;return this._getColorByOccupancy(e.occupancy,r)}}Mo.prototype.id="OC",Mo.prototype.name="Occupancy",Mo.prototype.shortName="Occupancy";const Po=Mo;class No extends co{static id="HY";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){let r=this.palette.defaultResidueColor;if(void 0!==e._type.hydrophobicity){const t=-4.5,n=4.5;r=this.palette.getGradientColor((e._type.hydrophobicity-t)/(n-t),this.opts.gradient)}return r}}No.prototype.id="HY",No.prototype.name="Hydrophobicity",No.prototype.shortName="Hydrophobicity";const Lo=No;class Io extends co{static id="MO";getAtomColor(e,t){return this.getResidueColor(e.residue,t)}getResidueColor(e,t){const r=e._molecule,n=t.getMoleculeCount();return n>1?this.palette.getGradientColor((r.index-1)/(n-1),this.opts.gradient):this.palette.getGradientColor(0,this.opts.gradient)}}Io.prototype.id="MO",Io.prototype.name="Molecule",Io.prototype.shortName="Molecule";const Oo=Io;class Vo extends co{static id="CB";getAtomColor(e,t){const r=this.opts.color,n=(s=r,(i=this.opts.factor)*(s>>16&255)<<16|i*(s>>8&255)<<8|i*(255&s));var s,i;return e.flags&he.Flags.CARBON?r:n}getResidueColor(e,t){return this.opts.color}}Vo.prototype.id="CB",Vo.prototype.name="Carbon",Vo.prototype.shortName="Carbon";const Do=new hr([uo,mo,_o,yo,bo,So,Co,Eo,Ro,Po,Lo,Oo,Vo]);function ko(e){return new r.Color(e,e,e)}const zo=[{id:"DF",name:"Diffuse",shortName:"Diffuse",uberOptions:{diffuse:ko(1),specular:ko(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"SF",name:"Soft Plastic",shortName:"Soft",uberOptions:{diffuse:ko(1),specular:ko(.1),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"PL",name:"Glossy Plastic",shortName:"Glossy",uberOptions:{diffuse:ko(.56),specular:ko(.28),shininess:100,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"ME",name:"Metal",shortName:"Metal",uberOptions:{diffuse:ko(.56),specular:ko(.55),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"TR",name:"Transparent",shortName:"Transparent",uberOptions:{diffuse:ko(1),specular:ko(0),shininess:1,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"GL",name:"Glass",shortName:"Glass",uberOptions:{diffuse:ko(.5),specular:ko(.65),shininess:100,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"BA",name:"Backdrop",shortName:"Backdrop",uberOptions:{diffuse:ko(1),specular:ko(0),shininess:1,opacity:1},values:{lights:!1,fog:!1,depthWrite:!1,transparent:!1,toonShading:!1}},{id:"TN",name:"Toon",shortName:"Toon",uberOptions:{diffuse:ko(1),specular:ko(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!0}},{id:"FL",name:"Flat",shortName:"Flat",uberOptions:{diffuse:ko(1),specular:ko(0),shininess:0,opacity:1},values:{lights:!1,fog:!0,depthWrite:!0,transparent:!1}}],Fo=new hr(zo);function Bo(e,t,r){const n=e.material.createInstance();n.setValues(t);const s=new e.constructor(e.geometry,n);return s.material.needsUpdate=!0,s.applyMatrix4(e.matrix),s.layers.set(r),s}function Uo(e,t,r){const n=function(e,t){const r=[];return e.traverse((e=>{for(let n=0;n<t.length;n++)if(e instanceof t[n]){r[r.length]=e;break}})),r}(e,t);for(let e=0,t=n.length;e<t;++e){const t=n[e];t.parent&&r(t)}}function Go(e,t){!function e(n){n instanceof r.Mesh&&t(n);for(let t=0,r=n.children.length;t<r;t++)e(n.children[t])}(e)}const jo={applyTransformsToMeshes:function(e,t){const n=t.length;if(n<1)return;Uo(e,[r.Mesh,r.LineSegments,r.Line],(e=>{e.applyMatrix4(t[0]);for(let r=1;r<n;++r){const n=new e.constructor(e.geometry,e.material);e.parent.add(n),n.applyMatrix4(t[r])}}))},processTransparentMaterial:function(){const e={prepassTransparancy:!0,fakeOpacity:!1,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1};return function(t,n){n instanceof Jn&&Uo(t,[r.Mesh,r.LineSegments],(t=>{t.material.setValues({prepassTransparancy:!1,fakeOpacity:!1}),t.material.needsUpdate=!0,t.layers.set(sr.LAYERS.TRANSPARENT);const r=Bo(t,e,sr.LAYERS.PREPASS_TRANSPARENT);t.parent.add(r)}))}}(),processColFromPosMaterial:function(){const e={colorFromPos:!0,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1,overrideColor:!1,fogTransparent:!1,attrColor:!1,attrColor2:!1,attrAlphaColor:!1,fakeOpacity:!1};return function(t,n){n instanceof Jn&&Uo(t,[r.Mesh,r.LineSegments],(t=>{const r=Bo(t,e,sr.LAYERS.COLOR_FROM_POSITION);t.parent.add(r)}))}}(),createShadowmapMaterial:function(){const e={colorFromDepth:!0,orthoCam:!0,lights:!1,shadowmap:!1,fog:!1};return function(t,n){n instanceof Jn&&Uo(t,[r.Mesh,r.LineSegments],(t=>{if(!t.receiveShadow&&t.material.shadowmap&&t.material.setValues({shadowmap:!1}),!t.material.lights)return;if(!t.castShadow)return;if(!sr.belongToSelectLayers(t))return;const r=Bo(t,e,sr.LAYERS.SHADOWMAP);r.isShadowmapMesh=!0,t.parent.add(r)}))}}(),removeShadowmapMaterial:function(e,t){t instanceof Jn&&Uo(e,[r.Mesh,r.LineSegments],(e=>{e.isShadowmapMesh&&e.parent.remove(e)}))},forEachMeshInGroup:Go,countTriangles:function(e){let t=0;return Go(e,(e=>{t+=function(e){const t=e.geometry;if(t instanceof r.InstancedBufferGeometry){const e=t.attributes;for(const n in e)if(e.hasOwnProperty(n)&&e[n]instanceof r.InstancedBufferAttribute){const r=e[n];return(t.index?t.index.array.length/3:0)*r.array.length/r.itemSize}return 0}return t instanceof r.BufferGeometry?t.index?t.index.array.length/3:0:t.faces?t.faces.length:0}(e)})),t}},{selectors:Ho}=Yt;const $o=class{constructor(e,t,r,n){const s={clipPlane:z.now.draft.clipPlane,fogTransparent:z.now.bg.transparent,shadowmap:z.now.shadow.on,shadowmapType:z.now.shadow.type};this.index=e,this.mode=t,this.colorer=r,this.selector=n,this.selectorString="",this.count=0,this.material=new Jn,this.material.setValues(s),this.material.setUberOptions({fogAlpha:z.now.fogAlpha}),this.materialPreset=Fo.first,this.needsRebuild=!0,this.visible=!0,this.setMode(t)}markAtoms(e){return this.count=e.markAtoms(this.selector,1<<this.index),this.needsRebuild=!0,this.count}unmarkAtoms(e){e.clearAtomBits(1<<this.index),this.count=0}setMode(e){this.mode=e}setMaterialPreset(e){this.materialPreset=e,this.material.setUberOptions(e.uberOptions),this.material.setValues(e.values)}reset(){this.geo=null,this.selectionGeo=null}buildGeometry(e){return this.reset(),this.needsRebuild=!1,z.now.ao&&this.material.setValues({normalsToGBuffer:z.now.ao}),this.geo=this.mode.buildGeometry(e,this.colorer,1<<this.index,this.material),this.material.uberOptions.opacity<.99&&"prepass"===z.now.transparency&&jo.processTransparentMaterial(this.geo,this.material),this.geo.visible=this.visible,sr.processObjRenderOrder(this.geo,this.materialPreset.id),jo.processColFromPosMaterial(this.geo,this.material),z.now.shadow.on&&jo.createShadowmapMaterial(this.geo,this.material),this.geo}buildSelectionGeometry(e){let t=null;if(this.geo&&"getSubset"in this.geo){const n=this.geo.getSubset(e);if(n&&n.length>0){t=new r.Group,t.matrixAutoUpdate=!1,t.matrix=this.geo.matrix;for(let e=0;e<n.length;e++){const r=n[e];t.add(r)}}}return t&&(t.visible=this.visible),this.selectionGeo=t,this.selectionGeo}compare(e){const t={},r=String(this.selector);e&&r.valueOf()===String(e.selector).valueOf()||(t.selector=r);const n=this.mode.identify();e&&!Array.isArray(n)&&n===e.mode||(t.mode=n);const s=this.colorer.identify();return e&&!Array.isArray(s)&&s===e.colorer||(t.colorer=s),e&&this.materialPreset.id===e.material||(t.material=this.materialPreset.id),t}change(e,r,n,s){const i={};if(e.selector){const t=Ho.parse(e.selector).selector,n=String(t);this.selectorString!==n&&(i.selector=n,this.selectorString=n,this.selector=t,this.markAtoms(r))}if(e.mode){const r=e.mode;t().isEqual(this.mode.identify(),r)||(i.mode=r,this.setMode(n))}if(e.colorer){const r=e.colorer;t().isEqual(this.colorer.identify(),r)||(i.colorer=r,this.colorer=s)}if(e.material){const r=e.material;t().isEqual(this.materialPreset.id,r)||(i.material=r,this.setMaterialPreset(Fo.get(e.material)))}return i}show(e){this.visible=e,this.geo&&(this.geo.visible=e),this.selectionGeo&&(this.selectionGeo.visible=e)}};function Wo(e,t,r){const{children:n}=e;if(n)for(let e=0,s=n.length;e<s;++e){const s=n[e];s._component===t&&r(s),s instanceof sr.RCGroup&&Wo(s,t,r)}}function Yo(){}const Xo={ComponentEditor:class extends Yo{constructor(e){super(),this._complexVisual=e,this._inProgress=!1}begin(){const e=this._complexVisual.getComplex();this._componentTransforms=[];for(let t=0;t<e._components.length;++t){const n=e._components[t];this._componentTransforms[n._index]=new r.Object3D}return this._inProgress=!0,!0}apply(){if(!this._inProgress)return;const e=this._complexVisual.getComplex();for(let t=0;t<e._components.length;++t)this._bakeComponentTransform(e._components[t]);e.onAtomPositionChanged(),this._resetComponentTransform(),this._complexVisual.finalizeEdit()}discard(){this._inProgress&&(this._resetComponentTransform(),this._complexVisual.finalizeEdit())}getAltObj(){const e={objects:[],pivot:new r.Vector3(0,0,0)},t=this._complexVisual,n=t.getSelectedComponent();if(null===n)return e;const s=this._complexVisual.getSelectionGeo(),i=1<<t.getSelectionBit();let o,a,l,c;for(Wo(t,n,(t=>{e.objects.push(t)})),o=0;o<s.children.length;++o)for(l=s.children[o],a=0;a<l.children.length;++a)c=l.children[a],c.hasOwnProperty("_component")&&c._component===n&&e.objects.push(c);e.objects.push(this._componentTransforms[n._index]);const h=new r.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),u=new r.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n.forEachResidue((e=>{const t=e._atoms;for(a=0;a<t.length;++a)t[a].mask&i&&(h.min(t[a].position),u.max(t[a].position))})),e.pivot.lerpVectors(h,u,.5),e}_bakeComponentTransform(e){const t=this._componentTransforms[e._index];!t||0===t.position.x&&0===t.position.y&&0===t.position.z&&0===t.quaternion.x&&0===t.quaternion.y&&0===t.quaternion.z&&1===t.quaternion.w||(t.updateMatrix(),e.forEachResidue((e=>{const r=e._atoms;for(let e=0;e<r.length;++e)r[e].position.applyMatrix4(t.matrix)})))}_resetComponentTransform(){const e=this._complexVisual,t=this._complexVisual.getSelectionGeo();let r,n,s,i;for(r=0;r<this._componentTransforms.length;++r)i=this._componentTransforms[r],i.position.set(0,0,0),i.quaternion.set(0,0,0,1);for(r=0;r<e.children.length;++r)for(s=e.children[r],n=0;n<s.children.length;++n)i=s.children[n],i.hasOwnProperty("_component")&&(i.position.set(0,0,0),i.quaternion.set(0,0,0,1));for(r=0;r<t.children.length;++r)for(s=t.children[r],n=0;n<s.children.length;++n)i=s.children[n],i.hasOwnProperty("_component")&&(i.position.set(0,0,0),i.quaternion.set(0,0,0,1))}},FragmentEditor:class extends Yo{constructor(e){super(),this._complexVisual=e,this._inProgress=!1}begin(){const e=this._complexVisual,t=this._complexVisual.getSelectionGeo(),n=this._getSelectionBorderAtoms();if(n.length<1||n.length>2)return w.error("Can only edit fragments with one or two bound atoms."),!1;this._fragmentBoundAtoms=n;const s=1<<e.getSelectionBit();e.disableSubset(s,!0);for(let e=0;e<t.children.length;++e)t.children[e].visible=!1;const i=n[0].position.clone();2===n.length&&i.lerp(n[1].position,.5),this._fragmentGeo=new r.Group,e.add(this._fragmentGeo),this._fragmentGeo.position.copy(i),this._fragmentSelectionGeo=new r.Group,t.add(this._fragmentSelectionGeo),this._fragmentSelectionGeo.position.copy(i);const o=i.clone();o.negate();for(let t=0;t<e.children.length;++t){const n=e.children[t];if(!("getSubset"in n))continue;const i=new r.Group;this._fragmentGeo.add(i);const a=new r.Group;this._fragmentSelectionGeo.add(a);const l=n.getSubset(s,!0);for(let e=0;e<l.length;e++){const t=l[e];i.add(t),t.position.copy(o)}const c=n.getSubset(s,!0);for(let e=0;e<c.length;e++){const t=c[e];a.add(t),t.position.copy(o)}}return sr.applySelectionMaterial(this._fragmentSelectionGeo),this._inProgress=!0,!0}apply(){if(!this._inProgress)return;const e=this._complexVisual,t=e.getSelectionBit(),n=this._fragmentGeo.position,s=this._fragmentGeo.matrix.clone();s.multiply((new r.Matrix4).makeTranslation(-n.x,-n.y,-n.z)),this._bakeAtomTransform(s,1<<t),e.enableSubset(1<<t,!0),e.getComplex().onAtomPositionChanged(),e.finalizeEdit()}discard(){if(!this._inProgress)return;const e=this._complexVisual,t=this._complexVisual.getSelectionGeo();this._fragmentGeo.parent.remove(this._fragmentGeo),e.enableSubset(1<<e.getSelectionBit(),!0);for(let e=0;e<t.children.length;++e){const r=t.children[e];r.visible?t.remove(r):r.visible=!0}e.finalizeEdit()}isFreeRotationAllowed(){return this._fragmentBoundAtoms.length<2}getAltObj(){const e={objects:[],pivot:new r.Vector3(0,0,0)};e.objects.push(this._fragmentGeo,this._fragmentSelectionGeo);const t=this._fragmentBoundAtoms;if(1===t.length){if(1===t[0].bonds.length){const n=t[0].bonds[0];e.axis=(new r.Vector3).subVectors(n._right.position,n._left.position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld)}}else 2===t.length&&(e.axis=(new r.Vector3).subVectors(t[1].position,t[0].position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld));return e}_getSelectionBorderAtoms(){const e=this._complexVisual.getComplex(),t=1<<this._complexVisual.getSelectionBit(),r={};e.forEachBond((e=>{e._left.mask&t?0==(e._right.mask&t)&&(r[e._left.index]=1):e._right.mask&t&&(r[e._right.index]=1)}));const n=[],s=Object.keys(r);for(let t=0,r=s.length;t<r;++t){const r=s[t];n.push(e._atoms[r])}return n}_bakeAtomTransform(e,t){this._complexVisual.getComplex().forEachAtom((r=>{r.mask&t&&r.position.applyMatrix4(e)}))}}},{selectors:qo}=Yt;function Zo(e,t){Array.isArray(t)||(t=[t]);const[r,n]=t;return new(e.get(r)||e.first)(n)}class Ko extends ar{constructor(e,t){super(e,t),this._complex=t,this._reprList=[],this._repr=null,this._reprListChanged=!0,this._selectionBit=0,this._reprUsedBits=0,this._selectionCount=0,this._selectionGeometry=new r.Group}getBoundaries(){return this._complex.getBoundaries()}release(){this._selectionGeometry.parent&&this._selectionGeometry.remove(this._selectionGeometry),ar.prototype.release.call(this)}getComplex(){return this._complex}getSelectionCount(){return this._selectionCount}getSelectionGeo(){return this._selectionGeometry}getSelectionBit(){return this._selectionBit}getEditor(){return this._editor}resetReps(e){this._complex&&this._complex.clearAtomBits(-1),this._reprListChanged=!0,this._reprUsedBits=0,this._reprList.length=e.length;for(let t=0,r=e.length;t<r;++t){const r=e[t];let n,s;"string"==typeof r.selector?(s=r.selector,({selector:n}=qo.parse(s))):void 0===r.selector?(s=z.now.presets.default[0].selector,({selector:n}=qo.parse(s))):(({selector:n}=r),s=n.toString());const i=Zo(Xi,r.mode),o=Zo(Do,r.colorer),a=Fo.get(r.material)||Fo.first;this._reprList[t]=new $o(t,i,o,n),this._reprList[t].setMaterialPreset(a),this._reprList[t].selectorString=s,this._complex&&this._complex.markAtoms(n,1<<t),this._reprUsedBits|=1<<t}this._repr=e.length>0?this._reprList[0]:null,this._selectionBit=e.length,this._reprUsedBits|=1<<this._selectionBit,this._selectionCount=0,this._complex&&this._complex.update()}repCount(){return this._reprList.length}repCurrent(e){return e>=0&&e<this._reprList.length?this._repr=this._reprList[e]:e=this._reprList.indexOf(this._repr),e}rep(e,r){if(!r&&(void 0===e||e instanceof Object)&&(r=e,e=this.repCurrent()),e<0||e>this._reprList.length)return w.error(`Rep ${e} does not exist!`),null;if(e===this._reprList.length){const t=this.repAdd(r);return w.warn(`Rep ${e} does not exist! New representation was created.`),{desc:t.desc,index:e,status:"created"}}const n=this._reprList[e],s={selector:n.selectorString,mode:n.mode.identify(),colorer:n.colorer.identify(),material:n.materialPreset.id};if(r){const i=n.change(r,this._complex,Zo(Xi,r.mode),Zo(Do,r.colorer));if(!t().isEmpty(i)){n.needsRebuild=!0;for(const t in i)i.hasOwnProperty(t)&&(s[t]=i[t],w.debug(`rep[${e}].${t} changed to ${i[t]}`));return i.mode&&n.mode.isSurface&&("ultra"===z.now.resolution||"high"===z.now.resolution)&&(w.report('Surface resolution was changed to "medium" to avoid hang-ups.'),z.set("resolution","medium")),{desc:s,index:e,status:"changed"}}}return{desc:s,index:e,status:""}}repGet(e){return(void 0===e||e instanceof Object)&&(e=this.repCurrent()),e<0||e>=this._reprList.length?null:this._reprList[e]}_getFreeReprIdx(){let e=this._reprUsedBits;for(let t=0;t<=Ko.NUM_REPRESENTATION_BITS;++t,e>>=1)if(0==(1&e))return t;return-1}repAdd(e){if(this._reprList.length>=Ko.NUM_REPRESENTATION_BITS)return null;const r=this._getFreeReprIdx();if(r<0)return null;const n=this.buildSelectorFromMask(1<<this._selectionBit),s=z.now.presets.default[0],i=t().merge({selector:s.selector,mode:s.mode,colorer:s.colorer,material:s.material},e),o="string"==typeof i.selector?qo.parse(i.selector).selector:i.selector,a=new $o(this._selectionBit,Zo(Xi,i.mode),Zo(Do,i.colorer),o);return a.selectorString=o.toString(),a.setMaterialPreset(Fo.get(i.material)),a.markAtoms(this._complex),this._reprList.push(a),this._selectionBit=r,this._reprUsedBits|=1<<this._selectionBit,this._complex.markAtoms(n,1<<this._selectionBit),{desc:i,index:this._reprList.length-1}}repRemove(e){void 0===e&&(e=this.repCurrent());let t=this._reprList.length;if(e<0||e>=t||t<=1)return;const r=this._reprList[e];r.unmarkAtoms(this._complex),this._reprUsedBits&=~(1<<r.index),this._reprList.splice(e,1),r===this._repr&&(--t,e=e<t?e:t-1,this._repr=this._reprList[e]),this._reprListChanged=!0}repHide(e,t){if(void 0===t&&(t=!0),e<0||e>=this._reprList.length)return;this._reprList[e].show(!t)}select(e,t){t?this._selectionCount+=this._complex.markAtomsAdditionally(e,1<<this._selectionBit):this._selectionCount=this._complex.markAtoms(e,1<<this._selectionBit),this._complex.updateStructuresMask(),this.rebuildSelectionGeometry()}resetSelectionMask(){0!==this._selectionCount&&(this._selectionCount=0,this._complex&&this._complex.clearAtomBits(1<<this._selectionBit))}updateSelectionMask(e){const t=this,{atom:r}=e;let{residue:n,chain:s,molecule:i}=e;const o=1<<this._selectionBit,a=~o;if(r)n=r.residue,s=n._chain,i=n._molecule,r.mask&o?(r.mask&=a,n._mask&=a,s._mask&=a,i&&(i.mask&=a),this._selectionCount--):(r.mask|=o,this._selectionCount++,n.collectMask(),s.collectMask(),i&&i.collectMask());else if(n)s=n._chain,i=n._molecule,n._mask&o?(n._mask&=a,s._mask&=a,n.forEachAtom((e=>{e.mask&o&&(e.mask&=a,t._selectionCount--)}))):(n._mask|=o,n.forEachAtom((e=>{e.mask&o||(e.mask|=o,t._selectionCount++)})),s.collectMask(),i&&i.collectMask());else if(s||i){const e=s||i;e._mask&o?(e._mask&=a,e.forEachResidue((e=>{e._mask&o&&(e._mask&=a,e.forEachAtom((e=>{e.mask&o&&(e.mask&=a,t._selectionCount--)})),e._mask&=a)}))):(e._mask|=o,e.forEachResidue((e=>{if(!(e._mask&o)){e._mask|=o,e.forEachAtom((e=>{e.mask&o||(e.mask|=o,t._selectionCount++)}));const r=s?e.getMolecule():e.getChain();r&&r.collectMask()}})))}else this.resetSelectionMask()}expandSelection(){const e=this,t=1<<this._selectionBit,r=1<<31;this._complex.forEachBond((e=>{e._left.mask&t?0==(e._right.mask&t)&&(e._right.mask|=r):e._right.mask&t&&(e._left.mask|=r)}));this._complex.forEachAtom((n=>{n.mask&r&&(n.mask=2147483647&n.mask|t,++e._selectionCount)})),this._complex.updateStructuresMask()}shrinkSelection(){const e=this,t=1<<this._selectionBit,r=1<<31;this._complex.forEachBond((e=>{e._left.mask&t?0==(e._right.mask&t)&&(e._left.mask|=r):e._right.mask&t&&(e._right.mask|=r)})),this._complex.forEachAtom((e=>{e.mask&t&&1===e.bonds.length&&(e.mask|=r)}));const n=~(t|r);this._complex.forEachAtom((t=>{t.mask&r&&(t.mask&=n,--e._selectionCount)})),this._complex.updateStructuresMask()}getSelectedComponent(){const e=1<<this._selectionBit;let t=null,r=!1;return this._complex.forEachAtom((n=>{n.mask&e&&(null===t?t=n.residue._component:t!==n.residue._component&&(r=!0))})),r?null:t}getSelectionCenter(e,t,r){e.set(0,0,0);let n=0;return this._complex.forEachAtom((s=>{t(s,r)&&(e.add(s.position),n++)})),0!==n&&(e.divideScalar(n),e.applyMatrix4(this.matrix),!0)}needsRebuild(){if(this._reprListChanged)return!0;const e=this._reprList;for(let t=0,r=e.length;t<r;++t){if(e[t].needsRebuild)return!0}return!1}rebuild(){const e=this;return sr.clearTree(this),new Promise((t=>{const r=e._complex;if(!r)return void t();let n=!1;setTimeout((()=>{const s=e._reprList,i=ao.get(z.now.palette)||ao.first;let o=!1;for(let t=0,a=s.length;t<a;++t){const a=s[t];if(a.colorer.palette=i,a.needsRebuild){a.reset();try{a.buildGeometry(r)}catch(e){if(!(e instanceof O.OutOfMemoryError))throw e;a.needsRebuild=!1,a.reset(),w.error(`Not enough memory to build geometry for representation ${a.index+1}`),n=!0}0}o=n||o||sr.groupHasGeometryToRender(a.geo),a.geo&&e.add(a.geo)}e._reprListChanged=!1,t()}),10)}))}setNeedsRebuild(){const e=this._reprList;for(let t=0,r=e.length;t<r;++t)e[t].needsRebuild=!0}rebuildSelectionGeometry(){const e=1<<this._selectionBit;sr.clearTree(this._selectionGeometry);for(let t=0,r=this._reprList.length;t<r;++t){const r=this._reprList[t].buildSelectionGeometry(e);if(r){this._selectionGeometry.add(r);for(let e=0;e<r.children.length;e++){const t=r.children[e];if(this._editor&&this._editor._componentTransforms){const e=this._editor._componentTransforms[t._component._index];e&&(t.position.copy(e.position),t.quaternion.copy(e.quaternion))}}sr.applySelectionMaterial(r)}}}_buildSelectorFromSortedLists(e,t,r){const n=this._complex;function s(e){const t=[];let r=0,n=NaN,s=NaN;for(let i=0,o=e.length;i<o;++i){const o=e[i];o===s+1?s=o:(Number.isNaN(n)||(t[r++]=new qo.Range(n,s)),n=s=o)}return Number.isNaN(n)||(t[r]=new qo.Range(n,s)),t}let i=null;if(r.length===n._chains.length)i=qo.all();else{let n;if(r.length>0&&(n=qo.chain(r),i=i?qo.or(i,n):n),Object.keys(t).length>0)for(const e in t)t.hasOwnProperty(e)&&(n=qo.and(qo.chain(e),qo.residx(s(t[e]))),i=i?qo.or(i,n):n);e.length>0&&(n=qo.serial(s(e)),i=i?qo.or(i,n):n),i||(i=qo.none())}return i}buildSelectorFromMask(e){const t=this._complex,r=[],n={},s=[];return t.forEachChain((t=>{t._mask&e&&r.push(t._name)})),t.forEachResidue((t=>{if(t._mask&e&&!(t._chain._mask&e)){const e=t._chain._name;e in n?n[e].push(t._index):n[e]=[t._index]}})),t.forEachAtom((t=>{t.mask&e&&!(t.residue._mask&e)&&s.push(t.serial)})),this._buildSelectorFromSortedLists(s,n,r)}forSelectedResidues(e){const t=1<<this._selectionBit;this._complex.forEachResidue((r=>{r._mask&t&&e(r)}))}beginComponentEdit(){if(this._editor)return null;const e=new Xo.ComponentEditor(this);return e.begin()?(this._editor=e,e):null}beginFragmentEdit(){if(this._editor)return null;const e=new Xo.FragmentEditor(this);return e.begin()?(this._editor=e,e):null}finalizeEdit(){this._editor=null}setMaterialValues(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;for(let s=0,i=this._reprList.length;s<i;++s){const i=this._reprList[s];i.material.setValues(e),t&&i.geo.traverse((t=>{t instanceof r.Mesh&&(t.material.setValues(e),void 0!==n&&n(t),t.material.needsUpdate=!0)}))}}setUberOptions(e){for(let t=0,r=this._reprList.length;t<r;++t){this._reprList[t].material.setUberOptions(e)}}within(e,t){const r=this._complex.getVoxelWorld();if(null===r)return!1;const n=1<<this._selectionBit;return this._complex.markAtoms(e,n),r&&r.forEachAtomWithinDistFromMasked(this._complex,n,Number(t),(e=>{e.mask|=n})),this._selectionCount=this._complex.countAtomsByMask(n),this._complex.updateStructuresMask(),this.buildSelectorFromMask(n)}}Ko.NUM_REPRESENTATION_BITS=30;const Qo=Ko,Jo=r.UniformsUtils.merge([{volumeDim:{type:"v3",value:new r.Vector3(512,512,512)},tileTex:{type:"t",value:null},tileTexSize:{type:"v2",value:new r.Vector2(512,512)},tileStride:{type:"v2",value:new r.Vector2(512,512)},boxAngles:{type:"v3",value:new r.Vector3(1,1,1)},delta:{type:"v3",value:new r.Vector3(0,0,0)},_isoLevel0:{type:"v2",value:new r.Vector3(.5,.75,1)},_flipV:{type:"f",value:0},_BFLeft:{type:"t",value:null},_BFRight:{type:"t",value:null},_FFLeft:{type:"t",value:null},_FFRight:{type:"t",value:null},_WFFLeft:{type:"t",value:null},_WFFRight:{type:"t",value:null}}]);function ea(e,t){const n=r.UniformsUtils.clone(t);for(const t in e)n.hasOwnProperty(t)&&(n[t].value=e[t]);return n}function ta(e,t){return{uniforms:ea(e,{}),vertexShader:"varying vec3 pos;\r\n\r\nvoid main() {\r\n  // we're assuming local position is in [-0.5, 0.5]\r\n  // we need to offset it to be represented in RGB\r\n  pos = position.xyz + 0.5;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}",fragmentShader:"varying vec3 pos;\r\n\r\nvoid main() {\r\n  gl_FragColor = vec4(pos, 0.5);\r\n}",transparent:!1,depthTest:!1,depthWrite:!1,side:t}}class ra extends r.ShaderMaterial{constructor(e){super(ta(e,r.BackSide))}}class na{constructor(e,t,n,s){this.uniforms=ea(e,t),this.vertexShader=n,this.fragmentShader=s,this.transparent=!1,this.depthTest=!1,this.depthWrite=!1,this.side=r.FrontSide}}class sa extends r.ShaderMaterial{constructor(e){const t=r.UniformsUtils.merge([{aspectRatio:{type:"f",value:0},farZ:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},matWorld2Volume:{type:"4fv",value:new r.Matrix4}}]);super(new na(e,t,"varying vec4 volPos;\r\nuniform float aspectRatio;\r\nuniform float farZ;\r\nuniform float tanHalfFOV;\r\nuniform mat4  matWorld2Volume;\r\n\r\nvoid main() {\r\n  // rescale plane to fill in the whole far plane area seen from camera\r\n  vec3 pos = position.xyz;\r\n  pos.x = pos.x * tanHalfFOV * farZ * aspectRatio;\r\n  pos.y = pos.y * tanHalfFOV * farZ;\r\n  // common transformation\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\r\n  // calc pos in volume CS\r\n  volPos = matWorld2Volume * modelMatrix * vec4(pos, 1.0);\r\n  // we're assuming local position is in [-0.5, 0.5]\r\n  // we need to offset it to be represented in RGB\r\n  volPos = volPos + 0.5;\r\n  volPos.w = 0.5;\r\n}\r\n","varying vec4 volPos;\r\n\r\nvoid main() {\r\n  gl_FragColor = volPos;\r\n}"))}}class ia extends r.ShaderMaterial{constructor(e){super(ta(e,r.FrontSide))}}class oa extends r.ShaderMaterial{constructor(e){const t=new na(e,Jo,"varying vec4 screenSpacePos;\r\n\r\nvoid main() {\r\n  screenSpacePos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n  gl_Position = screenSpacePos;\r\n}","uniform mat4 projectionMatrix;\r\n\r\n// 3D volume texture\r\nuniform vec3 volumeDim;    // volume dimensions, pixels\r\nuniform sampler2D tileTex; // tiled texture containing all Z-slices of a 3D data\r\nuniform vec2 tileTexSize;  // size of tiled texture, pixels\r\nuniform vec2 tileStride;   // UV stride between slices in tile tex, pixels\r\n\r\nuniform vec3 boxAngles;//value of angles({x: alpha, y:beta, z:gamma}) types 1 - if angle is obtuse, 0 - if acute\r\nuniform vec3 delta; //Projection box delta's from non-orthogonal origin axes; {x: XY, y : XZ, z: YZ}\r\n\r\nuniform vec3 _isoLevel0;\r\nuniform float _flipV;\r\nuniform sampler2D _BFLeft;\r\nuniform sampler2D _BFRight;\r\nuniform sampler2D _FFLeft;\r\nuniform sampler2D _FFRight;\r\nuniform sampler2D _WFFLeft;\r\nuniform sampler2D _WFFRight;\r\n\r\nvarying vec4 screenSpacePos;\r\n\r\n#define NO_COLOR vec4(0., 0., 0., 0.)\r\n\r\nvec4 sample3DTexture(vec3 texCoord) {\r\n  // a pair of Z slices is determined by nearest slice border\r\n  float zSliceBorder = floor(texCoord.z * volumeDim.z + 0.5);\r\n  float zSliceNumber1 = max(zSliceBorder - 1.0, 0.0);\r\n  float zSliceNumber2 = min(zSliceBorder, volumeDim.z - 1.0);\r\n\r\n  float rowTiles = floor(tileTexSize.x / tileStride.x);\r\n\r\n  // calculate coords in tile texture for both slices\r\n  vec2 tileOffset = vec2(mod(zSliceNumber1, rowTiles), floor(zSliceNumber1 / rowTiles));\r\n  vec2 texCoordSlice1 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r\n  tileOffset = vec2(mod(zSliceNumber2, rowTiles), floor(zSliceNumber2 / rowTiles));\r\n  vec2 texCoordSlice2 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r\n\r\n  // bilinear filtering\r\n  vec4 colorSlice1 = texture2D(tileTex, texCoordSlice1);\r\n  vec4 colorSlice2 = texture2D(tileTex, texCoordSlice2);\r\n  float weightSlice2 = texCoord.z * volumeDim.z - (zSliceNumber1 + 0.5);\r\n  return mix(colorSlice1, colorSlice2, weightSlice2);\r\n}\r\n\r\nvec4 sample3DTextureInclined(vec3 boxCoord) { // delta:{ x: XY, y : XZ, z: YZ }\r\n  vec3 textCoord = boxCoord;\r\n  vec2 currDelta = mix(boxCoord.zz, vec2(1., 1.) - boxCoord.zz, boxAngles.yx) * delta.yz;\r\n\r\n  textCoord.y = (boxCoord.y  - currDelta.y) / (1. - delta.z);\r\n  if (textCoord.y < 0.0 || textCoord.y > 1.0)\r\n    return NO_COLOR;\r\n\r\n  currDelta.x += mix(textCoord.y, 1.0 - textCoord.y, boxAngles.z) * delta.x;\r\n\r\n  textCoord.x = (boxCoord.x - currDelta.x) / (1. - delta.x - delta.y);\r\n  if (textCoord.x < 0.0 || textCoord.x > 1.0)\r\n    return NO_COLOR;\r\n\r\n  return sample3DTexture(textCoord);\r\n}\r\n\r\nfloat CalcColor(vec3 iter, vec3 dir) {\r\n  float d = 1. / 128.;\r\n  vec3 dx = vec3(d, 0.0, 0.0);\r\n  vec3 dy = vec3(0.0, d, 0.0);\r\n  vec3 dz = vec3(0.0, 0.0, d);\r\n\r\n  // #Opt: coordInc.x:(iter + dx).x > 1. ? 0.: sample3DTextureInclined(iter + dx).x,\r\n  vec3 coordInc = mix(\r\n    vec3(\r\n      sample3DTextureInclined(iter + dx).x,\r\n      sample3DTextureInclined(iter + dy).x,\r\n      sample3DTextureInclined(iter + dz).x\r\n    ),\r\n    vec3(0. ,0. , 0.),\r\n    vec3(floor((iter + dx).x), floor((iter + dy).y), floor((iter + dz).z))\r\n  );\r\n\r\n  // #Opt: coordDec.x:(iter - dx).x < 0. ? 0.: sample3DTextureInclined(iter - dx).x,\r\n  vec3 coordDec = mix(\r\n    vec3(0. ,0. , 0.),\r\n    vec3(\r\n      sample3DTextureInclined(iter - dx).x,\r\n      sample3DTextureInclined(iter - dy).x,\r\n      sample3DTextureInclined(iter - dz).x\r\n    ),\r\n    vec3(ceil((iter - dx).x), ceil((iter - dy).y), ceil((iter - dz).z))\r\n  );\r\n\r\n  vec3 N = normalize(coordInc - coordDec);\r\n  float dif = max(0.0, dot(N, dir));\r\n  return dif;\r\n}\r\n\r\nvec3 AccuracyIso(vec3 left, vec3 right, float volLeft, float threshold) {\r\n  for (int i = 0; i < 5; i++) {\r\n    vec3 iterator = 0.5 * (left + right);\r\n    float vol = sample3DTextureInclined(iterator).r;\r\n    if ((volLeft - threshold) * (vol - threshold) < 0.)\r\n      right = iterator;\r\n    else\r\n      left = iterator;\r\n  }\r\n  return 0.5 * (left + right);\r\n}\r\n\r\nvec3 CorrectIso(vec3 left, vec3 right, float tr) {\r\n  for (int j = 0; j < 5; j++) {\r\n    vec3 iterator = 0.5 * (left + right);\r\n    float vol = sample3DTextureInclined(iterator).r;\r\n    if (vol < tr)\r\n      right = iterator;\r\n    else\r\n      left = iterator;\r\n  }\r\n  return 0.5 * (left + right);\r\n}\r\n\r\nvec4 GetIso1(vec3 start, vec3 back, float molDist, vec3 dir, float tr, int count) {\r\n  float vol, stepSize = (float(count) + 2.) / float(STEPS_COUNT);\r\n  vec3 step = stepSize * dir, iterator = start, left, right;\r\n  vec4 acc = NO_COLOR;\r\n\r\n  for (int i = 0; i < STEPS_COUNT; i++) {\r\n    iterator = iterator + step;\r\n    vol = sample3DTextureInclined(iterator).r;\r\n    if (length(iterator - back) <= stepSize || (vol > tr))\r\n      break;\r\n  }\r\n\r\n  if (vol > tr)\r\n    acc = vec4(CorrectIso(iterator, iterator - step, tr).xyz, 1.);\r\n\r\n  return acc;\r\n}\r\n\r\nfloat easeOut(float x0, float x1, float x) {\r\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r\n  return 1.0 - (1.0 - t) * (1.0 - t);\r\n}\r\n\r\nfloat easeIn(float x0, float x1, float x) {\r\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r\n  return t * t;\r\n}\r\n\r\nvec3 GetColSimple(float vol) {\r\n  float t = easeOut(_isoLevel0.x, _isoLevel0.y, vol);\r\n  float s = easeIn(_isoLevel0.y, _isoLevel0.z, vol);\r\n  return vec3(0.5, 0.6, 0.7) * (1.0 - t) + 2.0 * vec3(s, 0, 0);\r\n}\r\n\r\nvec4 VolRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  vec4 acc = NO_COLOR, iso;\r\n  vec3 iterator = start, sumColor = vec3(0., 0., 0.);\r\n  float stepSize, alpha, sumAlpha = 0.0, vol, curStepSize, molD;\r\n  vec3 step, col, colOld, right;\r\n  float tr0 = _isoLevel0.x;\r\n  float dif, r, kd, finish;\r\n  int count = 0, stopMol = 0;\r\n\r\n  for (int k = 0; k < 3; k++) {\r\n    stepSize = (float(k) + 2.) / float(STEPS_COUNT);\r\n    kd = 140. * tr0 * stepSize;\r\n    r = 1. - kd;\r\n    step = stepSize * dir;\r\n    iso = GetIso1(iterator, back, molDist, dir, tr0, k);\r\n    if (iso.a < 0.1 || length(iso.xyz - start) > molDist)\r\n      break;\r\n    iterator = iso.xyz;\r\n    dif = 1.;// CalcColor(iterator, dir);\r\n    colOld = GetColSimple(tr0);\r\n    curStepSize = stepSize;\r\n    for (int i = 0; i < STEPS_COUNT; i++) {\r\n      iterator = iterator + step;\r\n      molD = length(iterator - start);\r\n      vol = sample3DTextureInclined(iterator).r;\r\n      finish = distance(iterator, back) - stepSize;\r\n      if (finish < 0.0 || vol < tr0 || (sumAlpha > 0.97) || molD > molDist)\r\n        break;\r\n      alpha = (1. - r);\r\n      col = GetColSimple(vol);\r\n      vol = sample3DTextureInclined(iterator - 0.5 * step).r;\r\n      vec3 colMid = GetColSimple(vol);\r\n      sumColor += (1. - sumAlpha) * (colOld + 4.* colMid + col) * alpha / 6.;\r\n      sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r\n      colOld = col;\r\n    } // for i\r\n\r\n    if (finish < 0.0 || sumAlpha > 0.97)\r\n      break;\r\n\r\n    if (molD > molDist) {\r\n      curStepSize = stepSize - (molD - molDist);\r\n      right = iterator - (molD - molDist) * dir;\r\n      vol = sample3DTextureInclined(right).r;\r\n    } else {\r\n      vec3 left = iterator - step;\r\n      right = CorrectIso(left, iterator, tr0);\r\n      curStepSize = distance(left, right);\r\n      vol = tr0;\r\n    }\r\n\r\n    alpha = (1. - r) * curStepSize / stepSize;\r\n    dif = 1.;// CalcColor(right, dir);\r\n    col = GetColSimple(vol);\r\n    vol = sample3DTextureInclined(iterator - 0.5 * curStepSize / stepSize * step).r;\r\n    vec3 colMid = GetColSimple(vol);\r\n    sumColor += (1. - sumAlpha) * (colOld + 4. * colMid + col) * alpha / 6.;\r\n    sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r\n\r\n    if (molD > molDist)\r\n      break;\r\n  } // for k\r\n  acc.rgb = 1. * sumColor / sumAlpha;\r\n  acc.a = sumAlpha;\r\n  return acc;\r\n}\r\n\r\nvec4 VolRender1(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  float stepSize = 1.0 / float(STEPS_COUNT);\r\n  float len = length(back - start);\r\n  vec3 step = stepSize * dir;\r\n  vec3 iterator = start;\r\n  float acc = 0.0;\r\n\r\n  for (int i = 0; i < STEPS_COUNT; i++) {\r\n    if (float(i) * stepSize > len)\r\n      break;\r\n    iterator = iterator + step;\r\n    if (sample3DTextureInclined(iterator).r > _isoLevel0.x)\r\n      acc += 10. * sample3DTextureInclined(iterator).r / float(STEPS_COUNT);\r\n  }\r\n\r\n  return vec4(1.,1.,1., acc);\r\n}\r\n\r\nvec4 IsoRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  vec4 tst = GetIso1(start, back, 2., dir, _isoLevel0.x, 0);\r\n  vec4 col = NO_COLOR;\r\n\r\n  if (length(tst.xyz - start) < molDist && tst.a > 0.1) {\r\n    float dif =  CalcColor(tst.xyz, dir);\r\n    dif = 0.9 * dif * dif;\r\n    col = vec4(dif, dif, dif, 1);\r\n  }\r\n  return col;\r\n}\r\n\r\nvec4 VolRender2(vec3 start, vec3 back, float molDist, vec3 dir) {\r\n  return sample3DTexture(start);\r\n}\r\n\r\nvoid main() {\r\n  vec3 tc = screenSpacePos.xyz / screenSpacePos.w * 0.5 + 0.5;\r\n\r\n  if (_flipV > 0.0) {\r\n    tc.y = 1.0 - tc.y;\r\n  }\r\n\r\n  vec3 start;\r\n  vec3 back;\r\n  vec3 molBack;\r\n  if (projectionMatrix[0][2] < 0.0) {\r\n    start = texture2D(_FFLeft, tc.xy).xyz;\r\n    back = texture2D(_BFLeft, tc.xy).xyz;\r\n    molBack = texture2D(_WFFLeft, tc.xy).xyz;\r\n  } else {\r\n    start = texture2D(_FFRight, tc.xy).xyz;\r\n    back = texture2D(_BFRight, tc.xy).xyz;\r\n    molBack = texture2D(_WFFRight, tc.xy).xyz;\r\n  }\r\n\r\n  vec3 dir = normalize(back - start);\r\n\r\n  float molDist = 2.0;\r\n  if (length(molBack) > 0.001) {\r\n    molDist = distance(start, molBack);\r\n  }\r\n\r\n  #ifdef ISO_MODE\r\n    gl_FragColor = IsoRender(start, back, molDist, dir);\r\n  #else\r\n    gl_FragColor = VolRender(start, back, molDist, dir);\r\n  #endif\r\n}\r\n");t.transparent=!0,t.depthTest=!0,super(t),this.updateDefines()}updateDefines(){this.defines={ISO_MODE:z.now.modes.VD.isoMode,STEPS_COUNT:100*z.now.modes.VD.polyComplexity[z.now.resolution]},this.needsUpdate=!0}}const aa={BackFacePosMaterial:ra,BackFacePosMaterialFarPlane:sa,FrontFacePosMaterial:ia,VolumeMaterial:oa};class la extends r.Mesh{volumeInfo={};constructor(){const e=new r.BufferGeometry;super(e),this.clipPlane=new r.Plane;const t=new r.Vector3(.5,.5,.5);this.size=t,this.cullFlag=[!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1],this.faces=[{indices:[],norm:new r.Vector3(0,0,-1)},{indices:[],norm:new r.Vector3(0,0,1)},{indices:[],norm:new r.Vector3(0,-1,0)},{indices:[],norm:new r.Vector3(0,1,0)},{indices:[],norm:new r.Vector3(-1,0,0)},{indices:[],norm:new r.Vector3(1,0,0)},{indices:[],norm:new r.Vector3(0,0,0)}],this.vertices=[new r.Vector3(-t.x,-t.y,-t.z),new r.Vector3(-t.x,t.y,-t.z),new r.Vector3(t.x,-t.y,-t.z),new r.Vector3(t.x,t.y,-t.z),new r.Vector3(-t.x,-t.y,t.z),new r.Vector3(-t.x,t.y,t.z),new r.Vector3(t.x,-t.y,t.z),new r.Vector3(t.x,t.y,t.z),new r.Vector3(0,0,0),new r.Vector3(0,0,0),new r.Vector3(0,0,0),new r.Vector3(0,0,0),new r.Vector3(0,0,0),new r.Vector3(0,0,0)],e.setAttribute("position",new r.BufferAttribute(new Float32Array(3*this.vertices.length),3)),this.name="VolumeMesh"}static _corners=[[-1,-1,-1,0,4,8],[1,-1,-1,0,5,9],[1,1,-1,1,5,10],[-1,1,-1,1,4,11],[-1,-1,1,2,6,8],[1,-1,1,2,7,9],[1,1,1,3,7,10],[-1,1,1,3,6,11]];static _edges=[[0,1,0,-1,-1],[2,3,0,1,-1],[4,5,0,-1,1],[6,7,0,1,1],[0,3,-1,0,-1],[1,2,1,0,-1],[4,7,-1,0,1],[5,6,1,0,1],[0,4,-1,-1,0],[1,5,1,-1,0],[2,6,-1,1,0],[3,7,1,1,0]];static _edgeIntersections=function(){const e=[];for(let t=0;t<12;++t)e.push(new r.Vector3);return e}();_updateVertices(){const e=la._corners,t=la._edges,n=la._edgeIntersections;let s;const i=this.clipPlane.normal,o=this.clipPlane.constant,a=this.vertices,{size:l}=this,c=[0,0,0,0,0,0,0,0],h=[1,1,1,1,1,1,1,1,1,1,1,1],u=new r.Vector3;let d=null;function p(){if(0===i.x)return 0;const e=-(i.dot(u)+o)/i.x;return-l.x<=e&&e<=l.x?(d.set(e,u.y,u.z),e===l.x?2:e===-l.x?-2:1):0}function m(){if(0===i.y)return 0;const e=-(i.dot(u)+o)/i.y;return-l.y<=e&&e<=l.y?(d.set(u.x,e,u.z),e===l.y?2:e===-l.y?-2:1):0}function f(){if(0===i.z)return 0;const e=-(i.dot(u)+o)/i.z;return-l.z<=e&&e<=l.z?(d.set(u.x,u.y,e),e===l.z?2:e===-l.z?-2:1):0}for(let e=0;e<12;++e){const r=t[e];d=n[e],u.set(r[2],r[3],r[4]),u.multiply(l);let s=0;0===r[2]&&(s=p()),0===r[3]&&(s=m()),0===r[4]&&(s=f()),-2===s?c[r[0]]=1:2===s?c[r[1]]=1:0===s&&(h[e]=0)}const _={indices:[],norm:i.clone().negate()};let g=8;for(s=0;s<8;++s)1===c[s]&&(a[g].set(e[s][0],e[s][1],e[s][2]).multiply(l),_.indices.push(g++),h[e[s][3]]=0,h[e[s][4]]=0,h[e[s][5]]=0);for(s=0;s<12;++s)1===h[s]&&(a[g].copy(n[s]),_.indices.push(g++));this.faces[6]=_;const y=new r.Vector3,x=new r.Vector3;for(this.clipPlane.coplanarPoint(x),s=0;s<a.length;++s)this.cullFlag[s]=!1,s<8?(y.subVectors(a[s],x),this.cullFlag[s]=i.dot(y)>=0):s<8+_.indices.length&&(this.cullFlag[s]=!0);const b=this.geometry.getAttribute("position");let w=0;for(s=0;s<a.length;++s)b.array[w++]=a[s].x,b.array[w++]=a[s].y,b.array[w++]=a[s].z;b.needsUpdate=!0}_collectVertices(e,t){let r;const n=this.vertices;for(e.indices=[],r=0;r<n.length;++r)this.cullFlag[r]&&t(n[r])&&e.indices.push(r)}_sortIndices(e,t){let n,s;const i=this.vertices,o=[],a=new r.Vector3;for(n=1;n<e.indices.length;++n)a.subVectors(i[e.indices[n]],i[e.indices[0]]),a.normalize(),a.cross(t),a.negate(),o[n]=e.norm.dot(a);for(n=1;n<e.indices.length-1;++n)for(s=n+1;s<e.indices.length;++s)if(o[s]<o[n]){let t=o[n];o[n]=o[s],o[s]=t,t=e.indices[n],e.indices[n]=e.indices[s],e.indices[s]=t}}_updateIndices(){let e,t,n;const s=this.vertices,{size:i}=this;this._collectVertices(this.faces[0],(e=>e.z===-i.z)),this._collectVertices(this.faces[1],(e=>e.z===i.z)),this._collectVertices(this.faces[2],(e=>e.y===-i.y)),this._collectVertices(this.faces[3],(e=>e.y===i.y)),this._collectVertices(this.faces[4],(e=>e.x===-i.x)),this._collectVertices(this.faces[5],(e=>e.x===i.x));const o=new r.Vector3,a=new r.Vector3,l=new r.Vector3;for(t=0;t<this.faces.length;++t){if(n=this.faces[t],0===n.indices.length)continue;for(o.set(0,0,0),e=0;e<n.indices.length;++e)o.add(s[n.indices[e]]);o.multiplyScalar(1/n.indices.length),a.subVectors(s[n.indices[0]],o),a.normalize();const r=[];for(e=0;e<n.indices.length;++e)l.subVectors(s[n.indices[e]],o),r[e]=l.dot(a);for(e=1;e<n.indices.length;++e)if(r[e]<r[0]){let t=r[0];r[0]=r[e],r[e]=t,[t]=n.indices,n.indices[0]=n.indices[e],n.indices[e]=t}this._sortIndices(n,a)}let c=0;for(t=0;t<this.faces.length;++t)n=this.faces[t],n.indices.length>=3&&(c+=3*(n.indices.length-2));let h=0;const u=new Uint16Array(c);for(t=0;t<this.faces.length;++t)for(n=this.faces[t],e=0;e<n.indices.length-2;++e)u[h]=n.indices[0],u[h+1]=n.indices[e+1],u[h+2]=n.indices[e+2],h+=3;this.geometry.setIndex(new r.BufferAttribute(u,1))}setDataSource(e){const t=new aa.VolumeMaterial,r=e.getDimensions(),n=e.getTiledTextureStride(),s=e.buildTiledTexture(),i=e.getBox();t.uniforms.volumeDim.value.set(r[0],r[1],r[2]),t.uniforms.tileTex.value=s,t.uniforms.tileTexSize.value.set(s.image.width,s.image.height),t.uniforms.tileStride.value.set(n[0],n[1]),Object.assign(this.volumeInfo,e.getVolumeInfo());const o=this.volumeInfo;t.uniforms.delta.value.copy(o.delta),t.uniforms.boxAngles.value.set(o.obtuseAngle[0],o.obtuseAngle[1],o.obtuseAngle[2]),this.material=t,i.getSize(this.scale),i.getCenter(this.position)}_updateIsoLevel(){const{kSigma:e,kSigmaMed:t,kSigmaMax:r}=z.now.modes.VD,n=this.volumeInfo,s=n.dmean-n.dmin,i=n.dmax-n.dmin,o=e=>(s+e*n.sd)/i;this.material.uniforms._isoLevel0.value.set(o(e),o(t),o(r))}static _nearClipPlaneOffset=.2;static _pos=(()=>new r.Vector3)();static _norm=(()=>new r.Vector3)();static _norm4D=(()=>new r.Vector4)();static _matrixWorldToLocal=(()=>new r.Matrix4)();static _clipPlane=(()=>new r.Plane)();rebuild(e){const t=la._nearClipPlaneOffset,r=la._pos,n=la._norm,s=la._norm4D,i=la._matrixWorldToLocal,o=la._clipPlane;this._updateIsoLevel(),e.getWorldDirection(n),e.getWorldPosition(r),r.addScaledVector(n,e.near+t),i.copy(this.matrixWorld).invert(),r.applyMatrix4(i),s.set(n.x,n.y,n.z,0),s.applyMatrix4(i),n.copy(s),n.normalize(),o.setFromNormalAndCoplanarPoint(n,r),this.clipPlane.equals(o)||(this.clipPlane=o.clone(),this._updateVertices(),this._updateIndices())}}const ca=la;class ha{static _projectionTable={XY:["x",2],XZ:["y",1],YZ:["z",0]};constructor(e,t){const{delta:n}=t,{obtuseAngle:s}=t,i=new r.Vector3;e.getSize(i),i.multiplyScalar(.5);const o=this._getBaseVertices(n,s),a=new r.BufferGeometry,l=[];for(let e=0;e<4;e++)l.push(o[e].clone().multiply(i)),l.push(o[(e+1)%4].clone().multiply(i));const c=new r.Vector3(2*i.x*(1-n.x-n.y),0,0);for(let e=0;e<8;e++)l.push(l[e].clone().add(c));for(let e=0;e<4;e++)l.push(l[2*e].clone()),l.push(l[2*e+8].clone());const h=new r.Vector3;e.getCenter(h),l.forEach((e=>e.add(h)));const u=function(e){const t=e.length,r=new Float32Array(3*t);for(let n=0;n<t;++n){const t=3*n,s=e[n];r[t]=s.x,r[t+1]=s.y,r[t+2]=s.z}return r}(l);a.setAttribute("position",new r.BufferAttribute(u,3)),this._lines=new r.LineSegments(a,new r.LineBasicMaterial({color:16777215})),this._lines.layers.set(sr.LAYERS.VOLUME)}_getBaseVertices(e,t){const n=ha._projectionTable,s=(r,s)=>{const i=e[n[r][0]];return(-.5*(s-1)+s*t[n[r][1]])*i};return[new r.Vector3(2*(s("XZ",1)+s("XY",1))-1,2*s("YZ",1)-1,-1),new r.Vector3(2*(s("XZ",-1)+s("XY",1))-1,2*s("YZ",-1)-1,1),new r.Vector3(2*(s("XZ",-1)+s("XY",-1))-1,1-2*s("YZ",1),1),new r.Vector3(2*(s("XZ",1)+s("XY",-1))-1,1-2*s("YZ",-1),-1)]}getMesh(){return this._lines}}const ua=ha;const da=class{constructor(e,t,n){const s=this._initPlaneGeo(t,n),i=new aa.BackFacePosMaterialFarPlane;this._plane=new fs.Mesh(s,i),this._plane.frustumCulled=!1,this._plane.doubleSided=!0;const o=new r.Matrix4;this._plane._onBeforeRender=function(t,n,s,i,a,l){const{material:c}=this;if(!e||!c)return;const h=new r.Vector4(0,0,-(s.far-.1),1);h.applyMatrix4(s.matrixWorld),this.matrix.identity(),this.matrix.makeTranslation(h.x,h.y,h.z),this.matrixWorld.copy(this.matrix),this.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,this.matrixWorld),this.normalMatrix.getNormalMatrix(this.modelViewMatrix);const u=e.matrixWorld;o.copy(u).invert(),c.uniforms.aspectRatio.value=s.aspect,c.uniforms.farZ.value=s.far,c.uniforms.tanHalfFOV.value=Math.tan(.5*r.MathUtils.DEG2RAD*s.fov),c.uniforms.matWorld2Volume.value=o},this._plane.layers.set(sr.LAYERS.VOLUME_BFPLANE)}_initPlaneGeo(e,t){const n=new r.BufferGeometry;e=e||1,t=t||1;const s=new Float32Array([-.5*e,.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0]);return n.setAttribute("position",new r.BufferAttribute(s,3)),n.setIndex([0,2,1,2,3,1]),n}getMesh(){return this._plane}};const pa=class extends ar{constructor(e,t){super(e,t),this._mesh=new ca,this._mesh.setDataSource(t),this.add(this._mesh),this._frame=new ua(this.getBoundaries().boundingBox,this._mesh.volumeInfo),this.add(this._frame.getMesh()),this.showFrame(z.now.modes.VD.frame),this._farPlane=new da(this._mesh,2,2),this.add(this._farPlane.getMesh())}getBoundaries(){const e=this._dataSource.getBox(),t=new r.Sphere;return e.getBoundingSphere(t),{boundingBox:e,boundingSphere:t}}getMesh(){return this._mesh}showFrame(e){this._frame.getMesh().material.visible=e}};const ma=class extends hr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],["types"])}find(e){let t=[];if(e.type)t=this._dict.types[e.type.toLowerCase()]||[];else if(e.source)return this._list.filter((t=>t.canProbablyLoad&&t.canProbablyLoad(e.source)));return[...t]}};class fa extends g{constructor(e,t){super(),this._source=e,this._options=t||{},this._abort=!1,this._agent=null}load(){return Promise.reject(new Error("Loading from this source is not implemented"))}abort(){this._abort=!0,this._agent&&this._agent.abort()}static extractName(e){}}ur(fa.prototype);class _a extends fa{constructor(e,t){super(e,t),t=this._options,this._binary=!0===t.binary}load(){return new Promise(((e,t)=>{if(this._abort)throw new Error("Loading aborted");const r=this._source,n=this._agent=new FileReader;n.addEventListener("load",(()=>{e(n.result)})),n.addEventListener("error",(()=>{t(n.error)})),n.addEventListener("abort",(()=>{t(new Error("Loading aborted"))})),n.addEventListener("progress",(e=>{this.dispatchEvent(e)})),this._binary?n.readAsArrayBuffer(r):n.readAsText(r)}))}static canProbablyLoad(e){return File&&e instanceof File||Blob&&e instanceof Blob}static extractName(e){return e&&e.name}}_a.types=["file","blob"];const ga=/^(https?|ftp):\/\//i;class ya extends fa{constructor(e,t){super(e,t),t=this._options,this._binary=!0===t.binary}load(){return new Promise(((e,t)=>{if(this._abort)throw new Error("Loading aborted");const r=this._source,n=this._agent=new XMLHttpRequest;n.addEventListener("load",(()=>{200===n.status?e(n.response):t(new Error(`HTTP ${n.status} while fetching ${r}`))})),n.addEventListener("error",(()=>{t(new Error("HTTP request failed"))})),n.addEventListener("abort",(()=>{t(new Error("Loading aborted"))})),n.addEventListener("progress",(e=>{this.dispatchEvent(e)})),n.open("GET",r),this._binary?n.responseType="arraybuffer":n.responseType="text",n.send()}))}static canProbablyLoad(e){return t().isString(e)&&ga.test(e)}static extractName(e){if(e){const t=(e.indexOf("?")+1||e.lastIndexOf("#")+1||e.length+1)-1;return e.slice(e.lastIndexOf("/",t)+1,t)}}}ya.types=["url"];class xa extends fa{load(){return new Promise((e=>{if(this._abort)throw new Error("Loading aborted");e(this._source)}))}static canProbablyLoad(e){return!1}}xa.types=["immediate"];const ba=new ma([_a,ya,xa]);const wa=class extends hr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],["formats","extensions"])}find(e){let t=[];return e.format?t=this._dict.formats[e.format.toLowerCase()]||[]:e.ext&&(t=this._dict.extensions[e.ext.toLowerCase()]||[]),0===t.length&&!e.format&&e.data?this._list.filter((t=>t.canProbablyParse&&t.canProbablyParse(e.data))):[...t]}};class Sa{constructor(e,t){this._data=e,this._options=t||{},this._abort=!1}parseSync(){throw new Error("Parsing this type of data is not implemented")}parse(){return new Promise(((e,t)=>{setTimeout((()=>{try{return this._abort?t(new Error("Parsing aborted")):e(this.parseSync())}catch(e){return t(e)}}))}))}getModel(){return this.model._parseHeader(this._data),this.model}abort(){this._abort=!0}}ur(Sa.prototype);class va{constructor(){this.matrices=[],this._matrix=null,this._matrixIndex=-1}parse(e){let t=this._matrix;if("  SMTRY"===e.readString(12,18)){const n=e.readCharCode(19)-49,s=e.readString(20,80).trim().split(/\s+/),i=parseInt(s[0],10);null!==this._matrix&&i===this._matrixIndex||(this._matrixIndex=i,this._matrix=t=new r.Matrix4,this.matrices[this.matrices.length]=t);const{elements:o}=t;o[n]=parseFloat(s[1]),o[n+4]=parseFloat(s[2]),o[n+8]=parseFloat(s[3]),o[n+12]=parseFloat(s[4])}}}va.prototype.id=290;const Ca=va,{Assembly:Aa}=Yt;class Ea{constructor(e){this._complex=e,this.assemblies=[],this._assembly=null,this._matrix=null,this._matrixIndex=-1}parse(e){let t=this._assembly,n=this._matrix;if(t&&"  BIOMT"===e.readString(12,18)){const s=e.readCharCode(19)-49,i=e.readString(20,80).trim().split(/\s+/),o=parseInt(i[0],10);null!==this._matrix&&o===this._matrixIndex||(this._matrixIndex=o,this._matrix=n=new r.Matrix4,t.addMatrix(n));const{elements:a}=n;a[s]=parseFloat(i[1]),a[s+4]=parseFloat(i[2]),a[s+8]=parseFloat(i[3]),a[s+12]=parseFloat(i[4])}else if(t&&"CHAINS:"===e.readString(35,41)){const r=e.readString(42,80).split(",");for(let e=0,n=r.length;e<n;++e){const n=r[e].trim();n.length>0&&t.addChain(n)}}else"BIOMOLECULE:"===e.readString(12,23)&&(this._matrix=null,this._matrixIndex=-1,this._assembly=t=new Aa(this._complex),this.assemblies.push(t))}}Ea.prototype.id=350;const Ta=Ea;const Ra=class{constructor(e){this._data=e,this._start=0,this._nextCR=-1,this._nextLF=-1,this._next=-1,this._end=e.length,this.next()}readLine(){return this._data.slice(this._start,this._next)}readChar(e){return(e=this._start+e-1)<this._next?this._data[e]:" "}readCharCode(e){return(e=this._start+e-1)<this._next?this._data.charCodeAt(e):32}readString(e,t){const r=this._start+e-1,n=this._start+t;return this._data.slice(r,n<this._next?n:this._next)}readInt(e,t){return parseInt(this.readString(e,t),10)}readFloat(e,t){return parseFloat(this.readString(e,t))}end(){return this._start>=this._end}next(){const e=this._next+1;this._start=e<this._end?e:this._end,this._start>this._nextCR&&(this._nextCR=(this._data.indexOf("\r",this._start)+1||this._end+1)-1),this._start>this._nextLF&&(this._nextLF=(this._data.indexOf("\n",this._start)+1||this._end+1)-1),this._next=this._nextCR+1<this._nextLF?this._nextCR:this._nextLF}},{Complex:Ma,Element:Pa,Helix:Na,Sheet:La,Strand:Ia,Bond:Oa,Molecule:Va}=Yt;const Da=/^(HEADER\s|COMPND\s|REMARK\s|ATOM {2}|HETATM|MODEL )/i,ka={290:Ca,350:Ta};class za extends Sa{constructor(e,t){super(e,t),this._complex=null,this._chain=null,this._residue=null,this._sheet=null,this._serialAtomMap=null,this._modelId=1,this._compaundFound=!1,this._biomoleculeFound=!1,this._allowedChainsIDs=null,this._lastMolId=-1,this._remarks={},this._remark=null,this._molecules=[],this._molecule=null,this._compndCurrToken="",this._options.fileType="pdb"}static canProbablyParse(e){return t().isString(e)&&Da.test(e)}_finalize(){this._fixBondsArray(),this._fixChains();const e=this._remarks[290];this._complex.symmetry=t().isUndefined(e)?[]:e.matrices;const r=this._remarks[350];this._complex.units=this._complex.units.concat(t().isUndefined(r)?[]:r.assemblies),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}_finalizeMolecules(){const e={};let t;const r=this._complex._chains;for(t=0;t<r.length;++t){const n=r[t];e[n._name]=n}for(t=0;t<this._molecules.length;t++){const r=this._molecules[t];let n=[];for(let t=0;t<r._chains.length;t++){const s=e[r._chains[t]];n=n.concat(s._residues.slice())}const s=new Va(this._complex,r._name,t+1);s.residues=n,this._complex._molecules[t]=s}}_fixChains(){const e={},t=this._complex;for(let r=0;r<t._chains.length;r++){const n=t._chains[r];e[n._name.charCodeAt(0)]=n}}_fixBondsArray(){const e=this._serialAtomMap={},t=this._complex,r=t._atoms;for(let t=0,n=r.length;t<n;++t){const n=r[t];e[n.serial]=n}const n=t._bonds,{logger:s}=this;for(let t=0,r=n.length;t<r;++t){const r=n[t];r._right<r._left&&s.debug("_fixBondsArray: Logic error."),r._left=e[r._left]||null,r._right=e[r._right]||null}}_parseATOM(e){if(1!==this._modelId)return;const t=72===e.readCharCode(1),n=t?e.readInt(7,11):e.readInt(6,11);let s=e.readString(13,16);const i=e.readChar(17),o=e.readString(18,20).trim(),a=e.readChar(22),l=e.readInt(23,26),c=e.readChar(27),h=e.readFloat(31,38),u=e.readFloat(39,46),d=e.readFloat(47,54),p=e.readFloat(55,60),m=e.readFloat(61,66),f=e.readString(77,78).trim()||function(e){const t=4===e.trim().length;return e.slice(0,t?1:2).trim()}(s),_=e.readInt(79,80)||0;if(this.settings.now.nowater&&("HOH"===o||"WAT"===o))return;s=s.trim();const g=Pa.getByName(f),y=Pa.Role[s];let x=this._chain;x&&x.getName()===a||(this._chain=x=this._complex.getChain(a)||this._complex.addChain(a),this._residue=null);let b=this._residue;b&&b.getSequence()===l&&b.getICode()===c||(this._residue=b=x.addResidue(o,l,c));const w=new r.Vector3(h,u,d);b.addAtom(s,g,w,y,t,n,i,p,m,_)}_parseENDMDL(){this._modelId+=1}_parseCONECT(e){const t=e.readInt(7,11),r=e.readInt(12,16),n=e.readInt(17,21),s=e.readInt(22,26),i=e.readInt(27,31),o=this._complex;r&&r>t&&o.addBond(t,r,0,Oa.BondType.UNKNOWN,!0),n&&n>t&&o.addBond(t,n,0,Oa.BondType.UNKNOWN,!0),s&&s>t&&o.addBond(t,s,0,Oa.BondType.UNKNOWN,!0),i&&i>t&&o.addBond(t,i,0,Oa.BondType.UNKNOWN,!0)}_parseCOMPND(e){const t=e.readString(11,80),r=t.indexOf(":");if(this._compndCurrToken=r>0?t.substring(0,r).trim():this._compndCurrToken,"MOL_ID"===this._compndCurrToken)this._molecule={_index:"",_chains:[]},this._molecule._index=parseInt(t.substring(r+1,t.indexOf(";")),10),this._molecules.push(this._molecule);else if("MOLECULE"===this._compndCurrToken&&null!=this._molecule)this._molecule._name=t.substring(r+1,t.indexOf(";")).trim();else if("CHAIN"===this._compndCurrToken&&null!=this._molecule){let e=t.substring(r+1,80).trim();const n=e[e.length-1];";"!==n&&","!==n||(e=e.slice(0,-1)),e=e.replace(/\s+/g,"");const s=e.split(",");this._molecule._chains=this._molecule._chains.concat(s)}}_parseREMARK(e){const r=e.readInt(8,10);let n=this._remarks[r];if(t().isUndefined(n)){const e=ka[r];t().isFunction(e)&&(this._remarks[r]=n=new e(this._complex))}t().isUndefined(n)||n.parse(e)}_parseHELIX(e){this._parseSTRUCTURE(e,[20,22,32,34],(e=>{this._complex.addHelix(e),this._complex.structures.push(e)}))}_parseSHEET(e){this._parseSTRUCTURE(e,[22,23,33,34],(e=>{this._complex.addSheet(e)}))}_parseSTRUCTURE(e,t,r){const n=e.readInt(8,10),s=e.readString(12,14).trim(),i=e.readString(41,70).trim(),o=e.readInt(72,76),a=e.readInt(39,40),l=e.readInt(15,16),c=e.readInt(42,45),h=e.readInt(57,60),u=e.readString(t[0],t[2]+1).charCodeAt(0),d=e.readString(t[2],t[2]+1).charCodeAt(0),p=e.readInt(t[1],t[1]+3);let m=e.readString(t[1]+4,t[1]+4),f=0;m.length>0&&(f=m.charCodeAt(0));const _=e.readInt(t[3],t[3]+3);m=e.readString(t[3]+4,t[3]+4);let g,y=0;m.length>0&&(y=m.charCodeAt(0));let x=this._sheet;if(83===e.readCharCode(1)){null!==x&&x.getName()!==s&&(x=null,this._sheet=null),null===x?(this._sheet=g=new La(s,l),r(g)):g=x;const e=new Ia(g,this._complex.getUnifiedSerial(u,p,f),this._complex.getUnifiedSerial(d,_,y),a,c,h);g.addStrand(e),this._complex.structures.push(e)}else g=new Na(a,this._complex.getUnifiedSerial(u,p,f),this._complex.getUnifiedSerial(d,_,y),n,s,i,o),r(g)}_parseHEADER(e){const{metadata:t}=this._complex;t.classification=e.readString(11,50).trim(),t.date=e.readString(51,59).trim();const r=e.readString(63,66).trim();t.id=r,r&&(this._complex.name=r),t.format="pdb"}_parseTITLE(e){const{metadata:t}=this._complex;t.title=t.title||[];const r=e.readInt(9,10)||1;t.title[r-1]=e.readString(11,80).trim()}static tagParsers=(()=>({HEADER:za.prototype._parseHEADER,"TITLE ":za.prototype._parseTITLE,"ATOM  ":za.prototype._parseATOM,HETATM:za.prototype._parseATOM,ENDMDL:za.prototype._parseENDMDL,CONECT:za.prototype._parseCONECT,COMPND:za.prototype._parseCOMPND,REMARK:za.prototype._parseREMARK,"HELIX ":za.prototype._parseHELIX,"SHEET ":za.prototype._parseSHEET,"ATOM 1":za.prototype._parseATOM,"ATOM 2":za.prototype._parseATOM,"ATOM 3":za.prototype._parseATOM,"ATOM 4":za.prototype._parseATOM,"ATOM 5":za.prototype._parseATOM,"ATOM 6":za.prototype._parseATOM,"ATOM 7":za.prototype._parseATOM,"ATOM 8":za.prototype._parseATOM,"ATOM 9":za.prototype._parseATOM}))();parseSync(){const e=new Ra(this._data),r=this._complex=new Ma;for(;!e.end();){const r=e.readString(1,6),n=za.tagParsers[r];t().isFunction(n)&&n.call(this,e),e.next()}if(this._finalize(),this._serialAtomMap=null,this._sheet=null,this._residue=null,this._chain=null,this._complex=null,0===r.getAtomCount())throw new Error("The data does not contain valid atoms");return r}}za.formats=["pdb"],za.extensions=[".pdb",".ent"];const Fa=za,{Complex:Ba,Element:Ua,SGroup:Ga,Bond:ja}=Yt,Ha={A:0,S:1,D:2,T:3},$a=/\s*<\?xml\b[^?>]*\?>\s*<(?:cml|molecule)\b/i;class Wa extends Sa{constructor(e,t){super(e,t),this._complex=null,this._residue=null,this._serialAtomMap=null,this._modelId=1,this._lastMolId=-1,this._readOnlyOneMolecule=!1,this._options.fileType="cml"}static canProbablyParse(e){return t().isString(e)&&$a.test(e)}_rebuidBondIndexes(e,t){const r=e.length;for(let n=0;n<r;n++){const r=e[n].id,s=t.length;for(let e=0;e<s;e++){const s=t[e].atomRefs2.split(" ");s[0]===r&&(t[e].start=n),s[1]===r&&(t[e].end=n)}}}_createSGroup(e,t){const n=new Ga(e.id,e.fieldData,new r.Vector3(parseFloat(e.x),parseFloat(e.y),0),e.atomRefs,e);"Relative"===e.placement&&(n._center=new r.Vector3(0,0,0)),"MDLBG_FRAGMENT_CHARGE"===e.fieldName&&(n._charge=parseInt(e.fieldData,10)||0),"MDLBG_FRAGMENT_COEFFICIENT"===e.fieldName&&(n._repeat=parseInt(e.fieldData,10)||1),t.push(n)}_extractSGroup(e,t){if(Array.isArray(t)||(t=[]),e)if(Array.isArray(e)){const r=e.length;for(let n=0;n<r;n++)e[n].molecule&&(t=t.concat(this._extractSGroup(e[n].molecule))),this._createSGroup(e[n],t)}else e.molecule&&e.molecule&&(t=t.concat(this._extractSGroup(e.molecule))),this._createSGroup(e,t);return t}_extractSGroups(e,t){const n=this._extractSGroup(e),s=t.length;let i,o;for(i=0;i<s;i++){const e=t[i].id;for(o=0;o<n.length;o++){n[o]._atoms.split(" ")[0]===e&&(t[i].sgroupRef||(t[i].sgroupRef=[]),t[i].sgroupRef.push(n[o]))}}let a={},l=null;const c=1e8,h=new r.Vector3(c,c,c),u=new r.Vector3(-c,-c,-c);function d(e){l=a[e],l&&n[o]._atoms.push(l.a)}function p(e){l=a[e],l&&(h.set(Math.min(h.x,l.x),Math.min(h.y,l.y),Math.min(h.z,l.z)),u.set(Math.max(u.x,l.x),Math.max(u.y,l.y),Math.max(u.z,l.z)),d(e))}for(i=0;i<t.length;i++)a[t[i].id]={},a[t[i].id].x=t[i].x2,t[i].x3&&(a[t[i].id].x=t[i].x3),a[t[i].id].x=parseFloat(a[t[i].id].x),a[t[i].id].y=t[i].y2,t[i].y3&&(a[t[i].id].y=t[i].y3),a[t[i].id].y=parseFloat(a[t[i].id].y),a[t[i].id].z="0.0",t[i].z3&&(a[t[i].id].z=t[i].z3),a[t[i].id].z=parseFloat(a[t[i].id].z),a[t[i].id].a=t[i];let m;for(o=0;o<n.length;o++)null!==n[o]._center?(h.set(c,c,c),u.set(-c,-c,-c),m=n[o]._atoms.split(" "),n[o]._atoms=[],m.forEach(p),n[o]._center.addVectors(h,u),n[o]._center.multiplyScalar(.5)):(m=n[o]._atoms.split(" "),n[o]._atoms=[],m.forEach(d));a=null}_traverseData(e){const t={};return e.childNodes.length&&function e(t,r){if("#text"===t.nodeName&&""===t.nodeValue.trim())return;const n={};n.xmlNode=t;const s=r[t.nodeName];var i;let o,a;if(s?(i=s,"[object Array]"!==Object.prototype.toString.apply(i)?r[t.nodeName]=[s,n]:r[t.nodeName].push(n)):r[t.nodeName]=n,t.attributes)for(({length:o}=t.attributes),a=0;a<o;a++){const e=t.attributes[a];n[e.nodeName]=e.nodeValue}for(({length:o}=t.childNodes),a=0;a<o;a++)e(t.childNodes[a],n)}(e.childNodes[0],t),t}_findSuitableMolecule(e,t){for(const r in e)if("xmlNode"!==r)if("molecule"===r){if(e.molecule&&(e.molecule.atomArray&&e.molecule.atomArray.atom&&t.push(e),Array.isArray(e.molecule)))for(let r=0;r<e.molecule.length;r++)e.molecule[r].atomArray&&e.molecule[r].atomArray.atom&&t.push({molecule:e.molecule[r]})}else e[r]&&null!==e[r]&&"object"==typeof e[r]&&this._findSuitableMolecule(e[r],t)}_selectComponents(e){const t=(new DOMParser).parseFromString(e,"application/xml"),r=this._traverseData(t);let n;const s=this;n=r.cml?r.cml:r;const i=[],o=[];return this._findSuitableMolecule(n,o),this._readOnlyOneMolecule&&o.length>1&&o.splice(1,o.length-1),o.forEach((e=>{const r=function(e){let r,n=[];if(e.molecule&&e.molecule.atomArray&&e.molecule.atomArray.atom)Array.isArray(e.molecule.atomArray.atom)?n=e.molecule.atomArray.atom:n.push(e.molecule.atomArray.atom);else if(!e.molecule){return{atomLabels:null,labelsCount:1}}e.molecule.molecule&&s._extractSGroups(e.molecule.molecule,n);let i=n.length;for(let e=0;e<i;e++)r=n[e],r.edges=[];let o,a=[];e.molecule.bondArray&&e.molecule.bondArray.bond&&(Array.isArray(e.molecule.bondArray.bond)?a=e.molecule.bondArray.bond:a.push(e.molecule.bondArray.bond)),i=a.length,s._rebuidBondIndexes(n,a);for(let e=0;e<i;e++){if(o=a[e],r=n[o.start],!(r&&(r.edges.push(o.end),r=n[o.end],r&&(r.edges.push(o.start),1))))continue;const t=o.xmlNode.getAttribute("order"),s=parseInt(t,10);if(a[e].order=0,a[e].type=ja.BondType.UNKNOWN,s>1)a[e].order=s;else{const r=Ha[t];void 0!==r&&(a[e].order=r,"A"===t&&(a[e].type=ja.BondType.AROMATIC))}}i=n.length;for(let e=0;e<i;e++)r=n[e],r.edges.sort();const l=s._breadWidthSearch(n,0),c={};return c.atoms=n,c.bonds=a,c.labels=l.atomLabels,c.count=Math.min(1,l.labelsCount),c.curr=-1,c.originalCML=t,c}(e);r.atoms.length>0&&i.push(r)})),i}_packLabel(e,t){return(t<<16)+e}_unpackLabel(e){return{molId:e>>>16,compId:65535&e}}_breadWidthSearch(e,t){const r=new Array(e.length);let n;for(n=0;n<r.length;n++)r[n]=this._packLabel(0,t);const s=[];let i=0,o=e.length;for(;o>0;){i++;let a=-1;for(n=0;n<r.length;n++)if(0===this._unpackLabel(r[n]).compId){a=n;break}if(a<0)break;for(s.push(e[a]),r[a]=this._packLabel(i,t),o--;s.length>0;){const t=s.shift();if(t)for(let n=0;n<t.edges.length;n++)r[t.edges[n]]!==i&&(s.push(e[t.edges[n]]),r[t.edges[n]]=i,o--)}}const a={};return a.atomLabels=r,a.labelsCount=i,a}_parseBond(e,t,r,n){if(e>=0){const s=[Math.min(e,t),Math.max(e,t)];this._complex.addBond(s[0],s[1],r,n,!0)}}_fixBondsArray(){const e=this._serialAtomMap={},t=this._complex,r=t._atoms;for(let t=0,n=r.length;t<n;++t){const n=r[t];e[n.serial]=n}const n=t._bonds,{logger:s}=this;for(let t=0,r=n.length;t<r;++t){const r=n[t];r._right<r._left&&s.debug("_fixBondsArray: Logic error."),r._left=e[r._left]||null,r._right=e[r._right]||null}}_parseSet(e){const t=this._complex=new Ba,n=e,s=n.curr,{atoms:i,labels:o}=n;let a,l,c=null;const h=i.length;let u={};const d=[];for(a=0;a<h;a++)d.push(a);for(d.sort(((e,t)=>o[e]-o[t])),a=0;a<h;a++){const e=0,n=o[d[a]];if(this._unpackLabel(n).molId===this._unpackLabel(s).molId){c=i[d[a]];const s=c.elementType;if(c.sgroupRef){const e=c.sgroupRef.length;for(let r=0;r<e;++r)t._sgroups.push(c.sgroupRef[r])}if(c.x3||c.x2){const t=this._unpackLabel(n).compId,i=" ",o=t,a=" ";let l=t.toString();1===l.length&&(l=`0${l}`);const h=`N${l}`;let d=u[i];d&&d.getName()===i||(u[i]=d=this._complex.getChain(i)||this._complex.addChain(i),this._residue=null);let m=this._residue;m&&m.getSequence()===o&&m.getICode()===a||(this._residue=m=d.addResidue(h,o,a));let f=null;c.x3?f=new r.Vector3(parseFloat(c.x3),parseFloat(c.y3),parseFloat(c.z3)):c.x2&&(f=new r.Vector3(parseFloat(c.x2),parseFloat(c.y2),0));let _=Ua.ByName[c.elementType.toUpperCase()];_||(_=JSON.parse(JSON.stringify(Ua.ByName[Object.keys(Ua.ByName)[Object.keys(Ua.ByName).length-1]])),_.number+=1,_.name=c.elementType.toUpperCase(),_.fullName="Unknown",Ua.ByName[c.elementType.toUpperCase()]=_);const g=parseInt(c.id.replace(/[^0-9]/,""),10),y=m.addAtom(s,_,f,Ua.Role.SG,!0,g," ",1,0,e);c.hydrogenCount&&(y.hydrogenCount=parseInt(c.hydrogenCount,10)),c.mrvValence&&(y.valence=parseInt(c.mrvValence,10)),(p=y).xmlNodeRef=c,c.x2&&(c.x3=c.x2,delete c.x2),c.y2&&(c.y3=c.y2,delete c.y2),c.z3||(c.z3="0.0"),c.complexAtom=p}}}var p;for(u=null,a=0;a<n.bonds.length;a++){const e=n.bonds[a];if(this._unpackLabel(o[e.start]).molId===this._unpackLabel(s).molId&&this._unpackLabel(o[e.end]).molId===this._unpackLabel(s).molId){if(c=i[e.start],!c||!i[e.end])continue;this._parseBond(parseInt(c.id.replace(/[^0-9]/,""),10),parseInt(i[e.end].id.replace(/[^0-9]/,""),10),e.order,e.type)}}for(a=0;a<this._complex.getSGroupCount();a++){const e=this._complex.getSGroups()[a];for(l=0;l<e._atoms.length;l++)e._atoms[l]=e._atoms[l].complexAtom}for(a=0;a<h;a++)this._unpackLabel(o[a]).molId===this._unpackLabel(s).molId&&(c=i[a],c.complexAtom=null,delete c.complexAtom);return this._complex.originalCML=n.originalCML,this._fixBondsArray(),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._serialAtomMap=null,this._complex=null,t}parseSync(){const e=[],t=this;this._selectComponents(this._data).forEach((r=>{r.curr=2,0===r.count&&(r.count=1);for(let n=0;n<r.count;n++)r.curr=n+1,e.push(t._parseSet(r,!1))}));let r=0;if(e.forEach((e=>{r+=e.getAtomCount()})),r<=0)throw new Error("The data does not contain valid atoms");if(e.length>1){const t=new Ba;return t.joinComplexes(e),t.originalCML=e[0].originalCML,t}return 1===e.length?e[0]:new Ba}}Wa.formats=["cml"],Wa.extensions=[".cml"];const Ya=Wa;var Xa=s(660),qa=s.n(Xa);const{Complex:Za,Chain:Ka,Atom:Qa,Element:Ja,Helix:el,Sheet:tl,Strand:rl,Bond:nl,Assembly:sl,Molecule:il}=Yt;class ol{constructor(e){this._original=Array.from(e),this._original.sort(),this._sum=0;for(let e=0;e<this._original.length;++e)this._sum+=this._original[e]}compare(e){const t=e.length;if(t!==this._original.length)return!1;let r,n=0;for(r=0;r<t;++r)n+=e[r];if(n!==this._sum)return!1;const s=Array.from(e);for(s.sort(),r=0;r<t;++r)if(s[r]!==this._original[r])return!1;return!0}}ol.prototype.constructor=ol;const al=Oe.Type,ll=[al.HELIX_PI,al.BEND,al.HELIX_ALPHA,al.STRAND,al.HELIX_310,al.BRIDGE,al.TURN,al.COIL];class cl extends Sa{constructor(e,t){super(e,t),this._options.fileType="mmtf"}static canProbablyParse(e){return t().isArrayBuffer(e)&&223==(1|new Uint8Array(e,0,1)[0])}_onModel(e){}_onChain(e){if(0!==e.modelIndex)return;const t=new Ka(this._complex,e.chainName);this._complex._chains[e.chainIndex]=t,t._index=e.chainIndex}_onGroup(e){if(0!==e.modelIndex)return;if(this.settings.now.nowater&&("HOH"===e.groupName||"WAT"===e.groupName))return;const t=this._complex._chains[e.chainIndex],r=e.insCode.charCodeAt(0)?e.insCode:"",n=t.addResidue(e.groupName,e.groupId,r);n._index=e.groupIndex,this._updateSecStructure(this._complex,n,e)}_onAtom(e){if(0!==e.modelIndex)return;const t=e.altLoc.charCodeAt(0)?e.altLoc:"",n=new Qa(e.groupIndex,e.atomName,Ja.getByName(e.element.toUpperCase()),new r.Vector3(e.xCoord,e.yCoord,e.zCoord),Ja.Role[e.atomName],!1,e.atomId,t,e.occupancy,e.bFactor,e.formalCharge);this._complex._atoms[e.atomIndex]=n,n.index=e.atomIndex,this._serialAtomMap[e.atomId]=n}_onBond(e){const t=Math.max(e.atomIndex1,e.atomIndex2);if(t>=this._complex._atoms.length)return;const r=Math.min(e.atomIndex1,e.atomIndex2);this._complex.addBond(this._complex._atoms[r],this._complex._atoms[t],e.bondOrder,nl.BondType.UNKNOWN,!0)}_updateSecStructure(e,r,n){const s=[3,-1,1,-1,5];if(!t().isUndefined(n)&&n.secStruct===this._ssType)return r._secondary=this._ssStruct,void(this._ssStruct&&(this._ssStruct.term=r));if(!t().isUndefined(n)){const t=ll[n.secStruct];this._ssType=n.secStruct,this._ssStart=r;let i=null;switch(this._ssType){case-1:case 7:break;case 0:case 2:case 4:i=new el(s[this._ssType],r,r,0,"","",0),e._helices.push(i);break;case 3:{const t=new tl("",0);e._sheets.push(t),i=new rl(t,r,r,0,null,null);break}default:void 0!==t&&(i=new Oe(t,r,r))}this._ssStruct=i,r._secondary=i,i&&e.structures.push(i)}}_updateMolecules(e){const t=e.entityList;if(!t)return;const r=e.chainsPerModel[0];for(let e=0;e<t.length;e++){const n=t[e],s=n.chainIndexList;let i=[];for(let e=0;e<s.length;e++){const t=s[e];if(t>=r)continue;const n=this._complex._chains[t];i=i.concat(n._residues.slice())}const o=new il(this._complex,n.description,e+1);o.residues=i,this._complex._molecules[e]=o}}_traverse(e){const t=this,{metadata:r}=this._complex;r.id=e.structureId,r.title=[],r.title[0]=e.title,r.date=e.releaseDate,r.format="mmtf";const n={onModel(e){t._onModel(e)},onChain(e){t._onChain(e)},onGroup(e){t._onGroup(e)},onAtom(e){t._onAtom(e)},onBond(e){t._onBond(e)}};this._ssType=-1,this._ssStruct=null,this._ssStart=null,qa().traverse(e,n),this._updateSecStructure(this._complex),this._updateMolecules(e)}_linkAtomsToResidues(){for(let e=0;e<this._complex._atoms.length;++e){const t=this._complex._atoms[e],r=this._complex._residues[t.residue];t.residue=r,r._atoms.push(t)}}_findSynonymousChains(){const e={};for(let t=0;t<this._complex._chains.length;++t){const r=this._complex._chains[t],n=r.getName();e.hasOwnProperty(n)||(e[n]=[]),e[n].push(r._index)}return e}_parseAssemblyInfo(e){let t,n,s;const i=[],{logger:o}=this;for(t=0;t<e.bioAssemblyList.length;++t){const a=e.bioAssemblyList[t];if(0===a.transformList.length)continue;const l=a.transformList[0].chainIndexList,c=new ol(l),h={};for(n=0;n<l.length;++n)h[this._complex._chains[l[n]].getName()]=1;const u=[];let d;for(d in h)h.hasOwnProperty(d)&&Array.prototype.push.apply(u,this._chainsByName[d]);c.compare(u)||o.debug("MMTF: Assembly is missing some of the synonymous chains. Skipping...");const p=new sl(this._complex);for(d in h)h.hasOwnProperty(d)&&p.addChain(d);for(p.addMatrix((new r.Matrix4).fromArray(a.transformList[0].matrix).transpose()),n=1;n<a.transformList.length;++n){const e=a.transformList[n];if(!c.compare(e.chainIndexList)){o.debug("MMTF: Chain lists differ for different transforms in one assembly. Skipping...");continue}const t=(new r.Matrix4).fromArray(e.matrix).transpose();for(s=0;s<p.matrices.length&&!p.matrices[s].equals(t);++s);s===p.matrices.length&&p.addMatrix(t)}p.finalize(),i.push(p)}return i}_markHeteroAtoms(e){const t=e.chainsPerModel[0];for(let r=0;r<e.entityList.length;++r){const n=e.entityList[r];if("polymer"!==n.type)for(let e=0;e<n.chainIndexList.length;++e){const r=n.chainIndexList[e];if(r>=t)continue;const s=this._complex._chains[r];for(let e=0;e<s._residues.length;++e){const t=s._residues[e];for(let e=0;e<t._atoms.length;++e)t._atoms[e].het=!0}}}}_joinSynonymousChains(){let e,t;const r=[],n={};for(e=0;e<this._complex._chains.length;++e){const s=this._complex._chains[e],i=s.getName();if(!n.hasOwnProperty(i)){n[i]=s,s._index=r.length,r.push(s);continue}const o=n[i];for(t=0;t<s._residues.length;++t){const e=s._residues[t];o._residues.push(e),e._chain=o}}this._complex._chains=r}parseSync(){const e=qa().decode(this._data);return this._complex=new Za,this._serialAtomMap={},this._traverse(e),this._linkAtomsToResidues(),this._markHeteroAtoms(e),this._chainsByName=this._findSynonymousChains(),Array.prototype.push.apply(this._complex.units,this._parseAssemblyInfo(e)),this._joinSynonymousChains(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex}}cl.formats=["mmtf"],cl.extensions=[".mmtf"],cl.binary=!0;const hl=cl;class ul extends Error{constructor(e,t,r){super(`data:${t}:${r}: ${e}`),Error.captureStackTrace&&Error.captureStackTrace(this,ul),this.name="ParsingError",this.parseLine=t,this.parseColumn=r}}const dl=ul;function pl(e){return 32===e||10===e||13===e||9===e}function ml(e,t,r){const n=t.length;let s=-1;for(;r<n&&(s=t.charCodeAt(r),s!==e&&10!==s);)++r;return s===e?r:-1}const{Complex:fl,Element:_l,Helix:gl,Sheet:yl,Strand:xl,Assembly:bl,Molecule:wl}=Yt,Sl=["auth_seq_id","Cartn_x","Cartn_y","Cartn_z","label_atom_id"],vl={helx:"helix",turn:"turn",strn:"strand"};function Cl(e){const t=/[A-Za-z]+/.exec(e);return t?vl[t[0].toLowerCase()]:null}function Al(e){return null==e||t().isArray(e)?e:[e]}function El(e){const t=4===e.trim().length;return e.slice(0,t?1:2).trim()}class Tl extends Error{constructor(e){super(),this.name="AtomDataError",this.message=e}}function Rl(e,n){const s=(e=t().isString(e)?e:`${e}`).replace(/\)\s*\(/g,"!").replace(/[()']/g,"").split("!"),i=[];for(let e=0,t=s.length;e<t;++e){const t=s[e].split(","),r=[];let o=0;for(let e=0,s=t.length;e<s;++e){const s=t[e];if(s.includes("-")){const e=s.split("-");let t=parseInt(e[0],10);const i=parseInt(e[1],10);for(;t<=i;++t)r[o++]=n[t]}else r[o++]=n[s]}i.push(r)}const o=[];let a=0;return function e(t,n){for(let s=0,l=i[t].length;s<l;++s){const l=n?n.clone():new r.Matrix4;l.multiplyMatrices(i[t][s],l),0===t?o[a++]=l:e(t-1,l)}}(i.length-1),o}class Ml extends Sa{constructor(e,t){super(e,t),this.asymDict={},this.molecules=[],this._options.fileType="cif"}static canProbablyParse(e){return t().isString(e)&&/^\s*data_/i.test(e)}parseSync(){this.logger.info("Parsing CIF file..");const e=function(e){let r=0,n=0;const s=e.length;let i,o=NaN,a=!0,l=1,c=1,h=0;const u={};let d,p={},m=[],f=0,_="",g=[],y=0;function x(){let t;if((46===o||63===o)&&(r+1>=s||pl(e.charCodeAt(r+1))))return++c,void++r;if(a&&59===o){n=r;let i=0;do{if(n=ml(10,e,n+1),-1===n)throw new dl("Unterminated text block found",l,c);++i}while(n+1<s&&e.charCodeAt(n+1)!==o||n+1>=s);return t=e.substring(r+1,n).replace(/\r/g,""),r=n+2,l+=i,c=1,a=!1,t}if(39===o||34===o){n=r;do{if(n=ml(o,e,n+1),-1===n)throw new dl("Unterminated quoted string found",l,c)}while(n+1<s&&!pl(e.charCodeAt(n+1)));return t=e.substring(r+1,n),c+=n-r+1,r=n+1,t}for(n=r;n<s&&!pl(e.charCodeAt(n));)++n;t=e.substring(r,n),c+=n-r,r=n;const i=Number(t);return Number.isNaN(i)?t:i}for(;r<=s;){if(o=e.charCodeAt(r),13===o);else if(10===o)a=!0,++l,c=1;else{if(32!==o&&9!==o){if(35===o){if(r=ml(10,e,r+1),-1===r)break;continue}if(0===h){if(68!==o&&100!==o||"ata_"!==e.substr(r+1,4).toLowerCase()){if(Number.isNaN(o))break;throw new dl(`Unexpected character in state ${h}`,l,c)}for(n=r+5,i=n;n<s&&!pl(e.charCodeAt(n));)++n;if(c+=n-r,r=n,i<r){u[e.substring(i,r)]=p={},h=1;continue}throw new dl("Data block name missing",l,c)}if(1===h){if(68!==o&&100!==o||"ata_"!==e.substr(r+1,4).toLowerCase()){if(95===o){for(n=r+1,i=n;n<s&&!pl(e.charCodeAt(n));)++n;if(c+=n-r,r=n,i<r){_=e.substring(i,r),h=2;continue}throw new dl("Tag name missing",l,c)}if(76!==o&&108!==o||"oop_"!==e.substr(r+1,4).toLowerCase()){if(Number.isNaN(o))break;throw new dl(`Unexpected character in state ${h}`,l,c)}if(r+=5,c+=5,r<s&&!pl(e.charCodeAt(r)))throw new dl(`Unexpected character in state ${h}`,l,c);m=[],f=0,g=[],y=0,h=3;continue}h=0;continue}if(2===h){if(Number.isNaN(o))break;d=x(),t().set(p,_,d),h=1;continue}if(3===h){if(95===o){for(n=r+1,i=n;n<s&&!pl(e.charCodeAt(n));)++n;if(c+=n-r,r=n,i<r){w=e.substring(i,r),m[f++]=w;continue}throw new dl("Tag name missing",l,c)}if(f>0){for(let e=0;e<f;++e)d=[],g[e]=d,t().set(p,m[e],d);h=4;continue}throw new dl("Data tags are missing inside a loop",l,c)}if(4===h){68!==o&&100!==o||"ata_"!==e.substr(r+1,4).toLowerCase()?95===o?h=1:76!==o&&108!==o||"oop_"!==e.substr(r+1,4).toLowerCase()?Number.isNaN(o)?h=0:(b=x(),g[y%f].push(b),++y):h=1:h=0;continue}throw new dl(`Unexpected internal state ${h}`,l,c)}a=!1,++c}++r}var b,w;if(2===h)throw new dl(`Unexpected end of file in state ${h}`,l,c);return u}(this._data);return this._toComplex(e)}_toComplex(e){const t=new fl,r=e[Object.keys(e)[0]];return this._extractAtoms(t,r),this._extractSecondary(t,r),this._extractAssemblies(t,r),this._extractMolecules(t,r),this._extractMetadata(t,r),t.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing}),t}_extractMetadata(e,t){const{metadata:r}=e;r.id=t.entry.id,r.classification=t.struct_keywords.pdbx_keywords;const n=t.database_PDB_rev;r.date=n&&n.date_original?n.date_original:"",r.format="cif",r.title=[],r.title[0]=t.struct.title}_extractMolecules(e,t){const r=Al(t.entity.pdbx_description),n=r.length;let s;for(s=0;s<n;s++)this.molecules[s]?this.molecules[s].name=r[s]:this.molecules[s]={name:r[s],residues:[]};const i=e.getMolecules();for(s=0;s<n;s++){const t=this.molecules[s];i[s]=new wl(e,t.name,s+1),i[s].residues=t.residues}}_extractAtoms(e,t){const n=t.atom_site;if(!n)throw new Tl("CIF parsing error: atom_site is not specified!");for(let e=0,t=Sl.length;e<t;++e)if(!n[Sl[e]])throw new Tl(`CIF parsing error: requires field ${Sl[e]} not found!`);const{asymDict:s}=this,i=Al(n.auth_seq_id),o=Al(n.Cartn_x),a=Al(n.Cartn_y),l=Al(n.Cartn_z),c=Al(n.label_atom_id),h=c.length,u=Al(n.group_PDB)||[],d=Al(n.auth_asym_id)||[],p=Al(n.label_asym_id)||[],m=Al(n.id)||[],f=Al(n.pdbx_PDB_ins_code)||[],_=Al(n.label_comp_id)||[],g=Al(n.type_symbol)||[],y=Al(n.B_iso_or_equiv)||[],x=Al(n.occupancy)||[],b=Al(n.pdbx_formal_charge)||[],w=Al(n.label_alt_id)||[],S=Al(n.pdbx_PDB_model_num)||[],v=Al(n.label_entity_id)||[];let C=null,A=null;for(let t=0;t<h;++t){if(1!==(S[t]||1))continue;const n=String(d[t]||" ");C&&C.getName()===n||(C=e.getChain(n)||e.addChain(n)),s[String(p[t]||" ")]=n;const h=i[t],E=String(f[t]||" "),T=String(_[t]||"");if(!A||A.getSequence()!==h||A.getICode()!==E){A=C.addResidue(T,h,E);const e=v[t]-1;let r=this.molecules[e];r||(this.molecules[e]={name:"",residues:[]},r=this.molecules[e]),r.residues.push(A)}const R=c[t],M=g[t]||El(R),P=_l.getByName(M),N=_l.Role[R.trim()],L=new r.Vector3(o[t],a[t],l[t]),I="HETATM"===u[t]||!1,O=m[t]||t,V=y[t]||0,D=x[t]||0,k=String(w[t]||""),z=b[t]||0;A.addAtom(R,P,L,N,I,O,k,D,V,z)}}_extractSecondary(e,t){t.struct_conf&&this._extractConfs(e,t.struct_conf),t.struct_sheet_range&&this._extractSheets(e,t.struct_sheet_range)}_extractSheets(e,t){const{asymDict:r}=this;if(!(t.sheet_id&&t.id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id))return;const n=e._sheets;function s(e){const t=n.length;for(let r=0;r<t;++r)if(n[r]._name===e)return n[r];return n[t]=new yl(e,0),n[t]}const i=Al(t.sheet_id),o=Al(t.id),a=Al(t.beg_auth_seq_id),l=Al(t.end_auth_seq_id),c=Al(t.beg_label_asym_id),h=Al(t.pdbx_beg_PDB_ins_code)||[],u=Al(t.pdbx_end_PDB_ins_code)||[];for(let t=0,n=o.length;t<n;++t){const n=e.getChain(r[c[t]]),o=s(i[t]),d=a[t],p=l[t],m=h[t]||" ",f=u[t]||" ",_=n.findResidue(d,m),g=n.findResidue(p,f);if(!_||!g)continue;const y=new xl(o,_[0],g[0],0,null,null),x=n.getResidues();for(let e=_[1];e<=g[1];++e)x[e]._secondary=y;o.addStrand(y),e.structures.push(y)}}_extractConfs(e,t){const{asymDict:r}=this;if(!(t.conf_type_id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id))return;const n=Al(t.conf_type_id),s=Al(t.beg_auth_seq_id),i=Al(t.pdbx_beg_PDB_ins_code)||[],o=Al(t.end_auth_seq_id),a=Al(t.pdbx_end_PDB_ins_code)||[],l=Al(t.details)||[],c=Al(t.pdbx_PDB_helix_length)||[],h=Al(t.pdbx_PDB_helix_class)||[],u=Al(t.id)||[],d=Al(t.beg_label_asym_id);for(let t=0,p=n.length;t<p;++t){const p=Cl(n[t]);if(!p)continue;const m=u[t]||n[t],f=e.getChain(r[d[t]]),_=s[t],g=o[t],y=i[t]||" ",x=a[t]||" ",b=f.findResidue(_,y),w=f.findResidue(g,x);if(!b||!w)continue;const S=l[t]||"",v=c[t]||0,C=h[t]||" ";let A;if("helix"===p){const t=e._helices.length;A=new gl(C,b[0],w[0],t,m,S,v),e.addHelix(A),e.structures.push(A)}else"turn"===p?(A=new Oe(Oe.Type.TURN,b[0],w[0]),e.structures.push(A)):A=null;if(!A)continue;const E=f.getResidues();for(let e=b[1];e<=w[1];++e)E[e]._secondary=A}}_extractAssemblies(e,t){const{asymDict:n}=this,s=t.pdbx_struct_assembly_gen;if(!s)return;const i=Al(s.assembly_id),o=Al(s.oper_expression),a=Al(s.asym_id_list);if(!i||!o||!a)return;const l=function(e){if(!e)return null;const t=Al(e.id),{matrix:n,vector:s}=e;if(!t||!n||!s)return null;const i=[];for(let e=0,o=t.length;e<o;++e){const o=new r.Matrix4,{elements:a}=o;for(let t=0;t<3;++t){const r=n[t+1];a[t]=Al(r[1])[e],a[t+4]=Al(r[2])[e],a[t+8]=Al(r[3])[e],a[t+12]=Al(s[t+1])[e]}i[t[e]]=o}return i}(t.pdbx_struct_oper_list);if(l)for(let t=0,r=i.length;t<r;++t){const r=new bl(e),s=Rl(o[t],l),i=a[t].split(",");for(let e=0,t=i.length;e<t;++e){const t=i[e].trim();t.length>0&&r.addChain(n[t])}r.matrices=s,e.units.push(r)}}}Ml.formats=["cif","mmcif"],Ml.extensions=[".cif",".mmcif"];const Pl=Ml,Nl=0,Ll=1,Il=2,Ol=3;const Vl=class{_xyz2crs=[];_origin=(()=>new r.Vector3(0,0,0))();constructor(){this._header={},this._boxSize=new r.Vector3,this._boxStart=new r.Vector3,this._header.delta={},this._header.extent=[],this._header.nstart=[],this._header.grid=[],this._header.crs2xyz=[],this._header.cellDims=new r.Vector3,this._header.angles=[],this._header.origin=new r.Vector3(0,0,0),this._header.dmin=0,this._header.dmean=0,this._header.dmax=0}_typedCheck(){if(t().isTypedArray(this._buff))this._buff=this._buff.buffer;else if(!t().isArrayBuffer(this._buff))throw new TypeError("Expected ArrayBuffer or TypedArray")}_fillHeader(e,t){for(const r in e)if(e.hasOwnProperty(r))switch(e[r][0]){case Nl:this._header[r]=t[e[r][1]][e[r][2]];break;case Il:this._parseArray(this._header[r],t[e[r][1]],e[r][2]);break;case Ll:this._parseVector(this._header[r],t[e[r][1]],e[r][2]);break;case Ol:this._header[r]=new Uint8Array(t[e[r][1]],4*[e[r][2]],4*[e[r][3]])}}_parseVector(e,t,r){[e.x,e.y,e.z]=[t[r],t[r+1],t[r+2]]}_parseArray(e,t,r){e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}_parseHeader(e){}_setAxisIndices(){}_setOrigins(){}_getAxis(){const e=this._header,t=e.cellDims.x/e.grid[0],n=e.cellDims.y/e.grid[1],s=e.cellDims.z/e.grid[2],[i,o,a]=e.angles,l=Math.cos(o),c=(Math.cos(i)-Math.cos(o)*Math.cos(a))/Math.sin(a),h=Math.sqrt(1-l*l-c*c);return[new r.Vector3(t,0,0),new r.Vector3(Math.cos(a)*n,Math.sin(a)*n,0),new r.Vector3(l*s,c*s,h*s)]}_getXYZdim(){return[this._header.extent[this._xyz2crs[0]],this._header.extent[this._xyz2crs[1]],this._header.extent[this._xyz2crs[2]]]}_getVolumeInfo(){const e=t().pick(this._header,["dmean","dmin","dmax","sd","delta"]);return e.obtuseAngle=this._header.angles.map((e=>Number(e>=Math.PI/2))),e}_setBoxParams(e,t,n){let s=0,i=0;const[o,a,l]=this._header.angles;l>=Math.PI/2&&(s+=Math.abs(t.x)),a>=Math.PI/2&&(s+=Math.abs(n.x)),o>=Math.PI/2&&(i+=Math.abs(n.y)),this._boxStart=new r.Vector3(this._origin.x-s,this._origin.y-i,this._origin.z),this._boxSize=new r.Vector3(Math.abs(e.x)+Math.abs(t.x)+Math.abs(n.x),Math.abs(t.y)+Math.abs(n.y),Math.abs(n.z));const c=(e,t)=>Math.abs(e[t])/this._boxSize[t];this._header.delta.x=c(t,"x"),this._header.delta.y=c(n,"x"),this._header.delta.z=c(n,"y")}_getXYZbox(){return new r.Box3(this._boxStart.clone(),this._boxStart.clone().add(this._boxSize))}_toXYZData(){}parse(e){return this._parseHeader(e),this._setOrigins(),new Wt(Float32Array,this._getXYZdim(),this._getXYZbox(),1,this._toXYZData(),this._getVolumeInfo())}},Dl={extent:[Il,"u32",0],type:[Nl,"u32",3],nstart:[Il,"i32",4],grid:[Il,"u32",7],cellDims:[Ll,"f32",10],angles:[Il,"f32",13],crs2xyz:[Il,"i32",16],dmin:[Nl,"f32",19],dmax:[Nl,"f32",20],dmean:[Nl,"f32",21],ispg:[Nl,"u32",22],nsymbt:[Nl,"u32",23],lksflg:[Nl,"u32",24],customData:[Ol,"buffer",25,9],origin:[Ll,"f32",34],map:[Ol,"buffer",52,1],machine:[Nl,"u32",53],sd:[Nl,"f32",54],nlabel:[Nl,"f32",55],label:[Ol,"buffer",56,200]};class kl extends Vl{_parseHeader(e){this._buff=e,this._typedCheck();const t={};t.u32=new Uint32Array(this._buff,0,56),t.i32=new Int32Array(this._buff,0,56),t.f32=new Float32Array(this._buff,0,56),t.buffer=this._buff;const r=this._header;this._fillHeader(Dl,t),r.angles.forEach(((e,t,r)=>{r[t]*=Math.PI/180}))}_setAxisIndices(){const e=this._header;0===e.cellDims.x&&0===e.cellDims.y&&0===e.cellDims.z&&e.cellDims.set(1,1,1);const{crs2xyz:t}=this._header;0===t[0]&&0===t[1]&&0===t[2]&&(t[0]=1,t[1]=2,t[2]=3);const r=this._xyz2crs;r[t[0]-1]=0,r[t[1]-1]=1,r[t[2]-1]=2}_setOrigins(){const[e,t,r]=this._getAxis();this._setAxisIndices();const n=this._header,s=this._xyz2crs;if(0===n.origin.x&&0===n.origin.y&&0===n.origin.z?(this._origin.addScaledVector(e,n.nstart[s[0]]),this._origin.addScaledVector(t,n.nstart[s[1]]),this._origin.addScaledVector(r,n.nstart[s[2]])):this._origin=n.origin,e.multiplyScalar(n.extent[s[0]]-1),t.multiplyScalar(n.extent[s[1]]-1),r.multiplyScalar(n.extent[s[2]]-1),2!==n.type)throw new Error(`CCP4: Unsupported format ${n.type}`);this._data=new Float32Array(this._buff,1024+n.nsymbt,n.extent[0]*n.extent[1]*n.extent[2]),this._setBoxParams(e,t,r)}_toXYZData(){const e=this._header,t=this._data,r=this._xyz2crs,n=new Float32Array(t.length),s=this._getXYZdim(),i=s[0],o=s[1];let a=0;const l=[];let c,h,u;for(l[2]=0;l[2]<e.extent[2];l[2]++)for(l[1]=0;l[1]<e.extent[1];l[1]++)for(l[0]=0;l[0]<e.extent[0];l[0]++,a++)c=l[r[0]],h=l[r[1]],u=l[r[2]],n[c+i*(h+o*u)]=t[a];return n}}class zl extends Sa{constructor(e,t){super(e,t),this._options.fileType="ccp4",this.model=new kl}static canProbablyParse(e){return!1}parseSync(){return this.model.parse(this._data)}}zl.formats=["ccp4"],zl.extensions=[".ccp4",".map",".mrc"],zl.binary=!0;const Fl=zl,{Complex:Bl,Element:Ul,Molecule:Gl}=Yt;const jl=class extends Sa{constructor(e,t){super(e,t),this._complex=null,this._atomsInf=null,this._options.fileType="xyz",this._fileName=t.name}static canProbablyParse(e){return t().isString(e)&&/^\s*\d+ *\n[^\n]*\n\s*\w{1,3}\s+-?\d/.test(e)}_parseToAtomsInf(e){const t=e.indexOf("\n"),r=parseInt(e.substring(0,t),10),n=e.indexOf("\n",t+1);let s=e.slice(t+1,n).trim();0===s.length&&(s=this._fileName);const i=n+e.substring(n).search(/\S/);this._atomsInf=e.substring(i).split(/[\s,]*\n[\s,]*/),Number.isNaN(r)||this._atomsInf.length-1===r?(this._complex.metadata.format="xyz",this._complex.name=s):this._complex.error={message:"wrong number of atoms"}}_parseAtomsInf(){const e=this._complex.addChain("A").addResidue("UNK",1," ");for(let t=0;t<this._atomsInf.length-1;t++){const n=this._atomsInf[t].split(/[\s,]+/);if(4!==n.length){this._complex.error={message:"missed parameters"};break}const s=t+1,i=n[0],o=new r.Vector3(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),a=Ul.getByName(i),l=void 0;e.addAtom(i,a,o,l,true,s," ",1,1,0)}const t=new Gl(this._complex,this._complex.name,1);t.residues=e,this._complex._molecules[0]=t}parseSync(){const e=this._complex=new Bl;if(this._parseToAtomsInf(this._data),this._parseAtomsInf(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex=null,this._atomsInf=null,e.error)throw new Error(e.error.message);return e}static formats=["xyz"];static extensions=[".xyz"]},{Complex:Hl,Element:$l}=Yt;class Wl extends Sa{constructor(e,t){super(e,t),this._options.fileType="pubchem+json"}static canProbablyParse(e){return t().isString(e)&&"{"===e[0]}parseSync(){return this.logger.info("Parsing PubChem JSON file..."),this._toComplex(JSON.parse(this._data))}_toComplex(e){const t=new Hl,r=e.PC_Compounds&&e.PC_Compounds[0];return r&&(this._extractAtoms(t,r),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing})),t}_extractAtoms(e,n){let s=n.atoms&&n.atoms.aid,i=s&&n.atoms.element;if(!i||s.length!==i.length)throw new Error("Unable to parse atom elements");i=t().fromPairs(t().zip(s,i));const o={},a=n.coords&&n.coords[0],l=a&&a.conformers&&a.conformers[0],c=l&&l.x,h=l&&l.y,u=l&&l.z||[];if(s=a&&a.aid,!s||!c||!h)throw new Error("Coordinates are not found in the file");const d=e.addChain(" ").addResidue("UNK",1," ");for(let e=0,t=s.length;e<t;++e){const t=s[e],n=$l.ByAtomicNumber[i[t]],a=new r.Vector3(c[e],h[e],u[e]||0);o[t]=d.addAtom(n.name,n,a,void 0,!0,t," ",1,0,0)}const p=n.bonds&&n.bonds.aid1,m=n.bonds&&n.bonds.aid2,f=n.bonds&&n.bonds.order||[];if(p&&m&&p.length===m.length)for(let t=0,r=p.length;t<r;++t)e.addBond(o[p[t]],o[m[t]],f[t]||1,0,!0)}}Wl.formats=["pubchem","pubchem+json","pc"],Wl.extensions=[".json"];const Yl=Wl;class Xl{constructor(e){this._strings=e.split(/\r?\n|\r/),this._currentStart=0,this._currentStringIndx=0}setStart(e){e>=this._strings.length?(this._currentStart=this._strings.length-1,this._currentStringIndx=this._strings.length-1):(this._currentStart=e,this._currentStringIndx=e)}getNextString(){return this._strings[++this._currentStringIndx]}getCurrentString(){return this._strings[this._currentStringIndx]}getStringFromStart(e){return this._currentStringIndx=this._currentStart+e,this._strings[this._currentStart+e]}findNextDataItem(){let e=this.getNextString(),r=!1;for(;!t().isUndefined(e)&&"$$$$"!==e.trim();){if(e.match(/>\s+<(.*)>/)){r=!0;break}e=this.getNextString()}return r}findNextCompoundStart(){let e=this.getCurrentString();for(;!t().isUndefined(e)&&"$$$$"!==e.trim();)e=this.getNextString();return this.setStart(++this._currentStringIndx),this.probablyHaveDataToParse()}probablyHaveDataToParse(){return this._currentStringIndx<this._strings.length-2}}const{Complex:ql,Element:Zl,Bond:Kl,Molecule:Ql}=Yt,Jl=[0,3,2,1,0,-1,-2,-3],ec=[0,1,2,3,1,1,1,2],tc=[Kl.BondType.UNKNOWN,Kl.BondType.COVALENT,Kl.BondType.COVALENT,Kl.BondType.COVALENT,Kl.BondType.AROMATIC,Kl.BondType.UNKNOWN,Kl.BondType.AROMATIC,Kl.BondType.AROMATIC],rc=/.*(M\s\sEND).*|.*(^$$$$).*|.*>\s+<(.+)>.*/,nc=/.*($$$$).*|.*>\s+<(.+)>.*/,sc="sdf",ic="mol",oc=["name","id","title"],ac={name:["PUBCHEM_IUPAC_TRADITIONAL_NAME",/PUBCHEM_(.+)_NAME/,/(.+)name/,/(.+)NAME/],id:["PUBCHEM_COMPOUND_CID","id","ID",/.*CID/,/.*ID/,/.*id/],title:["msg","MSG","message","title","description","desc"]};class lc extends Sa{constructor(e,t){super(e,t),this._format="sdf",this._complex=null,this._chain=null,this._residue=null,this._molecules=null,this._metadata={},this._metadata.molecules=[],this._currentMolProps={},this._compoundIndx=-1,this._assemblies=[],this._atomsParsed=0,this._atomsIndexes=[]}canProbablyParse(e){return t().isString(e)&&rc.test(e)}_parseHeader(e){const t={};t.name=e.getStringFromStart(0);const r=parseInt(e.getStringFromStart(1).substr(10,6).trim(),10);t.date=r.toString()||"",t.title=e.getStringFromStart(2),this._metadata.molecules.push(t)}_parseAtoms(e,t){let n,s=this._atomsParsed;const i=function(e){if(!e)return"A";const t=[];for(;e;)t.push(65+e%26),e=Math.trunc(e/26);return t.length>1&&(t.reverse(),t[0]-=1),String.fromCharCode(...t)}(this._compoundIndx);this._chain=this._complex.getChain(i)||this._complex.addChain(i),this._residue=this._chain.addResidue("UNK",1," ");for(let i=0;i<t;i++){n=e.getNextString(),s++;const t=parseFloat(n.substr(0,10)),i=parseFloat(n.substr(10,10)),o=parseFloat(n.substr(20,10)),a=Jl[parseInt(n.substr(36,3),10)],l=new r.Vector3(t,i,o);let c=n.substr(31,3).trim().toUpperCase();const h=Zl.getByName(c);this._atomsIndexes[c]||(this._atomsIndexes[c]=0),this._atomsIndexes[c]+=1,c+=this._atomsIndexes[c],this._residue.addAtom(c,h,l,void 0,!0,s," ",1,0,a)}}_parseBonds(e,t){let r;for(let n=0;n<t;n++){r=e.getNextString();let t=parseInt(r.substr(0,3),10)+this._atomsParsed,n=parseInt(r.substr(3,3),10)+this._atomsParsed;const s=parseInt(r.substr(6,3),10);t>n&&([t,n]=[n,t]),this._complex.addBond(t,n,ec[s]||1,tc[s]||Kl.BondType.UNKNOWN,!0)}}_parseMOL(e){this._compoundIndx++,this._parseHeader(e);const t=e.getStringFromStart(3),r=parseInt(t.substr(0,3),10),n=parseInt(t.substr(3,3),10);this._parseAtoms(e,r),this._parseBonds(e,n),this._atomsParsed+=r,this._metadata.molecules[this._compoundIndx]._residues=[],this._metadata.molecules[this._compoundIndx]._residues.push(this._residue)}_parseDataItem(e){const t=e.getCurrentString();let r=[],n=e.getNextString();for(;""!==n.trim();)r.push(n),n=e.getNextString();1===r.length&&([r]=r),this._currentMolProps[t.replace(/[<>]/g,"").trim()]=r}_parseCompound(e){if(this._parseMOL(e),this._format===sc){for(this._currentMolProps={};e.findNextDataItem();)this._parseDataItem(e);if(0!==Object.keys(this._currentMolProps).length){const e=this._metadata.molecules[this._compoundIndx];e.props=this._currentMolProps,this._tryToUpdateMoleculeData(e)}}}_fixBondsArray(){const e=this._serialAtomMap,t=this._complex._bonds;for(let r=0;r<t.length;r++){const n=t[r];n._right,n._left,n._left=e[n._left]||null,n._right=e[n._right]||null}}_buildAssemblies(){const e=this._complex._chains;if(1===e.length)return this._assemblies;for(let t=0;t<e.length;t++){const n=new ct(this._complex),s=new r.Matrix4;n.addMatrix(s),n.addChain(e[t]._name),this._assemblies.push(n)}return this._assemblies}_buildMolecules(){this._complex._molecules=[];const{molecules:e}=this._metadata;for(let t=0;t<e.length;t++){const r=new Ql(this._complex,e[t].name,t+1);r.residues=e[t]._residues,this._complex._molecules[t]=r}return this._complex._molecules}_searchTag(e,t){for(let r=0;r<t.length;r++)if(e instanceof RegExp&&e.test(t[r].tag)||e===t[r].tag)return t[r].data}_tryToFind(e,t){for(let r=0;r<e.length;r++){const n=this._searchTag(e[r],t);if(n)return n}}_tryToUpdateMoleculeData(e){let t=!1;for(let r=0;r<oc.length;r++){const n=ac[oc[r]],s=this._tryToFind(n,e.props);s&&(e[oc[r]]=s,t=!0)}return e.name=e.name||e.id,e.name.match(/^\d+$/)&&(e.name=`CID: ${e.name}`),t}_finalizeMetadata(){const{molecules:e}=this._metadata,{metadata:t}=this._complex,r=this._complex;if(1===e.length)r.name=e[0].name,t.title=e[0].title,t.date=e[0].date,t.properties=e[0].props;else if(e.length>1){t.molecules=[];for(let r=0;r<e.length;r++)t.molecules.push({name:e[r].name,date:e[r].date,title:e[r].title,properties:e[r].props})}}_finalize(){const e=this._serialAtomMap={},t=this._complex._atoms;for(let r=0;r<t.length;r++){const n=t[r];e[n.serial]=n}this._complex._finalizeBonds(),this._fixBondsArray(),this._finalizeMetadata(),this._buildAssemblies(),this._complex.units=this._complex.units.concat(this._assemblies),this._buildMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:!1,enableEditing:!1,serialAtomMap:this._serialAtomMap})}defineFormat(e){let t;return t=nc.test(e)?sc:ic,t}parseSync(){const e=this._complex=new ql,t=new Xl(this._data);this._format=this.defineFormat(this._data),e.metadata.format=this._format;do{this._parseCompound(t)}while(t.findNextCompoundStart());return this._finalize(),e}}lc.formats=["mol","sdf"],lc.extensions=[".mol",".sdf"];const cc={nstart:[Il,"i16",0],extent:[Il,"i16",3],grid:[Il,"i16",6],cellDims:[Ll,"i16",9],angles:[Il,"i16",12],div:[Nl,"i16",15],adder:[Nl,"i16",16],scaleFactor:[Nl,"i16",17]};class hc extends Vl{_parseHeader(e){this._buff=e,this._typedCheck();const t={};if(t.i16=new Int16Array(this._buff),100!==t.i16[18])for(let e=0,r=t.i16.length;e<r;++e){const r=t.i16[e];t.i16[e]=(255&r)<<8|r>>8&255}if(100!==t.i16[18])throw new Error("DSN6: Incorrect format ");const r=this._header;this._fillHeader(cc,t),r.cellDims.multiplyScalar(1/r.scaleFactor),r.angles.forEach(((e,t,n)=>{n[t]*=Math.PI/180/r.scaleFactor})),r.div/=100}_setAxisIndices(){this._xyz2crs[0]=0,this._xyz2crs[1]=1,this._xyz2crs[2]=2}_setOrigins(){const e=this._header,[t,r,n]=this._getAxis();this._setAxisIndices(),this._origin.addScaledVector(t,e.nstart[0]),this._origin.addScaledVector(r,e.nstart[1]),this._origin.addScaledVector(n,e.nstart[2]),t.multiplyScalar(e.extent[0]),r.multiplyScalar(e.extent[1]),n.multiplyScalar(e.extent[2]),this._setBoxParams(t,r,n)}_pointCalculate(e,t,r,n,s,i,o){const a=this._header;if(!(s<a.extent[0]&&n<a.extent[1]&&r<a.extent[2]))return i.counter+=8-o,!1;e[s+a.extent[0]*(n+a.extent[1]*r)]=(t[i.counter]-a.adder)/a.div,++i.counter;return!0}_blockCalculate(e,t,r,n,s,i){for(let o=0;o<8;++o){const a=8*r+o;for(let r=0;r<8;++r){const o=8*n+r;let l=!0,c=0;for(;l&&c<8;){const r=8*s+c;l=this._pointCalculate(e,t,a,o,r,i,c),c++}}}}_toXYZData(){const e=this._header,t=new Uint8Array(this._buff),n=new Float32Array(e.extent[0]*e.extent[1]*e.extent[2]),s=new r.Vector3(e.extent[0]/8,e.extent[1]/8,e.extent[2]/8),i={counter:512};for(let e=0;e<s.z;++e)for(let r=0;r<s.y;++r)for(let o=0;o<s.x;++o)this._blockCalculate(n,t,e,r,o,i);return this._calculateInfoParams(n),n}_calculateInfoParams(e){this._header.dmean/=e.length;let t=0,r=e[0],n=e[0];for(let s=0;s<e.length;s++)t+=(this._header.dmean-e[s])**2,e[s]<r&&(r=e[s]),e[s]>n&&(n=e[s]);this._header.sd=Math.sqrt(t/e.length),this._header.dmax=n,this._header.dmin=r}}class uc extends Sa{constructor(e,t){super(e,t),this._options.fileType="dsn6",this.model=new hc}static canParse(e,t){return!!e&&(e instanceof ArrayBuffer&&Sa.checkDataTypeOptions(t,"dsn6"))}static canProbablyParse(e){return!1}parseSync(){return this.model.parse(this._data)}}uc.formats=["dsn6"],uc.extensions=[".dsn6",".omap"],uc.binary=!0;const dc=uc;const pc=class extends Ra{constructor(e){super(e),this._next=-1,this.next()}getNext(){return this._next}},{Complex:mc,Element:fc,Molecule:_c}=Yt;class gc extends Sa{constructor(e,t){super(e,t),this._time=null,this._numAtoms=null,this._residueNumber=null,this._residueName="",this._atomName="",this._atomNumber=null,this._atomPosition=[],this._atomVelocity=[],this._complex=null,this._molecules=[],this._molecule=null,this._options.filetype="gro"}canProbablyParse(e){return t().isString(this._data)&&/^\s*[^\n]*\n\s*\d+ *\n\s*\d+[^\n\d]{3}\s*\w+\s*\d+\s*-?\d/.test(e)}_parseTitle(e){const{metadata:t}=this._complex;t.id=e.readLine().trim(),t.name=t.id.slice(t.id.lastIndexOf("\\")+1,t.id.lastIndexOf(".")),t.format="gro"}_parseNumberOfAtoms(e){if(this._numAtoms=e.readInt(0,e.getNext()),Number.isNaN(this._numAtoms))throw new Error("Line 2 is not representing atom number. Consider checking input file")}_parseAtom(e){this._residueNumber=e.readInt(1,5),this._residueName=e.readString(6,10).trim(),this._atomName=e.readString(11,15).trim(),this._atomNumber=e.readInt(16,20);const t=10*e.readFloat(21,28),n=10*e.readFloat(29,36),s=10*e.readFloat(37,45);if(Number.isNaN(t)||Number.isNaN(n)||Number.isNaN(s))return void(this._complex.error={message:`Atom position is invalid in "${e.readLine()}"`});const i=fc.getByName(this._atomName[0]);if("Unknown"===i.fullName)return void(this._complex.error={message:`${this._atomName[0]} hasn't been recognised as an atom name.`});const o=fc.Role[this._atomName];let a=this._chain;a||(this._chain=a=this._complex.addChain("A"));let l=this._residue;l&&l.getSequence()===this._residueNumber||(this._residue=l=a.addResidue(this._residueName,this._residueNumber," ")),this._atomPosition=new r.Vector3(t,n,s);l.addAtom(this._atomName,i,this._atomPosition,o,!0,this._atomNumber," ",1,1,0)}_finalize(){const e=new _c(this._complex,this._complex.metadata.name,1);e.residues=this._chain._residues,e._chains=this._chain,this._complex._molecules[0]=e,this._molecules.push(e),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}parseSync(){const e=this._complex=new mc,t=new pc(this._data);let r=0;for(this._parseTitle(t),t.next(),this._parseNumberOfAtoms(t),t.next(),r=0;r<this._numAtoms&&!t.end();++r)this._parseAtom(t),t.next();if(r<this._numAtoms&&(this._complex.error={message:"File ended unexpectedly."}),e.error)throw new Error(e.error.message);return this._finalize(),this._atomPosition=null,this._complex=null,this._molecules=null,this._molecule=null,e}}gc.formats=["gro"],gc.extensions=[".gro"];const yc=gc,{Complex:xc,Element:bc,Bond:wc,Molecule:Sc}=Yt,vc={un:0,1:1,2:2,3:3,ar:1,am:1,nc:0,du:1},Cc={un:wc.BondType.UNKNOWN,1:wc.BondType.COVALENT,2:wc.BondType.COVALENT,3:wc.BondType.COVALENT,ar:wc.BondType.AROMATIC,am:wc.BondType.COVALENT,nc:wc.BondType.UNKNOWN,du:wc.BondType.COVALENT},Ac=/\d+$/,Ec=/\s+/;function Tc(e){return e.trim().split(Ec)}class Rc extends Sa{constructor(e,t){super(e,t),this._complex=null,this._chain=null,this._residue=null,this._compoundIndx=-1,this._molecules=[],this._molecule=null,this._currPosIdx=0,this._currStartIdx=0,this._serialAtomMap={},this._options.fileType="mol2"}_parseRawStrings(e){return e.split(/\r?\n|\r/)}_toStringFromStart(e,t){const r=this._currStartIdx+e;this._currPosIdx=r<t.length?r:this._currStartIdx}_toHeaderString(e,t){for(this._toStringFromStart(0,t);this._currPosIdx<t.length;){if(t[this._currPosIdx].match(`@<TRIPOS>${e}`))return;this._currPosIdx++}this._toStringFromStart(0,t)}_toStringFromHeader(e,t,r){this._toHeaderString(e,r);const n=this._currPosIdx+t;r[this._currPosIdx].match(`@<TRIPOS>${e}`)&&n<r.length&&(this._currPosIdx=n)}_setStart(e,t){e>=t.length?this._currStartIdx=this._currPosIdx=t.length-1:this._currStartIdx=this._currPosIdx=e}_probablyHaveDataToParse(e){return this._currPosIdx<e.length-2}_findNextCompoundStart(e){for(;this._currPosIdx<e.length&&"@<TRIPOS>MOLECULE>"!==e[this._currPosIdx].trim();)this._currPosIdx++;return this._setStart(++this._currPosIdx,e),this._probablyHaveDataToParse(e)}_parseMolecule(e){this._toHeaderString("MOLECULE",e);const{metadata:t}=this._complex;t.name=e[++this._currPosIdx],t.format="mol2",this._molecule={_index:"",_chains:[]},this._molecule._index=this._compoundIndx+1,this._molecules.push(this._molecule)}_parseAtoms(e,t){this._toHeaderString("ATOM",t);for(let n=0;n<e;n++){const e=Tc(t[++this._currPosIdx]);if(e.length<6)throw new Error("MOL2 parsing error: Not enough information to create atom!");const n=parseInt(e[0],10),s=e[1],i=parseFloat(e[2]),o=parseFloat(e[3]),a=parseFloat(e[4]),l=e[5].split(".")[0].toUpperCase();let c=0;e.length>=9&&(c=parseFloat(e[8])||0);let h=this._chain;if(h||(this._chain=h=this._complex.getChain("A")||this._complex.addChain("A"),this._residue=null),!this._setResidue(e))continue;const u=!1,d=" ",p=1,m=0,f=bc.getByName(l),_=bc.Role[s],g=new r.Vector3(i,o,a);this._residue.addAtom(s,f,g,_,u,n,d,p,m,c)}}_setResidue(e){let t=1,r="UNK";if(e.length>=7&&(t=parseInt(e[6],10)),e.length>=8&&"<0>"!==e[7]&&(r=e[7].replace(Ac,"")),this.settings.now.nowater&&("HOH"===r||"WAT"===r))return!1;const n=this._residue,s=this._chain;return n&&n.getSequence()===t||(this._residue=s.addResidue(r,t,"A")),!0}_parseBonds(e,t){this._toHeaderString("BOND",t);for(let r=0;r<e;r++){const e=Tc(t[++this._currPosIdx]);if(e.length<3)throw new Error("MOL2 parsing error: Missing information about bonds!");let r=parseInt(e[1],10),n=parseInt(e[2],10);const s=e[3];r>n&&([r,n]=[n,r]),this._complex.addBond(r,n,vc[s]||0,Cc[s]||wc.BondType.UNKNOWN,!0)}}_fixSerialAtoms(){const e=this._complex._atoms;for(let t=0;t<e.length;t++){const r=e[t];this._serialAtomMap[r.serial]=r}}_fixBondsArray(){const e=this._serialAtomMap,t=this._complex;if(0===Object.keys(e).length)throw new Error("MOL2 parsing error: Missing atom information!");const r=t._bonds;for(let t=0;t<r.length;t++){const n=r[t];n._left=e[n._left]||null,n._right=e[n._right]||null}}_finalizeMolecules(){const e=this._complex._chains[0];this._complex._molecules=[];for(let t=0;t<this._molecules.length;t++){const r=this._molecules[t],n=e._residues,s=new Sc(this._complex,r._name,t+1);s.residues=n,this._complex._molecules[t]=s}}_finalize(){this._complex._finalizeBonds(),this._fixSerialAtoms(),this._fixBondsArray(),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}_parseCompound(e){this._compoundIndx++,this._parseMolecule(e),this._toStringFromHeader("MOLECULE",2,e);const t=e[this._currPosIdx].trim().split(Ec),r=t[0],n=t[1];this._parseAtoms(r,e),this._parseBonds(n,e)}parseSync(){const e=this._complex=new xc,t=this._parseRawStrings(this._data);do{this._parseCompound(t)}while(this._findNextCompoundStart(t));return this._finalize(),e}}Rc.formats=["mol2"],Rc.extensions=[".mol2",".ml2",".sy2"];const Mc=new wa([Fa,Pl,hl,jl,Ya,Yl,lc,Fl,dc,yc,Rc]);const Pc=class extends hr{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],["formats"])}find(e){let t=[];return e.format&&(t=this._dict.formats[e.format.toLowerCase()]||[]),[...t]}};class Nc{constructor(e,t){this._source=e,this._options=t||{},this._abort=!1}exportSync(){throw new Error("Exporting to this source is not implemented")}export(){return new Promise(((e,t)=>{setTimeout((()=>{try{return this._abort?t(new Error("Export aborted")):e(this.exportSync())}catch(e){return t(e)}}))}))}abort(){this._abort=!0}}ur(Nc.prototype);class Lc{constructor(){this._resultArray=[],this._currentStr=-1,this._tag=null,this._fixedNumeration=!1,this._numeration=!1,this._tagStrNum=0}getResult(){return this.writeString("\n",81,81),this._resultArray.join("")}_currentStrLength(){const e=this._resultArray[this._currentStr];return e?e.length:0}newTag(e,r){this._tag=e||null,t().isUndefined(r)?(this._numeration=!1,this._fixedNumeration=!1,this._tagStrNum=0):t().isNumber(r)?(this._tagStrNum=r,this._numeration=!0,this._fixedNumeration=!0):t().isBoolean(r)&&(this._tagStrNum=0,this._numeration=r,this._fixedNumeration=!1)}newString(e){this.writeString("\n",81,81),this._currentStr++,this._resultArray.push(""),e?this.writeString(e,1,6):this._tag&&this.writeString(this._tag,1,6),this._numeration&&(this._fixedNumeration||this._tagStrNum++,1!==this._tagStrNum&&this.writeString(this._tagStrNum.toString(),10,8))}writeEntireString(e,t,r){t||(t=81);for(let n=0;n<e.length;n++)this._currentStrLength()===t&&n!==e.length-1&&(this.newString(),r&&this.writeString(r.tag,r.begin,r.end)),"\n"===e[n]?this.newString():this.writeString(e[n])}writeString(e,r,n){let s,i=this._resultArray[this._currentStr];const o=i?i.length:0;if(t().isUndefined(e))return;t().isNumber(r)||(r=o+1),t().isNumber(n)||(n=o+e.length),s=t().isString(e)?e:e.toString();const a=r<n?n:r,l=r<n?r:n;if(s.length>Math.abs(r-n)+1&&(s=s.substr(0,Math.abs(r-n+1))),l>o+1)this._resultArray[this._currentStr]+=" ".repeat(l-o-1);else if(l<=o){const e=this._resultArray[this._currentStr];this._resultArray[this._currentStr]=e.slice(0,l-1)}if(n<r){s=" ".repeat(r-n+1-s.length)+s}11===l&&this._numeration&&1!==this._tagStrNum&&(s=` ${s}`),this._resultArray[this._currentStr]+=s,i=this._resultArray[this._currentStr],a>i.length&&(this._resultArray[this._currentStr]+=" ".repeat(a-i.length))}writeBondsArray(e,t){const r=this._getSubArrays(e,4);for(let e=0;e<r.length;e++){this.newString(),this.writeString(t.serial,11,7);for(let n=0;n<r[e].length;n++){const s=r[e][n]._left.serial===t.serial?r[e][n]._right.serial:r[e][n]._left.serial;this.writeString(s,16+5*n,12+5*n)}}}_getSubArrays(e,t){const r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}writeMatrix(e,t,r){for(let n=0;n<3;n++){this.newString(),this.writeString(r,14,18),this.writeString((n+1).toString(),19,19),this.writeString(t.toString(),23,20);for(let t=0;t<3;t++){const r=parseFloat(e.elements[4*n+t]).toFixed(6);this.writeString(r.toString(),33+10*t,24+10*t)}const s=parseFloat(e.elements[4*n+3]).toFixed(5);this.writeString(s.toString(),68,55)}}writeMatrices(e,t){if(!e)return;const n=new r.Matrix4;for(let r=0;r<e.length;r++)n.copy(e[r]).transpose(),this.writeMatrix(n,r+1,t)}}class Ic extends Nc{constructor(e,t){super(e,t),this._tags=["HEADER","TITLE","COMPND","REMARK","HELIX","SHEET","ATOM and HETATM","CONECT"],this._result=null,this._tagExtractors={HEADER:this._extractHEADER,TITLE:this._extractTITLE,"ATOM and HETATM":this._extractATOM,CONECT:this._extractCONECT,COMPND:this._extractCOMPND,REMARK:this._extractREMARK,HELIX:this._extractHELIX,SHEET:this._extractSHEET},this._stringForRemark350="COORDINATES FOR A COMPLETE MULTIMER REPRESENTING THE KNOWN\nBIOLOGICALLY SIGNIFICANT OLIGOMERIZATION STATE OF THE\nMOLECULE CAN BE GENERATED BY APPLYING BIOMT TRANSFORMATIONS\nGIVEN BELOW.  BOTH NON-CRYSTALLOGRAPHIC AND\nCRYSTALLOGRAPHIC OPERATIONS ARE GIVEN.",this._stringForRemark290="CRYSTALLOGRAPHIC SYMMETRY TRANSFORMATIONS\nTHE FOLLOWING TRANSFORMATIONS OPERATE ON THE ATOM/HETATM\nRECORDS IN THIS ENTRY TO PRODUCE CRYSTALLOGRAPHICALLY\nRELATED MOLECULES."}exportSync(){const e=new Lc;if(!this._source)return this._result;for(let r=0;r<this._tags.length;r++){const n=this._tags[r],s=this._tagExtractors[n];t().isFunction(s)&&s.call(this,e)}return this._result=e.getResult(),this._result}_extractHEADER(e){if(!this._source.metadata)return;const{metadata:t}=this._source;e.newTag("HEADER"),e.newString(),t.classification&&e.writeString(t.classification,11,50),t.date&&e.writeString(t.date,51,59),t.id&&e.writeString(t.id,63,66)}_extractTITLE(e){if(!this._source.metadata)return;const{metadata:t}=this._source;if(t.title){e.newTag("TITLE",!0);for(let r=0;r<t.title.length;r++)e.newString(),e.writeString(t.title[r],11,80)}}_extractCONECT(e){if(!this._source._atoms)return;const t=this._source._atoms;e.newTag("CONECT");for(let r=0;r<t.length;r++){const n=t[r].bonds.filter((e=>e._fixed));0!==n.length&&e.writeBondsArray(n.reverse(),t[r])}}_extractSHEET(e){if(!this._source._sheets)return;e.newTag("SHEET");const t=this._source._sheets;for(let r=0;r<t.length;r++)if(t[r]._strands){const n=t[r]._strands;for(let s=0;s<n.length;s++)e.newString(),e.writeString(s+1,10,8),e.writeString(t[r]._name,14,12),e.writeString(n.length,16,15),e.writeString(n[s].init._type._name,18,20),e.writeString(n[s].init._chain._name,22,22),e.writeString(n[s].init._sequence,26,23),e.writeString(n[s].init._icode,27,27),e.writeString(n[s].term._type._name,29,31),e.writeString(n[s].init._chain._name,33,33),e.writeString(n[s].term._sequence,37,34),e.writeString(n[s].term._icode,38,38),e.writeString(n[s].sense,40,39)}}_extractHELIX(e){if(!this._source._helices)return;e.newTag("HELIX");const r=this._source._helices;for(let n=0;n<r.length;n++){const s=r[n],i=t().invert(De);e.newString(),e.writeString(s.serial,10,8),e.writeString(s.name,14,12),e.writeString(s.init._type._name,16,18),e.writeString(s.init._chain._name,20,20),e.writeString(s.init._sequence,25,22),e.writeString(s.init._icode,26,26),e.writeString(s.term._type._name,28,30),e.writeString(s.term._chain._name,32,32),e.writeString(s.term._sequence,37,34),e.writeString(s.term._icode,38,38),e.writeString(i[s.type],40,39),e.writeString(s.comment,41,70),e.writeString(s.length,76,72)}}_extractATOM(e){if(!this._source._atoms)return;const t=this._source._atoms;for(let r=0;r<t.length;r++){const n=t[r].het?"HETATM":"ATOM";e.newString(n);const s=t[r].element.name.length>1||t[r].name.length>3?13:14;e.writeString(t[r].serial,11,7),e.writeString(t[r].name,s,16),e.writeString(String.fromCharCode(t[r].location),17,17),e.writeString(t[r].residue._type._name,20,18),e.writeString(t[r].residue._chain._name,22,22),e.writeString(t[r].residue._sequence,26,23),e.writeString(t[r].residue._icode,27,27),e.writeString(t[r].position.x.toFixed(3),38,31),e.writeString(t[r].position.y.toFixed(3),46,39),e.writeString(t[r].position.z.toFixed(3),54,47),e.writeString(t[r].occupancy.toFixed(2),60,55),e.writeString(t[r].temperature.toFixed(2),66,61),e.writeString(t[r].element.name,78,77),t[r].charge&&e.writeString(t[r].charge,79,80)}}_extractCOMPND(e){if(!this._source._molecules)return;const t=this._source._molecules;e.newTag("COMPND",!0);for(let r=0;r<t.length;r++){const n=this._getMoleculeChains(t[r]);e.newString(),e.writeString(`MOL_ID: ${t[r].index};`,11,80),e.newString(),e.writeString(`MOLECULE: ${t[r].name};`,11,80),e.newString(),e.writeString("CHAIN: ",11,18);const s=`${n.join(", ")};`;e.writeEntireString(s,81)}}_extractREMARK(e){this._Remark290(e),this._Remark350(e)}_Remark290(e){if(this._source.symmetry&&0!==this._source.symmetry.length){const t=this._source.symmetry;e.newTag("REMARK",290),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark290),e.writeMatrices(t,"SMTRY"),e.newString(),e.newString(),e.writeString("REMARK: NULL",11,80)}}_Remark350(e){if(!this._source.units)return;const{units:t}=this._source;let r=0;e.newTag("REMARK",350),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark350);const n=t.filter((e=>e instanceof ct));for(let t=0;t<n.length;t++){e.newString(),e.newString(),r++,e.writeString(`BIOMOLECULE: ${r}`,11,80);const s=n[t].chains.join(", ");e.newString(),e.writeString("APPLY THE FOLLOWING TO CHAINS: "),e.writeEntireString(s,69,{tag:"AND CHAINS: ",begin:31,end:42});const{matrices:i}=n[t];e.writeMatrices(i,"BIOMT")}}_getMoleculeChains(e){const t=e.residues.map((function(e){return e._chain._name}));return t.filter(((e,r)=>t.indexOf(e)===r))}}Ic.formats=["pdb"],Ic.SourceClass=jt;function Oc(e,t,r,n){r[n]=e[t],r[n+1]=e[t+1],r[n+2]=e[t+2]}function Vc(e,t,r,n,s){r[n]=e[t],r[n+1]=e[t+1],r[n+2]=e[t+2],r[n+3]=s}const Dc=new r.Vector4;function kc(e,t,r,n,s){Dc.set(e[t],e[t+1],e[t+2],s.w),Dc.applyMatrix4(s.matrix),r[n]=Dc.x,r[n+1]=Dc.y,r[n+2]=Dc.z}function zc(e,t,r,n,s){if(!((t.array.length-t.start)/t.stride<r||(e.array.length-e.start)/e.stride<r))if(e.stride===t.stride)t.array.set(e.array,t.start);else{let i=t.start,o=e.start;for(let a=0;a<r;++a,i+=t.stride,o+=e.stride)n(e.array,o,t.array,i,s)}}class Fc{constructor(){this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.lastPos=0,this.lastNorm=0,this.lastCol=0,this.lastIdx=0}init(e,t){this.positions=new Float32Array(3*e),this.normals=new Float32Array(3*e),this.colors=new Float32Array(4*e),this.indices=new Int32Array(t)}setPositions(e,t,r,n){zc({array:e,start:t,stride:n},{array:this.positions,start:this.lastPos,stride:3},r,Oc),this.lastPos+=3*r}setTransformedPositions(e,t,r,n,s){let i=this.lastPos,o=t;const a={matrix:s,w:1};for(let t=0;t<r;++t,o+=n,i+=3)kc(e,o,this.positions,i,a);this.lastPos+=3*r}setNormals(e,t,r,n){zc({array:e,start:t,stride:n},{array:this.normals,start:this.lastNorm,stride:3},r,Oc),this.lastNorm+=3*r}setTransformedNormals(e,t,r,n,s){let i=this.lastNorm,o=t;const a={matrix:s,w:0};for(let t=0;t<r;++t,o+=n,i+=3)kc(e,o,this.normals,i,a);this.lastNorm+=3*r}setColors(e,t,r,n){zc({array:e,start:t,stride:n},{array:this.colors,start:this.lastCol,stride:4},r,Vc,1),this.lastCol+=4*r}setIndices(e,t,r){this.indices.set(e,this.lastIdx),this.lastIdx+=r}setShiftedIndices(e,t,r){const n=e.map((e=>e+r));this.setIndices(n,0,t)}getVerticesNumber(){return this.lastPos/3}addInstance(e,t){const r=this.getVerticesNumber();this.setShiftedIndices(t.indices,t.indices.length,r);const n=t.itemSize;this.setTransformedPositions(t.positions,0,t.vertsCount,n.position,e),this.setTransformedNormals(t.normals,0,t.vertsCount,n.normal,e),this.setColors(t.colors,0,t.vertsCount,n.color)}}class Bc{constructor(){this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.vertsCount=0,this.itemSize=null}init(e,t){const{attributes:r}=e;this.itemSize={position:r.position.itemSize,normal:r.normal.itemSize,color:r.color.itemSize}}}class Uc extends Bc{init(e,t){super.init(e,t);const{attributes:{position:r,normal:n},index:s}=e;this.vertsCount=r.count,this.positions=r.array,this.normals=n.array,this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this.indices=s.array}setColors(e){let t=0;for(let r=0,n=this.colors.length,s=this.itemSize.color;r<n;r+=s)this.colors[t++]=e.r,this.colors[t++]=e.g,this.colors[t++]=e.b}}class Gc extends Bc{constructor(){super(),this._cutRawStart=0,this._cutRawEnd=0,this._facesPerSlice=0}init(e,t){super.init(e,t);const{attributes:{position:r},index:n}=e;this.vertsCount=r.count+t.addPerCylinder,this._facesPerSlice=t.addPerCylinder,this.positions=new Float32Array(this.vertsCount*r.itemSize),this.normals=new Float32Array(this.vertsCount*this.itemSize.normal),this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this._extendVertices(e,t),this.indices=new Uint32Array(n.count),this._extendIndices(e,t)}_extendVertices(e,t){const{position:r}=e.attributes,{normal:n}=e.attributes,s=e.getGeoParams();this._cutRawStart=1*s.radialSegments,this._cutRawEnd=this._cutRawStart+t.addPerCylinder;{let e=r.array.slice(0,this._cutRawEnd*r.itemSize);this.positions.set(e,0),e=n.array.slice(0,this._cutRawEnd*n.itemSize),this.normals.set(e,0)}{let e=r.array.slice(this._cutRawStart*r.itemSize,r.array.length);this.positions.set(e,this._cutRawEnd*r.itemSize),e=n.array.slice(this._cutRawStart*n.itemSize,n.array.length),this.normals.set(e,this._cutRawEnd*n.itemSize)}}_extendIndices(e,t){const{index:r}=e,n=6*t.addPerCylinder,s=t.addPerCylinder;let i=r.array.slice(n,r.count);i=i.map((e=>e+s)),this.indices.set(r.array,0),this.indices.set(i,n)}_setColorRange(e,t,r,n){const s=n.length;for(let i=e;i<t;i+=s)r.set(n,i)}setColors(e,t){const r=this.itemSize.color,n=this._cutRawEnd*r,s=2*n;if(this._setColorRange(0,n,this.colors,e.toArray()),this._setColorRange(n,s,this.colors,t.toArray()),s<this.colors.length){const n=(this._facesPerSlice+1)*r,i=s+n;this._setColorRange(s,i,this.colors,t.toArray());const o=i+n;this._setColorRange(i,o,this.colors,e.toArray())}}}class jc{constructor(){this._materials=[],this._models=[]}process(e){this._extractModelsAndMaterials(e);const t=this._flattenModels();return{name:e.name,models:t,materials:this._materials}}_extractModelsAndMaterials(e){const t=new r.Layers;t.set(sr.LAYERS.DEFAULT),t.enable(sr.LAYERS.TRANSPARENT),e.traverse((e=>{e instanceof r.Mesh&&e.layers.test(t)&&this.checkExportAbility(e)&&("InstancedBufferGeometry"===e.geometry.type?this._collectInstancedGeoInfo(e):this._collectGeoInfo(e))}))}_reworkIndices(e){for(let t=2;t<e.length;t+=3)e[t]*=-1,e[t]--}_flattenModels(){let e=0;function t(t){return t+e}const r=[];for(let n=0,s=this._models.length;n<s;n++){const s=this._models[n];let i=[],o=[],a=[],l=[];e=0;for(let r=0;r<s.length;r++){const n=s[r];i.push(n.indices.map(t)),e+=n.getVerticesNumber(),o.push(n.positions),a.push(n.normals),l.push(n.colors)}i=O.mergeTypedArraysUnsafe(i),this._reworkIndices(i),o=O.mergeTypedArraysUnsafe(o),a=O.mergeTypedArraysUnsafe(a),l=O.mergeTypedArraysUnsafe(l),r.push({indices:i,positions:o,normals:a,colors:l,verticesCount:e})}return r}checkExportAbility(e){return 0!==e.geometry.attributes.position.count&&(e instanceof rs?(w.warn("Currently we cannot export 'sprites' modes, like BS, WV, LC. Please turn of settings 'zSprites' and try again"),!1):!(e instanceof ds)||(w.warn("Currently we cannot export Lines mode"),!1))}_collectGeoInfo(e){const{geometry:{attributes:{position:t,color:r,normal:n},index:s},matrix:i}=e,o=new Fc,a=t.count;o.init(a,s.count),i.isIdentity()?(o.setPositions(t.array,0,a,t.itemSize),o.setNormals(n.array,0,a,n.itemSize)):(o.setTransformedPositions(t.array,0,a,t.itemSize,i),o.setTransformedNormals(n.array,0,a,n.itemSize,i)),o.setColors(r.array,0,a,r.itemSize),o.setIndices(s.array,0,s.count);const l=this._collectMaterialInfo(e);this._addToPool(o,l)}_collectSpheresInfo(e){const{geometry:{attributes:{position:t,color:n},index:s},matrix:i}=e,o=new Fc,a=e.geometry.instanceCount,l=t.count,c=s.count;o.init(a*l,a*c);const h=new Uc;h.init(e.geometry);const u=new r.Matrix4,d=new r.Matrix4,p=new r.Color;for(let t=0;t<a;++t){const r=t*n.itemSize;p.fromArray(n.array,r),h.setColors(p),this._getSphereInstanceMatrix(e.geometry,t,u),d.multiplyMatrices(i,u),o.addInstance(d,h)}const m=this._collectMaterialInfo(e);this._addToPool(o,m)}_collectCylindersInfo(e){const{geometry:{attributes:{position:t,color:n,color2:s},index:i},matrix:o}=e,a=new Fc,l=e.geometry.instanceCount,c=new Uc;c.init(e.geometry);const h=this._gatherCylindersColoringInfo(e.geometry);let u=null;h.needToSplit>0&&(u=new Gc,u.init(e.geometry,h));const d=h.addPerCylinder*h.needToSplit,p=t.count,m=i.count;a.init(l*p+d,l*m);const f=new r.Matrix4,_=new r.Matrix4,g=new r.Color,y=new r.Color;let x={};for(let t=0;t<l;++t){const r=t*n.itemSize;h.is2Colored[t]?(g.fromArray(s.array,r),y.fromArray(n.array,r),u&&(u.setColors(g,y),x=u)):(g.fromArray(n.array,r),c.setColors(g),x=c),this._getCylinderInstanceMatrix(e.geometry,t,f),_.multiplyMatrices(o,f),a.addInstance(_,x)}const b=this._collectMaterialInfo(e);this._addToPool(a,b)}_addToPool(e,t){const r=this._checkExistingMaterial(t);if(r<0)this._models.push([e]),this._materials.push(t);else{this._models[r].push(e)}}_checkExistingMaterial(e){return t().findIndex(this._materials,(r=>t().isEqual(r,e)))}_gatherCylindersColoringInfo(e){const t=e.instanceCount,r=e.attributes.color.array,n=e.attributes.color2.array,s=e.attributes.color.itemSize,i=new Array(t);let o=0,a=0;for(let e=0;e<t;e++,a+=s){const t=Math.abs(r[a]-n[a])>1e-7||Math.abs(r[a+1]-n[a+1])>1e-7||Math.abs(r[a+2]-n[a+2])>1e-7;i[e]=t,o+=t}return{is2Colored:i,needToSplit:o,addPerCylinder:e.getGeoParams().radialSegments}}_collectInstancedGeoInfo(e){e.geometry instanceof gr?this._collectSpheresInfo(e):e.geometry instanceof Dr&&this._collectCylindersInfo(e)}_collectMaterialInfo(e){const{uberOptions:t}=e.material;return{diffuse:t.diffuse.toArray(),opacity:t.opacity,shininess:t.shininess,specular:t.specular.toArray()}}_getCylinderInstanceMatrix(e,t,r){const n=e.attributes.matVector1.array,s=e.attributes.matVector2.array,i=e.attributes.matVector3.array,o=4*t;r.set(n[o],n[o+1],n[o+2],n[o+3],s[o],s[o+1],s[o+2],s[o+3],i[o],i[o+1],i[o+2],i[o+3],0,0,0,1)}_getSphereInstanceMatrix(e,t,r){const{offset:n}=e.attributes,s=t*n.itemSize,i=n.array[s],o=n.array[s+1],a=n.array[s+2],l=n.array[s+3];r.set(l,0,0,i,0,l,0,o,0,0,l,a,0,0,0,1)}}class Hc{constructor(){this._resultArray=[],this._info=null}getResult(e){return this._info=e,this._resultArray.push(this._writeHeader()),this._resultArray.push(this._writeDefinitions()),this._resultArray.push(this._writeObjects(e.models,e.materials)),this._resultArray.push(this._writeRelations()),this._resultArray.push(this._writeConnections()),this._info=null,this._resultArray.join("")}_writeHeader(){const e=new Date,t=`Miew FBX Exporter v${this._info.version}`;return`; FBX 6.1.0 project file\n; Created by ${t} Copyright (c) 2015-2024 EPAM Systems, Inc.\n; For support please contact miew@epam.com\n; ----------------------------------------------------\n\nFBXHeaderExtension:  {\n  FBXHeaderVersion: 1003\n  FBXVersion: 6100\n  CreationTimeStamp:  {\n    Version: 1000\n    Year: ${e.getFullYear()}\n    Month: ${e.getMonth()+1}\n    Day: ${e.getDate()}\n    Hour: ${e.getHours()}\n    Minute: ${e.getMinutes()}\n    Second: ${e.getSeconds()}\n    Millisecond: ${e.getMilliseconds()}\n  }\n  Creator: "${t}"\n  OtherFlags:  {\n    FlagPLE: 0\n  }\n}\nCreationTime: "${e}"\nCreator: "${t}"\n`}_writeDefinitions(){return'\n; Object definitions\n;------------------------------------------------------------------\n\n\nDefinitions:  {\n  Version: 100\n  Count: 3\n  ObjectType: "Model" {\n    Count: 1\n  }\n  ObjectType: "Geometry" {\n    Count: 1\n  }\n  ObjectType: "Material" {\n    Count: 1\n  }\n  ObjectType: "Pose" {\n    Count: 1\n  }\n  ObjectType: "GlobalSettings" {\n    Count: 1\n  }\n} \n'}_models(){let e="";const{models:t}=this._info;for(let r=0;r<t.length;++r){const n=t[r],s=n.verticesCount;e+=`\n  Model: "Model::${this._info.name}_${r}", "Mesh" {\n    Version: 232\n    Properties60: {\n      Property: "QuaternionInterpolate", "bool", "",0\n      Property: "Visibility", "Visibility", "A",1\n      Property: "Lcl Translation", "Lcl Translation", "A",0.000000000000000,0.000000000000000,-1789.238037109375000\n      Property: "Lcl Rotation", "Lcl Rotation", "A",0.000009334667643,-0.000000000000000,0.000000000000000\n      Property: "Lcl Scaling", "Lcl Scaling", "A",1.000000000000000,1.000000000000000,1.000000000000000\n      Property: "RotationOffset", "Vector3D", "",0,0,0\n      Property: "RotationPivot", "Vector3D", "",0,0,0\n      Property: "ScalingOffset", "Vector3D", "",0,0,0\n      Property: "ScalingPivot", "Vector3D", "",0,0,0\n      Property: "TranslationActive", "bool", "",0\n      Property: "TranslationMin", "Vector3D", "",0,0,0\n      Property: "TranslationMax", "Vector3D", "",0,0,0\n      Property: "TranslationMinX", "bool", "",0\n      Property: "TranslationMinY", "bool", "",0\n      Property: "TranslationMinZ", "bool", "",0\n      Property: "TranslationMaxX", "bool", "",0\n      Property: "TranslationMaxY", "bool", "",0\n      Property: "TranslationMaxZ", "bool", "",0\n      Property: "RotationOrder", "enum", "",0\n      Property: "RotationSpaceForLimitOnly", "bool", "",0\n      Property: "AxisLen", "double", "",10\n      Property: "PreRotation", "Vector3D", "",0,0,0\n      Property: "PostRotation", "Vector3D", "",0,0,0\n      Property: "RotationActive", "bool", "",0\n      Property: "RotationMin", "Vector3D", "",0,0,0\n      Property: "RotationMax", "Vector3D", "",0,0,0\n      Property: "RotationMinX", "bool", "",0\n      Property: "RotationMinY", "bool", "",0\n      Property: "RotationMinZ", "bool", "",0\n      Property: "RotationMaxX", "bool", "",0\n      Property: "RotationMaxY", "bool", "",0\n      Property: "RotationMaxZ", "bool", "",0\n      Property: "RotationStiffnessX", "double", "",0\n      Property: "RotationStiffnessY", "double", "",0\n      Property: "RotationStiffnessZ", "double", "",0\n      Property: "MinDampRangeX", "double", "",0\n      Property: "MinDampRangeY", "double", "",0\n      Property: "MinDampRangeZ", "double", "",0\n      Property: "MaxDampRangeX", "double", "",0\n      Property: "MaxDampRangeY", "double", "",0\n      Property: "MaxDampRangeZ", "double", "",0\n      Property: "MinDampStrengthX", "double", "",0\n      Property: "MinDampStrengthY", "double", "",0\n      Property: "MinDampStrengthZ", "double", "",0\n      Property: "MaxDampStrengthX", "double", "",0\n      Property: "MaxDampStrengthY", "double", "",0\n      Property: "MaxDampStrengthZ", "double", "",0\n      Property: "PreferedAngleX", "double", "",0\n      Property: "PreferedAngleY", "double", "",0\n      Property: "PreferedAngleZ", "double", "",0\n      Property: "InheritType", "enum", "",0\n      Property: "ScalingActive", "bool", "",0\n      Property: "ScalingMin", "Vector3D", "",1,1,1\n      Property: "ScalingMax", "Vector3D", "",1,1,1\n      Property: "ScalingMinX", "bool", "",0\n      Property: "ScalingMinY", "bool", "",0\n      Property: "ScalingMinZ", "bool", "",0\n      Property: "ScalingMaxX", "bool", "",0\n      Property: "ScalingMaxY", "bool", "",0\n      Property: "ScalingMaxZ", "bool", "",0\n      Property: "GeometricTranslation", "Vector3D", "",0,0,0\n      Property: "GeometricRotation", "Vector3D", "",0,0,0\n      Property: "GeometricScaling", "Vector3D", "",1,1,1\n      Property: "LookAtProperty", "object", ""\n      Property: "UpVectorProperty", "object", ""\n      Property: "Show", "bool", "",1\n      Property: "NegativePercentShapeSupport", "bool", "",1\n      Property: "DefaultAttributeIndex", "int", "",0\n      Property: "Color", "Color", "A+",0,0,0\n      Property: "Size", "double", "",100\n      Property: "Look", "enum", "",1\n    }\n    ${this._verticesIndices(n.positions,n.indices)}\n    ${this._normalLayer(n.normals)}\n    ${this._colorLayer(n.colors,s)}\n    \n    LayerElementMaterial: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "AllSame"\n      ReferenceInformationType: "Direct"\n      Materials: 0\n    }\n    \n    Layer: 0 {\n      Version: 100\n      LayerElement:  {\n        Type: "LayerElementNormal"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementColor"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementMaterial"\n        TypedIndex: 0\n      }\n    }\n  }`}return e}_materials(){let e="";const{materials:t}=this._info;for(let r=0;r<t.length;++r){const n=t[r];e+=`\n  Material: "Material::${this._info.name}_${r}_default", "" {\n    Version: 102\n    ShadingModel: "lambert"\n    MultiLayer: 0\n    ${this._materialProperties(n)}\n  }`}return e}_writeObjects(){return`\n; Object properties\n;------------------------------------------------------------------\n\nObjects:  {\n  ${this._models()}\n  ${this._materials()}\n  GlobalSettings: {\n    Version: 1000\n    Properties60:  {\n      Property: "UpAxis", "int", "",1\n      Property: "UpAxisSign", "int", "",1\n      Property: "FrontAxis", "int", "",2\n      Property: "FrontAxisSign", "int", "",1\n      Property: "CoordAxis", "int", "",0\n      Property: "CoordAxisSign", "int", "",1\n      Property: "UnitScaleFactor", "double", "",1\n    }\n  }\n}\n`}_writeRelations(){let e="";for(let t=0;t<this._info.models.length;++t)e+=`\n  Model: "Model::${this._info.name}_${t}", "Mesh" {\n  }`;let t="";for(let e=0;e<this._info.materials.length;++e)t+=`\n  Material: "Material::${this._info.name}_${e}_default", "" {\n  }`;return`\n; Object relations\n;------------------------------------------------------------------\n\nRelations:  {\n  ${e}\n  Model: "Model::Producer Perspective", "Camera" {\n  }\n  Model: "Model::Producer Top", "Camera" {\n  }\n  Model: "Model::Producer Bottom", "Camera" {\n  }\n  Model: "Model::Producer Front", "Camera" {\n  }\n  Model: "Model::Producer Back", "Camera" {\n  }\n  Model: "Model::Producer Right", "Camera" {\n  }\n  Model: "Model::Producer Left", "Camera" {\n  }\n  Model: "Model::Camera Switcher", "CameraSwitcher" {\n  }\n  ${t}\n}`}_writeConnections(){let e="";const{name:t}=this._info;for(let r=0;r<this._info.models.length;++r)e+=`\n  Connect: "OO", "Model::${t}_${r}", "Model::Scene"`;let r="";for(let e=0;e<this._info.materials.length;++e)r+=`\n  Connect: "OO", "Material::${t}_${e}_default", "Model::${t}_${e}"`;return`\n; Object connections\n;------------------------------------------------------------------\n\nConnections:  {\n  ${e}\n  ${r}\n}`}_floatArrayToString(e){const t=[];for(let r=0;r<e.length;++r)t[r]=e[r].toFixed(6);return t.join(",")}_colorLayer(e,t){return`\n    LayerElementColor: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct"\n      Colors: ${this._floatArrayToString(e)}\n      ColorIndex: ${[...Array(t).keys()]}\n    }`}_normalLayer(e){return`\n    LayerElementNormal: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct"\n      Normals: ${this._floatArrayToString(e)}\n    }`}_verticesIndices(e,t){return`MultiLayer: 0\n    MultiTake: 1\n    Shading: Y\n    Culling: "CullingOff"\n    Vertices: ${this._floatArrayToString(e)}\n    PolygonVertexIndex: ${t}\n    GeometryVersion: 124`}_materialProperties(e){return`Properties60:  {\n      Property: "ShadingModel", "KString", "", "Lambert"\n      Property: "MultiLayer", "bool", "",0\n      Property: "EmissiveColor", "ColorRGB", "",0,0,0\n      Property: "EmissiveFactor", "double", "",0.0000\n      Property: "AmbientColor", "ColorRGB", "",1,1,1\n      Property: "AmbientFactor", "double", "",0.0000\n      Property: "DiffuseColor", "ColorRGB", "",${e.diffuse}\n      Property: "DiffuseFactor", "double", "",1.0000\n      Property: "Bump", "Vector3D", "",0,0,0\n      Property: "TransparentColor", "ColorRGB", "",1,1,1\n      Property: "TransparencyFactor", "double", "",0.0000\n      Property: "SpecularColor", "ColorRGB", "",${e.specular}\n      Property: "SpecularFactor", "double", "",1.0000\n      Property: "ShininessExponent", "double", "",${e.shininess}\n      Property: "ReflectionColor", "ColorRGB", "",0,0,0\n      Property: "ReflectionFactor", "double", "",1\n      Property: "Ambient", "ColorRGB", "",1,1,1\n      Property: "Diffuse", "ColorRGB", "",${e.diffuse}\n      Property: "Specular", "ColorRGB", "",${e.specular}\n      Property: "Shininess", "double", "",${e.shininess}\n      Property: "Opacity", "double", "",${e.opacity}\n      Property: "Reflectivity", "double", "",0\n    }`}}class $c extends Nc{constructor(e,t){super(e,t),this._data=e,this._version=t.miewVersion||"0.0-UNSPECIFIED",this._extractor=new jc}exportSync(){const e=new Hc;if(!this._source)return this._result;const t=this._extractor.process(this._data);return t.version=this._version,this._result=e.getResult(t),this._result}}$c.formats=["fbx"],$c.SourceClass=Qo;const Wc={loaders:ba,parsers:Mc,exporters:new Pc([Ic,$c])},Yc=new r.Color;const Xc=class{constructor(){this._width=0,this._height=0,this._widthHalf=0,this._heightHalf=0,this._vector=new r.Vector3,this._viewMatrix=new r.Matrix4,this._projectionMatrix=new r.Matrix4,this._domElement=document.createElement("div"),this._domElement.style.overflow="hidden",this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.zIndex="0",this._domElement.style.pointerEvents="none"}getElement(){return this._domElement}reset(){const e=this.getElement();for(;e.firstChild;)e.removeChild(e.firstChild)}setSize(e,t){this._width=e,this._height=t,this._widthHalf=this._width/2,this._heightHalf=this._height/2,this._domElement.style.width=`${e}px`,this._domElement.style.height=`${t}px`}_renderObject(e,t,n){function s(e,t,r){return Yc.setHex(e),Yc.lerp(t,r),`#${Yc.getHexString()}`}function i(e){return Yc.setHex(e),`#${Yc.getHexString()}`}if(e instanceof qt){if(this._vector.setFromMatrixPosition(e.matrixWorld),void 0!==e.userData&&void 0!==e.userData.offset){const t=new r.Vector3(e.userData.offset.x,e.userData.offset.y,0);this._vector.add(t.multiplyScalar(e.matrixWorld.getMaxScaleOnAxis()))}this._vector.applyMatrix4(this._viewMatrix);const o=this._vector.z>-t.near?"hidden":"visible",a=1e4*(t.far- -this._vector.z)/(t.far-t.near),l=e.getElement();if(void 0===n.fog)l.style.color=i(e.userData.color),"transparent"!==e.userData.background&&(l.style.background=i(e.userData.background));else{const t=r.MathUtils.smoothstep(-this._vector.z,n.fog.near,n.fog.far);l.style.color=s(e.userData.color,n.fog.color,t),"transparent"!==e.userData.background&&(l.style.background=s(e.userData.background,n.fog.color,t))}this._vector.applyMatrix4(this._projectionMatrix);const c=`${e.userData!=={}?e.userData.translation:"translate(-50%, -50%) "}translate(${this._vector.x*this._widthHalf+this._widthHalf}px,${-this._vector.y*this._heightHalf+this._heightHalf}px)`;l.style.visibility=o,l.style.WebkitTransform=c,l.style.MozTransform=c,l.style.oTransform=c,l.style.transform=c,l.style.zIndex=Number(a).toFixed(0),l.parentNode!==this._domElement&&this._domElement.appendChild(l)}for(let r=0,s=e.children.length;r<s;r++)this._renderObject(e.children[r],t,n)}render(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.copy(t.matrixWorld).invert(),this._viewMatrix.copy(t.matrixWorldInverse),this._projectionMatrix.copy(t.projectionMatrix),this._renderObject(e,t,e)}};function qc(){try{if(void 0!==window.top.location.href)return window.top}catch(e){}return window}const Zc=-1,Kc=0,Qc=1,Jc=2,eh=3,th=new r.Quaternion,rh=new r.Matrix4;function nh(e,t,n,s){this.objects=e,[this.object]=e,this.camera=t,this.pivot=n,this.axis=new r.Vector3(0,0,1),this.options=s,this.lastRotation={axis:new r.Vector3,angle:0}}function sh(e,t,n,s,i){g.call(this);const o=this;this.object=e,this.objectPivot=t,this.camera=n,this.domElement=void 0!==s?s:document,this.getAltObj=i,this.enabled=!0,this.hotkeysEnabled=!0,this.screen={left:0,top:0,width:0,height:0},this.options={rotateFactor:Math.PI,axisRotateFactor:4*Math.PI,intertia:!0,dynamicDampingFactor:.1,intertiaThreshold:.001},this._state=Zc,this._mousePrevPos=new r.Vector2,this._mouseCurPos=new r.Vector2,this._mainObj=new nh([this.object],this.camera,new r.Vector3(0,0,0),this.options),this._altObj=new nh([this.object],this.camera,new r.Vector3(0,0,0),this.options),this._affectedObj=this._mainObj,this._isAltObjFreeRotationAllowed=!0,this._isTranslationAllowed=!0,this._isKeysTranslatingObj=!1,this._pressedKeys=[],this._clock=new u,this._clock.start(),this._lastUpdateTime=this._clock.getElapsedTime(),this._listeners=[{obj:o.domElement,type:"mousedown",handler(e){o.mousedown(e)}},{obj:o.domElement,type:"mouseup",handler(e){o.mouseup(e)}},{obj:o.domElement,type:"mousemove",handler(e){o.mousemove(e)}},{obj:o.domElement,type:"mousewheel",handler(e){o.mousewheel(e)}},{obj:o.domElement,type:"DOMMouseScroll",handler(e){o.mousewheel(e)}},{obj:o.domElement,type:"mouseout",handler(e){o.mouseup(e)}},{obj:o.domElement,type:"touchstart",handler(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchend",handler(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchmove",handler(e){o.touchmove(e)}},{obj:o.getKeyBindObject(),type:"keydown",handler(e){o.keydownup(e)}},{obj:o.getKeyBindObject(),type:"keyup",handler(e){o.keydownup(e)}},{obj:window,type:"resize",handler(){o.handleResize()}},{obj:window,type:"blur",handler(){o.resetKeys()}},{obj:o.domElement,type:"contextmenu",handler(e){o.contextmenu(e)}}];for(let e=0;e<this._listeners.length;e++){const t=this._listeners[e];t.obj.addEventListener(t.type,t.handler)}this.handleResize(),this.resetKeys(),this.update()}nh.prototype._rotate=function(){const e=new r.Vector3,t=new r.Quaternion,n=new r.Vector3,s=new r.Matrix4;return function(r){const i=0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z;if(s.copy(this.object.matrix),i?s.multiply(rh.makeRotationFromQuaternion(r)):(s.multiply(rh.makeTranslation(this.pivot.x,this.pivot.y,this.pivot.z)),s.multiply(rh.makeRotationFromQuaternion(r)),s.multiply(rh.makeTranslation(-this.pivot.x,-this.pivot.y,-this.pivot.z))),s.decompose(e,t,n),!i)for(let t=0;t<this.objects.length;++t)this.objects[t].position.copy(e);for(let e=0;e<this.objects.length;++e)this.objects[e].quaternion.copy(t),this.objects[e].updateMatrix()}}(),nh.prototype.setObjects=function(e){this.objects=e,[this.object]=e},nh.prototype.rotate=function(){const e={axis:new r.Vector3,angle:0};return function(t,r,n,s){this.mouse2rotation(e,r,n,s),t.setFromAxisAngle(e.axis,e.angle),e.angle&&this._rotate(t),this.lastRotation=e}}(),nh.prototype.translate=function(){const e=new r.Vector3,t=new r.Vector3;return function(r){e.set(r.x/this.camera.projectionMatrix.elements[0],r.y/this.camera.projectionMatrix.elements[5],0);let n=e.length();e.normalize(),e.transformDirection(rh.copy(this.object.matrixWorld).invert()),t.copy(this.pivot),this.object.localToWorld(t),n*=Math.abs(t.z-this.camera.position.z),n/=this.object.matrixWorld.getMaxScaleOnAxis();for(let t=0;t<this.objects.length;++t)this.objects[t].translateOnAxis(e,n)}}(),nh.prototype.update=function(){const e=new r.Vector3;return function(t,r){if(0!==z.now.autoRotation)return z.now.autoRotationAxisFixed||0===this.lastRotation.axis.length()?e.set(0,1,0).transformDirection(rh.copy(this.object.matrixWorld).invert()):e.copy(this.lastRotation.axis),this._rotate(th.setFromAxisAngle(e,z.now.autoRotation*t)),!0;if(this.options.intertia&&this.lastRotation.angle){const e=this.lastRotation.angle*(1-this.options.dynamicDampingFactor)**(40*r);if(!(Math.abs(e)<=this.options.intertiaThreshold))return this._rotate(th.setFromAxisAngle(this.lastRotation.axis,e)),!0;this.lastRotation.angle=0}return!1}}(),nh.prototype.stop=function(){this.lastRotation.angle=0},nh.prototype.mouse2rotation=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Vector3,s=new r.Vector3,i=new r.Vector3,o=new r.Vector3,a=new r.Vector2;return function(r,l,c,h){if(h)r.axis.copy(this.axis),r.angle=this.options.axisRotateFactor*(c.y-l.y);else{a.subVectors(c,l);const h=a.length();if(0===h)return;e.copy(this.pivot),this.object.localToWorld(e),t.subVectors(this.camera.position,e),n.copy(t).normalize(),s.copy(this.camera.up).normalize(),i.crossVectors(s,n).normalize(),s.setLength(a.y),i.setLength(a.x),o.copy(s.add(i)),r.axis.crossVectors(o,t),r.angle=-h*this.options.rotateFactor}r.axis.transformDirection(rh.copy(this.object.matrixWorld).invert()),r.angle<0&&(r.axis.negate(),r.angle=-r.angle)}}(),sh.prototype=Object.create(g.prototype),sh.prototype.constructor=sh,sh.prototype.resetKeys=function(){this._pressedKeys[37]=!1,this._pressedKeys[38]=!1,this._pressedKeys[39]=!1,this._pressedKeys[40]=!1},sh.prototype.contextmenu=function(e){e.stopPropagation(),e.preventDefault()},sh.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},sh.prototype.enable=function(e){this.enabled=e},sh.prototype.enableHotkeys=function(e){this.hotkeysEnabled=e},sh.prototype.allowTranslation=function(e){this._isTranslationAllowed=e},sh.prototype.allowAltObjFreeRotation=function(e){this._isAltObjFreeRotationAllowed=e},sh.prototype.keysTranslateObj=function(e){this._isKeysTranslatingObj=e},sh.prototype.isEditingAltObj=function(){return(this._state===Kc||this._state===Qc)&&this._affectedObj===this._altObj},sh.prototype.convertMouseToOnCircle=function(e,t,r){const n=Math.min(this.screen.width,this.screen.height);0!==n?e.set((t-.5*this.screen.width-this.screen.left)/n,(.5*this.screen.height+this.screen.top-r)/n):e.set(0,0)},sh.prototype.convertMouseToViewport=function(e,t,r){0!==this.screen.width&&0!==this.screen.height?e.set(2*(t-.5*this.screen.width-this.screen.left)/this.screen.width,2*(.5*this.screen.height+this.screen.top-r)/this.screen.height):e.set(0,0)},sh.prototype.stop=function(){this._mainObj.stop(),this._altObj.stop()},sh.prototype.rotateByMouse=function(){const e=new r.Quaternion;return function(t){this._affectedObj.rotate(e,this._mousePrevPos,this._mouseCurPos,t),this.dispatchEvent({type:"change",action:"rotate",quaternion:e})}}(),sh.prototype.rotate=function(e){this.object.quaternion.multiply(e),this.dispatchEvent({type:"change",action:"rotate",quaternion:e})},sh.prototype.getOrientation=function(){return this.object.quaternion},sh.prototype.setOrientation=function(e){this.object.quaternion.copy(e)},sh.prototype.translate=function(){const e=new r.Vector2;return function(){e.subVectors(this._mouseCurPos,this._mousePrevPos),this._affectedObj.translate(e),this.dispatchEvent({type:"change",action:"translate"})}}(),sh.prototype.getScale=function(){return this.object.scale.x},sh.prototype.setScale=function(e){this.object.scale.set(e,e,e)},sh.prototype.scale=function(e){e<=0||(this.setScale(this.object.scale.x*e),this.dispatchEvent({type:"change",action:"zoom",factor:e}))},sh.prototype.update=function(){const e=new r.Vector2;return function(){const t=this._clock.getElapsedTime(),r=t-this._lastUpdateTime;if(this._state===Zc){const e=t-this._lastMouseMoveTime;(this._mainObj.update(r,e)||this._altObj.update(r,e))&&this.dispatchEvent({type:"change",action:"auto"})}if(this._isKeysTranslatingObj){const t=Number(this._pressedKeys[39])-Number(this._pressedKeys[37]),n=Number(this._pressedKeys[38])-Number(this._pressedKeys[40]);if(0!==t||0!==n){const s=r,i=this.getAltObj();i.objects.length>0&&(this._altObj.setObjects(i.objects),this._altObj.pivot=i.pivot,"axis"in i?this._altObj.axis=i.axis.clone():this._altObj.axis.set(0,0,1),e.set(s*t,s*n),this._altObj.translate(e),this.dispatchEvent({type:"change",action:"translate"}))}}this._lastUpdateTime=t}}(),sh.prototype.reset=function(){this._state=Zc,this.object.quaternion.copy(th.set(0,0,0,1))},sh.prototype.mousedown=function(e){if(!1!==this.enabled&&this._state===Zc){if(e.preventDefault(),e.stopPropagation(),this._state===Zc)if(0===e.button){this._affectedObj.stop();let t=!1;if(e.altKey){const e=this.getAltObj();t=e.objects.length>0,t&&(this._altObj.setObjects(e.objects),this._altObj.pivot=e.pivot,"axis"in e?this._altObj.axis=e.axis.clone():this._altObj.axis.set(0,0,1))}this._affectedObj=t?this._altObj:this._mainObj,this._state=t&&e.ctrlKey&&this._isTranslationAllowed?Qc:Kc}else 2===e.button&&(this._state=eh);this._state===Kc&&(this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos)),this._state!==Qc&&this._state!==eh||(this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos))}},sh.prototype.mousemove=function(e){if(!1!==this.enabled&&this._state!==Zc)switch(e.preventDefault(),e.stopPropagation(),this._state){case Kc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this.rotateByMouse(e.altKey&&!this._isAltObjFreeRotationAllowed||e.shiftKey),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case Qc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translate();break;case eh:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translatePivotByMouse()}},sh.prototype.mousewheel=function(e){if(!1===this.enabled||!z.now.zooming||this._state!==Zc||e.shiftKey)return;e.preventDefault();let t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3);let r=1+.05*t;r=Math.max(r,.01),this.scale(r)},sh.prototype.mouseup=function(e){!1!==this.enabled&&this._state!==Zc&&(e.preventDefault(),e.stopPropagation(),this._state=Zc,this._clock.getElapsedTime()-this._lastMouseMoveTime>.1&&this._affectedObj.stop())},sh.prototype.touchstartend=function(e){if(!1!==this.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this._state=Kc,this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this._mousePrevPos.copy(this._mouseCurPos);break;case 2:{this._mainObj.stop(),this._altObj.stop(),this._state=Jc;const t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=this._touchDistanceStart=Math.sqrt(t*t+r*r),this._scaleStart=this.object.scale.x;break}default:this._state=Zc}},sh.prototype.touchmove=function(e){if(!1!==this.enabled&&this._state!==Zc)switch(e.preventDefault(),e.stopPropagation(),this._state){case Kc:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this.rotateByMouse(!1),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case Jc:if(z.now.zooming){const t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=Math.sqrt(t*t+r*r);const n=this._scaleStart*this._touchDistanceCur/this._touchDistanceStart/this.object.scale.x;this.scale(n)}}},sh.prototype.keydownup=function(e){if(!1!==this.enabled&&!1!==this.hotkeysEnabled)switch(e.keyCode){case 37:case 38:case 39:case 40:this._pressedKeys[e.keyCode]="keydown"===e.type,e.preventDefault(),e.stopPropagation()}},sh.prototype.getKeyBindObject=function(){return qc()},sh.prototype.dispose=function(){for(let e=0;e<this._listeners.length;e++){const t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}},sh.prototype.translatePivotByMouse=function(){const e=new r.Vector2;return function(){e.subVectors(this._mouseCurPos,this._mousePrevPos),this.translatePivotInWorld(z.now.translationSpeed*e.x,z.now.translationSpeed*e.y,0)}}(),sh.prototype.translatePivotInWorld=function(e,t,r){const n=this.objectPivot.position;n.applyMatrix4(this.object.matrixWorld),n.setX(n.x+e),n.setY(n.y+t),n.setZ(n.z+r),n.applyMatrix4(rh.copy(this.object.matrixWorld).invert()),this.dispatchEvent({type:"change",action:"translatePivot"})},sh.prototype.translatePivot=function(e,t,r){const n=this.objectPivot.position;n.setX(n.x+e),n.setY(n.y+t),n.setZ(n.z+r),this.dispatchEvent({type:"change",action:"translatePivot"})},sh.prototype.setPivot=function(e){this.objectPivot.position.copy(e),this.dispatchEvent({type:"change",action:"translatePivot"})};const ih=sh;function oh(e,t,n){g.call(this);const s=this;this.gfxObj=e,this.camera=t,this.domElement=void 0!==n?n:document,this.screen={left:0,top:0,width:0,height:0},this._lastMousePos=new r.Vector2(0,0),this._mouseTotalDist=0,this._lastClickBeginTime=-1e3,this._lastClickPos=new r.Vector2(0,0),this._clickBeginTime=0,this._clock=new u,this._clock.start(),this._listeners=[{obj:s.domElement,type:"mousedown",handler(e){s.mousedown(e)}},{obj:s.domElement,type:"mouseup",handler(e){s.mouseup(e)}},{obj:s.domElement,type:"mousemove",handler(e){s.mousemove(e)}},{obj:s.domElement,type:"touchstart",handler(e){s.touchstart(e)}},{obj:s.domElement,type:"touchend",handler(e){s.touchend(e)}},{obj:window,type:"resize",handler(){s.handleResize()}}];for(let e=0;e<this._listeners.length;e++){const t=this._listeners[e];t.obj.addEventListener(t.type,t.handler)}this.handleResize()}oh.prototype=Object.create(g.prototype),oh.prototype.constructor=oh,oh.prototype.reset=function(){this.picked={},this.dispatchEvent({type:"newpick",obj:{}})},oh.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},oh.prototype.pickObject=function(e){if(!this.gfxObj)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});const{gfxObj:t}=this,n=new r.Raycaster;n.ray.origin.setFromMatrixPosition(this.camera.matrixWorld),n.ray.direction.set(e.x,e.y,.5).unproject(this.camera).sub(n.ray.origin).normalize();const s=z.now.draft.clipPlane&&this.clipPlaneValue?this.clipPlaneValue:1/0,i=z.now.fog&&this.fogFarValue?this.fogFarValue:1/0,o=n.intersectVisibleObject(t,this.camera,s,i);if(!o)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});let a={};if(o.residue||o.atom){const e=o.residue||o.atom.residue;"chain"===z.now.pick?a={chain:e.getChain()}:"molecule"===z.now.pick?a={molecule:e.getMolecule()}:o.residue||"residue"===z.now.pick?a={residue:e}:o.atom&&(a={atom:o.atom})}this.picked=a,this.dispatchEvent({type:"newpick",obj:a})},oh.prototype.getMouseInViewport=function(e,t){return new r.Vector2((e-this.screen.left)/this.screen.width*2-1,-(t-this.screen.top)/this.screen.height*2+1)},oh.prototype.mousedown=function(e){e.preventDefault(),e.stopPropagation(),0===e.button&&(this._lastMousePos=this.getMouseInViewport(e.pageX,e.pageY),this._mouseTotalDist=0,this._clickBeginTime=this._clock.getElapsedTime())},oh.prototype.mousemove=function(e){e.preventDefault(),e.stopPropagation();const t=this.getMouseInViewport(e.pageX,e.pageY);this._mouseTotalDist+=t.sub(this._lastMousePos).length()},oh.prototype.mouseup=function(e){const t=this;if(e.preventDefault(),e.stopPropagation(),0===e.button&&this._mouseTotalDist<.01){const n=this._clock.getElapsedTime(),s=this.getMouseInViewport(e.pageX,e.pageY);if(n-this._lastClickBeginTime<.7){if((new r.Vector2).subVectors(s,this._lastClickPos).length()<.01)return this.dispatchEvent({type:"dblclick",obj:this.picked}),this._lastClickPos=s,void(this._lastClickBeginTime=-1e3)}setTimeout((()=>{t.pickObject(s)}),0),this._lastClickPos=s,this._lastClickBeginTime=this._clickBeginTime}},oh.prototype.touchstart=function(e){e.preventDefault(),e.stopPropagation(),1===e.touches.length&&(this._lastTouchdownPos=this.getMouseInViewport(e.touches[0].pageX,e.touches[0].pageY))},oh.prototype.touchend=function(e){const t=this;if(e.preventDefault(),e.stopPropagation(),0===e.touches.length&&1===e.changedTouches.length){this.getMouseInViewport(e.changedTouches[0].pageX,e.changedTouches[0].pageY).sub(this._lastTouchdownPos).length()<.01&&setTimeout((()=>{t.pickObject(t._lastTouchdownPos)}),0)}},oh.prototype.dispose=function(){for(let e=0;e<this._listeners.length;e++){const t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}};const ah=oh;const lh=class{constructor(e,t){this._target=e,this._targetCamera=t,this._camera=new r.PerspectiveCamera(t.fov,t.aspect,1,100),this._object=new r.AxesHelper(1),this._scene=new r.Scene,this._scene.add(this._object),this._full=new r.Vector2,this._update()}_update(){const{fov:e}=this._targetCamera,t=this._camera;t.aspect=this._targetCamera.aspect,t.setMinimalFov(e),t.setDistanceToFit(1,e),t.updateProjectionMatrix(),this._object.quaternion.copy(this._target.quaternion)}render(e){this._update(),e.getSize(this._full);const t=.25*this._full.width,r=.25*this._full.height,{autoClear:n}=e;e.autoClear=!1,e.setViewport(0,0,t,r),e.clear(!1,!0,!1),e.render(this._scene,this._camera),e.setViewport(0,0,this._full.width,this._full.height),e.autoClear=n}},ch=["helix","strand"],hh=["fs","ps","ns","us"];function uh(e,t){const r=t._residues,n=r.length,s=new Uint8Array(n),i=t._atoms;for(let t=0,r=e.length;t<r;++t){s[i[t].residue._index]=e[t]}const o=[];let a=0;for(;a<n;){if(0!==s[a]){const e=a,t=s[a];for(;a<n-1&&s[a+1]===t&&r[a].isConnected(r[a+1]);)++a;o.push({start:e,end:a,type:ch[t-1]})}++a}return o}function dh(e){return e>=524288?e-1048576:e}class ph{constructor(e,t,r){this._complex=e,this._secondary=null,this.isLoading=!1,this._framesRange={start:0,end:-1},this.frameIsReady=!1,this._buffer=null,this._frameRequest=null,this._callbacks=r,"function"==typeof t?(this._framesRequestLength=1,this._downloadDataFn=t):this.parseBinaryData(t,!0),this.reset(),this.setFrame(0)}_prepareBuffer(e,t){if(null==e&&(e=0),null==t&&(t=e+this._framesRequestLength),void 0!==this._framesCount&&(t=Math.min(this._framesCount-1,t)),this._downloadDataFn){const r=this,n=function(n){if(r.isLoading=!1,r._callbacks&&"function"==typeof r._callbacks.onLoadStatusChanged&&r._callbacks.onLoadStatusChanged(),r._buffer={data:n,state:"ready",start:e,end:t},null!==r._frameRequest){const e=r._frameRequest;r._frameRequest=null,r.setFrame(e)}},s=function(){r.isLoading=!1,r._callbacks&&"function"==typeof r._callbacks.onError&&r._callbacks.onError("Streaming failed")};this._buffer||(this._buffer={}),this._buffer.state="downloading",this.isLoading=!0,r._callbacks&&"function"==typeof r._callbacks.onLoadStatusChanged&&r._callbacks.onLoadStatusChanged(),this._downloadDataFn({start:e,end:t+1},n,s)}}_parseBuffer(){if(this._buffer&&"ready"===this._buffer.state){this._framesRange={start:this._buffer.start,end:this._buffer.end},this.parseBinaryData(this._buffer.data,!1);let e=(this._buffer.end+1)%this._framesCount;if(e>=this._framesCount&&(e=0),this._buffer={state:"none"},this._prepareBuffer(e,e+this._framesRequestLength),null!==this._frameRequest){const e=this._frameRequest;this._frameRequest=null,this.setFrame(e)}}}parseBinaryData(e){const t=new DataView(e);let r=0;const n=t.getUint32(r,!0);r+=4;const s=t.getUint32(r,!0);this._framesCount=s,this._framesRange.end=this._framesRange.end>0?Math.min(this._framesRange.end,s-1):s-1,r+=4,this._atomsCount=n;this._framesRequestLength=Math.ceil(1048576/(8*n));const i=this._framesRange.end-this._framesRange.start+1;if(n!==this._complex._atoms.length||e.byteLength!==12+i*n*8)throw new Error;const o=this._complex;let a=t.getUint32(r,!0),l=0;for(;a>1e3&&l<hh.length-1;)a/=1e3,++l;this._timeStep=`${a.toString()} ${hh[l]}`,r+=4;const c=[],h=new Float32Array(i*n*3);let u=0;const d=new Int8Array(n);for(let e=0;e<i;++e){for(let e=0;e<n;++e){const n=t.getUint32(r,!0);r+=4;const s=t.getUint32(r,!0);r+=4;const i=(4026531840&s)>>>28,o=dh((268435200&s)>>>8>>0),a=dh(((255&s)<<12|(4293918720&n)>>>20)>>0),l=dh((1048575&n)>>0);d[e]=0,i>0&&i<4?d[e]=1:4===i&&(d[e]=2),h[u++]=o/100,h[u++]=a/100,h[u++]=l/100}c.push(uh(d,o))}this._secondaryData=c,this._data=h}nextFrame(){this.setFrame((this._currFrame+1)%this._framesCount)}needsColorUpdate(e){return e instanceof bo}getAtomColor(e,t){return e.getResidueColor(this._residues[t.residue._index],this._complex)}getResidueColor(e,t){return e.getResidueColor(this._residues[t._index],this._complex)}_updateSecondary(){let e;const t=this._residues;let r=t.length;for(e=0;e<r;++e)t[e]._secondary=null;const n=this._secondaryData[this._currFrame-this._framesRange.start];for(e=0,r=n.length;e<r;++e){const r=n[e],{start:s,end:i}=r,o={_start:t[s],_end:t[i],type:r.type,generic:r.generic};for(let e=s;e<=i;++e)t[e]._secondary=o}}reset(){const e=this._complex._residues,t=e.length;this._residues=new Array(t);const r=this._residues,n=function(){return this._secondary};for(let s=0;s<t;++s)r[s]={_type:e[s]._type,_isValid:e[s]._isValid,_controlPoint:null,_wingVector:null,_secondary:null,getSecondary:n}}setFrame(e){if(this.frameIsReady=!1,e>=this._framesRange.start&&e<=this._framesRange.end)this._currFrame=e,this._cachedResidues=!1,this._updateSecondary(),this.frameIsReady=!0;else if(this._frameRequest=e,this._buffer){const t=this;switch(this._buffer.state){case"none":this._prepareBuffer(e);break;case"ready":t._parseBuffer()}}else this._prepareBuffer(e)}disableEvents(){this._callbacks=null}static _vec=(()=>new r.Vector3)();getAtomPos(e){const t=ph._vec,r=this,n=r._data,s=3*(r._atomsCount*(r._currFrame-r._framesRange.start)+e);return t.set(n[s],n[s+1],n[s+2]),t}getResidues(){return this._cachedResidues||this._complex.updateToFrame(this),this._residues}}const mh=ph;class fh{constructor(e,r){if(this.constructor===fh)throw new Error("Can not instantiate abstract class!");this.params=e,this.opts=t().merge(O.deriveDeep(z.now.objects[this.type],!0),r),this.needsRebuild=!1,this._mesh=null,this.id=null}identify(){const e={type:this.type,params:this.params},r=O.objectsDiff(this.opts,z.now.modes[this.id]);return t().isEmpty(r)||(e.opts=r),e}toString(){return`o=${this.type},${this.params.join(",")}`+O.compareOptionsWithDefaults(this.opts,z.defaults.objects[this.type])}getGeometry(){return this._mesh}destroy(){this._mesh&&sr.destroyObject(this._mesh)}}fh.prototype.type="__";const _h=fh;class gh extends _h{constructor(e,t){if(super(e,t),e.length<2)throw new Error("Wrong number of argumets on line object creation!");[this._id1,this._id2]=e}_getAtomFromName(e,t){const r=e.getAtomByFullname(t);if(!r)throw new Error(t+" - Wrong atom format it must be '#CHAIN_NAME.#RESIDUE_NUMBER.#ATOM_NAME' (e.g. 'A.38.CO1')");return r}build(e){const t=new r.BufferGeometry;this._atom1=this._getAtomFromName(e,this._id1),this._atom2=this._getAtomFromName(e,this._id2);const n=this._atom1.position,s=this._atom2.position,i=new Float32Array([n.x,n.y,n.z,s.x,s.y,s.z]);t.setAttribute("position",new r.BufferAttribute(i,3)),t.computeBoundingBox(),this._line=new fs.Line(t,new Jn({lights:!1,overrideColor:!0,dashedLine:!0,fogTransparent:z.now.bg.transparent})),this._line.computeLineDistances(),this._line.material.setUberOptions({fixedColor:new r.Color(this.opts.color),dashedLineSize:this.opts.dashSize,dashedLinePeriod:this.opts.dashSize+this.opts.gapSize}),this._line.material.updateUniforms(),this._line.raycast=function(e,t){},this._mesh=this._line;const o=e.getTransforms();o.length>0&&(this._mesh=new r.Group,this._mesh.add(this._line),jo.applyTransformsToMeshes(this._mesh,o))}updateToFrame(e){if(!this._atom1||!this._atom2||!this._line)return;const t=this._line.geometry;t.vertices[0].copy(e.getAtomPos(this._atom1.index)),t.vertices[1].copy(e.getAtomPos(this._atom2.index)),this._line.computeLineDistances(),t.computeBoundingSphere(),t.verticesNeedUpdate=!0}}gh.prototype.constructor=gh,gh.prototype.type="line";const yh=gh;class xh extends r.RawShaderMaterial{constructor(e){super(e);const t={uniforms:{srcTex:{type:"t",value:null},srcDepthTex:{type:"t",value:null},srcTexSize:{type:"v2",value:new r.Vector2(512,512)},color:{type:"v3",value:null},threshold:{type:"f",value:null},opacity:{type:"f",value:1},thickness:{type:"v2",value:new r.Vector2(1,1)}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n\r\nuniform sampler2D srcTex;\r\nuniform vec2 srcTexSize;\r\nuniform vec2 thickness;\r\nvarying vec2 vUv;\r\n\r\n#ifdef DEPTH_OUTLINE\r\n  uniform sampler2D srcDepthTex; //depthTexture\r\n  uniform vec3 color;\r\n  uniform float threshold;\r\n#endif\r\n\r\nvoid main() {\r\n\r\n  vec2 pixelSize = thickness / srcTexSize;\r\n\r\n  #ifdef DEPTH_OUTLINE\r\n    float c00 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,-pixelSize.y)).x;\r\n    float c01 = texture2D(srcDepthTex, vUv + vec2(0,-pixelSize.y)).x;\r\n    float c02 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,-pixelSize.y)).x;\r\n    float c10 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,0)).x;\r\n    float c12 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,0)).x;\r\n    float c20 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,pixelSize.y)).x;\r\n    float c21 = texture2D(srcDepthTex, vUv + vec2(0,pixelSize.y)).x;\r\n    float c22 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,pixelSize.y)).x;\r\n\r\n    float horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r\n    float vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r\n\r\n    float grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r\n\r\n    gl_FragColor = ( grad > threshold ) ? vec4(color.rgb, 1.0) : gl_FragColor = texture2D(srcTex, vUv);\r\n\r\n  #else\r\n    vec4 c00 = texture2D(srcTex, vUv + vec2(-pixelSize.x,-pixelSize.y));\r\n    vec4 c01 = texture2D(srcTex, vUv + vec2(0,-pixelSize.y));\r\n    vec4 c02 = texture2D(srcTex, vUv + vec2(pixelSize.x,-pixelSize.y));\r\n    vec4 c10 = texture2D(srcTex, vUv + vec2(-pixelSize.x,0));\r\n    vec4 c12 = texture2D(srcTex, vUv + vec2(pixelSize.x,0));\r\n    vec4 c20 = texture2D(srcTex, vUv + vec2(-pixelSize.x,pixelSize.y));\r\n    vec4 c21 = texture2D(srcTex, vUv + vec2(0,pixelSize.y));\r\n    vec4 c22 = texture2D(srcTex, vUv + vec2(pixelSize.x,pixelSize.y));\r\n\r\n    vec4 horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r\n    vec4 vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r\n\r\n    vec4 grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r\n    gl_FragColor = grad;\r\n  #endif\r\n}\r\n",transparent:!0,depthTest:!1,depthWrite:!1};this.setValues(t)}copy(e){super.copy(e),this.depth=e.depth}setValues(e){if(void 0===e)return;super.setValues(e);const t={};this.depth&&(t.DEPTH_OUTLINE=1),this.defines=t}}xh.prototype.depth=!1;const bh=xh;class wh extends r.RawShaderMaterial{constructor(e){super(e),this.setValues.call(this,{uniforms:{srcTex:{type:"t",value:null},srcTexelSize:{type:"v2",value:new r.Vector2(1/512,1/512)},bgColor:{type:"c",value:new r.Color(16777215)}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n\r\n// edge end finding algorithm parameters\r\n#define FXAA_QUALITY_PS 8\r\n#define FXAA_QUALITY_P0 1.0\r\n#define FXAA_QUALITY_P1 1.5\r\n#define FXAA_QUALITY_P2 2.0\r\n#define FXAA_QUALITY_P3 2.0\r\n#define FXAA_QUALITY_P4 2.0\r\n#define FXAA_QUALITY_P5 2.0\r\n#define FXAA_QUALITY_P6 4.0\r\n#define FXAA_QUALITY_P7 12.0\r\n// constants\r\nfloat fxaaQualityEdgeThreshold = 0.125;\r\nfloat fxaaQualityEdgeThresholdMin = 0.0625;\r\nfloat fxaaQualitySubpix = 0.7; //0.65;\r\n// global params\r\nuniform sampler2D srcTex;\r\nuniform vec2 srcTexelSize;\r\nuniform vec3 bgColor;\r\n// from vs\r\nvarying vec2 vUv;\r\n//=====================================================================//\r\n// calc luminance from rgb\r\n//'float FxaaLuma(vec3 rgb) {return rgb.y * (0.587/0.299) + rgb.x; } // Lotte's idea about game luminance\r\nfloat FxaaLuma(vec3 rgb) {return dot(rgb, vec3(0.299, 0.587, 0.114)); } // real luminance calculation\r\n                                                                           // for non-real scene rendering\r\n// texture sampling by pixel position(coords) and offset(in pixels)\r\n vec3 FxaaTex(sampler2D tex, vec2 pos, vec2 off,  vec2 res ) {\r\n  #ifdef BG_TRANSPARENT\r\n    vec4 color = texture2D( tex, pos + off * res );\r\n    return mix(color.rgb, bgColor, 1.0 - color.a);\r\n  #else\r\n    return texture2D( tex, pos + off * res ).xyz;\r\n  #endif\r\n}\r\nvec3 FxaaTexTop(sampler2D tex, vec2 pos) {\r\n  #ifdef BG_TRANSPARENT\r\n    vec4 color = texture2D( tex, pos );\r\n    return mix(color.rgb, bgColor, 1.0 - color.a);\r\n  #else\r\n    return texture2D( tex, pos).xyz;\r\n  #endif\r\n}\r\nvec4 FxaaTexTopAlpha(sampler2D tex, vec2 pos) {\r\n  return texture2D( tex, pos);\r\n}\r\n\r\n//=====================================================================//\r\nvoid main() {\r\n  // renaming\r\n  vec2 posM = vUv;\r\n  // get luminance for neighbours\r\n  float lumaS = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, 1.0 ), srcTexelSize));\r\n  float lumaE = FxaaLuma(FxaaTex(srcTex, posM, vec2( 1.0, 0.0 ), srcTexelSize));\r\n  float lumaN = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, -1.0 ), srcTexelSize));\r\n  float lumaW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, 0.0 ), srcTexelSize));\r\n  float lumaM = FxaaLuma(FxaaTexTop(srcTex, posM));\r\n  // find max and min luminance\r\n  float rangeMax = max(max(lumaN, lumaW), max(lumaE, max(lumaS, lumaM)));\r\n  float rangeMin = min(min(lumaN, lumaW), min(lumaE, min(lumaS, lumaM)));\r\n  // calc maximum non-edge range\r\n  float rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;\r\n  float range = rangeMax - rangeMin;\r\n  float rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);\r\n  // exit when luma contrast is small (is not edge)\r\n  if(range < rangeMaxClamped){\r\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r\n    return;\r\n  }\r\n  float subpixRcpRange = 1.0/range;\r\n  // note: the sampling coordinates can be calculated in vertex shader but the approach doesn't affect performance\r\n  // visibly, thus we decided to leave calculation here for better readability.\r\n  // calc other neighbours luminance\r\n  float lumaNE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0, -1.0 ), srcTexelSize));\r\n  float lumaSW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0,  1.0 ), srcTexelSize));\r\n  float lumaSE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0,  1.0 ), srcTexelSize));\r\n  float lumaNW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, -1.0 ), srcTexelSize));\r\n/*--------------span calculation and subpix amount calulation-----------------*/\r\n  float lumaNS = lumaN + lumaS;\r\n  float lumaWE = lumaW + lumaE;\r\n  float subpixNSWE = lumaNS + lumaWE;\r\n  float edgeHorz1 = (-2.0 * lumaM) + lumaNS;\r\n  float edgeVert1 = (-2.0 * lumaM) + lumaWE;\r\n/*--------------------------------------------------------------------------*/\r\n  float lumaNESE = lumaNE + lumaSE;\r\n  float lumaNWNE = lumaNW + lumaNE;\r\n  float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;\r\n  float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;\r\n/*--------------------------------------------------------------------------*/\r\n  float lumaNWSW = lumaNW + lumaSW;\r\n  float lumaSWSE = lumaSW + lumaSE;\r\n  float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);\r\n  float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);\r\n  float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;\r\n  float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;\r\n  float edgeHorz = abs(edgeHorz3) + edgeHorz4;\r\n  float edgeVert = abs(edgeVert3) + edgeVert4;\r\n/*--------------------subpix amount calulation------------------------------*/\r\n  float subpixNWSWNESE = lumaNWSW + lumaNESE;\r\n  float lengthSign = srcTexelSize.x;\r\n  bool horzSpan = edgeHorz >= edgeVert;\r\n   // debug  code edge span visualization\r\n/*'  if (horzSpan)\r\n      gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\r\n  else\r\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\r\n  return;*/\r\n  float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;\r\n/*--------------------------------------------------------------------------*/\r\n  if(!horzSpan) lumaN = lumaW;\r\n  if(!horzSpan) lumaS = lumaE;\r\n  if(horzSpan) lengthSign = srcTexelSize.y;\r\n  float subpixB = (subpixA * (1.0/12.0)) - lumaM;\r\n/*--------------------------------------------------------------------------*/\r\n  float gradientN = lumaN - lumaM;\r\n  float gradientS = lumaS - lumaM;\r\n  float lumaNN = lumaN + lumaM;\r\n  float lumaSS = lumaS + lumaM;\r\n  bool pairN = abs(gradientN) >= abs(gradientS);\r\n  float gradient = max(abs(gradientN), abs(gradientS));\r\n  if(pairN) lengthSign = -lengthSign;\r\n  float subpixC = clamp(abs(subpixB) * subpixRcpRange, 0.0, 1.0);\r\n/*--------------------------------------------------------------------------*/\r\n  vec2 posB;\r\n  posB = posM;\r\n  vec2 offNP;\r\n  offNP.x = (!horzSpan) ? 0.0 : srcTexelSize.x;\r\n  offNP.y = ( horzSpan) ? 0.0 : srcTexelSize.y;\r\n  if(!horzSpan) posB.x += lengthSign * 0.5;\r\n  if( horzSpan) posB.y += lengthSign * 0.5;\r\n/*--------------------------------------------------------------------------*/\r\n  vec2 posN;\r\n  posN = posB - offNP * FXAA_QUALITY_P0;\r\n  vec2 posP;\r\n  posP = posB + offNP * FXAA_QUALITY_P0;\r\n  float subpixD = ((-2.0)*subpixC) + 3.0;\r\n  float lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN));\r\n  float subpixE = subpixC * subpixC;\r\n  float lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP));\r\n/*--------------------------------------------------------------------------*/\r\n  if(!pairN) lumaNN = lumaSS;\r\n  float gradientScaled = gradient * 1.0/4.0;\r\n  float lumaMM = lumaM - lumaNN * 0.5;\r\n  float subpixF = subpixD * subpixE;\r\n  bool lumaMLTZero = lumaMM < 0.0;\r\n/*---------------------looped edge-end search-------------------------------*/\r\n  lumaEndN -= lumaNN * 0.5;\r\n  lumaEndP -= lumaNN * 0.5;\r\n  bool doneN = abs(lumaEndN) >= gradientScaled;\r\n  bool doneP = abs(lumaEndP) >= gradientScaled;\r\n  if(!doneN) posN -= offNP * FXAA_QUALITY_P1;\r\n  bool doneNP = (!doneN) || (!doneP);\r\n  if(!doneP) posP += offNP * FXAA_QUALITY_P1;\r\n/*--------------------------------------------------------------------------*/\r\n  if(doneNP) {\r\n    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n    doneN = abs(lumaEndN) >= gradientScaled;\r\n    doneP = abs(lumaEndP) >= gradientScaled;\r\n    if(!doneN) posN -= offNP * FXAA_QUALITY_P2;\r\n    doneNP = (!doneN) || (!doneP);\r\n    if(!doneP) posP += offNP * FXAA_QUALITY_P2;\r\n/*--------------------------------------------------------------------------*/\r\n    #if (FXAA_QUALITY_PS > 3)\r\n      if(doneNP) {\r\n        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n        doneN = abs(lumaEndN) >= gradientScaled;\r\n        doneP = abs(lumaEndP) >= gradientScaled;\r\n        if(!doneN) posN -= offNP * FXAA_QUALITY_P3;\r\n        doneNP = (!doneN) || (!doneP);\r\n        if(!doneP) posP += offNP * FXAA_QUALITY_P3;\r\n/*--------------------------------------------------------------------------*/\r\n        #if (FXAA_QUALITY_PS > 4)\r\n          if(doneNP) {\r\n            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n            doneN = abs(lumaEndN) >= gradientScaled;\r\n            doneP = abs(lumaEndP) >= gradientScaled;\r\n            if(!doneN) posN -= offNP * FXAA_QUALITY_P4;\r\n            doneNP = (!doneN) || (!doneP);\r\n            if(!doneP) posP += offNP * FXAA_QUALITY_P4;\r\n/*--------------------------------------------------------------------------*/\r\n            #if (FXAA_QUALITY_PS > 5)\r\n               if(doneNP) {\r\n                 if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                 if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                 if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                 if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                 doneN = abs(lumaEndN) >= gradientScaled;\r\n                 doneP = abs(lumaEndP) >= gradientScaled;\r\n                 if(!doneN) posN -= offNP * FXAA_QUALITY_P5;\r\n                 doneNP = (!doneN) || (!doneP);\r\n                 if(!doneP) posP += offNP * FXAA_QUALITY_P5;\r\n/*--------------------------------------------------------------------------*/\r\n                 #if (FXAA_QUALITY_PS > 6)\r\n                   if(doneNP) {\r\n                     if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                     if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                     if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                     if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                     doneN = abs(lumaEndN) >= gradientScaled;\r\n                     doneP = abs(lumaEndP) >= gradientScaled;\r\n                     if(!doneN) posN -= offNP * FXAA_QUALITY_P6;\r\n                     doneNP = (!doneN) || (!doneP);\r\n                     if(!doneP) posP += offNP * FXAA_QUALITY_P6;\r\n/*--------------------------------------------------------------------------*/\r\n                     #if (FXAA_QUALITY_PS > 7)\r\n                       if(doneNP) {\r\n                         if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r\n                         if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r\n                         if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r\n                         if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r\n                         doneN = abs(lumaEndN) >= gradientScaled;\r\n                         doneP = abs(lumaEndP) >= gradientScaled;\r\n                         if(!doneN) posN -= offNP * FXAA_QUALITY_P7;\r\n                         doneNP = (!doneN) || (!doneP);\r\n                         if(!doneP) posP += offNP * FXAA_QUALITY_P7;\r\n/*--------------------------------------------------------------------------*/\r\n                       }\r\n                     #endif\r\n                   }\r\n                 #endif\r\n               }\r\n             #endif\r\n           }\r\n         #endif\r\n      }\r\n    #endif\r\n  }\r\n/*----------------calculate subpix offset due to edge ends-------------------*/\r\n  float dstN = posM.x - posN.x;\r\n  float dstP = posP.x - posM.x;\r\n  if(!horzSpan) dstN = posM.y - posN.y;\r\n  if(!horzSpan) dstP = posP.y - posM.y;\r\n/*--------------------------------------------------------------------------*/\r\n  bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;\r\n  float spanLength = (dstP + dstN);\r\n  bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;\r\n  float spanLengthRcp = 1.0 / spanLength;\r\n/*--------------------------------------------------------------------------*/\r\n  bool directionN = dstN < dstP;\r\n  float dst = min(dstN, dstP);\r\n  bool goodSpan = directionN ? goodSpanN : goodSpanP;\r\n  float subpixG = subpixF * subpixF;\r\n  float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;\r\n  float subpixH = subpixG * fxaaQualitySubpix;\r\n/*-----------------calc texture offest using subpix-------------------------*/\r\n  float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;\r\n  float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);\r\n\r\n  float offset = pixelOffsetSubpix * lengthSign;\r\n  #ifdef BG_TRANSPARENT\r\n    // get original texel\r\n    vec4 rgbaA = FxaaTexTopAlpha(srcTex, posM);\r\n    // calc step to blended texel\r\n    vec2 step = sign((!horzSpan) ? vec2 (offset, 0.0) : vec2 (0.0, offset));\r\n    // get neighboring texel\r\n    vec4 rgbaB = FxaaTexTopAlpha(srcTex, posM + step * srcTexelSize);\r\n    //  calc blend factor from offset\r\n    float f = (!horzSpan) ? offset / srcTexelSize.x : offset / srcTexelSize.y;\r\n    f = abs(f);\r\n    // calc alpha (special formula to emulate blending with bg)\r\n    gl_FragColor.a = 1.0 - mix(1.0 - rgbaA.a, 1.0 - rgbaB.a, f);\r\n    // calc color (special formula to emulate blending with bg)\r\n    gl_FragColor.rgb = mix(rgbaA.rgb * rgbaA.a, rgbaB.rgb * rgbaB.a, f) / gl_FragColor.a;\r\n  #else\r\n    if(!horzSpan) {\r\n       posM.x += offset;\r\n    } else {\r\n       posM.y += offset;\r\n    }\r\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r\n  #endif\r\n  return;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),this.setValues(e)}copy(e){super.copy(e),this.depth=e.depth}setValues(e){if(void 0===e)return;super.setValues(e);const t={};this.bgTransparent&&(t.BG_TRANSPARENT=1),this.defines=t}}wh.prototype.bgTransparent=!1;const Sh=wh,vh=[new r.Vector3(.295184,.077723,.068429),new r.Vector3(-.271976,-.365221,.838363),new r.Vector3(.547713,.467576,.488515),new r.Vector3(.662808,-.031733,.584758),new r.Vector3(-.025717,.218955,.657094),new r.Vector3(-.310153,-.365223,.370701),new r.Vector3(-.101407,-.006313,.747665),new r.Vector3(-.769138,.360399,.086847),new r.Vector3(-.271988,-.27514,.905353),new r.Vector3(.09674,-.566901,.700151),new r.Vector3(.562872,-.735136,.094647),new r.Vector3(.379877,.359278,.190061),new r.Vector3(.519064,-.023055,.405068),new r.Vector3(-.301036,.114696,.088885),new r.Vector3(-.282922,.598305,.487214),new r.Vector3(-.181859,.25167,.679702),new r.Vector3(-.191463,-.635818,.512919),new r.Vector3(-.293655,.427423,.078921),new r.Vector3(-.267983,.680534,.13288),new r.Vector3(.139611,.319637,.477439),new r.Vector3(-.352086,.31104,.653913),new r.Vector3(.321032,.805279,.487345),new r.Vector3(.073516,.820734,.414183),new r.Vector3(-.155324,.589983,.41146),new r.Vector3(.335976,.170782,.527627),new r.Vector3(.46346,-.355658,.167689),new r.Vector3(.222654,.59655,.769406),new r.Vector3(.922138,-.04207,.147555),new r.Vector3(-.72705,-.329192,.369826),new r.Vector3(-.090731,.53382,.463767),new r.Vector3(-.323457,-.876559,.238524),new r.Vector3(-.663277,-.372384,.342856)];class Ch extends r.RawShaderMaterial{constructor(){super(),this.setValues.call(this,{uniforms:{noiseTexture:{type:"t",value:Yn.noiseTexture},noiseTexelSize:{type:"v2",value:new r.Vector2(1/Yn.noiseWidth,1/Yn.noiseHeight)},diffuseTexture:{type:"t",value:null},normalTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new r.Vector2(1/512,1/512)},camNearFar:{type:"v2",value:new r.Vector2(1,10)},projMatrix:{type:"mat4",value:new r.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},samplesKernel:{type:"v3v",value:vh},kernelRadius:{type:"f",value:1},depthThreshold:{type:"f",value:1},factor:{type:"f",value:1}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 32\r\nuniform vec3 samplesKernel[MAX_SAMPLES_COUNT];\r\nuniform sampler2D noiseTexture;\r\nuniform vec2      noiseTexelSize;\r\nuniform sampler2D diffuseTexture;\r\nuniform sampler2D depthTexture;\r\nuniform sampler2D normalTexture;\r\nuniform vec2      srcTexelSize;\r\nuniform vec2      camNearFar;\r\nuniform mat4      projMatrix;\r\n\r\nuniform float aspectRatio;\r\nuniform float tanHalfFOV;\r\n\r\nuniform float kernelRadius;\r\nuniform float depthThreshold;\r\nuniform float factor;\r\n\r\nvarying vec2 vUv;\r\n\r\nfloat CalcViewZ(vec2 screenPos)\r\n{\r\n  float depth = texture2D(depthTexture, screenPos).x;\r\n  // [0, 1]->[-1, 1]\r\n  float clipedZ = 2.0 * depth - 1.0;\r\n  // see THREE.js camera.makeFrustum for projection details\r\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r\n}\r\n\r\nvec3 ViewPosFromDepth(vec2 screenPos)\r\n{\r\n  vec3 viewPos;\r\n  viewPos.z = CalcViewZ(screenPos);\r\n  //[0, 1]->[-1, 1]\r\n  vec2 projPos = 2.0 * screenPos - 1.0;\r\n  // reconstruct viewposition in right-handed sc with z to viewer\r\n  viewPos.xy = vec2(\r\n                    projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r\n                    projPos.y * tanHalfFOV * abs(viewPos.z)\r\n                   );\r\n  return viewPos;\r\n}\r\n\r\nvoid main() {\r\n  vec3 viewPos = ViewPosFromDepth(vUv);\r\n  // remap coordinates to prevent noise exture rescale\r\n  vec2 vUvNoise = vUv / srcTexelSize * noiseTexelSize;\r\n  vec4 normalData = texture2D(normalTexture, vUv);\r\n  // return for background fragments (their normals are zero vectors)\r\n  if (length(normalData.rgb) < EPSILON) {\r\n    // 0.0 in alpha component means that it is background fragment\r\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\r\n    return;\r\n  }\r\n  //[0, 1] -> [-1, 1]\r\n  vec3 normal = (normalData.rgb * 2.0 - 1.0);\r\n  // normalData.a store 1.0 if normal was build for frontfaced surface\r\n  // and 0.0 in other case\r\n  if (normalData.a < EPSILON) {\r\n    normal *= -1.0;\r\n  }\r\n  // get random vector for sampling sphere rotation\r\n  vec3 randN = texture2D(noiseTexture, vUvNoise).rgb * 2.0 - 1.0;\r\n  randN = normalize(randN);\r\n  // build TBN (randomly rotated around normal)\r\n  vec3 tangent   = normalize(randN - normal * dot(randN, normal));\r\n  vec3 bitangent = cross(tangent, normal);\r\n  mat3 TBN = mat3(tangent, bitangent, normal);\r\n  // calc AO value\r\n  float AO = 0.0;\r\n  for (int i = 0 ; i < MAX_SAMPLES_COUNT ; i++) {\r\n    // rotate sampling kernel around normal\r\n    vec3 reflectedSample = TBN * samplesKernel[i];\r\n    // get sample\r\n    vec3 samplePos = viewPos + reflectedSample * kernelRadius;\r\n\r\n    // project sample to screen to get sample's screen pos\r\n    vec4 SampleScrPos = vec4(samplePos, 1.0);\r\n    // eye -> clip\r\n    SampleScrPos = projMatrix * SampleScrPos;\r\n    // normalize\r\n    SampleScrPos.xy /= SampleScrPos.w;\r\n    //[-1, 1] -> [0, 1]\r\n    SampleScrPos.xy = (SampleScrPos.xy + vec2(1.0)) * 0.5;\r\n\r\n    // get view z for sample projected to the objct surface\r\n    float sampleDepth = CalcViewZ(SampleScrPos.xy);\r\n    // calc occlusion made by object surface at the sample\r\n    AO += step(samplePos.z, sampleDepth);\r\n  }\r\n  // calc result AO-map color\r\n  AO = 1.0 - max(0.0, AO / float(MAX_SAMPLES_COUNT) * factor);\r\n  // write value to AO-map\r\n  gl_FragColor = vec4(AO, AO, AO, 1.0);\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1})}}const Ah=Ch,Eh=[-2,-1,0,1,2];class Th extends r.RawShaderMaterial{constructor(){super(),this.setValues.call(this,{uniforms:{depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new r.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:Eh}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 5\r\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\r\nuniform sampler2D aoMap;\r\nuniform sampler2D depthTexture;\r\nuniform vec2      srcTexelSize;\r\n\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  float x = vUv.x;\r\n  float y = vUv.y;\r\n  vec4 res = vec4(0.0);\r\n  res.a = texture2D(aoMap, vec2(x, y )).a;\r\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\r\n  if (res.a < EPSILON) {\r\n    gl_FragColor = res;\r\n    return;\r\n  }\r\n\r\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r\n  float weightSum = 0.0;\r\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r\n    if (texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).a < EPSILON) {\r\n      continue;\r\n    }\r\n    vec2 samplePos = vec2(x + samplesOffsets[i] * srcTexelSize.x, y);\r\n    float depth = texture2D(depthTexture, samplePos).x;\r\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r\n    res.rgb += texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).rgb * weight;\r\n    weightSum += weight;\r\n  }\r\n  res.rgb = res.rgb / weightSum;\r\n  gl_FragColor = res;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1})}}const Rh=Th,Mh=[-2,-1,0,1,2];class Ph extends r.RawShaderMaterial{constructor(e){super(e),this.setValues.call(this,{uniforms:{diffuseTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new r.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:Mh},projMatrix:{type:"mat4",value:new r.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},fogNearFar:{type:"v2",value:new r.Vector2(100,100)},fogColor:{type:"v4",value:new r.Vector4(0,.5,0,1)}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n#define EPSILON 0.0000001\r\n\r\n#define MAX_SAMPLES_COUNT 5\r\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\r\nuniform sampler2D diffuseTexture;\r\nuniform sampler2D aoMap;\r\nuniform sampler2D depthTexture;\r\nuniform vec2      srcTexelSize;\r\n\r\nuniform mat4  projMatrix;\r\nuniform float aspectRatio;\r\nuniform float tanHalfFOV;\r\n\r\n#ifdef USE_FOG\r\n  uniform vec2 fogNearFar;\r\n  uniform vec4 fogColor;\r\n#endif\r\nvarying vec2 vUv;\r\n\r\nfloat CalcViewZ(vec2 screenPos)\r\n{\r\n  float depth = texture2D(depthTexture, screenPos).x;\r\n  // [0, 1]->[-1, 1]\r\n  float clipedZ = 2.0 * depth - 1.0;\r\n  // see THREE.js camera.makeFrustum for projection details\r\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r\n}\r\n\r\nvec3 ViewPosFromDepth(vec2 screenPos)\r\n{\r\n  vec3 viewPos;\r\n  viewPos.z = CalcViewZ(screenPos);\r\n  //[0, 1]->[-1, 1]\r\n  vec2 projPos = 2.0 * screenPos - 1.0;\r\n  // reconstruct viewposition in right-handed sc with z to viewer\r\n  viewPos.xy = vec2(\r\n  projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r\n  projPos.y * tanHalfFOV * abs(viewPos.z)\r\n  );\r\n  return viewPos;\r\n}\r\n\r\nvoid main() {\r\n  vec3 viewPos = ViewPosFromDepth(vUv);\r\n  float x = vUv.x;\r\n  float y = vUv.y;\r\n  vec4 color = texture2D(diffuseTexture, vec2(x, y));\r\n  vec4 res = vec4(0.0);\r\n  res.a = texture2D(aoMap, vec2(x, y )).a;\r\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\r\n  if (res.a < EPSILON) {\r\n    gl_FragColor = color;\r\n    return;\r\n  }\r\n\r\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r\n  float weightSum = 0.0;\r\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r\n    if (texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).a < EPSILON) {\r\n      continue;\r\n    }\r\n    vec2 samplePos = vec2(x, y + samplesOffsets[i] * srcTexelSize.y);\r\n    float depth = texture2D(depthTexture, samplePos).x;\r\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r\n    res.rgb += texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).rgb * weight;\r\n    weightSum += weight;\r\n  }\r\n  res.rgb /= weightSum;\r\n\r\n  #if defined(USE_FOG) && !defined(FOG_TRANSPARENT)\r\n    // Add fog to the result value\r\n    // Proper way to get an image with fog and ao requires formula:\r\n    //          gl_FragColor = fragColor*AO*(1-fogFactor) + fogColor*fogFactor\r\n    // But we have already fogged molecule to add AO too. Let's split the straight formula into our real steps!\r\n    // We have:  AO, fogFactor, fogColor,\r\n    //          color = fragColor*(1-fogFactor) + fogColor*fogFactor (it comes from diffuseTexture,\r\n    //                                                                where molecule has been already drawn with fog)\r\n    // Transform:\r\n    //          fragColor*AO*(1-fogFactor) + fogColor*fogFactor =\r\n    //        = [fragColor*(1-fogFactor) = color - fogColor*fogFactor] =\r\n    //        = (color - fogColor*fogFactor)*AO + fogColor*fogFactor =\r\n    //        = color*AO + fogColor*fogFactor*(1 - AO)\r\n    // Result:  gl_FragColor = color*AO + fogColor*fogFactor*(1 - AO)\r\n    float fogFactor = smoothstep(fogNearFar.x, fogNearFar.y, - viewPos.z) * fogColor.a;\r\n    gl_FragColor.rgb = color.rgb * res.rgb + fogColor.rgb * fogFactor *(vec3(1.0, 1.0, 1.0) - res.rgb);\r\n  #else\r\n    gl_FragColor.rgb = color.rgb * res.rgb;\r\n  #endif\r\n  gl_FragColor.a = color.a;\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1}),this.setValues(e)}setValues(e){if(void 0===e)return;super.setValues(e);const t={};this.useFog&&(t.USE_FOG=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.defines=t}}Ph.prototype.useFog=!0,Ph.prototype.fogTransparent=!1;const Nh=Ph;class Lh extends r.RawShaderMaterial{constructor(){super();const e={uniforms:{srcL:{type:"t",value:null},srcR:{type:"t",value:null}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n\r\nuniform sampler2D srcL;\r\nuniform sampler2D srcR;\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vec4 l = texture2D(srcL, vUv);\r\n  vec4 r = texture2D(srcR, vUv);\r\n  gl_FragColor = vec4(l.r, r.g, r.b, 1.0);\r\n}\r\n",transparent:!1,depthTest:!1,depthWrite:!1};this.setValues(e)}}const Ih=Lh;class Oh{constructor(){this.position=new r.Vector3(0,0,0),this.scale=1,this.orientation=new r.Quaternion(0,0,0,1)}set(e,t,r){this.position=e,this.scale=t,this.orientation=r}}class Vh{setup(e,t){this._startTime=void 0,this._endTime=void 0,this._isPaused=!1,this._srcView=e,this._dstView=t,this._isMoving=!1}isMoving(){return this._isMoving}wasStarted(){return void 0!==this._startTime&&void 0!==this._endTime}start(){this._startTime=Date.now();const e=z.now.interpolateViews?1500:0;this._endTime=this._startTime+e,this._isMoving=!0}getCurrentView(){if(void 0===this._srcView||void 0===this._dstView||!this._isMoving||!this.wasStarted())return{success:!1};let e=this.createView();const t=Date.now();if(t>this._endTime)return e=this._dstView,this.reset(),{success:!0,view:e};const r=(t-this._startTime)/(this._endTime-this._startTime);return e.position.copy(this._srcView.position),e.position.lerp(this._dstView.position,r),e.scale=(1-r)*this._srcView.scale+r*this._dstView.scale,e.orientation.copy(this._srcView.orientation),e.orientation.slerp(this._dstView.orientation,r),{success:!0,view:e}}reset(){this._startTime=this._endTime=0,this._isMoving=!1}pause(){this._isPaused||(this.setup(this.getCurrentView().view,this._dstView),this._isPaused=!0)}resume(){this._isPaused=!1}createView(){return new Oh}}function Dh(e,r){this.context=e,this._opts=t().merge({path:"/"},r)}ur(Dh.prototype),Dh.prototype.removeCookie=function(e){const t=this._toCount(e);let r=this._getSimpleCookie(t);if(r){this._removeSimpleCookie(t),r=parseInt(r,10);for(let t=0;t<r;++t)this._removeSimpleCookie(e+t)}else this._removeSimpleCookie(e)},Dh.prototype.setCookie=function(e,t){this.removeCookie(e);const r=function(e,t){const r=e.length,n=[];for(let s=0,i=0;i<r;s++,i+=t)n[s]=e.slice(i,i+t);return n}(t=encodeURIComponent(t),4e3-e.length-1),n=r.length;if(1===n)return void this._setSimpleCookie(e,t);const s=this._toCount(e);this._setSimpleCookie(s,n.toString());for(let t=0;t<n;++t)this._setSimpleCookie(e+t,r[t])},Dh.prototype.getCookie=function(e){const t=this._toCount(e);let r=this._getSimpleCookie(t);if(!r)return this._getSimpleCookie(e);r=parseInt(r,10);const n=[];for(let t=0;t<r;++t)n[t]=this._getSimpleCookie(e+t);return n.join("")},Dh.prototype._toCount=function(e){return e+"Cnt"},Dh.prototype._removeSimpleCookie=function(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:01 GMT;`},Dh.prototype._getExpirationDate=function(){const e=new Date;return e.setFullYear(e.getFullYear()+10),e},Dh.prototype._setSimpleCookie=function(e,t){document.cookie=`${e}=${t};expires=${this._getExpirationDate().toUTCString()};path=${this._opts.path}`},Dh.prototype._getSimpleCookie=function(e){const t=document.cookie.match(new RegExp(`(?:^|; )${e}=([^;]*)`));return t?decodeURIComponent(t[1]):""},Dh.prototype._exists=function(e){return document.cookie.match(new RegExp(`(?:^|; )${e}=([^;]*)`))};const kh=Dh;function zh(e){function t(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="transparent",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator){const r=document.createElement("button");return r.style.display="none",t(r),navigator.xr.isSessionSupported("immersive-vr").then((t=>t?function(t){t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR";let r=null;function n(){r.removeEventListener("end",n),t.textContent="ENTER VR",r=null}function s(s){s.addEventListener("end",n),e._gfx.renderer.xr.setReferenceSpaceType("local"),e._gfx.renderer.xr.setSession(s),t.textContent="EXIT VR",r=s}t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){if(null===r){const t={optionalFeatures:["local-floor","bounded-floor"]};navigator.xr.requestSession("immersive-vr",t).then(s),e.moveSceneBehindHeadset()}else r.end()}}(r):function(e){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.textContent="VR NOT FOUND",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}(r))),r}const r=document.createElement("a");return r.href="https://webvr.info",r.innerHTML="WEBXR NOT SUPPORTED",r.style.left="calc(50% - 90px)",r.style.width="180px",r.style.textDecoration="none",t(r),r}class Fh{constructor(e){this._mainCamera=new r.PerspectiveCamera,this._button=null,this._onToggle=e,this._molContainer=new sr.RCGroup,this._user=new sr.RCGroup,this._scalingPivot=new r.Object3D,this._user.add(this._scalingPivot),this._controller1=null,this._controller2=null,this._pressedGripsCounter=0,this._distance=0,this._gfx=null}startScalingByControllers(){this._distance=this._controller1.position.distanceTo(this._controller2.position),sr.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),this._scalingPivot.scale.set(1,1,1),this._scalingPivot.updateMatrix(),this._scalingPivot.updateMatrixWorld(),this._scalingPivot.addSavingWorldTransform(this._molContainer)}stopScalingByControllers(){this._gfx.scene.addSavingWorldTransform(this._molContainer)}handleGripsDown(e){this._pressedGripsCounter++,2===this._pressedGripsCounter?this.startScalingByControllers():1===this._pressedGripsCounter&&e.target.addSavingWorldTransform(this._molContainer)}handleGripsUp(e){if(this._pressedGripsCounter--,1===this._pressedGripsCounter){this.stopScalingByControllers();(e.target===this._controller1?this._controller2:this._controller1).addSavingWorldTransform(this._molContainer)}else 0===this._pressedGripsCounter&&this._gfx.scene.addSavingWorldTransform(this._molContainer)}enable(e){if(!e)return void w.warn("WebVR couldn't be enabled, because gfx is not defined");this._gfx=e;const{renderer:t,camera:r}=e;if(!t)throw new Error("No renderer is available to toggle WebVR");if(!r)throw new Error("No camera is available to toggle WebVR");t.xr.enabled=!0,this._button?this._button.style.display="block":(this._button=zh(this),document.body.appendChild(this._button)),this._mainFog=z.now.fog,z.set("fog",!1),this._plugVRNodesIntoScene(e,t),this._setControllersListeners(),this._onToggle&&this._onToggle(!0)}_plugVRNodesIntoScene(e,t){this._mainCamera.copy(e.camera),e.scene.add(this._user),e.scene.add(this._molContainer),this._molContainer.add(e.root),this._controller1=t.xr.getController(0),this._controller2=t.xr.getController(1);const r=this._createControllerMesh();this._controller1.add(r),this._controller2.add(r.clone()),this._user.add(this._controller1),this._user.add(this._controller2)}_setControllersListeners(){this._controller1.addEventListener("selectstart",(e=>{this.handleGripsDown(e)})),this._controller1.addEventListener("selectend",(e=>{this.handleGripsUp(e)})),this._controller2.addEventListener("selectstart",(e=>{this.handleGripsDown(e)})),this._controller2.addEventListener("selectend",(e=>{this.handleGripsUp(e)})),this._controller1.addEventListener("squeezestart",(e=>{this.handleGripsDown(e)})),this._controller1.addEventListener("squeezeend",(e=>{this.handleGripsUp(e)})),this._controller2.addEventListener("squeezestart",(e=>{this.handleGripsDown(e)})),this._controller2.addEventListener("squeezeend",(e=>{this.handleGripsUp(e)}))}disable(){if(!this._gfx)return;const{renderer:e,camera:t}=this._gfx;if(!e)throw new Error("No renderer is available to toggle WebVR");e.setAnimationLoop(null);const r=e.xr.getSession();r&&r.end(),e.xr.enabled=!1,this._button&&(this._button.style.display="none"),z.set("fog",this._mainFog),this._unplugVRNodesFromScene(t),this._onToggle&&this._onToggle(!1)}_unplugVRNodesFromScene(e){this._mainCamera&&e&&e.copy(this._mainCamera);const t=this._molContainer.children[0];t&&this._gfx.scene.add(t),this._molContainer.parent.remove(this._molContainer),this._user&&this._gfx.scene.remove(this._user),this._molContainer=null,this._user=null,this._scalingPivot=null,this._user=null,this._controller1=null,this._controller2=null}_createControllerMesh(){const e=new r.CylinderGeometry(.04,.04,.3),t=new Jn({lights:!1,overrideColor:!0});t.setUberOptions({fixedColor:new r.Color(4474111)}),t.updateUniforms();const n=new r.Mesh(e,t);return n.rotateX(-Math.PI/2),n}updateMoleculeScale(){if(!this._controller1||!this._controller2)return;const e=this;if(2===e._pressedGripsCounter){sr.getMiddlePoint(e._controller1.position,e._controller2.position,e._scalingPivot.position);const t=e._controller1.position.distanceTo(e._controller2.position),r=t/e._distance;e._scalingPivot.scale.multiplyScalar(r),e._distance=t}}moveSceneBehindHeadset(){const e=this._gfx,{camera:t}=e,r=this._molContainer;r.matrix.identity(),r.position.set(0,0,-4),r.updateMatrix(),r.matrixWorld.multiplyMatrices(t.matrixWorld,r.matrix),e.scene.addSavingWorldTransform(r),this._onToggle&&this._onToggle(!0)}getCanvas(){const e=this._gfx;return e&&e.renderer?e.renderer.domElement:null}}const{selectors:Bh,Atom:Uh,Residue:Gh,Chain:jh,Molecule:Hh}=Yt,$h=0,Wh=1,Yh=2,Xh="Could not find suitable loader for this source";r.ColorManagement.enabled=!1;const{createElement:qh}=O;function Zh(e){const t=e.lastIndexOf(".");return t>=0&&(e=e.substr(0,t)),e}function Kh(e,t,r){void 0!==r?e.debug(`${t}... ${Math.floor(100*r)}%`):e.debug(`${t}...`)}function Qh(){return z.now.fogColorEnable?z.now.fogColor:z.now.bg.color}function Jh(e){g.call(this),this._opts=t().merge({settingsCookie:"settings",cookiePath:"/"},e),this._gfx=null,this._interpolator=new Vh,this._container=e&&e.container||document.getElementById("miew-container")||t().head(document.getElementsByClassName("miew-container"))||document.body,this._containerRoot=this._container,this._running=!1,this._halting=!1,this._building=!1,this._needRender=!0,this._hotKeysEnabled=!0,this.settings=z;const r=w;r.console=!1,r.level="info",this.logger=r,this._cookies=new kh(this),this.restoreSettings(),e&&e.settings&&this.settings.set(e.settings),this._spinner=null,this._loading=[],this._animInterval=null,this._visuals={},this._curVisualName=null,this._objects=[],this._sourceWindow=null,this.reset(),this._repr&&r.debug(`Selected ${this._repr.mode.name} mode with ${this._repr.colorer.name} colorer.`);const n=this;Jh.registeredPlugins.forEach((e=>{e.call(n)})),this._initOnSettingsChanged()}function eu(e,t){const r=e;for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(t)}function tu(e){return e.getExtension("EXT_frag_depth")}function ru(e){return e.getExtension("WEBGL_depth_texture")&&e.getExtension("WEBGL_draw_buffers")}Jh.prototype=Object.create(g.prototype),Jh.prototype.constructor=Jh,Jh.prototype.getMaxRepresentationCount=function(){return Qo.NUM_REPRESENTATION_BITS},Jh.prototype._updateShadowCamera=function(){const e=new r.Matrix4,t=new r.Vector3,n={center:new r.Vector3,halfSize:new r.Vector3};return function(){this._gfx.scene.updateMatrixWorld();for(let r=0;r<this._gfx.scene.children.length;r++)if("DirectionalLight"===this._gfx.scene.children[r].type){const s=this._gfx.scene.children[r];e.copy(s.shadow.camera.matrixWorldInverse),this.getOBB(e,n),t.subVectors(s.target.position,s.position),s.position.subVectors(n.center,t),s.target.position.copy(n.center),s.shadow.bias=.09,s.shadow.camera.bottom=-n.halfSize.y,s.shadow.camera.top=n.halfSize.y,s.shadow.camera.right=n.halfSize.x,s.shadow.camera.left=-n.halfSize.x,s.shadow.camera.near=t.length()-n.halfSize.z,s.shadow.camera.far=t.length()+n.halfSize.z,s.shadow.camera.updateProjectionMatrix()}}}(),Jh.prototype.init=function(){const e=this._container,t=O.createElement("div",{class:"miew-canvas"});eu(e,t),this._container=t;const r=document.createDocumentFragment();if(r.appendChild(this._msgMode=qh("div",{class:"mode-message overlay"},qh("p",{},"COMPONENT EDIT MODE"))),r.appendChild(this._msgAtomInfo=qh("div",{class:"atom-info overlay"},qh("p",{},""))),e.appendChild(r),null!==this._gfx)return!0;const n=this;this._showMessage("Viewer is being initialized...");try{this._initGfx(),this._initListeners(),this._spinner=new a({lines:13,length:28,width:14,radius:42,color:"#fff",zIndex:700});const e=qc();e.addEventListener("keydown",(e=>{n._onKeyDown(e)})),e.addEventListener("keyup",(e=>{n._onKeyUp(e)})),this._objectControls=new ih(this._gfx.root,this._gfx.pivot,this._gfx.camera,this._gfx.renderer.domElement,(()=>n._getAltObj())),this._objectControls.addEventListener("change",(e=>{switch(z.now.shadow.on&&n._updateShadowCamera(),e.action){case"rotate":n.dispatchEvent({type:"rotate",quaternion:e.quaternion});break;case"zoom":n.dispatchEvent({type:"zoom",factor:e.factor});break;default:n.dispatchEvent({type:e.action})}n.dispatchEvent({type:"transform"}),n._needRender=!0}));const t=this._gfx;this._picker=new ah(t.root,t.camera,t.renderer.domElement),this._picker.addEventListener("newpick",(e=>{n._onPick(e)})),this._picker.addEventListener("dblclick",(e=>{n.center(e)}))}catch(e){if("TypeError"===e.name&&"Cannot read property 'getExtension' of null"===e.message)this._showMessage("Could not create WebGL context.");else{if(!(e.message.search(/webgl/i)>1))throw this._showMessage("Viewer initialization failed."),e;this._showMessage(e.message)}return!1}const s=this._opts&&this._opts.load;if(s){const e=this._opts&&this._opts.type;this.load(s,{fileType:e,keepRepsInfo:!0})}return!0},Jh.prototype.term=function(){this._showMessage("Viewer has been terminated."),this._loading.forEach((e=>{e.cancel()})),this._loading.length=0,this.halt(),this._gfx=null},Jh.prototype._showMessage=function(e){const t=document.createElement("div");t.setAttribute("class","miew-message"),t.appendChild(document.createElement("p")).appendChild(document.createTextNode(e)),eu(this._container,t)},Jh.prototype._showCanvas=function(){eu(this._container,this._gfx.renderer.domElement)},Jh.prototype._requestAnimationFrame=function(e){const{xr:t}=this._gfx.renderer;t&&t.enabled?this._gfx.renderer.setAnimationLoop(e):requestAnimationFrame(e)},Jh.prototype._initGfx=function(){const e={width:this._container.clientWidth,height:this._container.clientHeight},t={preserveDrawingBuffer:!0,alpha:!0,premultipliedAlpha:!1};z.now.antialias&&(t.antialias=!0),e.renderer2d=new Xc,e.renderer=new r.WebGL1Renderer(t),e.renderer.shadowMap.enabled=z.now.shadow.on,e.renderer.shadowMap.autoUpdate=!1,e.renderer.shadowMap.type=r.PCFShadowMap,Fn.init(e.renderer),tu(e.renderer.getContext())||z.set("zSprites",!1),ru(e.renderer.getContext())||z.set("ao",!1),e.renderer.autoClear=!1,e.renderer.setPixelRatio(window.devicePixelRatio),e.renderer.setSize(e.width,e.height),e.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent)),e.renderer.clearColor(),e.renderer2d.setSize(e.width,e.height),e.camera=new r.PerspectiveCamera(z.now.camFov,e.width/e.height,z.now.camNear,z.now.camFar),e.camera.setMinimalFov(z.now.camFov),e.camera.position.z=z.now.camDistance,e.camera.updateProjectionMatrix(),e.camera.layers.set(sr.LAYERS.DEFAULT),e.camera.layers.enable(sr.LAYERS.VOLUME),e.camera.layers.enable(sr.LAYERS.VOLUME_BFPLANE),e.stereoCam=new r.StereoCamera,e.scene=new r.Scene;const n=Qh();e.scene.fog=new r.Fog(n,z.now.camNear,z.now.camFar),e.root=new sr.RCGroup,e.scene.add(e.root),e.pivot=new sr.RCGroup,e.root.add(e.pivot),e.selectionScene=new r.Scene,e.selectionRoot=new r.Group,e.selectionRoot.matrixAutoUpdate=!1,e.selectionScene.add(e.selectionRoot),e.selectionPivot=new r.Group,e.selectionPivot.matrixAutoUpdate=!1,e.selectionRoot.add(e.selectionPivot);const s=new r.DirectionalLight(16777215,.45);s.position.set(0,.414,1),s.layers.enable(sr.LAYERS.TRANSPARENT),s.castShadow=!0,s.shadow.bias=.09,s.shadow.radius=z.now.shadow.radius,s.shadow.camera.layers.set(sr.LAYERS.SHADOWMAP);const i=e.renderer.getPixelRatio(),o=Math.max(e.width,e.height)*i;s.shadow.mapSize.width=o,s.shadow.mapSize.height=o,s.target.position.set(0,0,0),e.scene.add(s),e.scene.add(s.target);const a=new r.AmbientLight(6710886);a.layers.enable(sr.LAYERS.TRANSPARENT),e.scene.add(a),e.axes=new lh(e.root,e.camera);const l=e.width*i,c=e.height*i;e.offscreenBuf=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.NearestFilter,format:r.RGBAFormat,depthBuffer:!0}),e.renderer.getContext().getExtension("WEBGL_depth_texture")&&(e.offscreenBuf.depthTexture=new r.DepthTexture,e.offscreenBuf.depthTexture.type=r.UnsignedShortType),e.offscreenBuf2=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!1}),e.offscreenBuf3=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!1}),e.offscreenBuf4=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!1}),e.volBFTex=e.offscreenBuf3,e.volFFTex=e.offscreenBuf4,e.volWFFTex=e.offscreenBuf,e.renderer.getContext().getExtension("OES_texture_float")?(e.offscreenBuf5=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,type:r.FloatType,depthBuffer:!1}),e.offscreenBuf6=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,type:r.FloatType,depthBuffer:!1}),e.offscreenBuf7=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,type:r.FloatType,depthBuffer:!0}),e.volBFTex=e.offscreenBuf5,e.volFFTex=e.offscreenBuf6,e.volWFFTex=e.offscreenBuf7):this.logger.warn("Device doesn't support OES_texture_float extension"),e.stereoBufL=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!1}),e.stereoBufR=new r.WebGLRenderTarget(l,c,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!1}),this._gfx=e,this._showCanvas(),this._embedWebXR("WEBVR"===z.now.stereo),this._container.appendChild(e.renderer2d.getElement());const h=new m;h.domElement.style.position="absolute",h.domElement.style.right="0",h.domElement.style.bottom="0",this._container.appendChild(h.domElement),this._fps=h,this._fps.show(z.now.fps)},Jh.prototype._initListeners=function(){const e=this;window.addEventListener("resize",(()=>{e._onResize()}))},Jh.prototype._makeUniqueVisualName=function(e){if(!e)return Math.random().toString();let t=e,r=1;for(;this._visuals.hasOwnProperty(t);)t=`${e} (${r.toString()})`,r++;return t},Jh.prototype._addVisual=function(e){if(!e)return null;const t=this._makeUniqueVisualName(e.name);return e.name=t,this._visuals[t]=e,this._gfx.pivot.add(e),e.getSelectionGeo&&this._gfx.selectionPivot.add(e.getSelectionGeo()),t},Jh.prototype._removeVisual=function(e){let t="",r=null;e instanceof ar?(({name:t}=e),r=e):"string"==typeof e&&(t=e,r=this._visuals[t]),r&&this._visuals.hasOwnProperty(t)&&this._visuals[t]===r&&(t===this._curVisualName&&(this._curVisualName=void 0),delete this._visuals[t],r.release(),this._needRender=!0)},Jh.prototype._forEachVisual=function(e){for(const t in this._visuals)this._visuals.hasOwnProperty(t)&&e(this._visuals[t])},Jh.prototype._releaseAllVisuals=function(){if(this._gfx&&this._gfx.pivot){for(const e in this._visuals)this._visuals.hasOwnProperty(e)&&this._visuals[e].release();this._visuals={}}},Jh.prototype._forEachComplexVisual=function(e){if(this._gfx&&this._gfx.pivot)for(const t in this._visuals)this._visuals.hasOwnProperty(t)&&this._visuals[t]instanceof Qo&&e(this._visuals[t])},Jh.prototype._getComplexVisual=function(e){e=e||this._curVisualName;let t=null,r=null;return this._forEachComplexVisual((n=>{t=n,n.name===e&&(r=n)})),r||t},Jh.prototype._getVolumeVisual=function(){let e=null;return this._forEachVisual((t=>{t instanceof pa&&(e=t)})),e},Jh.prototype._getVisualForComplex=function(e){if(!e)return null;let t=null;return this._forEachComplexVisual((r=>{r.getComplex()===e&&(t=r)})),t},Jh.prototype.getVisuals=function(){return Object.keys(this._visuals)},Jh.prototype.getComplexVisualsCount=function(){let e=0;return this._forEachComplexVisual((()=>e++)),e},Jh.prototype.getCurrentVisual=function(){return this._curVisualName},Jh.prototype.setCurrentVisual=function(e){this._visuals[e]&&(this._curVisualName=e)},Jh.prototype.run=function(){if(!this._running){if(this._running=!0,this._halting)return void(this._halting=!1);this._objectControls.enable(!0),this._interpolator.resume(),this._requestAnimationFrame((()=>this._onTick()))}},Jh.prototype.halt=function(){this._running&&(this._discardComponentEdit(),this._discardFragmentEdit(),this._objectControls.enable(!1),this._interpolator.pause(),this._halting=!0)},Jh.prototype.enableHotKeys=function(e){this._hotKeysEnabled=e,this._objectControls.enableHotkeys(e)},Jh.prototype._onResize=function(){const e=this._gfx;e&&(this._needRender=!0,e.width=this._container.clientWidth,e.height=this._container.clientHeight,e.camera.aspect=e.width/e.height,e.camera.setMinimalFov(z.now.camFov),e.camera.updateProjectionMatrix(),e.renderer.setSize(e.width,e.height),e.renderer2d.setSize(e.width,e.height),this.dispatchEvent({type:"resize"}))},Jh.prototype._resizeOffscreenBuffers=function(e,t,r){const n=this._gfx,s="NONE"===(r=r||"NONE")||"ANAGLYPH"===r,i=s?1:.5;n.offscreenBuf.setSize(i*e,t),n.offscreenBuf2.setSize(i*e,t),n.offscreenBuf3.setSize(i*e,t),n.offscreenBuf4.setSize(i*e,t),n.offscreenBuf5&&n.offscreenBuf5.setSize(i*e,t),n.offscreenBuf6&&n.offscreenBuf6.setSize(i*e,t),n.offscreenBuf7&&n.offscreenBuf7.setSize(i*e,t),s&&(n.stereoBufL.setSize(e,t),n.stereoBufR.setSize(e,t))},Jh.prototype._onTick=function(){if(this._halting)return this._running=!1,void(this._halting=!1);this._fps.update(),this._requestAnimationFrame((()=>this._onTick())),this._onUpdate(),this._needRender&&(this._onRender(),this._needRender=!z.now.suspendRender||"WEBVR"===z.now.stereo)},Jh.prototype._getBSphereRadius=function(){let e=0;return this._forEachVisual((t=>{e=Math.max(e,t.getBoundaries().boundingSphere.radius)})),e*this._objectControls.getScale()},Jh.prototype.getOBB=function(){const e=new r.Sphere,t=new r.Box3,n=new r.Box3,s=new r.Matrix4,i=[new r.Vector3,new r.Vector3,new r.Vector3,new r.Vector3];return function(r,o){n.makeEmpty(),this._forEachVisual((s=>{e.copy(s.getBoundaries().boundingSphere),e.applyMatrix4(s.matrixWorld).applyMatrix4(r),e.getBoundingBox(t),n.union(t)})),n.getCenter(o.center),s.copy(r).invert(),o.center.applyMatrix4(s);const{min:a}=n,{max:l}=n;i[0].set(a.x,a.y,a.z),i[1].set(l.x,a.y,a.z),i[2].set(a.x,l.y,a.z),i[3].set(a.x,a.y,l.z);for(let e=0,t=i.length;e<t;e++)i[e].applyMatrix4(s);o.halfSize.set(Math.abs(i[0].x-i[1].x),Math.abs(i[0].y-i[2].y),Math.abs(i[0].z-i[3].z)).multiplyScalar(.5)}}(),Jh.prototype._updateFog=function(){const e=this._gfx;if(z.now.fog){if(void 0===e.scene.fog||null===e.scene.fog){const t=Qh();e.scene.fog=new r.Fog(t),this._setUberMaterialValues({fog:z.now.fog})}t=e.scene.fog,n=e.camera.position.z,s=this._getBSphereRadius(),t.near=n-s*z.now.fogNearFactor,t.far=n+s*z.now.fogFarFactor}else e.scene.fog&&(e.scene.fog=void 0,this._setUberMaterialValues({fog:z.now.fog}));var t,n,s},Jh.prototype._onUpdate=function(){void 0!==this.isScriptingCommandAvailable&&this.isScriptingCommandAvailable()&&!this._building&&this.callNextCmd(),this._objectControls.update(),this._forEachComplexVisual((e=>{e.getComplex().update()})),z.now.autobuild&&!this._loading.length&&!this._building&&this._needRebuild()&&this.rebuild(),this._loading.length||this._building||this._needRebuild()||this._updateView(),this._updateFog(),this._gfx.renderer.xr.enabled&&this.webVR.updateMoleculeScale()},Jh.prototype._onRender=function(){const e=this._gfx;e.scene.updateMatrixWorld(),e.camera.updateMatrixWorld(),this._clipPlaneUpdateValue(this._getBSphereRadius()),this._fogFarUpdateValue(),e.renderer.setRenderTarget(null),e.renderer.clear(),this._renderFrame(z.now.stereo)},Jh.prototype._renderFrame=function(){const e=new Ih,t=new r.Vector2;return function(r){const n=this._gfx,{renderer:s}=n;s.getSize(t),"NONE"!==r&&(n.camera.focus=n.camera.position.z,n.stereoCam.aspect=1,"ANAGLYPH"===r?n.stereoCam.update(n.camera):n.stereoCam.updateHalfSized(n.camera,z.now.camFov));const i=n.renderer.getPixelRatio();switch(this._resizeOffscreenBuffers(t.width*i,t.height*i,r),this._renderShadowMap(),r){case"WEBVR":case"NONE":this._renderScene(n.camera,!1);break;case"SIMPLE":case"DISTORTED":s.setScissorTest(!0),s.setScissor(0,0,t.width/2,t.height),s.setViewport(0,0,t.width/2,t.height),this._renderScene(this._gfx.stereoCam.cameraL,"DISTORTED"===r),s.setScissor(t.width/2,0,t.width/2,t.height),s.setViewport(t.width/2,0,t.width/2,t.height),this._renderScene(this._gfx.stereoCam.cameraR,"DISTORTED"===r),s.setScissorTest(!1);break;case"ANAGLYPH":this._renderScene(this._gfx.stereoCam.cameraL,!1,n.stereoBufL),this._renderScene(this._gfx.stereoCam.cameraR,!1,n.stereoBufR),s.setRenderTarget(null),e.uniforms.srcL.value=n.stereoBufL.texture,e.uniforms.srcR.value=n.stereoBufR.texture,n.renderer.renderScreenQuad(e)}n.renderer2d.render(n.scene,n.camera),z.now.axes&&n.axes&&!n.renderer.xr.enabled&&n.axes.render(s)}}(),Jh.prototype._onBgColorChanged=function(){const e=this._gfx,t=Qh();e&&(e.scene.fog&&e.scene.fog.color.set(t),e.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent))),this._needRender=!0},Jh.prototype._onFogColorChanged=function(){const e=this._gfx,t=Qh();e&&e.scene.fog&&e.scene.fog.color.set(t),this._needRender=!0},Jh.prototype._setUberMaterialValues=function(e){this._gfx.root.traverse((t=>{(t instanceof r.Mesh||t instanceof r.LineSegments||t instanceof r.Line)&&t.material instanceof Jn&&(t.material.setValues(e),t.material.needsUpdate=!0)}))},Jh.prototype._enableMRT=function(e,t,r){const n=this._gfx,s=n.renderer.getContext(),i=s.getExtension("WEBGL_draw_buffers"),{properties:o}=n.renderer;if(!e)return void i.drawBuffersWEBGL([s.COLOR_ATTACHMENT0,null]);n.renderer.setRenderTarget(r);const a=o.get(r.texture).__webglTexture;s.bindTexture(s.TEXTURE_2D,a),n.renderer.setRenderTarget(t);const l=o.get(t).__webglFramebuffer,c=o.get(t.texture).__webglTexture;s.bindFramebuffer(s.FRAMEBUFFER,l),l.width=t.width,l.height=t.height,s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,c,0),s.framebufferTexture2D(s.FRAMEBUFFER,i.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,a,0),i.drawBuffersWEBGL([s.COLOR_ATTACHMENT0,i.COLOR_ATTACHMENT1_WEBGL])},Jh.prototype._renderScene=function(e,t,r){t=t||!1,r=r||null;const n=this._gfx;if(n.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent)),n.renderer.setRenderTarget(r),n.renderer.clear(),n.renderer.xr.enabled)return void n.renderer.render(n.scene,e);n.renderer.setClearColor(0,0),n.renderer.setRenderTarget(n.offscreenBuf4),n.renderer.clearColor(),n.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent)),n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.clear();const s=null!==this._getComplexVisual(),i=this._getVolumeVisual(),o=s&&z.now.ao;o&&this._enableMRT(!0,n.offscreenBuf,n.offscreenBuf4),"prepass"===z.now.transparency?this._renderWithPrepassTransparency(e,n.offscreenBuf):"standard"===z.now.transparency&&(n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.render(n.scene,e)),o&&this._enableMRT(!1,null,null);const a=s&&z.now.outline.on,l=s&&z.now.fxaa,c=null!==i&&null!=i.getMesh().material;let h=o||a||c||l||t?n.offscreenBuf2:r,u=n.offscreenBuf;o?(this._performAO(u,n.offscreenBuf4,n.offscreenBuf.depthTexture,h,n.offscreenBuf3,n.offscreenBuf2),l||t||c||a||(u=h,h=r,n.renderer.setRenderTarget(h),n.renderer.renderScreenQuadFromTex(u.texture,1))):(n.renderer.setRenderTarget(h),n.renderer.renderScreenQuadFromTex(u.texture,1)),a&&(u=h,h=c||l||t?n.offscreenBuf3:r,null!=u&&this._renderOutline(e,n.offscreenBuf,u,h)),this._renderSelection(e,n.offscreenBuf,h),c&&(n.renderer.setRenderTarget(n.offscreenBuf),n.renderer.renderScreenQuadFromTex(h.texture,1),h=n.offscreenBuf,this._renderVolume(i,e,h,n.volBFTex,n.volFFTex,n.volWFFTex),l||t||(n.renderer.setRenderTarget(r),n.renderer.renderScreenQuadFromTex(h.texture,1))),u=h,l&&(h=t?n.offscreenBuf4:r,this._performFXAA(u,h),u=h),t&&(h=r,this._performDistortion(u,h,!0))},Jh.prototype._performDistortion=function(){const e=new r.Scene,t=new r.OrthographicCamera(-1,1,1,-1,-500,1e3),n=new r.RawShaderMaterial({uniforms:{srcTex:{type:"t",value:null},aberration:{type:"fv3",value:new r.Vector3(1)}},vertexShader:Qt,fragmentShader:"precision highp float;\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D srcTex;\r\nuniform vec3 aberration;\r\n\r\nvoid main() {\r\n  vec2 uv = vUv * 2.0 - 1.0;\r\n  \r\n  gl_FragColor.r = texture2D(srcTex, 0.5 * (uv * aberration[0] + 1.0)).r;\r\n  gl_FragColor.g = texture2D(srcTex, 0.5 * (uv * aberration[1] + 1.0)).g;\r\n  gl_FragColor.b = texture2D(srcTex, 0.5 * (uv * aberration[2] + 1.0)).b;\r\n  gl_FragColor.a = 1.0;\r\n}",transparent:!1,depthTest:!1,depthWrite:!1}),s=sr.buildDistorionMesh(10,10,z.now.debug.stereoBarrel);return e.add(new fs.Mesh(s,n)),function(r,s,i){this._gfx.renderer.setRenderTarget(s),this._gfx.renderer.clear(),i?(n.uniforms.srcTex.value=r.texture,n.uniforms.aberration.value.set(.995,1,1.01),this._gfx.renderer.render(e,t)):this._gfx.renderer.renderScreenQuadFromTexWithDistortion(r,z.now.debug.stereoBarrel)}}(),Jh.prototype._renderOutline=function(){const e=new bh({depth:!0});return function(t,n,s,i){const o=this._gfx;e.uniforms.srcTex.value=s.texture,e.uniforms.srcDepthTex.value=n.depthTexture,e.uniforms.srcTexSize.value.set(n.width,n.height),e.uniforms.color.value=new r.Color(z.now.outline.color),e.uniforms.threshold.value=z.now.outline.threshold,e.uniforms.thickness.value=new r.Vector2(z.now.outline.thickness,z.now.outline.thickness),o.renderer.setRenderTarget(i),o.renderer.renderScreenQuad(e)}}(),Jh.prototype._renderShadowMap=function(){const e={minFilter:r.NearestFilter,magFilter:r.NearestFilter,format:r.RGBAFormat};return function(){if(!z.now.shadow.on)return;const t=this._gfx,n=t.renderer.getRenderTarget(),s=t.renderer.getActiveCubeFace(),i=t.renderer.getActiveMipmapLevel(),o=t.renderer.state;o.setBlending(r.NoBlending),o.buffers.color.setClear(1,1,1,1),o.buffers.depth.setTest(!0),o.setScissorTest(!1);for(let n=0;n<t.scene.children.length;n++)if("DirectionalLight"===t.scene.children[n].type){const s=t.scene.children[n];null==s.shadow.map&&(s.shadow.map=new r.WebGLRenderTarget(s.shadow.mapSize.width,s.shadow.mapSize.height,e),s.shadow.camera.updateProjectionMatrix()),s.shadow.updateMatrices(s),t.renderer.setRenderTarget(s.shadow.map),t.renderer.clear(),t.renderer.render(t.scene,s.shadow.camera)}t.renderer.setRenderTarget(n,s,i)}}(),Jh.prototype._hasSelectionToRender=function(){const e=this._gfx.selectionPivot;for(let t=0;t<e.children.length;t++){if(e.children[t].children.length>0)return!0}return!1},Jh.prototype._renderSelection=function(){const e=new bh;return function(t,r,n){const s=this._gfx;s.renderer.setClearColor("black",0),s.renderer.setRenderTarget(r),s.renderer.clear(!0,!1,!1),this._hasSelectionToRender()?(s.selectionRoot.matrix=s.root.matrix,s.selectionPivot.matrix=s.pivot.matrix,s.renderer.render(s.selectionScene,t)):s.renderer.renderDummyQuad(),s.renderer.setRenderTarget(n),s.renderer.renderScreenQuadFromTex(r.texture,.6),e.uniforms.srcTex.value=r.texture,e.uniforms.srcTexSize.value.set(r.width,r.height),s.renderer.renderScreenQuad(e)}}(),Jh.prototype._checkVolumeRenderingSupport=function(e){if(!e)return!1;const t=this._gfx,r=t.renderer.getRenderTarget();t.renderer.setRenderTarget(e);const n=t.renderer.getContext(),s=n.checkFramebufferStatus(n.FRAMEBUFFER);return t.renderer.setRenderTarget(r),s===n.FRAMEBUFFER_COMPLETE||(this.logger.warn("Device doesn't support electron density rendering"),!1)},Jh.prototype._renderVolume=function(){const e=new aa.BackFacePosMaterial,t=new aa.FrontFacePosMaterial,n=(new r.Matrix4).makeTranslation(.5,.5,.5),s=new r.Matrix4;let i;return function(r,o,a,l,c,h){const u=this._gfx;if(void 0===i&&(i=this._checkVolumeRenderingSupport(l)),!i)return;const d=r.getMesh();d.rebuild(u.camera),u.renderer.setClearColor("black",0),u.renderer.setRenderTarget(l),u.renderer.clear(),u.renderer.setRenderTarget(c),u.renderer.clear(),u.renderer.setRenderTarget(h),u.renderer.clear(),u.renderer.setRenderTarget(l),o.layers.set(sr.LAYERS.VOLUME_BFPLANE),u.renderer.render(u.scene,o),o.layers.set(sr.LAYERS.VOLUME),u.scene.overrideMaterial=e,u.renderer.render(u.scene,o),u.renderer.setRenderTarget(c),o.layers.set(sr.LAYERS.VOLUME),u.scene.overrideMaterial=t,u.renderer.render(u.scene,o),u.scene.overrideMaterial=null,o.layers.set(sr.LAYERS.DEFAULT),s.copy(d.matrixWorld).invert(),Jn.prototype.uberOptions.world2colorMatrix.multiplyMatrices(n,s),o.layers.set(sr.LAYERS.COLOR_FROM_POSITION),u.renderer.setRenderTarget(h),u.renderer.render(u.scene,o);const p=d.material;p.uniforms._BFRight.value=l.texture,p.uniforms._FFRight.value=c.texture,p.uniforms._WFFRight.value=h.texture,o.layers.set(sr.LAYERS.VOLUME),u.renderer.setRenderTarget(a),u.renderer.render(u.scene,o),o.layers.set(sr.LAYERS.DEFAULT)}}(),Jh.prototype._renderWithPrepassTransparency=function(e,t){const r=this._gfx;r.renderer.setRenderTarget(t),e.layers.set(sr.LAYERS.DEFAULT),r.renderer.render(r.scene,e),e.layers.set(sr.LAYERS.PREPASS_TRANSPARENT),r.renderer.getContext().colorMask(!1,!1,!1,!1),r.renderer.render(r.scene,e),r.renderer.getContext().colorMask(!0,!0,!0,!0),e.layers.set(sr.LAYERS.TRANSPARENT),r.renderer.render(r.scene,e),e.layers.set(sr.LAYERS.DEFAULT)},Jh.prototype._performFXAA=function(){const e=new Sh;return function(t,r){if(void 0===t||void 0===r)return;const n=this._gfx;n.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent)),n.renderer.setRenderTarget(r),n.renderer.clear(),e.uniforms.srcTex.value=t.texture,e.uniforms.srcTexelSize.value.set(1/t.width,1/t.height),e.uniforms.bgColor.value.set(z.now.bg.color),e.bgTransparent!==z.now.bg.transparent&&(e.setValues({bgTransparent:z.now.bg.transparent}),e.needsUpdate=!0),n.renderer.renderScreenQuad(e)}}(),Jh.prototype._performAO=function(){const e=new Ah,t=new Rh,n=new Nh,s=new r.Vector3;return function(i,o,a,l,c,h){if(!(i&&o&&a&&l&&c&&h))return;const u=this._gfx,d=Math.tan(.5*r.MathUtils.DEG2RAD*u.camera.fov);e.uniforms.diffuseTexture.value=i.texture,e.uniforms.depthTexture.value=a,e.uniforms.normalTexture.value=o.texture,e.uniforms.srcTexelSize.value.set(1/i.width,1/i.height),e.uniforms.camNearFar.value.set(u.camera.near,u.camera.far),e.uniforms.projMatrix.value=u.camera.projectionMatrix,e.uniforms.aspectRatio.value=u.camera.aspect,e.uniforms.tanHalfFOV.value=d,u.root.matrix.extractScale(s),e.uniforms.kernelRadius.value=z.now.debug.ssaoKernelRadius*s.x,e.uniforms.depthThreshold.value=2*this._getBSphereRadius(),e.uniforms.factor.value=z.now.debug.ssaoFactor,u.renderer.setRenderTarget(h),u.renderer.renderScreenQuad(e),t.uniforms.aoMap.value=h.texture,t.uniforms.srcTexelSize.value.set(1/h.width,1/h.height),t.uniforms.depthTexture.value=a,u.renderer.setRenderTarget(c),u.renderer.renderScreenQuad(t),n.uniforms.aoMap.value=c.texture,n.uniforms.diffuseTexture.value=i.texture,n.uniforms.srcTexelSize.value.set(1/c.width,1/c.height),n.uniforms.depthTexture.value=a,n.uniforms.projMatrix.value=u.camera.projectionMatrix,n.uniforms.aspectRatio.value=u.camera.aspect,n.uniforms.tanHalfFOV.value=d;const{fog:p}=u.scene;p&&(n.uniforms.fogNearFar.value.set(p.near,p.far),n.uniforms.fogColor.value.set(p.color.r,p.color.g,p.color.b,z.now.fogAlpha)),n.useFog===z.now.fog&&n.fogTransparent===z.now.bg.transparent||(n.setValues({useFog:z.now.fog,fogTransparent:z.now.bg.transparent}),n.needsUpdate=!0),u.renderer.setRenderTarget(l),u.renderer.renderScreenQuad(n)}}(),Jh.prototype.reset=function(){this._picker&&this._picker.reset(),this._lastPick=null,this._releaseAllVisuals(),this._setEditMode($h),this._resetObjects(),this._gfx&&(sr.clearTree(this._gfx.pivot),this._gfx.renderer2d.reset()),this.setNeedRender()},Jh.prototype._resetScene=function(){this._objectControls.reset(),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.resetReps(),this.resetPivot(),this.rebuildAll()},Jh.prototype.resetView=function(){this._picker&&this._picker.reset(),this._setEditMode($h),this._resetScene(),this._forEachComplexVisual((e=>{e.updateSelectionMask({}),e.rebuildSelectionGeometry()}))},Jh.prototype._export=function(e){const r=t().head(Wc.exporters.find({format:e}));if(!r)return this.logger.error("Could not find suitable exporter for this source"),Promise.reject(new Error("Could not find suitable exporter for this source"));if(this.dispatchEvent({type:"exporting"}),this._visuals[this._curVisualName]instanceof Qo){let e=null;r.SourceClass===Qo?e=this._visuals[this._curVisualName]:r.SourceClass===jt&&(e=this._visuals[this._curVisualName]._complex);return new r(e,{miewVersion:Jh.VERSION}).export().then((e=>e))}return this._visuals[this._curVisualName]instanceof pa?Promise.reject(new Error("Sorry, exporter for volume data not implemented yet")):Promise.reject(new Error("Unexpected format of data"))};const nu=/^(?:(pdb|cif|ccp4|dsn6):\s*)?(\d[a-z\d]{3})$/i,su=/^(?:pc|pubchem):\s*([a-z]+)$/i,iu=/^([a-z][a-z\d\-+.]*):/i;function ou(e,r,n){return new Promise((s=>{if(n.shouldCancel())throw new Error("Operation cancelled");n.notify({type:"fetching"}),e=function(e,r){if(!t().isString(e))return e;const n=nu.exec(e);if(n){let[,t="pdb",s]=n;switch(t=t.toLowerCase(),s=s.toUpperCase(),t){case"pdb":e=`https://files.rcsb.org/download/${s}.pdb`;break;case"cif":e=`https://files.rcsb.org/download/${s}.cif`;break;case"ccp4":e=`https://www.ebi.ac.uk/pdbe/coordinates/files/${s.toLowerCase()}.ccp4`;break;case"dsn6":e=`https://edmaps.rcsb.org/maps/${s.toLowerCase()}_2fofc.dsn6`;break;default:throw new Error("Unexpected data format shortcut")}return r.fileType=t,r.fileName=`${s}.${t}`,r.sourceType="url",e}const s=su.exec(e);if(s){const t=s[1].toLowerCase();return e=`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${t}/JSON?record_type=3d`,r.fileType="pubchem",r.fileName=`${t}.json`,r.sourceType="url",e}return"url"!==r.sourceType&&void 0!==r.sourceType||(r.sourceType="url",iu.test(e)||(e=O.resolveURL(e))),e}(e,r);const i=t().head(Wc.loaders.find({type:r.sourceType,source:e}));if(!i)throw new Error(Xh);const o=r.fileName||i.extractName(e);if(o){const[e,n]=O.splitFileName(o);t().defaults(r,{name:e,fileExt:n,fileName:o})}!function(e){let{binary:r}=e;if(void 0!==e.fileType){const n=t().head(Wc.parsers.find({format:e.fileType}));if(!n)throw new Error("Could not find suitable parser for this format");r=n.binary||!1}if(void 0===r&&void 0!==e.fileExt){const n=t().head(Wc.parsers.find({ext:e.fileExt}));n&&(r=n.binary||!1)}void 0!==e.fileExt&&".man"===e.fileExt.toLowerCase()&&(e.binary=!0,e.animation=!0),void 0!==r&&void 0!==e.binary&&e.binary!==r&&e.context.logger.warn("Overriding incorrect binary mode"),e.binary=r||!1}(r);let a=t().get(r,"preset.expression");if(!t().isUndefined(a)&&(a=JSON.parse(a),a&&a.settings)){const e=["singleUnit"];for(let r=0,n=e.length;r<n;++r){const n=e[r],s=t().get(a.settings,n);t().isUndefined(s)||z.set(n,s)}}const l=new i(e,r);l.context=r.context,n.addEventListener("cancel",(()=>l.abort())),l.addEventListener("progress",(e=>{e.lengthComputable&&e.total>0?Kh(l.logger,"Fetching",e.loaded/e.total):Kh(l.logger,"Fetching")}));s(l.load().then((e=>(r.context.logger.info("Fetching finished"),n.notify({type:"fetchingDone",data:e}),e))).catch((e=>{throw r.context.logger.debug(e.message),e.stack&&r.context.logger.debug(e.stack),r.context.logger.error("Fetching failed"),n.notify({type:"fetchingDone",error:e}),e})))}))}Jh.prototype.load=function(e,r){r=t().merge({},r,{context:this}),this.settings.now.use.multiFile||(this._loading.length&&(this._loading.forEach((e=>{e.cancel()})),this._loading.length=0),r.animation||this.reset(!0)),this._interpolator.reset(),this.dispatchEvent({type:"loading",options:r,source:e});const n=new V;this._loading.push(n),n.addEventListener("notification",(e=>{this.dispatchEvent(e.slaveEvent)})),this._spinner.spin(this._container);const s=e=>{const t=this._loading.indexOf(n);return-1!==t&&this._loading.splice(t,1),this._spinner.stop(),this._refreshTitle(),n.notify({type:"loadingDone",anything:e}),e};return ou(e,r,n).then((e=>function(e,r,n){if(n.shouldCancel())return Promise.reject(new Error("Operation cancelled"));n.notify({type:"parsing"});const s=t().head(Wc.parsers.find({format:r.fileType,ext:r.fileExt,data:e}));if(!s)return Promise.reject(new Error("Could not find suitable parser"));const i=new s(e,r);return i.context=r.context,n.addEventListener("cancel",(()=>i.abort())),i.parse().then((e=>(n.notify({type:"parsingDone",data:e}),e))).catch((e=>{throw r.error=e,r.context.logger.debug(e.message),e.stack&&r.context.logger.debug(e.stack),r.context.logger.error("Parsing failed"),n.notify({type:"parsingDone",error:e}),e}))}(e,r,n))).then((e=>{const t=this._onLoad(e,r);return s(t)})).catch((e=>{throw this.logger.error("Could not load data"),this.logger.debug(e),s(e)}))},Jh.prototype.unload=function(e){this._removeVisual(e||this.getCurrentVisual()),this.resetPivot(),z.now.shadow.on&&this._updateShadowCamera()},Jh.prototype._startAnimation=function(e){this._stopAnimation();const t=this,r=this._getComplexVisual();if(null!==r){try{this._frameInfo=new mh(r.getComplex(),e,{onLoadStatusChanged(){t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:!t._frameInfo||t._frameInfo.isLoading}})},onError(e){t._stopAnimation(),t.logger.error(e)}})}catch(e){return void this.logger.error("Animation file does not fit to current complex!")}this._continueAnimation()}else this.logger.error("Unable to start animation - no molecule is loaded.")},Jh.prototype._pauseAnimation=function(){null!==this._animInterval&&(this._isAnimating=!1,clearInterval(this._animInterval),this._animInterval=null,this._frameInfo&&this.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:this._isAnimating,isLoading:this._frameInfo.isLoading}}))},Jh.prototype._continueAnimation=function(){this._isAnimating=!0;let e=1e3/z.now.maxfps;e=Number.isNaN(e)?0:e;const t=this,{pivot:r}=t._gfx,n=this._getComplexVisual();n&&(n.resetSelectionMask(),n.rebuildSelectionGeometry(),this._msgAtomInfo.style.opacity=0),this._animInterval=setInterval((()=>{if(t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:t._frameInfo.isLoading}}),t._frameInfo.frameIsReady){r.updateToFrame(t._frameInfo),t._updateObjsToFrame(t._frameInfo),t._refreshTitle(` Frame ${t._frameInfo._currFrame} of ${t._frameInfo._framesCount} time interval - ${t._frameInfo._timeStep}`);try{t._frameInfo.nextFrame()}catch(e){return t.logger.error("Error during animation"),void t._stopAnimation()}t._needRender=!0}}),e)},Jh.prototype._stopAnimation=function(){null!==this._animInterval&&(clearInterval(this._animInterval),this._frameInfo.disableEvents(),this._frameInfo=null,this._animInterval=null,this.dispatchEvent({type:"mdPlayerStateChanged",state:null}))},Jh.prototype._onLoad=function(e,r){const n=this._gfx;let s=null;if(r.animation)return this._refreshTitle(),this._startAnimation(e),null;if(this._stopAnimation(),r&&r.keepRepsInfo||(this._opts.reps=null,this._opts._objects=null),"Complex"===e.id){const n=e;r.fileName?n.name=n.name||Zh(r.fileName).toUpperCase():r.amberFileName?n.name=n.name||Zh(r.amberFileName).toUpperCase():n.name=`Dynamic ${r.fileType} molecule`,s=this._addVisual(new Qo(n.name,n)),this._curVisualName=s;const i=this.info();if(this.logger.info(`Parsed ${r.fileName} (${i.atoms} atoms, ${i.bonds} bonds, ${i.residues} residues, ${i.chains} chains).`),t().isNumber(this._opts.unit)&&n.setCurrentUnit(this._opts.unit),r.preset);else if(z.now.autoPreset)switch(r.fileType){case"cml":this.resetReps("small");break;case"pdb":case"mmtf":case"cif":!function(e){let t=!1;return e.forEachComponent((e=>{e.forEachResidue((e=>{e._isValid&&(t=!0)}))})),t}(n)?this.resetReps("small"):this.resetReps("macro");break;default:this.resetReps("default")}else this.resetReps("default")}else"Volume"===e.id&&(this.resetEd(),s=this._onLoadEd(e));return n.camera.updateProjectionMatrix(),this._updateFog(),n.root.resetTransform(),this.resetPivot(),this._objectControls.setScale(z.now.radiusToFit/this._getBSphereRadius()),this._resetObjects(),z.now.autoResolution&&this._tweakResolution(),z.now.shadow.on&&this._updateShadowCamera(),this._opts.view&&(this.view(this._opts.view),delete this._opts.view),this._refreshTitle(),s},Jh.prototype.resetEd=function(){this._edLoader&&(this._edLoader.abort(),this._edLoader=null),this._removeVisual(this._getVolumeVisual()),this._needRender=!0},Jh.prototype.loadEd=function(e){this.resetEd();const r=t().head(Wc.loaders.find({source:e}));if(!r)return this.logger.error(Xh),Promise.reject(new Error(Xh));const n=this._edLoader=new r(e,{binary:!0});return n.context=this,n.load().then((e=>{const r=t().head(Wc.parsers.find({format:"ccp4"}));if(!r)throw new Error("Could not find suitable parser for this source");const n=new r(e);return n.context=this,n.parse().then((e=>{this._onLoadEd(e)}))})).catch((e=>{this.logger.error("Could not load ED data"),this.logger.debug(e)}))},Jh.prototype._onLoadEd=function(e){e.normalize();const t=new pa("volume",e);t.getMesh().layers.set(sr.LAYERS.VOLUME);const r=this._addVisual(t);return this._needRender=!0,r},Jh.prototype._needRebuild=function(){let e=!1;return this._forEachComplexVisual((t=>{e=e||t.needsRebuild()})),e},Jh.prototype._rebuildObjects=function(){const e=this,t=this._gfx;let r,n;const s=[];for(r=0;r<t.pivot.children.length;++r){const e=t.pivot.children[r];e instanceof ar||s.push(e)}for(r=0;r<s.length;++r)s[r].parent.remove(s[r]);setTimeout((()=>{const s=e._objects;for(r=0,n=s.length;r<n;++r){const e=s[r];e.needsRebuild&&e.build(),e.getGeometry()&&t.pivot.add(e.getGeometry())}}),10)},Jh.prototype.changeUnit=function(e,r){const n=this._getComplexVisual(r);if(!n)throw new Error("There is no complex to change!");function s(){const e=n?n.getComplex().getCurrentUnit():0;return`Current unit: ${e} (${e>0?`Bio molecule ${e}`:"Asymmetric unit"})`}return void 0===e||(t().isString(e)&&(e=Math.max(parseInt(e,10),0)),n.getComplex().setCurrentUnit(e)&&(this._resetScene(),this._updateInfoPanel())),s()},Jh.prototype.rebuild=function(){if(this._building)return void this.logger.warn("Miew.rebuild(): already building!");this._building=!0,this.dispatchEvent({type:"rebuilding"}),this._rebuildObjects(),this._gfx.renderer2d.reset();const e=[];this._forEachComplexVisual((t=>{t.needsRebuild()&&e.push(t.rebuild().then((()=>new Promise((e=>{t.rebuildSelectionGeometry(),e()})))))}));const t=this;this._spinner.spin(this._container),Promise.all(e).then((()=>{t._spinner.stop(),t._needRender=!0,t._refreshTitle(),this.dispatchEvent({type:"buildingDone"}),t._building=!1}))},Jh.prototype.rebuildAll=function(){this._forEachComplexVisual((e=>{e.setNeedsRebuild()}))},Jh.prototype._refreshTitle=function(e){let t;e=void 0===e?"":e;const r=this._getComplexVisual();if(r){t=r.getComplex().name;const e=r.repGet(r.repCurrent());t+=e?` – ${e.mode.name} Mode`:""}else t=Object.keys(this._visuals).length>0?"Unknown":"No Data";t+=e,this.dispatchEvent({type:"titleChanged",data:t})},Jh.prototype.setNeedRender=function(){this._needRender=!0},Jh.prototype._extractRepresentation=function(){const e=[];this._forEachComplexVisual((t=>{if(0===t.getSelectionCount())return;const r=t.buildSelectorFromMask(1<<t.getSelectionBit()),n=z.now.presets.default,s=t.repAdd({selector:r,mode:n[0].mode.id,colorer:n[0].colorer.id,material:n[0].material.id});s?(this.dispatchEvent({type:"repAdded",index:s.index,name:t.name}),t.repCurrent(s.index),e.push(t.name)):t.repCount()===Qo.NUM_REPRESENTATION_BITS&&this.logger.warn(`Number of representations is limited to ${Qo.NUM_REPRESENTATION_BITS}`)})),e.length>0&&this.logger.report(`New representation from selection for complexes: ${e.join(", ")}`)},Jh.prototype._setReps=function(e){e=e||this._opts&&this._opts.reps||[],this._forEachComplexVisual((t=>t.resetReps(e)))},Jh.prototype.applyPreset=function(e){const{presets:t}=z.now,r=[e||z.defaults.preset,z.defaults.preset,Object.keys(t)[0]];let n=null;for(let e=0;!n&&e<r.length;++e)z.set("preset",r[e]),n=t[z.now.preset],n||this.logger.warn(`Unknown preset "${z.now.preset}"`);this._setReps(n)},Jh.prototype.resetReps=function(e){const t=this._opts&&this._opts.reps;t?this._setReps(t):this.applyPreset(e)},Jh.prototype.repCount=function(e){const t=this._getComplexVisual(e);return t?t.repCount():0},Jh.prototype.repCurrent=function(e,t){const r=this._getComplexVisual(t),n=r?r.repCurrent(e):-1;return e&&n!==e&&this.logger.warn(`Representation ${e} was not found. Current rep remains unchanged.`),n},Jh.prototype.rep=function(e,t){const r=this._getComplexVisual("");if(!r)return null;const n=r.rep(e,t);return"created"===n.status?this.dispatchEvent({type:"repAdded",index:n.index,name:r.name}):"changed"===n.status&&this.dispatchEvent({type:"repChanged",index:n.index,name:r.name}),n.desc},Jh.prototype.repGet=function(e,t){const r=this._getComplexVisual(t);return r?r.repGet(e):null},Jh.prototype.repAdd=function(e,t){const r=this._getComplexVisual(t);if(!r)return-1;const n=r.repAdd(e);return n?(this.dispatchEvent({type:"repAdded",index:n.index,name:t}),n.index):-1},Jh.prototype.repRemove=function(e,t){const r=this._getComplexVisual(t);r&&(r.repRemove(e),this.dispatchEvent({type:"repRemoved",index:e,name:t}))},Jh.prototype.repHide=function(e,t,r){this._needRender=!0;const n=this._getComplexVisual(r);return n?n.repHide(e,t):null},Jh.prototype._setEditMode=function(e){this._editMode=e;const t=this._msgMode;if(t&&(t.style.opacity=e===$h?0:1,e!==$h)){t.getElementsByTagName("p")[0].innerHTML=e===Wh?"COMPONENT EDIT MODE":"FRAGMENT EDIT MODE"}this.dispatchEvent({type:"editModeChanged",data:e===$h})},Jh.prototype._enterComponentEditMode=function(){if(this._editMode!==$h)return;const e=[];this._forEachComplexVisual((t=>{const r=t.beginComponentEdit();r&&e.push(r)})),e!==[]&&(this._editors=e,this.logger.info("COMPONENT EDIT MODE -- ON"),this._setEditMode(Wh),this._objectControls.keysTranslateObj(!0))},Jh.prototype._applyComponentEdit=function(){if(this._editMode===Wh){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(let e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (applied)"),this._setEditMode($h),this.rebuildAll()}},Jh.prototype._discardComponentEdit=function(){if(this._editMode===Wh){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(let e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (discarded)"),this._setEditMode($h),this._needRender=!0,this.rebuildAll()}},Jh.prototype._enterFragmentEditMode=function(){if(this._editMode!==$h)return;const e=[];if(this._forEachComplexVisual((t=>{t instanceof Qo&&t.getSelectionCount()>0&&e.push(t)})),1!==e.length)return;const t=e[0].beginFragmentEdit();t&&(this._editors=[t],this.logger.info("FRAGMENT EDIT MODE -- ON (single bond)"),this._setEditMode(Yh),this._objectControls.allowTranslation(!1),this._objectControls.allowAltObjFreeRotation(t.isFreeRotationAllowed()),this._needRender=!0)},Jh.prototype._applyFragmentEdit=function(){if(this._editMode===Yh){this._objectControls.stop();for(let e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (applied)"),this._setEditMode($h),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.rebuildAll()}},Jh.prototype._discardFragmentEdit=function(){if(this._editMode===Yh){this._objectControls.stop();for(let e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (discarded)"),this._setEditMode($h),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this._needRender=!0}},Jh.prototype._onPick=function(e){if(!z.now.picking)return;if(null!==this._animInterval)return;if(this._editMode===Yh)return;if(this._objectControls.isEditingAltObj())return;let t=null;function r(t){t.updateSelectionMask(e.obj),t.rebuildSelectionGeometry()}if(e.obj.atom?(t=e.obj.atom.residue.getChain().getComplex(),this._lastPick=e.obj.atom):e.obj.residue?(t=e.obj.residue.getChain().getComplex(),this._lastPick=e.obj.residue):e.obj.chain?(t=e.obj.chain.getComplex(),this._lastPick=e.obj.chain):e.obj.molecule?(t=e.obj.molecule.complex,this._lastPick=e.obj.molecule):this._lastPick=null,t){const e=this._getVisualForComplex(t);e&&(r(e),this._needRender=!0)}else this._forEachComplexVisual(r),this._needRender=!0;this._updateInfoPanel(),this.dispatchEvent(e)},Jh.prototype._onKeyDown=function(e){if(this._running&&this._hotKeysEnabled){if(z.now.editing)switch(e.code){case"KeyC":this._enterComponentEditMode();break;case"KeyF":this._enterFragmentEditMode();break;case"KeyA":switch(this._editMode){case Wh:this._applyComponentEdit();break;case Yh:this._applyFragmentEdit()}break;case"KeyD":switch(this._editMode){case Wh:this._discardComponentEdit();break;case Yh:this._discardFragmentEdit()}}switch(e.code){case"NumpadAdd":e.altKey&&(e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual((e=>{e.expandSelection(),e.rebuildSelectionGeometry()})),this._updateInfoPanel(),this._needRender=!0);break;case"NumpadSubtract":e.altKey&&(e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual((e=>{e.shrinkSelection(),e.rebuildSelectionGeometry()})),this._updateInfoPanel(),this._needRender=!0)}}},Jh.prototype._onKeyUp=function(e){this._running&&this._hotKeysEnabled&&"KeyX"===e.code&&this._extractRepresentation()},Jh.prototype._updateInfoPanel=function(){const e=this._msgAtomInfo.getElementsByTagName("p")[0];let t,r,n=0;for(this._forEachComplexVisual((e=>{n+=e.getSelectionCount()}));e.firstChild;)e.removeChild(e.firstChild);if(0===n)return void(this._msgAtomInfo.style.opacity=0);let s=`${String(n)} atom${1!==n?"s":""} selected`;null!==this._lastPick&&(s+=", the last pick:");let i="",o="",a="";if(this._lastPick instanceof Uh){t=this._lastPick,r=t.residue,o=t.name;const e=32!==t.location?String.fromCharCode(t.location):"";i=`${t.element.fullName} #${t.serial}${e}:       ${r._chain._name}.${r._type._name}${r._sequence}${r._icode.trim()}.`,i+=o,a=`Coord: (${t.position.x.toFixed(2).toString()},     ${t.position.y.toFixed(2).toString()},     ${t.position.z.toFixed(2).toString()})`}else this._lastPick instanceof Gh?(r=this._lastPick,i=`${r._type._fullName}:       ${r._chain._name}.${r._type._name}${r._sequence}${r._icode.trim()}`):this._lastPick instanceof jh?i=`chain ${this._lastPick._name}`:this._lastPick instanceof Hh&&(i=`molecule ${this._lastPick._name}`);e.appendChild(document.createTextNode(s)),""!==i&&(e.appendChild(document.createElement("br")),e.appendChild(document.createTextNode(i))),""!==a&&(e.appendChild(document.createElement("br")),e.appendChild(document.createTextNode(a))),this._msgAtomInfo.style.opacity=1},Jh.prototype._getAltObj=function(){if(this._editors){let e=null;for(let t=0;t<this._editors.length;++t){const r=this._editors[t].getAltObj();if(r.objects.length>0){if(e){e=null;break}e=r}}if(e)return e}return{objects:[],pivot:new r.Vector3(0,0,0)}},Jh.prototype.resetPivot=function(){const e=new r.Box3,t=new r.Vector3;return function(){e.makeEmpty(),this._forEachVisual((t=>{e.union(t.getBoundaries().boundingBox)})),e.getCenter(t),this._objectControls.setPivot(t.negate()),this.dispatchEvent({type:"transform"})}}(),Jh.prototype.setPivotResidue=function(){const e=new r.Vector3;return function(t){const r=this._getVisualForComplex(t.getChain().getComplex());if(r){if(t._controlPoint)e.copy(t._controlPoint);else{let r=0,n=0,s=0;const i=t._atoms.length;for(let e=0;e<i;++e){const o=t._atoms[e].position;r+=o.x/i,n+=o.y/i,s+=o.z/i}e.set(r,n,s)}e.applyMatrix4(r.matrix).negate(),this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"})}}}(),Jh.prototype.setPivotAtom=function(){const e=new r.Vector3;return function(t){const r=this._getVisualForComplex(t.residue.getChain().getComplex());r&&(e.copy(t.position),e.applyMatrix4(r.matrix).negate(),this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"}))}}(),Jh.prototype.getSelectionCenter=function(){const e=new r.Vector3(0,0,0);return function(t,r,n){t.set(0,0,0);let s=0;return this._forEachComplexVisual((i=>{i.getSelectionCenter(e,r,n||i.getSelectionBit())&&(t.add(e),s++)})),0!==s&&(t.divideScalar(s),t.negate(),!0)}}(),Jh.prototype.setPivotSubset=function(){const e=new r.Vector3(0,0,0);function t(e,t){return e.mask&1<<t}function n(e,t){return t.selector.includesAtom(e)}return function(r){const s=r?n:t;this.getSelectionCenter(e,s,r)?(this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"})):this.logger.warn("selection is empty. Center operation not performed")}}(),Jh.prototype.screenshot=function(e,t){const n=this._gfx,s=n.renderer.domElement.width,i=n.renderer.domElement.height;function o(){let r;if(O.getBrowser()===O.browserType.SAFARI){const o=document.createElement("canvas"),a=o.getContext("2d");o.width=void 0===e?s:e,o.height=void 0===t?i:t,a.drawImage(n.renderer.domElement,0,0,o.width,o.height),r=o.toDataURL("image/png")}else r=n.renderer.domElement.toDataURL("image/png");return r}let a;if(t=t||e,void 0===e&&void 0===t||e===s&&t===i)a=o();else{const s=n.camera.aspect,i=n.camera.fov,h=(c=n.camera.fov,Math.tan(r.MathUtils.degToRad(.5*c)))*Math.min(n.width,n.height)/n.height,u=e/t;n.renderer.setPixelRatio(1),n.camera.aspect=u,n.camera.fov=(l=h/Math.min(u,1),2*r.MathUtils.radToDeg(Math.atan(l))),n.camera.updateProjectionMatrix(),n.renderer.setDrawingBufferSize(e,t,1),this._renderFrame(z.now.stereo),a=o(),n.renderer.setPixelRatio(window.devicePixelRatio),n.camera.aspect=s,n.camera.fov=i,n.camera.updateProjectionMatrix(),n.renderer.setDrawingBufferSize(n.width,n.height,window.devicePixelRatio),this._needRender=!0}var l,c;return a},Jh.prototype.screenshotSave=function(e,t,r){const n=this.screenshot(t,r);O.shotDownload(n,e)},Jh.prototype.save=function(e){this._export(e.fileType).then((t=>{const r=this._visuals[this._curVisualName]._complex.name;O.download(t,r,e.fileType),this._refreshTitle(),this.dispatchEvent({type:"exportingDone"})})).catch((e=>{this.logger.error("Could not export data"),this.logger.debug(e),this._refreshTitle(),this.dispatchEvent({type:"exportingDone",error:e})}))},Jh.prototype._tweakResolution=function(){const e=[["poor",100],["low",500],["medium",1e3],["high",5e3],["ultra",Number.MAX_VALUE]];let t=0;if(this._forEachComplexVisual((e=>{t+=e.getComplex().getAtomCount()})),t>0){const r=1e6*this._gfxScore/t;for(let t=0;t<e.length;++t)if(r<e[t][1]){this._autoChangeResolution(e[t][0]);break}}},Jh.prototype._autoChangeResolution=function(e){e!==z.now.resolution&&this.logger.report(`Your rendering resolution was changed to "${e}" for best performance.`),z.now.resolution=e},Jh.prototype.saveSettings=function(){this._cookies.setCookie(this._opts.settingsCookie,JSON.stringify(this.settings.getDiffs(!0)))},Jh.prototype.restoreSettings=function(){try{const e=this._cookies.getCookie(this._opts.settingsCookie),t=e?JSON.parse(e):{};this.settings.applyDiffs(t,!0)}catch(e){this.logger.error(`Cookies parse error: ${e.message}`)}},Jh.prototype.resetSettings=function(){this.settings.reset()},Jh.prototype.setOptions=function(e){"string"==typeof e&&(e=Jh.options.fromAttr(e)),e.reps&&(this._opts.reps=null),t().merge(this._opts,e),e.settings&&this.set(e.settings),this._opts._objects=e._objects,this._resetObjects(),e.load&&this.load(e.load,{fileType:e.type}),e.preset&&(z.now.preset=e.preset),e.reps&&this.resetReps(e.preset),this._opts.view&&(this.view(this._opts.view),delete this._opts.view);const r=this._getComplexVisual();r&&(r.getComplex().resetCurrentUnit(),t().isNumber(e.unit)&&r.getComplex().setCurrentUnit(e.unit),this.resetView(),this.rebuildAll())},Jh.prototype.info=function(e){const t=this._getComplexVisual(e);if(!t)return{};const r=t.getComplex(),{metadata:n}=r;return{id:n.id||r.name||"UNKNOWN",title:n.title&&n.title.join(" ")||"UNKNOWN DATA",atoms:r.getAtomCount(),bonds:r.getBondCount(),residues:r.getResidueCount(),chains:r.getChainCount()}},Jh.prototype.addObject=function(e,t){let r=null;if(e.type===yh.prototype.type&&(r=yh),null===r)throw new Error(`Unknown scene object type - ${e.type}`);try{const t=new r(e.params,e.opts);this._addSceneObject(t)}catch(e){if(t)throw e;this.logger.debug(`Error during scene object creation: ${e.message}`)}this._needRender=!0},Jh.prototype._addSceneObject=function(e){const t=this._getComplexVisual();e.build&&t&&(e.build(t.getComplex()),this._gfx.pivot.add(e.getGeometry()));const r=this._objects;r[r.length]=e},Jh.prototype._updateObjsToFrame=function(e){const t=this._objects;for(let r=0,n=t.length;r<n;++r)t[r].updateToFrame&&t[r].updateToFrame(e)},Jh.prototype._resetObjects=function(){const e=this._opts._objects;if(this._objects=[],e)for(let t=0,r=e.length;t<r;++t)this.addObject(e[t],!1)},Jh.prototype.removeObject=function(e){const t=this._objects[e];if(!t)throw new Error(`Scene object with index ${e} does not exist`);t.destroy(),this._objects.splice(e,1),this._needRender=!0},Jh.prototype.getURL=function(e){return le.toURL(this.getState(t().defaults(e,{compact:!0,settings:!1,view:!1})))},Jh.prototype.getScript=function(e){return le.toScript(this.getState(t().defaults(e,{compact:!0,settings:!0,view:!0})))},Jh.prototype._compareReps=function(e,r){const n={};let s=0;e&&(s=e.repCount());const i=z.defaults.presets[z.now.preset];let o=r;void 0===i||i.length>s?(o=!1,n.preset="empty"):z.now.preset!==z.defaults.preset&&(n.preset=z.now.preset);const a=[];let l=!0;for(let r=0,n=s;r<n;++r)a[r]=e.repGet(r).compare(o?i[r]:null),t().isEmpty(a[r])||(l=!1);return l||(n.reps=a),n},Jh.prototype.getState=function(e){const r={};e=t().defaults(e,{compact:!0,settings:!1,view:!1});const n=this._getComplexVisual();if(null!==n){const e=n.getComplex(),{metadata:t}=e;if(t.id){const e=t.format?`${t.format}:`:"";r.load=e+t.id}const s=e.getCurrentUnit();1!==s&&(r.unit=s)}const s=this._compareReps(n,e.compact);s.preset&&(r.preset=s.preset),s.reps&&(r.reps=s.reps);const i=this._objects,o=[];for(let e=0,t=i.length;e<t;++e)o[e]=i[e].identify();if(i.length>0&&(r._objects=o),e.view&&(r.view=this.view()),e.settings){const e=this.settings.getDiffs(!1);t().isEmpty(e)||(r.settings=e)}return r},Jh.prototype.get=function(e,t){return z.get(e,t)},Jh.prototype._clipPlaneUpdateValue=function(e){const t=Math.max(this._gfx.camera.position.z-e*z.now.draft.clipPlaneFactor,z.now.camNear),r={clipPlaneValue:t};this._forEachComplexVisual((e=>{e.setUberOptions(r)}));for(let e=0,t=this._objects.length;e<t;++e){const t=this._objects[e];t._line&&t._line.material.setUberOptions(r)}null!==this._picker&&(this._picker.clipPlaneValue=t)},Jh.prototype._fogFarUpdateValue=function(){null!==this._picker&&(this._gfx.scene.fog?this._picker.fogFarValue=this._gfx.scene.fog.far:this._picker.fogFarValue=void 0)},Jh.prototype._updateShadowmapMeshes=function(e){this._forEachComplexVisual((t=>{const r=t._reprList;for(let t=0,n=r.length;t<n;++t){const n=r[t];e(n.geo,n.material)}}))},Jh.prototype._updateMaterials=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;this._forEachComplexVisual((n=>n.setMaterialValues(e,t,r)));for(let t=0,r=this._objects.length;t<r;++t){const r=this._objects[t];r._line&&(r._line.material.setValues(e),r._line.material.needsUpdate=!0)}},Jh.prototype._fogAlphaChanged=function(){this._forEachComplexVisual((e=>{e.setUberOptions({fogAlpha:z.now.fogAlpha})}))},Jh.prototype._embedWebXR=function(){if("WEBVR"!==z.now.stereo)return this.webVR&&this.webVR.disable(),void(this.webVR=null);this.webVR||(this.webVR=new Fh((()=>{this._requestAnimationFrame((()=>this._onTick())),this._needRender=!0,this._onResize()}))),this.webVR.enable(this._gfx)},Jh.prototype._initOnSettingsChanged=function(){const e=(e,r)=>{(e=t().isArray(e)?e:[e]).forEach((e=>{this.settings.addEventListener(`change:${e}`,r)}))};e("modes.VD.frame",(()=>{const e=this._getVolumeVisual();null!==e&&(e.showFrame(z.now.modes.VD.frame),this._needRender=!0)})),e("modes.VD.isoMode",(()=>{const e=this._getVolumeVisual();null!==e&&(e.getMesh().material.updateDefines(),this._needRender=!0)})),e("bg.color",(()=>{this._onBgColorChanged()})),e("ao",(()=>{if(z.now.ao&&!ru(this._gfx.renderer.getContext()))this.logger.warn("Your device or browser does not support ao"),z.set("ao",!1);else{const e={normalsToGBuffer:z.now.ao};this._setUberMaterialValues(e)}})),e("zSprites",(()=>{z.now.zSprites&&!tu(this._gfx.renderer.getContext())&&(this.logger.warn("Your device or browser does not support zSprites"),z.set("zSprites",!1)),this.rebuildAll()})),e("fogColor",(()=>{this._onFogColorChanged()})),e("fogColorEnable",(()=>{this._onFogColorChanged()})),e("bg.transparent",(e=>{const t=this._gfx;t&&t.renderer.setClearColor(z.now.bg.color,Number(!z.now.bg.transparent)),this._updateMaterials({fogTransparent:e.value}),this.rebuildAll()})),e("draft.clipPlane",(e=>{this._updateMaterials({clipPlane:e.value}),this.rebuildAll()})),e("shadow.on",(e=>{const t={shadowmap:e.value,shadowmapType:z.now.shadow.type},r=this._gfx;r&&(r.renderer.shadowMap.enabled=Boolean(t.shadowmap)),this._updateMaterials(t,!0),t.shadowmap?(this._updateShadowCamera(),this._updateShadowmapMeshes(jo.createShadowmapMaterial)):this._updateShadowmapMeshes(jo.removeShadowmapMaterial),this._needRender=!0})),e("shadow.type",(e=>{z.now.shadow.on&&(this._updateMaterials({shadowmapType:e.value},!0),this._needRender=!0)})),e("shadow.radius",(e=>{for(let t=0;t<this._gfx.scene.children.length;t++)if(void 0!==this._gfx.scene.children[t].shadow){this._gfx.scene.children[t].shadow.radius=e.value,this._needRender=!0}})),e("fps",(()=>{this._fps.show(z.now.fps)})),e(["fog","fogNearFactor","fogFarFactor"],(()=>{this._updateFog(),this._needRender=!0})),e("fogAlpha",(()=>{const{fogAlpha:e}=z.now;(e<0||e>1)&&this.logger.warn("fogAlpha must belong range [0,1]"),this._fogAlphaChanged(),this._needRender=!0})),e("autoResolution",(e=>{e.value&&!this._gfxScore&&this.logger.warn("Benchmarks are missed, autoresolution will not work! Autoresolution should be set during miew startup.")})),e("stereo",(()=>{this._embedWebXR("WEBVR"===z.now.stereo),this._needRender=!0})),e(["transparency","palette"],(()=>{this.rebuildAll()})),e("resolution",(()=>{this.rebuildAll();const e=this._getVolumeVisual();e&&(e.getMesh().material.updateDefines(),this._needRender=!0)})),e(["axes","fxaa","ao","outline.on","outline.color","outline.threshold","outline.thickness"],(()=>{this._needRender=!0}))},Jh.prototype.set=function(e,t){z.set(e,t)},Jh.prototype.select=function(e,r){const n=this._getComplexVisual();if(!n)return;let s=e;t().isString(e)&&(s=Bh.parse(e).selector),n.select(s,r),this._lastPick=null,this._updateInfoPanel(),this._needRender=!0};Jh.prototype.view=function(e){const t=this,{pivot:n}=this._gfx;let s=[];return void 0===e?function(){const e=n.position,i=t._objectControls.getScale()/z.now.radiusToFit,o=new r.Euler;return o.setFromQuaternion(t._objectControls.getOrientation(),"ZXY"),s=[e.x,e.y,e.z,i,o.x,o.y,o.z],"1"+O.arrayToBase64(s,Float32Array)}():(function(){40===e.length&&(e=`0${e}`);const i=e[0];if(s=O.arrayFromBase64(e.substr(1),Float32Array),"1"!==i){if("0"!==i)return void t.logger.warn(`Encoded view version mismatch, stored as ${i} vs 1 expected`);s[3]/=8}const o=t._interpolator,a=o.createView();a.position.copy(n.position),a.scale=t._objectControls.getScale(),a.orientation.copy(t._objectControls.getOrientation());const l=o.createView();l.position.set(s[0],s[1],s[2]),t._getComplexVisual()&&l.position.sub(t._getComplexVisual().position),l.scale=s[3],l.orientation.setFromEuler(new r.Euler(s[4],s[5],s[6],"ZXY")),o.setup(a,l)}(),e)},Jh.prototype._updateView=function(){const e=this,{pivot:t}=this._gfx,r=this._interpolator;if(r.wasStarted()||r.start(),!r.isMoving())return;const n=r.getCurrentView();if(n.success){const r=n.view;t.position.copy(r.position),e._objectControls.setScale(r.scale*z.now.radiusToFit),e._objectControls.setOrientation(r.orientation),this.dispatchEvent({type:"transform"}),e._needRender=!0}},Jh.prototype.translate=function(e,t,r){this._objectControls.translatePivot(e,t,r),this.dispatchEvent({type:"transform"}),this._needRender=!0},Jh.prototype.rotate=function(e,t,n){this._objectControls.rotate((new r.Quaternion).setFromEuler(new r.Euler(e,t,n,"XYZ"))),this.dispatchEvent({type:"transform"}),this._needRender=!0},Jh.prototype.scale=function(e){if(e<=0)throw new RangeError("Scale should be greater than zero");this._objectControls.scale(e),this.dispatchEvent({type:"transform"}),this._needRender=!0},Jh.prototype.center=function(e){if(void 0===e)return this.setPivotSubset(),void(this._needRender=!0);if(void 0!==e.obj&&("atom"in e.obj||"residue"in e.obj))return"atom"in e.obj?this.setPivotAtom(e.obj.atom):this.setPivotResidue(e.obj.residue),void(this._needRender=!0);if(void 0===e.obj&&""!==e){const t=Bh.parse(e);if(void 0===t.error)return this.setPivotSubset(t),void(this._needRender=!0)}this.resetPivot(),this._needRender=!0},Jh.prototype.within=function(e,t){const r=this._getComplexVisual();if(!r)return Bh.None();e instanceof String&&(e=Bh.parse(e));const n=r.within(e,t);return n&&(r.rebuildSelectionGeometry(),this._needRender=!0),n},Jh.prototype.projected=function(e,t){const r=this._getComplexVisual(t);if(!r)return!1;const n=r.getComplex().getAtomByFullname(e);if(null===n)return!1;const s=n.position.clone();return this._gfx.pivot.updateMatrixWorldRecursive(),this._gfx.camera.updateMatrixWorldRecursive(),this._gfx.pivot.localToWorld(s),s.project(this._gfx.camera),{x:.5*(s.x+1)*this._gfx.width,y:.5*(1-s.y)*this._gfx.height}},Jh.prototype.dssp=function(e){const t=this._getComplexVisual(e);t&&(t.getComplex().dssp(),t._reprList.forEach((e=>{"CA"!==e.mode.id&&"SS"!==e.colorer.id||(e.needsRebuild=!0)})))},Jh.prototype.exportCML=function(){const e=this;const t=e._getComplexVisual(),n=t?t.getComplex():null;if(n&&n.originalCML){!function(t){const{root:n}=e._gfx,s=function(e){const t=new r.Vector3,n=new r.Vector3,s=new r.Vector3;e.extractBasis(t,n,s),t.normalize(),n.normalize(),s.normalize();const i=new r.Matrix4;return i.identity(),i.makeBasis(t,n,s),i}(n.matrixWorld),i=new r.Vector4(0,0,0,0),o=new r.Vector4(0,0,0,0);let a=null,l=null;t.forEachAtom((e=>{e.xmlNodeRef&&e.xmlNodeRef.xmlNode&&(a=e.xmlNodeRef.xmlNode,l=e.position,i.set(l.x,l.y,l.z,1),i.applyMatrix4(s),a.setAttribute("x3",i.x.toString()),a.setAttribute("y3",i.y.toString()),a.setAttribute("z3",i.z.toString()),a.removeAttribute("x2"),a.removeAttribute("y2"))})),t.forEachSGroup((e=>{if(e.xmlNodeRef&&e.xmlNodeRef.xmlNode){a=e.xmlNodeRef.xmlNode,l=e.getPosition(),i.set(l.x,l.y,l.z,1);const t=e.getCentralPoint();null===t?i.applyMatrix4(s):(o.set(t.x,t.y,t.z,0),i.add(o),i.applyMatrix4(s),o.set(t.x,t.y,t.z,1),o.applyMatrix4(s),i.sub(o)),a.setAttribute("x",i.x.toString()),a.setAttribute("y",i.y.toString()),a.setAttribute("z",i.z.toString())}}))}(n);return(new XMLSerializer).serializeToString(n.originalCML)}return null},Jh.prototype.motm=function(){z.set({fogColorEnable:!0,fogColor:0,outline:{on:!0,threshold:.01},bg:{color:16777215}}),this._forEachComplexVisual((e=>{const t=[],r=e.getComplex(),n=ao.get(z.now.palette);for(let e=0;e<r.getChainCount();e++){const s=r._chains[e]._name,i=n.getChainColor(s);t[e]={selector:`chain ${s}`,mode:"VW",colorer:["CB",{color:i,factor:.9}],material:"FL"}}e.resetReps(t)}))},Jh.prototype.VERSION="0.11.1",t().assign(Jh,{VERSION:Jh.prototype.VERSION,registeredPlugins:[],chem:Yt,io:Wc,modes:Xi,colorers:Do,materials:Fo,palettes:ao,options:le,settings:z,utils:O,gfx:{Representation:$o},thirdParty:{lodash:t(),three:r}});const au=Jh;var lu=s(89);const cu={$help:["Rendering mode shortcut","    BS - balls and sticks mode","    LN - lines mode","    LC - licorice mode","    VW - van der waals mode","    TR - trace mode","    TU - tube mode","    CA - cartoon mode","    SA - isosurface mode","    QS - quick surface mode","    SE - solvent excluded mode","    TX - text mode"],BS:{$help:["   Balls and sticks","      aromrad = <number> #aromatic radius","      atom = <number>    #atom radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},CA:{$help:["   Cartoon","      arrow = <number>   #arrow size","      depth = <number>   #depth of surface","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> #","      width = <number>  #secondary width\n"]},LN:{$help:["   Lines","      atom = <number>    #atom radius","      chunkarom = <number>","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      offsarom = <number>\n"]},LC:{$help:["   Licorice","      aromrad = <number> #aromatic radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},VW:{$help:["   Van der Waals","      nothing\n"]},TR:{$help:["   Trace","      radius = <number>  #tube radius\n"]},TU:{$help:["   Tube","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> \n"]},SA:{$help:["   Surface","      zClip = <bool> #clip z plane\n"]},QS:{$help:["   Quick surface","      isoValue = <number>","      scale = <number>","      wireframe = <bool>","      zClip = <bool> #clip z plane\n"]},SE:{$help:["   Solvent excluded surface","      zClip = <bool> #clip z plane\n"]},TX:{$help:["   Text mode",'      template = <format string> string that can include "{{ id }}"',"          it will be replaced by value, id can be one of next:","          serial, name, type, sequence, residue, chain, hetatm, water\n",'      horizontalAlign = <string> {"left", "right", "center"}','      verticalAlign = <string> {"top", "bottom", "middle"}',"      dx = <number> #offset along x","      dy = <number> #offset along y","      dz = <number> #offset along z","      fg = <string> #text color modificator","           could be keyword, named color or hex","      fg = <string> #back color modificator","           could be keyword, named color or hex","      showBg = <bool> #if set show background","           plate under text"]}},hu={$help:["Coloring mode shortcut","    EL - color by element","    CH - color by chain","    SQ - color by sequence","    RT - color by residue type","    SS - color by secondary structure","    UN - uniform"],UN:{$help:["Parameters of coloring modes customization","   Uniform","      color = <number|color> #RGB->HEX->dec\n"],color:{$help:Object.keys(ao.get(z.now.palette).namedColors).sort().join("\n")}}},uu={$help:["Material shortcut","    DF - diffuse","    TR - transparent","    SF - soft plastic","    PL - glossy plastic","    ME - metal","    GL - glass"]},du={$help:["Short (packed) representation description as a set of variables","    s=<EXPRESSION>","        selector property","    m=<MODE_ID>[!<PARAMETER>:<VALUE>[,...]]","        render mode property","    c=<COLORER_ID>[!<PARAMETER>:<VALUE>[,...]]","        color mode property","    mt=<MATERIAL_ID>","        material property"],s:{$help:"Selection expression string as it is in menu->representations->selection"},m:cu,c:hu,mt:uu},pu={$help:["Parameters of rendering modes customization: modes","Parameters of colorer customization: colorers","Autobuild: autobuild = (<number>|<bool>)"],modes:cu,colorers:hu},mu={$help:["help (<cmd name>| <path to property>)","You can get detailed information about command options",'   using "help cmd.opt.opt.[...]"\n',"   you can use one line comments","   everything started from (#|//) will be skipped","   Example: >build //some comment\n","List of available commands:"],reset:{$help:["Reload current object, delete all representations","    Nothing will work until load new object"]},load:{$help:["load (<PDBID>|<URL>|-f [<*.NC FILE URL STRING>])","    Load new pdb object from selected source"],PDBID:{$help:"pdb id in remote molecule database"},URL:{$help:"url to source file"},f:{$help:["open file system dialog to fetch local file","optionally you can determine trajectory file","via URL for *.top model"]}},clear:{$help:"No args. Clear terminal"},add:{$help:["add [<REP_NAME>] [<DESCRIPTION>]","    Add new item to representation set with","    default or <DESCRIPTION> params"],REP_NAME:{$help:"Identifier string [_,a-z,A-Z,0-9] can not start from digit"},DESCRIPTION:du},rep:{$help:["rep [<REP_NAME>|<REP_INDEX>] [<DESCRIPTION>]","    set current representation by name or index","    edit current representation by <DESCRIPTION>"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"},DESCRIPTION:du},remove:{$help:["remove (<REP_NAME>|<REP_INDEX>)","Remove representation by name or index"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"}},selector:{$help:["selector <EXPRESSION>","   set selector from EXPRESSION to current representation"],EXPRESSION:{$help:"Selection expression string as it is in menu->representations->selection"}},mode:{$help:["mode <MODE_ID> [<PARAMETER>=<VALUE>...]","   set rendering mode and apply parameters to current representation"],MODE_ID:cu},color:{$help:["color <COLORER_ID> [<PARAMETER>=<VALUE>...]","   set colorer and apply parameters to current representation"],COLORER_ID:hu},material:{$help:["material <MATERIAL_ID>","   set material to current representation"],MATERIAL_ID:uu},build:{$help:"build help str",add:{$help:"build.add",new:{$help:["add.new","add.new new line 1","add.new new line 2","add.new new line 3"]}},del:{$help:"build.del"}},list:{$help:["list [-e|-s|<REP_NAME>|<REP_INDEX>]","Print representations if no args print list of representations","    -e expand list and show all representations","    -s show all user-registered selectors","    <REP_NAME>|<REP_INDEX> show only current representation"]},hide:{$help:["hide (<REP_NAME>|<REP_INDEX>)","Hide representation referenced in args"]},show:{$help:["show (<REP_NAME>|<REP_INDEX>)","Show representation referenced in args"]},get:{$help:["get <PARAMETER>","Print <PARAMETER> value","    <PARAMETER> - path to option use get.PARAMETER to get more info"],PARAMETER:pu},set:{$help:["set <PARAMETER> <VALUE>","Set <PARAMETER> with <VALUE>","    <PARAMETER> - path to option use set.PARAMETER to get more info"],PARAMETER:pu},set_save:{$help:["set_save","Save current settings to cookie"]},set_restore:{$help:["set_restore","Load and apply settings from cookie"]},set_reset:{$help:["set_reset","Reset current settings to the defaults"]},preset:{$help:["preset [<PRESET>]","Reset current representation or set preset to <PRESET>"],PRESET:{$help:["default","wire","small","macro"]}},unit:{$help:["unit [<unit_id>]","Change current biological structure view. Zero <unit_id> value means asymmetric unit,","positive values set an assembly with corresponding number.","Being called with no parameters command prints current unit information."]},view:{$help:["view [<ENCODED_VIEW>]","Get current encoded view or set if ENCODED_VIEW placed as argument"],ENCODED_VIEW:{$help:["encoded view matrix string (binary code)"]}},rotate:{$help:["rotate (x|y|z) [<DEGREES>] [(x|y|z) [<DEGREES>]]...","Rotate scene"]},scale:{$help:["scale <SCALE>","Scale scene"]},select:{$help:["select <SELECTOR_STRING> [as <SELECTOR_NAME>]","Select atoms using selector defined in SELECTOR_STRING","    and if SELECTOR_NAME is defined register it in viewer","    you can use it later as a complex selector"]},within:{$help:["within <DISTANCE> of <SELECTOR_STRING> as <SELECTOR_NAME>","Build within named selector","    DISTANCE        <number>","    SELECTOR_STRING <string(selection language)>","    SELECTOR_NAME   <identifier>"]},url:{$help:["url [-s] [-v]","Report URL encoded scene","    if -s set that include settings in the URL","    if -v set that include view in the URL"]},screenshot:{$help:["screenshot [<WIDTH> [<HEIGHT>]]","Make a screenshot of the scene","    WIDTH  <number> in pixels","    HEIGHT <number> in pixels, equal to WIDTH by default"]},line:{$help:["line <first_atom_path> <second_atom_path> [<PARAMETER>=<VALUE>]","Draw dashed line between two specified atoms"]},removeobj:{$help:["removeobj <id>","Remove scene object by its index. Indices could be obtained by <listobj> command"]},listobj:{$help:["listobj","Display the list of all existing scene objects"]}},{chem:{selectors:fu},modes:_u,colorers:gu,materials:yu,palettes:xu,options:bu,settings:wu}=au;function Su(){}const vu=function(){const e=new Su;return function(){return e}}();const Cu=new class{constructor(){this.representationMap={},this.representationID={}}get(e){return this.representationMap[e]||this.representationID[e]||"<no name>"}add(e,t){if(-1===e)return"Can not create representation: there is no data";if(void 0!==t){if(this.representationMap.hasOwnProperty(e))return"This name has already existed, registered without name";this.representationMap[e.toString()]=t,this.representationID[t]=e.toString()}return`Representation ${e} successfully added`}remove(e){e&&this.representationID.hasOwnProperty(e)&&(delete this.representationMap[this.representationID[e]],delete this.representationID[e]);const t=Object.keys(this.representationID).sort();for(const r in t)if(t.hasOwnProperty(r)){const n=t[r];n>e&&(this.representationID[n-1]=this.representationID[n],this.representationMap[this.representationID[n]]-=1,delete this.representationID[n])}}clear(){this.representationMap={},this.representationID={}}};function Au(e){const t={s:"selector",m:"mode",c:"colorer",mt:"material",mode:"modes",color:"colorers",colorer:"colorers",select:"selector",material:"materials",selector:"selector"}[e];return void 0===t?e:t}const Eu=new class{list(e,t,r){let n="";if(e&&void 0!==t&&(void 0===r||"-e"===r)){const s=e.repCount();for(let i=0;i<s;i++)n+=this.listRep(e,t,i,r)}return n}listRep(e,t,r,n){let s="";const i=e.repGet(r);if(!i)return w.warn(`Rep ${r} does not exist!`),s;const o=r,a=t.get(o),{mode:l,colorer:c}=i,h=i.selectorString,u=i.materialPreset;return s+=`#${o} : ${l.name}${"<no name>"===a?"":`, ${a}`}\n`,void 0!==n&&(s+=`    selection : "${h}"\n`,s+=`    mode      : (${l.id}), ${l.name}\n`,s+=`    colorer   : (${c.id}), ${c.name}\n`,s+=`    material  : (${u.id}), ${u.name}\n`),s}listSelector(e,t){let r="";for(const e in t)t.hasOwnProperty(e)&&(r+=`${e} : "${t[e]}"\n`);return r}listObjs(e){const t=e._objects;if(!t||!Array.isArray(t)||0===t.length)return"There are no objects on the scene";const r=[];for(let e=0,n=t.length;e<n;++e)r[e]=`${e}: ${t[e].toString()}`;return r.join("\n")}joinHelpStr(e){return e instanceof Array?e.join("\n"):e}help(e){if(t().isUndefined(e))return`${this.joinHelpStr(mu.$help)}\n${t().slice(t().sortBy(t().keys(mu)),1).join(", ")}\n`;const r=t().get(mu,e);return t().isUndefined(r)?this.help():`${this.joinHelpStr(r.$help)}\n`}load(e,t){if(void 0===e||void 0===t||"-f"===t)return;e.awaitWhileCMDisInProcess();const r=()=>e.finishAwaitingCMDInProcess();e.load(t).then(r,r)}checkArg(e,t,r){if(void 0!==e&&void 0!==t){if("selector"===Au(e)){const e=fu.parse(t);if(void 0!==e.error){throw{message:e.error}}return void 0!==r&&r?e.selector:t}const n={colorers:gu,modes:_u,materials:yu};let s,i=e;for(;i!==s;)s=i,i=Au(s);if(void 0===n[i].get(t)){throw{message:`${t} is not existed in ${i}`}}return t}return vu}propagateProp(e,r){if(void 0!==e){let n={};const s=bu.adapters[typeof t().get(wu.defaults,e)];if(void 0===s){throw{message:`${e} is not existed`}}if((e.endsWith(".color")||e.endsWith(".baseColor")||e.endsWith(".EL.carbon"))&&"number"!=typeof r&&(r=xu.get(wu.now.palette).getNamedColor(r)),e.endsWith(".fg")||e.endsWith(".bg"))if("number"!=typeof r){const e=xu.get(wu.now.palette).getNamedColor(r,!0);void 0!==e&&(r=`0x${e.toString(16)}`)}else r=`0x${r.toString(16)}`;if(e.endsWith(".template")&&(r=r.replace(/\\n/g,"\n")),void 0!==r&&s(r)!==r&&s(r)!==r>0)throw n={message:`${e} must be a "${typeof t().get(wu.defaults,e)}"`},n}return r}unquoteString(e){return O.unquoteString(e)}};function Tu(e){if(e instanceof this.constructor)return e;this._values=e instanceof Array?e.slice(0):e?[e]:[]}Tu.prototype.append=function(e){const t=this._values;return t[t.length]=e,this},Tu.prototype.remove=function(e){const t=this._values,r=t.indexOf(e);return r>=0&&t.splice(r,1),this},Tu.prototype.toJSO=function(e,r,n){const s={},i=this._values;for(let o=0,a=i.length;o<a;++o)t().set(s,i[o].id,e.propagateProp(`${Au(r)}.${n}.${i[o].id}`,i[o].val));return s};const Ru=Object.create({});Ru.Arg=function(e,t){this.id=e,this.val=t},Ru.ArgList=Tu,Ru.miew=null,Ru.echo=null,Ru.representations=Cu,Ru.utils=Eu,Ru._=t(),Ru.CreateObjectPair=function(e,t){const r={};return r[e]=t,r},Ru.keyRemap=Au,Ru.Context=fu.Context,Ru.ClearContext=fu.ClearContext,Ru.NULL=vu,Ru.notimplemented=function(){return this.NULL},au.prototype.script=function(e,t,r){lu.parser.yy.miew=this,lu.parser.yy.echo=t,lu.parser.yy.error=r,void 0===this.cmdQueue&&(this.cmdQueue=[]),void 0===this.commandInAction&&(this.commandInAction=!1),this.cmdQueue=this.cmdQueue.concat(e.split("\n"))},au.prototype.awaitWhileCMDisInProcess=function(){this.commandInAction=!0},au.prototype.finishAwaitingCMDInProcess=function(){this.commandInAction=!1},au.prototype.isScriptingCommandAvailable=function(){return void 0!==this.commandInAction&&!this.commandInAction&&void 0!==this.cmdQueue&&this.cmdQueue.length>0},au.prototype.callNextCmd=function(){if(this.isScriptingCommandAvailable()){const e=this.cmdQueue.shift(),t={success:!1};try{lu.parser.parse(e),t.success=!0}catch(e){t.error=e.message,lu.parser.yy.error(t.error),this.finishAwaitingCMDInProcess()}return t}return""},lu.parser.yy=Ru,lu.parser.yy.parseError=lu.parser.parseError;const Mu=au})(),i=i.default})()));
//# sourceMappingURL=Miew.min.js.map